'use strict';const _0x5c7e7c=_0x12ce;(function(_0x2e3e64,_0x139bb8){const _0x1a1980=_0x12ce,_0x2f0bfe=_0x2e3e64();while(!![]){try{const _0x304bea=parseInt(_0x1a1980(0x17b))/0x1*(-parseInt(_0x1a1980(0x1ee))/0x2)+-parseInt(_0x1a1980(0x180))/0x3*(parseInt(_0x1a1980(0x154))/0x4)+-parseInt(_0x1a1980(0x33b))/0x5+parseInt(_0x1a1980(0x33c))/0x6*(parseInt(_0x1a1980(0x23b))/0x7)+-parseInt(_0x1a1980(0x16a))/0x8*(parseInt(_0x1a1980(0x1e8))/0x9)+parseInt(_0x1a1980(0x197))/0xa+parseInt(_0x1a1980(0x1a8))/0xb;if(_0x304bea===_0x139bb8)break;else _0x2f0bfe['push'](_0x2f0bfe['shift']());}catch(_0x57024e){_0x2f0bfe['push'](_0x2f0bfe['shift']());}}}(_0x469b,0xe378f));var __decorate=this&&this['__decorate']||function(_0x187bf7,_0x57f894,_0x510e81,_0x44c3aa){const _0x39891f=_0x12ce;var _0x4b0423=arguments[_0x39891f(0x1ea)],_0x39bd5f=_0x4b0423<0x3?_0x57f894:_0x44c3aa===null?_0x44c3aa=Object['getOwnPropertyDescriptor'](_0x57f894,_0x510e81):_0x44c3aa,_0x18a760;if(typeof Reflect===_0x39891f(0x17f)&&typeof Reflect[_0x39891f(0x202)]===_0x39891f(0x227))_0x39bd5f=Reflect[_0x39891f(0x202)](_0x187bf7,_0x57f894,_0x510e81,_0x44c3aa);else{for(var _0x3d62e4=_0x187bf7[_0x39891f(0x1ea)]-0x1;_0x3d62e4>=0x0;_0x3d62e4--)if(_0x18a760=_0x187bf7[_0x3d62e4])_0x39bd5f=(_0x4b0423<0x3?_0x18a760(_0x39bd5f):_0x4b0423>0x3?_0x18a760(_0x57f894,_0x510e81,_0x39bd5f):_0x18a760(_0x57f894,_0x510e81))||_0x39bd5f;}return _0x4b0423>0x3&&_0x39bd5f&&Object['defineProperty'](_0x57f894,_0x510e81,_0x39bd5f),_0x39bd5f;},__metadata=this&&this[_0x5c7e7c(0x19d)]||function(_0x17db9a,_0x5017d0){const _0x2de4c5=_0x5c7e7c;if(typeof Reflect===_0x2de4c5(0x17f)&&typeof Reflect['metadata']===_0x2de4c5(0x227))return Reflect[_0x2de4c5(0x1fa)](_0x17db9a,_0x5017d0);},__param=this&&this['__param']||function(_0x309bc8,_0x3ed7f6){return function(_0xb15c16,_0x25a5f2){_0x3ed7f6(_0xb15c16,_0x25a5f2,_0x309bc8);};};function _0x12ce(_0x86179e,_0x1f1241){const _0x469b2e=_0x469b();return _0x12ce=function(_0x12ce3b,_0x5b2b42){_0x12ce3b=_0x12ce3b-0x133;let _0x3d3788=_0x469b2e[_0x12ce3b];return _0x3d3788;},_0x12ce(_0x86179e,_0x1f1241);}Object[_0x5c7e7c(0x2c9)](exports,_0x5c7e7c(0x13f),{'value':!![]}),exports[_0x5c7e7c(0x2a7)]=void 0x0;const user_entity_1=require(_0x5c7e7c(0x1d0)),common_1=require('@nestjs/common'),typeorm_1=require(_0x5c7e7c(0x316)),midjourney_entity_1=require('./midjourney.entity'),typeorm_2=require(_0x5c7e7c(0x313)),axios_1=require(_0x5c7e7c(0x28c)),globalConfig_service_1=require(_0x5c7e7c(0x27c)),midjourney_constant_1=require(_0x5c7e7c(0x24e)),upload_service_1=require(_0x5c7e7c(0x1a6)),badwords_service_1=require(_0x5c7e7c(0x1bd)),userBalance_service_1=require(_0x5c7e7c(0x315)),utils_1=require('../../common/utils'),mjPrompts_entity_1=require('./mjPrompts.entity'),mjParam_entity_1=require(_0x5c7e7c(0x169)),mjIncantationClassify_entity_1=require('./mjIncantationClassify.entity'),mjInspireClassify_entity_1=require(_0x5c7e7c(0x330)),mjIncantation_entity_1=require(_0x5c7e7c(0x27a)),createRandomId_1=require(_0x5c7e7c(0x173)),fanyi_service_1=require('../fanyi/fanyi.service'),mjSuggestWord_entity_1=require(_0x5c7e7c(0x339)),user_service_1=require(_0x5c7e7c(0x1d1)),midjourney_1=require(_0x5c7e7c(0x1ab)),redisCache_service_1=require(_0x5c7e7c(0x27e)),socket_io_client_1=require(_0x5c7e7c(0x327)),mjpAccount_service_1=require(_0x5c7e7c(0x214)),mjpTask_service_1=require(_0x5c7e7c(0x317)),addDrawQueue_dto_1=require(_0x5c7e7c(0x2b4)),MjConfig_1=require('../../config/MjConfig'),redisKey_constant_1=require(_0x5c7e7c(0x1f3)),aiLog_service_1=require(_0x5c7e7c(0x31d)),relate_contant_1=require(_0x5c7e7c(0x272)),jwt=require(_0x5c7e7c(0x190));let MidjourneyService=class MidjourneyService{constructor(_0xb758dd,_0x9942bc,_0x34c23e,_0xcd814f,_0x2df763,_0x564206,_0x5a2743,_0x12e7d8,_0x4836d2,_0xc2119e,_0x569ff9,_0x2e5fb0,_0x33f7b8,_0x27e9a7,_0x54ea6f,_0x12521c,_0xf8fdc6,_0x32cf3b,_0x143578){const _0xf20355=_0x5c7e7c;this[_0xf20355(0x182)]=_0xb758dd,this['userEntity']=_0x9942bc,this[_0xf20355(0x2e7)]=_0x34c23e,this[_0xf20355(0x217)]=_0xcd814f,this[_0xf20355(0x277)]=_0x2df763,this[_0xf20355(0x1ec)]=_0x564206,this['mjSuggestWordEntity']=_0x5a2743,this[_0xf20355(0x2c5)]=_0x12e7d8,this[_0xf20355(0x212)]=_0x4836d2,this[_0xf20355(0x172)]=_0xc2119e,this[_0xf20355(0x2b8)]=_0x569ff9,this[_0xf20355(0x1a1)]=_0x2e5fb0,this['fanyiService']=_0x33f7b8,this['userService']=_0x27e9a7,this[_0xf20355(0x170)]=_0x54ea6f,this[_0xf20355(0x14a)]=_0x12521c,this[_0xf20355(0x193)]=_0xf8fdc6,this[_0xf20355(0x16c)]=_0x32cf3b,this['connection']=_0x143578,this[_0xf20355(0x153)]=_0xf20355(0x28d),this['apiBaseUrl']=_0xf20355(0x221),this['midJourney']={},this[_0xf20355(0x2bd)]=null,this[_0xf20355(0x31a)]=null,this[_0xf20355(0x184)]=async _0x291c94=>{const _0x1f09a9=_0xf20355,{authorization:_0x1eb338,guildId:_0x7c80d3,channelId:_0x518790,mode:_0x5e265a}=_0x291c94,_0x2c95e5=this['wsBaseUrl'],_0xa79df6=this[_0x1f09a9(0x229)];!this[_0x1f09a9(0x206)][_0x5e265a]&&await this[_0x1f09a9(0x2a9)]({'channel_id':_0x518790,'guild_id':_0x7c80d3,'token':_0x1eb338,'wsBaseUrl':_0x2c95e5,'apiBaseUrl':_0xa79df6},_0x5e265a);const _0x322f5b=await this[_0x1f09a9(0x237)](_0x5e265a),_0x279bff=await this[_0x1f09a9(0x234)](_0x5e265a),_0x244317=_0x322f5b[_0x1f09a9(0x2df)][_0x1f09a9(0x257)],_0x36f983=_0x244317['split']('\x0a')[_0x1f09a9(0x290)](_0x1cdb24=>_0x1cdb24)['map'](_0x2953da=>_0x2953da[_0x1f09a9(0x161)](/\*/g,''));let _0x48c147={};_0x36f983[_0x1f09a9(0x255)](_0x37fc72=>{const _0x1c2338=_0x1f09a9,_0x22f5c4=_0x37fc72[_0x1c2338(0x178)](':');!_0x48c147[_0x22f5c4[0x0]]&&(_0x48c147[_0x22f5c4[0x0]]=_0x22f5c4[0x1]);});const _0x2f42a5=_0x48c147['Fast\x20Time\x20Remaining']||'',_0x5a371=_0x48c147['Lifetime\x20Usage']||'',_0x3ee70d=_0x48c147[_0x1f09a9(0x2e5)]||'',_0x3600e5=_0x48c147[_0x1f09a9(0x1b9)]||'',_0x1c7db4=_0x3600e5?.['split']('\x20')[0x0]===_0x1f09a9(0x16d)?0x1:0x2;return{'settingInfo':_0x279bff,'fastRemainTime':_0x2f42a5,'lifetimeUsage':_0x5a371,'relaxedUsage':_0x3ee70d,'orderPlan':_0x1c7db4,'subscription':_0x3600e5,'info':_0x244317};};}async[_0x5c7e7c(0x1cc)](){const _0x4d2a31=_0x5c7e7c;await this[_0x4d2a31(0x26a)](),await this[_0x4d2a31(0x34d)](),await this[_0x4d2a31(0x133)]();}async[_0x5c7e7c(0x15e)](_0x3141f0){const _0x519820=_0x5c7e7c;if(!this[_0x519820(0x232)]||!this[_0x519820(0x232)][_0x519820(0x29a)]){const _0x157580=_0x3141f0||'';common_1['Logger'][_0x519820(0x29f)](_0x157580,_0x519820(0x1e2));if(!_0x157580)throw new common_1[(_0x519820(0x139))]('socket协议地址错误',common_1['HttpStatus'][_0x519820(0x14e)]);return common_1['Logger'][_0x519820(0x29f)](_0x157580,_0x519820(0x171)),this[_0x519820(0x232)]=(0x0,socket_io_client_1['io'])(_0x157580,{'transports':[_0x519820(0x288),_0x519820(0x347)],'reconnection':!![],'autoConnect':!![],'query':{'token':_0x519820(0x284)}}),this[_0x519820(0x232)]['on'](_0x519820(0x251),_0x4ff03e=>{const _0x5a7dbf=_0x519820;console[_0x5a7dbf(0x29f)](_0x4ff03e);}),this[_0x519820(0x232)]['on'](_0x519820(0x1c4),_0x14a83e=>{const _0x34e85d=_0x519820;console[_0x34e85d(0x29f)](_0x34e85d(0x1e1)),_0x14a83e[_0x34e85d(0x224)]('socket-open'),this[_0x34e85d(0x31a)]&&(clearTimeout(this[_0x34e85d(0x31a)]),this[_0x34e85d(0x31a)]=null);}),this[_0x519820(0x232)]['on'](_0x519820(0x142),()=>{const _0x1b7bcb=_0x519820;console['log'](_0x1b7bcb(0x142)),this[_0x1b7bcb(0x31a)]=setTimeout(()=>{const _0x571686=_0x1b7bcb;this[_0x571686(0x2bd)]&&typeof this['heartbeatTask']===_0x571686(0x20d)&&(clearInterval(this[_0x571686(0x2bd)]),this[_0x571686(0x2bd)]=null),this[_0x571686(0x232)]=this[_0x571686(0x15e)][_0x571686(0x289)](this);},0xfa0);}),this[_0x519820(0x232)]['on']('connect',async()=>{const _0x144d31=_0x519820;common_1['Logger']['log'](_0x144d31(0x1f7));}),this[_0x519820(0x232)]['on']('disconnect',async(_0x7eea07,_0x2f7776)=>{const _0x5daada=_0x519820;console[_0x5daada(0x29f)](_0x7eea07,_0x2f7776),common_1[_0x5daada(0x1e6)]['log']('socket断开成功');}),this[_0x519820(0x232)];}return common_1[_0x519820(0x1e6)][_0x519820(0x29f)](_0x519820(0x2c1)),this[_0x519820(0x232)];}async[_0x5c7e7c(0x34d)](){const _0x11e321=_0x5c7e7c,_0x224df2=await this['mjParamEntity'][_0x11e321(0x209)]({'where':{'enable':0x1},'order':{'weight':_0x11e321(0x25b)}});_0x224df2===0x0&&common_1[_0x11e321(0x1e6)][_0x11e321(0x135)](_0x11e321(0x322));}async[_0x5c7e7c(0x26a)](){const _0x585c65=_0x5c7e7c,_0x39d068=await this[_0x585c65(0x1ec)]['count']();if(_0x39d068===0x0){const _0x2fa309=[{'name':_0x585c65(0x2b3),'value':0x1},{'name':'摄影拍照','value':0x2},{'name':_0x585c65(0x2a8),'value':0x3},{'name':_0x585c65(0x342),'value':0x4},{'name':_0x585c65(0x1e5),'value':0x5},{'name':_0x585c65(0x2de),'value':0x6},{'name':_0x585c65(0x19b),'value':0x7},{'name':_0x585c65(0x253),'value':0x8},{'name':'形象设计','value':0x9},{'name':_0x585c65(0x2a2),'value':0xa}][_0x585c65(0x337)](_0x267a18=>{const _0x3f419f=_0x585c65;return{'name':_0x267a18[_0x3f419f(0x17a)],'value':_0x267a18[_0x3f419f(0x1b6)]+'','inner':0x1};});await this[_0x585c65(0x1ec)][_0x585c65(0x146)](_0x2fa309)[_0x585c65(0x31e)](_0x56efef=>{const _0x2c148e=_0x585c65;common_1['Logger'][_0x2c148e(0x135)]('初始化灵感广场分类失败');}),common_1[_0x585c65(0x1e6)][_0x585c65(0x29f)](_0x585c65(0x2e6));}common_1[_0x585c65(0x1e6)][_0x585c65(0x29f)]('不需要灵感广场分类');}async[_0x5c7e7c(0x133)](){const _0x55dcfe=_0x5c7e7c,_0x490678=await this[_0x55dcfe(0x182)][_0x55dcfe(0x15c)]({'where':{'status':(0x0,typeorm_2['In'])([midjourney_constant_1[_0x55dcfe(0x2c6)][_0x55dcfe(0x1c8)]])}})['then'](_0x14b987=>_0x14b987[_0x55dcfe(0x290)](_0xc25721=>Date[_0x55dcfe(0x27f)]()-_0xc25721[_0x55dcfe(0x267)]['getTime']()>0x5*0x3c*0x3e8))[_0x55dcfe(0x2a6)](_0x567929=>_0x567929[_0x55dcfe(0x337)](_0x3dd820=>_0x3dd820['id']))[_0x55dcfe(0x31e)](_0x3c26ff=>{const _0x24e96d=_0x55dcfe;common_1[_0x24e96d(0x1e6)][_0x24e96d(0x135)](_0x3c26ff);});if(!_0x490678||_0x490678[_0x55dcfe(0x1ea)]===0x0)return;await this[_0x55dcfe(0x182)][_0x55dcfe(0x19e)](_0x490678,{'status':midjourney_constant_1['MidjourneyStatusEnum']['DRAWFAIL']})[_0x55dcfe(0x2a6)](_0x982600=>_0x982600[_0x55dcfe(0x306)]>0x0)[_0x55dcfe(0x31e)](_0x49dad7=>{const _0x3e778e=_0x55dcfe;common_1[_0x3e778e(0x1e6)][_0x3e778e(0x135)](_0x49dad7);});}async['initMj'](_0x368829){const _0x445095=_0x5c7e7c,_0x2b69e8=this[_0x445095(0x153)],_0x44ce86=this[_0x445095(0x229)];if(!this['midJourney'][_0x368829]){const {guild_id:_0x4be860,channel_id:_0xd6d7a1,authorization:_0x2f7822}=await this[_0x445095(0x248)](_0x368829)[_0x445095(0x31e)](_0x58af35=>{const _0x35f79b=_0x445095;return Promise[_0x35f79b(0x22f)](_0x58af35);});return await this[_0x445095(0x2a9)]({'channel_id':_0xd6d7a1,'guild_id':_0x4be860,'token':_0x2f7822,'wsBaseUrl':_0x2b69e8,'apiBaseUrl':_0x44ce86},_0x368829),!![];}return!![];}async[_0x5c7e7c(0x2a9)](_0xf089b4,_0x2c3110){const _0x8dcf01=_0x5c7e7c,{token:_0x6b72dc,channel_id:_0x408b20,guild_id:_0x217dba,apiBaseUrl:_0x2697bb,wsBaseUrl:_0x487fe3}=_0xf089b4;this[_0x8dcf01(0x206)][_0x2c3110]=new midjourney_1[(_0x8dcf01(0x275))]({'token':_0x6b72dc,'guild_id':_0x217dba,'channel_id':_0x408b20,'apiBaseUrl':_0x2697bb,'wsBaseUrl':_0x487fe3,'skipHeartbeat':!![]}),await this['midJourney'][_0x2c3110]['init']();}async[_0x5c7e7c(0x210)](_0x22f60d){const _0x525226=_0x5c7e7c,_0xbf743=new addDrawQueue_dto_1[(_0x525226(0x18f))](_0x22f60d);await this[_0x525226(0x2b8)]['checkBadWords'](_0xbf743[_0x525226(0x256)],_0xbf743[_0x525226(0x1ed)]);const _0x57c045=await this[_0x525226(0x182)]['save'](_0xbf743);return _0x57c045;}async['handleAddDrawTask'](_0x596329,_0x4c62d6){const _0x9b1e70=_0x5c7e7c;let _0x3e9d07,_0x23e30e;try{const {type:_0x2b41d8,params:_0x3ea12f}=_0x596329;await this[_0x9b1e70(0x259)][_0x9b1e70(0x21d)](_0x4c62d6[_0x9b1e70(0x307)]);if(_0x2b41d8===midjourney_constant_1['MidJourneyDrawEnum'][_0x9b1e70(0x15b)]){let {botType:_0x168d0a,prompt:_0x4bdd9a,extend:_0x3ba060,action:_0x40a480,mode:_0x14d9ef,translate:_0x3ca556,base64Array:_0xd4ca25,mats:mats=[],iw:_0x4e7c61,roles:roles=[],cw:_0x1f112f,styles:styles=[],sw:_0x593c1a}=_0x3ea12f,_0x4d0632=await this['calcCost'](_0x9b1e70(0x324),_0x14d9ef);await this[_0x9b1e70(0x1a1)][_0x9b1e70(0x2b5)](_0x4c62d6,'mjDraw',_0x4d0632);const _0x1ba6ac=_0x4bdd9a,_0x426e57=await this[_0x9b1e70(0x2ea)](_0x14d9ef);_0x4bdd9a&&await this['badwordsService']['checkBadWords'](_0x4bdd9a,_0x4c62d6[_0x9b1e70(0x307)]['id']),_0x4bdd9a=_0x3ca556===0x1&&(0x0,utils_1['isChinese'])(_0x4bdd9a)?await this[_0x9b1e70(0x14c)][_0x9b1e70(0x156)](_0x4bdd9a):_0x4bdd9a;let _0x3f8b1e=_0x4bdd9a;mats['length']&&(_0x3f8b1e=mats[_0x9b1e70(0x247)]('\x20')+'\x20'+_0x3f8b1e);_0x4e7c61&&(_0x3f8b1e=_0x3f8b1e+'\x20--iw\x20'+_0x4e7c61);styles[_0x9b1e70(0x1ea)]&&(_0x3f8b1e=_0x3f8b1e+_0x9b1e70(0x276)+styles[_0x9b1e70(0x247)]('\x20'));roles[_0x9b1e70(0x1ea)]&&(_0x3f8b1e=_0x3f8b1e+'\x20--cref\x20'+roles[_0x9b1e70(0x247)]('\x20'));_0x1f112f&&(_0x3f8b1e=_0x3f8b1e+_0x9b1e70(0x278)+_0x1f112f);_0x593c1a&&(_0x3f8b1e=_0x3f8b1e+_0x9b1e70(0x1f0)+_0x593c1a);_0x3ba060&&(_0x3f8b1e=_0x3f8b1e+'\x20'+_0x3ba060);const _0x10e6a3=await this[_0x9b1e70(0x193)][_0x9b1e70(0x200)]({'data':{'mode':this[_0x9b1e70(0x2ec)](_0x14d9ef),'prompt':_0x3f8b1e,'botType':_0x168d0a||_0x9b1e70(0x1b3),'base64Array':_0xd4ca25,'accountFilter':{'instanceId':_0x426e57['mjpId']}}});if(_0x10e6a3[_0x9b1e70(0x19f)]===0x17)throw new Error('队列已满，请稍后尝试');if(_0x10e6a3[_0x9b1e70(0x19f)]===0x18)throw new Error(_0x9b1e70(0x208));if(_0x10e6a3[_0x9b1e70(0x19f)]!==0x1&&_0x10e6a3[_0x9b1e70(0x19f)]!==0x16)throw new Error(_0x10e6a3['description']);_0x23e30e=_0x10e6a3['result'],_0x3e9d07=await this[_0x9b1e70(0x27d)][_0x9b1e70(0x299)](async _0x2b483f=>{const _0x4d2e18=_0x9b1e70,_0x773b9d={'mode':_0x14d9ef,'prompt':_0x4bdd9a,'action':_0x40a480,'translate':_0x3ca556,'fullPrompt':_0x3f8b1e,'originPrompt':_0x1ba6ac,'extraParam':_0x3ba060,'userId':_0x4c62d6[_0x4d2e18(0x307)]['id'],'mjpId':_0x426e57[_0x4d2e18(0x1be)],'mjpTaskId':_0x10e6a3[_0x4d2e18(0x296)],'botType':_0x168d0a||_0x4d2e18(0x1b3)},_0x3f94b7=await this[_0x4d2e18(0x210)](_0x773b9d);if(!_0x3f94b7)throw new Error(_0x4d2e18(0x21f));return await this[_0x4d2e18(0x1a1)][_0x4d2e18(0x2b1)](_0x4c62d6[_0x4d2e18(0x307)]['id'],'mjDraw',_0x4d0632,_0x4d0632),_0x3f94b7[_0x4d2e18(0x230)];});}else{if(_0x2b41d8===midjourney_constant_1['MidJourneyDrawEnum'][_0x9b1e70(0x31f)]){let {taskId:_0x2875ec,prompt:_0x1dff6d,mask:_0x6f3c74,action:_0x5118b6,customId:_0x45fc69}=_0x3ea12f;const _0x17ccb4=await this[_0x9b1e70(0x182)][_0x9b1e70(0x201)]({'where':{'id':_0x2875ec}});if(!_0x17ccb4)throw new Error(_0x9b1e70(0x20f));const _0x5dcc3b=_0x1dff6d;_0x1dff6d&&await this[_0x9b1e70(0x2b8)][_0x9b1e70(0x34f)](_0x1dff6d,_0x4c62d6[_0x9b1e70(0x307)]['id']),_0x1dff6d=(0x0,utils_1[_0x9b1e70(0x2f9)])(_0x1dff6d)?await this[_0x9b1e70(0x14c)]['convertToEnglish'](_0x1dff6d):_0x1dff6d;const _0x1a06bf=await this[_0x9b1e70(0x193)][_0x9b1e70(0x2e3)]({'data':{'prompt':_0x1dff6d,'maskBase64':_0x6f3c74,'taskId':_0x17ccb4[_0x9b1e70(0x305)]}});if(_0x1a06bf[_0x9b1e70(0x19f)]!==0x1&&_0x1a06bf[_0x9b1e70(0x19f)]!==0x16)throw new Error(_0x1a06bf['description']);return this[_0x9b1e70(0x182)]['save']({'id':_0x2875ec,'prompt':_0x1dff6d,'status':0x1,'originPrompt':_0x5dcc3b,'messageFlags':0x1}),_0x17ccb4[_0x9b1e70(0x230)];}else{if(_0x2b41d8===midjourney_constant_1['MidJourneyDrawEnum']['IMAGE_ACTION']){const {action:_0xc5c2e3,taskId:_0x50cf85,customId:_0x22670c}=_0x3ea12f;await this[_0x9b1e70(0x309)](_0x50cf85,_0x22670c);const _0x28a576=await this[_0x9b1e70(0x182)][_0x9b1e70(0x201)]({'where':{'id':_0x50cf85}});if(!_0x28a576)throw new Error(_0x9b1e70(0x20f));let _0xcd6872=await this['calcCost'](_0x22670c,_0x28a576[_0x9b1e70(0x254)]);await this['userBalanceService'][_0x9b1e70(0x2b5)](_0x4c62d6,_0x9b1e70(0x1d5),_0xcd6872);const _0x4cd56e=await this['mjpTaskService'][_0x9b1e70(0x1dd)]({'data':{'customId':_0x22670c,'taskId':_0x28a576[_0x9b1e70(0x305)],'accountFilter':{'instanceId':_0x28a576[_0x9b1e70(0x1be)]},'mode':this['convertMode4Transfer'](_0x28a576[_0x9b1e70(0x254)])}});if(_0x4cd56e[_0x9b1e70(0x19f)]===0x17)throw new Error(_0x9b1e70(0x297));else{if(_0x4cd56e['code']===0x18)throw new Error('prompt包含敏感词');else{if(_0x4cd56e[_0x9b1e70(0x19f)]===0x15)setTimeout(()=>this[_0x9b1e70(0x1b5)](_0x4cd56e[_0x9b1e70(0x296)]));else{if(_0x4cd56e[_0x9b1e70(0x19f)]!==0x1&&_0x4cd56e[_0x9b1e70(0x19f)]!==0x16)throw new Error(_0x4cd56e[_0x9b1e70(0x257)]);}}}_0x23e30e=_0x4cd56e[_0x9b1e70(0x296)],_0x3e9d07=await this[_0x9b1e70(0x27d)]['transaction'](async _0x197e86=>{const _0x20aeaf=_0x9b1e70,_0x32905d={'action':_0xc5c2e3,'customId':_0x22670c,'userId':_0x4c62d6[_0x20aeaf(0x307)]['id'],'mjpTaskId':_0x4cd56e[_0x20aeaf(0x296)],'originTaskId':String(_0x50cf85),'mode':_0x28a576[_0x20aeaf(0x254)],'mjpId':_0x28a576['mjpId'],'prompt':_0x28a576['prompt'],'botType':_0x28a576['botType'],'extraParam':_0x28a576[_0x20aeaf(0x148)],'fullPrompt':_0x28a576[_0x20aeaf(0x256)],'originPrompt':_0x28a576[_0x20aeaf(0x280)]},_0x2c304f=await this[_0x20aeaf(0x210)](_0x32905d);if(!_0x2c304f)throw new Error('提交动作失败');return await this[_0x20aeaf(0x1a1)][_0x20aeaf(0x2b1)](_0x4c62d6[_0x20aeaf(0x307)]['id'],_0x20aeaf(0x1d5),_0xcd6872,_0xcd6872),_0x2c304f[_0x20aeaf(0x230)];});}else return new common_1['HttpException'](_0x9b1e70(0x239),common_1['HttpStatus'][_0x9b1e70(0x14e)]);}}return _0x3e9d07;}catch(_0x34f185){if(_0x34f185 instanceof common_1['HttpException'])throw _0x34f185;else{_0x23e30e&&await this[_0x9b1e70(0x193)][_0x9b1e70(0x22e)]({},_0x23e30e);throw new common_1[(_0x9b1e70(0x139))](_0x34f185['message'],common_1[_0x9b1e70(0x18d)]['BAD_REQUEST']);}}}async[_0x5c7e7c(0x30a)](_0x5a3ec4,_0x2f82e7){const _0x3fef39=_0x5c7e7c;let _0x40a16b,_0x3ae7c8;try{const {type:_0x2604d2,botType:_0x23e697,files:_0x7ce1b5,mode:_0x12cc33,action:_0x2e98a3,size:_0x2e5539,base64Array:base64Array=[]}=_0x5a3ec4;await this[_0x3fef39(0x259)][_0x3fef39(0x21d)](_0x2f82e7[_0x3fef39(0x307)]);let _0x119034='';if(Number(_0x2604d2)===midjourney_constant_1[_0x3fef39(0x1fd)][_0x3fef39(0x2fd)])_0x119034='Blend';else Number(_0x2604d2)===midjourney_constant_1[_0x3fef39(0x1fd)][_0x3fef39(0x231)]&&(_0x119034='Describe');let _0x2eaf81=await this[_0x3fef39(0x2e1)](_0x119034,_0x5a3ec4[_0x3fef39(0x254)]);await this[_0x3fef39(0x1a1)][_0x3fef39(0x2b5)](_0x2f82e7,_0x3fef39(0x1d5),_0x2eaf81);const _0x1657a8=await this[_0x3fef39(0x2ea)](_0x12cc33);if(!base64Array[_0x3fef39(0x1ea)])for(let _0x1f7414=0x0;_0x1f7414<_0x7ce1b5['length'];_0x1f7414++){base64Array['push'](_0x3fef39(0x149)+_0x7ce1b5[_0x1f7414][_0x3fef39(0x1c6)]['toString']('base64'));}if(Number(_0x2604d2)===midjourney_constant_1[_0x3fef39(0x1fd)][_0x3fef39(0x2fd)]){if(base64Array['length']<0x2)throw new Error(_0x3fef39(0x2e4));const _0x13b67a=await this[_0x3fef39(0x193)][_0x3fef39(0x314)]({'data':{'mode':this[_0x3fef39(0x2ec)](_0x12cc33),'dimensions':_0x2e5539,'botType':_0x3fef39(0x1b3),'base64Array':base64Array,'accountFilter':{'instanceId':_0x1657a8['mjpId']}}});if(_0x13b67a[_0x3fef39(0x19f)]===0x17)throw new Error(_0x3fef39(0x297));if(_0x13b67a[_0x3fef39(0x19f)]!==0x1&&_0x13b67a[_0x3fef39(0x19f)]!==0x16)throw new Error(_0x13b67a[_0x3fef39(0x257)]);_0x3ae7c8=_0x13b67a['result'],_0x40a16b=await this[_0x3fef39(0x27d)][_0x3fef39(0x299)](async _0x3e6e81=>{const _0xfa0282=_0x3fef39,_0x5d6faa={'mode':_0x12cc33,'action':_0x2e98a3,'imgUrl':'','userId':_0x2f82e7[_0xfa0282(0x307)]['id'],'jobId':(0x0,utils_1[_0xfa0282(0x252)])(),'botType':_0x23e697||'MID_JOURNEY','extraParam':JSON[_0xfa0282(0x262)]({'attachments':[]}),'originPrompt':'','mjpTaskId':_0x13b67a[_0xfa0282(0x296)]},_0x42bc0a=await this[_0xfa0282(0x210)](_0x5d6faa);if(!_0x42bc0a)throw new Error(_0xfa0282(0x244));return await this[_0xfa0282(0x1a1)][_0xfa0282(0x2b1)](_0x2f82e7[_0xfa0282(0x307)]['id'],_0xfa0282(0x1d5),_0x2eaf81,_0x2eaf81),_0x42bc0a[_0xfa0282(0x230)];});}else{if(Number(_0x2604d2)===midjourney_constant_1[_0x3fef39(0x1fd)]['IMAGE_TO_TEXT']){const _0x41b8aa=await this[_0x3fef39(0x193)]['describe']({'data':{'mode':this[_0x3fef39(0x2ec)](_0x12cc33),'botType':_0x3fef39(0x1b3),'base64':base64Array[0x0],'accountFilter':{'instanceId':_0x1657a8[_0x3fef39(0x1be)]}}});if(_0x41b8aa['code']===0x17)throw new Error('队列已满，请稍后尝试');if(_0x41b8aa[_0x3fef39(0x19f)]!==0x1&&_0x41b8aa[_0x3fef39(0x19f)]!==0x16)throw new Error(_0x41b8aa[_0x3fef39(0x257)]);_0x3ae7c8=_0x41b8aa['result'],_0x40a16b=await this[_0x3fef39(0x27d)][_0x3fef39(0x299)](async _0x231201=>{const _0x4a714c=_0x3fef39,_0x1e78bf={'mode':_0x12cc33,'action':_0x2e98a3,'imgUrl':'','userId':_0x2f82e7['user']['id'],'jobId':(0x0,utils_1[_0x4a714c(0x252)])(),'botType':_0x23e697||_0x4a714c(0x1b3),'extraParam':JSON[_0x4a714c(0x262)]({'attachments':[]}),'originPrompt':'','mjpTaskId':_0x41b8aa[_0x4a714c(0x296)]},_0x1c9e5b=await this[_0x4a714c(0x210)](_0x1e78bf);if(!_0x1c9e5b)throw new Error(_0x4a714c(0x29e));return await this[_0x4a714c(0x1a1)]['deductFromBalance'](_0x2f82e7[_0x4a714c(0x307)]['id'],_0x4a714c(0x1d5),_0x2eaf81,_0x2eaf81),_0x1c9e5b[_0x4a714c(0x230)];})['catch'](async _0x504fca=>{const _0x102f2c=_0x3fef39;await this[_0x102f2c(0x193)][_0x102f2c(0x22e)]({},_0x41b8aa['result']);throw _0x504fca;});}else return new common_1[(_0x3fef39(0x139))]('任务类型错误',common_1[_0x3fef39(0x18d)][_0x3fef39(0x14e)]);}return _0x40a16b;}catch(_0x157ddb){if(_0x157ddb instanceof common_1['HttpException'])throw _0x157ddb;else{_0x3ae7c8&&await this[_0x3fef39(0x193)][_0x3fef39(0x22e)]({},_0x3ae7c8);throw new common_1['HttpException'](_0x157ddb[_0x3fef39(0x23f)],common_1[_0x3fef39(0x18d)][_0x3fef39(0x14e)]);}}}async[_0x5c7e7c(0x2f2)](_0x66d7ce,_0x28f054){const _0x6204d1=_0x5c7e7c;let _0xd88e60,_0x1ab22d;try{const {type:_0x50e40b,params:_0xa69295}=_0x66d7ce,{mode:_0x305910,botType:_0x131e8c,action:_0x1e7b76,extend:_0x2f154b,sourceBase64:_0x45ebb4,targetBase64:_0x4932ac}=_0xa69295;await this[_0x6204d1(0x259)][_0x6204d1(0x21d)](_0x28f054['user']);let _0x428b58=await this[_0x6204d1(0x2e1)]('FaceSwap',_0x305910);await this[_0x6204d1(0x1a1)][_0x6204d1(0x2b5)](_0x28f054,_0x6204d1(0x1d5),_0x428b58);const _0x5010fa=await this[_0x6204d1(0x2ea)](_0x305910),_0x420629=await this[_0x6204d1(0x193)][_0x6204d1(0x1f2)]({'data':{'sourceBase64':_0x45ebb4,'targetBase64':_0x4932ac,'state':_0x2f154b,'mode':this[_0x6204d1(0x2ec)](_0x305910),'accountFilter':{'instanceId':_0x5010fa[_0x6204d1(0x1be)]}}});if(_0x420629[_0x6204d1(0x19f)]===0x17)throw new Error(_0x6204d1(0x297));if(_0x420629['code']===0x18)throw new Error(_0x6204d1(0x208));if(_0x420629[_0x6204d1(0x19f)]!==0x1&&_0x420629[_0x6204d1(0x19f)]!==0x16)throw new Error(_0x420629[_0x6204d1(0x257)]);return _0x1ab22d=_0x420629['result'],_0xd88e60=await this[_0x6204d1(0x27d)][_0x6204d1(0x299)](async _0x3fe597=>{const _0x50a82a=_0x6204d1,_0x523720={'mode':_0x305910,'action':_0x1e7b76,'prompt':null,'extraParam':_0x2f154b,'originPrompt':null,'userId':_0x28f054[_0x50a82a(0x307)]['id'],'mjpId':_0x5010fa[_0x50a82a(0x1be)],'mjpTaskId':_0x420629[_0x50a82a(0x296)],'botType':_0x131e8c||_0x50a82a(0x1b3)},_0x7bb210=new addDrawQueue_dto_1[(_0x50a82a(0x18f))](_0x523720),_0x49404d=await this['midjourneyEntity'][_0x50a82a(0x146)](_0x7bb210);if(!_0x49404d)throw new Error('添加绘图任务失败');return await this[_0x50a82a(0x1a1)][_0x50a82a(0x2b1)](_0x28f054[_0x50a82a(0x307)]['id'],_0x50a82a(0x1d5),_0x428b58,_0x428b58),_0x49404d[_0x50a82a(0x230)];}),_0xd88e60;}catch(_0x3add0b){throw new common_1[(_0x6204d1(0x139))](_0x3add0b[_0x6204d1(0x23f)],common_1['HttpStatus'][_0x6204d1(0x14e)]);}}async[_0x5c7e7c(0x2e1)](_0x1204e6,_0x4b021d){const _0x52187b=_0x5c7e7c;var _0x15d184=_0x1204e6[_0x52187b(0x238)](),_0x2da135=new RegExp('imagine|variation|outpaint|pan|blend|inpaint|picreader|reroll'),_0x291ec8=new RegExp(_0x52187b(0x1e3)),_0x3e2fde=new RegExp('fetch|listbyids|modal|seed'),_0x59dd1e='';if(_0x4b021d===midjourney_constant_1[_0x52187b(0x181)][_0x52187b(0x188)])_0x59dd1e=_0x52187b(0x1ff);else{if(_0x4b021d===midjourney_constant_1[_0x52187b(0x181)]['relax'])_0x59dd1e='relax_mjDeduction';else _0x4b021d===midjourney_constant_1['DrawSpeed'][_0x52187b(0x1c7)]&&(_0x59dd1e=_0x52187b(0x1af));}if(_0x2da135['test'](_0x15d184))_0x59dd1e=_0x59dd1e+0x1;else{if(_0x291ec8[_0x52187b(0x319)](_0x15d184))_0x59dd1e=_0x59dd1e+0x2;else _0x3e2fde[_0x52187b(0x319)](_0x15d184)&&(_0x59dd1e=_0x59dd1e+0x3);}const _0x31ce02=await this['globalConfigService']['getConfigByKey'](_0x59dd1e);if(!_0x31ce02)return 0x4;return Number(_0x31ce02[_0x52187b(0x18e)])||0x4;}async[_0x5c7e7c(0x24f)](_0x55ccbd){const _0x5ec95d=_0x5c7e7c,{files:_0x45dc7f,mode:_0x37f5e2,action:_0x4984c7,jobId:_0x4f6196,userId:_0x494e7f}=_0x55ccbd;let _0x1a8b62=0x0;const {channel_id:_0xc88883,authorization:_0x391894,mjProxy:_0x10355f,mjProxyUrl:_0x47a358}=await this['getMjDefaultParams'](_0x37f5e2)[_0x5ec95d(0x31e)](_0x1405b6=>{const _0xe71e06=_0x5ec95d;return Promise[_0xe71e06(0x22f)](_0x1405b6);});let _0x2e0af2=[];if(_0x10355f==0x0)while(_0x1a8b62<_0x45dc7f[_0x5ec95d(0x1ea)]){const _0x154373=_0x45dc7f[_0x1a8b62],_0x1975a5=await this[_0x5ec95d(0x287)]({'channel_id':_0xc88883,'authorization':_0x391894,'filename':(0x0,utils_1[_0x5ec95d(0x252)])()+_0x154373[_0x5ec95d(0x32f)],'buffer':_0x154373[_0x5ec95d(0x1c6)],'needImage':![]})[_0x5ec95d(0x31e)](_0x5785cd=>{const _0x87b185=_0x5ec95d;return common_1[_0x87b185(0x1e6)][_0x87b185(0x135)](_0x5785cd),Promise[_0x87b185(0x2f3)]({'attachments':[]});});_0x2e0af2=_0x2e0af2[_0x5ec95d(0x1d3)](_0x1975a5[_0x5ec95d(0x281)]||[]),_0x1a8b62++;}else common_1[_0x5ec95d(0x1e6)][_0x5ec95d(0x29f)](_0x5ec95d(0x2d2)),_0x2e0af2=await this[_0x5ec95d(0x2d3)]({'proxy':_0x47a358,'channel_id':_0xc88883,'authorization':_0x391894,'file':_0x45dc7f,'needImage':![]})['then'](_0x157f8c=>_0x157f8c[_0x5ec95d(0x337)](_0x51f24e=>_0x51f24e['attachments']))[_0x5ec95d(0x2a6)](_0x57606e=>_0x57606e[_0x5ec95d(0x15d)]())[_0x5ec95d(0x31e)](_0x2fed1a=>{const _0x3dbe1e=_0x5ec95d;return common_1[_0x3dbe1e(0x1e6)][_0x3dbe1e(0x135)](_0x2fed1a),Promise[_0x3dbe1e(0x2f3)]({'attachments':[]});});common_1[_0x5ec95d(0x1e6)][_0x5ec95d(0x29f)](_0x5ec95d(0x2d9));const _0x1db8b6={'mode':_0x37f5e2,'action':_0x4984c7,'jobId':_0x4f6196,'userId':_0x494e7f,'imgUrl':'','extraParam':JSON[_0x5ec95d(0x262)]({'attachments':_0x2e0af2}),'originPrompt':'','mjpTaskId':''},_0x55ea65=await this[_0x5ec95d(0x210)](_0x1db8b6)[_0x5ec95d(0x31e)](_0x500424=>{const _0x2d1a3e=_0x5ec95d;common_1[_0x2d1a3e(0x1e6)][_0x2d1a3e(0x135)](_0x500424);});if(!_0x55ea65)throw new common_1[(_0x5ec95d(0x139))](_0x5ec95d(0x21f),common_1[_0x5ec95d(0x18d)][_0x5ec95d(0x14e)]);this[_0x5ec95d(0x301)]({'jobId':_0x4f6196})[_0x5ec95d(0x31e)](_0x200e12=>{const _0x582936=_0x5ec95d;common_1[_0x582936(0x1e6)]['error'](_0x200e12);}),await this[_0x5ec95d(0x1a1)]['deductFromBalance'](_0x494e7f,_0x5ec95d(0x1d5),0x4,0x4);return;}async['saveImageToText'](_0x48ebdf){const _0x2c021a=_0x5c7e7c,{file:_0x55c750,mode:_0x1280f2,action:_0x135a60,jobId:_0x4dd3c5,userId:_0x4aef0e}=_0x48ebdf;console[_0x2c021a(0x29f)](_0x2c021a(0x230),_0x4dd3c5);const {channel_id:_0x274dc9,authorization:_0x45f608,mjProxy:_0x30035b,mjProxyUrl:_0x36f82c}=await this[_0x2c021a(0x248)](_0x1280f2)[_0x2c021a(0x31e)](_0x41db9c=>{const _0x39a93e=_0x2c021a;return Promise[_0x39a93e(0x22f)](_0x41db9c);});let _0x3d5e34;Number(_0x30035b)==0x1?_0x3d5e34=await this[_0x2c021a(0x2d3)]({'proxy':_0x36f82c,'authorization':_0x45f608,'channel_id':_0x274dc9,'file':[_0x55c750],'needImage':!![]})[_0x2c021a(0x2a6)](_0xaa44d0=>_0xaa44d0[0x0]):_0x3d5e34=await this['uploadImage']({'authorization':_0x45f608,'channel_id':_0x274dc9,'filename':(0x0,utils_1['createRandomUid'])()+_0x55c750[_0x2c021a(0x32f)],'buffer':_0x55c750[_0x2c021a(0x1c6)],'needImage':!![]})[_0x2c021a(0x31e)](_0x4a5e2a=>{const _0x4c10cd=_0x2c021a;throw new common_1[(_0x4c10cd(0x139))](_0x4a5e2a,common_1[_0x4c10cd(0x18d)][_0x4c10cd(0x14e)]);});if(!_0x3d5e34)throw new common_1[(_0x2c021a(0x139))](_0x2c021a(0x135),common_1['HttpStatus'][_0x2c021a(0x14e)]);const {image:_0x433ccc,attachments:_0x49294d}=_0x3d5e34,_0x2dade1={'mode':_0x1280f2,'action':_0x135a60,'jobId':_0x4dd3c5,'userId':_0x4aef0e,'imgUrl':_0x433ccc?.[_0x2c021a(0x270)]||'','extraParam':JSON[_0x2c021a(0x262)]({'attachments':_0x49294d,..._0x433ccc}),'originPrompt':'','mjpTaskId':''},_0x1a8f25=await this[_0x2c021a(0x210)](_0x2dade1)[_0x2c021a(0x31e)](_0x280a1d=>{const _0x13e4c5=_0x2c021a;common_1['Logger'][_0x13e4c5(0x135)](_0x280a1d);});if(!_0x1a8f25)throw new common_1['HttpException'](_0x2c021a(0x21f),common_1[_0x2c021a(0x18d)][_0x2c021a(0x14e)]);return this[_0x2c021a(0x13c)]({'jobId':_0x4dd3c5})[_0x2c021a(0x31e)](_0x338b50=>{const _0x46c072=_0x2c021a;common_1[_0x46c072(0x1e6)][_0x46c072(0x135)](_0x338b50);}),await this[_0x2c021a(0x1a1)][_0x2c021a(0x2b1)](_0x4aef0e,'mjDraw',0x4,0x4),_0x4dd3c5;}async['runImageToTextJob'](_0x1f212b,_0x130c5f){const _0x5b7fc2=_0x5c7e7c,{attachments:_0x4357ae,mode:_0x7262c8}=_0x1f212b;return await this[_0x5b7fc2(0x33e)](_0x7262c8),await this[_0x5b7fc2(0x206)][_0x7262c8][_0x5b7fc2(0x282)][_0x5b7fc2(0x185)](_0x4357ae,(_0x454457,_0x16decc)=>{_0x130c5f(_0x454457,_0x16decc);});}async['runVaryRegionDrawJob'](_0x5dc456,_0x2549d8){const _0x5b6c3b=_0x5c7e7c,{customId:_0x54bdb6,prompt:_0xb46c09,mask:_0x548c69,mode:_0x1adcb0}=_0x5dc456;return await this[_0x5b6c3b(0x33e)](_0x1adcb0),await this['midJourney'][_0x1adcb0][_0x5b6c3b(0x282)][_0x5b6c3b(0x30d)](_0x54bdb6,_0xb46c09,_0x548c69,(_0x35128d,_0x564e41)=>{_0x2549d8(_0x35128d,_0x564e41);});}async[_0x5c7e7c(0x1cb)](_0x48f2f1,_0x51a2fc){const _0x4e52ff=_0x5c7e7c,{attachments:_0x8606a9,mode:_0x1e1f30}=_0x48f2f1;return await this['initMj'](_0x1e1f30),await this[_0x4e52ff(0x206)][_0x1e1f30][_0x4e52ff(0x282)][_0x4e52ff(0x314)](_0x8606a9,(_0x488839,_0x2a23c5)=>{_0x51a2fc(_0x488839,_0x2a23c5);});}async[_0x5c7e7c(0x1e7)](_0x543137,_0x18f5cd){const _0x1c6a32=_0x5c7e7c,{prompt:_0x225f38,mode:_0x22ff15}=_0x543137;return await this['initMj'](_0x22ff15),await this[_0x1c6a32(0x206)][_0x22ff15][_0x1c6a32(0x282)]['imagine'](_0x225f38,(_0x5ae594,_0x9e22dd)=>{_0x18f5cd(_0x5ae594,_0x9e22dd);});}async[_0x5c7e7c(0x220)](_0x308ef6,_0xe7954b){const _0xdc13b5=_0x5c7e7c,{messageId:_0x5bbfb0,customId:_0x17010d,messageFlags:_0x1f9799,mode:_0x3d1b65}=_0x308ef6;return await this['initMj'](_0x3d1b65),await this[_0xdc13b5(0x206)][_0x3d1b65]['api'][_0xdc13b5(0x1dd)](_0x5bbfb0,_0x17010d,_0x1f9799,_0xe7954b);}async[_0x5c7e7c(0x194)](_0x332aca){const _0x4d1208=_0x5c7e7c,{proxy:_0x51dabe,guild_id:_0x53fa91,channel_id:_0x48aab2,authorization:_0x231b18,prompt:_0x35de7e}=_0x332aca;return await axios_1[_0x4d1208(0x2a0)][_0x4d1208(0x163)](_0x51dabe+_0x4d1208(0x2ca),{'guild_id':_0x53fa91,'channel_id':_0x48aab2,'token':_0x231b18,'prompt':_0x35de7e});}async[_0x5c7e7c(0x1cd)](_0x3663b4){const _0x22fec6=_0x5c7e7c,{proxy:_0xd579a8,guild_id:_0x441a61,channel_id:_0x395f9c,message_id:_0x53f34e,custom_id:_0x6722e1,flags:_0x187db4,authorization:_0x1e360b}=_0x3663b4;return await axios_1[_0x22fec6(0x2a0)][_0x22fec6(0x163)](_0xd579a8+_0x22fec6(0x1ba),{'message_id':_0x53f34e,'custom_id':_0x6722e1,'flags':_0x187db4,'guild_id':_0x441a61,'channel_id':_0x395f9c,'token':_0x1e360b});}async[_0x5c7e7c(0x228)](_0xabac9f){const _0x1d641c=_0x5c7e7c,{proxy:_0x3ab251,guild_id:_0x2e41e7,channel_id:_0x45e86d,message_id:_0x14b0b6,custom_id:_0x46d0e8,flags:_0xb868a8,authorization:_0x31f722}=_0xabac9f;return await axios_1[_0x1d641c(0x2a0)][_0x1d641c(0x163)](_0x3ab251+'/api/mj/setting',{'message_id':_0x14b0b6,'custom_id':_0x46d0e8,'flags':_0xb868a8,'guild_id':_0x2e41e7,'channel_id':_0x45e86d,'token':_0x31f722});}async[_0x5c7e7c(0x2d7)](_0x557e1e){const _0x3ef907=_0x5c7e7c,_0x56da22=await this['midjourneyEntity'][_0x3ef907(0x201)]({'where':{'jobId':_0x557e1e}}),{id:_0x4c48ac,createdAt:_0x21e835,mode:_0x3243c2,action:_0x41286c,imgUrl:_0x492062,extraParam:_0x939b6d,prompt:_0x4a2829,translate:_0x232fa5}=_0x56da22;await this[_0x3ef907(0x266)](_0x557e1e,midjourney_constant_1[_0x3ef907(0x2c6)][_0x3ef907(0x1c8)]);let _0x196a48=_0x232fa5===0x1&&(0x0,utils_1['isChinese'])(_0x4a2829)?await this[_0x3ef907(0x14c)][_0x3ef907(0x156)](_0x4a2829):_0x4a2829;common_1[_0x3ef907(0x1e6)][_0x3ef907(0x29f)](_0x196a48,'翻译后的\x20'),common_1[_0x3ef907(0x1e6)][_0x3ef907(0x29f)](_0x232fa5===0x1&&(0x0,utils_1[_0x3ef907(0x2f9)])(_0x4a2829)?'是':'否','是否翻译\x20');const _0x39dade=_0x492062?_0x492062+'\x20'+_0x196a48+'\x20'+_0x939b6d:_0x196a48+'\x20'+_0x939b6d;return _0x232fa5===0x1&&(0x0,utils_1['isChinese'])(_0x4a2829)&&await this['midjourneyEntity']['update']({'id':_0x4c48ac},{'fullPrompt':_0x39dade,'prompt':_0x196a48})[_0x3ef907(0x31e)](_0x17a32b=>{const _0x201fe1=_0x3ef907;console[_0x201fe1(0x29f)](_0x17a32b),this[_0x201fe1(0x1e4)]({'id':_0x4c48ac,'userId':_0x56da22[_0x201fe1(0x1ed)],'action':_0x56da22[_0x201fe1(0x1dd)]});}),!![];}async[_0x5c7e7c(0x166)](_0x5be482){const _0x220690=_0x5c7e7c,{jobId:_0x49ae72,customId:_0x5485d6,prompt:_0x15026d,mask:_0x58abb0}=_0x5be482,_0x23cc7c=await this[_0x220690(0x182)][_0x220690(0x201)]({'where':{'jobId':_0x49ae72}});await this[_0x220690(0x266)](_0x49ae72,midjourney_constant_1['MidjourneyStatusEnum']['DRAWING']);const _0x27f287=await this[_0x220690(0x212)]['getConfigs']([_0x220690(0x138)]),{mode:_0x2f8b45,id:_0x3a73bc,createdAt:_0x5384b7}=_0x23cc7c;if(Number(_0x27f287)===0x0){const _0x3a5d1c=await this[_0x220690(0x17d)]({'customId':_0x5485d6,'prompt':_0x15026d,'mask':_0x58abb0,'mode':_0x2f8b45},async(_0x9b14bf,_0x581331)=>{const _0x2d5f7f=_0x220690;console[_0x2d5f7f(0x29f)](_0x2d5f7f(0x331),_0x9b14bf,_0x581331);if(_0x9b14bf===_0x2d5f7f(0x213)||_0x9b14bf==='MESSAGE_CREATE'){const {progress:_0x4fbc7b,content:_0x358ad9,url:_0x2166d1,id:_0x562f79,attachments:_0x24a731,flags:_0x3feede,components:_0x2eccb1}=_0x581331;await this[_0x2d5f7f(0x30c)]({'messageId':_0x562f79,'messageFlags':_0x3feede,'id':_0x3a73bc,'jobId':_0x49ae72,'createdAt':_0x5384b7,'extend':JSON[_0x2d5f7f(0x262)]({'components':_0x2eccb1,'attachments':_0x24a731[0x0]||{}})||'','url':_0x2166d1,'action':_0x23cc7c[_0x2d5f7f(0x1dd)],'progress':_0x4fbc7b,'type':_0x2d5f7f(0x213),'mode':_0x2f8b45,'prompt':_0x358ad9});}})[_0x220690(0x31e)](_0x163129=>{const _0x10caac=_0x220690;common_1[_0x10caac(0x1e6)][_0x10caac(0x135)](_0x163129,_0x10caac(0x13a)),this[_0x10caac(0x1e4)]({'id':_0x3a73bc,'userId':_0x23cc7c[_0x10caac(0x1ed)],'action':_0x23cc7c[_0x10caac(0x1dd)]});});if(!_0x3a5d1c)return;const _0x3bb4f5=(new Date(_0x3a5d1c[_0x220690(0x298)])[_0x220690(0x1ef)]()-new Date(_0x5384b7)[_0x220690(0x1ef)]())/0x3e8,{url:_0x2c50f9,progress:_0x7a03ef,components:_0x368009,attachments:_0x25d20b}=_0x3a5d1c;await this['updateDrawData'](_0x49ae72,{..._0x3a5d1c,'components':_0x368009,'attachments':_0x25d20b[0x0]||{},'messageFlags':_0x3a5d1c[_0x220690(0x14b)],'messageId':_0x3a5d1c['id'],'url':_0x2c50f9,'progress':_0x7a03ef,'action':_0x23cc7c[_0x220690(0x1dd)],'durationSpent':_0x3bb4f5,'prompt':_0x3a5d1c[_0x220690(0x351)]}),await this[_0x220690(0x30c)]({'durationSpent':_0x3bb4f5,'messageId':_0x3a5d1c['id'],'messageFlags':_0x3a5d1c[_0x220690(0x14b)],'id':_0x3a73bc,'jobId':_0x49ae72,'createdAt':_0x5384b7,'extend':JSON[_0x220690(0x262)]({'components':_0x368009,'attachments':_0x25d20b[0x0]||{}})||'','url':_0x2c50f9,'action':_0x23cc7c[_0x220690(0x1dd)],'progress':_0x7a03ef,'type':'INTERACTION_SUCCESS','mode':_0x2f8b45,'prompt':_0x3a5d1c[_0x220690(0x351)]});}else{console[_0x220690(0x29f)]('region\x20proxy\x20line');const {guild_id:_0x5aed56,channel_id:_0x100292,authorization:_0x433a8a,mjProxyUrl:_0x37a1c8,mjSocketProxyUrl:_0x352c89}=await this[_0x220690(0x248)](_0x2f8b45)[_0x220690(0x31e)](_0xc17b0c=>{const _0x2da36d=_0x220690;return Promise[_0x2da36d(0x22f)](_0xc17b0c);}),_0x3006b6=await this[_0x220690(0x18a)]({'guild_id':_0x5aed56,'channel_id':_0x100292,'authorization':_0x433a8a,'custom_id':_0x5485d6,'prompt':_0x15026d,'mask':_0x58abb0,'proxy':_0x37a1c8});await this[_0x220690(0x15e)](_0x352c89)[_0x220690(0x2a6)](_0x40d1df=>{const _0x4707ad=_0x220690;common_1['Logger'][_0x4707ad(0x29f)](_0x4707ad(0x187),_0x40d1df[_0x4707ad(0x29a)]),common_1[_0x4707ad(0x1e6)][_0x4707ad(0x29f)](_0x4707ad(0x18b),_0x40d1df[_0x4707ad(0x1d8)]),(!_0x40d1df[_0x4707ad(0x29a)]||!_0x40d1df['connected'])&&_0x40d1df[_0x4707ad(0x241)](),_0x40d1df['active']&&!_0x40d1df[_0x4707ad(0x1d8)]&&_0x40d1df[_0x4707ad(0x241)](),_0x40d1df['on'](_0x4707ad(0x18c),async _0x3564a7=>{const _0x1bd3b5=_0x4707ad,{nonceId:_0x15ed6a,msg:_0x384d75,type:_0x2b3488}=_0x3564a7;console[_0x1bd3b5(0x29f)](_0x15ed6a,_0x384d75,_0x2b3488);if(_0x3006b6['data']===_0x15ed6a){if(_0x2b3488===_0x1bd3b5(0x213)||_0x2b3488===_0x1bd3b5(0x2dd)){const {progress:_0x41d1e6,content:_0x22c343,url:_0x36b517,timestamp:_0x28b0e2,id:_0x33dfbe,flags:_0x3d4dde,components:_0x18bcfa,attachments:_0x5de439}=_0x384d75;if(_0x41d1e6<0x64)await this[_0x1bd3b5(0x30c)]({'id':_0x3a73bc,'messageId':_0x33dfbe,'messageFlags':_0x3d4dde,'extend':JSON[_0x1bd3b5(0x262)]({'components':_0x18bcfa,'attachments':_0x5de439[0x0]})||'','jobId':_0x49ae72,'createdAt':_0x23cc7c[_0x1bd3b5(0x267)],'progress':_0x41d1e6,'action':_0x23cc7c[_0x1bd3b5(0x1dd)],'url':_0x36b517||'','type':_0x2b3488,'mode':_0x2f8b45,'prompt':_0x22c343});else{const _0x2fe592=(new Date(_0x28b0e2)[_0x1bd3b5(0x1ef)]()-new Date(_0x23cc7c['createdAt'])[_0x1bd3b5(0x1ef)]())/0x3e8;await this['updateDrawData'](_0x49ae72,{..._0x384d75,'components':_0x18bcfa,'attachments':{'width':0x0,'height':0x0},'messageId':_0x33dfbe,'messageFlags':_0x3d4dde,'url':_0x36b517||'','action':_0x23cc7c[_0x1bd3b5(0x1dd)],'prompt':_0x22c343,'progress':_0x41d1e6,'durationSpent':_0x2fe592}),await this[_0x1bd3b5(0x30c)]({'durationSpent':_0x2fe592,'id':_0x3a73bc,'messageId':_0x33dfbe,'messageFlags':_0x3d4dde,'extend':JSON[_0x1bd3b5(0x262)]({'components':_0x18bcfa,'attachments':_0x5de439[0x0]})||'','jobId':_0x49ae72,'createdAt':_0x23cc7c[_0x1bd3b5(0x267)],'progress':_0x41d1e6,'action':_0x23cc7c['action'],'url':_0x36b517||'','type':_0x2b3488,'mode':_0x2f8b45,'prompt':_0x22c343});}}}});});}}async['runVaryRegionJobByProxy'](_0x5f4b02){const _0x203cd3=_0x5c7e7c,{proxy:_0x1ff443,guild_id:_0x1c43c8,custom_id:_0x11290d,prompt:_0x12f9aa,mask:_0x314c72,channel_id:_0x152afe,authorization:_0x1db3c3}=_0x5f4b02;return await axios_1[_0x203cd3(0x2a0)][_0x203cd3(0x163)](_0x1ff443+_0x203cd3(0x294),{'guild_id':_0x1c43c8,'channel_id':_0x152afe,'token':_0x1db3c3,'prompt':_0x12f9aa,'mask':_0x314c72,'custom_id':_0x11290d});}async['runMjDescribeTask'](_0x57a31c){const _0x29be36=_0x5c7e7c,{jobId:_0x17f8ce}=_0x57a31c,_0x517393=await this[_0x29be36(0x182)]['findOne']({'where':{'jobId':_0x17f8ce}});await this[_0x29be36(0x266)](_0x17f8ce,midjourney_constant_1[_0x29be36(0x2c6)][_0x29be36(0x1c8)]);const _0x3e463f=await this[_0x29be36(0x212)]['getConfigs'](['mjProxy']),{mode:_0x326492,id:_0x536d08,extraParam:_0x54a559,action:_0x2b07ca}=_0x517393;if(!_0x54a559){common_1['Logger'][_0x29be36(0x135)](_0x29be36(0x2e9)),await this[_0x29be36(0x1e4)]({'id':_0x536d08,'userId':_0x517393[_0x29be36(0x1ed)],'action':_0x517393[_0x29be36(0x1dd)]});return;}const _0x505885=JSON[_0x29be36(0x2f0)](_0x54a559),{attachments:_0xa27c0d}=_0x505885;common_1[_0x29be36(0x1e6)][_0x29be36(0x29f)]('文生图是否代理',_0x3e463f);if(Number(_0x3e463f)===0x0)await this[_0x29be36(0x192)]({'attachments':_0xa27c0d,'mode':_0x326492},async(_0x43d6b7,_0x2cc761)=>{const _0x12e1d0=_0x29be36;console[_0x12e1d0(0x29f)](_0x12e1d0(0x2ad),_0x43d6b7,_0x2cc761);if(_0x43d6b7===_0x12e1d0(0x213)){const {progress:_0x154382,url:_0x3846ee,timestamp:_0x193d26,id:_0x2d9790,flags:_0x4c38ba,components:_0x4d1738,embed:_0xf2a1bf}=_0x2cc761,_0x54ca1e=(new Date(_0x193d26)[_0x12e1d0(0x1ef)]()-new Date(_0x517393[_0x12e1d0(0x267)])[_0x12e1d0(0x1ef)]())/0x3e8;await this[_0x12e1d0(0x2ce)](_0x17f8ce,{..._0x2cc761,'components':_0x4d1738,'attachments':{'width':0x0,'height':0x0},'messageId':_0x2d9790,'messageFlags':_0x4c38ba,'url':_0x3846ee||'','action':_0x2b07ca,'prompt':_0xf2a1bf['description'],'progress':_0x154382,'durationSpent':_0x54ca1e}),await this[_0x12e1d0(0x30c)]({'durationSpent':_0x54ca1e,'id':_0x536d08,'messageId':_0x2d9790,'messageFlags':_0x4c38ba,'extend':JSON['stringify']({'components':_0x4d1738,'attachments':{}})||'','jobId':_0x17f8ce,'createdAt':_0x517393[_0x12e1d0(0x267)],'progress':_0x154382,'action':_0x2b07ca,'url':_0x3846ee||'','type':_0x43d6b7,'mode':_0x326492,'prompt':_0xf2a1bf['description']});}})[_0x29be36(0x31e)](_0x56720c=>{const _0x38799e=_0x29be36;common_1[_0x38799e(0x1e6)][_0x38799e(0x135)](_0x56720c),this[_0x38799e(0x1e4)]({'id':_0x536d08,'userId':_0x517393[_0x38799e(0x1ed)],'action':_0x517393[_0x38799e(0x1dd)]});});else{const {guild_id:_0xf301ee,channel_id:_0x17cdd3,authorization:_0x3bd1ac,mjProxyUrl:_0x510a1c,mjSocketProxyUrl:_0x23421b}=await this['getMjDefaultParams'](_0x326492)[_0x29be36(0x31e)](_0x209c4a=>{const _0x132391=_0x29be36;return Promise[_0x132391(0x22f)](_0x209c4a);}),_0x498389=await this['runMjDescribeProxy']({'guild_id':_0xf301ee,'channel_id':_0x17cdd3,'authorization':_0x3bd1ac,'files':_0xa27c0d,'proxy':_0x510a1c});await this[_0x29be36(0x15e)](_0x23421b)[_0x29be36(0x2a6)](_0x3152d3=>{const _0x59291e=_0x29be36;common_1[_0x59291e(0x1e6)][_0x59291e(0x29f)]('socket.active',_0x3152d3[_0x59291e(0x29a)]),common_1['Logger']['log']('socket.connected',_0x3152d3[_0x59291e(0x1d8)]),(!_0x3152d3['active']||!_0x3152d3['connected'])&&_0x3152d3['connect'](),_0x3152d3['active']&&!_0x3152d3[_0x59291e(0x1d8)]&&_0x3152d3[_0x59291e(0x241)](),_0x3152d3['on'](_0x59291e(0x185),async _0x10fa9f=>{const _0x225020=_0x59291e,{nonceId:_0x2262e8,msg:_0x4ee70d,type:_0x56ac17}=_0x10fa9f;if(_0x498389[_0x225020(0x183)]===_0x2262e8){if(_0x56ac17==='MESSAGE_UPDATE'){const {progress:_0x411f14,url:_0x17df5b,timestamp:_0x49bef9,id:_0x2b15ea,flags:_0x25a094,components:_0x23733f,embed:_0x43c6d3}=_0x4ee70d;console[_0x225020(0x29f)](_0x225020(0x159),_0x4ee70d);const _0x1ae7d7=(new Date(_0x49bef9)['getTime']()-new Date(_0x517393[_0x225020(0x267)])[_0x225020(0x1ef)]())/0x3e8;await this[_0x225020(0x2ce)](_0x17f8ce,{..._0x4ee70d,'components':_0x23733f,'attachments':{'width':0x0,'height':0x0},'messageId':_0x2b15ea,'messageFlags':_0x25a094,'url':_0x17df5b||'','action':_0x2b07ca,'prompt':_0x43c6d3['description'],'progress':_0x411f14,'durationSpent':_0x1ae7d7}),common_1[_0x225020(0x1e6)]['log'](_0x225020(0x15a)),await this[_0x225020(0x30c)]({'durationSpent':_0x1ae7d7,'id':_0x536d08,'messageId':_0x2b15ea,'messageFlags':_0x25a094,'extend':JSON[_0x225020(0x262)]({'components':_0x23733f,'attachments':{}})||'','jobId':_0x17f8ce,'createdAt':_0x517393[_0x225020(0x267)],'progress':_0x411f14,'action':_0x2b07ca,'url':_0x17df5b||'','type':_0x56ac17,'mode':_0x326492,'prompt':_0x43c6d3[_0x225020(0x257)]});}}});});}return!![];}async[_0x5c7e7c(0x2e2)](_0x4a35a4){const _0x3ddff1=_0x5c7e7c,{proxy:_0x4bee37,guild_id:_0x6d5b96,files:_0x318ab8,channel_id:_0x558d9e,authorization:_0x1a3ee9}=_0x4a35a4;return await axios_1[_0x3ddff1(0x2a0)][_0x3ddff1(0x163)](_0x4bee37+'/api/mj/describe',{'guild_id':_0x6d5b96,'channel_id':_0x558d9e,'token':_0x1a3ee9,'files':_0x318ab8});}async[_0x5c7e7c(0x168)](_0x3a2a43){const _0x490044=_0x5c7e7c,{proxy:_0x3b3c07,guild_id:_0x538bc2,files:_0x3e73d8,channel_id:_0x201b52,authorization:_0x52756a}=_0x3a2a43;return await axios_1[_0x490044(0x2a0)]['post'](_0x3b3c07+_0x490044(0x20e),{'guild_id':_0x538bc2,'channel_id':_0x201b52,'token':_0x52756a,'files':_0x3e73d8});}async[_0x5c7e7c(0x301)](_0xb4c1d){const _0x2fd23f=_0x5c7e7c;common_1[_0x2fd23f(0x1e6)][_0x2fd23f(0x29f)](_0x2fd23f(0x31b));const {jobId:_0x3bc24e}=_0xb4c1d,_0x24250e=await this[_0x2fd23f(0x182)][_0x2fd23f(0x201)]({'where':{'jobId':_0x3bc24e}});await this[_0x2fd23f(0x266)](_0x3bc24e,midjourney_constant_1[_0x2fd23f(0x2c6)]['DRAWING']);const _0x293ee6=await this[_0x2fd23f(0x212)]['getConfigs']([_0x2fd23f(0x138)]),{mode:_0x43d96c,id:_0x19504d,createdAt:_0x536238,extraParam:_0x453e7e,action:_0x1d0613}=_0x24250e;if(!_0x453e7e){common_1[_0x2fd23f(0x1e6)][_0x2fd23f(0x135)](_0x2fd23f(0x2e9)),this[_0x2fd23f(0x1e4)]({'id':_0x19504d,'userId':_0x24250e[_0x2fd23f(0x1ed)],'action':_0x24250e['action']});return;}const _0x1b2ad5=JSON[_0x2fd23f(0x2f0)](_0x453e7e),{attachments:_0x5a9ae8}=_0x1b2ad5;common_1['Logger'][_0x2fd23f(0x29f)](_0x293ee6==0x0,_0x2fd23f(0x30e));if(Number(_0x293ee6)===0x0){const _0x44a331=await this[_0x2fd23f(0x1cb)]({'attachments':_0x5a9ae8,'mode':_0x43d96c},async(_0x435d86,_0x5d82bd)=>{const _0x4ccb49=_0x2fd23f;console[_0x4ccb49(0x29f)]('runMjBlendTask\x20type,\x20runMjBlendTaskmsg\x20',_0x435d86,_0x5d82bd);if(_0x435d86===_0x4ccb49(0x213)){console[_0x4ccb49(0x29f)](_0x4ccb49(0x144),_0x1d0613);const {progress:_0x11052a,content:_0x44e5cb,url:_0x5db29f,id:_0x1e237d,attachments:_0x36d83d,flags:_0x4a6afb,components:_0x5ab924}=_0x5d82bd;await this[_0x4ccb49(0x30c)]({'messageId':_0x1e237d,'messageFlags':_0x4a6afb,'id':_0x19504d,'jobId':_0x3bc24e,'createdAt':_0x536238,'extend':JSON[_0x4ccb49(0x262)]({'components':_0x5ab924,'attachments':_0x36d83d[0x0]||{}})||'','url':_0x5db29f,'action':_0x24250e[_0x4ccb49(0x1dd)],'progress':_0x11052a,'type':'MESSAGE_UPDATE','mode':_0x43d96c,'prompt':_0x44e5cb});}})['catch'](_0x27ecb2=>{const _0x591ddf=_0x2fd23f;common_1[_0x591ddf(0x1e6)]['error'](_0x27ecb2),this[_0x591ddf(0x1e4)]({'id':_0x19504d,'userId':_0x24250e[_0x591ddf(0x1ed)],'action':_0x24250e[_0x591ddf(0x1dd)]});});console['log'](_0x2fd23f(0x2fc),_0x44a331);const _0x32e23a=(new Date(_0x44a331[_0x2fd23f(0x298)])['getTime']()-new Date(_0x536238)[_0x2fd23f(0x1ef)]())/0x3e8,{url:_0x835ded,progress:_0x385ee6,components:_0x196fc9,attachments:_0x9e9fa}=_0x44a331;await this['updateDrawData'](_0x3bc24e,{..._0x44a331,'components':_0x196fc9,'attachments':_0x9e9fa[0x0]||{},'messageFlags':_0x44a331[_0x2fd23f(0x14b)],'messageId':_0x44a331['id'],'url':_0x835ded,'progress':_0x385ee6,'action':_0x24250e[_0x2fd23f(0x1dd)],'durationSpent':_0x32e23a,'prompt':_0x44a331[_0x2fd23f(0x351)]}),await this['saveToRedis']({'durationSpent':_0x32e23a,'messageId':_0x44a331['id'],'messageFlags':_0x44a331[_0x2fd23f(0x14b)],'id':_0x19504d,'jobId':_0x3bc24e,'createdAt':_0x536238,'extend':JSON[_0x2fd23f(0x262)]({'components':_0x196fc9,'attachments':_0x9e9fa[0x0]||{}})||'','url':_0x835ded,'action':_0x24250e[_0x2fd23f(0x1dd)],'progress':_0x385ee6,'type':_0x2fd23f(0x1b7),'mode':_0x43d96c,'prompt':_0x44a331[_0x2fd23f(0x351)]});}else{common_1[_0x2fd23f(0x1e6)][_0x2fd23f(0x29f)]('图混图代理执行');const {guild_id:_0x2ad073,channel_id:_0x36b2e0,authorization:_0x495416,mjProxyUrl:_0x396e36,mjSocketProxyUrl:_0x152d98}=await this[_0x2fd23f(0x248)](_0x43d96c)[_0x2fd23f(0x31e)](_0x4f040f=>{return Promise['reject'](_0x4f040f);}),_0x417941=await this[_0x2fd23f(0x168)]({'guild_id':_0x2ad073,'channel_id':_0x36b2e0,'authorization':_0x495416,'files':_0x5a9ae8,'proxy':_0x396e36});await this[_0x2fd23f(0x15e)](_0x152d98)[_0x2fd23f(0x2a6)](_0x278c2d=>{const _0x1aab69=_0x2fd23f;common_1['Logger'][_0x1aab69(0x29f)](_0x1aab69(0x187),_0x278c2d[_0x1aab69(0x29a)]),common_1[_0x1aab69(0x1e6)][_0x1aab69(0x29f)](_0x1aab69(0x18b),_0x278c2d[_0x1aab69(0x1d8)]),(!_0x278c2d[_0x1aab69(0x29a)]||!_0x278c2d['connected'])&&_0x278c2d[_0x1aab69(0x241)](),_0x278c2d[_0x1aab69(0x29a)]&&!_0x278c2d[_0x1aab69(0x1d8)]&&_0x278c2d[_0x1aab69(0x241)](),_0x278c2d['on'](_0x1aab69(0x314),async _0x25a26c=>{const _0x9114ca=_0x1aab69,{nonceId:_0x209cda,msg:_0x759fa4,type:_0x87aab1}=_0x25a26c;if(_0x417941['data']===_0x209cda){if(_0x87aab1===_0x9114ca(0x213)||_0x87aab1===_0x9114ca(0x2dd)){const {progress:_0x250854,content:_0x3256d5,url:_0x3c3b77,id:_0x2e4f48,attachments:_0x379f6d,flags:_0x5a82ba,components:_0x408e58}=_0x759fa4;if(_0x250854<0x64)await this[_0x9114ca(0x30c)]({'messageId':_0x2e4f48,'messageFlags':_0x5a82ba,'id':_0x19504d,'jobId':_0x3bc24e,'createdAt':_0x536238,'extend':JSON['stringify']({'components':_0x408e58,'attachments':_0x379f6d[0x0]||{}})||'','url':_0x3c3b77,'action':_0x24250e[_0x9114ca(0x1dd)],'progress':_0x250854,'type':_0x9114ca(0x213),'mode':_0x43d96c,'prompt':_0x3256d5});else{const _0xcfc13=(new Date(_0x759fa4[_0x9114ca(0x298)])[_0x9114ca(0x1ef)]()-new Date(_0x536238)[_0x9114ca(0x1ef)]())/0x3e8,{components:_0x195651,attachments:_0x2ec7ec}=_0x759fa4;await this['updateDrawData'](_0x3bc24e,{'components':_0x195651,'attachments':_0x2ec7ec[0x0]||{},'messageFlags':_0x5a82ba,'messageId':_0x2e4f48,'url':_0x3c3b77,'progress':_0x250854,'action':_0x24250e[_0x9114ca(0x1dd)],'durationSpent':_0xcfc13,'prompt':_0x3256d5}),await this[_0x9114ca(0x30c)]({'durationSpent':_0xcfc13,'messageId':_0x2e4f48,'messageFlags':_0x5a82ba,'id':_0x19504d,'jobId':_0x3bc24e,'createdAt':_0x536238,'extend':JSON[_0x9114ca(0x262)]({'components':_0x195651,'attachments':_0x2ec7ec[0x0]||{}})||'','url':_0x3c3b77,'action':_0x24250e[_0x9114ca(0x1dd)],'progress':_0x250854,'type':_0x9114ca(0x1b7),'mode':_0x43d96c,'prompt':_0x3256d5});}}}});});}return!![];}async['runMjActionTask'](_0x58a692){const _0x2d5535=_0x5c7e7c,{jobId:_0x3f267c,messageId:_0x3f9e10,drawId:_0x418008,customId:_0x1f4d2a,messageFlags:_0x5a411e}=_0x58a692,_0x303714=await this[_0x2d5535(0x182)][_0x2d5535(0x201)]({'where':{'jobId':_0x3f267c}});await this['updateDrawStatus'](_0x3f267c,midjourney_constant_1[_0x2d5535(0x2c6)][_0x2d5535(0x1c8)]);const _0x249151=await this['globalConfigService']['getConfigs']([_0x2d5535(0x138)]),{mode:_0x1e06b8}=_0x303714;if(Number(_0x249151)===0x0){const _0x52e0b8=await this['runAction']({'messageId':_0x3f9e10,'customId':_0x1f4d2a,'messageFlags':_0x5a411e,'mode':_0x1e06b8},async(_0x44eeb8,_0x412800)=>{const _0x57a952=_0x2d5535;if(_0x44eeb8==='MESSAGE_UPDATE'){common_1[_0x57a952(0x1e6)]['log']('MESSAGE_UPDATE\x20jobId',_0x3f267c);const {progress:_0x132eba,content:_0x502a5b,url:_0x1aa476,id:_0x1e7659,flags:_0x3a49bb,components:_0x448db2}=_0x412800;_0x303714[_0x57a952(0x1dd)]!==midjourney_constant_1[_0x57a952(0x2b9)][_0x57a952(0x292)]&&await this[_0x57a952(0x30c)]({'id':_0x418008,'messageId':_0x1e7659,'messageFlags':_0x3a49bb,'extend':JSON[_0x57a952(0x262)]({'components':_0x448db2})||'','jobId':_0x3f267c,'action':_0x303714['action'],'createdAt':_0x303714[_0x57a952(0x267)],'progress':_0x132eba,'url':_0x1aa476||'','type':_0x44eeb8,'mode':_0x1e06b8,'prompt':_0x502a5b||''});}if(_0x44eeb8==='MESSAGE_CREATE'){const {progress:_0x12ee3f,id:_0x4cd323,flags:_0x215691,url:_0x6037dd,attachments:_0x3ce27f,components:_0x11c669}=_0x412800;common_1['Logger'][_0x57a952(0x29f)](_0x57a952(0x268),_0x3f267c),await this[_0x57a952(0x30c)]({'id':_0x418008,'messageId':_0x4cd323,'messageFlags':_0x215691,'extend':JSON[_0x57a952(0x262)]({'components':_0x11c669,'attachments':_0x3ce27f})||'','jobId':_0x3f267c,'action':_0x303714[_0x57a952(0x1dd)],'createdAt':_0x303714[_0x57a952(0x267)],'progress':_0x12ee3f,'url':_0x6037dd||'','type':_0x44eeb8,'mode':_0x1e06b8,'prompt':_0x412800['content']||_0x303714['fullPrompt']});}if(_0x44eeb8==='INTERACTION_MODAL_CREATE'){const {components:_0x447c05,id:_0x48355b,custom_id:_0x4155ea}=_0x412800;await this[_0x57a952(0x22a)]({'mode':_0x1e06b8,'components':_0x447c05,'customId':_0x4155ea,'id':_0x48355b,'action':_0x303714[_0x57a952(0x1dd)],'jobId':_0x3f267c,'drawId':_0x418008,'createdAt':_0x303714[_0x57a952(0x267)]});}})[_0x2d5535(0x31e)](_0x5b7d1c=>{const _0x3fb202=_0x2d5535;common_1[_0x3fb202(0x1e6)][_0x3fb202(0x135)](_0x5b7d1c),this['drawFailed']({'id':_0x418008,'userId':_0x303714[_0x3fb202(0x1ed)],'action':_0x303714[_0x3fb202(0x1dd)]});});if(!_0x52e0b8)return;const _0x4885f0=(new Date(_0x52e0b8[_0x2d5535(0x298)])[_0x2d5535(0x1ef)]()-new Date(_0x303714[_0x2d5535(0x267)])[_0x2d5535(0x1ef)]())/0x3e8,{url:_0x6c86d3,progress:_0x13e4c1,attachments:_0x3cdead,components:_0x1e7990}=_0x52e0b8;await this[_0x2d5535(0x2ce)](_0x3f267c,{..._0x52e0b8,'components':_0x1e7990,'attachments':_0x3cdead[0x0]||{},'messageId':_0x52e0b8['id'],'messageFlags':_0x52e0b8['flags'],'url':_0x6c86d3,'action':_0x303714[_0x2d5535(0x1dd)],'prompt':_0x52e0b8[_0x2d5535(0x351)],'progress':_0x13e4c1,'durationSpent':_0x4885f0}),await this['saveToRedis']({'durationSpent':_0x4885f0,'messageId':_0x52e0b8['id'],'messageFlags':_0x52e0b8['flags'],'id':_0x303714['id'],'jobId':_0x3f267c,'createdAt':_0x303714[_0x2d5535(0x267)],'extend':JSON['stringify']({'components':_0x1e7990,'attachments':_0x3cdead}),'action':_0x303714[_0x2d5535(0x1dd)],'url':_0x6c86d3,'progress':_0x13e4c1,'type':_0x2d5535(0x1b7),'mode':_0x1e06b8,'prompt':_0x52e0b8[_0x2d5535(0x351)]});}else{const {guild_id:_0x1b639a,channel_id:_0x5cfba1,authorization:_0x4766b7,mjProxyUrl:_0x3efc94,mjSocketProxyUrl:_0x27e324}=await this[_0x2d5535(0x248)](_0x1e06b8)[_0x2d5535(0x31e)](_0x318504=>{const _0x395da2=_0x2d5535;return Promise[_0x395da2(0x22f)](_0x318504);}),_0x2a0804=await this[_0x2d5535(0x1cd)]({'message_id':_0x3f9e10,'custom_id':_0x1f4d2a,'channel_id':_0x5cfba1,'proxy':_0x3efc94,'flags':_0x5a411e,'authorization':_0x4766b7,'guild_id':_0x1b639a});await this[_0x2d5535(0x15e)](_0x27e324)[_0x2d5535(0x2a6)](_0x3959a8=>{const _0x43636b=_0x2d5535;common_1[_0x43636b(0x1e6)]['log'](_0x43636b(0x187),_0x3959a8['active']),common_1[_0x43636b(0x1e6)][_0x43636b(0x29f)](_0x43636b(0x18b),_0x3959a8[_0x43636b(0x1d8)]),(!_0x3959a8[_0x43636b(0x29a)]||!_0x3959a8[_0x43636b(0x1d8)])&&_0x3959a8[_0x43636b(0x241)](),_0x3959a8[_0x43636b(0x29a)]&&!_0x3959a8[_0x43636b(0x1d8)]&&_0x3959a8['connect'](),_0x3959a8['on'](_0x43636b(0x1dd),async _0x2d1320=>{const _0x9f351b=_0x43636b,{nonceId:_0x2d84d0,msg:_0x557965,type:_0x4a4ab9}=_0x2d1320;if(_0x2a0804[_0x9f351b(0x183)]===_0x2d84d0){if(_0x4a4ab9===_0x9f351b(0x213)){const {progress:_0x47149f,content:_0x1fe5af,createdAt:_0x5eeb34,url:_0xe6cffa,id:_0x31ccd9,flags:_0xcc084a,attachments:_0x566cb1,components:_0x130a44}=_0x557965;_0x303714['action']!==midjourney_constant_1[_0x9f351b(0x2b9)][_0x9f351b(0x292)]&&(console[_0x9f351b(0x29f)](_0x9f351b(0x1fe),_0x47149f,_0x303714[_0x9f351b(0x1dd)]),await this['saveToRedis']({'id':_0x418008,'messageId':_0x31ccd9,'messageFlags':_0xcc084a,'extend':JSON[_0x9f351b(0x262)]({'components':_0x130a44})||'','jobId':_0x3f267c,'action':_0x303714[_0x9f351b(0x1dd)],'createdAt':_0x303714[_0x9f351b(0x267)],'progress':_0x47149f,'url':_0xe6cffa||'','type':_0x4a4ab9,'mode':_0x1e06b8,'prompt':_0x1fe5af||''}));}if(_0x4a4ab9===_0x9f351b(0x2dd)){console['log'](_0x9f351b(0x33a));const {progress:_0x38a177,timestamp:_0xa7fd86,createdAt:_0x4a4e3c,content:_0x5188e7,id:_0x2aae88,flags:_0x7dac28,url:_0x4a7c3c,attachments:_0x3b91f5,components:_0x370fee}=_0x557965;if(_0x38a177===0x64){console['log'](_0xa7fd86),console[_0x9f351b(0x29f)](_0x303714[_0x9f351b(0x267)]);const _0xe139c6=(new Date(_0xa7fd86)['getTime']()-new Date(_0x303714[_0x9f351b(0x267)])[_0x9f351b(0x1ef)]())/0x3e8;console['log'](_0xe139c6),await this[_0x9f351b(0x2ce)](_0x303714[_0x9f351b(0x230)],{..._0x557965,'url':_0x4a7c3c,'attachments':_0x3b91f5,'action':_0x303714[_0x9f351b(0x1dd)],'progress':_0x38a177,'prompt':_0x5188e7,'messageId':_0x3f9e10,'messageFlags':_0x7dac28,'durationSpent':_0xe139c6}),await this[_0x9f351b(0x30c)]({'progress':_0x38a177,'url':_0x4a7c3c,'type':_0x9f351b(0x213),'durationSpent':_0xe139c6,'jobId':_0x303714[_0x9f351b(0x230)],'createdAt':_0x4a4e3c,'action':_0x303714[_0x9f351b(0x1dd)],'messageId':_0x3f9e10,'messageFlags':_0x7dac28,'extend':JSON['stringify']({'components':_0x370fee,'attachments':_0x3b91f5[0x0]||{}})||'','id':_0x303714['id'],'mode':_0x1e06b8,'prompt':_0x5188e7});}else await this['saveToRedis']({'id':_0x418008,'messageId':_0x2aae88,'messageFlags':_0x7dac28,'extend':JSON[_0x9f351b(0x262)]({'components':_0x370fee,'attachments':_0x3b91f5})||'','jobId':_0x3f267c,'action':_0x303714[_0x9f351b(0x1dd)],'createdAt':_0x303714['createdAt'],'progress':_0x38a177,'url':_0x4a7c3c||'','type':_0x4a4ab9,'mode':_0x1e06b8,'prompt':_0x557965[_0x9f351b(0x351)]||_0x303714[_0x9f351b(0x256)]});}if(_0x4a4ab9===_0x9f351b(0x134)){const {components:_0x159439,id:_0x49331c,custom_id:_0x75001c}=_0x557965;await this['handleSubmitRemix']({'mode':_0x1e06b8,'components':_0x159439,'customId':_0x75001c,'id':_0x49331c,'action':_0x303714[_0x9f351b(0x1dd)],'jobId':_0x3f267c,'drawId':_0x418008,'createdAt':_0x303714[_0x9f351b(0x267)]});}}});});}return!![];}async[_0x5c7e7c(0x30c)](_0x4396fb){const _0x2770fb=_0x5c7e7c,{jobId:_0x2120ad,durationSpent:_0x7baf47,action:_0x202757,messageId:_0x2bd009,messageFlags:_0x169436,id:_0x3e4ea1,type:_0x3689db,extend:_0x305d80,createdAt:_0x22d6f4,progress:_0x13dd78,url:_0x361efa,prompt:_0x12dd03,mode:_0x3807ac}=_0x4396fb;let _0x467982='';if(_0x361efa){const _0x68982b=await this[_0x2770fb(0x212)][_0x2770fb(0x32d)](['mjProxyImgUrl']);_0x467982=_0x68982b+_0x2770fb(0x320)+_0x361efa;}return this[_0x2770fb(0x170)][_0x2770fb(0x345)]({'key':_0x2120ad,'val':JSON[_0x2770fb(0x262)]({'durationSpent':_0x7baf47,'messageId':_0x2bd009,'messageFlags':_0x169436,'id':_0x3e4ea1,'action':_0x202757,'extend':_0x305d80,'progress':_0x13dd78,'createdAt':_0x22d6f4,'status':_0x13dd78<0x64?midjourney_constant_1['MidjourneyStatusEnum']['DRAWING']:midjourney_constant_1[_0x2770fb(0x2c6)][_0x2770fb(0x1c1)],'prompt':_0x12dd03,'mode':_0x3807ac,'type':_0x3689db,'cosUrl':_0x467982})},0x5*0x3c*0x3e8);}async[_0x5c7e7c(0x2cb)](_0x3722ae){const {messageId:_0x3aff3d,customId:_0x73043a,messageFlags:_0x496ba2,mode:_0x62bbec}=_0x3722ae;return new Promise(async _0x36ad9d=>{const _0x1a2f13=_0x12ce,{guild_id:_0x1e7cbf,channel_id:_0x42922e,authorization:_0x13c016,mjProxyUrl:_0x4ea33d,mjProxy:_0x3a6d7e}=await this[_0x1a2f13(0x248)](_0x62bbec)[_0x1a2f13(0x31e)](_0x46b23d=>{const _0x15a8be=_0x1a2f13;return Promise[_0x15a8be(0x22f)](_0x46b23d);});if(_0x3a6d7e==0x0)await this['initMj'](_0x62bbec),await this[_0x1a2f13(0x220)]({'messageId':_0x3aff3d,'customId':_0x73043a,'messageFlags':_0x496ba2,'mode':_0x62bbec},async(_0x4fdbe4,_0x4d4ada)=>{const _0x29e63e=_0x1a2f13;if(_0x4fdbe4===_0x29e63e(0x199)){const {custom_id:_0x274eed,id:_0x460c84,nonce:_0x172891,varyRegionImgBase64:_0x4225b3,varyRegionPrompt:_0x300c05}=_0x4d4ada;_0x36ad9d({'customId':_0x274eed,'messageId':_0x460c84,'nonce':_0x172891,'varyRegionImgBase64':_0x4225b3,'varyRegionPrompt':_0x300c05});}})[_0x1a2f13(0x31e)](_0x31db44=>{const _0x5a360a=_0x1a2f13;common_1['Logger'][_0x5a360a(0x135)](_0x31db44);});else{const _0x4d0f95=await this['getRegionInfoByProxy']({'messageId':_0x3aff3d,'customId':_0x73043a,'messageFlags':_0x496ba2,'guild_id':_0x1e7cbf,'channel_id':_0x42922e,'authorization':_0x13c016,'mjProxyUrl':_0x4ea33d});_0x36ad9d(_0x4d0f95);}});}async[_0x5c7e7c(0x34a)](_0x3d4d2c){const _0x38cfcb=_0x5c7e7c;try{const _0x35ed14=await this[_0x38cfcb(0x182)][_0x38cfcb(0x201)]({'where':{'jobId':_0x3d4d2c}});if(!_0x35ed14)throw new Error(_0x38cfcb(0x2a4));const _0x180d1f=await this[_0x38cfcb(0x193)][_0x38cfcb(0x34a)]({},_0x35ed14[_0x38cfcb(0x305)]);if(_0x180d1f[_0x38cfcb(0x19f)]!==0x1)throw new Error(_0x180d1f[_0x38cfcb(0x257)]);return _0x180d1f['result'];}catch(_0x4eb149){throw new common_1['HttpException'](_0x4eb149['message'],common_1[_0x38cfcb(0x18d)][_0x38cfcb(0x14e)]);}}async['getRegionInfoByProxy'](_0x6e070a){const _0x27df48=_0x5c7e7c,{messageId:_0x345351,customId:_0x3364a4,messageFlags:_0x294b6e,guild_id:_0x4338c9,channel_id:_0x43b0d6,authorization:_0x5e1e71,mjProxyUrl:_0x10a044}=_0x6e070a;return axios_1['default'][_0x27df48(0x163)](_0x10a044+'/api/mj/region_info',{'message_id':_0x345351,'custom_id':_0x3364a4,'flags':_0x294b6e,'guild_id':_0x4338c9,'channel_id':_0x43b0d6,'token':_0x5e1e71})[_0x27df48(0x2a6)](_0x5e21d7=>_0x5e21d7[_0x27df48(0x183)]);}async['handleSubmitRemix'](_0x35003b){const _0x551fa9=_0x5c7e7c,{mode:_0x351715,id:_0x19fd69,customId:_0x2f8b01,createdAt:_0x38d849,jobId:_0x22c37c,drawId:_0x39de60,action:_0x5379d1,components:_0x4449ea}=_0x35003b;await this[_0x551fa9(0x33e)](_0x351715);const _0x53803b=await this[_0x551fa9(0x206)][_0x351715][_0x551fa9(0x282)]['remixSubmit'](_0x19fd69,_0x2f8b01,_0x4449ea,(_0x5ceabf,_0x2bd463)=>{const _0x184e68=_0x551fa9;if(_0x5ceabf==='MESSAGE_UPDATE'){const {progress:_0x81b80f,content:_0x38e07b,url:_0x31ecca,id:_0x5d6606,flags:_0xc674da,components:_0x22d821}=_0x2bd463;this[_0x184e68(0x30c)]({'messageId':_0x5d6606,'messageFlags':_0xc674da,'id':_0x39de60,'extend':JSON[_0x184e68(0x262)]({'components':_0x22d821})||'','jobId':_0x22c37c,'createdAt':_0x38d849,'progress':_0x81b80f,'action':_0x5379d1,'url':_0x31ecca,'type':_0x5ceabf,'mode':_0x351715,'prompt':_0x38e07b});}});console[_0x551fa9(0x29f)](_0x551fa9(0x20b),_0x53803b);const _0x8ac604=(new Date(_0x53803b[_0x551fa9(0x298)])[_0x551fa9(0x1ef)]()-new Date(_0x38d849)[_0x551fa9(0x1ef)]())/0x3e8,{url:_0xa80e9b,progress:_0x13ef3a,components:_0x4b2e71,attachments:_0x5cf9c9}=_0x53803b;await this[_0x551fa9(0x2ce)](_0x22c37c,{..._0x53803b,'components':_0x4b2e71,'action':_0x5379d1,'attachments':_0x5cf9c9[0x0]||{},'prompt':_0x53803b[_0x551fa9(0x351)],'messageFlags':_0x53803b[_0x551fa9(0x14b)],'messageId':_0x53803b['id'],'url':_0xa80e9b,'progress':_0x13ef3a,'durationSpent':_0x8ac604}),await this[_0x551fa9(0x30c)]({'jobId':_0x22c37c,'messageId':_0x53803b['id'],'messageFlags':_0x53803b[_0x551fa9(0x14b)],'id':_0x39de60,'durationSpent':_0x8ac604,'createdAt':_0x38d849,'extend':JSON[_0x551fa9(0x262)]({'components':_0x4b2e71,'attachments':_0x5cf9c9[0x0]||{}})||'','url':_0xa80e9b,'action':_0x5379d1,'progress':_0x13ef3a,'type':_0x551fa9(0x1b7),'mode':_0x351715,'prompt':_0x53803b[_0x551fa9(0x351)]});}async[_0x5c7e7c(0x2ce)](_0x258a50,_0x5be2e0){const _0x863e40=_0x5c7e7c;try{const {url:_0xa55160,messageId:_0x367f2c,action:_0x214beb,components:_0x546b20,messageFlags:_0x11e335,prompt:prompt='',attachments:_0x3095ac,durationSpent:_0x116d07,progress:_0x14a242}=_0x5be2e0;console[_0x863e40(0x29f)](_0x863e40(0x165),_0x14a242);const {width:width=0x0,height:height=0x0}=_0x3095ac,_0x3874e3=await this[_0x863e40(0x212)][_0x863e40(0x32d)]([_0x863e40(0x152)]);common_1[_0x863e40(0x1e6)][_0x863e40(0x29f)]('mjNotSaveImg:\x20',_0x3874e3);let _0xc2287e='';const _0x30de40=Date['now']();if(!Number(_0x3874e3)||Number(_0x3874e3)===0x0){common_1[_0x863e40(0x1e6)][_0x863e40(0x29f)]('------>\x20开始上传图片！！！','MidjourneyService');const _0x1f9f36=new Date();_0xc2287e=await this[_0x863e40(0x172)][_0x863e40(0x2ae)]({'filename':_0x30de40,'url':_0xa55160}),console[_0x863e40(0x29f)](_0x863e40(0x340),_0xc2287e);const _0x13f761=new Date();common_1[_0x863e40(0x1e6)]['log'](_0x863e40(0x145)+(_0x13f761[_0x863e40(0x1ef)]()-_0x1f9f36[_0x863e40(0x1ef)]())/0x3e8+'秒',_0x863e40(0x2a7));}else{const _0x2915a7=await this[_0x863e40(0x212)][_0x863e40(0x32d)]([_0x863e40(0x271)]);_0xc2287e=_0x2915a7+_0x863e40(0x320)+_0xa55160,common_1['Logger'][_0x863e40(0x29f)](_0x863e40(0x341));}const _0x1cb000=await this[_0x863e40(0x172)][_0x863e40(0x304)](),_0x1c4343={'prompt':prompt,'messageId':_0x367f2c,'messageFlags':_0x11e335,'status':midjourney_constant_1['MidjourneyStatusEnum'][_0x863e40(0x1c1)],'progress':_0x14a242,'action':_0x214beb,'fileInfo':JSON[_0x863e40(0x262)]({'filename':_0x30de40,'cosUrl':_0xc2287e,'width':width,'height':height,'cosType':_0x1cb000}),'extend':JSON['stringify']({'attachments':_0x3095ac,'components':_0x546b20,'url':_0xa55160}),'durationSpent':_0x116d07||0x0,'isSaveImg':!Number(_0x3874e3)||Number(_0x3874e3)===0x0};console[_0x863e40(0x29f)](_0x863e40(0x16e),_0x1c4343),await this['midjourneyEntity'][_0x863e40(0x19e)]({'jobId':_0x258a50},_0x1c4343)[_0x863e40(0x2a6)](_0x3f27bd=>_0x3f27bd[_0x863e40(0x306)]>0x0)[_0x863e40(0x31e)](_0x87bdb8=>{throw new Error(_0x87bdb8);});}catch(_0x4057ce){console[_0x863e40(0x29f)](_0x863e40(0x141),_0x258a50,_0x4057ce);}}[_0x5c7e7c(0x300)](_0x481049,_0x51b3ee,_0xbce140,_0x46a38e){const _0x239e81=_0x5c7e7c;if(!_0x481049)return{};const _0x3f562e=JSON[_0x239e81(0x2f0)](_0x481049),{cosUrl:_0x4091d3,width:_0x3a6295,height:_0x56c38f,cosType:_0x4f1637}=_0x3f562e,_0x99d54d=0x136,_0x23507d=_0x4f1637||(_0x4091d3[_0x239e81(0x1cf)](_0x239e81(0x23d))?_0x239e81(0x24a):_0x4091d3[_0x239e81(0x1cf)](_0x239e81(0x249))?_0x239e81(0x2a5):_0x239e81(0x2c0));let _0x15b0b2;if(_0x23507d===_0x239e81(0x24a)){const _0x320620=_0x3a6295/_0x56c38f,_0x1ece71=Math['round'](_0x99d54d/_0x320620);_0x15b0b2=_0x4091d3+(_0x239e81(0x2a3)+_0x99d54d+'/h/'+_0x1ece71+_0x239e81(0x1a0));}if(_0x23507d===_0x239e81(0x2a5)){const _0x142c66=_0x56c38f/_0x3a6295,_0x4c76c4=Math[_0x239e81(0x242)](_0x99d54d/_0x142c66);_0x15b0b2=_0x4091d3+(_0x239e81(0x344)+_0x4c76c4);}_0x23507d==='chevereto'&&(_0x15b0b2=_0x4091d3['replace'](/\.png$/,'.md.png'));_0x3f562e['thumbImg']=_0x15b0b2;if(!_0x51b3ee){const _0x32037a=_0xbce140+_0x239e81(0x320)+_0x46a38e;_0x3f562e['thumbImg']=_0x32037a,_0x3f562e[_0x239e81(0x24c)]=_0x32037a;}return _0x3f562e;}[_0x5c7e7c(0x2f7)](_0x36e451){const _0x34bd17=_0x5c7e7c,_0x268f93=/- Variations \(.*?\)/;return _0x268f93[_0x34bd17(0x319)](_0x36e451);}async[_0x5c7e7c(0x16f)](){const _0x586484=_0x5c7e7c;return await this[_0x586484(0x217)][_0x586484(0x209)]({'where':{'enable':0x1,'mode':(0x0,typeorm_2['In'])([midjourney_constant_1[_0x586484(0x181)][_0x586484(0x188)],midjourney_constant_1[_0x586484(0x181)][_0x586484(0x333)],midjourney_constant_1[_0x586484(0x181)][_0x586484(0x1c7)]])}})[_0x586484(0x2a6)](_0x590195=>_0x590195>0x0)[_0x586484(0x31e)](_0x435dda=>{const _0x58a622=_0x586484;return common_1[_0x58a622(0x1e6)][_0x58a622(0x135)](_0x435dda),![];});}async['getRandomKey'](_0x588585=midjourney_constant_1['DrawSpeed'][_0x5c7e7c(0x188)]){const _0x4c1c50=_0x5c7e7c,_0x476023=await this[_0x4c1c50(0x217)][_0x4c1c50(0x15c)]({'where':{'enable':0x1,'mode':_0x588585},'order':{'weight':_0x4c1c50(0x25b)}});if(!_0x476023[_0x4c1c50(0x1ea)])return Promise['reject'](_0x4c1c50(0x26e)+(_0x588585===midjourney_constant_1[_0x4c1c50(0x181)][_0x4c1c50(0x188)]?'快速':_0x588585===midjourney_constant_1[_0x4c1c50(0x181)][_0x4c1c50(0x333)]?'休闲':_0x4c1c50(0x1c7))+_0x4c1c50(0x205));return(0x0,utils_1['getRandomItemFromArray'])(_0x476023);}async[_0x5c7e7c(0x2ea)](_0x3fc1e9){const _0x9be100=_0x5c7e7c;if(MjConfig_1[_0x9be100(0x2a0)][_0x9be100(0x2ee)]!==_0x9be100(0x138))return new mjParam_entity_1[(_0x9be100(0x1a7))]();const _0x4fe14c=await this[_0x9be100(0x217)]['find']({'where':{'enable':0x1,'mode':_0x3fc1e9,'fastRemainTime':(0x0,typeorm_2[_0x9be100(0x189)])((0x0,typeorm_2['IsNull'])())},'order':{'weight':_0x9be100(0x25b)}});if(!_0x4fe14c[_0x9be100(0x1ea)])throw new Error(_0x9be100(0x2c4));return _0x4fe14c[0x0];}async['getModelProxyUrl'](_0x341f6a){const _0x192ea8=_0x5c7e7c,{proxyUrl:_0x4a0393}=_0x341f6a,_0x44fdc1=await this['globalConfigService'][_0x192ea8(0x32d)]([_0x192ea8(0x334)]);return _0x4a0393||_0x44fdc1||_0x192ea8(0x261);}async['addMjAccount'](_0x5ec5d5){const _0x264884=_0x5c7e7c;try{const {guildId:_0x4aa782,account:_0x136add,authorization:_0x3b8fb0,mode:_0x23d3a8,timeout:_0x80f095,channelId:_0x472aa2,remark:_0x51fa57,mjBotChannelId:_0x1cbff9,nijiBotChannelId:_0x73669a}=_0x5ec5d5;var _0x2cbe8a=await this[_0x264884(0x14a)][_0x264884(0x308)]({'data':{'channelId':_0x472aa2,'coreSize':0x3,'guildId':_0x4aa782,'mjBotChannelId':_0x1cbff9||'','nijiBotChannelId':_0x73669a||'','queueSize':0xa,'remark':_0x51fa57,'remixAutoSubmit':![],'timeoutMinutes':_0x80f095,'userAgent':_0x264884(0x1ae),'userToken':_0x3b8fb0}});if(_0x2cbe8a[_0x264884(0x19f)]!==0x1)throw new Error(_0x2cbe8a[_0x264884(0x257)]);const _0x310c0d=await this[_0x264884(0x217)][_0x264884(0x146)]({'account':_0x136add,'authorization':_0x3b8fb0,'mode':_0x23d3a8,'timeout':_0x80f095,'channelId':_0x472aa2,'guildId':_0x4aa782,'remark':_0x51fa57,'mjpId':_0x2cbe8a[_0x264884(0x296)],'mjBotChannelId':_0x1cbff9||'','nijiBotChannelId':_0x73669a||''});return await this[_0x264884(0x25f)](_0x2cbe8a[_0x264884(0x296)]),!!_0x310c0d;}catch(_0x18f312){common_1[_0x264884(0x1e6)][_0x264884(0x135)](_0x18f312);throw new common_1['HttpException'](_0x18f312[_0x264884(0x23f)],common_1[_0x264884(0x18d)][_0x264884(0x14e)]);}}async[_0x5c7e7c(0x26b)](_0x20c35f){const _0x7dec83=_0x5c7e7c,{id:_0x5089cc,account:_0x603775,authorization:_0x2eb636,mode:_0x1c337a,guildId:_0xf9012e,remark:_0x557213,channelId:_0x246b46,timeout:_0x4ad9d9,enable:_0x5d7660,mjBotChannelId:_0x5cf132,nijiBotChannelId:_0x3dcf89}=_0x20c35f;try{const _0x2943e2=await this[_0x7dec83(0x217)][_0x7dec83(0x22c)]({'id':Number(_0x5089cc)});var _0x1cc8aa=await this[_0x7dec83(0x14a)]['updateReconnect']({'data':{'channelId':_0x246b46,'coreSize':0x3,'guildId':_0xf9012e,'mjBotChannelId':_0x5cf132||'','nijiBotChannelId':_0x3dcf89||'','queueSize':0xa,'remark':_0x557213,'remixAutoSubmit':![],'timeoutMinutes':_0x4ad9d9,'userAgent':'Mozilla/5.0\x20(Macintosh;\x20Intel\x20Mac\x20OS\x20X\x2010_15_7)\x20AppleWebKit/537.36\x20(KHTML,\x20like\x20Gecko)\x20Chrome/112.0.0.0\x20Safari/537.36','userToken':_0x2eb636,'enable':Boolean(_0x5d7660)}},_0x2943e2[_0x7dec83(0x1be)]);if(_0x1cc8aa[_0x7dec83(0x19f)]!==0x1)throw new Error(_0x1cc8aa['description']);return await this[_0x7dec83(0x217)][_0x7dec83(0x19e)](_0x5089cc,{'account':_0x603775,'authorization':_0x2eb636,'mode':_0x1c337a,'guildId':_0xf9012e,'remark':_0x557213,'channelId':_0x246b46,'timeout':_0x4ad9d9,'mjBotChannelId':_0x5cf132||'','nijiBotChannelId':_0x3dcf89||''});}catch(_0xd707df){common_1['Logger'][_0x7dec83(0x135)](_0xd707df);throw new common_1[(_0x7dec83(0x139))](_0xd707df['message'],common_1[_0x7dec83(0x18d)][_0x7dec83(0x14e)]);}}async[_0x5c7e7c(0x336)](_0x5b316b,_0x4b2c48){const _0x4448cf=_0x5c7e7c;_0x5b316b[_0x4448cf(0x2f6)]=_0x4b2c48[_0x4448cf(0x20a)];if(_0x4b2c48[_0x4448cf(0x254)]===_0x4448cf(0x2d1))_0x5b316b[_0x4448cf(0x254)]=midjourney_constant_1[_0x4448cf(0x181)][_0x4448cf(0x188)];else{if(_0x4b2c48[_0x4448cf(0x254)]===_0x4448cf(0x352))_0x5b316b[_0x4448cf(0x254)]=midjourney_constant_1[_0x4448cf(0x181)][_0x4448cf(0x333)];else _0x4b2c48[_0x4448cf(0x254)]===_0x4448cf(0x328)&&(_0x5b316b[_0x4448cf(0x254)]=midjourney_constant_1[_0x4448cf(0x181)][_0x4448cf(0x1c7)]);}_0x5b316b['fastRemainTime']=_0x4b2c48[_0x4448cf(0x258)],_0x5b316b[_0x4448cf(0x2ba)]=_0x4b2c48['fastTimeRemaining'],_0x5b316b[_0x4448cf(0x2f8)]=_0x4b2c48[_0x4448cf(0x2f8)],_0x5b316b['relaxedUsage']=_0x4b2c48['relaxedUsage'],_0x5b316b['remix']=Number(_0x4b2c48['remix']);if(_0x4b2c48['subscribePlan']==='BASIC')_0x5b316b[_0x4448cf(0x29d)]=0x1;else{if(_0x4b2c48[_0x4448cf(0x14d)]===_0x4448cf(0x34b))_0x5b316b[_0x4448cf(0x29d)]=0x2;else{if(_0x4b2c48[_0x4448cf(0x14d)]===_0x4448cf(0x2c3))_0x5b316b['orderPlan']=0x3;else _0x4b2c48[_0x4448cf(0x14d)]===_0x4448cf(0x2d4)&&(_0x5b316b['orderPlan']=0x4);}}_0x5b316b['renewDate']=_0x4b2c48[_0x4448cf(0x1d9)],_0x5b316b[_0x4448cf(0x2b0)]=_0x4b2c48[_0x4448cf(0x1de)],_0x5b316b['setting']=JSON[_0x4448cf(0x262)](_0x4b2c48[_0x4448cf(0x311)]),_0x5b316b[_0x4448cf(0x1ce)]=JSON[_0x4448cf(0x262)](_0x4b2c48[_0x4448cf(0x31c)]),await this[_0x4448cf(0x217)][_0x4448cf(0x146)](_0x5b316b);}async['syncMjpAccount'](_0x4dffdd){const _0x23b7f3=_0x5c7e7c;try{if(MjConfig_1[_0x23b7f3(0x2a0)][_0x23b7f3(0x2ee)]!==_0x23b7f3(0x138))return;const _0x524222=await this[_0x23b7f3(0x14a)][_0x23b7f3(0x263)]({},_0x4dffdd);if(!_0x524222)return;const _0x58416e=await this[_0x23b7f3(0x217)][_0x23b7f3(0x201)]({'where':{'mjpId':_0x4dffdd}});await this['copyAccountInfo'](_0x58416e,_0x524222);}catch(_0x4db10b){common_1[_0x23b7f3(0x1e6)][_0x23b7f3(0x135)](_0x23b7f3(0x13e),_0x4db10b);}}async[_0x5c7e7c(0x32b)](){const _0xa8ab12=_0x5c7e7c,_0x77b600=await this['mjParamEntity'][_0xa8ab12(0x15c)]();if(!_0x77b600[_0xa8ab12(0x1ea)])return;for(let _0x36d282=0x0;_0x36d282<_0x77b600[_0xa8ab12(0x1ea)];_0x36d282++){this[_0xa8ab12(0x25f)](_0x77b600[_0x36d282][_0xa8ab12(0x1be)]);}}async[_0x5c7e7c(0x32a)]({id:_0x4bde6e}){const _0x16744f=_0x5c7e7c;try{const _0x3cff84=await this[_0x16744f(0x217)][_0x16744f(0x22c)]({'id':Number(_0x4bde6e)}),_0xff391f=await this[_0x16744f(0x14a)][_0x16744f(0x2fe)]({},_0x3cff84['mjpId']);if(_0xff391f['code']!==0x1)throw new Error(_0xff391f['description']);await this['copyAccountInfo'](_0x3cff84,_0xff391f[_0x16744f(0x296)]);}catch(_0x27d43f){throw new common_1['HttpException'](_0x27d43f[_0x16744f(0x23f)],common_1['HttpStatus']['BAD_REQUEST']);}}async['changeVersion'](_0x11dde1){const _0x3a1869=_0x5c7e7c;try{const _0x4ca22f=await this[_0x3a1869(0x217)][_0x3a1869(0x22c)]({'id':Number(_0x11dde1['id'])}),_0x1b61d2=await this['mjpAccountService'][_0x3a1869(0x203)]({'data':_0x11dde1},_0x4ca22f[_0x3a1869(0x1be)]);if(_0x1b61d2[_0x3a1869(0x19f)]!==0x1)throw new Error(_0x1b61d2['description']);return _0x4ca22f['mjVersion']=_0x11dde1[_0x3a1869(0x20a)],await this['mjParamEntity']['save'](_0x4ca22f),!![];}catch(_0x22f480){throw new common_1[(_0x3a1869(0x139))](_0x22f480[_0x3a1869(0x23f)],common_1[_0x3a1869(0x18d)][_0x3a1869(0x14e)]);}}async[_0x5c7e7c(0x1dd)](_0x561f73){const _0x1fcbea=_0x5c7e7c;try{const _0x4a7970=await this['mjParamEntity'][_0x1fcbea(0x22c)]({'id':Number(_0x561f73['id'])}),_0x129dda=await this[_0x1fcbea(0x14a)]['action']({'data':_0x561f73},_0x4a7970[_0x1fcbea(0x1be)]);if(_0x129dda[_0x1fcbea(0x19f)]!==0x1)throw new Error(_0x129dda[_0x1fcbea(0x257)]);return!![];}catch(_0x4541d9){throw new common_1[(_0x1fcbea(0x139))](_0x4541d9[_0x1fcbea(0x23f)],common_1[_0x1fcbea(0x18d)][_0x1fcbea(0x14e)]);}}async[_0x5c7e7c(0x1fb)](_0x42b72d){const _0x20f782=_0x5c7e7c,{id:_0x168777}=_0x42b72d;try{const _0x25daae=await this[_0x20f782(0x217)][_0x20f782(0x201)]({'where':{'id':Number(_0x168777)}});if(!_0x25daae)throw new Error('账号不存在');common_1['Logger'][_0x20f782(0x135)](_0x20f782(0x164),_0x25daae[_0x20f782(0x1be)]);const _0x4f1790=await this['mjpAccountService']['delete']({},_0x25daae[_0x20f782(0x1be)]);if(_0x4f1790['code']!==0x1)throw new Error(_0x4f1790[_0x20f782(0x257)]);const _0x2746aa=await this['mjParamEntity'][_0x20f782(0x32e)]({'id':_0x168777});return _0x2746aa[_0x20f782(0x306)];}catch(_0x2f270e){throw new common_1[(_0x20f782(0x139))](_0x2f270e[_0x20f782(0x23f)],common_1['HttpStatus'][_0x20f782(0x14e)]);}}async[_0x5c7e7c(0x2e0)](_0x59975f){const _0x4bb941=_0x5c7e7c,{id:_0x1e2d4e}=_0x59975f,_0x4486d4=await this['mjParamEntity'][_0x4bb941(0x201)]({'where':{'id':_0x1e2d4e}});if(!_0x4486d4)throw new common_1[(_0x4bb941(0x139))](_0x4bb941(0x216),common_1[_0x4bb941(0x18d)][_0x4bb941(0x14e)]);try{return await this[_0x4bb941(0x2fe)](_0x4486d4)['catch'](_0x3e934b=>{console['log'](_0x3e934b);});}catch(_0x825ff5){throw new common_1['HttpException'](_0x4bb941(0x14f),common_1[_0x4bb941(0x18d)]['BAD_REQUEST']);}}async[_0x5c7e7c(0x1c5)](_0x18f9a3){const _0x312cf4=_0x5c7e7c,{channelId:_0x35e8f9,guildId:_0x4be5da,authorization:_0x43542d,proxy:_0x1ef3c1}=_0x18f9a3;return await axios_1[_0x312cf4(0x2a0)][_0x312cf4(0x163)](_0x1ef3c1+'/api/mj/setting_get',{'token':_0x43542d,'channel_id':_0x35e8f9,'guild_id':_0x4be5da})[_0x312cf4(0x2a6)](_0x2c544f=>_0x2c544f[_0x312cf4(0x183)]);}async[_0x5c7e7c(0x2fe)](_0x2d722f,_0x5554da=![]){const _0x400a2b=_0x5c7e7c,{mjProxy:_0x1eeec8,mjProxyUrl:_0x261a09,mjSocketProxyUrl:_0x35bfb4}=await this[_0x400a2b(0x212)][_0x400a2b(0x32d)]([_0x400a2b(0x138),_0x400a2b(0x2aa),_0x400a2b(0x218)]),{channelId:_0x3723bc,guildId:_0x50d1cb,authorization:_0x5cea15}=_0x2d722f;let _0x585ebc;_0x1eeec8==0x0?_0x585ebc=await this['getSyncAccountInfo'](_0x2d722f):(_0x585ebc=await this[_0x400a2b(0x1c5)]({'channelId':_0x3723bc,'guildId':_0x50d1cb,'authorization':_0x5cea15,'proxy':_0x261a09}),console[_0x400a2b(0x29f)](_0x585ebc));const {settingInfo:_0x5228db,info:_0x243c22,subscription:_0x2ff3c,fastRemainTime:_0x4b52c2,lifetimeUsage:_0x1bf1fb,relaxedUsage:_0x179bbb,orderPlan:_0x1aed98}=_0x585ebc,_0x1aed19=await this[_0x400a2b(0x217)]['update'](_0x2d722f['id'],{'remix':_0x5228db['components'][0x1][_0x400a2b(0x2ed)][0x1][_0x400a2b(0x2eb)]===0x3?0x1:0x0,'setting':JSON[_0x400a2b(0x262)](_0x5228db),'fastRemainTime':_0x4b52c2[_0x400a2b(0x265)](),'info':_0x243c22,'renewDate':_0x2ff3c['trim'](),'orderPlan':_0x1aed98,'lifetimeUsage':_0x1bf1fb[_0x400a2b(0x265)](),'relaxedUsage':_0x179bbb['trim']()})[_0x400a2b(0x2a6)](_0xcb11fe=>_0xcb11fe[_0x400a2b(0x306)]>0x0)[_0x400a2b(0x31e)](_0x41cc2a=>{throw _0x41cc2a;});if(_0x5554da){const _0xc637c8=_0x5228db[_0x400a2b(0x2ed)];return _0xc637c8[0x1]['components'][0x1][_0x400a2b(0x2eb)]===0x3;}else return _0x1aed19;}async[_0x5c7e7c(0x237)](_0x17d2aa){return new Promise(async _0x5e18f3=>{const _0x540f41=_0x12ce;await this['midJourney'][_0x17d2aa][_0x540f41(0x282)][_0x540f41(0x1ce)]((_0x22da34,_0x550acd)=>{const _0x53ab76=_0x540f41;_0x22da34===_0x53ab76(0x213)&&_0x5e18f3(_0x550acd);});});}async[_0x5c7e7c(0x234)](_0x489ae7){return new Promise(async _0x1511e6=>{const _0x2baa71=_0x12ce;await this[_0x2baa71(0x206)][_0x489ae7][_0x2baa71(0x282)][_0x2baa71(0x2da)]((_0x1d6b09,_0x10b52c)=>{const _0x23f4de=_0x2baa71;_0x1d6b09===_0x23f4de(0x213)&&_0x1511e6(_0x10b52c);});});}async[_0x5c7e7c(0x250)](_0x3988b9){const _0x432a43=_0x5c7e7c,{id:_0x8677bd,enable:_0x20bd4d}=_0x3988b9;return await this['mjParamEntity'][_0x432a43(0x19e)](_0x8677bd,{'enable':_0x20bd4d})['then'](_0x42a5b0=>_0x42a5b0[_0x432a43(0x306)]>0x0);}async[_0x5c7e7c(0x28a)](_0x5c4946,_0x1cee74){const _0x197e1a=_0x5c7e7c,_0x275abe=_0x1cee74[_0x197e1a(0x307)][_0x197e1a(0x174)],_0x323e76=_0x275abe===_0x197e1a(0x1c2),{id:_0x2dc68e}=_0x5c4946;let _0x1ffb0a=null;try{const _0x2d2872=await this[_0x197e1a(0x217)][_0x197e1a(0x201)]({'where':{'id':_0x2dc68e}});return _0x323e76&&(_0x1ffb0a=await this[_0x197e1a(0x14a)]['fetch']({},_0x2d2872[_0x197e1a(0x1be)])),{..._0x2d2872,'mjpAccountInfo':_0x1ffb0a,'authorization':_0x323e76?_0x2d2872[_0x197e1a(0x291)]:(0x0,utils_1[_0x197e1a(0x1c9)])(_0x2d2872[_0x197e1a(0x291)]),'guildId':_0x323e76?_0x2d2872[_0x197e1a(0x1f1)]:(0x0,utils_1[_0x197e1a(0x1c9)])(_0x2d2872[_0x197e1a(0x1f1)]),'channelId':_0x323e76?_0x2d2872[_0x197e1a(0x22b)]:(0x0,utils_1[_0x197e1a(0x1c9)])(_0x2d2872['channelId'])};}catch(_0x45d11e){throw new common_1[(_0x197e1a(0x139))](_0x45d11e,common_1[_0x197e1a(0x18d)][_0x197e1a(0x14e)]);}}async[_0x5c7e7c(0x1ca)](_0x700b3a,_0x334016){const _0x4f22dc=_0x5c7e7c,_0xb05c8=_0x334016[_0x4f22dc(0x307)][_0x4f22dc(0x174)],{page:page=0x1,size:size=0x14,account:_0x268ff8,channelId:_0x1a2152,enable:_0x162b37}=_0x700b3a;if(!page||!size)throw new common_1[(_0x4f22dc(0x139))](_0x4f22dc(0x2c7),common_1[_0x4f22dc(0x18d)][_0x4f22dc(0x14e)]);const _0x36767d={};_0x268ff8&&Object['assign'](_0x36767d,{'account':(0x0,typeorm_2[_0x4f22dc(0x24d)])('%'+_0x268ff8+'%')}),_0x1a2152&&Object[_0x4f22dc(0x23e)](_0x36767d,{'channelId':(0x0,typeorm_2[_0x4f22dc(0x24d)])('%'+_0x1a2152+'%')}),_0x162b37>0x0&&Object['assign'](_0x36767d,{'enable':_0x162b37});const [_0x169c32,_0x31d0f2]=await this[_0x4f22dc(0x217)][_0x4f22dc(0x2c8)]({'skip':(page-0x1)*size,'where':_0x36767d,'take':size,'order':{'createdAt':_0x4f22dc(0x25b)},'cache':!![],'select':['id',_0x4f22dc(0x1f1),_0x4f22dc(0x22b),'authorization',_0x4f22dc(0x329),_0x4f22dc(0x147),_0x4f22dc(0x21c),_0x4f22dc(0x226),'orderPlan',_0x4f22dc(0x1d9),'createdAt',_0x4f22dc(0x254)]});return{'rows':_0xb05c8===_0x4f22dc(0x1c2)?_0x169c32:_0x169c32['map'](_0xa28652=>({..._0xa28652,'authorization':(0x0,utils_1[_0x4f22dc(0x1c9)])(_0xa28652['authorization']),'guildId':(0x0,utils_1[_0x4f22dc(0x1c9)])(_0xa28652[_0x4f22dc(0x1f1)]),'channelId':(0x0,utils_1[_0x4f22dc(0x1c9)])(_0xa28652[_0x4f22dc(0x22b)])}))||[],'count':_0x31d0f2||0x0};}async['setAttachment'](_0x3e7ae9){const _0x3aa8db=_0x5c7e7c,{authorization:_0x197e25,channel_id:_0x1d5258}=_0x3e7ae9,_0x16e435=_0x3aa8db(0x2d5)+_0x1d5258+_0x3aa8db(0x25c),_0x5bbe2c={'Content-Type':_0x3aa8db(0x22d),'authorization':_0x197e25};try{return await axios_1[_0x3aa8db(0x2a0)]['post'](_0x16e435,{'files':_0x3e7ae9[_0x3aa8db(0x2b6)]},{'headers':_0x5bbe2c});}catch(_0x44ae55){console[_0x3aa8db(0x29f)](_0x3aa8db(0x21b),_0x44ae55);throw new common_1['HttpException'](_0x3aa8db(0x1bf),common_1['HttpStatus'][_0x3aa8db(0x14e)]);}}async[_0x5c7e7c(0x2d3)](_0x297785){const _0x4cd262=_0x5c7e7c,{proxy:_0x383cd0,needImage:_0x38b175,file:_0x191b1c,authorization:_0x392e21,channel_id:_0x191af3}=_0x297785,_0x2ffcd1={'authorization':_0x392e21,'needImage':_0x38b175,'channel_id':_0x191af3,'files':_0x191b1c[_0x4cd262(0x337)](_0x3851a0=>_0x3851a0[_0x4cd262(0x1c6)][_0x4cd262(0x25d)](_0x4cd262(0x21a)))};return await axios_1[_0x4cd262(0x2a0)]['post'](_0x383cd0+_0x4cd262(0x310),_0x2ffcd1)[_0x4cd262(0x2a6)](_0x30e34f=>_0x30e34f[_0x4cd262(0x183)])[_0x4cd262(0x31e)](_0xba5265=>Promise[_0x4cd262(0x22f)](_0xba5265));}async[_0x5c7e7c(0x287)](_0x285629){const _0x471673=_0x5c7e7c,{buffer:_0x2accb6,channel_id:_0x236c2e,authorization:_0x245622,filename:_0x68f8f2,needImage:needImage=![]}=_0x285629,_0x33b51d=_0x2accb6[_0x471673(0x1ea)],_0x5b71c5=(0x0,createRandomId_1[_0x471673(0x160)])(),_0x157ad8=await this[_0x471673(0x236)]({'authorization':_0x245622,'channel_id':_0x236c2e,'files':[{'filename':_0x68f8f2,'file_size':_0x33b51d,'id':_0x5b71c5}]});if(_0x157ad8[_0x471673(0x269)]!=0xc8)return Promise[_0x471673(0x22f)](_0x471673(0x1bf));const _0x52669a=_0x157ad8['data'];if(_0x52669a[_0x471673(0x281)]?.['length']!=0x1)return Promise['reject'](_0x471673(0x1fc));const _0x1cc861=await axios_1['default'][_0x471673(0x2f1)](_0x52669a[_0x471673(0x281)][0x0][_0x471673(0x1b4)],_0x2accb6,{'headers':{'Content-Type':_0x471673(0x28e)}})[_0x471673(0x31e)](_0x36ca52=>{const _0x4ac8ec=_0x471673;return Promise[_0x4ac8ec(0x22f)]('上传文件失败...'+_0x36ca52);});if(_0x1cc861&&_0x1cc861[_0x471673(0x269)]!=0xc8&&_0x1cc861[_0x471673(0x269)]!=0xc9)throw new common_1[(_0x471673(0x139))](_0x471673(0x264),common_1[_0x471673(0x18d)][_0x471673(0x14e)]);const _0x15ae71=_0x52669a[_0x471673(0x281)][0x0]['upload_filename'],_0x545b48=_0x15ae71['split']('/'),_0x5e3573=_0x545b48[_0x471673(0x1ea)]>0x1?_0x545b48[0x1]:_0x545b48[0x0];if(needImage){const _0x21e0b8=_0x471673(0x2d5)+_0x236c2e+_0x471673(0x346),_0x54591f=await(0x0,axios_1['default'])({'url':''+_0x21e0b8,'method':_0x471673(0x163),'headers':{'Authorization':''+_0x245622,'Content-Type':_0x471673(0x22d)},'data':{'content':_0x5e3573,'channel_id':_0x236c2e,'type':0x0,'sticker_ids':[],'attachments':[{'id':0x0,'filename':_0x5e3573,'uploaded_filename':_0x15ae71}]}});if(_0x54591f[_0x471673(0x269)]!==0xc8)throw new common_1[(_0x471673(0x139))](_0x471673(0x243),common_1[_0x471673(0x18d)][_0x471673(0x14e)]);const _0x2bb9c5=await _0x54591f[_0x471673(0x183)];if(_0x2bb9c5[_0x471673(0x281)]?.[_0x471673(0x1ea)]!=0x1)throw new common_1[(_0x471673(0x139))](_0x471673(0x13d),common_1[_0x471673(0x18d)]['BAD_REQUEST']);return{'attachments':[{'id':_0x5b71c5,'filename':_0x5e3573,'uploaded_filename':_0x15ae71}],'image':_0x2bb9c5['attachments'][0x0]};}else return{'attachments':[{'id':_0x5b71c5,'filename':_0x5e3573,'uploaded_filename':_0x15ae71}],'image':{'url':''}};}async[_0x5c7e7c(0x266)](_0x35ca39,_0x3e0008){const _0x3c40fc=_0x5c7e7c;return await this[_0x3c40fc(0x182)][_0x3c40fc(0x19e)]({'jobId':_0x35ca39},{'status':_0x3e0008});}async[_0x5c7e7c(0x248)](_0x7852c0=midjourney_constant_1[_0x5c7e7c(0x181)][_0x5c7e7c(0x188)]){const _0x391810=_0x5c7e7c;try{const _0x48edfe=await this[_0x391810(0x25e)](_0x7852c0)['catch'](_0x1fcfb1=>{throw _0x1fcfb1;}),_0x323a94=await this[_0x391810(0x212)][_0x391810(0x32d)]([_0x391810(0x138),_0x391810(0x2aa),_0x391810(0x218)]);return{'guild_id':_0x48edfe[_0x391810(0x1f1)],'channel_id':_0x48edfe[_0x391810(0x22b)],'authorization':_0x48edfe['authorization'],'mjProxy':_0x323a94[_0x391810(0x138)],'mjProxyUrl':_0x323a94[_0x391810(0x2aa)],'mjSocketProxyUrl':_0x323a94['mjSocketProxyUrl']};}catch(_0x4d48d8){return Promise[_0x391810(0x22f)](_0x4d48d8);}}async[_0x5c7e7c(0x191)](_0x2ac313,_0x44e4ec){const _0x14966a=_0x5c7e7c;try{const _0x53bf27=_0x2ac313[_0x14966a(0x307)]['id'],{page:page=0x1,size:size=0x14,status:_0x5dad88,rec:_0x37501b,favorite:_0x4ccb0d}=_0x44e4ec,_0x185212={};_0x53bf27&&Object[_0x14966a(0x23e)](_0x185212,{'userId':_0x53bf27});Number(_0x4ccb0d)===0x1?Object[_0x14966a(0x23e)](_0x185212,{'favorite':Number(_0x4ccb0d)}):_0x5dad88>0x0&&Object[_0x14966a(0x23e)](_0x185212,{'status':_0x5dad88});const [_0x12bdca,_0x5619ec]=await this[_0x14966a(0x182)]['findAndCount']({'where':_0x185212,'order':{'id':_0x14966a(0x25b)},'take':size,'skip':(page-0x1)*size});return{'rows':(0x0,utils_1['formatCreateOrUpdateDate'])(_0x12bdca),'count':_0x5619ec};}catch(_0xc3b60a){console[_0x14966a(0x29f)](_0xc3b60a);throw new common_1[(_0x14966a(0x139))](_0x14966a(0x2d6),common_1[_0x14966a(0x18d)][_0x14966a(0x14e)]);}}async['checkIsActionDone'](_0x310f0f,_0x5484b9){const _0x3ad371=_0x5c7e7c,_0x878589=await this[_0x3ad371(0x182)][_0x3ad371(0x209)]({'where':{'originTaskId':String(_0x310f0f),'customId':_0x5484b9}});if(_0x878589>0x0)throw new common_1[(_0x3ad371(0x139))]('当前图片已经执行过相同指令！',common_1['HttpStatus'][_0x3ad371(0x14e)]);return![];}async[_0x5c7e7c(0x1c3)](_0x2b013a,_0x32926f){const _0x132741=_0x5c7e7c;try{const _0x3b7f56=await this[_0x132741(0x182)][_0x132741(0x201)]({'where':{'id':_0x2b013a,'userId':_0x32926f['user']['id']}});if(!_0x3b7f56)throw new Error(_0x132741(0x17e));if(_0x3b7f56[_0x132741(0x269)]===midjourney_constant_1['MidjourneyStatusEnum'][_0x132741(0x1c8)])throw new Error(_0x132741(0x2e8));await this[_0x132741(0x193)][_0x132741(0x22e)](null,_0x3b7f56['mjpTaskId']);const _0x98892=await this[_0x132741(0x182)][_0x132741(0x32e)]({'id':_0x2b013a});if(_0x98892[_0x132741(0x306)]>0x0)return _0x132741(0x312);else throw new Error(_0x132741(0x1e0));}catch(_0x5aa2e5){throw new common_1[(_0x132741(0x139))](_0x5aa2e5[_0x132741(0x23f)],common_1[_0x132741(0x18d)][_0x132741(0x14e)]);}}async[_0x5c7e7c(0x29c)](_0x499020,_0x3f751b){const _0x45eb35=_0x5c7e7c,{id:_0x20715f}=_0x499020['user'],_0x15b5ca=await this[_0x45eb35(0x182)][_0x45eb35(0x209)]({'where':{'userId':_0x20715f,'status':(0x0,typeorm_2['In'])([0x1,0x2])}}),_0x3cafaf=await this[_0x45eb35(0x248)](_0x3f751b)[_0x45eb35(0x31e)](_0x37cec0=>{return Promise['reject'](_0x37cec0);});if(!_0x3cafaf)throw new common_1[(_0x45eb35(0x139))](_0x45eb35(0x26f),common_1['HttpStatus'][_0x45eb35(0x14e)]);const _0x50cc6d=await this[_0x45eb35(0x212)][_0x45eb35(0x32d)](['mjLimitCount']),_0x5ee0fa=_0x50cc6d?Number(_0x50cc6d):0xa;if(_0x15b5ca>=_0x5ee0fa)throw new common_1[(_0x45eb35(0x139))](_0x45eb35(0x151)+_0x5ee0fa+_0x45eb35(0x1f8),common_1[_0x45eb35(0x18d)][_0x45eb35(0x14e)]);}async[_0x5c7e7c(0x1e4)](_0x4e1581){const _0x276e63=_0x5c7e7c,{id:_0x4f9306,userId:_0x3e8d29,action:_0x3ed4a9}=_0x4e1581,_0x37f9b9=0x4;await this['userBalanceService'][_0x276e63(0x222)](_0x3e8d29,_0x37f9b9),await this[_0x276e63(0x182)]['update']({'id':_0x4f9306},{'status':midjourney_constant_1[_0x276e63(0x2c6)]['DRAWFAIL']});}async[_0x5c7e7c(0x26d)](_0x4e1ada){const _0x94ce9c=_0x5c7e7c,{page:page=0x1,size:size=0x14,rec:_0x17d876,squareType:_0x2fc894,userId:_0x12d9d6,status:_0xe8f58,favorite:favorite=0x0,keyword:_0x4313d5}=_0x4e1ada,_0x1c85fd={};_0x12d9d6&&Object[_0x94ce9c(0x23e)](_0x1c85fd,{'userId':_0x12d9d6}),favorite&&Object['assign'](_0x1c85fd,{'favorite':favorite}),_0x17d876&&Object[_0x94ce9c(0x23e)](_0x1c85fd,{'rec':_0x17d876}),_0x4313d5&&Object[_0x94ce9c(0x23e)](_0x1c85fd,{'prompt':(0x0,typeorm_2['Like'])('%'+_0x4313d5+'%')}),_0xe8f58>0x0&&Object['assign'](_0x1c85fd,{'status':_0xe8f58}),_0x2fc894!==''&&Object[_0x94ce9c(0x23e)](_0x1c85fd,{'squareType':_0x2fc894});const [_0x537d08,_0x40e1a6]=await this[_0x94ce9c(0x182)]['findAndCount']({'where':_0x1c85fd,'take':size,'order':{'id':_0x94ce9c(0x25b)},'skip':(page-0x1)*size,'select':['fileInfo',_0x94ce9c(0x136),_0x94ce9c(0x1dd),'mode','prompt',_0x94ce9c(0x280),_0x94ce9c(0x204),'favorite',_0x94ce9c(0x267),'id','jobId','imageUrl','extend',_0x94ce9c(0x256),_0x94ce9c(0x27b),'isSaveImg']});return _0x537d08[_0x94ce9c(0x255)](_0x5ba24d=>{const _0x28664d=_0x94ce9c;_0x5ba24d['fileInfo']=_0x5ba24d[_0x28664d(0x2ff)]?JSON[_0x28664d(0x2f0)](_0x5ba24d['fileInfo']):{};}),{'rows':_0x537d08,'count':_0x40e1a6};}async['getOneDraw'](_0x565850,_0x4046cc){const _0x43b00d=_0x5c7e7c;try{let _0x107ab7,_0x31eba5,_0x3e8567,_0x4fb94d;const {jobId:_0x3f8037,detail:_0x1e5aa3}=_0x4046cc;if(_0x565850['headers'][_0x43b00d(0x291)]){const _0x26d87a=_0x565850[_0x43b00d(0x1a4)][_0x43b00d(0x291)][_0x43b00d(0x178)]('\x20'),_0x3d36c4=jwt[_0x43b00d(0x34c)](_0x26d87a[0x1],process[_0x43b00d(0x1ad)][_0x43b00d(0x2cd)]);_0x31eba5=_0x3d36c4['id'];}const _0x475552=await this[_0x43b00d(0x182)]['findOne']({'where':{'jobId':_0x3f8037}});return _0x1e5aa3&&(this[_0x43b00d(0x16c)][_0x43b00d(0x1a9)](relate_contant_1['ELogRelateType']['mj'],_0x475552['id']),_0x107ab7=await this[_0x43b00d(0x2c2)][_0x43b00d(0x201)]({'where':{'id':_0x475552['userId']}}),_0x3e8567=await this['aiLogService'][_0x43b00d(0x13b)](relate_contant_1['ELogRelateType']['mj'],_0x475552['id']),_0x31eba5&&(_0x4fb94d=await this[_0x43b00d(0x16c)][_0x43b00d(0x32c)](relate_contant_1[_0x43b00d(0x28b)]['mj'],_0x475552['id']))),{..._0x475552,'avatar':_0x107ab7?_0x107ab7['avatar']:null,'username':_0x107ab7?_0x107ab7[_0x43b00d(0x17c)]:null,'nickname':_0x107ab7?_0x107ab7[_0x43b00d(0x2bb)]:null,'visitNum':_0x3e8567?_0x3e8567[_0x43b00d(0x1b2)]:0x0,'agreeNum':_0x3e8567?_0x3e8567[_0x43b00d(0x1dc)]:0x0,'agree':_0x4fb94d?_0x4fb94d[_0x43b00d(0x1dd)]:null};}catch(_0x57e9cc){throw new common_1['HttpException'](_0x57e9cc['message'],common_1[_0x43b00d(0x18d)][_0x43b00d(0x14e)]);}}async[_0x5c7e7c(0x215)](_0xcda961,_0x5dc835){const _0x4378eb=_0x5c7e7c;try{if(!_0x5dc835['jobIds']||!_0x5dc835[_0x4378eb(0x30b)][_0x4378eb(0x1ea)])return[];const _0x149e0d=_0x5dc835[_0x4378eb(0x30b)][_0x4378eb(0x178)](','),_0x5b0983=await this[_0x4378eb(0x182)]['find']({'where':{'jobId':(0x0,typeorm_2['In'])(_0x149e0d)}});return _0x5b0983;}catch(_0x1f7626){throw new common_1[(_0x4378eb(0x139))](_0x1f7626[_0x4378eb(0x23f)],common_1[_0x4378eb(0x18d)]['BAD_REQUEST']);}}async[_0x5c7e7c(0x1d6)](_0x41420d,_0x42003b){const _0x2d975e=_0x5c7e7c;try{const {page:page=0x1,size:size=0xa,rec:_0x2fa33c,userId:_0x45529c,status:_0x2d550e}=_0x42003b,_0x35d660={};_0x2fa33c&&Object[_0x2d975e(0x23e)](_0x35d660,{'rec':_0x2fa33c}),_0x45529c&&Object[_0x2d975e(0x23e)](_0x35d660,{'userId':_0x45529c}),_0x2d550e&&Object[_0x2d975e(0x23e)](_0x35d660,{'status':_0x2d550e});const [_0x22754b,_0x2c6ee4]=await this[_0x2d975e(0x182)]['findAndCount']({'where':_0x35d660,'order':{'id':_0x2d975e(0x25b)},'take':size,'skip':(page-0x1)*size}),_0x1378b6=_0x22754b['map'](_0x18f270=>_0x18f270[_0x2d975e(0x1ed)])[_0x2d975e(0x290)](_0x1d2adb=>_0x1d2adb<0x186a0),_0x55cedb=await this[_0x2d975e(0x2c2)][_0x2d975e(0x15c)]({'where':{'id':(0x0,typeorm_2['In'])(_0x1378b6)},'select':['id','username',_0x2d975e(0x196),_0x2d975e(0x1db)]});return _0x22754b[_0x2d975e(0x255)](_0x1890b3=>{const _0x2a44e0=_0x2d975e;_0x1890b3[_0x2a44e0(0x207)]=_0x55cedb[_0x2a44e0(0x15c)](_0x3e68c0=>_0x3e68c0['id']===_0x1890b3['userId']),_0x1890b3['isGroup']=![];}),_0x41420d[_0x2d975e(0x307)]['role']!==_0x2d975e(0x1c2)&&_0x22754b[_0x2d975e(0x255)](_0x3ff7d4=>{const _0x5bb174=_0x2d975e;_0x3ff7d4['userInfo']&&_0x3ff7d4[_0x5bb174(0x207)]['email']&&(_0x3ff7d4[_0x5bb174(0x207)][_0x5bb174(0x1db)]=_0x3ff7d4['userInfo'][_0x5bb174(0x1db)][_0x5bb174(0x161)](/(.{2}).+(.{2}@.+)/,_0x5bb174(0x303)));}),{'rows':_0x22754b,'count':_0x2c6ee4};}catch(_0x4e873e){throw new common_1['HttpException'](_0x2d975e(0x155),common_1[_0x2d975e(0x18d)][_0x2d975e(0x14e)]);}}[_0x5c7e7c(0x20c)](_0x5bc01a){const _0x37e380=_0x5c7e7c;return _0x5bc01a[_0x37e380(0x161)](/^\**/g,'');}async[_0x5c7e7c(0x21e)](_0x39df0a){const _0x40a093=_0x5c7e7c,{id:_0x3488a0,squareType:_0xff1b6c}=_0x39df0a,_0x43a48d=await this[_0x40a093(0x182)][_0x40a093(0x201)]({'where':{'id':_0x3488a0,'status':midjourney_constant_1['MidjourneyStatusEnum'][_0x40a093(0x1c1)]}});if(!_0x43a48d)throw new common_1[(_0x40a093(0x139))](_0x40a093(0x348),common_1['HttpStatus'][_0x40a093(0x14e)]);const _0x1e9ab2=await this[_0x40a093(0x182)]['update']({'id':_0x3488a0},{'rec':0x1,'squareType':_0xff1b6c})[_0x40a093(0x31e)](_0x3262da=>{const _0x30207c=_0x40a093;throw new common_1[(_0x30207c(0x139))](_0x3262da,common_1[_0x30207c(0x18d)]['BAD_REQUEST']);});if(_0x1e9ab2['affected']<=0x0)throw new common_1[(_0x40a093(0x139))](_0x40a093(0x285),common_1['HttpStatus'][_0x40a093(0x14e)]);return await this['redisCacheService'][_0x40a093(0x158)]({'key':_0x40a093(0x23a)}),!![];}async['setImageFavorite'](_0x3b270b){const _0x44e3bd=_0x5c7e7c,{id:_0x25d012,favorite:_0x1650f2}=_0x3b270b,_0x2d2a09=await this['midjourneyEntity']['findOne']({'where':{'id':_0x25d012}})[_0x44e3bd(0x31e)](_0x14f18f=>{const _0x4c9594=_0x44e3bd;common_1[_0x4c9594(0x1e6)][_0x4c9594(0x135)](_0x14f18f);});if(!_0x2d2a09)throw new common_1['HttpException'](_0x44e3bd(0x348),common_1[_0x44e3bd(0x18d)][_0x44e3bd(0x14e)]);const _0x1a430e=await this['midjourneyEntity']['update']({'id':_0x25d012},{'favorite':_0x1650f2});if(_0x1a430e[_0x44e3bd(0x306)]<=0x0)throw new common_1[(_0x44e3bd(0x139))](_0x44e3bd(0x285),common_1[_0x44e3bd(0x18d)]['BAD_REQUEST']);return!![];}async[_0x5c7e7c(0x293)](){const _0x45fce2=_0x5c7e7c;try{await this[_0x45fce2(0x182)]['update']({'status':0x2},{'status':0x4});}catch(_0x1156e3){console[_0x45fce2(0x29f)](_0x45fce2(0x1f9),_0x1156e3);}}async[_0x5c7e7c(0x2bf)](_0x471f2b,_0xddbb63){const _0x55e4f5=_0x5c7e7c,{id:_0x2757dc}=_0xddbb63;if(!_0x2757dc)throw new common_1['HttpException'](_0x55e4f5(0x260),common_1['HttpStatus'][_0x55e4f5(0x14e)]);const _0x28859b=await this[_0x55e4f5(0x182)][_0x55e4f5(0x32e)]({'id':_0x2757dc});if(_0x28859b[_0x55e4f5(0x306)]<=0x0)throw new common_1['HttpException'](_0x55e4f5(0x1e9),common_1[_0x55e4f5(0x18d)][_0x55e4f5(0x14e)]);return!![];}async[_0x5c7e7c(0x219)](_0x3ade49,_0x527f16){const _0x5a15df=_0x5c7e7c;try{const {prompt:_0x1583c1,status:_0x23f837,isCarryParams:_0x3a784e,imageUrl:_0x323bc4,title:_0x597842,order:_0x260ec1,id:_0x486b61,aspect:_0x177203}=_0x527f16;return _0x486b61?await this[_0x5a15df(0x2e7)][_0x5a15df(0x19e)]({'id':_0x486b61},{'prompt':_0x1583c1,'imageUrl':_0x323bc4,'status':_0x23f837,'isCarryParams':_0x3a784e,'order':_0x260ec1,'aspect':_0x177203})[_0x5a15df(0x2a6)](_0x56e1e5=>!!_0x56e1e5):await this['mjPromptsEntity'][_0x5a15df(0x146)]({'prompt':_0x1583c1,'status':_0x23f837,'imageUrl':_0x323bc4,'isCarryParams':_0x3a784e,'title':_0x597842,'order':_0x260ec1,'aspect':_0x177203})[_0x5a15df(0x2a6)](_0x97c252=>!!_0x97c252);}catch(_0x333294){console['log'](_0x5a15df(0x1b1),_0x333294);}}async[_0x5c7e7c(0x283)](_0x33d27d,_0x11b58c){const _0x40b1e6=_0x5c7e7c,{id:_0x5199ac}=_0x11b58c;if(!_0x5199ac)throw new common_1[(_0x40b1e6(0x139))](_0x40b1e6(0x260),common_1['HttpStatus'][_0x40b1e6(0x14e)]);return await this[_0x40b1e6(0x2e7)][_0x40b1e6(0x32e)]({'id':_0x5199ac});}async[_0x5c7e7c(0x23c)](){const _0x14d74a=_0x5c7e7c;return await this[_0x14d74a(0x2e7)][_0x14d74a(0x15c)]({'order':{'order':_0x14d74a(0x25b)}})[_0x14d74a(0x2a6)](_0x34e873=>_0x34e873||[])[_0x14d74a(0x31e)](_0x31e913=>{const _0x37bf4d=_0x14d74a;common_1[_0x37bf4d(0x1e6)][_0x37bf4d(0x135)](_0x31e913);});}async[_0x5c7e7c(0x176)](_0xdd4f42){const _0x17e2b2=_0x5c7e7c,{size:_0x447773,page:_0xf0c8c7}=_0xdd4f42;return await this[_0x17e2b2(0x2e7)][_0x17e2b2(0x15c)]({'order':{'order':_0x17e2b2(0x25b)},'take':_0x447773,'skip':(_0xf0c8c7-0x1)*_0x447773})['catch'](_0x47e78d=>{const _0x530fd7=_0x17e2b2;console[_0x530fd7(0x29f)](_0x47e78d);});}async[_0x5c7e7c(0x279)](_0x4e9883){const {mode:_0x271974}=_0x4e9883;}async[_0x5c7e7c(0x318)](_0x5be70a){const _0x279d74=_0x5c7e7c;try{const {name:_0x3c747b,value:_0x1ef52e}=_0x5be70a,_0x13183c=await this['mjInspireClassifyEntity'][_0x279d74(0x22c)]({'name':_0x3c747b});if(_0x13183c)throw new common_1['HttpException'](_0x279d74(0x1a2),common_1[_0x279d74(0x18d)][_0x279d74(0x14e)]);return await this[_0x279d74(0x1ec)]['save']({'name':_0x3c747b,'value':_0x1ef52e})[_0x279d74(0x2a6)](_0x1ebe37=>!!_0x1ebe37)[_0x279d74(0x31e)](_0x2edff1=>{const _0x139a65=_0x279d74;console[_0x139a65(0x29f)](_0x2edff1);throw new common_1[(_0x139a65(0x139))](_0x2edff1,common_1[_0x139a65(0x18d)][_0x139a65(0x14e)]);});}catch(_0x5ddd4b){return![];}}async[_0x5c7e7c(0x321)](_0x3ea118){const _0x68df0e=_0x5c7e7c,{id:_0x40c21f,name:_0x1be8bf,value:_0x25a757}=_0x3ea118;return await this[_0x68df0e(0x1ec)][_0x68df0e(0x19e)](_0x40c21f,{'name':_0x1be8bf,'value':_0x25a757})[_0x68df0e(0x2a6)](_0x462ca4=>!!_0x462ca4);}async['removeMjInspireClassify'](_0x32edc2){const _0x57281d=_0x5c7e7c,{id:_0x313b37}=_0x32edc2;return await this[_0x57281d(0x1ec)][_0x57281d(0x32e)]({'id':_0x313b37})[_0x57281d(0x31e)](_0x16431f=>{const _0xdf91b7=_0x57281d;throw new common_1[(_0xdf91b7(0x139))](_0x16431f,common_1[_0xdf91b7(0x18d)]['BAD_REQUEST']);});}async[_0x5c7e7c(0x2af)](_0xe1394d){const _0x1e1591=_0x5c7e7c,{size:_0x8c5fe7,page:_0x10b373}=_0xe1394d,_0x254739=await this[_0x1e1591(0x1ec)]['findAndCount']({'order':{'createdAt':_0x1e1591(0x25b)},'take':_0x8c5fe7,'skip':(_0x10b373-0x1)*_0x8c5fe7})[_0x1e1591(0x31e)](_0x305373=>{const _0x25fe7f=_0x1e1591;throw new common_1[(_0x25fe7f(0x139))](_0x305373,common_1[_0x25fe7f(0x18d)][_0x25fe7f(0x14e)]);});if(!_0x254739)throw new common_1[(_0x1e1591(0x139))](_0x1e1591(0x2b2),common_1[_0x1e1591(0x18d)]['BAD_REQUEST']);const [_0x2fcdd9,_0x48dd56]=_0x254739;return{'rows':_0x2fcdd9,'count':_0x48dd56};}async[_0x5c7e7c(0x1ac)](_0xfbb2b5){const _0x1bc7ec=_0x5c7e7c,{id:_0x446c8c}=_0xfbb2b5;return await this['mjInspireClassifyEntity'][_0x1bc7ec(0x201)]({'where':{'id':_0x446c8c}});}async[_0x5c7e7c(0x302)](_0x36a45c){const _0x214de0=_0x5c7e7c;try{const {classifyName:_0x42dcd0,level:_0x8f7aad,type:_0xaaa251,pid:pid=0x0}=_0x36a45c;return await this[_0x214de0(0x277)][_0x214de0(0x146)]({'classifyName':_0x42dcd0,'level':_0x8f7aad,'type':_0xaaa251,'pid':pid})[_0x214de0(0x2a6)](_0x26f99d=>!!_0x26f99d)[_0x214de0(0x31e)](_0xb4911b=>{const _0x2cacd7=_0x214de0;console[_0x2cacd7(0x29f)](_0xb4911b);throw new common_1[(_0x2cacd7(0x139))](_0xb4911b,common_1['HttpStatus'][_0x2cacd7(0x14e)]);});}catch(_0x336ad4){return![];}}async[_0x5c7e7c(0x1f6)](_0x334e2c){const _0x16999a=_0x5c7e7c,{id:_0x51fc57,classifyName:_0x59ae49,level:_0x4fa3e7,type:_0x3ba2fd,pid:_0x361d65}=_0x334e2c;return this['connection'][_0x16999a(0x299)](async()=>{const _0x1d6b8f=_0x16999a,_0x34300c=await this[_0x1d6b8f(0x277)][_0x1d6b8f(0x201)]({'where':{'id':_0x51fc57}});_0x34300c['type']!==_0x3ba2fd&&await this[_0x1d6b8f(0x277)]['update']({'pid':_0x51fc57},{'type':_0x3ba2fd}),await this[_0x1d6b8f(0x277)][_0x1d6b8f(0x19e)](_0x51fc57,{'classifyName':_0x59ae49,'level':_0x4fa3e7,'type':_0x3ba2fd,'pid':_0x361d65});}),!![];}async['removeMjIncantationClassify'](_0x5813f5){const _0x4096ca=_0x5c7e7c,{id:_0xd1b4c8}=_0x5813f5;return await this[_0x4096ca(0x277)]['delete']({'id':_0xd1b4c8})['then'](_0x43a8df=>_0x43a8df[_0x4096ca(0x306)]>0x0);}async[_0x5c7e7c(0x245)](_0x2e8e5c){const _0x416282=_0x5c7e7c,{id:_0x1aab6a}=_0x2e8e5c;return await this[_0x416282(0x277)][_0x416282(0x201)]({'where':{'id':_0x1aab6a}});}async[_0x5c7e7c(0x30f)](){const _0x121559=_0x5c7e7c;return this[_0x121559(0x277)][_0x121559(0x15c)]({'where':{'level':0x1}});}async[_0x5c7e7c(0x240)](_0x4ffad8){const _0x4b14a1=_0x5c7e7c,{size:_0x24530d,page:_0x377a29,type:_0x40eebd,keyword:_0x143f62,level:_0x492496}=_0x4ffad8;let _0x421790={};_0x492496>0x0&&(_0x421790[_0x4b14a1(0x195)]=_0x492496);_0x40eebd&&(_0x421790[_0x4b14a1(0x2b7)]=_0x40eebd);_0x143f62&&(_0x421790[_0x4b14a1(0x2fa)]=(0x0,typeorm_2['Like'])('%'+_0x143f62+'%'));const _0xb20e70=await this['mjIncantationClassifyEntity']['findAndCount']({'order':{'createdAt':_0x4b14a1(0x25b)},'where':_0x421790,'take':_0x24530d,'skip':(_0x377a29-0x1)*_0x24530d})[_0x4b14a1(0x31e)](_0x439d23=>{const _0x1977fc=_0x4b14a1;console[_0x1977fc(0x29f)](_0x439d23);});if(!_0xb20e70)throw new common_1[(_0x4b14a1(0x139))](_0x4b14a1(0x246),common_1['HttpStatus'][_0x4b14a1(0x14e)]);const [_0x302057,_0x5e3b2e]=_0xb20e70;return{'rows':_0x302057,'count':_0x5e3b2e};}async[_0x5c7e7c(0x1b8)](_0x527e2b){const _0x50c931=_0x5c7e7c,{level:_0x14d815,type:_0x37258e}=_0x527e2b,_0x2938fd={};_0x14d815===0x0?_0x2938fd[_0x50c931(0x195)]=(0x0,typeorm_2[_0x50c931(0x2ac)])(_0x14d815):_0x2938fd[_0x50c931(0x195)]=_0x14d815;_0x37258e&&(_0x2938fd[_0x50c931(0x2b7)]=_0x37258e);const _0x462a6c=await this[_0x50c931(0x277)]['findBy'](_0x2938fd)['catch'](_0x5c6014=>{const _0xc09aad=_0x50c931;console[_0xc09aad(0x29f)](_0x5c6014);});if(!_0x462a6c)throw new common_1[(_0x50c931(0x139))](_0x50c931(0x246),common_1[_0x50c931(0x18d)][_0x50c931(0x14e)]);if(_0x14d815===0x0)return{'level1':_0x462a6c[_0x50c931(0x290)](_0x45fe83=>_0x45fe83[_0x50c931(0x195)]===0x1),'level2':_0x462a6c[_0x50c931(0x290)](_0x3f7b3a=>_0x3f7b3a['level']===0x2)};return _0x462a6c;}async[_0x5c7e7c(0x338)](_0x525f29){const _0x2a1259=_0x5c7e7c;try{const {incantationEn:_0x20b851,incantationCn:_0x6d0f2e,img:_0x503656,pid:_0x41d4b2}=_0x525f29;return await this['mjIncantationEntity'][_0x2a1259(0x146)]({'incantationEn':_0x20b851,'incantationCn':_0x6d0f2e,'img':_0x503656,'pid':_0x41d4b2})[_0x2a1259(0x2a6)](_0x3f8756=>!!_0x3f8756)[_0x2a1259(0x31e)](_0x294912=>{throw _0x294912;});}catch(_0x3004b2){return console[_0x2a1259(0x29f)](_0x3004b2),![];}}async[_0x5c7e7c(0x24b)](_0x1d0465){const _0x3d49ca=_0x5c7e7c,{id:_0x10f97f,incantationEn:_0x324c27,incantationCn:_0x3e32d4,img:_0x416a43,pid:_0x4a3b95}=_0x1d0465;return await this['mjIncantationEntity'][_0x3d49ca(0x19e)](_0x10f97f,{'incantationCn':_0x3e32d4,'incantationEn':_0x324c27,'img':_0x416a43,'pid':_0x4a3b95});}async[_0x5c7e7c(0x2bc)](_0x2fe486){const _0x18e79a=_0x5c7e7c,{id:_0x1763f4}=_0x2fe486;return await this[_0x18e79a(0x2c5)][_0x18e79a(0x32e)]({'id':_0x1763f4})['then'](_0x2ffbce=>_0x2ffbce[_0x18e79a(0x306)]>0x0);}async[_0x5c7e7c(0x225)](_0x4a7819){const _0x327a3a=_0x5c7e7c,{id:_0x41931d}=_0x4a7819;return await this[_0x327a3a(0x2c5)][_0x327a3a(0x201)]({'where':{'id':_0x41931d}});}async[_0x5c7e7c(0x343)](_0x404e4e){const _0x1fb507=_0x5c7e7c,{size:_0x120c57,page:_0x3b2593,keyword:_0x5e9105,pid:_0x183351}=_0x404e4e;let _0xe5d60a={};_0x183351>0x0&&(_0xe5d60a['pid']=_0x183351);_0x5e9105&&(_0xe5d60a[_0x1fb507(0x286)]=(0x0,typeorm_2[_0x1fb507(0x24d)])('%'+_0x5e9105+'%'));const _0x488967=await this[_0x1fb507(0x2c5)][_0x1fb507(0x2c8)]({'order':{'createdAt':_0x1fb507(0x25b)},'where':_0xe5d60a,'take':_0x120c57,'skip':(_0x3b2593-0x1)*_0x120c57})[_0x1fb507(0x31e)](_0x6f46bd=>{const _0x4567e8=_0x1fb507;console[_0x4567e8(0x29f)](_0x6f46bd);});if(!_0x488967)throw new common_1['HttpException'](_0x1fb507(0x2ef),common_1['HttpStatus'][_0x1fb507(0x14e)]);const [_0x29f17e,_0x303741]=_0x488967;return{'rows':_0x29f17e,'count':_0x303741};}async[_0x5c7e7c(0x273)](_0x3feaa3){const _0x173f69=_0x5c7e7c,{id:_0x45c437}=_0x3feaa3,_0x11874e=await this[_0x173f69(0x277)]['findOne']({'where':{'level':0x1,'id':_0x45c437}})[_0x173f69(0x31e)](_0x5b2e4e=>{const _0x150fa6=_0x173f69;common_1['Logger'][_0x150fa6(0x135)](_0x5b2e4e);});if(!_0x11874e)throw new common_1[(_0x173f69(0x139))](_0x173f69(0x335),common_1[_0x173f69(0x18d)][_0x173f69(0x14e)]);const _0x591074=await this[_0x173f69(0x277)][_0x173f69(0x15c)]({'where':{'level':0x2,'pid':_0x11874e['id']}})[_0x173f69(0x31e)](_0x2eb116=>{const _0x7376e6=_0x173f69;common_1[_0x7376e6(0x1e6)][_0x7376e6(0x135)](_0x2eb116);});if(!_0x591074||_0x591074[_0x173f69(0x1ea)]===0x0)return{'rows':[]};const _0x2015bd=_0x591074[_0x173f69(0x337)](_0x2e40e3=>_0x2e40e3['id']),_0x55e7e1=await this[_0x173f69(0x2c5)][_0x173f69(0x15c)]({'where':{'pid':(0x0,typeorm_2['In'])(_0x2015bd)}})[_0x173f69(0x31e)](_0x4608c3=>{const _0x5af604=_0x173f69;common_1[_0x5af604(0x1e6)][_0x5af604(0x135)](_0x4608c3);});if(!_0x55e7e1)throw new common_1[(_0x173f69(0x139))](_0x173f69(0x2ef),common_1['HttpStatus'][_0x173f69(0x14e)]);const _0x2586c5=_0x591074[_0x173f69(0x337)](_0x27b0a0=>{const _0x95cebb=_0x173f69;return{'children':_0x55e7e1['filter'](_0x171131=>_0x171131[_0x95cebb(0x16b)]===_0x27b0a0['id'])||[],..._0x27b0a0};});return{'rows':_0x2586c5};}async[_0x5c7e7c(0x157)](){const _0xde27cb=_0x5c7e7c,_0x431ad4=await this[_0xde27cb(0x2c5)][_0xde27cb(0x15c)]({'order':{'createdAt':_0xde27cb(0x25b)}})[_0xde27cb(0x31e)](_0x1373ba=>{console['log'](_0x1373ba);});if(!_0x431ad4)throw new common_1[(_0xde27cb(0x139))](_0xde27cb(0x2ef),common_1[_0xde27cb(0x18d)][_0xde27cb(0x14e)]);return _0x431ad4;}async['saveSuggestWords'](_0xb634){const _0x42b656=_0x5c7e7c,{id:_0x20a4f3,suggestCn:_0x5e1b13,suggestEn:_0x295414,order:_0x1004c9,image:_0x8ac3a6}=_0xb634,_0x223336=await this[_0x42b656(0x2a1)]['findOne']({'where':{'suggestCn':_0x5e1b13}});if(_0x20a4f3){if(_0x223336&&_0x223336['id']!==_0x20a4f3)throw new common_1[(_0x42b656(0x139))](_0x42b656(0x235),common_1['HttpStatus']['BAD_REQUEST']);}else{if(_0x223336)throw new common_1['HttpException'](_0x42b656(0x235),common_1[_0x42b656(0x18d)][_0x42b656(0x14e)]);}const _0x43aac5=await this[_0x42b656(0x2a1)][_0x42b656(0x146)]({'id':_0x20a4f3,'suggestCn':_0x5e1b13,'suggestEn':_0x295414,'order':_0x1004c9||0x64,'image':_0x8ac3a6||''})[_0x42b656(0x2a6)](_0xc56aad=>!!_0xc56aad['id'])['catch'](_0x2ff895=>{const _0x6c3fea=_0x42b656;console[_0x6c3fea(0x29f)](_0x2ff895);});if(!_0x43aac5)throw new common_1[(_0x42b656(0x139))]('保存推荐关键词',common_1['HttpStatus'][_0x42b656(0x14e)]);return _0x43aac5;}async[_0x5c7e7c(0x223)](_0x4095e1){const _0x56c7d8=_0x5c7e7c,{id:_0x47634d}=_0x4095e1,_0x44a0b3=await this[_0x56c7d8(0x2a1)][_0x56c7d8(0x167)]({'where':{'id':_0x47634d}});if(!_0x44a0b3)throw new common_1['HttpException'](_0x56c7d8(0x1f4),common_1[_0x56c7d8(0x18d)][_0x56c7d8(0x14e)]);const _0x2301b3=await this[_0x56c7d8(0x2a1)][_0x56c7d8(0x32e)](_0x47634d)[_0x56c7d8(0x2a6)](_0x4692a7=>_0x4692a7[_0x56c7d8(0x306)]>0x0)['catch'](_0xd21e29=>{console['log'](_0xd21e29);});if(!_0x2301b3)throw new common_1[(_0x56c7d8(0x139))]('删除推荐关键词失败',common_1[_0x56c7d8(0x18d)][_0x56c7d8(0x14e)]);return _0x2301b3;}async[_0x5c7e7c(0x137)](_0x2dcd15){const _0x1f1511=_0x5c7e7c;let _0x34d1d4={};const {page:_0x208c3a,size:_0x44385a}=_0x2dcd15,_0x4a71c7=await this[_0x1f1511(0x2a1)][_0x1f1511(0x2c8)]({'where':_0x34d1d4,'take':_0x44385a,'skip':(_0x208c3a-0x1)*_0x44385a,'order':{'order':_0x1f1511(0x25b)}})[_0x1f1511(0x2a6)](([_0x56c13a,_0x3beaa8])=>({'rows':_0x56c13a,'count':_0x3beaa8}))[_0x1f1511(0x31e)](_0x4164c1=>{const _0x1b495e=_0x1f1511;console[_0x1b495e(0x29f)](_0x4164c1);});if(!_0x4a71c7)throw new common_1[(_0x1f1511(0x139))](_0x1f1511(0x2ab),common_1[_0x1f1511(0x18d)]['BAD_REQUEST']);return _0x4a71c7;}async[_0x5c7e7c(0x34e)](_0x46d560){const _0x3baab3=_0x5c7e7c,{accountId:_0x48036b,customId:_0x535932,flags:_0x2ca219,messageId:_0x1d4cbc,mode:_0xeb3adf}=_0x46d560,_0x3e65f9=await this[_0x3baab3(0x217)]['exist']({'where':{'id':_0x48036b}});if(!_0x3e65f9)throw new common_1[(_0x3baab3(0x139))]('账户不存在',common_1[_0x3baab3(0x18d)][_0x3baab3(0x14e)]);const {guild_id:_0x542ff8,channel_id:_0x1f3733,authorization:_0x4bda90,mjProxyUrl:_0x143559,mjProxy:_0x113d6a}=await this[_0x3baab3(0x248)](_0xeb3adf)[_0x3baab3(0x31e)](_0x5ae18a=>{const _0x3ccea2=_0x3baab3;return Promise[_0x3ccea2(0x22f)](_0x5ae18a);});console[_0x3baab3(0x29f)](_0x113d6a==0x1?_0x3baab3(0x274):_0x3baab3(0x198));if(_0x113d6a==0x0){const _0x5e83e3=await this[_0x3baab3(0x179)](_0x46d560),{msg:_0x54fede,type:_0x4032b9}=_0x5e83e3;if(_0x4032b9===_0x3baab3(0x213))return await this[_0x3baab3(0x217)][_0x3baab3(0x19e)]({'id':_0x48036b},{'setting':JSON[_0x3baab3(0x262)](_0x54fede)})[_0x3baab3(0x2a6)](_0x45b5c5=>_0x45b5c5[_0x3baab3(0x306)]>0x0)[_0x3baab3(0x31e)](_0x470137=>{const _0x4cc0ed=_0x3baab3;common_1['Logger'][_0x4cc0ed(0x135)](_0x470137);throw new common_1[(_0x4cc0ed(0x139))](_0x470137,common_1[_0x4cc0ed(0x18d)][_0x4cc0ed(0x14e)]);});return!![];}else{const _0x48c58f=await this[_0x3baab3(0x15f)]({'customId':_0x535932,'messageId':_0x1d4cbc,'flags':_0x2ca219,'guildId':_0x542ff8,'channelId':_0x1f3733,'token':_0x4bda90,'mjProxyUrl':_0x143559});return console[_0x3baab3(0x29f)](_0x3baab3(0x1d4),_0x48c58f),await this[_0x3baab3(0x217)][_0x3baab3(0x19e)]({'id':_0x48036b},{'setting':JSON[_0x3baab3(0x262)](_0x48c58f)})[_0x3baab3(0x2a6)](_0x3baaab=>_0x3baaab[_0x3baab3(0x306)]>0x0)[_0x3baab3(0x31e)](_0x4c3de9=>{const _0x3eea93=_0x3baab3;common_1[_0x3eea93(0x1e6)][_0x3eea93(0x135)](_0x4c3de9);throw new common_1['HttpException'](_0x4c3de9,common_1[_0x3eea93(0x18d)][_0x3eea93(0x14e)]);});}}async[_0x5c7e7c(0x15f)](_0x409d4f){const _0x269680=_0x5c7e7c,{channelId:_0x4d5f7b,token:_0x39df9f,guildId:_0x3aa9f0,flags:_0x43f1d7,mjProxyUrl:_0x3fe991,customId:_0x49e882,messageId:_0x5963de}=_0x409d4f;return axios_1['default'][_0x269680(0x163)](_0x3fe991+'/api/mj/setting_update',{'custom_id':_0x49e882,'flags':_0x43f1d7,'message_id':_0x5963de,'token':_0x39df9f,'channel_id':_0x4d5f7b,'guild_id':_0x3aa9f0})[_0x269680(0x2a6)](_0x20e190=>_0x20e190['data'])[_0x269680(0x31e)](_0xf0d4a6=>Promise['reject'](_0xf0d4a6));}async[_0x5c7e7c(0x2dc)](_0x1a4226){const _0x3e3333=_0x5c7e7c,{accountId:_0x121a02}=_0x1a4226,_0x19ea29=await this['mjParamEntity']['findOne']({'where':{'id':_0x121a02}});if(!_0x19ea29)throw new common_1[(_0x3e3333(0x139))]('账户不存在',common_1['HttpStatus']['BAD_REQUEST']);const {setting:_0x2e4919}=_0x19ea29,_0x257450=_0x2e4919?JSON[_0x3e3333(0x2f0)](_0x2e4919):'';if(!_0x257450)return await this[_0x3e3333(0x2fe)](_0x19ea29,!![])['catch'](_0x2114c3=>{const _0x219b79=_0x3e3333;console[_0x219b79(0x29f)](_0x2114c3);});else{const _0x1d6ddc=_0x257450[_0x3e3333(0x2ed)];return _0x1d6ddc[_0x3e3333(0x1ea)]>=0x2?_0x1d6ddc[0x1][_0x3e3333(0x2ed)][0x1][_0x3e3333(0x2eb)]===0x3:await this[_0x3e3333(0x2fe)](_0x19ea29,!![])['catch'](_0x80e3d9=>{const _0x443b4f=_0x3e3333;console[_0x443b4f(0x29f)](_0x80e3d9);});}}async[_0x5c7e7c(0x179)](_0xd83a66){const _0x45054a=_0x5c7e7c,{messageId:_0x495564,customId:_0x4d94bf,flags:_0x28d9ed,mode:_0x248f2a,accountId:_0x39684d}=_0xd83a66,{guild_id:_0x1f4c7a,channel_id:_0x143493,authorization:_0x1a103}=await this[_0x45054a(0x248)](_0x248f2a)[_0x45054a(0x31e)](_0x414348=>{const _0x4b28cd=_0x45054a;return Promise[_0x4b28cd(0x22f)](_0x414348);}),_0x2a4108=this[_0x45054a(0x153)],_0x3e669f=this[_0x45054a(0x229)];return!this[_0x45054a(0x206)][_0x248f2a]&&await this['initMidJourney']({'channel_id':_0x143493,'guild_id':_0x1f4c7a,'token':_0x1a103,'wsBaseUrl':_0x2a4108,'apiBaseUrl':_0x3e669f},_0x248f2a),new Promise(async(_0x19025b,_0x16ccae)=>{const _0x5affee=_0x45054a;return await this[_0x5affee(0x206)][_0x248f2a][_0x5affee(0x282)][_0x5affee(0x1dd)](_0x495564,_0x4d94bf,_0x28d9ed,(_0x24c334,_0x2d7192)=>{const _0x1e053f=_0x5affee;console[_0x1e053f(0x29f)](_0x1e053f(0x2b7),_0x24c334,_0x1e053f(0x1bc),_0x2d7192),_0x19025b({'type':_0x24c334,'msg':_0x2d7192});});});}[_0x5c7e7c(0x2ec)](_0x4195a8){const _0x39147f=_0x5c7e7c;if(!_0x4195a8)return'fast';if(_0x4195a8===midjourney_constant_1[_0x39147f(0x181)][_0x39147f(0x188)])return _0x39147f(0x188);if(_0x4195a8===midjourney_constant_1['DrawSpeed'][_0x39147f(0x333)])return _0x39147f(0x333);if(_0x4195a8===midjourney_constant_1[_0x39147f(0x181)][_0x39147f(0x1c7)])return _0x39147f(0x1c7);return'fast';}async[_0x5c7e7c(0x1b5)](_0x3d6a3a){const _0x5c1dca=_0x5c7e7c,_0x997022=await this[_0x5c1dca(0x193)][_0x5c1dca(0x2fb)]({'data':{'ids':[_0x3d6a3a]}});common_1[_0x5c1dca(0x1e6)]['log']('Modal\x20状态\x20手动同步任务信息'),this[_0x5c1dca(0x1d7)](_0x997022[0x0]);}async[_0x5c7e7c(0x1d7)](_0x4643e4){const _0xd2b41a=_0x5c7e7c;common_1[_0xd2b41a(0x1e6)][_0xd2b41a(0x29f)](_0x4643e4,'MJ\x20通知内容：');try{let _0x362e53=[];const _0x533b81=midjourney_constant_1[_0xd2b41a(0x140)][_0xd2b41a(0x1da)](_0x4643e4[_0xd2b41a(0x269)]),_0x5e6ea6=_0x4643e4['progress']?parseFloat(_0x4643e4[_0xd2b41a(0x2be)]):null;let _0x29690c=await this[_0xd2b41a(0x182)]['findOne']({'where':{'mjpTaskId':_0x4643e4['id']}});if(_0x4643e4[_0xd2b41a(0x269)]===_0xd2b41a(0x295)&&_0x29690c[_0xd2b41a(0x33f)]){common_1[_0xd2b41a(0x1e6)]['log'](_0xd2b41a(0x28f),_0xd2b41a(0x323));return;}_0x4643e4[_0xd2b41a(0x311)]&&(_0x362e53=_0x4643e4[_0xd2b41a(0x311)][_0xd2b41a(0x290)](_0x2b47d6=>_0x2b47d6[_0xd2b41a(0x26c)]!==_0xd2b41a(0x349)&&_0x2b47d6['label']!==_0xd2b41a(0x233)&&_0x2b47d6[_0xd2b41a(0x1a5)]!=='❤️'));MjConfig_1[_0xd2b41a(0x2a0)][_0xd2b41a(0x271)]&&_0x4643e4[_0xd2b41a(0x25a)]&&(_0x4643e4[_0xd2b41a(0x25a)]=_0x4643e4[_0xd2b41a(0x25a)][_0xd2b41a(0x161)](_0xd2b41a(0x326),MjConfig_1[_0xd2b41a(0x2a0)]['mjProxyImgUrl']));const _0x1c5c81={'id':_0x29690c['id'],'status':_0x533b81,'progress':_0x5e6ea6,'durationSpent':null,'imageUrl':_0x4643e4[_0xd2b41a(0x25a)],'failReason':_0x4643e4[_0xd2b41a(0x1eb)],'buttons':JSON[_0xd2b41a(0x262)](_0x362e53)};return(_0x4643e4[_0xd2b41a(0x1dd)]=_0xd2b41a(0x2cc))&&(_0x1c5c81[_0xd2b41a(0x1f5)]=_0x4643e4[_0xd2b41a(0x1f5)]||_0x1c5c81[_0xd2b41a(0x1f5)]||''),_0x4643e4['finishTime']&&_0x4643e4[_0xd2b41a(0x2cf)]&&(_0x1c5c81[_0xd2b41a(0x1b0)]=(_0x4643e4[_0xd2b41a(0x1bb)]-_0x4643e4['startTime'])/0x3e8),_0x29690c=await this['midjourneyEntity'][_0xd2b41a(0x146)](_0x1c5c81),_0x4643e4[_0xd2b41a(0x269)]===_0xd2b41a(0x2f5)&&_0x4643e4[_0xd2b41a(0x25a)]&&this['uploadService']['transferImg'](_0x29690c['id'],_0x29690c[_0xd2b41a(0x25a)]),null;}catch(_0x2e96a6){common_1[_0xd2b41a(0x1e6)]['error']('Mj任务通知异常:\x20',_0x2e96a6);}}async[_0x5c7e7c(0x350)](){const _0x569f25=_0x5c7e7c;try{const _0x1826a9=await this[_0x569f25(0x182)]['find']({'where':{'status':(0x0,typeorm_2['In'])([0x1,0x2,0x6])}});if(_0x1826a9[_0x569f25(0x1ea)])for(let _0x143ad2=0x0;_0x143ad2<_0x1826a9[_0x569f25(0x1ea)];_0x143ad2++){const _0x52fb0b=redisKey_constant_1[_0x569f25(0x175)]+_0x1826a9[_0x143ad2]['mjpTaskId'],_0x5d9dd9=await this['redisCacheService']['get']({'key':_0x52fb0b});if(_0x5d9dd9)continue;else this['redisCacheService'][_0x569f25(0x345)]({'key':_0x52fb0b,'val':'lock'}),this['mjpTaskService'][_0x569f25(0x2fb)]({'data':{'ids':[_0x1826a9[_0x143ad2]['mjpTaskId']]}})[_0x569f25(0x2a6)](async _0x196b24=>{const _0x1db222=_0x569f25,_0x529071=_0x196b24[0x0],_0x5ec930=_0x1826a9[_0x143ad2],_0x31dce5=midjourney_constant_1[_0x1db222(0x140)][_0x1db222(0x1da)](_0x529071['status']),_0x570000=_0x529071[_0x1db222(0x2be)]?parseFloat(_0x529071[_0x1db222(0x2be)]):null;if(_0x5ec930[_0x1db222(0x2be)]===_0x570000&&_0x5ec930[_0x1db222(0x269)]===_0x31dce5){}else{const _0xdc313a=_0x529071[_0x1db222(0x311)]['filter'](_0x5a6c24=>_0x5a6c24['label']!==_0x1db222(0x349)&&_0x5a6c24['label']!=='Imagine\x20all'&&_0x5a6c24['emoji']!=='❤️'),_0x2a6652={'id':_0x5ec930['id'],'mjpTaskId':_0x529071['id'],'status':_0x31dce5,'progress':_0x570000,'durationSpent':null,'imageUrl':_0x529071[_0x1db222(0x25a)],'failReason':_0x529071[_0x1db222(0x1eb)],'buttons':JSON[_0x1db222(0x262)](_0xdc313a)};(_0x529071['action']=_0x1db222(0x2cc))&&(_0x2a6652[_0x1db222(0x1f5)]=_0x529071[_0x1db222(0x1f5)]||_0x2a6652['prompt']||''),_0x529071[_0x1db222(0x1bb)]&&_0x529071['startTime']&&(_0x2a6652['durationSpent']=(_0x529071[_0x1db222(0x1bb)]-_0x529071[_0x1db222(0x2cf)])/0x3e8),await this[_0x1db222(0x182)][_0x1db222(0x146)](_0x2a6652);}})[_0x569f25(0x31e)](_0xf84ca9=>{const _0x2f7df4=_0x569f25;common_1[_0x2f7df4(0x1e6)][_0x2f7df4(0x135)](_0x2f7df4(0x2f4),_0xf84ca9);})[_0x569f25(0x211)](()=>{this['redisCacheService']['del']({'key':_0x52fb0b});});}}catch(_0x2ea093){}}async[_0x5c7e7c(0x1a3)](){const _0x7308c3=_0x5c7e7c;if(MjConfig_1[_0x7308c3(0x2a0)][_0x7308c3(0x152)])return;try{const _0x3bb37a=await this[_0x7308c3(0x182)][_0x7308c3(0x15c)]({'where':{'status':0x3,'imageUrl':(0x0,typeorm_2['Like'])(_0x7308c3(0x33d))}});if(_0x3bb37a['length'])for(let _0x54e9da=0x0;_0x54e9da<_0x3bb37a[_0x7308c3(0x1ea)];_0x54e9da++){let {id:_0x557dc3,imageUrl:_0x25430d}=_0x3bb37a[_0x54e9da];this['uploadService'][_0x7308c3(0x1c0)](_0x557dc3,_0x25430d);}}catch(_0x34ea80){common_1[_0x7308c3(0x1e6)][_0x7308c3(0x135)](_0x34ea80);}}};function _0x469b(){const _0x47968e=['mjpId','上传文件失败...','transferImg','DRAWED','super','deleteDraw','open','getAccountInfoByProxy','buffer','turbo','DRAWING','hideString','queryMjAccountList','runImageMixImageJob','onModuleInit','runActionJobByProxy','info','includes','./../user/user.entity','../user/user.service','BadwordsService','concat','response\x20result','mjDraw','getAdminDrawList','notify','connected','renewDate','get','email','agreeNum','action','timeoutMinutes','UserBalanceService','删除失败！','socket-open','socketUrl','upsample|upscale|describe|picread::retry|faceSwap|shorten','drawFailed','动漫漫画','Logger','runImageJob','8521839gvhwyZ','删除记录失败！','length','failReason','mjInspireClassifyEntity','userId','1063740LbPbgn','getTime','\x20--sw\x20','guildId','swap','../../common/constants/redisKey.constant','推荐关键词不存在','prompt','modifyMjIncantationClassify','socket连接成功','个任务','TODO->error:\x20','metadata','removeMjAccount','上传文件失败...,\x20\x20no\x20attachment','MidJourneyDrawEnum','执行按钮操作','fast_mjDeduction','imagine','findOne','decorate','changeVersion','squareType','模式账号，请前往后台配置！','midJourney','userInfo','prompt包含敏感词','count','version','finally\x20remixSubmit','filterStar','number','/api/mj/blend','无绘图记录','addDrawQueue','finally','globalConfigService','MESSAGE_UPDATE','../mjp/mjpAccount.service','getDetailByIds','账号信息配置不存在！','mjParamEntity','mjSocketProxyUrl','setPrompt','base64','提交图片:\x20','enable','checkUserStatus','recDraw','添加绘图任务失败','runAction','https://discord.com','refundMjBalance','removeSuggestWords','emit','getMjIncantation','fastRemainTime','function','runGetSettingByProxy','apiBaseUrl','handleSubmitRemix','channelId','findOneBy','application/json','cancel','reject','jobId','IMAGE_TO_TEXT','socketClient','Imagine\x20all','getSettingInfo','推荐关键词已存在，不可重复添加','setAttachment','getAccountInfo','toLowerCase','任务类型错误','squire-images','95711eoRBJt','queryAllPrompt','cos','assign','message','queryMjIncantationClassify','connect','round','上传文件失败...,\x20upload\x20message\x20fail','创建图混图任务失败','getMjIncantationClassify','查询咒语分类失败','join','getMjDefaultParams','oss','tencent','modifyMjIncantation','cosUrl','Like','../../common/constants/midjourney.constant','saveImageToMixed','setMjAccountEnable','unauthorized','createRandomUid','商拍摄影','mode','forEach','fullPrompt','description','fastTimeRemaining','userService','imageUrl','DESC','/attachments','toString','getRandomKey','syncMjpAccount','非法操作！','https://api.openai.com','stringify','fetch','上传文件失败...,\x20\x20upload\x20fail','trim','updateDrawStatus','createdAt','MESSAGE_CREATE\x20jobId','status','initInspireData','modifyMjAccount','label','getList','未指定','无可用MJ账号，请后台添加或启用MJ账号','url','mjProxyImgUrl','../../common/constants/relate.contant','queryMjIncantationByClassify','走代理','MidjourneySdk','\x20--sref\x20','mjIncantationClassifyEntity','\x20--cw\x20','handleGetIsRemix','./mjIncantation.entity','rec','../globalConfig/globalConfig.service','connection','../redisCache/redisCache.service','now','originPrompt','attachments','api','delPrompt','gomaxai','操作失败！','incantationCn','uploadImage','polling','call','getMjAccount','ELogRelateType','axios','wss://gateway.discord.gg/?encoding=json&v=9','image/png','Modal已处理，无需更新','filter','authorization','IMAGE_TO_TEXT_ACTION','cleanQueue','/api/mj/region_redraw','MODAL','result','队列已满，请稍后尝试','timestamp','transaction','active','GlobalConfigService','checkLimit','orderPlan','创建图生文任务失败','log','default','mjSuggestWordEntity','精选分享','?imageView2/1/w/','任务不存在！','ali','then','MidjourneyService','头像制作','initMidJourney','mjProxyUrl','查询推荐关键词失败','MoreThan','runMjDescribeTask\x20type,\x20msg\x20','uploadFileFromUrl','queryMjInspireClassify','timeout','deductFromBalance','查询灵感分类失败','绘画制作','./dto/addDrawQueue.dto','validateBalance','files','type','badwordsService','MidjourneyActionEnum','totalTime','nickname','removeMjIncantation','heartbeatTask','progress','delLog','chevereto','socket已连接，不需要重连','userEntity','PRO','没有满足条件的MJ账号，请联系管理员！','mjIncantationEntity','MidjourneyStatusEnum','分页参数错误','findAndCount','defineProperty','/api/mj/imagine','handleGetRegionInfo','DESCRIBE','JWT_SECRET','updateDrawData','startTime','MjpAccountService','FAST','图混图上传图片','uploadByProxy','MEGA','https://discord.com/api/v9/channels/','获取我得绘制列表失败','runMjDrawTask','MidjourneyEntity','图混图上传图片完成','settings','AiLogService','handleGetMjSetting','MESSAGE_CREATE','壁纸绘画','embed','syncMjAccount','calcCost','runMjDescribeProxy','modal','图混图任务至少需要两张图片','Relaxed\x20Usage','初始化灵感广场分类成功','mjPromptsEntity','绘制中的图片任务、禁止删除！','执行图生文任务失败，attachments\x20参数为空','distributeAccount','style','convertMode4Transfer','components','mjModel','查询咒语失败','parse','put','insightFace','resolve','mjTaskUpdateJob:\x20','SUCCESS','mjVersion','isVaryImage','lifetimeUsage','isChinese','classifyName','listByCondition','runMjBlendTask\x20finalResult','IMAGE_MIX_IMAGE','syncInfo','fileInfo','formatFileInfo','runMjBlendTask','addMjIncantationClassify','$1****$2','getUploadType','mjpTaskId','affected','user','create','checkIsActionDone','handleImagesUploadTask','jobIds','saveToRedis','varyRegion','执行图混图是否代理','queryTopMjIncantationClassify','/api/attachment','buttons','删除成功！','typeorm','blend','../userBalance/userBalance.service','@nestjs/typeorm','../mjp/mjpTask.service','addMjInspireClassify','test','reconnectionTask','执行图混图','versionSelector','../aiLog/aiLog.service','catch','REGION_ACTION','/api/pipe?url=','modifyMjInspireClassify','要使用MJ绘画功能，至少需要配置一个MJ账号,并且启用该账号','Mj\x20Modal\x20通知','Imagine','MjpTaskService','https://cdn.discordapp.com','socket.io-client','TURBO','account','syncMjpAccountManual','syncMjpAccountAutomatic','getAgreeByRelateId','getConfigs','delete','originalname','./mjInspireClassify.entity','type,\x20msg\x20','Repository','relax','openaiBaseUrl','未查询到咒语一级分类','copyAccountInfo','map','addMjIncantation','./mjSuggestWord.entity','按钮操作','2412560AsHxbr','678MAaQbO','https://cdn.discordapp.com%','initMj','messageFlags','response\x20cosUrl','配置不存图片','美女形象','queryMjIncantation','?x-oss-process=image/resize,w_','set','/messages','websocket','当前图片不存在！','Custom\x20Zoom','imageSeed','STANDARD','verify','initHasAccount','handleUpdateMjSetting','checkBadWords','syncMjpTask','content','RELAX','updateAllUnfinishedTaskStatus','INTERACTION_MODAL_CREATE','error','extend','querySuggestWords','mjProxy','HttpException','catch\x20runMjRegionTask\x20error\x20','getByRelateId','runMjDescribeTask','上传文件失败...,\x20\x20upload\x20message\x20fail','自动同步账号信息失败：','__esModule','MjpStateMap','TODO->存储图片失败','close','RedisCacheService','action\x20MESSAGE_UPDATE','本次图片上传耗时为','save','weight','extraParam','data:image/png;base64,','mjpAccountService','flags','fanyiService','subscribePlan','BAD_REQUEST','同步信息失败！','design:paramtypes','当前管理员限制单用户同时最多能执行','mjNotSaveImg','wsBaseUrl','32EIovud','查询失败！','convertToEnglish','queryMjIncantationAll','del','走到解析','保存到redis','TEXT_TO_IMAGE','find','flat','initSocket','updateSettingByProxy','createRandomId','replace','MjIncantationEntity','post','mjpId:\x20','走保存','runMjRegionTask','exist','runMjBlendProxy','./mjParam.entity','8IlStiF','pid','aiLogService','Standard','save\x20db\x20drawInfo\x20','hasAccount','redisCacheService','socketWs','uploadService','../../common/utils/createRandomId','role','MJ_TASK_UPDATE','queryPromptByPage','UserEntity','split','runActionSetting','name','2uoIdwO','username','runVaryRegionDrawJob','绘制的任务不存在！','object','348879WIIzlD','DrawSpeed','midjourneyEntity','data','getSyncAccountInfo','describe','FanyiService','socket.active','fast','Not','runVaryRegionJobByProxy','socket.connected','region','HttpStatus','configVal','AddDrawQueueDto','jsonwebtoken','getDrawList','runImageToTextJob','mjpTaskService','runImageJobByProxy','level','avatar','14595170cZwwBp','不走代理','INTERACTION_IFRAME_MODAL_CREATE','Connection','艺术设计','MjInspireClassifyEntity','__metadata','update','code','/q/55','userBalanceService','名称不能重复','syncMjImg','headers','emoji','../upload/upload.service','MjParamEntity','14856908YUoICm','increaseVisit','InjectRepository','../../core/midjourney','getMjInspireClassify','env','Mozilla/5.0\x20(Macintosh;\x20Intel\x20Mac\x20OS\x20X\x2010_15_7)\x20AppleWebKit/537.36\x20(KHTML,\x20like\x20Gecko)\x20Chrome/112.0.0.0\x20Safari/537.36','turbo_mjDeduction','durationSpent','error:\x20','visitNum','MID_JOURNEY','upload_url','syncTaskInfo','value','INTERACTION_SUCCESS','queryMjIncantationClassifyAllByLevel','Subscription','/api/mj/action','finishTime','receive','../badwords/badwords.service'];_0x469b=function(){return _0x47968e;};return _0x469b();}MidjourneyService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1[_0x5c7e7c(0x1aa)])(midjourney_entity_1[_0x5c7e7c(0x2d8)])),__param(0x1,(0x0,typeorm_1['InjectRepository'])(user_entity_1[_0x5c7e7c(0x177)])),__param(0x2,(0x0,typeorm_1['InjectRepository'])(mjPrompts_entity_1['MjPromptsEntity'])),__param(0x3,(0x0,typeorm_1[_0x5c7e7c(0x1aa)])(mjParam_entity_1['MjParamEntity'])),__param(0x4,(0x0,typeorm_1[_0x5c7e7c(0x1aa)])(mjIncantationClassify_entity_1['MjIncantationClassifyEntity'])),__param(0x5,(0x0,typeorm_1[_0x5c7e7c(0x1aa)])(mjInspireClassify_entity_1[_0x5c7e7c(0x19c)])),__param(0x6,(0x0,typeorm_1[_0x5c7e7c(0x1aa)])(mjSuggestWord_entity_1['MjSuggestWordEntity'])),__param(0x7,(0x0,typeorm_1['InjectRepository'])(mjIncantation_entity_1[_0x5c7e7c(0x162)])),__metadata(_0x5c7e7c(0x150),[typeorm_2[_0x5c7e7c(0x332)],typeorm_2[_0x5c7e7c(0x332)],typeorm_2[_0x5c7e7c(0x332)],typeorm_2[_0x5c7e7c(0x332)],typeorm_2[_0x5c7e7c(0x332)],typeorm_2['Repository'],typeorm_2[_0x5c7e7c(0x332)],typeorm_2[_0x5c7e7c(0x332)],globalConfig_service_1[_0x5c7e7c(0x29b)],upload_service_1['UploadService'],badwords_service_1[_0x5c7e7c(0x1d2)],userBalance_service_1[_0x5c7e7c(0x1df)],fanyi_service_1[_0x5c7e7c(0x186)],user_service_1['UserService'],redisCache_service_1[_0x5c7e7c(0x143)],mjpAccount_service_1[_0x5c7e7c(0x2d0)],mjpTask_service_1[_0x5c7e7c(0x325)],aiLog_service_1[_0x5c7e7c(0x2db)],typeorm_2[_0x5c7e7c(0x19a)]])],MidjourneyService),exports[_0x5c7e7c(0x2a7)]=MidjourneyService;