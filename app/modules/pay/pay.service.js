'use strict';const _0x543297=_0x1e0a;(function(_0xf44cbc,_0xb9685c){const _0x1f5678=_0x1e0a,_0x2ff544=_0xf44cbc();while(!![]){try{const _0x4d9600=-parseInt(_0x1f5678(0x145))/0x1*(-parseInt(_0x1f5678(0x18c))/0x2)+parseInt(_0x1f5678(0x1a5))/0x3*(-parseInt(_0x1f5678(0x19b))/0x4)+parseInt(_0x1f5678(0x182))/0x5+parseInt(_0x1f5678(0x140))/0x6+-parseInt(_0x1f5678(0x17b))/0x7+parseInt(_0x1f5678(0x187))/0x8*(parseInt(_0x1f5678(0xd6))/0x9)+parseInt(_0x1f5678(0x147))/0xa*(parseInt(_0x1f5678(0x168))/0xb);if(_0x4d9600===_0xb9685c)break;else _0x2ff544['push'](_0x2ff544['shift']());}catch(_0x31ea00){_0x2ff544['push'](_0x2ff544['shift']());}}}(_0x9557,0xcb61f));var __decorate=this&&this[_0x543297(0x173)]||function(_0x5801f2,_0x448ac6,_0x3bec81,_0x46020f){const _0x15ffe1=_0x543297;var _0x54fa25=arguments['length'],_0x4fd2ad=_0x54fa25<0x3?_0x448ac6:_0x46020f===null?_0x46020f=Object['getOwnPropertyDescriptor'](_0x448ac6,_0x3bec81):_0x46020f,_0x42d7ee;if(typeof Reflect===_0x15ffe1(0x13f)&&typeof Reflect['decorate']==='function')_0x4fd2ad=Reflect['decorate'](_0x5801f2,_0x448ac6,_0x3bec81,_0x46020f);else{for(var _0xbe897a=_0x5801f2[_0x15ffe1(0xf4)]-0x1;_0xbe897a>=0x0;_0xbe897a--)if(_0x42d7ee=_0x5801f2[_0xbe897a])_0x4fd2ad=(_0x54fa25<0x3?_0x42d7ee(_0x4fd2ad):_0x54fa25>0x3?_0x42d7ee(_0x448ac6,_0x3bec81,_0x4fd2ad):_0x42d7ee(_0x448ac6,_0x3bec81))||_0x4fd2ad;}return _0x54fa25>0x3&&_0x4fd2ad&&Object[_0x15ffe1(0x114)](_0x448ac6,_0x3bec81,_0x4fd2ad),_0x4fd2ad;},__metadata=this&&this[_0x543297(0x10c)]||function(_0x4c470f,_0x5c5214){const _0x5a1bd3=_0x543297;if(typeof Reflect===_0x5a1bd3(0x13f)&&typeof Reflect[_0x5a1bd3(0x192)]===_0x5a1bd3(0x14c))return Reflect[_0x5a1bd3(0x192)](_0x4c470f,_0x5c5214);},__param=this&&this['__param']||function(_0x37657e,_0x55de67){return function(_0x9eb4e5,_0x446423){_0x55de67(_0x9eb4e5,_0x446423,_0x37657e);};};Object[_0x543297(0x114)](exports,_0x543297(0x19e),{'value':!![]}),exports[_0x543297(0xcf)]=void 0x0;function _0x1e0a(_0x404668,_0x219691){const _0x95579b=_0x9557();return _0x1e0a=function(_0x1e0a89,_0x17aa97){_0x1e0a89=_0x1e0a89-0xce;let _0x34680f=_0x95579b[_0x1e0a89];return _0x34680f;},_0x1e0a(_0x404668,_0x219691);}function _0x9557(){const _0x13743e=['alipay.trade.query','sign_type','now','Injectable','套餐不存在!','payWeChat','GlobalConfigService','wxpay','cancel','payWeChatMchId','payMpaySecret','axios','sign','orderId','device','epay','payMpayApiQueryUrl','alipay','success','queryMpay','createRandomNonceStr','sort','affected','addBalanceToOrder','payEpayPid','19293439umapTF','connection','epay\x20--->\x20res:\x20','md5','payWeChatSecret','payEpayApiPayUrl','payMpayReturnUrl','sdkExec','post','payHupiGatewayUrl','exec','__decorate','out_trade_no','alipay\x20result:\x20','message','payHupiSecret','TRANSACTION.SUCCESS','product_code','payWeChatPublicKey','11212152arfush','用户openId:\x20','total_fee','update','mini','SUCCESS','@nestjs/typeorm','2479295LTWzbi','bizContent','MD5','alipay-sdk','QUICK_MSECURITY_PAY','6011464OleDto','校验签名','payer','response','findOne','601378mMYjiH','submit.php','payHupi','@nestjs/common','payWeChatH5Url','OrderEntity','metadata','../redisCache/redisCache.service','map','notify_url','cancelWxOrder','close','支付请求失败:\x20','goodsId','wechatpay-node-v3','344plpXsb','data','notifyEpay','__esModule','time','微信H5支付失败！','notifyHupi','RedisCacheService','log','jsapi','41307nDDRZi','total','transactions_h5','type','toString','payType:\x20','https://api.xunhupay.com/payment/query.html','../globalConfig/globalConfig.service','PayService','hupi','getMiniOpenIdByUserId','transaction','hash','payAliPublicSecret','event_type','9XLlLyw','status','payHupiReturnUrl','pid','TRADE_SUCCESS','method','本次支付类型:\x20','HttpStatus','alipay.trade.app.pay','queryWeChat','pageExec','payMpay','mpay','trade_state','attach','payWeChatH5Name','payEpayReturnUrl','../order/order.entity','payAliWebAppId','payWeChatPrivateKey','payWeMiniAppId','getConfigs','payEpayApiQueryUrl','globalConfigService','payWeChatAppId','native','order','微信支付通知params:\x20','https://api.xunhupay.com/payment/do.html','transactions_native','length','act','trade_order_id','money','decipher_gcm','payMpayApiPayUrl','jsapi支付结果返回值:\x20','../crami/cramiPackage.entity','192.168.1.100','UserBalanceService','../user/user.service','payPlatform','订单不存在!','transactions_jsapi','setNotifyUrl','pay','queryEpay','BAD_REQUEST','POST','lock','校验签名通过','includes','version','payAli','__metadata','return_url','param','channel','text','order_no','payHupiAppId','payMpayPid','defineProperty','resource','CramiPackageEntity','userService','Repository','default','queryHupi','getOpenIdByUserId','trade_status','notifyMpay','cramiPackageEntity','h5_info','Wap','payEpaySecret','App支付结果返回值:\x20','notifyWeChat','payMpayNotifyUrl','get','1.1','redisCacheService','queryAliPay','hex','clientip','InjectRepository','query','wechat-pay:\x20','name','payWeChatNotifyUrl','PAY_UPDATE_ORDER','failed','userBalanceService','payHupiNotifyUrl','onModuleInit','del','orderEntity','join','transactions_app','payAliAppSecret','HttpException','notify','out_trade_order','payEpayNotifyUrl','payAliAppAppId','object','97836siIFYx','set','unsupported\x20pay\x20type','payEpay','scene_info','2RkrgxC','appid','10tEYMga','wechat','WE_APP_APPID','PKCS1','app','function','toFixed','design:paramtypes'];_0x9557=function(){return _0x13743e;};return _0x9557();}const typeorm_1=require(_0x543297(0x181)),typeorm_2=require('typeorm'),common_1=require(_0x543297(0x18f)),crypto=require('crypto'),axios_1=require(_0x543297(0x15a)),order_entity_1=require(_0x543297(0xe7)),cramiPackage_entity_1=require(_0x543297(0xfb)),userBalance_service_1=require('../userBalance/userBalance.service'),globalConfig_service_1=require(_0x543297(0xce)),utils_1=require('../../common/utils'),user_service_1=require(_0x543297(0xfe)),redisCache_service_1=require(_0x543297(0x193)),redisKey_constant_1=require('../../common/constants/redisKey.constant'),WxPay=require(_0x543297(0x19a)),AlipaySdk=require(_0x543297(0x185));let PayService=class PayService{constructor(_0x223233,_0x21290d,_0x4c0139,_0x5f1029,_0x28c162,_0x1620e8,_0x5cd869){const _0x1aa7cd=_0x543297;this['cramiPackageEntity']=_0x223233,this['orderEntity']=_0x21290d,this[_0x1aa7cd(0x132)]=_0x4c0139,this[_0x1aa7cd(0xed)]=_0x5f1029,this[_0x1aa7cd(0x117)]=_0x28c162,this[_0x1aa7cd(0x127)]=_0x1620e8,this[_0x1aa7cd(0x169)]=_0x5cd869;}async[_0x543297(0x134)](){}async[_0x543297(0x13b)](_0x3ac19b){const _0x3f965a=_0x543297;if(_0x3ac19b[_0x3f965a(0x10e)]==_0x3f965a(0x15e))return this[_0x3f965a(0x19d)](_0x3ac19b);if(_0x3ac19b[_0x3f965a(0xe4)]==_0x3f965a(0xd0))return this[_0x3f965a(0x1a1)](_0x3ac19b);if(typeof _0x3ac19b[_0x3f965a(0x115)]==_0x3f965a(0x13f))return this[_0x3f965a(0x123)](_0x3ac19b);return this[_0x3f965a(0x11d)](_0x3ac19b);}async[_0x543297(0x103)](_0x401669,_0x1ad792,_0xc4869b='wxpay'){const _0x14cedb=_0x543297,_0x24f0a2=await this[_0x14cedb(0x136)][_0x14cedb(0x18b)]({'where':{'userId':_0x401669,'orderId':_0x1ad792}});if(!_0x24f0a2)throw new common_1[(_0x14cedb(0x13a))]('订单不存在!',common_1[_0x14cedb(0xdd)][_0x14cedb(0x105)]);const _0x32eb8d=await this[_0x14cedb(0x11e)]['findOne']({'where':{'id':_0x24f0a2[_0x14cedb(0x199)]}});if(!_0x32eb8d)throw new common_1[(_0x14cedb(0x13a))](_0x14cedb(0x153),common_1['HttpStatus'][_0x14cedb(0x105)]);console[_0x14cedb(0x1a3)](_0x14cedb(0xdc),_0x24f0a2[_0x14cedb(0xff)]);try{if(_0x24f0a2[_0x14cedb(0xff)]==_0x14cedb(0x160))return this['payAli'](_0x401669,_0x1ad792,_0xc4869b);if(_0x24f0a2['payPlatform']==_0x14cedb(0x148))return this[_0x14cedb(0x154)](_0x401669,_0x1ad792,_0xc4869b);if(_0x24f0a2[_0x14cedb(0xff)]==_0x14cedb(0x15e))return this[_0x14cedb(0x143)](_0x401669,_0x1ad792,_0xc4869b);if(_0x24f0a2[_0x14cedb(0xff)]==_0x14cedb(0xe2))return this[_0x14cedb(0xe1)](_0x401669,_0x1ad792,_0xc4869b);if(_0x24f0a2[_0x14cedb(0xff)]==_0x14cedb(0xd0))return this[_0x14cedb(0x18e)](_0x401669,_0x1ad792,_0xc4869b);}catch(_0x53ac35){console[_0x14cedb(0x1a3)](_0x14cedb(0x198),_0x53ac35);throw new common_1['HttpException']('支付请求失败!',common_1[_0x14cedb(0xdd)][_0x14cedb(0x105)]);}}async[_0x543297(0x12c)](_0x27f8b1){const _0x31734a=_0x543297,_0x131b16=await this[_0x31734a(0x136)][_0x31734a(0x18b)]({'where':{'orderId':_0x27f8b1}});if(!_0x131b16)throw new common_1[(_0x31734a(0x13a))](_0x31734a(0x100),common_1['HttpStatus'][_0x31734a(0x105)]);return _0x131b16;}async[_0x543297(0x1a1)](_0x577c68){const _0xb29a61=_0x543297,_0x5bc17e=await this['globalConfigService']['getConfigs']([_0xb29a61(0x177)]),_0x558f9a=_0x577c68[_0xb29a61(0xd3)];delete _0x577c68[_0xb29a61(0xd3)];if(this[_0xb29a61(0x15b)](_0x577c68,_0x5bc17e)!=_0x558f9a)return _0xb29a61(0x131);const _0x20e501=await this[_0xb29a61(0x136)][_0xb29a61(0x18b)]({'where':{'orderId':_0x577c68[_0xb29a61(0xf6)],'status':0x0}});if(!_0x20e501)return _0xb29a61(0x131);await this['userBalanceService']['addBalanceToOrder'](_0x20e501);const _0x14fe33=await this[_0xb29a61(0x136)][_0xb29a61(0x17e)]({'orderId':_0x577c68[_0xb29a61(0xf6)]},{'status':0x1,'paydAt':new Date()});if(_0x14fe33[_0xb29a61(0x165)]!=0x1)return _0xb29a61(0x131);return _0xb29a61(0x161);}async[_0x543297(0x18e)](_0x4ed493,_0x996436,_0x547028=_0x543297(0x156)){const _0x1b9102=_0x543297,_0x253297=await this['orderEntity']['findOne']({'where':{'userId':_0x4ed493,'orderId':_0x996436}});if(!_0x253297)throw new common_1[(_0x1b9102(0x13a))](_0x1b9102(0x100),common_1[_0x1b9102(0xdd)][_0x1b9102(0x105)]);const _0x2790d9=await this[_0x1b9102(0x11e)][_0x1b9102(0x18b)]({'where':{'id':_0x253297[_0x1b9102(0x199)]}});if(!_0x2790d9)throw new common_1[(_0x1b9102(0x13a))](_0x1b9102(0x153),common_1[_0x1b9102(0xdd)][_0x1b9102(0x105)]);const {payHupiAppId:_0x5e55a8,payHupiSecret:_0x1a7318,payHupiNotifyUrl:_0x24e472,payHupiReturnUrl:_0x5efdf6,payHupiGatewayUrl:_0x26b999}=await this[_0x1b9102(0xed)][_0x1b9102(0xeb)]([_0x1b9102(0x112),_0x1b9102(0x177),_0x1b9102(0x133),_0x1b9102(0xd8),_0x1b9102(0x171)]),_0x2d19c1={};_0x2d19c1[_0x1b9102(0x10a)]='1.1',_0x2d19c1[_0x1b9102(0x146)]=_0x5e55a8,_0x2d19c1[_0x1b9102(0x19f)]=(Date['now']()/0x3e8)[_0x1b9102(0x14d)](0x0),_0x2d19c1['nonce_str']=(0x0,utils_1[_0x1b9102(0x163)])(0x20),_0x2d19c1['trade_order_id']=_0x996436,_0x2d19c1['title']=_0x2790d9[_0x1b9102(0x12e)],_0x2d19c1[_0x1b9102(0x17d)]=_0x253297['total'],_0x2d19c1[_0x1b9102(0x195)]=_0x24e472,_0x2d19c1[_0x1b9102(0x10d)]=_0x5efdf6,_0x2d19c1[_0x1b9102(0xe4)]='hupi',_0x2d19c1[_0x1b9102(0xd3)]=this[_0x1b9102(0x15b)](_0x2d19c1,_0x1a7318);const {data:{errcode:_0x2ccc16,errmsg:_0x183a29,url_qrcode:_0x5e4df4,url:_0x2c1073}}=await axios_1[_0x1b9102(0x119)][_0x1b9102(0x170)](_0x26b999||_0x1b9102(0xf2),_0x2d19c1);if(_0x2ccc16!=0x0)throw new common_1[(_0x1b9102(0x13a))](_0x183a29,common_1[_0x1b9102(0xdd)]['BAD_REQUEST']);return{'url_qrcode':_0x5e4df4,'url':_0x2c1073};}async[_0x543297(0x11a)](_0x5aaa25){const _0x10e16c=_0x543297,{payHupiAppId:_0x47e8fc,payHupiSecret:_0x48482b}=await this['globalConfigService'][_0x10e16c(0xeb)]([_0x10e16c(0x112),'payHupiSecret']),_0x34a24d={};_0x34a24d[_0x10e16c(0x10a)]=_0x10e16c(0x126),_0x34a24d[_0x10e16c(0x146)]=_0x47e8fc,_0x34a24d[_0x10e16c(0x19f)]=(Date[_0x10e16c(0x151)]()/0x3e8)[_0x10e16c(0x14d)](0x0),_0x34a24d['nonce_str']=(0x0,utils_1[_0x10e16c(0x163)])(0x20),_0x34a24d[_0x10e16c(0x13c)]=_0x5aaa25,_0x34a24d[_0x10e16c(0xd3)]=this[_0x10e16c(0x15b)](_0x34a24d,_0x48482b);const {data:{errcode:_0x45392d,errmsg:_0x26ba74,data:_0x4ed659}}=await axios_1[_0x10e16c(0x119)][_0x10e16c(0x170)](_0x10e16c(0x1ab),_0x34a24d);if(_0x45392d!=0x0)throw new common_1[(_0x10e16c(0x13a))](_0x26ba74,common_1['HttpStatus'][_0x10e16c(0x105)]);return _0x4ed659;}async[_0x543297(0x19d)](_0x28404f){const _0x3415e5=_0x543297,_0x2991b7=_0x28404f[_0x3415e5(0x15b)];delete _0x28404f[_0x3415e5(0x15b)],delete _0x28404f[_0x3415e5(0x150)];const _0x1c92af=await this[_0x3415e5(0xed)][_0x3415e5(0xeb)]([_0x3415e5(0x121)]);if(this['sign'](_0x28404f,_0x1c92af)!=_0x2991b7)return'failed';console[_0x3415e5(0x1a3)](_0x3415e5(0x108));const _0x4e4574=await this['orderEntity'][_0x3415e5(0x18b)]({'where':{'orderId':_0x28404f[_0x3415e5(0x174)],'status':0x0}});if(!_0x4e4574)return'failed';const _0xe2480e=_0x28404f[_0x3415e5(0x11c)]==_0x3415e5(0xda)?0x1:0x2,_0x3e9650=await this[_0x3415e5(0x136)][_0x3415e5(0x17e)]({'orderId':_0x28404f[_0x3415e5(0x174)]},{'status':_0xe2480e,'paydAt':new Date()});_0xe2480e===0x1&&await this[_0x3415e5(0x132)]['addBalanceToOrder'](_0x4e4574);if(_0x3e9650[_0x3415e5(0x165)]!=0x1)return'failed';return'success';}async[_0x543297(0x143)](_0x43a269,_0x233948,_0x357221=_0x543297(0x160)){const _0x2b0add=_0x543297,_0xc88d97=await this[_0x2b0add(0x136)][_0x2b0add(0x18b)]({'where':{'userId':_0x43a269,'orderId':_0x233948}});if(!_0xc88d97)throw new common_1['HttpException'](_0x2b0add(0x100),common_1['HttpStatus'][_0x2b0add(0x105)]);const _0x2286d1=await this['cramiPackageEntity'][_0x2b0add(0x18b)]({'where':{'id':_0xc88d97[_0x2b0add(0x199)]}});if(!_0x2286d1)throw new common_1[(_0x2b0add(0x13a))]('套餐不存在!',common_1[_0x2b0add(0xdd)]['BAD_REQUEST']);const {payEpayPid:_0x376769,payEpaySecret:_0x1dba43,payEpayNotifyUrl:_0x509518,payEpayReturnUrl:_0x48416d,payEpayApiPayUrl:_0xd5c9a4}=await this[_0x2b0add(0xed)][_0x2b0add(0xeb)]([_0x2b0add(0x167),_0x2b0add(0x121),_0x2b0add(0x13d),_0x2b0add(0xe6),_0x2b0add(0x16d)]);let _0x5e76de;_0x376769[_0x2b0add(0xf4)]<=0x10?_0x5e76de=Number(_0x376769):_0x5e76de=BigInt(_0x376769);const _0x2ee95d={};_0x2ee95d['pid']=_0x5e76de,_0x2ee95d[_0x2b0add(0x1a8)]=_0x357221,_0x2ee95d[_0x2b0add(0x174)]=_0x233948,_0x2ee95d[_0x2b0add(0x12e)]=_0x2286d1['name'],_0x2ee95d[_0x2b0add(0xf7)]=_0xc88d97[_0x2b0add(0x1a6)],_0x2ee95d[_0x2b0add(0x12a)]=_0x2b0add(0xfc),_0x2ee95d[_0x2b0add(0x15d)]='pc',_0x2ee95d[_0x2b0add(0x195)]=_0x509518,_0x2ee95d[_0x2b0add(0x10d)]=_0x48416d,_0x2ee95d[_0x2b0add(0x10e)]='epay',_0x2ee95d[_0x2b0add(0x15b)]=this[_0x2b0add(0x15b)](_0x2ee95d,_0x1dba43),_0x2ee95d[_0x2b0add(0x150)]=_0x2b0add(0x184);const _0x175868=new URLSearchParams(_0x2ee95d)[_0x2b0add(0x1a9)](),_0x4cff73=_0xd5c9a4+'?'+_0x175868;if(_0xd5c9a4[_0x2b0add(0x109)](_0x2b0add(0x18d)))return{'url_qrcode':null,'redirectUrl':_0x4cff73,'channel':_0x357221,'isRedirect':!![]};else{const _0x51747a=await axios_1[_0x2b0add(0x119)][_0x2b0add(0x125)](_0xd5c9a4,{'params':_0x2ee95d});console[_0x2b0add(0x1a3)](_0x2b0add(0x16a),_0x51747a[_0x2b0add(0x19c)]);const {data:{code:_0x10097f,msg:_0x341ea4,qrcode:_0xe4a008}}=_0x51747a;if(_0x10097f!=0x1)throw new common_1[(_0x2b0add(0x13a))](_0x341ea4,common_1[_0x2b0add(0xdd)][_0x2b0add(0x105)]);return{'url_qrcode':_0xe4a008,'redirectUrl':null,'channel':_0x357221,'isRedirect':![]};}}async[_0x543297(0x104)](_0x2fe8b8){const _0x11c430=_0x543297,{payEpayPid:_0x131763,payEpaySecret:_0x388eca,payEpayApiQueryUrl:_0x4ebe73}=await this['globalConfigService']['getConfigs'](['payEpayPid',_0x11c430(0x121),_0x11c430(0xec)]),_0x265b53={};_0x265b53[_0x11c430(0xf5)]=_0x11c430(0xf0),_0x265b53[_0x11c430(0x174)]=_0x2fe8b8,_0x265b53[_0x11c430(0xd9)]=_0x131763,_0x265b53['key']=_0x388eca;const {data:{code:_0x375f09,msg:_0x3478a1,data:_0xc4e9a0}}=await axios_1[_0x11c430(0x119)][_0x11c430(0x125)](_0x4ebe73,{'params':_0x265b53});if(_0x375f09!=0x1)throw new common_1[(_0x11c430(0x13a))](_0x3478a1,common_1[_0x11c430(0xdd)][_0x11c430(0x105)]);return _0xc4e9a0;}async['notifyMpay'](_0x4fc46a){const _0x6bd948=_0x543297,_0x2e419f=_0x4fc46a[_0x6bd948(0x15b)];delete _0x4fc46a[_0x6bd948(0x15b)],delete _0x4fc46a[_0x6bd948(0x150)];const _0x4df7c0=await this[_0x6bd948(0xed)][_0x6bd948(0xeb)](['payMpaySecret']);console[_0x6bd948(0x1a3)](_0x6bd948(0x188));if(this[_0x6bd948(0x15b)](_0x4fc46a,_0x4df7c0)!=_0x2e419f)return'failed';console[_0x6bd948(0x1a3)](_0x6bd948(0x108));const _0xa3be43=await this['orderEntity'][_0x6bd948(0x18b)]({'where':{'orderId':_0x4fc46a[_0x6bd948(0x174)],'status':0x0}});if(!_0xa3be43)return'failed';const _0x1bbac7=_0x4fc46a['trade_status']==_0x6bd948(0xda)?0x1:0x2;console[_0x6bd948(0x1a3)]('status:\x20',_0x1bbac7);const _0x8efd52=await this['orderEntity']['update']({'orderId':_0x4fc46a['out_trade_no']},{'status':_0x1bbac7,'paydAt':new Date()});_0x1bbac7===0x1&&await this['userBalanceService'][_0x6bd948(0x166)](_0xa3be43);if(_0x8efd52[_0x6bd948(0x165)]!=0x1)return _0x6bd948(0x131);return'success';}async['payMpay'](_0x581509,_0x38e568,_0x3cf254=_0x543297(0x156)){const _0x20f14d=_0x543297,_0x2a4779=await this[_0x20f14d(0x136)][_0x20f14d(0x18b)]({'where':{'userId':_0x581509,'orderId':_0x38e568}});if(!_0x2a4779)throw new common_1[(_0x20f14d(0x13a))](_0x20f14d(0x100),common_1['HttpStatus']['BAD_REQUEST']);const _0x4cc17b=await this[_0x20f14d(0x11e)]['findOne']({'where':{'id':_0x2a4779['goodsId']}});if(!_0x4cc17b)throw new common_1[(_0x20f14d(0x13a))](_0x20f14d(0x153),common_1[_0x20f14d(0xdd)][_0x20f14d(0x105)]);const {payMpayPid:_0x240394,payMpaySecret:_0x571f4e,payMpayNotifyUrl:_0x5ccd81,payMpayReturnUrl:_0x361f1b,payMpayApiPayUrl:_0x3be594}=await this[_0x20f14d(0xed)][_0x20f14d(0xeb)]([_0x20f14d(0x113),_0x20f14d(0x159),_0x20f14d(0x124),_0x20f14d(0x16e),_0x20f14d(0xf9)]),_0x4250fb={};_0x4250fb['pid']=Number(_0x240394),_0x4250fb['type']=_0x3cf254,_0x4250fb[_0x20f14d(0x174)]=_0x38e568,_0x4250fb[_0x20f14d(0x12e)]=_0x4cc17b['name'],_0x4250fb[_0x20f14d(0xf7)]=_0x2a4779[_0x20f14d(0x1a6)],_0x4250fb[_0x20f14d(0x195)]=_0x5ccd81,_0x4250fb[_0x20f14d(0x10d)]=_0x361f1b,_0x4250fb[_0x20f14d(0x15b)]=this[_0x20f14d(0x15b)](_0x4250fb,_0x571f4e),_0x4250fb[_0x20f14d(0x150)]=_0x20f14d(0x184);const _0x17563a=new URLSearchParams(_0x4250fb)['toString'](),_0x562671=_0x3be594+'?'+_0x17563a;return{'url_qrcode':null,'redirectUrl':_0x562671,'channel':_0x3cf254,'isRedirect':!![]};}async[_0x543297(0x162)](_0x223f06){const _0x232951=_0x543297,{payMpayApiQueryUrl:_0x5b7016}=await this[_0x232951(0xed)][_0x232951(0xeb)]([_0x232951(0x113),_0x232951(0x159),_0x232951(0x15f)]),_0x73e2b5={};_0x73e2b5[_0x232951(0x1a8)]=0x2,_0x73e2b5[_0x232951(0x111)]=_0x223f06;const {data:{code:_0x3b5cd1,msg:_0x42ad6e,data:_0x45636c}}=await axios_1[_0x232951(0x119)][_0x232951(0x125)](_0x5b7016,{'params':_0x73e2b5});if(_0x3b5cd1!=0x1)throw new common_1[(_0x232951(0x13a))](_0x42ad6e,common_1[_0x232951(0xdd)][_0x232951(0x105)]);return _0x45636c;}async[_0x543297(0x123)](_0x51be43){const _0xef2edd=_0x543297;console[_0xef2edd(0x1a3)](_0xef2edd(0xf1),_0x51be43);const {payWeChatAppId:_0x32b347,payWeChatMchId:_0x25a377,payWeChatSecret:_0x4246e4,payWeChatPublicKey:_0x53a46d,payWeChatPrivateKey:_0x11be11}=await this[_0xef2edd(0xed)][_0xef2edd(0xeb)]([_0xef2edd(0xee),_0xef2edd(0x158),_0xef2edd(0x16c),_0xef2edd(0x17a),'payWeChatPrivateKey']),_0x346bd0=new WxPay({'appid':_0x32b347,'mchid':_0x25a377,'publicKey':_0x53a46d,'privateKey':_0x11be11});let _0x5926e7;try{if(_0x51be43[_0xef2edd(0xd5)]==_0xef2edd(0x178)){const {ciphertext:_0x3f841c,associated_data:_0x5f0057,nonce:_0x232573}=_0x51be43[_0xef2edd(0x115)],_0x20bd69=_0x346bd0[_0xef2edd(0xf8)](_0x3f841c,_0x5f0057,_0x232573,_0x4246e4),_0x120fd0=_0x20bd69['out_trade_no'];_0x5926e7=redisKey_constant_1[_0xef2edd(0x130)]+_0x120fd0,await this[_0xef2edd(0x127)][_0xef2edd(0x141)]({'key':_0x5926e7,'val':_0xef2edd(0x107)});const _0x1e155a=await this[_0xef2edd(0x136)][_0xef2edd(0x18b)]({'where':{'orderId':_0x120fd0,'status':0x0}});if(!_0x1e155a)return _0xef2edd(0x131);if([0x1,0x2,0x3][_0xef2edd(0x109)](_0x1e155a[_0xef2edd(0xd7)]))return _0xef2edd(0x161);const _0x1ad1e8=await this[_0xef2edd(0x169)][_0xef2edd(0xd2)](async _0x27d205=>{const _0x2a2834=_0xef2edd,_0x5ab3b5=_0x20bd69[_0x2a2834(0xe3)]==_0x2a2834(0x180)?0x1:0x2,_0x258cb4=await this[_0x2a2834(0x136)][_0x2a2834(0x17e)]({'orderId':_0x120fd0},{'status':_0x5ab3b5,'paydAt':new Date(),'tradeId':_0x20bd69['transaction_id']});return _0x5ab3b5===0x1&&await this[_0x2a2834(0x132)][_0x2a2834(0x166)](_0x1e155a),_0x258cb4;});if(_0x1ad1e8[_0xef2edd(0x165)]!=0x1)return _0xef2edd(0x131);}return'success';}catch(_0x56e6c2){return console[_0xef2edd(0x1a3)]('error:\x20',_0x56e6c2),console['log']('支付通知验证失败:\x20',_0x56e6c2),_0xef2edd(0x131);}finally{_0x5926e7&&await this['redisCacheService'][_0xef2edd(0x135)]({'key':_0x5926e7});}}async[_0x543297(0x10b)](_0xcac9d9,_0x5ac306,_0x290af5){const _0x28b22d=_0x543297,_0x26cb57=await this['orderEntity'][_0x28b22d(0x18b)]({'where':{'userId':_0xcac9d9,'orderId':_0x5ac306}});if(!_0x26cb57)throw new common_1['HttpException'](_0x28b22d(0x100),common_1['HttpStatus'][_0x28b22d(0x105)]);const _0x1a1144=await this[_0x28b22d(0x11e)]['findOne']({'where':{'id':_0x26cb57[_0x28b22d(0x199)]}});if(!_0x1a1144)throw new common_1[(_0x28b22d(0x13a))](_0x28b22d(0x153),common_1[_0x28b22d(0xdd)][_0x28b22d(0x105)]);const _0x2b4435={'bizContent':{'out_trade_no':_0x5ac306,'total_amount':_0x26cb57[_0x28b22d(0x1a6)],'subject':_0x1a1144[_0x28b22d(0x12e)]}};let _0x323ea2,_0xfcf0d1,_0x24a6f0,_0x1fdb1c,_0x5d6fbf;const {payAliPublicSecret:_0x2d8ce8,payAliWebAppId:_0x1d91ed,payAliWebSecret:_0x10645f,payAliAppAppId:_0x57a893,payAliAppSecret:_0x545c32,payWeChatNotifyUrl:_0xb42789}=await this['globalConfigService']['getConfigs']([_0x28b22d(0xd4),_0x28b22d(0xe8),'payAliWebSecret',_0x28b22d(0x13e),_0x28b22d(0x139),_0x28b22d(0x12f)]);_0x290af5===_0x28b22d(0xef)&&(_0x2b4435[_0x28b22d(0xdb)]=_0x28b22d(0x106),_0x323ea2=_0x1d91ed,_0x24a6f0=_0x28b22d(0xe0),_0xfcf0d1=_0x10645f,_0x1fdb1c='alipay.trade.page.pay',_0x5d6fbf='FAST_INSTANT_TRADE_PAY');_0x290af5==='app'&&(_0x24a6f0=_0x28b22d(0x16f),_0x323ea2=_0x57a893,_0xfcf0d1=_0x545c32,_0x1fdb1c=_0x28b22d(0xde),_0x5d6fbf=_0x28b22d(0x186));const _0x178ec5=new AlipaySdk({'appId':_0x323ea2,'keyType':'PKCS1','privateKey':_0xfcf0d1,'alipayPublicKey':_0x2d8ce8});_0x2b4435[_0x28b22d(0x102)]=_0xb42789,_0x2b4435[_0x28b22d(0x183)][_0x28b22d(0x179)]=_0x5d6fbf;const _0x2c1d1b=await _0x178ec5[_0x24a6f0](_0x1fdb1c,_0x2b4435);return console[_0x28b22d(0x1a3)](_0x28b22d(0x175),_0x2c1d1b),_0x290af5===_0x28b22d(0xef)?{'form':_0x2c1d1b}:{'data':_0x2c1d1b};}async[_0x543297(0x128)](_0x5681c6,_0x39b56b){const _0x5d0428=_0x543297;let _0x10d092,_0x595981;const {payAliPublicSecret:_0x4d38af,payAliWebAppId:_0x21c8d3,payAliWebSecret:_0x17574d,payAliAppAppId:_0x53603c,payAliAppSecret:_0x57a97d,payWeChatNotifyUrl:_0x52a22}=await this['globalConfigService']['getConfigs']([_0x5d0428(0xd4),_0x5d0428(0xe8),'payAliWebSecret',_0x5d0428(0x13e),_0x5d0428(0x139),'payWeChatNotifyUrl']);_0x39b56b==='native'&&(_0x10d092=_0x21c8d3,_0x595981=_0x17574d);_0x39b56b==='app'&&(_0x10d092=_0x53603c,_0x595981=_0x57a97d);const _0x1a643d=new AlipaySdk({'appId':_0x10d092,'keyType':_0x5d0428(0x14a),'privateKey':_0x595981,'alipayPublicKey':_0x4d38af}),_0x30c2a2=await _0x1a643d[_0x5d0428(0x172)](_0x5d0428(0x14f),{'bizContent':{'out_trade_no':_0x5681c6}});return console[_0x5d0428(0x1a3)](_0x30c2a2),_0x30c2a2;}async[_0x543297(0x154)](_0x592598,_0x1abf95,_0x5742f3=_0x543297(0xef)){const _0x2efa5d=_0x543297;console[_0x2efa5d(0x1a3)](_0x2efa5d(0x1aa),_0x5742f3);const _0x559a3d=await this[_0x2efa5d(0x136)][_0x2efa5d(0x18b)]({'where':{'userId':_0x592598,'orderId':_0x1abf95}});if(!_0x559a3d)throw new common_1['HttpException'](_0x2efa5d(0x100),common_1[_0x2efa5d(0xdd)][_0x2efa5d(0x105)]);const _0x965389=await this[_0x2efa5d(0x11e)]['findOne']({'where':{'id':_0x559a3d[_0x2efa5d(0x199)]}});if(!_0x965389)throw new common_1['HttpException']('套餐不存在!',common_1[_0x2efa5d(0xdd)][_0x2efa5d(0x105)]);const {payWeChatAppId:_0x14ccc5,payWeMiniAppId:_0x3d906f,payWeChatMchId:_0x1166ee,payWeChatPublicKey:_0x43102a,payWeChatPrivateKey:_0x31c550,payWeChatNotifyUrl:_0x1f3dc9,payWeChatH5Name:_0x3fbf2f,payWeChatH5Url:_0x158ae7,WE_APP_APPID:_0x1ac991,WE_APP_APPSECRET:_0x505886}=await this[_0x2efa5d(0xed)]['getConfigs']([_0x2efa5d(0xee),_0x2efa5d(0xea),_0x2efa5d(0x158),_0x2efa5d(0x17a),_0x2efa5d(0xe9),_0x2efa5d(0x12f),_0x2efa5d(0xe5),_0x2efa5d(0x190),_0x2efa5d(0x149)]),_0xfe0bb6=new WxPay({'appid':_0x5742f3==='mini'?_0x3d906f:_0x14ccc5,'mchid':_0x1166ee,'publicKey':_0x43102a,'privateKey':_0x31c550}),_0x125a37={'appid':_0x5742f3===_0x2efa5d(0x17f)?_0x3d906f:_0x14ccc5,'mchid':_0x1166ee,'description':_0x965389[_0x2efa5d(0x12e)],'out_trade_no':_0x1abf95,'notify_url':_0x1f3dc9,'amount':{'total':Number(_0x559a3d['total']*0x64)},'scene_info':{'payer_client_ip':_0x2efa5d(0xfc)}};console['log'](_0x2efa5d(0x12d),_0x125a37);if(_0x5742f3=='h5'){_0x125a37[_0x2efa5d(0x144)][_0x2efa5d(0x11f)]={'type':_0x2efa5d(0x120),'app_name':_0x3fbf2f,'app_url':_0x158ae7};const _0x38e941=await _0xfe0bb6[_0x2efa5d(0x1a7)](_0x125a37);if(_0x38e941[_0x2efa5d(0xd7)]===0x193){const _0x382eaa=_0x38e941?.['errRaw']?.[_0x2efa5d(0x18a)]?.[_0x2efa5d(0x110)]?.[_0x2efa5d(0x176)];throw new common_1[(_0x2efa5d(0x13a))](_0x38e941?.[_0x2efa5d(0x176)]||_0x2efa5d(0x1a0),common_1[_0x2efa5d(0xdd)][_0x2efa5d(0x105)]);}const {h5_url:_0x265534}=_0x38e941;return{'url':_0x265534};}if(_0x5742f3===_0x2efa5d(0x14b)){_0x125a37[_0x2efa5d(0x146)]=_0x1ac991;const _0x5021ef=await _0xfe0bb6[_0x2efa5d(0x138)](_0x125a37);return console[_0x2efa5d(0x1a3)](_0x2efa5d(0x122),_0x5021ef),_0x5021ef;}if(_0x5742f3==_0x2efa5d(0x17f)){const _0x123c66=await this[_0x2efa5d(0x117)][_0x2efa5d(0xd1)](_0x592598);_0x125a37[_0x2efa5d(0x189)]={'openid':_0x123c66};const _0x5a0ba7=await _0xfe0bb6[_0x2efa5d(0x101)](_0x125a37);return console[_0x2efa5d(0x1a3)](_0x2efa5d(0xfa),_0x5a0ba7),_0x5a0ba7;}if(_0x5742f3==_0x2efa5d(0x1a4)){const _0x340c20=await this[_0x2efa5d(0x117)][_0x2efa5d(0x11b)](_0x592598);console[_0x2efa5d(0x1a3)](_0x2efa5d(0x17c),_0x340c20),_0x125a37[_0x2efa5d(0x189)]={'openid':_0x340c20};const _0x3d0021=await _0xfe0bb6[_0x2efa5d(0x101)](_0x125a37);return console['log'](_0x2efa5d(0xfa),_0x3d0021),_0x3d0021;}if(_0x5742f3==_0x2efa5d(0xef)){const _0x41cb9c=await _0xfe0bb6[_0x2efa5d(0xf3)](_0x125a37),{code_url:_0x140220}=_0x41cb9c;return!_0x140220&&console['log']('wx-native',_0x41cb9c),{'url_qrcode':_0x140220,'isRedirect':![]};}throw new common_1[(_0x2efa5d(0x13a))](_0x2efa5d(0x142),common_1[_0x2efa5d(0xdd)][_0x2efa5d(0x105)]);}async[_0x543297(0xdf)](_0x23c838,_0x3622c1){const _0x17f733=_0x543297,{payWeChatAppId:_0x1d3b20,payWeMiniAppId:_0x27d1d6,payWeChatMchId:_0x458922,payWeChatPublicKey:_0x603379,payWeChatPrivateKey:_0x43f6ee}=await this[_0x17f733(0xed)][_0x17f733(0xeb)]([_0x17f733(0xee),_0x17f733(0xea),_0x17f733(0x158),_0x17f733(0x17a),'payWeChatPrivateKey']),_0x5cd84c=new WxPay({'appid':_0x3622c1==='mini'?_0x27d1d6:_0x1d3b20,'mchid':_0x458922,'publicKey':_0x603379,'privateKey':_0x43f6ee}),_0x3da92a=await _0x5cd84c[_0x17f733(0x12c)]({'out_trade_no':_0x23c838});return _0x3da92a;}async[_0x543297(0x157)](_0x2cb455){const _0x3b0069=_0x543297;_0x2cb455[_0x3b0069(0xff)]===_0x3b0069(0x148)&&await this[_0x3b0069(0x196)](_0x2cb455);}async[_0x543297(0x196)](_0x153361){const _0x4961dc=_0x543297,{payWeChatAppId:_0x9c259e,payWeMiniAppId:_0xa8cd05,payWeChatMchId:_0x3e33ec,payWeChatPublicKey:_0x14a8ae,payWeChatPrivateKey:_0x2366ec}=await this[_0x4961dc(0xed)][_0x4961dc(0xeb)](['payWeChatAppId','payWeMiniAppId','payWeChatMchId',_0x4961dc(0x17a),_0x4961dc(0xe9),_0x4961dc(0x12f),_0x4961dc(0xe5),'payWeChatH5Url']),_0x4e8d91=new WxPay({'appid':_0x153361[_0x4961dc(0x10f)]===_0x4961dc(0x17f)?_0xa8cd05:_0x9c259e,'mchid':_0x3e33ec,'publicKey':_0x14a8ae,'privateKey':_0x2366ec});await _0x4e8d91[_0x4961dc(0x197)](_0x153361[_0x4961dc(0x15c)]);}[_0x543297(0x15b)](_0x4e22fb,_0x5bff52){const _0x5924ee=_0x543297,_0x33834d=Object['keys'](_0x4e22fb)[_0x5924ee(0x164)]()[_0x5924ee(0x194)](_0x585c86=>_0x585c86+'='+_0x4e22fb[_0x585c86])[_0x5924ee(0x137)]('&')+_0x5bff52;return crypto['createHash'](_0x5924ee(0x16b))['update'](_0x33834d)['digest'](_0x5924ee(0x129));}};PayService=__decorate([(0x0,common_1[_0x543297(0x152)])(),__param(0x0,(0x0,typeorm_1[_0x543297(0x12b)])(cramiPackage_entity_1[_0x543297(0x116)])),__param(0x1,(0x0,typeorm_1[_0x543297(0x12b)])(order_entity_1[_0x543297(0x191)])),__metadata(_0x543297(0x14e),[typeorm_2[_0x543297(0x118)],typeorm_2[_0x543297(0x118)],userBalance_service_1[_0x543297(0xfd)],globalConfig_service_1[_0x543297(0x155)],user_service_1['UserService'],redisCache_service_1[_0x543297(0x1a2)],typeorm_2['Connection']])],PayService),exports[_0x543297(0xcf)]=PayService;