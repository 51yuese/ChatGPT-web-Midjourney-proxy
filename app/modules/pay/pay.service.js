'use strict';const _0x1cd090=_0x4844;(function(_0x13115c,_0x34ed6c){const _0xcb25de=_0x4844,_0x31db44=_0x13115c();while(!![]){try{const _0x30c7a8=-parseInt(_0xcb25de(0x267))/0x1*(parseInt(_0xcb25de(0x1ca))/0x2)+-parseInt(_0xcb25de(0x224))/0x3+parseInt(_0xcb25de(0x207))/0x4+parseInt(_0xcb25de(0x1ef))/0x5*(-parseInt(_0xcb25de(0x27d))/0x6)+parseInt(_0xcb25de(0x215))/0x7*(-parseInt(_0xcb25de(0x214))/0x8)+parseInt(_0xcb25de(0x251))/0x9*(-parseInt(_0xcb25de(0x216))/0xa)+parseInt(_0xcb25de(0x22b))/0xb*(parseInt(_0xcb25de(0x1cd))/0xc);if(_0x30c7a8===_0x34ed6c)break;else _0x31db44['push'](_0x31db44['shift']());}catch(_0x4cc16c){_0x31db44['push'](_0x31db44['shift']());}}}(_0x2dbe,0x3f44c));function _0x4844(_0x136201,_0x28ea8c){const _0x2dbedd=_0x2dbe();return _0x4844=function(_0x484452,_0x54903c){_0x484452=_0x484452-0x1c9;let _0xf3e3e4=_0x2dbedd[_0x484452];return _0xf3e3e4;},_0x4844(_0x136201,_0x28ea8c);}var __decorate=this&&this[_0x1cd090(0x290)]||function(_0xcc3112,_0x3ea4c7,_0x35025f,_0x1efc09){const _0x1dc390=_0x1cd090;var _0x2dd338=arguments[_0x1dc390(0x254)],_0x4ddf48=_0x2dd338<0x3?_0x3ea4c7:_0x1efc09===null?_0x1efc09=Object[_0x1dc390(0x26c)](_0x3ea4c7,_0x35025f):_0x1efc09,_0x3976c3;if(typeof Reflect==='object'&&typeof Reflect[_0x1dc390(0x223)]===_0x1dc390(0x244))_0x4ddf48=Reflect[_0x1dc390(0x223)](_0xcc3112,_0x3ea4c7,_0x35025f,_0x1efc09);else{for(var _0xe92b19=_0xcc3112[_0x1dc390(0x254)]-0x1;_0xe92b19>=0x0;_0xe92b19--)if(_0x3976c3=_0xcc3112[_0xe92b19])_0x4ddf48=(_0x2dd338<0x3?_0x3976c3(_0x4ddf48):_0x2dd338>0x3?_0x3976c3(_0x3ea4c7,_0x35025f,_0x4ddf48):_0x3976c3(_0x3ea4c7,_0x35025f))||_0x4ddf48;}return _0x2dd338>0x3&&_0x4ddf48&&Object[_0x1dc390(0x1c9)](_0x3ea4c7,_0x35025f,_0x4ddf48),_0x4ddf48;},__metadata=this&&this[_0x1cd090(0x22a)]||function(_0x1771bf,_0x5cc6ef){const _0x51c34d=_0x1cd090;if(typeof Reflect===_0x51c34d(0x1e6)&&typeof Reflect[_0x51c34d(0x27c)]===_0x51c34d(0x244))return Reflect[_0x51c34d(0x27c)](_0x1771bf,_0x5cc6ef);},__param=this&&this['__param']||function(_0x5e7052,_0x572cac){return function(_0x198343,_0x4e3da9){_0x572cac(_0x198343,_0x4e3da9,_0x5e7052);};};Object[_0x1cd090(0x1c9)](exports,_0x1cd090(0x23a),{'value':!![]}),exports[_0x1cd090(0x273)]=void 0x0;const typeorm_1=require(_0x1cd090(0x25f)),typeorm_2=require(_0x1cd090(0x283)),common_1=require('@nestjs/common'),crypto=require(_0x1cd090(0x1e9)),axios_1=require(_0x1cd090(0x1ff)),order_entity_1=require(_0x1cd090(0x24a)),cramiPackage_entity_1=require('../crami/cramiPackage.entity'),userBalance_service_1=require(_0x1cd090(0x252)),globalConfig_service_1=require(_0x1cd090(0x1f3)),utils_1=require(_0x1cd090(0x246)),user_service_1=require(_0x1cd090(0x24b)),redisCache_service_1=require(_0x1cd090(0x1cb)),redisKey_constant_1=require(_0x1cd090(0x299)),WxPay=require(_0x1cd090(0x204)),AlipaySdk=require(_0x1cd090(0x1d6));let PayService=class PayService{constructor(_0x319456,_0x90a6cc,_0x35395b,_0x9d4a23,_0x455401,_0x254ed1,_0x5141f8){const _0x3ad1c7=_0x1cd090;this[_0x3ad1c7(0x211)]=_0x319456,this[_0x3ad1c7(0x271)]=_0x90a6cc,this[_0x3ad1c7(0x1f0)]=_0x35395b,this['globalConfigService']=_0x9d4a23,this[_0x3ad1c7(0x1da)]=_0x455401,this[_0x3ad1c7(0x298)]=_0x254ed1,this[_0x3ad1c7(0x222)]=_0x5141f8;}async[_0x1cd090(0x21f)](){}async[_0x1cd090(0x259)](_0x206050){const _0x337df0=_0x1cd090;if(_0x206050[_0x337df0(0x1cc)]==_0x337df0(0x23f))return this[_0x337df0(0x1d4)](_0x206050);if(_0x206050[_0x337df0(0x263)]==_0x337df0(0x241))return this[_0x337df0(0x28d)](_0x206050);if(typeof _0x206050['resource']==_0x337df0(0x1e6))return this['notifyWeChat'](_0x206050);return this[_0x337df0(0x27e)](_0x206050);}async[_0x1cd090(0x289)](_0x1fbf24,_0x42dbbf,_0x5e8c44=_0x1cd090(0x20d)){const _0x58998a=_0x1cd090,_0xefa00d=await this[_0x58998a(0x271)]['findOne']({'where':{'userId':_0x1fbf24,'orderId':_0x42dbbf}});if(!_0xefa00d)throw new common_1[(_0x58998a(0x28a))](_0x58998a(0x205),common_1[_0x58998a(0x20a)][_0x58998a(0x284)]);const _0x282ee8=await this['cramiPackageEntity'][_0x58998a(0x213)]({'where':{'id':_0xefa00d[_0x58998a(0x1e1)]}});if(!_0x282ee8)throw new common_1['HttpException'](_0x58998a(0x20f),common_1['HttpStatus'][_0x58998a(0x284)]);console['log'](_0x58998a(0x28b),_0xefa00d['payPlatform']);try{if(_0xefa00d['payPlatform']==_0x58998a(0x233))return this[_0x58998a(0x23c)](_0x1fbf24,_0x42dbbf,_0x5e8c44);if(_0xefa00d['payPlatform']==_0x58998a(0x1d2))return this[_0x58998a(0x1e0)](_0x1fbf24,_0x42dbbf,_0x5e8c44);if(_0xefa00d[_0x58998a(0x1f7)]==_0x58998a(0x23f))return this[_0x58998a(0x1cf)](_0x1fbf24,_0x42dbbf,_0x5e8c44);if(_0xefa00d['payPlatform']=='mpay')return this[_0x58998a(0x226)](_0x1fbf24,_0x42dbbf,_0x5e8c44);if(_0xefa00d[_0x58998a(0x1f7)]=='hupi')return this[_0x58998a(0x264)](_0x1fbf24,_0x42dbbf,_0x5e8c44);}catch(_0x4d5fc6){console[_0x58998a(0x1f4)](_0x58998a(0x257),_0x4d5fc6);throw new common_1[(_0x58998a(0x28a))](_0x58998a(0x1f9),common_1[_0x58998a(0x20a)][_0x58998a(0x284)]);}}async[_0x1cd090(0x294)](_0x4ed7f6){const _0x3fee96=_0x1cd090,_0x1af354=await this[_0x3fee96(0x271)][_0x3fee96(0x213)]({'where':{'orderId':_0x4ed7f6}});if(!_0x1af354)throw new common_1[(_0x3fee96(0x28a))](_0x3fee96(0x205),common_1['HttpStatus'][_0x3fee96(0x284)]);return _0x1af354;}async[_0x1cd090(0x28d)](_0x2b8dc8){const _0xd4d15f=_0x1cd090,_0x12c206=await this[_0xd4d15f(0x1d9)]['getConfigs']([_0xd4d15f(0x208)]),_0x10e230=_0x2b8dc8[_0xd4d15f(0x237)];delete _0x2b8dc8[_0xd4d15f(0x237)];if(this[_0xd4d15f(0x1db)](_0x2b8dc8,_0x12c206)!=_0x10e230)return _0xd4d15f(0x274);const _0x40ffc0=await this[_0xd4d15f(0x271)][_0xd4d15f(0x213)]({'where':{'orderId':_0x2b8dc8[_0xd4d15f(0x21d)],'status':0x0}});if(!_0x40ffc0)return _0xd4d15f(0x274);await this['userBalanceService'][_0xd4d15f(0x231)](_0x40ffc0);const _0x3a7a80=await this[_0xd4d15f(0x271)][_0xd4d15f(0x249)]({'orderId':_0x2b8dc8[_0xd4d15f(0x21d)]},{'status':0x1,'paydAt':new Date()});if(_0x3a7a80[_0xd4d15f(0x265)]!=0x1)return _0xd4d15f(0x274);return _0xd4d15f(0x212);}async[_0x1cd090(0x264)](_0x510613,_0x4b6ea,_0x5f3f5b=_0x1cd090(0x20d)){const _0x194a81=_0x1cd090,_0x3c9ef5=await this['orderEntity'][_0x194a81(0x213)]({'where':{'userId':_0x510613,'orderId':_0x4b6ea}});if(!_0x3c9ef5)throw new common_1[(_0x194a81(0x28a))](_0x194a81(0x205),common_1[_0x194a81(0x20a)][_0x194a81(0x284)]);const _0x469e50=await this['cramiPackageEntity']['findOne']({'where':{'id':_0x3c9ef5[_0x194a81(0x1e1)]}});if(!_0x469e50)throw new common_1['HttpException'](_0x194a81(0x20f),common_1['HttpStatus'][_0x194a81(0x284)]);const {payHupiAppId:_0x15d050,payHupiSecret:_0x289f44,payHupiNotifyUrl:_0x2d2f90,payHupiReturnUrl:_0x3de9d1,payHupiGatewayUrl:_0x45fd05}=await this[_0x194a81(0x1d9)][_0x194a81(0x26d)]([_0x194a81(0x200),_0x194a81(0x208),_0x194a81(0x1eb),_0x194a81(0x291),_0x194a81(0x22f)]),_0x292a38={};_0x292a38[_0x194a81(0x26f)]=_0x194a81(0x29d),_0x292a38[_0x194a81(0x22c)]=_0x15d050,_0x292a38['time']=(Date[_0x194a81(0x210)]()/0x3e8)[_0x194a81(0x29a)](0x0),_0x292a38[_0x194a81(0x203)]=(0x0,utils_1[_0x194a81(0x258)])(0x20),_0x292a38[_0x194a81(0x21d)]=_0x4b6ea,_0x292a38['title']=_0x469e50['name'],_0x292a38[_0x194a81(0x20b)]=_0x3c9ef5[_0x194a81(0x1f2)],_0x292a38['notify_url']=_0x2d2f90,_0x292a38[_0x194a81(0x206)]=_0x3de9d1,_0x292a38[_0x194a81(0x263)]=_0x194a81(0x241),_0x292a38['hash']=this[_0x194a81(0x1db)](_0x292a38,_0x289f44);const {data:{errcode:_0x42804d,errmsg:_0x99e57a,url_qrcode:_0x2adbde,url:_0x215d26}}=await axios_1[_0x194a81(0x24e)]['post'](_0x45fd05||_0x194a81(0x1f5),_0x292a38);if(_0x42804d!=0x0)throw new common_1['HttpException'](_0x99e57a,common_1[_0x194a81(0x20a)][_0x194a81(0x284)]);return{'url_qrcode':_0x2adbde,'url':_0x215d26};}async[_0x1cd090(0x235)](_0x2fa239){const _0x54b9c7=_0x1cd090,{payHupiAppId:_0x48ac74,payHupiSecret:_0xed97a1}=await this[_0x54b9c7(0x1d9)]['getConfigs']([_0x54b9c7(0x200),'payHupiSecret']),_0x2d07e3={};_0x2d07e3[_0x54b9c7(0x26f)]=_0x54b9c7(0x29d),_0x2d07e3[_0x54b9c7(0x22c)]=_0x48ac74,_0x2d07e3[_0x54b9c7(0x277)]=(Date[_0x54b9c7(0x210)]()/0x3e8)['toFixed'](0x0),_0x2d07e3['nonce_str']=(0x0,utils_1[_0x54b9c7(0x258)])(0x20),_0x2d07e3[_0x54b9c7(0x1ea)]=_0x2fa239,_0x2d07e3['hash']=this[_0x54b9c7(0x1db)](_0x2d07e3,_0xed97a1);const {data:{errcode:_0x4540aa,errmsg:_0x23483b,data:_0x3610b2}}=await axios_1['default'][_0x54b9c7(0x1d0)](_0x54b9c7(0x25b),_0x2d07e3);if(_0x4540aa!=0x0)throw new common_1[(_0x54b9c7(0x28a))](_0x23483b,common_1[_0x54b9c7(0x20a)][_0x54b9c7(0x284)]);return _0x3610b2;}async['notifyEpay'](_0x482d65){const _0xc2e4a9=_0x1cd090,_0x17995b=_0x482d65['sign'];delete _0x482d65['sign'],delete _0x482d65[_0xc2e4a9(0x268)];const _0x312334=await this[_0xc2e4a9(0x1d9)]['getConfigs']([_0xc2e4a9(0x1d8)]);if(this[_0xc2e4a9(0x1db)](_0x482d65,_0x312334)!=_0x17995b)return _0xc2e4a9(0x274);console[_0xc2e4a9(0x1f4)](_0xc2e4a9(0x24d));const _0x30d375=await this[_0xc2e4a9(0x271)][_0xc2e4a9(0x213)]({'where':{'orderId':_0x482d65['out_trade_no'],'status':0x0}});if(!_0x30d375)return _0xc2e4a9(0x274);const _0x185314=_0x482d65[_0xc2e4a9(0x256)]==_0xc2e4a9(0x25e)?0x1:0x2,_0x38a13a=await this[_0xc2e4a9(0x271)][_0xc2e4a9(0x249)]({'orderId':_0x482d65[_0xc2e4a9(0x29c)]},{'status':_0x185314,'paydAt':new Date()});_0x185314===0x1&&await this['userBalanceService'][_0xc2e4a9(0x231)](_0x30d375);if(_0x38a13a[_0xc2e4a9(0x265)]!=0x1)return _0xc2e4a9(0x274);return _0xc2e4a9(0x212);}async['payEpay'](_0xc6225a,_0x4b9898,_0x5a0b13=_0x1cd090(0x233)){const _0x50d8e0=_0x1cd090,_0x5df666=await this['orderEntity']['findOne']({'where':{'userId':_0xc6225a,'orderId':_0x4b9898}});if(!_0x5df666)throw new common_1['HttpException'](_0x50d8e0(0x205),common_1[_0x50d8e0(0x20a)][_0x50d8e0(0x284)]);const _0x232c11=await this[_0x50d8e0(0x211)][_0x50d8e0(0x213)]({'where':{'id':_0x5df666[_0x50d8e0(0x1e1)]}});if(!_0x232c11)throw new common_1[(_0x50d8e0(0x28a))](_0x50d8e0(0x20f),common_1[_0x50d8e0(0x20a)]['BAD_REQUEST']);const {payEpayPid:_0x52c32c,payEpaySecret:_0x1d6377,payEpayNotifyUrl:_0x1900eb,payEpayReturnUrl:_0x3203d7,payEpayApiPayUrl:_0x25b7d7}=await this['globalConfigService'][_0x50d8e0(0x26d)](['payEpayPid',_0x50d8e0(0x1d8),'payEpayNotifyUrl',_0x50d8e0(0x217),_0x50d8e0(0x1ce)]);let _0x32239b;_0x52c32c[_0x50d8e0(0x254)]<=0x10?_0x32239b=Number(_0x52c32c):_0x32239b=BigInt(_0x52c32c);const _0x5c5391={};_0x5c5391[_0x50d8e0(0x280)]=_0x32239b,_0x5c5391['type']=_0x5a0b13,_0x5c5391['out_trade_no']=_0x4b9898,_0x5c5391[_0x50d8e0(0x28c)]=_0x232c11[_0x50d8e0(0x28c)],_0x5c5391[_0x50d8e0(0x20e)]=_0x5df666['total'],_0x5c5391[_0x50d8e0(0x255)]=_0x50d8e0(0x23d),_0x5c5391['device']='pc',_0x5c5391['notify_url']=_0x1900eb,_0x5c5391[_0x50d8e0(0x206)]=_0x3203d7,_0x5c5391['param']=_0x50d8e0(0x23f),_0x5c5391[_0x50d8e0(0x1db)]=this[_0x50d8e0(0x1db)](_0x5c5391,_0x1d6377),_0x5c5391[_0x50d8e0(0x268)]=_0x50d8e0(0x286);const _0x4480a6=new URLSearchParams(_0x5c5391)['toString'](),_0x3ae97c=_0x25b7d7+'?'+_0x4480a6;if(_0x25b7d7[_0x50d8e0(0x1de)](_0x50d8e0(0x287)))return{'url_qrcode':null,'redirectUrl':_0x3ae97c,'channel':_0x5a0b13,'isRedirect':!![]};else{const _0x341ba1=await axios_1['default'][_0x50d8e0(0x227)](_0x25b7d7,{'params':_0x5c5391});console[_0x50d8e0(0x1f4)](_0x50d8e0(0x232),_0x341ba1[_0x50d8e0(0x250)]);const {data:{code:_0x53ee85,msg:_0x3eb3cc,qrcode:_0x2972d8}}=_0x341ba1;if(_0x53ee85!=0x1)throw new common_1[(_0x50d8e0(0x28a))](_0x3eb3cc,common_1['HttpStatus']['BAD_REQUEST']);return{'url_qrcode':_0x2972d8,'redirectUrl':null,'channel':_0x5a0b13,'isRedirect':![]};}}async[_0x1cd090(0x230)](_0xc32349){const _0x21b0c0=_0x1cd090,{payEpayPid:_0x3dfa91,payEpaySecret:_0x2e7973,payEpayApiQueryUrl:_0x21f50e}=await this[_0x21b0c0(0x1d9)]['getConfigs'](['payEpayPid',_0x21b0c0(0x1d8),_0x21b0c0(0x26b)]),_0x551b98={};_0x551b98['act']=_0x21b0c0(0x26a),_0x551b98[_0x21b0c0(0x29c)]=_0xc32349,_0x551b98[_0x21b0c0(0x280)]=_0x3dfa91,_0x551b98[_0x21b0c0(0x22e)]=_0x2e7973;const {data:{code:_0x5ace78,msg:_0x2c75e4,data:_0x32ebd3}}=await axios_1[_0x21b0c0(0x24e)]['get'](_0x21f50e,{'params':_0x551b98});if(_0x5ace78!=0x1)throw new common_1[(_0x21b0c0(0x28a))](_0x2c75e4,common_1['HttpStatus'][_0x21b0c0(0x284)]);return _0x32ebd3;}async[_0x1cd090(0x27e)](_0x1f07af){const _0x30a905=_0x1cd090,_0x56c399=_0x1f07af['sign'];delete _0x1f07af[_0x30a905(0x1db)],delete _0x1f07af['sign_type'];const _0x1a2d96=await this[_0x30a905(0x1d9)]['getConfigs']([_0x30a905(0x1f6)]);console['log'](_0x30a905(0x1ed));if(this[_0x30a905(0x1db)](_0x1f07af,_0x1a2d96)!=_0x56c399)return _0x30a905(0x274);console[_0x30a905(0x1f4)](_0x30a905(0x24d));const _0x38546c=await this['orderEntity'][_0x30a905(0x213)]({'where':{'orderId':_0x1f07af[_0x30a905(0x29c)],'status':0x0}});if(!_0x38546c)return'failed';const _0x37034c=_0x1f07af[_0x30a905(0x256)]==_0x30a905(0x25e)?0x1:0x2;console['log'](_0x30a905(0x242),_0x37034c);const _0x11bf02=await this[_0x30a905(0x271)]['update']({'orderId':_0x1f07af[_0x30a905(0x29c)]},{'status':_0x37034c,'paydAt':new Date()});_0x37034c===0x1&&await this[_0x30a905(0x1f0)][_0x30a905(0x231)](_0x38546c);if(_0x11bf02[_0x30a905(0x265)]!=0x1)return _0x30a905(0x274);return'success';}async['payMpay'](_0x141414,_0x1298fe,_0x19f1b0=_0x1cd090(0x20d)){const _0x51fe07=_0x1cd090,_0x3cdac8=await this[_0x51fe07(0x271)][_0x51fe07(0x213)]({'where':{'userId':_0x141414,'orderId':_0x1298fe}});if(!_0x3cdac8)throw new common_1[(_0x51fe07(0x28a))](_0x51fe07(0x205),common_1[_0x51fe07(0x20a)][_0x51fe07(0x284)]);const _0x5c042d=await this[_0x51fe07(0x211)]['findOne']({'where':{'id':_0x3cdac8['goodsId']}});if(!_0x5c042d)throw new common_1[(_0x51fe07(0x28a))](_0x51fe07(0x20f),common_1['HttpStatus'][_0x51fe07(0x284)]);const {payMpayPid:_0x138e8a,payMpaySecret:_0x5f4c86,payMpayNotifyUrl:_0x11a1c3,payMpayReturnUrl:_0x33b3c5,payMpayApiPayUrl:_0xfdd999}=await this['globalConfigService'][_0x51fe07(0x26d)]([_0x51fe07(0x220),_0x51fe07(0x1f6),_0x51fe07(0x1fe),_0x51fe07(0x1fd),_0x51fe07(0x29b)]),_0x3a153b={};_0x3a153b[_0x51fe07(0x280)]=Number(_0x138e8a),_0x3a153b[_0x51fe07(0x236)]=_0x19f1b0,_0x3a153b[_0x51fe07(0x29c)]=_0x1298fe,_0x3a153b[_0x51fe07(0x28c)]=_0x5c042d[_0x51fe07(0x28c)],_0x3a153b[_0x51fe07(0x20e)]=_0x3cdac8['total'],_0x3a153b['notify_url']=_0x11a1c3,_0x3a153b['return_url']=_0x33b3c5,_0x3a153b[_0x51fe07(0x1db)]=this[_0x51fe07(0x1db)](_0x3a153b,_0x5f4c86),_0x3a153b[_0x51fe07(0x268)]='MD5';const _0x3add5e=new URLSearchParams(_0x3a153b)['toString'](),_0x1b1299=_0xfdd999+'?'+_0x3add5e;return{'url_qrcode':null,'redirectUrl':_0x1b1299,'channel':_0x19f1b0,'isRedirect':!![]};}async[_0x1cd090(0x27b)](_0x56392a){const _0x344045=_0x1cd090,{payMpayApiQueryUrl:_0x14dde6}=await this[_0x344045(0x1d9)][_0x344045(0x26d)]([_0x344045(0x220),_0x344045(0x1f6),_0x344045(0x23b)]),_0x5927dc={};_0x5927dc[_0x344045(0x236)]=0x2,_0x5927dc['order_no']=_0x56392a;const {data:{code:_0x2bf400,msg:_0x2bd8f5,data:_0x2a8060}}=await axios_1['default'][_0x344045(0x227)](_0x14dde6,{'params':_0x5927dc});if(_0x2bf400!=0x1)throw new common_1[(_0x344045(0x28a))](_0x2bd8f5,common_1[_0x344045(0x20a)]['BAD_REQUEST']);return _0x2a8060;}async[_0x1cd090(0x229)](_0x302520){const _0x1d36c0=_0x1cd090;console[_0x1d36c0(0x1f4)](_0x1d36c0(0x278),_0x302520);const {payWeChatAppId:_0xf3a788,payWeChatMchId:_0x4ec7dc,payWeChatSecret:_0x34a46a,payWeChatPublicKey:_0x58b763,payWeChatPrivateKey:_0xd06346}=await this[_0x1d36c0(0x1d9)]['getConfigs']([_0x1d36c0(0x279),_0x1d36c0(0x238),_0x1d36c0(0x1f8),_0x1d36c0(0x27a),_0x1d36c0(0x21c)]),_0x397e05=new WxPay({'appid':_0xf3a788,'mchid':_0x4ec7dc,'publicKey':_0x58b763,'privateKey':_0xd06346});let _0x7fab3e;try{if(_0x302520[_0x1d36c0(0x219)]==_0x1d36c0(0x281)){const {ciphertext:_0xab278a,associated_data:_0x5ed32b,nonce:_0x2e2a8a}=_0x302520[_0x1d36c0(0x293)],_0x4e44a5=_0x397e05[_0x1d36c0(0x1d3)](_0xab278a,_0x5ed32b,_0x2e2a8a,_0x34a46a),_0x19e999=_0x4e44a5[_0x1d36c0(0x29c)];_0x7fab3e=redisKey_constant_1['PAY_UPDATE_ORDER']+_0x19e999,await this['redisCacheService']['set']({'key':_0x7fab3e,'val':_0x1d36c0(0x292)});const _0x42a9e7=await this[_0x1d36c0(0x271)]['findOne']({'where':{'orderId':_0x19e999,'status':0x0}});if(!_0x42a9e7)return _0x1d36c0(0x274);if([0x1,0x2,0x3][_0x1d36c0(0x1de)](_0x42a9e7[_0x1d36c0(0x21b)]))return _0x1d36c0(0x212);const _0x21e726=await this[_0x1d36c0(0x222)][_0x1d36c0(0x1dc)](async _0x46c929=>{const _0x2e50da=_0x1d36c0,_0x6ad895=_0x4e44a5[_0x2e50da(0x1df)]=='SUCCESS'?0x1:0x2,_0x23f3d7=await this[_0x2e50da(0x271)][_0x2e50da(0x249)]({'orderId':_0x19e999},{'status':_0x6ad895,'paydAt':new Date(),'tradeId':_0x4e44a5['transaction_id']});return _0x6ad895===0x1&&await this['userBalanceService'][_0x2e50da(0x231)](_0x42a9e7),_0x23f3d7;});if(_0x21e726[_0x1d36c0(0x265)]!=0x1)return _0x1d36c0(0x274);}return'success';}catch(_0x1a4897){return console[_0x1d36c0(0x1f4)]('error:\x20',_0x1a4897),console['log'](_0x1d36c0(0x201),_0x1a4897),_0x1d36c0(0x274);}finally{_0x7fab3e&&await this[_0x1d36c0(0x298)][_0x1d36c0(0x269)]({'key':_0x7fab3e});}}async[_0x1cd090(0x23c)](_0x780eb2,_0x27a7cb,_0x4014e1){const _0x2e5ab9=_0x1cd090,_0x45e3c6=await this[_0x2e5ab9(0x271)]['findOne']({'where':{'userId':_0x780eb2,'orderId':_0x27a7cb}});if(!_0x45e3c6)throw new common_1['HttpException'](_0x2e5ab9(0x205),common_1[_0x2e5ab9(0x20a)][_0x2e5ab9(0x284)]);const _0x28ad31=await this[_0x2e5ab9(0x211)][_0x2e5ab9(0x213)]({'where':{'id':_0x45e3c6[_0x2e5ab9(0x1e1)]}});if(!_0x28ad31)throw new common_1[(_0x2e5ab9(0x28a))](_0x2e5ab9(0x20f),common_1[_0x2e5ab9(0x20a)][_0x2e5ab9(0x284)]);const _0x574da9={'bizContent':{'out_trade_no':_0x27a7cb,'total_amount':_0x45e3c6[_0x2e5ab9(0x1f2)],'subject':_0x28ad31[_0x2e5ab9(0x28c)]}};let _0x4d9497,_0x2267fc,_0x5f012e,_0x355ed6,_0xaf9e60;const {payAliPublicSecret:_0x4d7888,payAliWebAppId:_0x2fd4f0,payAliWebSecret:_0x20e2c1,payAliAppAppId:_0x536024,payAliAppSecret:_0x23616f,payWeChatNotifyUrl:_0x2116b3}=await this[_0x2e5ab9(0x1d9)][_0x2e5ab9(0x26d)]([_0x2e5ab9(0x1dd),_0x2e5ab9(0x27f),'payAliWebSecret',_0x2e5ab9(0x23e),'payAliAppSecret',_0x2e5ab9(0x26e)]);_0x4014e1===_0x2e5ab9(0x239)&&(_0x574da9[_0x2e5ab9(0x270)]=_0x2e5ab9(0x262),_0x4d9497=_0x2fd4f0,_0x5f012e=_0x2e5ab9(0x1fc),_0x2267fc=_0x20e2c1,_0x355ed6='alipay.trade.page.pay',_0xaf9e60=_0x2e5ab9(0x1fb));_0x4014e1===_0x2e5ab9(0x260)&&(_0x5f012e=_0x2e5ab9(0x1fa),_0x4d9497=_0x536024,_0x2267fc=_0x23616f,_0x355ed6=_0x2e5ab9(0x218),_0xaf9e60='QUICK_MSECURITY_PAY');const _0x52fbd7=new AlipaySdk({'appId':_0x4d9497,'keyType':_0x2e5ab9(0x28f),'privateKey':_0x2267fc,'alipayPublicKey':_0x4d7888});_0x574da9[_0x2e5ab9(0x1ec)]=_0x2116b3,_0x574da9[_0x2e5ab9(0x295)][_0x2e5ab9(0x1e4)]=_0xaf9e60;const _0x5b01e1=await _0x52fbd7[_0x5f012e](_0x355ed6,_0x574da9);return console[_0x2e5ab9(0x1f4)](_0x2e5ab9(0x28e),_0x5b01e1),_0x4014e1===_0x2e5ab9(0x239)?{'form':_0x5b01e1}:{'data':_0x5b01e1};}async[_0x1cd090(0x21a)](_0xb74f3e,_0x2756c5){const _0x5ead33=_0x1cd090;let _0x5def71,_0x37f0a9;const {payAliPublicSecret:_0x498079,payAliWebAppId:_0x2f898d,payAliWebSecret:_0x22a07c,payAliAppAppId:_0x21f605,payAliAppSecret:_0x390e74,payWeChatNotifyUrl:_0x3a9524}=await this[_0x5ead33(0x1d9)][_0x5ead33(0x26d)]([_0x5ead33(0x1dd),'payAliWebAppId',_0x5ead33(0x202),_0x5ead33(0x23e),_0x5ead33(0x297),_0x5ead33(0x26e)]);_0x2756c5===_0x5ead33(0x239)&&(_0x5def71=_0x2f898d,_0x37f0a9=_0x22a07c);_0x2756c5===_0x5ead33(0x260)&&(_0x5def71=_0x21f605,_0x37f0a9=_0x390e74);const _0x58646e=new AlipaySdk({'appId':_0x5def71,'keyType':_0x5ead33(0x28f),'privateKey':_0x37f0a9,'alipayPublicKey':_0x498079}),_0x3b4896=await _0x58646e[_0x5ead33(0x25a)]('alipay.trade.query',{'bizContent':{'out_trade_no':_0xb74f3e}});return console[_0x5ead33(0x1f4)](_0x3b4896),_0x3b4896;}async[_0x1cd090(0x1e0)](_0x2d3c20,_0x4de818,_0x46dea7=_0x1cd090(0x239)){const _0x1b8789=_0x1cd090;console['log']('payType:\x20',_0x46dea7);const _0x5d98c8=await this[_0x1b8789(0x271)][_0x1b8789(0x213)]({'where':{'userId':_0x2d3c20,'orderId':_0x4de818}});if(!_0x5d98c8)throw new common_1[(_0x1b8789(0x28a))](_0x1b8789(0x205),common_1[_0x1b8789(0x20a)][_0x1b8789(0x284)]);const _0x4c350e=await this[_0x1b8789(0x211)]['findOne']({'where':{'id':_0x5d98c8['goodsId']}});if(!_0x4c350e)throw new common_1[(_0x1b8789(0x28a))](_0x1b8789(0x20f),common_1[_0x1b8789(0x20a)][_0x1b8789(0x284)]);const {payWeChatAppId:_0x108bd1,payWeMiniAppId:_0x4549c0,payWeChatMchId:_0x81020e,payWeChatPublicKey:_0x2bb449,payWeChatPrivateKey:_0x57b3da,payWeChatNotifyUrl:_0x2aa4fc,payWeChatH5Name:_0x48ece4,payWeChatH5Url:_0x1c512d,WE_APP_APPID:_0x45c0e5,WE_APP_APPSECRET:_0x30bb85}=await this[_0x1b8789(0x1d9)][_0x1b8789(0x26d)]([_0x1b8789(0x279),_0x1b8789(0x1e5),'payWeChatMchId',_0x1b8789(0x27a),_0x1b8789(0x21c),'payWeChatNotifyUrl',_0x1b8789(0x1ee),'payWeChatH5Url',_0x1b8789(0x1f1)]),_0x2053c7=new WxPay({'appid':_0x46dea7===_0x1b8789(0x288)?_0x4549c0:_0x108bd1,'mchid':_0x81020e,'publicKey':_0x2bb449,'privateKey':_0x57b3da}),_0x5cd709={'appid':_0x46dea7===_0x1b8789(0x288)?_0x4549c0:_0x108bd1,'mchid':_0x81020e,'description':_0x4c350e[_0x1b8789(0x28c)],'out_trade_no':_0x4de818,'notify_url':_0x2aa4fc,'amount':{'total':Number(_0x5d98c8[_0x1b8789(0x1f2)]*0x64)},'scene_info':{'payer_client_ip':_0x1b8789(0x23d)}};console[_0x1b8789(0x1f4)](_0x1b8789(0x296),_0x5cd709);if(_0x46dea7=='h5'){_0x5cd709[_0x1b8789(0x20c)][_0x1b8789(0x253)]={'type':'Wap','app_name':_0x48ece4,'app_url':_0x1c512d};const _0x448c9f=await _0x2053c7[_0x1b8789(0x261)](_0x5cd709);if(_0x448c9f['status']===0x193){const _0xd19586=_0x448c9f?.[_0x1b8789(0x266)]?.[_0x1b8789(0x1e2)]?.['text']?.['message'];throw new common_1[(_0x1b8789(0x28a))](_0x448c9f?.[_0x1b8789(0x248)]||_0x1b8789(0x272),common_1[_0x1b8789(0x20a)][_0x1b8789(0x284)]);}const {h5_url:_0x503690}=_0x448c9f;return{'url':_0x503690};}if(_0x46dea7===_0x1b8789(0x260)){_0x5cd709[_0x1b8789(0x22c)]=_0x45c0e5;const _0x31eb74=await _0x2053c7[_0x1b8789(0x243)](_0x5cd709);return console['log'](_0x1b8789(0x1e3),_0x31eb74),_0x31eb74;}if(_0x46dea7==_0x1b8789(0x288)){const _0x5c49e4=await this[_0x1b8789(0x1da)]['getMiniOpenIdByUserId'](_0x2d3c20);_0x5cd709[_0x1b8789(0x245)]={'openid':_0x5c49e4};const _0x54bfd8=await _0x2053c7['transactions_jsapi'](_0x5cd709);return console[_0x1b8789(0x1f4)](_0x1b8789(0x25c),_0x54bfd8),_0x54bfd8;}if(_0x46dea7==_0x1b8789(0x276)){const _0x151fbc=await this['userService'][_0x1b8789(0x21e)](_0x2d3c20);console[_0x1b8789(0x1f4)](_0x1b8789(0x25d),_0x151fbc),_0x5cd709[_0x1b8789(0x245)]={'openid':_0x151fbc};const _0x5afefa=await _0x2053c7['transactions_jsapi'](_0x5cd709);return console['log'](_0x1b8789(0x25c),_0x5afefa),_0x5afefa;}if(_0x46dea7=='native'){const _0x4bf5e2=await _0x2053c7['transactions_native'](_0x5cd709),{code_url:_0x58cc1a}=_0x4bf5e2;return!_0x58cc1a&&console[_0x1b8789(0x1f4)](_0x1b8789(0x247),_0x4bf5e2),{'url_qrcode':_0x58cc1a,'isRedirect':![]};}throw new common_1[(_0x1b8789(0x28a))](_0x1b8789(0x1d1),common_1[_0x1b8789(0x20a)][_0x1b8789(0x284)]);}async[_0x1cd090(0x1e8)](_0x5cd314,_0x214a3a){const _0x3f9dc4=_0x1cd090,{payWeChatAppId:_0x5c2e2b,payWeMiniAppId:_0x549a5a,payWeChatMchId:_0x320529,payWeChatPublicKey:_0x3b7a08,payWeChatPrivateKey:_0x3c71a3}=await this[_0x3f9dc4(0x1d9)][_0x3f9dc4(0x26d)]([_0x3f9dc4(0x279),'payWeMiniAppId',_0x3f9dc4(0x238),_0x3f9dc4(0x27a),_0x3f9dc4(0x21c)]),_0x21ffb3=new WxPay({'appid':_0x214a3a==='mini'?_0x549a5a:_0x5c2e2b,'mchid':_0x320529,'publicKey':_0x3b7a08,'privateKey':_0x3c71a3}),_0x4a5eec=await _0x21ffb3[_0x3f9dc4(0x294)]({'out_trade_no':_0x5cd314});return _0x4a5eec;}async[_0x1cd090(0x1d7)](_0x307beb){const _0xfb7d63=_0x1cd090;_0x307beb[_0xfb7d63(0x1f7)]===_0xfb7d63(0x1d2)&&await this[_0xfb7d63(0x228)](_0x307beb);}async[_0x1cd090(0x228)](_0x5db6e2){const _0x2cd213=_0x1cd090,{payWeChatAppId:_0x24b737,payWeMiniAppId:_0x3b34aa,payWeChatMchId:_0x52e496,payWeChatPublicKey:_0x3ca34b,payWeChatPrivateKey:_0x11431d}=await this[_0x2cd213(0x1d9)][_0x2cd213(0x26d)]([_0x2cd213(0x279),_0x2cd213(0x1e5),_0x2cd213(0x238),_0x2cd213(0x27a),'payWeChatPrivateKey',_0x2cd213(0x26e),'payWeChatH5Name','payWeChatH5Url']),_0xc406ab=new WxPay({'appid':_0x5db6e2['channel']===_0x2cd213(0x288)?_0x3b34aa:_0x24b737,'mchid':_0x52e496,'publicKey':_0x3ca34b,'privateKey':_0x11431d});await _0xc406ab[_0x2cd213(0x24c)](_0x5db6e2[_0x2cd213(0x240)]);}[_0x1cd090(0x1db)](_0x5dd48d,_0x3052a5){const _0x15f2be=_0x1cd090,_0x1925d1=Object[_0x15f2be(0x234)](_0x5dd48d)['sort']()[_0x15f2be(0x22d)](_0x1243e2=>_0x1243e2+'='+_0x5dd48d[_0x1243e2])['join']('&')+_0x3052a5;return crypto[_0x15f2be(0x225)]('md5')[_0x15f2be(0x249)](_0x1925d1)[_0x15f2be(0x285)]('hex');}};function _0x2dbe(){const _0x348601=['resource','query','bizContent','wechat-pay:\x20','payAliAppSecret','redisCacheService','../../common/constants/redisKey.constant','toFixed','payMpayApiPayUrl','out_trade_no','1.1','defineProperty','1256FAMpqc','../redisCache/redisCache.service','param','7990104rliGrI','payEpayApiPayUrl','payEpay','post','unsupported\x20pay\x20type','wechat','decipher_gcm','notifyEpay','Connection','alipay-sdk','cancel','payEpaySecret','globalConfigService','userService','sign','transaction','payAliPublicSecret','includes','trade_state','payWeChat','goodsId','response','App支付结果返回值:\x20','product_code','payWeMiniAppId','object','Repository','queryWeChat','crypto','out_trade_order','payHupiNotifyUrl','setNotifyUrl','校验签名','payWeChatH5Name','5zcHOdj','userBalanceService','WE_APP_APPID','total','../globalConfig/globalConfig.service','log','https://api.xunhupay.com/payment/do.html','payMpaySecret','payPlatform','payWeChatSecret','支付请求失败!','sdkExec','FAST_INSTANT_TRADE_PAY','pageExec','payMpayReturnUrl','payMpayNotifyUrl','axios','payHupiAppId','支付通知验证失败:\x20','payAliWebSecret','nonce_str','wechatpay-node-v3','订单不存在!','return_url','1153120IajKuQ','payHupiSecret','InjectRepository','HttpStatus','total_fee','scene_info','wxpay','money','套餐不存在!','now','cramiPackageEntity','success','findOne','15424hTjJAq','483xDoVvT','10yYLkqo','payEpayReturnUrl','alipay.trade.app.pay','event_type','queryAliPay','status','payWeChatPrivateKey','trade_order_id','getOpenIdByUserId','onModuleInit','payMpayPid','design:paramtypes','connection','decorate','1530702kOkHPx','createHash','payMpay','get','cancelWxOrder','notifyWeChat','__metadata','22JMCgqY','appid','map','key','payHupiGatewayUrl','queryEpay','addBalanceToOrder','epay\x20--->\x20res:\x20','alipay','keys','queryHupi','type','hash','payWeChatMchId','native','__esModule','payMpayApiQueryUrl','payAli','192.168.1.100','payAliAppAppId','epay','orderId','hupi','status:\x20','transactions_app','function','payer','../../common/utils','wx-native','message','update','../order/order.entity','../user/user.service','close','校验签名通过','default','Injectable','data','4348251CCxVde','../userBalance/userBalance.service','h5_info','length','clientip','trade_status','支付请求失败:\x20','createRandomNonceStr','notify','exec','https://api.xunhupay.com/payment/query.html','jsapi支付结果返回值:\x20','用户openId:\x20','TRADE_SUCCESS','@nestjs/typeorm','app','transactions_h5','POST','attach','payHupi','affected','errRaw','25hGmlIJ','sign_type','del','order','payEpayApiQueryUrl','getOwnPropertyDescriptor','getConfigs','payWeChatNotifyUrl','version','method','orderEntity','微信H5支付失败！','PayService','failed','UserBalanceService','jsapi','time','微信支付通知params:\x20','payWeChatAppId','payWeChatPublicKey','queryMpay','metadata','1312266lvqdot','notifyMpay','payAliWebAppId','pid','TRANSACTION.SUCCESS','RedisCacheService','typeorm','BAD_REQUEST','digest','MD5','submit.php','mini','pay','HttpException','本次支付类型:\x20','name','notifyHupi','alipay\x20result:\x20','PKCS1','__decorate','payHupiReturnUrl','lock'];_0x2dbe=function(){return _0x348601;};return _0x2dbe();}PayService=__decorate([(0x0,common_1[_0x1cd090(0x24f)])(),__param(0x0,(0x0,typeorm_1[_0x1cd090(0x209)])(cramiPackage_entity_1['CramiPackageEntity'])),__param(0x1,(0x0,typeorm_1[_0x1cd090(0x209)])(order_entity_1['OrderEntity'])),__metadata(_0x1cd090(0x221),[typeorm_2[_0x1cd090(0x1e7)],typeorm_2[_0x1cd090(0x1e7)],userBalance_service_1[_0x1cd090(0x275)],globalConfig_service_1['GlobalConfigService'],user_service_1['UserService'],redisCache_service_1[_0x1cd090(0x282)],typeorm_2[_0x1cd090(0x1d5)]])],PayService),exports['PayService']=PayService;