'use strict';const _0x39fbfd=_0x233c;(function(_0x39a17d,_0x52c3cd){const _0x228f63=_0x233c,_0x3f543c=_0x39a17d();while(!![]){try{const _0x2c87c2=-parseInt(_0x228f63(0x158))/0x1+-parseInt(_0x228f63(0x11b))/0x2*(-parseInt(_0x228f63(0x116))/0x3)+parseInt(_0x228f63(0x16a))/0x4*(-parseInt(_0x228f63(0x11d))/0x5)+parseInt(_0x228f63(0x14d))/0x6*(-parseInt(_0x228f63(0x12d))/0x7)+parseInt(_0x228f63(0x142))/0x8+parseInt(_0x228f63(0x17d))/0x9*(-parseInt(_0x228f63(0x115))/0xa)+parseInt(_0x228f63(0x133))/0xb;if(_0x2c87c2===_0x52c3cd)break;else _0x3f543c['push'](_0x3f543c['shift']());}catch(_0x31d854){_0x3f543c['push'](_0x3f543c['shift']());}}}(_0x12eb,0xd73df));var __decorate=this&&this[_0x39fbfd(0x113)]||function(_0x42b024,_0xe90200,_0x1394f3,_0x19b2e0){const _0x29ecdf=_0x39fbfd;var _0x1b7f3b=arguments[_0x29ecdf(0x110)],_0xe76222=_0x1b7f3b<0x3?_0xe90200:_0x19b2e0===null?_0x19b2e0=Object[_0x29ecdf(0x178)](_0xe90200,_0x1394f3):_0x19b2e0,_0xbb8014;if(typeof Reflect==='object'&&typeof Reflect[_0x29ecdf(0x17b)]===_0x29ecdf(0x146))_0xe76222=Reflect[_0x29ecdf(0x17b)](_0x42b024,_0xe90200,_0x1394f3,_0x19b2e0);else{for(var _0x28a458=_0x42b024[_0x29ecdf(0x110)]-0x1;_0x28a458>=0x0;_0x28a458--)if(_0xbb8014=_0x42b024[_0x28a458])_0xe76222=(_0x1b7f3b<0x3?_0xbb8014(_0xe76222):_0x1b7f3b>0x3?_0xbb8014(_0xe90200,_0x1394f3,_0xe76222):_0xbb8014(_0xe90200,_0x1394f3))||_0xe76222;}return _0x1b7f3b>0x3&&_0xe76222&&Object[_0x29ecdf(0x151)](_0xe90200,_0x1394f3,_0xe76222),_0xe76222;},__metadata=this&&this[_0x39fbfd(0x18e)]||function(_0x15e441,_0x25e5b5){const _0x3af6e7=_0x39fbfd;if(typeof Reflect===_0x3af6e7(0xfd)&&typeof Reflect[_0x3af6e7(0x192)]===_0x3af6e7(0x146))return Reflect[_0x3af6e7(0x192)](_0x15e441,_0x25e5b5);},__param=this&&this[_0x39fbfd(0x144)]||function(_0x395e5e,_0x3c63ef){return function(_0x170400,_0x3fa579){_0x3c63ef(_0x170400,_0x3fa579,_0x395e5e);};};function _0x233c(_0x4db840,_0x297409){const _0x12eb29=_0x12eb();return _0x233c=function(_0x233c50,_0x26471a){_0x233c50=_0x233c50-0xf2;let _0x4839cc=_0x12eb29[_0x233c50];return _0x4839cc;},_0x233c(_0x4db840,_0x297409);}function _0x12eb(){const _0x2f45b8=['微信H5支付失败！','includes','createRandomNonceStr','__metadata','用户openId:\x20','SUCCESS','default','metadata','scene_info','cramiPackageEntity','payWeChatNotifyUrl','time','payer','queryWeChat','order','affected','trade_state','act','goodsId','订单不存在!','nonce_str','attach','MD5','return_url','total','本次支付类型:\x20','wxpay','payHupiGatewayUrl','object','payMpaySecret','getOpenIdByUserId','notifyEpay','GlobalConfigService','@nestjs/typeorm','findOne','digest','md5','支付请求失败!','payWeChatPublicKey','notify','unsupported\x20pay\x20type','payMpayPid','payPlatform','TRANSACTION.SUCCESS','join','payEpaySecret','notify_url','length','1.1','globalConfigService','__decorate','https://api.xunhupay.com/payment/query.html','2236420kVaubl','33aGSeVM','error:\x20','getConfigs','device','decipher_gcm','2062uVZUIt','../globalConfig/globalConfig.service','4280mJkxls','data','notifyHupi','userBalanceService','../crami/cramiPackage.entity','payHupi','套餐不存在!','BAD_REQUEST','Wap','payEpayApiQueryUrl','event_type','payMpayApiQueryUrl','sign','payEpay','hupi','payWeChatMchId','7805dOHTEZ','success','log','status','type','out_trade_no','30013698RAjkVH','payWeChat','native','TRADE_SUCCESS','name','sign_type','192.168.1.100','mpay','jsapi','addBalanceToOrder','payWeChatAppId','toFixed','get','update','out_trade_order','13919984qsvWaK','WxPay','__param','__esModule','function','payType:\x20','InjectRepository','wechat-pay:\x20','../../common/utils','payEpayApiPayUrl','toString','9078QgdTDY','map','onModuleInit','微信支付通知params:\x20','defineProperty','payHupiSecret','payHupiNotifyUrl','errRaw','createHash','HttpStatus','failed','858529suyDet','../user/user.service','payWeChatPrivateKey','queryHupi','UserBalanceService','hash','key','money','wx-native','payMpayReturnUrl','epay','title','HttpException','payEpayPid','trade_status','trade_order_id','支付通知验证失败:\x20','hex','1784BMWHKb','payMpayApiPayUrl','notifyWeChat','param','notifyMpay','支付请求失败:\x20','payWeChatH5Name','PayService','Repository','h5_info','payHupiAppId','appid','CramiPackageEntity','now','getOwnPropertyDescriptor','crypto','payEpayNotifyUrl','decorate','epay\x20--->\x20res:\x20','27MLsymH','typeorm','@nestjs/common','payWeChatSecret','校验签名通过','transactions_native','submit.php','Injectable','queryEpay','userService','resource','version','transactions_h5','orderEntity'];_0x12eb=function(){return _0x2f45b8;};return _0x12eb();}Object[_0x39fbfd(0x151)](exports,_0x39fbfd(0x145),{'value':!![]}),exports[_0x39fbfd(0x171)]=void 0x0;const typeorm_1=require(_0x39fbfd(0x102)),typeorm_2=require(_0x39fbfd(0x17e)),common_1=require(_0x39fbfd(0x17f)),crypto=require(_0x39fbfd(0x179)),axios_1=require('axios'),order_entity_1=require('../order/order.entity'),cramiPackage_entity_1=require(_0x39fbfd(0x121)),userBalance_service_1=require('../userBalance/userBalance.service'),globalConfig_service_1=require(_0x39fbfd(0x11c)),utils_1=require(_0x39fbfd(0x14a)),user_service_1=require(_0x39fbfd(0x159));let PayService=class PayService{constructor(_0x48bcf5,_0xad4ca2,_0x691c59,_0x503cf4,_0x4e06b2){const _0x5424a0=_0x39fbfd;this[_0x5424a0(0x194)]=_0x48bcf5,this[_0x5424a0(0x18a)]=_0xad4ca2,this[_0x5424a0(0x120)]=_0x691c59,this[_0x5424a0(0x112)]=_0x503cf4,this['userService']=_0x4e06b2;}async[_0x39fbfd(0x14f)](){const _0x3e19b4=_0x39fbfd,_0x2ebbe6=await(0x0,utils_1['importDynamic'])('wechatpay-node-v3');this[_0x3e19b4(0x143)]=(_0x2ebbe6===null||_0x2ebbe6===void 0x0?void 0x0:_0x2ebbe6[_0x3e19b4(0x191)])?_0x2ebbe6[_0x3e19b4(0x191)]:_0x2ebbe6;}async[_0x39fbfd(0x108)](_0x247fbf){const _0x31766d=_0x39fbfd;if(_0x247fbf[_0x31766d(0x16d)]=='epay')return this[_0x31766d(0x100)](_0x247fbf);if(_0x247fbf['attach']==_0x31766d(0x12b))return this[_0x31766d(0x11f)](_0x247fbf);if(typeof _0x247fbf[_0x31766d(0x187)]==_0x31766d(0xfd))return this[_0x31766d(0x16c)](_0x247fbf);return this[_0x31766d(0x16e)](_0x247fbf);}async['pay'](_0x4af2e8,_0x1e8850,_0x2d9d18=_0x39fbfd(0xfb)){const _0x3938a2=_0x39fbfd,_0x2cb588=await this[_0x3938a2(0x18a)][_0x3938a2(0x103)]({'where':{'userId':_0x4af2e8,'orderId':_0x1e8850}});if(!_0x2cb588)throw new common_1[(_0x3938a2(0x164))](_0x3938a2(0xf4),common_1['HttpStatus'][_0x3938a2(0x124)]);const _0x4063d8=await this[_0x3938a2(0x194)][_0x3938a2(0x103)]({'where':{'id':_0x2cb588[_0x3938a2(0xf3)]}});if(!_0x4063d8)throw new common_1[(_0x3938a2(0x164))](_0x3938a2(0x123),common_1[_0x3938a2(0x156)]['BAD_REQUEST']);console['log'](_0x3938a2(0xfa),_0x2cb588[_0x3938a2(0x10b)]);try{if(_0x2cb588[_0x3938a2(0x10b)]=='wechat')return this[_0x3938a2(0x134)](_0x4af2e8,_0x1e8850,_0x2d9d18);if(_0x2cb588['payPlatform']==_0x3938a2(0x162))return this[_0x3938a2(0x12a)](_0x4af2e8,_0x1e8850,_0x2d9d18);if(_0x2cb588[_0x3938a2(0x10b)]==_0x3938a2(0x13a))return this['payMpay'](_0x4af2e8,_0x1e8850,_0x2d9d18);if(_0x2cb588[_0x3938a2(0x10b)]==_0x3938a2(0x12b))return this[_0x3938a2(0x122)](_0x4af2e8,_0x1e8850,_0x2d9d18);}catch(_0x4a3d38){console[_0x3938a2(0x12f)](_0x3938a2(0x16f),_0x4a3d38);throw new common_1[(_0x3938a2(0x164))](_0x3938a2(0x106),common_1[_0x3938a2(0x156)]['BAD_REQUEST']);}}async['query'](_0x39887c){const _0x2a79f7=_0x39fbfd,_0x587695=await this[_0x2a79f7(0x18a)][_0x2a79f7(0x103)]({'where':{'orderId':_0x39887c}});if(!_0x587695)throw new common_1[(_0x2a79f7(0x164))](_0x2a79f7(0xf4),common_1[_0x2a79f7(0x156)]['BAD_REQUEST']);return _0x587695;}async['notifyHupi'](_0x429336){const _0x28a8d9=_0x39fbfd,_0x69186e=await this['globalConfigService'][_0x28a8d9(0x118)](['payHupiSecret']),_0x41651d=_0x429336[_0x28a8d9(0x15d)];delete _0x429336['hash'];if(this[_0x28a8d9(0x129)](_0x429336,_0x69186e)!=_0x41651d)return _0x28a8d9(0x157);const _0x4dfd0a=await this['orderEntity'][_0x28a8d9(0x103)]({'where':{'orderId':_0x429336[_0x28a8d9(0x167)],'status':0x0}});if(!_0x4dfd0a)return _0x28a8d9(0x157);await this['userBalanceService']['addBalanceToOrder'](_0x4dfd0a);const _0xe13212=await this[_0x28a8d9(0x18a)]['update']({'orderId':_0x429336[_0x28a8d9(0x167)]},{'status':0x1,'paydAt':new Date()});if(_0xe13212[_0x28a8d9(0x19a)]!=0x1)return _0x28a8d9(0x157);return'success';}async[_0x39fbfd(0x122)](_0x386f2d,_0x2e55c2,_0x876537='wxpay'){const _0x595bf1=_0x39fbfd,_0x4efe94=await this[_0x595bf1(0x18a)][_0x595bf1(0x103)]({'where':{'userId':_0x386f2d,'orderId':_0x2e55c2}});if(!_0x4efe94)throw new common_1[(_0x595bf1(0x164))](_0x595bf1(0xf4),common_1[_0x595bf1(0x156)][_0x595bf1(0x124)]);const _0x3d6ae0=await this[_0x595bf1(0x194)]['findOne']({'where':{'id':_0x4efe94[_0x595bf1(0xf3)]}});if(!_0x3d6ae0)throw new common_1[(_0x595bf1(0x164))](_0x595bf1(0x123),common_1[_0x595bf1(0x156)][_0x595bf1(0x124)]);const {payHupiAppId:_0x1fdf5a,payHupiSecret:_0x1fbd9d,payHupiNotifyUrl:_0x55d284,payHupiReturnUrl:_0x98cfc7,payHupiGatewayUrl:_0x39a13a}=await this[_0x595bf1(0x112)]['getConfigs']([_0x595bf1(0x174),_0x595bf1(0x152),_0x595bf1(0x153),'payHupiReturnUrl',_0x595bf1(0xfc)]),_0x28cfe4={};_0x28cfe4[_0x595bf1(0x188)]='1.1',_0x28cfe4[_0x595bf1(0x175)]=_0x1fdf5a,_0x28cfe4[_0x595bf1(0x196)]=(Date['now']()/0x3e8)[_0x595bf1(0x13e)](0x0),_0x28cfe4[_0x595bf1(0xf5)]=(0x0,utils_1['createRandomNonceStr'])(0x20),_0x28cfe4[_0x595bf1(0x167)]=_0x2e55c2,_0x28cfe4[_0x595bf1(0x163)]=_0x3d6ae0['name'],_0x28cfe4['total_fee']=_0x4efe94[_0x595bf1(0xf9)],_0x28cfe4[_0x595bf1(0x10f)]=_0x55d284,_0x28cfe4['return_url']=_0x98cfc7,_0x28cfe4[_0x595bf1(0xf6)]=_0x595bf1(0x12b),_0x28cfe4[_0x595bf1(0x15d)]=this[_0x595bf1(0x129)](_0x28cfe4,_0x1fbd9d);const {data:{errcode:_0x2b34f9,errmsg:_0x1975a9,url_qrcode:_0x485e8e,url:_0x5c9893}}=await axios_1['default']['post'](_0x39a13a||'https://api.xunhupay.com/payment/do.html',_0x28cfe4);if(_0x2b34f9!=0x0)throw new common_1[(_0x595bf1(0x164))](_0x1975a9,common_1['HttpStatus']['BAD_REQUEST']);return{'url_qrcode':_0x485e8e,'url':_0x5c9893};}async[_0x39fbfd(0x15b)](_0x24d292){const _0x576db4=_0x39fbfd,{payHupiAppId:_0xe2f57,payHupiSecret:_0x18ac60}=await this[_0x576db4(0x112)]['getConfigs']([_0x576db4(0x174),_0x576db4(0x152)]),_0x23b556={};_0x23b556[_0x576db4(0x188)]=_0x576db4(0x111),_0x23b556[_0x576db4(0x175)]=_0xe2f57,_0x23b556[_0x576db4(0x196)]=(Date[_0x576db4(0x177)]()/0x3e8)[_0x576db4(0x13e)](0x0),_0x23b556[_0x576db4(0xf5)]=(0x0,utils_1[_0x576db4(0x18d)])(0x20),_0x23b556[_0x576db4(0x141)]=_0x24d292,_0x23b556[_0x576db4(0x15d)]=this[_0x576db4(0x129)](_0x23b556,_0x18ac60);const {data:{errcode:_0x4cdce9,errmsg:_0x1c1c0b,data:_0x2afd27}}=await axios_1[_0x576db4(0x191)]['post'](_0x576db4(0x114),_0x23b556);if(_0x4cdce9!=0x0)throw new common_1[(_0x576db4(0x164))](_0x1c1c0b,common_1[_0x576db4(0x156)][_0x576db4(0x124)]);return _0x2afd27;}async[_0x39fbfd(0x100)](_0x262329){const _0x781588=_0x39fbfd,_0x4f3d33=_0x262329[_0x781588(0x129)];delete _0x262329[_0x781588(0x129)],delete _0x262329[_0x781588(0x138)];const _0x43869f=await this[_0x781588(0x112)][_0x781588(0x118)](['payEpaySecret']);if(this[_0x781588(0x129)](_0x262329,_0x43869f)!=_0x4f3d33)return'failed';console['log'](_0x781588(0x181));const _0x4a488b=await this[_0x781588(0x18a)][_0x781588(0x103)]({'where':{'orderId':_0x262329['out_trade_no'],'status':0x0}});if(!_0x4a488b)return _0x781588(0x157);const _0x26c739=_0x262329[_0x781588(0x166)]==_0x781588(0x136)?0x1:0x2,_0x322dc6=await this[_0x781588(0x18a)][_0x781588(0x140)]({'orderId':_0x262329[_0x781588(0x132)]},{'status':_0x26c739,'paydAt':new Date()});_0x26c739===0x1&&await this[_0x781588(0x120)][_0x781588(0x13c)](_0x4a488b);if(_0x322dc6[_0x781588(0x19a)]!=0x1)return _0x781588(0x157);return _0x781588(0x12e);}async[_0x39fbfd(0x12a)](_0xe61393,_0x2c4a0f,_0x3b52a7='alipay'){const _0x359711=_0x39fbfd,_0x21c02b=await this[_0x359711(0x18a)][_0x359711(0x103)]({'where':{'userId':_0xe61393,'orderId':_0x2c4a0f}});if(!_0x21c02b)throw new common_1['HttpException'](_0x359711(0xf4),common_1[_0x359711(0x156)][_0x359711(0x124)]);const _0x41a564=await this[_0x359711(0x194)][_0x359711(0x103)]({'where':{'id':_0x21c02b[_0x359711(0xf3)]}});if(!_0x41a564)throw new common_1[(_0x359711(0x164))]('套餐不存在!',common_1[_0x359711(0x156)][_0x359711(0x124)]);const {payEpayPid:_0x53b114,payEpaySecret:_0x138e93,payEpayNotifyUrl:_0x1a5da7,payEpayReturnUrl:_0x4e2299,payEpayApiPayUrl:_0x404bd3}=await this[_0x359711(0x112)][_0x359711(0x118)]([_0x359711(0x165),_0x359711(0x10e),_0x359711(0x17a),'payEpayReturnUrl',_0x359711(0x14b)]);let _0x2433ed;_0x53b114['length']<=0x10?_0x2433ed=Number(_0x53b114):_0x2433ed=BigInt(_0x53b114);const _0x485940={};_0x485940['pid']=_0x2433ed,_0x485940[_0x359711(0x131)]=_0x3b52a7,_0x485940['out_trade_no']=_0x2c4a0f,_0x485940[_0x359711(0x137)]=_0x41a564[_0x359711(0x137)],_0x485940['money']=_0x21c02b[_0x359711(0xf9)],_0x485940['clientip']=_0x359711(0x139),_0x485940[_0x359711(0x119)]='pc',_0x485940[_0x359711(0x10f)]=_0x1a5da7,_0x485940[_0x359711(0xf8)]=_0x4e2299,_0x485940[_0x359711(0x16d)]=_0x359711(0x162),_0x485940[_0x359711(0x129)]=this[_0x359711(0x129)](_0x485940,_0x138e93),_0x485940[_0x359711(0x138)]=_0x359711(0xf7);const _0xd7f1b5=new URLSearchParams(_0x485940)[_0x359711(0x14c)](),_0x3df184=_0x404bd3+'?'+_0xd7f1b5;if(_0x404bd3[_0x359711(0x18c)](_0x359711(0x183)))return{'url_qrcode':null,'redirectUrl':_0x3df184,'channel':_0x3b52a7,'isRedirect':!![]};else{const _0x18d428=await axios_1['default'][_0x359711(0x13f)](_0x404bd3,{'params':_0x485940});console['log'](_0x359711(0x17c),_0x18d428[_0x359711(0x11e)]);const {data:{code:_0x2a9b29,msg:_0x2138f8,qrcode:_0x4451b3}}=_0x18d428;if(_0x2a9b29!=0x1)throw new common_1[(_0x359711(0x164))](_0x2138f8,common_1[_0x359711(0x156)]['BAD_REQUEST']);return{'url_qrcode':_0x4451b3,'redirectUrl':null,'channel':_0x3b52a7,'isRedirect':![]};}}async[_0x39fbfd(0x185)](_0x11d662){const _0xec21df=_0x39fbfd,{payEpayPid:_0xdf017,payEpaySecret:_0x2a8f79,payEpayApiQueryUrl:_0x364c11}=await this[_0xec21df(0x112)][_0xec21df(0x118)](['payEpayPid',_0xec21df(0x10e),_0xec21df(0x126)]),_0xc0fab1={};_0xc0fab1[_0xec21df(0xf2)]=_0xec21df(0x199),_0xc0fab1[_0xec21df(0x132)]=_0x11d662,_0xc0fab1['pid']=_0xdf017,_0xc0fab1[_0xec21df(0x15e)]=_0x2a8f79;const {data:{code:_0x137705,msg:_0x2656ce,data:_0xd29b4e}}=await axios_1[_0xec21df(0x191)][_0xec21df(0x13f)](_0x364c11,{'params':_0xc0fab1});if(_0x137705!=0x1)throw new common_1[(_0xec21df(0x164))](_0x2656ce,common_1['HttpStatus'][_0xec21df(0x124)]);return _0xd29b4e;}async[_0x39fbfd(0x16e)](_0x326897){const _0x5d0355=_0x39fbfd,_0x5d37b0=_0x326897[_0x5d0355(0x129)];delete _0x326897[_0x5d0355(0x129)],delete _0x326897[_0x5d0355(0x138)];const _0x155041=await this['globalConfigService'][_0x5d0355(0x118)]([_0x5d0355(0xfe)]);console['log']('校验签名');if(this[_0x5d0355(0x129)](_0x326897,_0x155041)!=_0x5d37b0)return _0x5d0355(0x157);console[_0x5d0355(0x12f)](_0x5d0355(0x181));const _0x419b8a=await this[_0x5d0355(0x18a)]['findOne']({'where':{'orderId':_0x326897[_0x5d0355(0x132)],'status':0x0}});if(!_0x419b8a)return _0x5d0355(0x157);const _0x475b0b=_0x326897[_0x5d0355(0x166)]==_0x5d0355(0x136)?0x1:0x2;console[_0x5d0355(0x12f)]('status:\x20',_0x475b0b);const _0x468dd6=await this[_0x5d0355(0x18a)]['update']({'orderId':_0x326897[_0x5d0355(0x132)]},{'status':_0x475b0b,'paydAt':new Date()});_0x475b0b===0x1&&await this[_0x5d0355(0x120)]['addBalanceToOrder'](_0x419b8a);if(_0x468dd6[_0x5d0355(0x19a)]!=0x1)return'failed';return _0x5d0355(0x12e);}async['payMpay'](_0x5b7ff3,_0x2f1add,_0x3849a8=_0x39fbfd(0xfb)){const _0x20181a=_0x39fbfd,_0x5a5467=await this[_0x20181a(0x18a)][_0x20181a(0x103)]({'where':{'userId':_0x5b7ff3,'orderId':_0x2f1add}});if(!_0x5a5467)throw new common_1[(_0x20181a(0x164))]('订单不存在!',common_1['HttpStatus'][_0x20181a(0x124)]);const _0x591e5f=await this['cramiPackageEntity']['findOne']({'where':{'id':_0x5a5467[_0x20181a(0xf3)]}});if(!_0x591e5f)throw new common_1['HttpException'](_0x20181a(0x123),common_1[_0x20181a(0x156)][_0x20181a(0x124)]);const {payMpayPid:_0x2dac63,payMpaySecret:_0x538434,payMpayNotifyUrl:_0xac97e6,payMpayReturnUrl:_0x4878e3,payMpayApiPayUrl:_0x153961}=await this[_0x20181a(0x112)]['getConfigs']([_0x20181a(0x10a),_0x20181a(0xfe),'payMpayNotifyUrl',_0x20181a(0x161),_0x20181a(0x16b)]),_0x329b9f={};_0x329b9f['pid']=Number(_0x2dac63),_0x329b9f['type']=_0x3849a8,_0x329b9f[_0x20181a(0x132)]=_0x2f1add,_0x329b9f[_0x20181a(0x137)]=_0x591e5f['name'],_0x329b9f[_0x20181a(0x15f)]=_0x5a5467['total'],_0x329b9f[_0x20181a(0x10f)]=_0xac97e6,_0x329b9f['return_url']=_0x4878e3,_0x329b9f[_0x20181a(0x129)]=this[_0x20181a(0x129)](_0x329b9f,_0x538434),_0x329b9f[_0x20181a(0x138)]=_0x20181a(0xf7);const _0x5b554c=new URLSearchParams(_0x329b9f)[_0x20181a(0x14c)](),_0x54f6d2=_0x153961+'?'+_0x5b554c;return{'url_qrcode':null,'redirectUrl':_0x54f6d2,'channel':_0x3849a8,'isRedirect':!![]};const _0x56e50d=await axios_1[_0x20181a(0x191)][_0x20181a(0x13f)](_0x153961,{'params':_0x329b9f});}async['queryMpay'](_0x3262b6){const _0x42bc0c=_0x39fbfd,{payMpayApiQueryUrl:_0x2d21cc}=await this['globalConfigService'][_0x42bc0c(0x118)](['payMpayPid',_0x42bc0c(0xfe),_0x42bc0c(0x128)]),_0x51d888={};_0x51d888[_0x42bc0c(0x131)]=0x2,_0x51d888['order_no']=_0x3262b6;const {data:{code:_0x6514cb,msg:_0x241c2a,data:_0x47ad45}}=await axios_1[_0x42bc0c(0x191)]['get'](_0x2d21cc,{'params':_0x51d888});if(_0x6514cb!=0x1)throw new common_1[(_0x42bc0c(0x164))](_0x241c2a,common_1['HttpStatus']['BAD_REQUEST']);return _0x47ad45;}async[_0x39fbfd(0x16c)](_0x571832){const _0x5bd5c8=_0x39fbfd;console['log'](_0x5bd5c8(0x150),_0x571832);const {payWeChatAppId:_0x1d0081,payWeChatMchId:_0x165096,payWeChatSecret:_0xe3275,payWeChatPublicKey:_0x1b3832,payWeChatPrivateKey:_0x8bbc41}=await this[_0x5bd5c8(0x112)][_0x5bd5c8(0x118)](['payWeChatAppId',_0x5bd5c8(0x12c),_0x5bd5c8(0x180),'payWeChatPublicKey',_0x5bd5c8(0x15a)]),_0x51c65f=new this[(_0x5bd5c8(0x143))]({'appid':_0x1d0081,'mchid':_0x165096,'publicKey':_0x1b3832,'privateKey':_0x8bbc41});try{if(_0x571832[_0x5bd5c8(0x127)]==_0x5bd5c8(0x10c)){const {ciphertext:_0x31a894,associated_data:_0x44ef3a,nonce:_0x5c4312}=_0x571832['resource'],_0x577246=_0x51c65f[_0x5bd5c8(0x11a)](_0x31a894,_0x44ef3a,_0x5c4312,_0xe3275),_0x5e466c=await this[_0x5bd5c8(0x18a)][_0x5bd5c8(0x103)]({'where':{'orderId':_0x577246[_0x5bd5c8(0x132)],'status':0x0}});if(!_0x5e466c)return _0x5bd5c8(0x157);const _0x2c862a=_0x577246[_0x5bd5c8(0x19b)]==_0x5bd5c8(0x190)?0x1:0x2,_0x1027da=await this[_0x5bd5c8(0x18a)][_0x5bd5c8(0x140)]({'orderId':_0x577246[_0x5bd5c8(0x132)]},{'status':_0x2c862a,'paydAt':new Date()});_0x2c862a===0x1&&await this[_0x5bd5c8(0x120)][_0x5bd5c8(0x13c)](_0x5e466c);if(_0x1027da[_0x5bd5c8(0x19a)]!=0x1)return _0x5bd5c8(0x157);}return _0x5bd5c8(0x12e);}catch(_0x3752f4){return console['log'](_0x5bd5c8(0x117),_0x3752f4),console[_0x5bd5c8(0x12f)](_0x5bd5c8(0x168),_0x3752f4),_0x5bd5c8(0x157);}}async[_0x39fbfd(0x134)](_0x18c19d,_0x352242,_0xcf6bf1=_0x39fbfd(0x135)){const _0x4cb7f9=_0x39fbfd;var _0x428a6a,_0xe8c04a,_0x2a0a37;console[_0x4cb7f9(0x12f)](_0x4cb7f9(0x147),_0xcf6bf1);const _0x49a49a=await this[_0x4cb7f9(0x18a)][_0x4cb7f9(0x103)]({'where':{'userId':_0x18c19d,'orderId':_0x352242}});if(!_0x49a49a)throw new common_1[(_0x4cb7f9(0x164))]('订单不存在!',common_1[_0x4cb7f9(0x156)][_0x4cb7f9(0x124)]);const _0x39a74b=await this[_0x4cb7f9(0x194)]['findOne']({'where':{'id':_0x49a49a[_0x4cb7f9(0xf3)]}});if(!_0x39a74b)throw new common_1['HttpException'](_0x4cb7f9(0x123),common_1[_0x4cb7f9(0x156)]['BAD_REQUEST']);const {payWeChatAppId:_0x59873e,payWeChatMchId:_0x352a53,payWeChatPublicKey:_0xb006ee,payWeChatPrivateKey:_0x221914,payWeChatNotifyUrl:_0x3f1a11,payWeChatH5Name:_0x35b089,payWeChatH5Url:_0x48688f}=await this[_0x4cb7f9(0x112)]['getConfigs']([_0x4cb7f9(0x13d),_0x4cb7f9(0x12c),'payWeChatPublicKey',_0x4cb7f9(0x15a),_0x4cb7f9(0x195),_0x4cb7f9(0x170),'payWeChatH5Url']),_0x1a7e07=new this['WxPay']({'appid':_0x59873e,'mchid':_0x352a53,'publicKey':_0xb006ee,'privateKey':_0x221914}),_0x44ffad={'appid':_0x59873e,'mchid':_0x352a53,'description':_0x39a74b[_0x4cb7f9(0x137)],'out_trade_no':_0x352242,'notify_url':_0x3f1a11,'amount':{'total':Number(_0x49a49a[_0x4cb7f9(0xf9)]*0x64)},'scene_info':{'payer_client_ip':_0x4cb7f9(0x139)}};console['log'](_0x4cb7f9(0x149),_0x44ffad);if(_0xcf6bf1=='h5'){_0x44ffad[_0x4cb7f9(0x193)][_0x4cb7f9(0x173)]={'type':_0x4cb7f9(0x125),'app_name':_0x35b089,'app_url':_0x48688f};const _0x21b58d=await _0x1a7e07[_0x4cb7f9(0x189)](_0x44ffad);if(_0x21b58d[_0x4cb7f9(0x130)]===0x193){const _0x2163ff=(_0x2a0a37=(_0xe8c04a=(_0x428a6a=_0x21b58d===null||_0x21b58d===void 0x0?void 0x0:_0x21b58d[_0x4cb7f9(0x154)])===null||_0x428a6a===void 0x0?void 0x0:_0x428a6a['response'])===null||_0xe8c04a===void 0x0?void 0x0:_0xe8c04a['text'])===null||_0x2a0a37===void 0x0?void 0x0:_0x2a0a37['message'];throw new common_1[(_0x4cb7f9(0x164))]((_0x21b58d===null||_0x21b58d===void 0x0?void 0x0:_0x21b58d['message'])||_0x4cb7f9(0x18b),common_1['HttpStatus'][_0x4cb7f9(0x124)]);}const {h5_url:_0x3d487b}=_0x21b58d;return{'url':_0x3d487b};}if(_0xcf6bf1==_0x4cb7f9(0x13b)){const _0xee812e=await this[_0x4cb7f9(0x186)][_0x4cb7f9(0xff)](_0x18c19d);console[_0x4cb7f9(0x12f)](_0x4cb7f9(0x18f),_0xee812e),_0x44ffad[_0x4cb7f9(0x197)]={'openid':_0xee812e};const _0xa53126=await _0x1a7e07['transactions_jsapi'](_0x44ffad);return console[_0x4cb7f9(0x12f)]('jsapi支付结果返回值:\x20',_0xa53126),_0xa53126;}if(_0xcf6bf1==_0x4cb7f9(0x135)){const _0x6eb3c7=await _0x1a7e07[_0x4cb7f9(0x182)](_0x44ffad),{code_url:_0x55b277}=_0x6eb3c7;return!_0x55b277&&console[_0x4cb7f9(0x12f)](_0x4cb7f9(0x160),_0x6eb3c7),{'url_qrcode':_0x55b277,'isRedirect':![]};}throw new common_1[(_0x4cb7f9(0x164))](_0x4cb7f9(0x109),common_1[_0x4cb7f9(0x156)]['BAD_REQUEST']);}async[_0x39fbfd(0x198)](_0x7023ad){const _0x381095=_0x39fbfd,{payWeChatAppId:_0x2fdb97,payWeChatMchId:_0x4581ec,payWeChatPublicKey:_0x27b1d3,payWeChatPrivateKey:_0x10f900,payWeChatNotifyUrl:_0x4900c6,payWeChatH5Name:_0x80b4fe,payWeChatH5Url:_0x1e4632}=await this[_0x381095(0x112)][_0x381095(0x118)](['payWeChatAppId',_0x381095(0x12c),_0x381095(0x107),_0x381095(0x15a)]),_0x22fbbf=new this[(_0x381095(0x143))]({'appid':_0x2fdb97,'mchid':_0x4581ec,'publicKey':_0x27b1d3,'privateKey':_0x10f900}),_0x32874b=await _0x22fbbf['query']({'out_trade_no':_0x7023ad});return _0x32874b;}[_0x39fbfd(0x129)](_0x1433cf,_0x25be2e){const _0x3dfc21=_0x39fbfd,_0x42464d=Object['keys'](_0x1433cf)['sort']()[_0x3dfc21(0x14e)](_0x5b95a5=>_0x5b95a5+'='+_0x1433cf[_0x5b95a5])[_0x3dfc21(0x10d)]('&')+_0x25be2e;return crypto[_0x3dfc21(0x155)](_0x3dfc21(0x105))['update'](_0x42464d)[_0x3dfc21(0x104)](_0x3dfc21(0x169));}};PayService=__decorate([(0x0,common_1[_0x39fbfd(0x184)])(),__param(0x0,(0x0,typeorm_1[_0x39fbfd(0x148)])(cramiPackage_entity_1[_0x39fbfd(0x176)])),__param(0x1,(0x0,typeorm_1[_0x39fbfd(0x148)])(order_entity_1['OrderEntity'])),__metadata('design:paramtypes',[typeorm_2['Repository'],typeorm_2[_0x39fbfd(0x172)],userBalance_service_1[_0x39fbfd(0x15c)],globalConfig_service_1[_0x39fbfd(0x101)],user_service_1['UserService']])],PayService),exports[_0x39fbfd(0x171)]=PayService;