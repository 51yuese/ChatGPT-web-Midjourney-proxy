'use strict';function _0xc08e(_0x4ef490,_0x503034){const _0x3d7eb9=_0x3d7e();return _0xc08e=function(_0xc08ef4,_0x130473){_0xc08ef4=_0xc08ef4-0x1f4;let _0x142dc0=_0x3d7eb9[_0xc08ef4];return _0x142dc0;},_0xc08e(_0x4ef490,_0x503034);}const _0x2fb1da=_0xc08e;(function(_0x18475f,_0x2af193){const _0x551f26=_0xc08e,_0x536bfa=_0x18475f();while(!![]){try{const _0x3788cc=parseInt(_0x551f26(0x25b))/0x1*(parseInt(_0x551f26(0x23e))/0x2)+-parseInt(_0x551f26(0x1fe))/0x3*(parseInt(_0x551f26(0x206))/0x4)+-parseInt(_0x551f26(0x26b))/0x5+-parseInt(_0x551f26(0x245))/0x6+parseInt(_0x551f26(0x234))/0x7*(-parseInt(_0x551f26(0x248))/0x8)+parseInt(_0x551f26(0x22f))/0x9*(-parseInt(_0x551f26(0x20b))/0xa)+parseInt(_0x551f26(0x24a))/0xb;if(_0x3788cc===_0x2af193)break;else _0x536bfa['push'](_0x536bfa['shift']());}catch(_0x596978){_0x536bfa['push'](_0x536bfa['shift']());}}}(_0x3d7e,0x36872));function _0x3d7e(){const _0x3eca49=['originTaskId','1452648reOPPi','queryUploadList','tencentCos','set','aliOssAccessKeyId','160yLVcod','../../common/utils','Repository','findOne','UploadService','env','query','GlobalConfigService','uploadFile','../../common/constants/redisKey.constant','getUploadType','removeSpecialCharacters','RedisCacheService','error:\x20','Injectable','@nestjs/typeorm','mjProxy','获取图片资源失败、请重新试试吧！','function','__param','response','stream-to-buffer','getService','cosSecretId','from','uploadFileByCheveretoFromUrl','__metadata','上传图片失败[ten]','HttpStatus','error','log','createRandomUid','object','Logger','getOwnPropertyDescriptor','../../config/MjConfig','223983RTKWIu','redisCacheService','tencent','getUploadConfig','data:image/jpeg;base64,','49oGzxCQ','design:paramtypes','globalConfigService','腾讯上传','uploadFileByAliOss','toString','putObject','post','chevereto','uploadFileByTencentCos','602596vSCVxZ','stream','tencentCosStatus','cosSecretKey','COS_REGION','get','default','2331864pgHGFH','decorate','typeorm','277040bThJlJ','url','16627204ReWGUo','metadata','aliOssBucket','ali-oss','上传图片失败[Chevereto]','aliyun','base64','uploadFileByTencentCosFromUrl','transferImg','ali','getModalImgById','BAD_REQUEST','replace','aliCos','cosRegion','save','当前已开启全球加速----------------->','1zGiKjQ','cheveretoStatus','status','cosBucket','axios','请先前往后台配置上传图片的方式','.png','aliOssStatus','HttpException','image-size','上传图片失败[Chevereto][url]','mjNotSaveImg','transferFile','image','uploadFileByChevereto','上传图片失败[Chevereto|buffer]\x20-->\x20','985540BKIYXg','arraybuffer','ISDEV','midjourneyEntity','https://','del','../globalConfig/globalConfig.service','put','InjectRepository','@nestjs/common','MidjourneyEntity','图床上传','stringify','message','/api/upload','mj-','imageUrl','上传图片失败[ALI][url]','data','mjProxyUrl','getBufferFromUrl','uploadFileByAliOssFromUrl','cos-nodejs-sdk-v5','tencentCosAcceleratedDomain','form-data','上传图片失败[ten][url]','ali\x20开始上传','aliOssRegion','3HhVGYR','split','cheveretoUploadPath','length','https://$2','getConfigs','lock'];_0x3d7e=function(){return _0x3eca49;};return _0x3d7e();}var __decorate=this&&this['__decorate']||function(_0x1e8c39,_0x260207,_0x365d3b,_0x37e927){const _0x324bb3=_0xc08e;var _0x3b4d2b=arguments['length'],_0x1e4462=_0x3b4d2b<0x3?_0x260207:_0x37e927===null?_0x37e927=Object[_0x324bb3(0x22d)](_0x260207,_0x365d3b):_0x37e927,_0x16f3e5;if(typeof Reflect===_0x324bb3(0x22b)&&typeof Reflect[_0x324bb3(0x246)]==='function')_0x1e4462=Reflect[_0x324bb3(0x246)](_0x1e8c39,_0x260207,_0x365d3b,_0x37e927);else{for(var _0x3164ca=_0x1e8c39[_0x324bb3(0x201)]-0x1;_0x3164ca>=0x0;_0x3164ca--)if(_0x16f3e5=_0x1e8c39[_0x3164ca])_0x1e4462=(_0x3b4d2b<0x3?_0x16f3e5(_0x1e4462):_0x3b4d2b>0x3?_0x16f3e5(_0x260207,_0x365d3b,_0x1e4462):_0x16f3e5(_0x260207,_0x365d3b))||_0x1e4462;}return _0x3b4d2b>0x3&&_0x1e4462&&Object['defineProperty'](_0x260207,_0x365d3b,_0x1e4462),_0x1e4462;},__metadata=this&&this[_0x2fb1da(0x225)]||function(_0x12de14,_0x1b1605){const _0x19ae15=_0x2fb1da;if(typeof Reflect==='object'&&typeof Reflect[_0x19ae15(0x24b)]===_0x19ae15(0x21d))return Reflect['metadata'](_0x12de14,_0x1b1605);},__param=this&&this[_0x2fb1da(0x21e)]||function(_0x5904b6,_0x3089d7){return function(_0x23e8ad,_0x1f189a){_0x3089d7(_0x23e8ad,_0x1f189a,_0x5904b6);};};Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports[_0x2fb1da(0x20f)]=void 0x0;const common_1=require(_0x2fb1da(0x274)),TENCENTCOS=require(_0x2fb1da(0x1f8)),ALIOSS=require(_0x2fb1da(0x24d)),axios_1=require(_0x2fb1da(0x25f)),image_size_1=require(_0x2fb1da(0x264)),streamToBuffer=require(_0x2fb1da(0x220)),utils_1=require(_0x2fb1da(0x20c)),globalConfig_service_1=require(_0x2fb1da(0x271)),FormData=require(_0x2fb1da(0x1fa)),midjourney_entity_1=require('../midjourney/midjourney.entity'),typeorm_1=require(_0x2fb1da(0x21a)),typeorm_2=require(_0x2fb1da(0x247)),redisKey_constant_1=require(_0x2fb1da(0x214)),redisCache_service_1=require('../redisCache/redisCache.service'),MjConfig_1=require(_0x2fb1da(0x22e));let UploadService=class UploadService{constructor(_0x5964c9,_0x467458,_0x47c70b){const _0x84596c=_0x2fb1da;this['midjourneyEntity']=_0x5964c9,this['globalConfigService']=_0x467458,this[_0x84596c(0x230)]=_0x47c70b;}async['onModuleInit'](){const _0x37913d=_0x2fb1da,{tencentCosStatus:tencentCosStatus=0x0,aliOssStatus:aliOssStatus=0x0,cheveretoStatus:cheveretoStatus=0x0}=await this[_0x37913d(0x236)][_0x37913d(0x203)]([_0x37913d(0x240),_0x37913d(0x262),'cheveretoStatus']);!Number(tencentCosStatus)&&!Number(aliOssStatus)&&!Number(cheveretoStatus)&&common_1[_0x37913d(0x22c)][_0x37913d(0x228)](_0x37913d(0x260));if(Number(tencentCosStatus)===0x1){const {SecretId:_0x5f5a2b,SecretKey:_0x40987d}=await this['getUploadConfig'](_0x37913d(0x231));this[_0x37913d(0x208)]=new TENCENTCOS({'SecretId':_0x5f5a2b,'SecretKey':_0x40987d,'FileParallelLimit':0xa});}if(Number(aliOssStatus)===0x1){const {region:_0x57528d,bucket:_0x1f4d22,accessKeyId:_0x212fc0,accessKeySecret:_0x43a825}=await this[_0x37913d(0x232)](_0x37913d(0x253));this[_0x37913d(0x257)]=new ALIOSS({'region':(0x0,utils_1[_0x37913d(0x216)])(_0x57528d),'accessKeyId':_0x212fc0,'accessKeySecret':_0x43a825,'bucket':(0x0,utils_1[_0x37913d(0x216)])(_0x1f4d22)});}}async[_0x2fb1da(0x213)](_0x4b9298){const _0x44bbd5=_0x2fb1da,{filename:_0x26c399,buffer:_0x54f1fd,dir:dir='ai'}=_0x4b9298,{tencentCosStatus:tencentCosStatus=0x0,aliOssStatus:aliOssStatus=0x0,cheveretoStatus:cheveretoStatus=0x0}=await this[_0x44bbd5(0x236)]['getConfigs']([_0x44bbd5(0x240),_0x44bbd5(0x262),_0x44bbd5(0x25c)]);if(!Number(tencentCosStatus)&&!Number(aliOssStatus)&&!Number(cheveretoStatus))throw new common_1[(_0x44bbd5(0x263))]('请先前往后台配置上传图片的方式',common_1['HttpStatus'][_0x44bbd5(0x255)]);if(Number(tencentCosStatus)===0x1)return this[_0x44bbd5(0x23d)]({'filename':_0x26c399,'buffer':_0x54f1fd,'dir':dir});if(Number(aliOssStatus)===0x1)return await this[_0x44bbd5(0x238)]({'filename':_0x26c399,'buffer':_0x54f1fd,'dir':dir});if(Number(cheveretoStatus)){const {filename:_0x4c4f7b,buffer:_0x5cac1,dir:_0x325f96}=_0x4b9298;return await this[_0x44bbd5(0x269)]({'filename':_0x4c4f7b,'buffer':_0x5cac1[_0x44bbd5(0x239)](_0x44bbd5(0x250)),'dir':_0x325f96});}}async[_0x2fb1da(0x215)](){const _0x47bc6f=_0x2fb1da,{tencentCosStatus:tencentCosStatus=0x0,aliOssStatus:aliOssStatus=0x0,cheveretoStatus:cheveretoStatus=0x0}=await this[_0x47bc6f(0x236)][_0x47bc6f(0x203)]([_0x47bc6f(0x240),_0x47bc6f(0x262),_0x47bc6f(0x25c)]);if(Number(tencentCosStatus))return _0x47bc6f(0x231);if(Number(aliOssStatus))return _0x47bc6f(0x253);if(Number(cheveretoStatus))return _0x47bc6f(0x23c);}async['uploadFileFromUrl']({filename:_0x30a59a,url:_0x46671d,dir:dir='mj'}){const _0x55bd7a=_0x2fb1da;dir=process[_0x55bd7a(0x210)][_0x55bd7a(0x26d)]?'mjdev':dir;const {tencentCosStatus:tencentCosStatus=0x0,aliOssStatus:aliOssStatus=0x0,cheveretoStatus:cheveretoStatus=0x0}=await this[_0x55bd7a(0x236)][_0x55bd7a(0x203)](['tencentCosStatus','aliOssStatus',_0x55bd7a(0x25c)]);if(!Number(tencentCosStatus)&&!Number(aliOssStatus)&&!Number(cheveretoStatus))throw new common_1['HttpException'](_0x55bd7a(0x260),common_1[_0x55bd7a(0x227)][_0x55bd7a(0x255)]);if(Number(tencentCosStatus))return common_1[_0x55bd7a(0x22c)]['log'](_0x55bd7a(0x237)),this[_0x55bd7a(0x251)]({'filename':_0x30a59a,'url':_0x46671d,'dir':dir});if(Number(aliOssStatus))return common_1['Logger'][_0x55bd7a(0x229)]('阿里上传'),await this[_0x55bd7a(0x1f7)]({'filename':_0x30a59a,'url':_0x46671d,'dir':dir});if(Number(cheveretoStatus))return common_1[_0x55bd7a(0x22c)][_0x55bd7a(0x229)](_0x55bd7a(0x276)),await this[_0x55bd7a(0x224)]({'filename':_0x30a59a,'url':_0x46671d,'dir':dir});}async[_0x2fb1da(0x23d)]({filename:_0x1bc891,buffer:_0x1c105c,dir:_0x3c13bf}){const _0x51ee1d=_0x2fb1da;try{const {Bucket:_0x148c1d,Region:_0x3fbd99,SecretId:_0x24cbb0,SecretKey:_0x5330ce}=await this[_0x51ee1d(0x232)]('tencent');!this['tencentCos']&&(this[_0x51ee1d(0x208)]=new TENCENTCOS({'SecretId':_0x24cbb0,'SecretKey':_0x5330ce,'FileParallelLimit':0xa}));const _0x142bc6=await this[_0x51ee1d(0x208)][_0x51ee1d(0x23a)]({'Bucket':(0x0,utils_1[_0x51ee1d(0x216)])(_0x148c1d),'Region':(0x0,utils_1[_0x51ee1d(0x216)])(_0x3fbd99),'Key':_0x3c13bf+'/'+(_0x1bc891||(0x0,utils_1[_0x51ee1d(0x22a)])()+_0x51ee1d(0x261)),'StorageClass':'STANDARD','Body':_0x1c105c});let _0x492f75=_0x142bc6['Location'][_0x51ee1d(0x256)](/^(http:\/\/|https:\/\/|\/\/|)(.*)/,_0x51ee1d(0x202));const {acceleratedDomain:_0x3d83ac}=await this['getUploadConfig']('tencent');return _0x3d83ac&&(_0x492f75=_0x492f75[_0x51ee1d(0x256)](/^(https:\/\/[^/]+)(\/.*)$/,_0x51ee1d(0x26f)+_0x3d83ac+'$2'),console[_0x51ee1d(0x229)](_0x51ee1d(0x25a),_0x492f75)),_0x492f75;}catch(_0x3f50e6){console['log'](_0x51ee1d(0x218),_0x3f50e6);throw new common_1[(_0x51ee1d(0x263))](_0x51ee1d(0x226),common_1[_0x51ee1d(0x227)][_0x51ee1d(0x255)]);}}async[_0x2fb1da(0x251)]({filename:_0x34ec6f,url:_0x14d45c,dir:_0x13ae81}){const _0x193584=_0x2fb1da,{Bucket:_0x20d56f,Region:_0x845458,SecretId:_0x1d10dd,SecretKey:_0x5db777}=await this[_0x193584(0x232)]('tencent');try{const _0x5d6496=await this[_0x193584(0x236)][_0x193584(0x203)]([_0x193584(0x21b)])||0x0;if(Number(_0x5d6496)===0x1){const _0xc7f2b5={'cosType':_0x193584(0x231),'url':_0x14d45c,'cosParams':{'Bucket':_0x20d56f,'Region':_0x845458,'SecretId':_0x1d10dd,'SecretKey':_0x5db777}},_0x2cbfd7=await this[_0x193584(0x236)]['getConfigs']([_0x193584(0x1f5)]);console[_0x193584(0x229)]('走代理上传');const _0x240fe7=await axios_1[_0x193584(0x244)][_0x193584(0x23b)](_0x2cbfd7+_0x193584(0x279),_0xc7f2b5,{'timeout':0xa*0x3c*0x3e8});if(!_0x240fe7[_0x193584(0x1f4)])throw new common_1[(_0x193584(0x263))]('上传图片失败[ten][url]',common_1[_0x193584(0x227)]['BAD_REQUEST']);let _0x5b853d=_0x240fe7[_0x193584(0x1f4)];const {acceleratedDomain:_0xf44b21}=await this[_0x193584(0x232)]('tencent');return _0xf44b21&&(_0x5b853d=_0x5b853d[_0x193584(0x256)](/^(https:\/\/[^/]+)(\/.*)$/,_0x193584(0x26f)+_0xf44b21+'$2'),console[_0x193584(0x229)](_0x193584(0x25a))),console[_0x193584(0x229)]('response\x20uploaded\x20url\x20',_0x5b853d),_0x5b853d;}else{const _0x2a1d21=await this[_0x193584(0x1f6)](_0x14d45c);return await this[_0x193584(0x23d)]({'filename':_0x34ec6f,'buffer':_0x2a1d21,'dir':_0x13ae81});}}catch(_0x4645a0){console['log']('TODO->error:\x20\x20',_0x4645a0);throw new common_1[(_0x193584(0x263))](_0x193584(0x1fb),common_1['HttpStatus'][_0x193584(0x255)]);}}async[_0x2fb1da(0x238)]({filename:_0x78b098,buffer:_0x5c5b40,dir:_0x552f21}){const _0x56741a=_0x2fb1da;if(!this[_0x56741a(0x257)]){const {region:_0xb0b925,bucket:_0x280ca1,accessKeyId:_0x4aedcd,accessKeySecret:_0x201bb6}=await this[_0x56741a(0x232)](_0x56741a(0x253));this[_0x56741a(0x257)]=new ALIOSS({'region':(0x0,utils_1['removeSpecialCharacters'])(_0xb0b925),'accessKeyId':_0x4aedcd,'accessKeySecret':_0x201bb6,'bucket':(0x0,utils_1['removeSpecialCharacters'])(_0x280ca1)});}try{console[_0x56741a(0x229)](_0x56741a(0x1fc));const _0x592146=await this[_0x56741a(0x257)][_0x56741a(0x272)](_0x552f21+'/'+(_0x78b098||(0x0,utils_1[_0x56741a(0x22a)])()+_0x56741a(0x261)),_0x5c5b40);return _0x592146[_0x56741a(0x249)];}catch(_0x5174c5){throw new common_1[(_0x56741a(0x263))]('上传图片失败[ali]',common_1['HttpStatus']['BAD_REQUEST']);}}async['uploadFileByAliOssFromUrl']({filename:_0x2be39a,url:_0x18d6fe,dir:_0x144c72}){const _0x21df93=_0x2fb1da,{region:_0x7fd938,bucket:_0x451c1a,accessKeyId:_0x1135a3,accessKeySecret:_0x383a20}=await this[_0x21df93(0x232)]('ali');try{const _0x16119e=await this[_0x21df93(0x236)][_0x21df93(0x203)](['mjProxy'])||0x0;if(Number(_0x16119e)===0x1){const _0xa6c6d1={'url':_0x18d6fe,'cosParams':{'region':_0x7fd938,'bucket':_0x451c1a,'accessKeyId':_0x1135a3,'accessKeySecret':_0x383a20},'cosType':_0x21df93(0x24f)},_0x50e50e=await this[_0x21df93(0x236)][_0x21df93(0x203)]([_0x21df93(0x1f5)])||'http://172.247.48.137:8000',_0x520ca9=await axios_1[_0x21df93(0x244)][_0x21df93(0x23b)](_0x50e50e+_0x21df93(0x279),_0xa6c6d1,{'timeout':0xa*0x3c*0x3e8});if(!_0x520ca9?.['data'])throw new common_1[(_0x21df93(0x263))](_0x21df93(0x27c),common_1[_0x21df93(0x227)][_0x21df93(0x255)]);return _0x520ca9[_0x21df93(0x1f4)];}else{const _0x37c0ff=await this[_0x21df93(0x1f6)](_0x18d6fe);return await this[_0x21df93(0x238)]({'filename':_0x2be39a,'buffer':_0x37c0ff,'dir':_0x144c72});}}catch(_0x42204a){throw new common_1[(_0x21df93(0x263))](_0x21df93(0x27c),common_1['HttpStatus'][_0x21df93(0x255)]);}}async['uploadFileByChevereto']({filename:filename='',buffer:_0x4b73a7,dir:dir='ai'}){const _0x508232=_0x2fb1da,{key:_0x1068b9,uploadPath:_0x370dc4}=await this['getUploadConfig']('chevereto'),_0x535326=new FormData();_0x535326['append']('source',_0x4b73a7[_0x508232(0x239)]('base64')),_0x535326['append']('key',_0x1068b9);try{const _0x266702=await axios_1['default'][_0x508232(0x23b)](_0x370dc4,_0x535326,{'headers':{'X-API-Key':_0x1068b9},'timeout':0xa*0x3c*0x3e8});if(_0x266702?.[_0x508232(0x25d)]===0xc8)return _0x266702[_0x508232(0x1f4)][_0x508232(0x268)][_0x508232(0x249)];else{common_1[_0x508232(0x22c)][_0x508232(0x228)](_0x508232(0x24e),JSON[_0x508232(0x277)](_0x266702['data']));throw new Error(_0x508232(0x24e));}}catch(_0x4c1db4){console[_0x508232(0x229)](_0x508232(0x218),_0x4c1db4[_0x508232(0x21f)]);throw new common_1['HttpException'](_0x508232(0x26a)+_0x4c1db4['response']?.[_0x508232(0x1f4)][_0x508232(0x228)][_0x508232(0x278)],common_1[_0x508232(0x227)][_0x508232(0x255)]);}}async[_0x2fb1da(0x224)]({filename:_0xf9a055,url:_0x45462a,dir:_0x4d9c34}){const _0x129fcf=_0x2fb1da;try{const _0x9f92a7=await this[_0x129fcf(0x236)][_0x129fcf(0x203)]([_0x129fcf(0x21b)])||0x0;if(Number(_0x9f92a7)===0x1){const {key:_0x57510a,uploadPath:_0xf45f24}=await this[_0x129fcf(0x232)]('chevereto'),_0x38227d={'cosType':_0x129fcf(0x23c),'url':_0x45462a,'cosParams':{'key':_0x57510a,'uploadPath':_0xf45f24}},_0x3a7489=await this['globalConfigService'][_0x129fcf(0x203)](['mjProxyUrl'])||'http://172.247.48.137:8000',_0x2d4dce=await axios_1[_0x129fcf(0x244)][_0x129fcf(0x23b)](_0x3a7489+_0x129fcf(0x279),_0x38227d,{'timeout':0xa*0x3c*0x3e8});if(!_0x2d4dce[_0x129fcf(0x1f4)])throw new common_1[(_0x129fcf(0x263))](_0x129fcf(0x265),common_1[_0x129fcf(0x227)][_0x129fcf(0x255)]);return _0x2d4dce[_0x129fcf(0x1f4)];}else{const _0x3428a1=await this[_0x129fcf(0x1f6)](_0x45462a);return await this[_0x129fcf(0x269)]({'filename':_0xf9a055,'buffer':_0x3428a1,'dir':_0x4d9c34});}}catch(_0x5bbf73){console['log'](_0x129fcf(0x218),_0x5bbf73);throw new common_1[(_0x129fcf(0x263))](_0x5bbf73[_0x129fcf(0x21f)],common_1[_0x129fcf(0x227)][_0x129fcf(0x255)]);}}async[_0x2fb1da(0x232)](_0x168884){const _0x4b12ad=_0x2fb1da;if(_0x168884===_0x4b12ad(0x253)){const {aliOssRegion:_0x2893d2,aliOssBucket:_0x2f17b8,aliOssAccessKeyId:_0x1effaf,aliOssAccessKeySecret:_0x8f836c}=await this[_0x4b12ad(0x236)][_0x4b12ad(0x203)]([_0x4b12ad(0x1fd),_0x4b12ad(0x24c),_0x4b12ad(0x20a),'aliOssAccessKeySecret']);return{'region':_0x2893d2,'bucket':_0x2f17b8,'accessKeyId':_0x1effaf,'accessKeySecret':_0x8f836c};}if(_0x168884===_0x4b12ad(0x231)){const {cosBucket:_0x408f1e,cosRegion:_0x168cb5,cosSecretId:_0x5eb0e5,cosSecretKey:_0x3e9186,tencentCosAcceleratedDomain:_0x3dc4da}=await this[_0x4b12ad(0x236)]['getConfigs']([_0x4b12ad(0x25e),_0x4b12ad(0x258),_0x4b12ad(0x222),_0x4b12ad(0x241),'tencentCosAcceleratedDomain']);return{'Bucket':_0x408f1e,'Region':_0x168cb5,'SecretId':_0x5eb0e5,'SecretKey':_0x3e9186,'acceleratedDomain':_0x3dc4da};}if(_0x168884===_0x4b12ad(0x23c)){const {cheveretoKey:_0x5db124,cheveretoUploadPath:_0x3c09af}=await this['globalConfigService'][_0x4b12ad(0x203)](['cheveretoKey',_0x4b12ad(0x200)]);return{'key':_0x5db124,'uploadPath':_0x3c09af};}}async[_0x2fb1da(0x1f6)](_0x6a325a){const _0x3bf0d3=_0x2fb1da,_0x21d1a1=await axios_1[_0x3bf0d3(0x244)]['get'](_0x6a325a,{'responseType':_0x3bf0d3(0x23f)});return new Promise((_0xf78ae7,_0x59627a)=>{const _0x477a1f=_0x3bf0d3;streamToBuffer(_0x21d1a1[_0x477a1f(0x1f4)],(_0x81ce24,_0x1b8a18)=>{const _0x2fcc50=_0x477a1f;if(_0x81ce24)throw new common_1[(_0x2fcc50(0x263))](_0x2fcc50(0x21c),common_1[_0x2fcc50(0x227)][_0x2fcc50(0x255)]);else _0xf78ae7(_0x1b8a18);});});}async[_0x2fb1da(0x207)](_0x48ae55,_0x3b9514){const _0x515344=_0x2fb1da,{cosBucket:_0x4fc0a0,cosRegion:_0x566304,cosSecretId:_0x46b0e8,cosSecretKey:_0x6ac87c,tencentCosAcceleratedDomain:_0x328d42}=await this[_0x515344(0x236)][_0x515344(0x203)](['cosBucket',_0x515344(0x258),_0x515344(0x222),_0x515344(0x241),_0x515344(0x1f9)]);this[_0x515344(0x208)]=new TENCENTCOS({'SecretId':_0x46b0e8,'SecretKey':_0x6ac87c,'FileParallelLimit':0xa}),this[_0x515344(0x208)][_0x515344(0x221)]({'Region':_0x515344(0x242)},function(_0x3108c7,_0x226478){const _0x1035d9=_0x515344;console[_0x1035d9(0x229)](_0x3108c7||_0x226478);});}async[_0x2fb1da(0x267)](_0x2fcca1){const _0x4109c7=_0x2fb1da;try{const _0x2e0006=await axios_1['default'][_0x4109c7(0x243)](_0x2fcca1,{'responseType':_0x4109c7(0x26c)}),_0x1621dd=_0x2fcca1[_0x4109c7(0x1ff)]('/')['pop'](),_0x558d71=await this['uploadFile']({'filename':_0x1621dd,'buffer':_0x2e0006[_0x4109c7(0x1f4)]});return _0x558d71;}catch(_0x47a7b0){return common_1[_0x4109c7(0x22c)][_0x4109c7(0x228)]('transferFile\x20error:\x20',_0x47a7b0),null;}}async[_0x2fb1da(0x252)](_0x1df407,_0x24fd68){const _0x5b3111=_0x2fb1da,_0x9b0441=redisKey_constant_1['MJ_IMG_TRANSFER']+_0x1df407;try{const _0x4bb358=await this[_0x5b3111(0x230)][_0x5b3111(0x243)]({'key':_0x9b0441});if(_0x4bb358)return;this['redisCacheService'][_0x5b3111(0x209)]({'key':_0x9b0441,'val':_0x5b3111(0x204)});const _0x5294b3=await axios_1[_0x5b3111(0x244)][_0x5b3111(0x243)](_0x24fd68,{'responseType':_0x5b3111(0x26c)}),{width:_0x429be8,height:_0x314cf7}=await(0x0,image_size_1[_0x5b3111(0x244)])(_0x5294b3[_0x5b3111(0x1f4)]);!MjConfig_1[_0x5b3111(0x244)][_0x5b3111(0x266)]&&(_0x24fd68=await this[_0x5b3111(0x213)]({'filename':_0x5b3111(0x27a)+_0x1df407+_0x5b3111(0x261),'buffer':_0x5294b3[_0x5b3111(0x1f4)]})),await this[_0x5b3111(0x26e)][_0x5b3111(0x259)]({'id':_0x1df407,'imageUrl':_0x24fd68,'fileInfo':JSON[_0x5b3111(0x277)]({'width':_0x429be8,'height':_0x314cf7})});}catch(_0x43d356){common_1['Logger'][_0x5b3111(0x228)](_0x9b0441,'：',_0x43d356);}finally{this[_0x5b3111(0x230)][_0x5b3111(0x270)]({'key':_0x9b0441});}}async[_0x2fb1da(0x254)](_0x32c269){const _0x13f7cd=_0x2fb1da,_0x2452a8=await this[_0x13f7cd(0x26e)][_0x13f7cd(0x20e)]({'where':{'id':Number(_0x32c269[_0x13f7cd(0x211)]['taskId'])}}),_0xe22145=await this[_0x13f7cd(0x26e)][_0x13f7cd(0x20e)]({'where':{'id':Number(_0x2452a8[_0x13f7cd(0x205)])}}),_0x1faa55=await axios_1[_0x13f7cd(0x244)][_0x13f7cd(0x243)](_0xe22145[_0x13f7cd(0x27b)],{'responseType':'arraybuffer'}),_0x391118=Buffer[_0x13f7cd(0x223)](_0x1faa55[_0x13f7cd(0x1f4)])[_0x13f7cd(0x239)](_0x13f7cd(0x250));return _0x13f7cd(0x233)+_0x391118;}};UploadService=__decorate([(0x0,common_1[_0x2fb1da(0x219)])(),__param(0x0,(0x0,typeorm_1[_0x2fb1da(0x273)])(midjourney_entity_1[_0x2fb1da(0x275)])),__metadata(_0x2fb1da(0x235),[typeorm_2[_0x2fb1da(0x20d)],globalConfig_service_1[_0x2fb1da(0x212)],redisCache_service_1[_0x2fb1da(0x217)]])],UploadService),exports[_0x2fb1da(0x20f)]=UploadService;