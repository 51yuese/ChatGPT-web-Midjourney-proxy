'use strict';const _0x2936f7=_0x5e52;function _0x5e52(_0x104efc,_0x17c678){const _0x1ba67e=_0x1ba6();return _0x5e52=function(_0x5e52c7,_0x876427){_0x5e52c7=_0x5e52c7-0xe6;let _0x50428e=_0x1ba67e[_0x5e52c7];return _0x50428e;},_0x5e52(_0x104efc,_0x17c678);}function _0x1ba6(){const _0x2b2a52=['object','queryUploadList','http://172.247.48.137:8000','putObject','STANDARD','获取图片资源失败、请重新试试吧！','ali\x20开始上传','/api/upload','originTaskId','Logger','getBufferFromUrl','cosBucket','put','get','post','mjNotSaveImg','腾讯上传','log','axios','redisCacheService','uploadFileByChevereto','.png','getOwnPropertyDescriptor','@nestjs/common','tencent','pop','uploadFileByTencentCosFromUrl','append','__param','上传图片失败[ali]','uploadFileByTencentCos','uploadFileByAliOss','HttpException','getConfigs','8210imOVKM','message','error:\x20','uploadFileByAliOssFromUrl','toString','design:paramtypes','response\x20uploaded\x20url\x20','__decorate','ISDEV','findOne','请先前往后台配置上传图片的方式','ali','data','5229FbfoyA','mjProxyUrl','__metadata','404908tUPkae','image-size','aliOssAccessKeySecret','getUploadType','RedisCacheService','from','COS_REGION','aliyun','@nestjs/typeorm','uploadFileFromUrl','cheveretoUploadPath','url','mjProxy','GlobalConfigService','上传图片失败[ALI][url]','globalConfigService','50haQezO','split','imageUrl','defineProperty','走代理上传','BAD_REQUEST','getModalImgById','default','11xQnbef','replace','env','HttpStatus','aliOssAccessKeyId','error','1550742aEUfKk','上传图片失败[Chevereto]','Location','8880XPWHzl','midjourneyEntity','551394DZOMjp','Injectable','../globalConfig/globalConfig.service','onModuleInit','data:image/jpeg;base64,','arraybuffer','lock','cheveretoKey','39301692GPAeZc','aliOssRegion','typeorm','cheveretoStatus','chevereto','https://','80FjcTFG','decorate','../redisCache/redisCache.service','207qcoGen','tencentCosStatus','metadata','stream','aliCos','上传图片失败[Chevereto][url]','uploadFileByCheveretoFromUrl','createRandomUid','cosRegion','InjectRepository','set','removeSpecialCharacters','base64','tencentCosAcceleratedDomain','length','taskId','aliOssStatus','https://$2','上传图片失败[Chevereto|buffer]\x20-->\x20','function','当前已开启全球加速----------------->','image','MidjourneyEntity','mjdev','../../common/utils','response','cosSecretKey','getUploadConfig','stringify','cosSecretId','../../config/MjConfig','UploadService','上传图片失败[ten]','uploadFile','transferFile\x20error:\x20','1747872atSuNt','tencentCos','Repository','save'];_0x1ba6=function(){return _0x2b2a52;};return _0x1ba6();}(function(_0x59337a,_0x2802b1){const _0x27883a=_0x5e52,_0x34869c=_0x59337a();while(!![]){try{const _0x26c783=-parseInt(_0x27883a(0x140))/0x1*(parseInt(_0x27883a(0xfc))/0x2)+parseInt(_0x27883a(0x12a))/0x3+-parseInt(_0x27883a(0x163))/0x4+-parseInt(_0x27883a(0x11c))/0x5*(parseInt(_0x27883a(0x12f))/0x6)+parseInt(_0x27883a(0x10c))/0x7*(-parseInt(_0x27883a(0x13d))/0x8)+parseInt(_0x27883a(0x109))/0x9*(-parseInt(_0x27883a(0x12d))/0xa)+parseInt(_0x27883a(0x124))/0xb*(parseInt(_0x27883a(0x137))/0xc);if(_0x26c783===_0x2802b1)break;else _0x34869c['push'](_0x34869c['shift']());}catch(_0x49e5bb){_0x34869c['push'](_0x34869c['shift']());}}}(_0x1ba6,0x781da));var __decorate=this&&this[_0x2936f7(0x103)]||function(_0x1d368f,_0x4540c7,_0x11d969,_0x25b8aa){const _0x493cda=_0x2936f7;var _0x450f67=arguments[_0x493cda(0x14e)],_0x236c42=_0x450f67<0x3?_0x4540c7:_0x25b8aa===null?_0x25b8aa=Object[_0x493cda(0xf0)](_0x4540c7,_0x11d969):_0x25b8aa,_0x1b0db3;if(typeof Reflect===_0x493cda(0x167)&&typeof Reflect[_0x493cda(0x13e)]===_0x493cda(0x153))_0x236c42=Reflect[_0x493cda(0x13e)](_0x1d368f,_0x4540c7,_0x11d969,_0x25b8aa);else{for(var _0x5c7427=_0x1d368f[_0x493cda(0x14e)]-0x1;_0x5c7427>=0x0;_0x5c7427--)if(_0x1b0db3=_0x1d368f[_0x5c7427])_0x236c42=(_0x450f67<0x3?_0x1b0db3(_0x236c42):_0x450f67>0x3?_0x1b0db3(_0x4540c7,_0x11d969,_0x236c42):_0x1b0db3(_0x4540c7,_0x11d969))||_0x236c42;}return _0x450f67>0x3&&_0x236c42&&Object[_0x493cda(0x11f)](_0x4540c7,_0x11d969,_0x236c42),_0x236c42;},__metadata=this&&this[_0x2936f7(0x10b)]||function(_0x8fc4b4,_0xb42465){const _0x4dba4b=_0x2936f7;if(typeof Reflect===_0x4dba4b(0x167)&&typeof Reflect[_0x4dba4b(0x142)]===_0x4dba4b(0x153))return Reflect[_0x4dba4b(0x142)](_0x8fc4b4,_0xb42465);},__param=this&&this[_0x2936f7(0xf6)]||function(_0xfe9bf0,_0x21dacd){return function(_0x53928c,_0x4300ea){_0x21dacd(_0x53928c,_0x4300ea,_0xfe9bf0);};};Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports['UploadService']=void 0x0;const common_1=require(_0x2936f7(0xf1)),TENCENTCOS=require('cos-nodejs-sdk-v5'),ALIOSS=require('ali-oss'),axios_1=require(_0x2936f7(0xec)),image_size_1=require(_0x2936f7(0x10d)),streamToBuffer=require('stream-to-buffer'),utils_1=require(_0x2936f7(0x158)),globalConfig_service_1=require(_0x2936f7(0x131)),FormData=require('form-data'),midjourney_entity_1=require('../midjourney/midjourney.entity'),typeorm_1=require(_0x2936f7(0x114)),typeorm_2=require(_0x2936f7(0x139)),redisKey_constant_1=require('../../common/constants/redisKey.constant'),redisCache_service_1=require(_0x2936f7(0x13f)),MjConfig_1=require(_0x2936f7(0x15e));let UploadService=class UploadService{constructor(_0x4dec61,_0x415fb2,_0x16dcb2){const _0x17a85e=_0x2936f7;this[_0x17a85e(0x12e)]=_0x4dec61,this[_0x17a85e(0x11b)]=_0x415fb2,this[_0x17a85e(0xed)]=_0x16dcb2;}async[_0x2936f7(0x132)](){const _0x12f19c=_0x2936f7,{tencentCosStatus:tencentCosStatus=0x0,aliOssStatus:aliOssStatus=0x0,cheveretoStatus:cheveretoStatus=0x0}=await this[_0x12f19c(0x11b)][_0x12f19c(0xfb)](['tencentCosStatus',_0x12f19c(0x150),_0x12f19c(0x13a)]);!Number(tencentCosStatus)&&!Number(aliOssStatus)&&!Number(cheveretoStatus)&&common_1['Logger'][_0x12f19c(0x129)](_0x12f19c(0x106));if(Number(tencentCosStatus)===0x1){const {SecretId:_0x2381c6,SecretKey:_0x556937}=await this['getUploadConfig'](_0x12f19c(0xf2));this[_0x12f19c(0x164)]=new TENCENTCOS({'SecretId':_0x2381c6,'SecretKey':_0x556937,'FileParallelLimit':0xa});}if(Number(aliOssStatus)===0x1){const {region:_0x2b4479,bucket:_0x3c7481,accessKeyId:_0x3dc714,accessKeySecret:_0x138723}=await this[_0x12f19c(0x15b)](_0x12f19c(0x107));this[_0x12f19c(0x144)]=new ALIOSS({'region':(0x0,utils_1['removeSpecialCharacters'])(_0x2b4479),'accessKeyId':_0x3dc714,'accessKeySecret':_0x138723,'bucket':(0x0,utils_1[_0x12f19c(0x14b)])(_0x3c7481)});}}async['uploadFile'](_0x59fa17){const _0xc44465=_0x2936f7,{filename:_0x327dd0,buffer:_0x4fb280,dir:dir='ai'}=_0x59fa17,{tencentCosStatus:tencentCosStatus=0x0,aliOssStatus:aliOssStatus=0x0,cheveretoStatus:cheveretoStatus=0x0}=await this[_0xc44465(0x11b)][_0xc44465(0xfb)]([_0xc44465(0x141),_0xc44465(0x150),_0xc44465(0x13a)]);if(!Number(tencentCosStatus)&&!Number(aliOssStatus)&&!Number(cheveretoStatus))throw new common_1['HttpException'](_0xc44465(0x106),common_1[_0xc44465(0x127)][_0xc44465(0x121)]);if(Number(tencentCosStatus)===0x1)return this[_0xc44465(0xf8)]({'filename':_0x327dd0,'buffer':_0x4fb280,'dir':dir});if(Number(aliOssStatus)===0x1)return await this[_0xc44465(0xf9)]({'filename':_0x327dd0,'buffer':_0x4fb280,'dir':dir});if(Number(cheveretoStatus)){const {filename:_0x459b16,buffer:_0x46c901,dir:_0x547289}=_0x59fa17;return await this[_0xc44465(0xee)]({'filename':_0x459b16,'buffer':_0x46c901[_0xc44465(0x100)]('base64'),'dir':_0x547289});}}async[_0x2936f7(0x10f)](){const _0x10f591=_0x2936f7,{tencentCosStatus:tencentCosStatus=0x0,aliOssStatus:aliOssStatus=0x0,cheveretoStatus:cheveretoStatus=0x0}=await this[_0x10f591(0x11b)][_0x10f591(0xfb)]([_0x10f591(0x141),_0x10f591(0x150),_0x10f591(0x13a)]);if(Number(tencentCosStatus))return _0x10f591(0xf2);if(Number(aliOssStatus))return _0x10f591(0x107);if(Number(cheveretoStatus))return _0x10f591(0x13b);}async[_0x2936f7(0x115)]({filename:_0x45d207,url:_0x101e91,dir:dir='mj'}){const _0x9ff055=_0x2936f7;dir=process[_0x9ff055(0x126)][_0x9ff055(0x104)]?_0x9ff055(0x157):dir;const {tencentCosStatus:tencentCosStatus=0x0,aliOssStatus:aliOssStatus=0x0,cheveretoStatus:cheveretoStatus=0x0}=await this['globalConfigService']['getConfigs']([_0x9ff055(0x141),_0x9ff055(0x150),_0x9ff055(0x13a)]);if(!Number(tencentCosStatus)&&!Number(aliOssStatus)&&!Number(cheveretoStatus))throw new common_1[(_0x9ff055(0xfa))](_0x9ff055(0x106),common_1[_0x9ff055(0x127)][_0x9ff055(0x121)]);if(Number(tencentCosStatus))return common_1['Logger'][_0x9ff055(0xeb)](_0x9ff055(0xea)),this['uploadFileByTencentCosFromUrl']({'filename':_0x45d207,'url':_0x101e91,'dir':dir});if(Number(aliOssStatus))return common_1[_0x9ff055(0x170)][_0x9ff055(0xeb)]('阿里上传'),await this[_0x9ff055(0xff)]({'filename':_0x45d207,'url':_0x101e91,'dir':dir});if(Number(cheveretoStatus))return common_1[_0x9ff055(0x170)][_0x9ff055(0xeb)]('图床上传'),await this[_0x9ff055(0x146)]({'filename':_0x45d207,'url':_0x101e91,'dir':dir});}async[_0x2936f7(0xf8)]({filename:_0x49159a,buffer:_0x497178,dir:_0x779ad8}){const _0x395314=_0x2936f7;try{const {Bucket:_0x4377d7,Region:_0x1db40d,SecretId:_0x778cba,SecretKey:_0xfc5d94}=await this[_0x395314(0x15b)](_0x395314(0xf2));!this['tencentCos']&&(this[_0x395314(0x164)]=new TENCENTCOS({'SecretId':_0x778cba,'SecretKey':_0xfc5d94,'FileParallelLimit':0xa}));const _0x15873d=await this[_0x395314(0x164)][_0x395314(0x16a)]({'Bucket':(0x0,utils_1[_0x395314(0x14b)])(_0x4377d7),'Region':(0x0,utils_1[_0x395314(0x14b)])(_0x1db40d),'Key':_0x779ad8+'/'+(_0x49159a||(0x0,utils_1[_0x395314(0x147)])()+_0x395314(0xef)),'StorageClass':_0x395314(0x16b),'Body':_0x497178});let _0x4b629e=_0x15873d[_0x395314(0x12c)][_0x395314(0x125)](/^(http:\/\/|https:\/\/|\/\/|)(.*)/,_0x395314(0x151));const {acceleratedDomain:_0x16b909}=await this['getUploadConfig'](_0x395314(0xf2));return _0x16b909&&(_0x4b629e=_0x4b629e[_0x395314(0x125)](/^(https:\/\/[^/]+)(\/.*)$/,_0x395314(0x13c)+_0x16b909+'$2'),console[_0x395314(0xeb)]('当前已开启全球加速----------------->',_0x4b629e)),_0x4b629e;}catch(_0x28f05c){console[_0x395314(0xeb)](_0x395314(0xfe),_0x28f05c);throw new common_1[(_0x395314(0xfa))](_0x395314(0x160),common_1['HttpStatus']['BAD_REQUEST']);}}async[_0x2936f7(0xf4)]({filename:_0x57ace8,url:_0x86b002,dir:_0x153b39}){const _0x430a71=_0x2936f7,{Bucket:_0x1d9b06,Region:_0x2c9cac,SecretId:_0x1991ad,SecretKey:_0x166acb}=await this[_0x430a71(0x15b)](_0x430a71(0xf2));try{const _0x2f4924=await this[_0x430a71(0x11b)][_0x430a71(0xfb)](['mjProxy'])||0x0;if(Number(_0x2f4924)===0x1){const _0x9bc3b1={'cosType':_0x430a71(0xf2),'url':_0x86b002,'cosParams':{'Bucket':_0x1d9b06,'Region':_0x2c9cac,'SecretId':_0x1991ad,'SecretKey':_0x166acb}},_0x1e932e=await this['globalConfigService'][_0x430a71(0xfb)]([_0x430a71(0x10a)]);console[_0x430a71(0xeb)](_0x430a71(0x120));const _0x351b3c=await axios_1['default'][_0x430a71(0xe8)](_0x1e932e+_0x430a71(0x16e),_0x9bc3b1,{'timeout':0xa*0x3c*0x3e8});if(!_0x351b3c[_0x430a71(0x108)])throw new common_1[(_0x430a71(0xfa))]('上传图片失败[ten][url]',common_1['HttpStatus'][_0x430a71(0x121)]);let _0x5cb802=_0x351b3c['data'];const {acceleratedDomain:_0x38b0c2}=await this[_0x430a71(0x15b)](_0x430a71(0xf2));return _0x38b0c2&&(_0x5cb802=_0x5cb802['replace'](/^(https:\/\/[^/]+)(\/.*)$/,_0x430a71(0x13c)+_0x38b0c2+'$2'),console[_0x430a71(0xeb)](_0x430a71(0x154))),console[_0x430a71(0xeb)](_0x430a71(0x102),_0x5cb802),_0x5cb802;}else{const _0x42d04f=await this[_0x430a71(0x171)](_0x86b002);return await this[_0x430a71(0xf8)]({'filename':_0x57ace8,'buffer':_0x42d04f,'dir':_0x153b39});}}catch(_0x277b37){console[_0x430a71(0xeb)]('TODO->error:\x20\x20',_0x277b37);throw new common_1[(_0x430a71(0xfa))]('上传图片失败[ten][url]',common_1[_0x430a71(0x127)][_0x430a71(0x121)]);}}async[_0x2936f7(0xf9)]({filename:_0x7d00f1,buffer:_0x3c432d,dir:_0x5a16fc}){const _0x47c56b=_0x2936f7;if(!this[_0x47c56b(0x144)]){const {region:_0x4a4b70,bucket:_0x51b127,accessKeyId:_0x143ef1,accessKeySecret:_0x6415e5}=await this['getUploadConfig'](_0x47c56b(0x107));this[_0x47c56b(0x144)]=new ALIOSS({'region':(0x0,utils_1[_0x47c56b(0x14b)])(_0x4a4b70),'accessKeyId':_0x143ef1,'accessKeySecret':_0x6415e5,'bucket':(0x0,utils_1[_0x47c56b(0x14b)])(_0x51b127)});}try{console[_0x47c56b(0xeb)](_0x47c56b(0x16d));const _0x24e22f=await this[_0x47c56b(0x144)][_0x47c56b(0xe6)](_0x5a16fc+'/'+(_0x7d00f1||(0x0,utils_1['createRandomUid'])()+'.png'),_0x3c432d);return _0x24e22f[_0x47c56b(0x117)];}catch(_0xe2c8c4){throw new common_1[(_0x47c56b(0xfa))](_0x47c56b(0xf7),common_1['HttpStatus'][_0x47c56b(0x121)]);}}async[_0x2936f7(0xff)]({filename:_0x527320,url:_0x29e33a,dir:_0x30b489}){const _0x126db2=_0x2936f7,{region:_0x449db7,bucket:_0x425388,accessKeyId:_0x54c5e9,accessKeySecret:_0x6ca20}=await this['getUploadConfig'](_0x126db2(0x107));try{const _0x274260=await this['globalConfigService'][_0x126db2(0xfb)]([_0x126db2(0x118)])||0x0;if(Number(_0x274260)===0x1){const _0x41ee5e={'url':_0x29e33a,'cosParams':{'region':_0x449db7,'bucket':_0x425388,'accessKeyId':_0x54c5e9,'accessKeySecret':_0x6ca20},'cosType':_0x126db2(0x113)},_0x193746=await this[_0x126db2(0x11b)][_0x126db2(0xfb)](['mjProxyUrl'])||_0x126db2(0x169),_0x6c8c18=await axios_1['default'][_0x126db2(0xe8)](_0x193746+_0x126db2(0x16e),_0x41ee5e,{'timeout':0xa*0x3c*0x3e8});if(!_0x6c8c18?.['data'])throw new common_1['HttpException'](_0x126db2(0x11a),common_1[_0x126db2(0x127)][_0x126db2(0x121)]);return _0x6c8c18[_0x126db2(0x108)];}else{const _0x1228a9=await this[_0x126db2(0x171)](_0x29e33a);return await this[_0x126db2(0xf9)]({'filename':_0x527320,'buffer':_0x1228a9,'dir':_0x30b489});}}catch(_0x4faac4){throw new common_1[(_0x126db2(0xfa))](_0x126db2(0x11a),common_1['HttpStatus'][_0x126db2(0x121)]);}}async[_0x2936f7(0xee)]({filename:filename='',buffer:_0x5b32c7,dir:dir='ai'}){const _0x5cdb4b=_0x2936f7,{key:_0x4e0e88,uploadPath:_0x112d43}=await this[_0x5cdb4b(0x15b)]('chevereto'),_0x583678=new FormData();_0x583678[_0x5cdb4b(0xf5)]('source',_0x5b32c7[_0x5cdb4b(0x100)](_0x5cdb4b(0x14c))),_0x583678['append']('key',_0x4e0e88);try{const _0x3b6ea1=await axios_1[_0x5cdb4b(0x123)][_0x5cdb4b(0xe8)](_0x112d43,_0x583678,{'headers':{'X-API-Key':_0x4e0e88},'timeout':0xa*0x3c*0x3e8});if(_0x3b6ea1?.['status']===0xc8)return _0x3b6ea1[_0x5cdb4b(0x108)][_0x5cdb4b(0x155)][_0x5cdb4b(0x117)];else{common_1[_0x5cdb4b(0x170)][_0x5cdb4b(0x129)](_0x5cdb4b(0x12b),JSON['stringify'](_0x3b6ea1[_0x5cdb4b(0x108)]));throw new Error(_0x5cdb4b(0x12b));}}catch(_0x44aa96){console[_0x5cdb4b(0xeb)](_0x5cdb4b(0xfe),_0x44aa96['response']);throw new common_1[(_0x5cdb4b(0xfa))](_0x5cdb4b(0x152)+_0x44aa96[_0x5cdb4b(0x159)]?.[_0x5cdb4b(0x108)][_0x5cdb4b(0x129)][_0x5cdb4b(0xfd)],common_1[_0x5cdb4b(0x127)][_0x5cdb4b(0x121)]);}}async[_0x2936f7(0x146)]({filename:_0x4c11d8,url:_0x319035,dir:_0x4ae480}){const _0x4adef2=_0x2936f7;try{const _0x5db5b8=await this[_0x4adef2(0x11b)][_0x4adef2(0xfb)]([_0x4adef2(0x118)])||0x0;if(Number(_0x5db5b8)===0x1){const {key:_0x17f640,uploadPath:_0x53cd1c}=await this[_0x4adef2(0x15b)](_0x4adef2(0x13b)),_0x50b17a={'cosType':_0x4adef2(0x13b),'url':_0x319035,'cosParams':{'key':_0x17f640,'uploadPath':_0x53cd1c}},_0x113c3c=await this[_0x4adef2(0x11b)]['getConfigs']([_0x4adef2(0x10a)])||_0x4adef2(0x169),_0x59e67a=await axios_1[_0x4adef2(0x123)][_0x4adef2(0xe8)](_0x113c3c+_0x4adef2(0x16e),_0x50b17a,{'timeout':0xa*0x3c*0x3e8});if(!_0x59e67a['data'])throw new common_1[(_0x4adef2(0xfa))](_0x4adef2(0x145),common_1['HttpStatus']['BAD_REQUEST']);return _0x59e67a[_0x4adef2(0x108)];}else{const _0x34990e=await this[_0x4adef2(0x171)](_0x319035);return await this['uploadFileByChevereto']({'filename':_0x4c11d8,'buffer':_0x34990e,'dir':_0x4ae480});}}catch(_0x10a6bb){console[_0x4adef2(0xeb)](_0x4adef2(0xfe),_0x10a6bb);throw new common_1[(_0x4adef2(0xfa))](_0x10a6bb['response'],common_1['HttpStatus'][_0x4adef2(0x121)]);}}async[_0x2936f7(0x15b)](_0x5b8c85){const _0x374ef6=_0x2936f7;if(_0x5b8c85===_0x374ef6(0x107)){const {aliOssRegion:_0x2db07f,aliOssBucket:_0x8b2034,aliOssAccessKeyId:_0x5844b3,aliOssAccessKeySecret:_0x2ca8c6}=await this[_0x374ef6(0x11b)][_0x374ef6(0xfb)]([_0x374ef6(0x138),'aliOssBucket',_0x374ef6(0x128),_0x374ef6(0x10e)]);return{'region':_0x2db07f,'bucket':_0x8b2034,'accessKeyId':_0x5844b3,'accessKeySecret':_0x2ca8c6};}if(_0x5b8c85===_0x374ef6(0xf2)){const {cosBucket:_0x34f1f3,cosRegion:_0x60bef9,cosSecretId:_0x140741,cosSecretKey:_0x491c61,tencentCosAcceleratedDomain:_0x1eebc9}=await this[_0x374ef6(0x11b)][_0x374ef6(0xfb)]([_0x374ef6(0x172),_0x374ef6(0x148),_0x374ef6(0x15d),_0x374ef6(0x15a),'tencentCosAcceleratedDomain']);return{'Bucket':_0x34f1f3,'Region':_0x60bef9,'SecretId':_0x140741,'SecretKey':_0x491c61,'acceleratedDomain':_0x1eebc9};}if(_0x5b8c85===_0x374ef6(0x13b)){const {cheveretoKey:_0x1eb935,cheveretoUploadPath:_0x3d88ec}=await this[_0x374ef6(0x11b)]['getConfigs']([_0x374ef6(0x136),_0x374ef6(0x116)]);return{'key':_0x1eb935,'uploadPath':_0x3d88ec};}}async[_0x2936f7(0x171)](_0x5a294c){const _0xf50cbc=_0x2936f7,_0x129779=await axios_1[_0xf50cbc(0x123)][_0xf50cbc(0xe7)](_0x5a294c,{'responseType':_0xf50cbc(0x143)});return new Promise((_0x5e10fc,_0x104e7b)=>{streamToBuffer(_0x129779['data'],(_0x2bd274,_0x3ed64a)=>{const _0x60e3d6=_0x5e52;if(_0x2bd274)throw new common_1[(_0x60e3d6(0xfa))](_0x60e3d6(0x16c),common_1[_0x60e3d6(0x127)]['BAD_REQUEST']);else _0x5e10fc(_0x3ed64a);});});}async[_0x2936f7(0x168)](_0x49a4b9,_0x1aa257){const _0x1ded11=_0x2936f7,{cosBucket:_0x2a8b1e,cosRegion:_0x3ceaf5,cosSecretId:_0x2cd29b,cosSecretKey:_0x4b936e,tencentCosAcceleratedDomain:_0xa6170b}=await this[_0x1ded11(0x11b)][_0x1ded11(0xfb)]([_0x1ded11(0x172),_0x1ded11(0x148),_0x1ded11(0x15d),_0x1ded11(0x15a),_0x1ded11(0x14d)]);this[_0x1ded11(0x164)]=new TENCENTCOS({'SecretId':_0x2cd29b,'SecretKey':_0x4b936e,'FileParallelLimit':0xa}),this[_0x1ded11(0x164)]['getService']({'Region':_0x1ded11(0x112)},function(_0x38138b,_0xfff50c){const _0x3fce0b=_0x1ded11;console[_0x3fce0b(0xeb)](_0x38138b||_0xfff50c);});}async['transferFile'](_0x468424){const _0x1d29f7=_0x2936f7;try{const _0x39339e=await axios_1[_0x1d29f7(0x123)]['get'](_0x468424,{'responseType':_0x1d29f7(0x134)}),_0x346ac2=_0x468424[_0x1d29f7(0x11d)]('/')[_0x1d29f7(0xf3)](),_0x379ec7=await this[_0x1d29f7(0x161)]({'filename':_0x346ac2,'buffer':_0x39339e[_0x1d29f7(0x108)]});return _0x379ec7;}catch(_0x5cf02c){return common_1['Logger'][_0x1d29f7(0x129)](_0x1d29f7(0x162),_0x5cf02c),null;}}async['transferImg'](_0xb645d7,_0x21cb42){const _0xa4eb2=_0x2936f7,_0x2c7296=redisKey_constant_1['MJ_IMG_TRANSFER']+_0xb645d7;try{const _0x17ad1c=await this[_0xa4eb2(0xed)][_0xa4eb2(0xe7)]({'key':_0x2c7296});if(_0x17ad1c)return;this[_0xa4eb2(0xed)][_0xa4eb2(0x14a)]({'key':_0x2c7296,'val':_0xa4eb2(0x135)});const _0x2c4b17=await axios_1[_0xa4eb2(0x123)][_0xa4eb2(0xe7)](_0x21cb42,{'responseType':_0xa4eb2(0x134)}),{width:_0x57267a,height:_0x4094d6}=await(0x0,image_size_1[_0xa4eb2(0x123)])(_0x2c4b17['data']);!MjConfig_1[_0xa4eb2(0x123)][_0xa4eb2(0xe9)]&&(_0x21cb42=await this[_0xa4eb2(0x161)]({'filename':'mj-'+_0xb645d7+_0xa4eb2(0xef),'buffer':_0x2c4b17['data']})),await this[_0xa4eb2(0x12e)][_0xa4eb2(0x166)]({'id':_0xb645d7,'imageUrl':_0x21cb42,'fileInfo':JSON[_0xa4eb2(0x15c)]({'width':_0x57267a,'height':_0x4094d6})});}catch(_0x412532){common_1['Logger'][_0xa4eb2(0x129)](_0x2c7296,'：',_0x412532);}finally{this[_0xa4eb2(0xed)]['del']({'key':_0x2c7296});}}async[_0x2936f7(0x122)](_0x427f57){const _0x2bf321=_0x2936f7,_0x420275=await this['midjourneyEntity'][_0x2bf321(0x105)]({'where':{'id':Number(_0x427f57['query'][_0x2bf321(0x14f)])}}),_0x56b000=await this['midjourneyEntity'][_0x2bf321(0x105)]({'where':{'id':Number(_0x420275[_0x2bf321(0x16f)])}}),_0x83d270=await axios_1['default'][_0x2bf321(0xe7)](_0x56b000[_0x2bf321(0x11e)],{'responseType':_0x2bf321(0x134)}),_0x11e52e=Buffer[_0x2bf321(0x111)](_0x83d270[_0x2bf321(0x108)])[_0x2bf321(0x100)](_0x2bf321(0x14c));return _0x2bf321(0x133)+_0x11e52e;}};UploadService=__decorate([(0x0,common_1[_0x2936f7(0x130)])(),__param(0x0,(0x0,typeorm_1[_0x2936f7(0x149)])(midjourney_entity_1[_0x2936f7(0x156)])),__metadata(_0x2936f7(0x101),[typeorm_2[_0x2936f7(0x165)],globalConfig_service_1[_0x2936f7(0x119)],redisCache_service_1[_0x2936f7(0x110)]])],UploadService),exports[_0x2936f7(0x15f)]=UploadService;