'use strict';const _0x2bef23=_0x100b;(function(_0x1632f6,_0x5b9b26){const _0x3d9863=_0x100b,_0x8d6379=_0x1632f6();while(!![]){try{const _0x55b37c=parseInt(_0x3d9863(0x109))/0x1+parseInt(_0x3d9863(0xf5))/0x2+-parseInt(_0x3d9863(0xc6))/0x3*(-parseInt(_0x3d9863(0x11a))/0x4)+parseInt(_0x3d9863(0xbb))/0x5+-parseInt(_0x3d9863(0x9b))/0x6*(-parseInt(_0x3d9863(0xf1))/0x7)+parseInt(_0x3d9863(0xc2))/0x8+-parseInt(_0x3d9863(0x92))/0x9;if(_0x55b37c===_0x5b9b26)break;else _0x8d6379['push'](_0x8d6379['shift']());}catch(_0x225d73){_0x8d6379['push'](_0x8d6379['shift']());}}}(_0x168b,0x75efa));function _0x100b(_0x3492a9,_0x375655){const _0x168b8e=_0x168b();return _0x100b=function(_0x100be7,_0x133707){_0x100be7=_0x100be7-0x8b;let _0x4bd6b6=_0x168b8e[_0x100be7];return _0x4bd6b6;},_0x100b(_0x3492a9,_0x375655);}var __decorate=this&&this[_0x2bef23(0x10f)]||function(_0x41dae7,_0x4b446d,_0x4f749b,_0x1761f5){const _0x29cfc0=_0x2bef23;var _0xeebe70=arguments[_0x29cfc0(0xfb)],_0x4c24fb=_0xeebe70<0x3?_0x4b446d:_0x1761f5===null?_0x1761f5=Object[_0x29cfc0(0xc0)](_0x4b446d,_0x4f749b):_0x1761f5,_0x2fd126;if(typeof Reflect===_0x29cfc0(0xbe)&&typeof Reflect[_0x29cfc0(0xb3)]===_0x29cfc0(0x91))_0x4c24fb=Reflect['decorate'](_0x41dae7,_0x4b446d,_0x4f749b,_0x1761f5);else{for(var _0x4152be=_0x41dae7[_0x29cfc0(0xfb)]-0x1;_0x4152be>=0x0;_0x4152be--)if(_0x2fd126=_0x41dae7[_0x4152be])_0x4c24fb=(_0xeebe70<0x3?_0x2fd126(_0x4c24fb):_0xeebe70>0x3?_0x2fd126(_0x4b446d,_0x4f749b,_0x4c24fb):_0x2fd126(_0x4b446d,_0x4f749b))||_0x4c24fb;}return _0xeebe70>0x3&&_0x4c24fb&&Object[_0x29cfc0(0x114)](_0x4b446d,_0x4f749b,_0x4c24fb),_0x4c24fb;},__metadata=this&&this[_0x2bef23(0x97)]||function(_0x295024,_0x4376ea){const _0x2bdf3f=_0x2bef23;if(typeof Reflect===_0x2bdf3f(0xbe)&&typeof Reflect[_0x2bdf3f(0xd6)]===_0x2bdf3f(0x91))return Reflect[_0x2bdf3f(0xd6)](_0x295024,_0x4376ea);},__param=this&&this[_0x2bef23(0x112)]||function(_0x1e2738,_0x5e70b5){return function(_0x530f69,_0x2927ce){_0x5e70b5(_0x530f69,_0x2927ce,_0x1e2738);};};Object[_0x2bef23(0x114)](exports,_0x2bef23(0x94),{'value':!![]}),exports[_0x2bef23(0x117)]=void 0x0;const common_1=require('@nestjs/common'),typeorm_1=require(_0x2bef23(0xb8)),chatLog_entity_1=require(_0x2bef23(0xdc)),typeorm_2=require(_0x2bef23(0x10d)),balance_constant_1=require(_0x2bef23(0xe8)),user_entity_1=require(_0x2bef23(0xed)),utils_1=require('../../common/utils'),exceljs_1=require('exceljs'),chatGroup_entity_1=require(_0x2bef23(0xa6)),upload_service_1=require(_0x2bef23(0xe1)),redisCache_service_1=require(_0x2bef23(0xe7)),redisKey_constant_1=require('../../common/constants/redisKey.constant'),aiAgreeLog_entity_1=require(_0x2bef23(0x115));function _0x168b(){const _0x1e561e=['Logger','save','3498dlxdsU','MUSIC_TRANSFER','catch','affected','Like','default','delete','update','syncMusic','message','super','?x-oss-process=image/resize,w_','substring','userEntity','删除对话记录成功！','username','metadata','prompt','ChatGroupEntity','all','?imageView2/1/w/','redisCacheService','./chatLog.entity','BAD_REQUEST','UploadService','assign','你删除的对话记录不存在、请检查！','../upload/upload.service','uploadService','transferFile','DESC','byAppId','delByGroupId','../redisCache/redisCache.service','../../common/constants/balance.constant','用户邮箱','DeductionKey','parse','call','../user/user.entity','你推荐的图片不存在、请检查！','HttpException','type','476XCQyWe','match','setHeader','removeLogsBatch','737612GjYsER','findAndCount','AiAgreeLogEntity','end','musicLog','图片成功！','length','paintCount','PAINT_TYPE','gpts','InjectRepository','当前页面已经没有东西可以删除了！','aiAgreeLogEntity','Repository','cos','IsNull','thumbImg','chat.xlsx','%filesystem.site%','includes','60341JQNPCu','size','提问问题','Workbook','typeorm','lock','__decorate','CHAT_TYPE','map','__param','user','defineProperty','../aiLog/aiAgreeLog.entity','ali','ChatLogService','deleteChatLog','maskEmail','416EwalXs','Content-Type','isGroup','rec','querAllDrawLog','createdAt','Not','function','9553320UIvNhN','replace','__esModule','set','assistant','__metadata','tencent','modelType','findOne','19524gRAEUh','formatDate','forEach','addRow','RedisCacheService','chatlog','exportExcel','del','role','userId','answer','../chatGroup/chatGroup.entity','querAllChatLog','用户名','/q/55','你操作的图片不存在、请检查！','components','music','extend','querDrawLog','chatLogEntity','@nine.com','columns','Content-Disposition','decorate','回答答案','Connection','chatList','email','@nestjs/typeorm','write','Injectable','363940MLZQhJ','group','find','object','HttpStatus','getOwnPropertyDescriptor','message_id','5600600zYvYZJ','addWorksheet'];_0x168b=function(){return _0x1e561e;};return _0x168b();}let ChatLogService=class ChatLogService{constructor(_0x446e0b,_0x5a5eda,_0x318a53,_0x3f1ec0,_0x51e7ff,_0x487d10,_0x440aa5){const _0x55829d=_0x2bef23;this[_0x55829d(0xaf)]=_0x446e0b,this['userEntity']=_0x5a5eda,this['chatGroupEntity']=_0x318a53,this[_0x55829d(0x101)]=_0x3f1ec0,this['connection']=_0x51e7ff,this['uploadService']=_0x487d10,this[_0x55829d(0xdb)]=_0x440aa5;}async['saveChatLog'](_0xbfc7ba){const _0x137767=_0x2bef23;return await this[_0x137767(0xaf)][_0x137767(0xc5)](_0xbfc7ba);}async[_0x2bef23(0xae)](_0x1b7d9d,_0x2cc4bb){const _0x25b333=_0x2bef23,{id:_0x5abfff}=_0x1b7d9d[_0x25b333(0x113)],{model:_0x2db1c8}=_0x2cc4bb,_0x2fc950={'userId':_0x5abfff,'type':balance_constant_1[_0x25b333(0xea)][_0x25b333(0xfd)]};_0x2db1c8&&(_0x2fc950['model']=_0x2db1c8);const _0x8bb2a3=await this[_0x25b333(0xaf)][_0x25b333(0xbd)]({'where':_0x2fc950,'order':{'id':_0x25b333(0xe4)},'select':['id',_0x25b333(0xa5),_0x25b333(0xd7),_0x25b333(0xc1),_0x25b333(0xbc),'model',_0x25b333(0xad),_0x25b333(0xf0)]});return _0x8bb2a3[_0x25b333(0x9d)](_0x980faf=>{const _0x123a23=_0x25b333;if(_0x980faf['type']===_0x123a23(0xfc)){const _0x3a5aa6=_0x980faf['model']==='mj'?0x136:0xa0,_0x217851=_0x980faf[_0x123a23(0xa5)]['includes']('cos')?_0x123a23(0x98):_0x123a23(0x116),_0x3588ba=_0x217851===_0x123a23(0x98)?_0x123a23(0xda)+_0x3a5aa6+_0x123a23(0xa9):_0x123a23(0xd1)+_0x3a5aa6;_0x980faf[_0x123a23(0x105)]=_0x980faf[_0x123a23(0xa5)]+_0x3588ba;const _0x416863=_0x980faf[_0x123a23(0xad)]?JSON[_0x123a23(0xeb)](_0x980faf['extend']):null;_0x416863&&(_0x416863?_0x980faf[_0x123a23(0x8c)]=_0x416863?.[_0x123a23(0xab)][0x0]?.[_0x123a23(0xab)]['length']===0x5:_0x980faf[_0x123a23(0x8c)]=![]);}}),_0x8bb2a3;}async[_0x2bef23(0x8e)](_0x85c682){const _0x283cd5=_0x2bef23,{page:page=0x1,size:size=0x14,rec:_0x1ed63e,userId:_0xcbdf18,model:_0x38113a}=_0x85c682,_0x40e3fa={'type':balance_constant_1[_0x283cd5(0xea)]['PAINT_TYPE'],'prompt':(0x0,typeorm_2['Not'])(''),'answer':(0x0,typeorm_2[_0x283cd5(0x90)])('')};_0x1ed63e&&Object[_0x283cd5(0xdf)](_0x40e3fa,{'rec':_0x1ed63e}),_0xcbdf18&&Object[_0x283cd5(0xdf)](_0x40e3fa,{'userId':_0xcbdf18}),_0x38113a&&Object[_0x283cd5(0xdf)](_0x40e3fa,{'model':_0x38113a});const [_0x46a61b,_0x5a4986]=await this['chatLogEntity'][_0x283cd5(0xf6)]({'order':{'id':_0x283cd5(0xe4)},'skip':(page-0x1)*size,'take':size,'where':_0x40e3fa});return _0x46a61b['forEach'](_0x1600c8=>{const _0x4b9a82=_0x283cd5;if(_0x1600c8[_0x4b9a82(0xf0)]===_0x4b9a82(0xfc)){const _0x541638=_0x1600c8['model']==='mj'?0x136:0xa0,_0x4bc59c=_0x1600c8[_0x4b9a82(0xa5)][_0x4b9a82(0x108)](_0x4b9a82(0x103))?'tencent':_0x4b9a82(0x116),_0x16ef59=_0x4bc59c==='tencent'?_0x4b9a82(0xda)+_0x541638+_0x4b9a82(0xa9):'?x-oss-process=image/resize,w_'+_0x541638;_0x1600c8[_0x4b9a82(0x105)]=_0x1600c8[_0x4b9a82(0xa5)]+_0x16ef59;const _0x292c99=_0x1600c8['extend']?JSON['parse'](_0x1600c8[_0x4b9a82(0xad)]):null;_0x292c99&&(_0x292c99?_0x1600c8[_0x4b9a82(0x8c)]=_0x292c99?.[_0x4b9a82(0xab)][0x0]?.['components'][_0x4b9a82(0xfb)]===0x5:_0x1600c8[_0x4b9a82(0x8c)]=![]);}}),{'rows':_0x46a61b,'count':_0x5a4986};}async['recDrawImg'](_0x159b76){const _0x294341=_0x2bef23,{id:_0x34491c}=_0x159b76,_0x579c41=await this[_0x294341(0xaf)][_0x294341(0x9a)]({'where':{'id':_0x34491c,'type':balance_constant_1[_0x294341(0xea)][_0x294341(0xfd)]}});if(!_0x579c41)throw new common_1[(_0x294341(0xef))](_0x294341(0xee),common_1[_0x294341(0xbf)]['BAD_REQUEST']);const _0x53163c=_0x579c41[_0x294341(0x8d)]===0x1?0x0:0x1,_0x4a3f24=await this[_0x294341(0xaf)][_0x294341(0xcd)]({'id':_0x34491c},{'rec':_0x53163c});if(_0x4a3f24['affected']>0x0)return(_0x53163c?'推荐':'取消推荐')+_0x294341(0xfa);throw new common_1[(_0x294341(0xef))](_0x294341(0xaa),common_1[_0x294341(0xbf)][_0x294341(0xdd)]);}async[_0x2bef23(0xa1)](_0x19845c,_0x39e032){const _0x5b5e63=_0x2bef23,_0x2d8591={'type':balance_constant_1[_0x5b5e63(0xea)][_0x5b5e63(0x110)]},{page:page=0x1,size:size=0x1e,prompt:_0x3f154c,email:_0x3c546f}=_0x19845c;_0x3f154c&&Object[_0x5b5e63(0xdf)](_0x2d8591,{'prompt':(0x0,typeorm_2[_0x5b5e63(0xca)])('%'+_0x3f154c+'%')});if(_0x3c546f){const _0x3a6450=await this[_0x5b5e63(0xd3)]['findOne']({'where':{'email':_0x3c546f}});_0x3a6450?.['id']&&Object[_0x5b5e63(0xdf)](_0x2d8591,{'userId':_0x3a6450['id']});}const [_0x3eb5c7,_0x4bb802]=await this[_0x5b5e63(0xaf)]['findAndCount']({'order':{'id':'DESC'},'skip':(page-0x1)*size,'take':size,'where':_0x2d8591}),_0x21e292=_0x3eb5c7[_0x5b5e63(0x111)](_0x1a79c3=>_0x1a79c3[_0x5b5e63(0xa4)]),_0x16c42d=await this[_0x5b5e63(0xd3)][_0x5b5e63(0xbd)]({'where':{'id':(0x0,typeorm_2['In'])(_0x21e292)}}),_0x26652a=_0x3eb5c7[_0x5b5e63(0x111)](_0x5dbea8=>{const _0x1ffd0b=_0x5b5e63,_0x30d4b1=_0x16c42d[_0x1ffd0b(0xbd)](_0x2e9f26=>_0x2e9f26['id']===_0x5dbea8[_0x1ffd0b(0xa4)]);return{'username':_0x30d4b1?_0x30d4b1[_0x1ffd0b(0xd5)]:'','email':_0x30d4b1?_0x30d4b1['email']:'','prompt':_0x5dbea8[_0x1ffd0b(0xd7)],'answer':_0x5dbea8[_0x1ffd0b(0xa5)],'createdAt':(0x0,utils_1[_0x1ffd0b(0x9c)])(_0x5dbea8[_0x1ffd0b(0x8f)])};}),_0x5107b4=new exceljs_1[(_0x5b5e63(0xcb))][(_0x5b5e63(0x10c))](),_0x3e6da8=_0x5107b4[_0x5b5e63(0xc3)](_0x5b5e63(0xa0));_0x3e6da8[_0x5b5e63(0xb1)]=[{'header':_0x5b5e63(0xa8),'key':_0x5b5e63(0xd5),'width':0x14},{'header':_0x5b5e63(0xe9),'key':_0x5b5e63(0xb7),'width':0x14},{'header':'提问时间','key':_0x5b5e63(0x8f),'width':0x14},{'header':_0x5b5e63(0x10b),'key':_0x5b5e63(0xd7),'width':0x50},{'header':_0x5b5e63(0xb4),'key':'answer','width':0x96}],_0x26652a[_0x5b5e63(0x9d)](_0x1b44df=>_0x3e6da8[_0x5b5e63(0x9e)](_0x1b44df)),_0x39e032[_0x5b5e63(0xf3)](_0x5b5e63(0x8b),'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'),_0x39e032['setHeader'](_0x5b5e63(0xb2),'attachment;\x20filename='+_0x5b5e63(0x106)),await _0x5107b4['xlsx'][_0x5b5e63(0xb9)](_0x39e032),_0x39e032[_0x5b5e63(0xf8)]();}async[_0x2bef23(0xa7)](_0x18fc9a,_0x6e5eed){const _0x5661e2=_0x2bef23,{page:page=0x1,size:size=0x14,userId:_0x28e264,prompt:_0x40892,modelType:_0x478a35}=_0x18fc9a,_0x16540d={'type':balance_constant_1[_0x5661e2(0xea)][_0x5661e2(0x110)],'prompt':(0x0,typeorm_2[_0x5661e2(0x90)])('')};_0x28e264&&Object['assign'](_0x16540d,{'userId':_0x28e264}),_0x40892&&Object['assign'](_0x16540d,{'prompt':(0x0,typeorm_2[_0x5661e2(0xca)])('%'+_0x40892+'%')});_0x478a35?_0x16540d[_0x5661e2(0x99)]=_0x478a35:_0x16540d[_0x5661e2(0x99)]=(0x0,typeorm_2['IsNull'])();const [_0x163a9c,_0x4214fd]=await this[_0x5661e2(0xaf)][_0x5661e2(0xf6)]({'order':{'id':_0x5661e2(0xe4)},'skip':(page-0x1)*size,'take':size,'where':_0x16540d}),_0x2e6d2b=_0x163a9c['map'](_0x44af78=>_0x44af78['userId']),_0x30bb27=await this[_0x5661e2(0xd3)]['find']({'where':{'id':(0x0,typeorm_2['In'])(_0x2e6d2b)},'select':['id',_0x5661e2(0xd5),_0x5661e2(0xb7)]});return _0x163a9c[_0x5661e2(0x9d)](_0x4e9b44=>{const _0x5448c7=_0x5661e2,{username:_0xc57969,email:_0x5a9f8f}=_0x30bb27['find'](_0x369033=>_0x369033['id']===_0x4e9b44['userId'])||{};_0x4e9b44[_0x5448c7(0xd5)]=_0xc57969,_0x4e9b44[_0x5448c7(0xb7)]=_0x5a9f8f;}),_0x6e5eed[_0x5661e2(0x113)][_0x5661e2(0xa3)]!==_0x5661e2(0xd0)&&_0x163a9c[_0x5661e2(0x9d)](_0x8d1b64=>_0x8d1b64[_0x5661e2(0xb7)]=(0x0,utils_1[_0x5661e2(0x119)])(_0x8d1b64[_0x5661e2(0xb7)])),_0x163a9c['forEach'](_0x4e32d2=>{const _0x5cf08d=_0x5661e2;!_0x4e32d2['email']&&(_0x4e32d2[_0x5cf08d(0xb7)]=_0x4e32d2?.[_0x5cf08d(0xa4)]+_0x5cf08d(0xb0)),!_0x4e32d2[_0x5cf08d(0xd5)]&&(_0x4e32d2[_0x5cf08d(0xd5)]='游客'+_0x4e32d2?.['userId']);}),{'rows':_0x163a9c,'count':_0x4214fd};}async[_0x2bef23(0xb6)](_0x12c614,_0x2dc742){const _0x196fff=_0x2bef23,{id:_0x189383}=_0x12c614['user'],{groupId:_0x2d12a6,logType:_0x179f31}=_0x2dc742,_0x5b1a77={'userId':_0x189383,'isDelete':![]};_0x2d12a6&&Object[_0x196fff(0xdf)](_0x5b1a77,{'groupId':_0x2d12a6}),_0x179f31&&Object[_0x196fff(0xdf)](_0x5b1a77,{'logType':_0x179f31});const _0x50af4a=await this['chatLogEntity'][_0x196fff(0xbd)]({'where':_0x5b1a77})[_0x196fff(0xc8)](_0x11dbee=>{const _0x34b6ab=_0x196fff;common_1[_0x34b6ab(0xc4)]['error'](_0x11dbee);});if(!_0x50af4a||_0x50af4a['length']===0x0)return[];return _0x50af4a[_0x196fff(0x111)](_0x5d6af2=>{const _0x5a14a3=_0x196fff,{prompt:_0x171ca0,role:_0x1cf501,answer:_0x4f6282,createdAt:_0x3d495c,model:_0x3b9b11,conversationOptions:_0x42c99e,requestOptions:_0x36f586,id:_0x324687}=_0x5d6af2;return{'chatId':_0x324687,'dateTime':(0x0,utils_1[_0x5a14a3(0x9c)])(_0x3d495c),'text':_0x1cf501===_0x5a14a3(0x113)?_0x171ca0:_0x4f6282,'inversion':_0x1cf501===_0x5a14a3(0x113),'error':![],'conversationOptions':_0x42c99e?JSON[_0x5a14a3(0xeb)](_0x42c99e):null,'requestOptions':_0x36f586?JSON[_0x5a14a3(0xeb)](_0x36f586):null};});}async[_0x2bef23(0xf9)](_0x88b167,_0x594f81){const _0x534684=_0x2bef23;try{const _0x700fdc={'isDelete':![],'answer':(0x0,typeorm_2[_0x534684(0x90)])((0x0,typeorm_2[_0x534684(0x104)])()),'modelType':_0x534684(0xac),'userId':_0x88b167[_0x534684(0x113)]['id']},[_0x4faaf9,_0x515756]=await this[_0x534684(0xaf)][_0x534684(0xf6)]({'where':_0x700fdc,'take':_0x594f81[_0x534684(0x10a)],'skip':(_0x594f81['page']-0x1)*_0x594f81['size'],'order':{'createdAt':'DESC'}}),_0x57b0ab=_0x4faaf9[_0x534684(0x111)](_0x2a611d=>_0x2a611d['id']),_0x461566=new Map();if(_0x57b0ab['length']){const _0x100872=await this[_0x534684(0x101)]['find']({'where':{'relateId':(0x0,typeorm_2['In'])(_0x57b0ab),'userId':_0x88b167[_0x534684(0x113)]['id']}});_0x100872[_0x534684(0x9d)](_0x3687f8=>{const _0x289c38=_0x534684;_0x461566[_0x289c38(0x95)](_0x3687f8['relateId'],_0x3687f8['action']);});}const _0x135757=_0x4faaf9[_0x534684(0x111)](_0x2fead0=>{const _0x5a6caf=_0x534684,{prompt:_0x14d75b,role:_0x298b8b,answer:_0x5f1eb5,createdAt:_0x520b9e,model:_0x5c3c1e,conversationOptions:_0x41e688,requestOptions:_0x3500d8,id:_0xc2bfcb}=_0x2fead0;return{'chatId':_0xc2bfcb,'error':![],'inversion':_0x298b8b===_0x5a6caf(0x113),'agree':_0x461566['get'](_0xc2bfcb)||null,'dateTime':(0x0,utils_1[_0x5a6caf(0x9c)])(_0x520b9e),'text':_0x298b8b===_0x5a6caf(0x113)?_0x14d75b:_0x5f1eb5,'requestOptions':_0x3500d8?JSON[_0x5a6caf(0xeb)](_0x3500d8):null,'conversationOptions':_0x41e688?JSON[_0x5a6caf(0xeb)](_0x41e688):null};});return{'count':_0x515756,'records':_0x135757};}catch(_0x5a81c0){throw new common_1[(_0x534684(0xef))](_0x5a81c0[_0x534684(0xcf)],common_1[_0x534684(0xbf)][_0x534684(0xdd)]);}}async['chatGptsList'](_0x42e330,_0x5f76f2){const _0x1b4e96=_0x2bef23,{id:_0x2fb3f0}=_0x42e330[_0x1b4e96(0x113)],{groupId:_0x48da8a}=_0x5f76f2,_0xa14129={'userId':_0x2fb3f0,'isDelete':![]};_0x48da8a&&Object[_0x1b4e96(0xdf)](_0xa14129,{'groupId':_0x48da8a});const _0x12771b=await this[_0x1b4e96(0xaf)][_0x1b4e96(0xbd)]({'where':_0xa14129});return _0x12771b[_0x1b4e96(0x111)](_0x39ace8=>{const _0x5c8370=_0x1b4e96,{prompt:_0x1a98f,role:_0x433c82,answer:_0x49a677,createdAt:_0x21333f,model:_0xd2dfff,conversationOptions:_0x3567c9,requestOptions:_0x5e7f3f,id:_0x18b218}=_0x39ace8;return{'chatId':_0x18b218,'dateTime':(0x0,utils_1[_0x5c8370(0x9c)])(_0x21333f),'text':_0x433c82==='user'?_0x1a98f:_0x49a677,'inversion':_0x433c82==='user','error':![],'conversationOptions':_0x3567c9?JSON[_0x5c8370(0xeb)](_0x3567c9):null,'requestOptions':_0x5e7f3f?JSON[_0x5c8370(0xeb)](_0x5e7f3f):null};});}async[_0x2bef23(0x118)](_0x54a9a8,_0xabf5dc){const _0x52c4fe=_0x2bef23,{id:_0x3e3961}=_0x54a9a8['user'],{id:_0x581a8c}=_0xabf5dc,_0x426040=await this['chatLogEntity'][_0x52c4fe(0x9a)]({'where':{'id':_0x581a8c,'userId':_0x3e3961}});if(!_0x426040)throw new common_1[(_0x52c4fe(0xef))](_0x52c4fe(0xe0),common_1['HttpStatus'][_0x52c4fe(0xdd)]);const _0x1faa67=await this[_0x52c4fe(0xaf)][_0x52c4fe(0xcd)]({'id':_0x581a8c},{'isDelete':!![]});if(_0x1faa67[_0x52c4fe(0xc9)]>0x0)return _0x52c4fe(0xd4);else throw new common_1[(_0x52c4fe(0xef))](_0x52c4fe(0xe0),common_1[_0x52c4fe(0xbf)][_0x52c4fe(0xdd)]);}async[_0x2bef23(0xe6)](_0x577a04,_0x468a3f){const _0x54e0a8=_0x2bef23,{groupId:_0x51f30d,type:_0x57d90e}=_0x468a3f,{id:_0x4ddc3b}=_0x577a04[_0x54e0a8(0x113)],_0x32d183=_0x57d90e&&_0x57d90e===_0x54e0a8(0xfe)?{'groupId':_0x51f30d,'userId':_0x4ddc3b}:{'groupId':_0x51f30d,'userId':_0x4ddc3b},_0x26d0f9=await this[_0x54e0a8(0xaf)][_0x54e0a8(0xcc)](_0x32d183);if(_0x26d0f9[_0x54e0a8(0xc9)]>0x0)return!![];if(_0x26d0f9['affected']===0x0)throw new common_1[(_0x54e0a8(0xef))](_0x54e0a8(0x100),common_1[_0x54e0a8(0xbf)][_0x54e0a8(0xdd)]);}async[_0x2bef23(0xf4)](_0x512e7a){const {ids:_0x44649c,userId:_0x37404a}=_0x512e7a;return await this['chatLogEntity']['delete']({'groupId':(0x0,typeorm_2['In'])(_0x44649c),'userId':_0x37404a});}async[_0x2bef23(0xe5)](_0x2fd223,_0x1c62c1){const _0x394ad2=_0x2bef23,{id:_0x1e93a9}=_0x2fd223[_0x394ad2(0x113)],{appId:_0x19eb8e,page:page=0x1,size:size=0xa}=_0x1c62c1,[_0x3235f3,_0x17b493]=await this[_0x394ad2(0xaf)][_0x394ad2(0xf6)]({'where':{'userId':_0x1e93a9,'appId':_0x19eb8e,'role':_0x394ad2(0x96)},'order':{'id':_0x394ad2(0xe4)},'take':size,'skip':(page-0x1)*size});return{'rows':_0x3235f3,'count':_0x17b493};}async[_0x2bef23(0xce)](){const _0x4c5540=_0x2bef23,_0x3a9c4d=await this['chatLogEntity']['find']({'where':{'modelType':'music','answer':(0x0,typeorm_2[_0x4c5540(0xca)])(_0x4c5540(0x107))}});for(let _0x269d5e=0x0;_0x269d5e<_0x3a9c4d[_0x4c5540(0xfb)];_0x269d5e++){const _0x37af2f=_0x3a9c4d[_0x269d5e];if(!_0x37af2f[_0x4c5540(0xa5)])continue;const _0x35e3f6=redisKey_constant_1[_0x4c5540(0xc7)]+_0x37af2f['id'];try{const _0x4433b0=await this[_0x4c5540(0xdb)]['get']({'key':_0x35e3f6});if(_0x4433b0)continue;await this['redisCacheService'][_0x4c5540(0x95)]({'key':_0x35e3f6,'val':_0x4c5540(0x10e)});const _0x887241=_0x37af2f['answer'][_0x4c5540(0xf2)](/https:\/\/filesystem.site\/cdn(.+)\)/g);if(!_0x887241)continue;const _0x39f141=Array['prototype']['slice'][_0x4c5540(0xec)](_0x887241)[_0x4c5540(0x111)](_0x3cadee=>_0x3cadee[_0x4c5540(0xd2)](0x0,_0x3cadee['length']-0x1));try{const _0xdbf91=await Promise[_0x4c5540(0xd9)](_0x39f141[_0x4c5540(0x111)](_0x5b8424=>this[_0x4c5540(0xe2)][_0x4c5540(0xe3)](_0x5b8424)));for(let _0x35cd12=0x0;_0x35cd12<_0xdbf91[_0x4c5540(0xfb)];_0x35cd12++){_0xdbf91[_0x35cd12]&&(_0x37af2f[_0x4c5540(0xa5)]=_0x37af2f[_0x4c5540(0xa5)][_0x4c5540(0x93)](_0x39f141[_0x35cd12],_0xdbf91[_0x35cd12]));}await this['chatLogEntity'][_0x4c5540(0xc5)](_0x37af2f);}catch(_0x4b060d){common_1[_0x4c5540(0xc4)]['error'](_0x4b060d);}}finally{await this[_0x4c5540(0xdb)][_0x4c5540(0xa2)]({'key':_0x35e3f6});}}}};ChatLogService=__decorate([(0x0,common_1[_0x2bef23(0xba)])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(chatLog_entity_1['ChatLogEntity'])),__param(0x1,(0x0,typeorm_1[_0x2bef23(0xff)])(user_entity_1['UserEntity'])),__param(0x2,(0x0,typeorm_1[_0x2bef23(0xff)])(chatGroup_entity_1[_0x2bef23(0xd8)])),__param(0x3,(0x0,typeorm_1[_0x2bef23(0xff)])(aiAgreeLog_entity_1[_0x2bef23(0xf7)])),__metadata('design:paramtypes',[typeorm_2[_0x2bef23(0x102)],typeorm_2[_0x2bef23(0x102)],typeorm_2[_0x2bef23(0x102)],typeorm_2[_0x2bef23(0x102)],typeorm_2[_0x2bef23(0xb5)],upload_service_1[_0x2bef23(0xde)],redisCache_service_1[_0x2bef23(0x9f)]])],ChatLogService),exports[_0x2bef23(0x117)]=ChatLogService;