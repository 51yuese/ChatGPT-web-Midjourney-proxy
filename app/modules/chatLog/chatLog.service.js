'use strict';function _0x20b4(_0x10b429,_0x29130d){const _0x587a8c=_0x587a();return _0x20b4=function(_0x20b4e3,_0x58a197){_0x20b4e3=_0x20b4e3-0x1cf;let _0xac2a2b=_0x587a8c[_0x20b4e3];return _0xac2a2b;},_0x20b4(_0x10b429,_0x29130d);}const _0x16aeea=_0x20b4;(function(_0x311016,_0x449371){const _0x4939df=_0x20b4,_0x52ea98=_0x311016();while(!![]){try{const _0x50ed70=parseInt(_0x4939df(0x1da))/0x1+parseInt(_0x4939df(0x1db))/0x2*(-parseInt(_0x4939df(0x1dd))/0x3)+parseInt(_0x4939df(0x1e2))/0x4+parseInt(_0x4939df(0x21e))/0x5*(-parseInt(_0x4939df(0x1d5))/0x6)+parseInt(_0x4939df(0x1e7))/0x7*(parseInt(_0x4939df(0x231))/0x8)+parseInt(_0x4939df(0x216))/0x9+-parseInt(_0x4939df(0x20e))/0xa;if(_0x50ed70===_0x449371)break;else _0x52ea98['push'](_0x52ea98['shift']());}catch(_0x900bad){_0x52ea98['push'](_0x52ea98['shift']());}}}(_0x587a,0xab7bd));var __decorate=this&&this['__decorate']||function(_0x306416,_0x5a1054,_0x5a31e0,_0x5a205d){const _0x3d8e44=_0x20b4;var _0x22dc59=arguments[_0x3d8e44(0x1d9)],_0xa4d772=_0x22dc59<0x3?_0x5a1054:_0x5a205d===null?_0x5a205d=Object[_0x3d8e44(0x23c)](_0x5a1054,_0x5a31e0):_0x5a205d,_0x3faf22;if(typeof Reflect==='object'&&typeof Reflect['decorate']===_0x3d8e44(0x217))_0xa4d772=Reflect[_0x3d8e44(0x234)](_0x306416,_0x5a1054,_0x5a31e0,_0x5a205d);else{for(var _0xaf9d1f=_0x306416[_0x3d8e44(0x1d9)]-0x1;_0xaf9d1f>=0x0;_0xaf9d1f--)if(_0x3faf22=_0x306416[_0xaf9d1f])_0xa4d772=(_0x22dc59<0x3?_0x3faf22(_0xa4d772):_0x22dc59>0x3?_0x3faf22(_0x5a1054,_0x5a31e0,_0xa4d772):_0x3faf22(_0x5a1054,_0x5a31e0))||_0xa4d772;}return _0x22dc59>0x3&&_0xa4d772&&Object[_0x3d8e44(0x1d2)](_0x5a1054,_0x5a31e0,_0xa4d772),_0xa4d772;},__metadata=this&&this[_0x16aeea(0x20c)]||function(_0x2278c8,_0x54bd5b){const _0x58dc5b=_0x16aeea;if(typeof Reflect===_0x58dc5b(0x22f)&&typeof Reflect[_0x58dc5b(0x1ec)]===_0x58dc5b(0x217))return Reflect['metadata'](_0x2278c8,_0x54bd5b);},__param=this&&this[_0x16aeea(0x1f1)]||function(_0x2989b3,_0x3ecd5b){return function(_0x37a23f,_0x9fe20a){_0x3ecd5b(_0x37a23f,_0x9fe20a,_0x2989b3);};};Object[_0x16aeea(0x1d2)](exports,_0x16aeea(0x21f),{'value':!![]}),exports[_0x16aeea(0x20d)]=void 0x0;const common_1=require('@nestjs/common'),typeorm_1=require(_0x16aeea(0x1f4)),chatLog_entity_1=require(_0x16aeea(0x214)),typeorm_2=require(_0x16aeea(0x1cf)),balance_constant_1=require(_0x16aeea(0x21b)),user_entity_1=require('../user/user.entity'),utils_1=require('../../common/utils'),exceljs_1=require('exceljs'),chatGroup_entity_1=require(_0x16aeea(0x1d6));let ChatLogService=class ChatLogService{constructor(_0x4a60b7,_0x506032,_0x36fc9d){const _0x256d06=_0x16aeea;this[_0x256d06(0x1ea)]=_0x4a60b7,this[_0x256d06(0x204)]=_0x506032,this[_0x256d06(0x223)]=_0x36fc9d;}async[_0x16aeea(0x238)](_0x24ae71){const _0x2da8ef=_0x16aeea;return await this[_0x2da8ef(0x1ea)][_0x2da8ef(0x21d)](_0x24ae71);}async[_0x16aeea(0x1d3)](_0x13dc28,_0x534863){const _0x2b6764=_0x16aeea,{id:_0x12ce61}=_0x13dc28['user'],{model:_0x26d394}=_0x534863,_0x2a9007={'userId':_0x12ce61,'type':balance_constant_1['DeductionKey'][_0x2b6764(0x1d0)]};_0x26d394&&(_0x2a9007[_0x2b6764(0x208)]=_0x26d394);const _0x12b44c=await this[_0x2b6764(0x1ea)][_0x2b6764(0x230)]({'where':_0x2a9007,'order':{'id':_0x2b6764(0x23b)},'select':['id','answer',_0x2b6764(0x22e),_0x2b6764(0x20f),_0x2b6764(0x222),'model','extend',_0x2b6764(0x235)]});return _0x12b44c[_0x2b6764(0x1e3)](_0x5cc353=>{const _0xdae1cc=_0x2b6764;var _0x26a280;if(_0x5cc353[_0xdae1cc(0x235)]===_0xdae1cc(0x1f9)){const _0xca03be=_0x5cc353[_0xdae1cc(0x208)]==='mj'?0x136:0xa0,_0x13a6a4=_0x5cc353['answer'][_0xdae1cc(0x1ef)](_0xdae1cc(0x1fb))?_0xdae1cc(0x22a):_0xdae1cc(0x202),_0x29e8f0=_0x13a6a4===_0xdae1cc(0x22a)?_0xdae1cc(0x210)+_0xca03be+_0xdae1cc(0x1de):'?x-oss-process=image/resize,w_'+_0xca03be;_0x5cc353[_0xdae1cc(0x209)]=_0x5cc353['answer']+_0x29e8f0;const _0x47be97=_0x5cc353[_0xdae1cc(0x1fd)]?JSON[_0xdae1cc(0x1e1)](_0x5cc353['extend']):null;_0x47be97&&(_0x47be97?_0x5cc353[_0xdae1cc(0x224)]=((_0x26a280=_0x47be97===null||_0x47be97===void 0x0?void 0x0:_0x47be97[_0xdae1cc(0x1f0)][0x0])===null||_0x26a280===void 0x0?void 0x0:_0x26a280[_0xdae1cc(0x1f0)][_0xdae1cc(0x1d9)])===0x5:_0x5cc353[_0xdae1cc(0x224)]=![]);}}),_0x12b44c;}async[_0x16aeea(0x20b)](_0xd39616){const _0x4fc777=_0x16aeea,{page:page=0x1,size:size=0x14,rec:_0x4d8531,userId:_0x26bda0,model:_0x1f51c5}=_0xd39616,_0x2881a1={'type':balance_constant_1[_0x4fc777(0x20a)][_0x4fc777(0x1d0)],'prompt':(0x0,typeorm_2[_0x4fc777(0x1e8)])(''),'answer':(0x0,typeorm_2[_0x4fc777(0x1e8)])('')};_0x4d8531&&Object[_0x4fc777(0x226)](_0x2881a1,{'rec':_0x4d8531}),_0x26bda0&&Object[_0x4fc777(0x226)](_0x2881a1,{'userId':_0x26bda0}),_0x1f51c5&&Object['assign'](_0x2881a1,{'model':_0x1f51c5});const [_0xe25c4a,_0x1ac32a]=await this['chatLogEntity']['findAndCount']({'order':{'id':_0x4fc777(0x23b)},'skip':(page-0x1)*size,'take':size,'where':_0x2881a1});return _0xe25c4a[_0x4fc777(0x1e3)](_0x2a205c=>{const _0xa29b44=_0x4fc777;var _0x433644;if(_0x2a205c[_0xa29b44(0x235)]===_0xa29b44(0x1f9)){const _0x4c239b=_0x2a205c['model']==='mj'?0x136:0xa0,_0x2d2165=_0x2a205c[_0xa29b44(0x1e5)]['includes'](_0xa29b44(0x1fb))?_0xa29b44(0x22a):'ali',_0x968ae=_0x2d2165===_0xa29b44(0x22a)?_0xa29b44(0x210)+_0x4c239b+_0xa29b44(0x1de):'?x-oss-process=image/resize,w_'+_0x4c239b;_0x2a205c[_0xa29b44(0x209)]=_0x2a205c['answer']+_0x968ae;const _0x2804b2=_0x2a205c[_0xa29b44(0x1fd)]?JSON[_0xa29b44(0x1e1)](_0x2a205c['extend']):null;_0x2804b2&&(_0x2804b2?_0x2a205c[_0xa29b44(0x224)]=((_0x433644=_0x2804b2===null||_0x2804b2===void 0x0?void 0x0:_0x2804b2['components'][0x0])===null||_0x433644===void 0x0?void 0x0:_0x433644[_0xa29b44(0x1f0)]['length'])===0x5:_0x2a205c[_0xa29b44(0x224)]=![]);}}),{'rows':_0xe25c4a,'count':_0x1ac32a};}async[_0x16aeea(0x1e4)](_0x53e04b){const _0x388a18=_0x16aeea,{id:_0x5567d9}=_0x53e04b,_0x5d18f5=await this[_0x388a18(0x1ea)][_0x388a18(0x1fc)]({'where':{'id':_0x5567d9,'type':balance_constant_1[_0x388a18(0x20a)][_0x388a18(0x1d0)]}});if(!_0x5d18f5)throw new common_1[(_0x388a18(0x221))](_0x388a18(0x23a),common_1[_0x388a18(0x22d)][_0x388a18(0x1ed)]);const _0x35aeb2=_0x5d18f5[_0x388a18(0x229)]===0x1?0x0:0x1,_0x595c1e=await this[_0x388a18(0x1ea)]['update']({'id':_0x5567d9},{'rec':_0x35aeb2});if(_0x595c1e[_0x388a18(0x228)]>0x0)return(_0x35aeb2?'推荐':'取消推荐')+_0x388a18(0x1ee);throw new common_1[(_0x388a18(0x221))](_0x388a18(0x1fa),common_1[_0x388a18(0x22d)][_0x388a18(0x1ed)]);}async[_0x16aeea(0x203)](_0x43989c,_0x4f85de){const _0xf15ff9=_0x16aeea,_0xb81534={'type':balance_constant_1['DeductionKey'][_0xf15ff9(0x1d8)]},{page:page=0x1,size:size=0x1e,prompt:_0x39337c,email:_0x38be32}=_0x43989c;_0x39337c&&Object['assign'](_0xb81534,{'prompt':(0x0,typeorm_2[_0xf15ff9(0x211)])('%'+_0x39337c+'%')});if(_0x38be32){const _0x178d54=await this[_0xf15ff9(0x204)]['findOne']({'where':{'email':_0x38be32}});(_0x178d54===null||_0x178d54===void 0x0?void 0x0:_0x178d54['id'])&&Object[_0xf15ff9(0x226)](_0xb81534,{'userId':_0x178d54['id']});}const [_0x215e48,_0x355c76]=await this['chatLogEntity'][_0xf15ff9(0x1f6)]({'order':{'id':'DESC'},'skip':(page-0x1)*size,'take':size,'where':_0xb81534}),_0x12b132=_0x215e48[_0xf15ff9(0x219)](_0x231861=>_0x231861[_0xf15ff9(0x1ff)]),_0x1a5ba1=await this[_0xf15ff9(0x204)][_0xf15ff9(0x230)]({'where':{'id':(0x0,typeorm_2['In'])(_0x12b132)}}),_0x48ea3f=_0x215e48['map'](_0x1c1932=>{const _0x27abcd=_0xf15ff9,_0x4fdf58=_0x1a5ba1[_0x27abcd(0x230)](_0x442def=>_0x442def['id']===_0x1c1932['userId']);return{'username':_0x4fdf58?_0x4fdf58['username']:'','email':_0x4fdf58?_0x4fdf58['email']:'','prompt':_0x1c1932[_0x27abcd(0x22e)],'answer':_0x1c1932[_0x27abcd(0x1e5)],'createdAt':(0x0,utils_1[_0x27abcd(0x1d7)])(_0x1c1932[_0x27abcd(0x233)])};}),_0x455b57=new exceljs_1['default'][(_0xf15ff9(0x205))](),_0x454dc5=_0x455b57[_0xf15ff9(0x1eb)](_0xf15ff9(0x206));_0x454dc5[_0xf15ff9(0x227)]=[{'header':_0xf15ff9(0x237),'key':_0xf15ff9(0x220),'width':0x14},{'header':'用户邮箱','key':_0xf15ff9(0x1f7),'width':0x14},{'header':'提问时间','key':_0xf15ff9(0x233),'width':0x14},{'header':_0xf15ff9(0x1dc),'key':'prompt','width':0x50},{'header':_0xf15ff9(0x1d4),'key':'answer','width':0x96}],_0x48ea3f['forEach'](_0x4e1d21=>_0x454dc5['addRow'](_0x4e1d21)),_0x4f85de[_0xf15ff9(0x1e6)](_0xf15ff9(0x1e9),_0xf15ff9(0x21a)),_0x4f85de[_0xf15ff9(0x1e6)]('Content-Disposition',_0xf15ff9(0x213)+_0xf15ff9(0x215)),await _0x455b57[_0xf15ff9(0x22c)][_0xf15ff9(0x1f3)](_0x4f85de),_0x4f85de[_0xf15ff9(0x218)]();}async[_0x16aeea(0x207)](_0x5e8cc5,_0xdf001a){const _0x4edf01=_0x16aeea,{page:page=0x1,size:size=0x14,userId:_0x2c6d9a,prompt:_0x2d2487}=_0x5e8cc5,_0x27e9a1={'type':balance_constant_1['DeductionKey']['CHAT_TYPE'],'prompt':(0x0,typeorm_2[_0x4edf01(0x1e8)])('')};_0x2c6d9a&&Object[_0x4edf01(0x226)](_0x27e9a1,{'userId':_0x2c6d9a}),_0x2d2487&&Object[_0x4edf01(0x226)](_0x27e9a1,{'prompt':(0x0,typeorm_2['Like'])('%'+_0x2d2487+'%')});const [_0x2c6501,_0x12ca31]=await this[_0x4edf01(0x1ea)][_0x4edf01(0x1f6)]({'order':{'id':_0x4edf01(0x23b)},'skip':(page-0x1)*size,'take':size,'where':_0x27e9a1}),_0x38f383=_0x2c6501[_0x4edf01(0x219)](_0x4bf714=>_0x4bf714[_0x4edf01(0x1ff)]),_0x5dde3a=await this[_0x4edf01(0x204)]['find']({'where':{'id':(0x0,typeorm_2['In'])(_0x38f383)},'select':['id',_0x4edf01(0x220),_0x4edf01(0x1f7)]});return _0x2c6501[_0x4edf01(0x1e3)](_0x369b4c=>{const _0x37f710=_0x4edf01,{username:_0x3d28c2,email:_0x33b868}=_0x5dde3a[_0x37f710(0x230)](_0x191918=>_0x191918['id']===_0x369b4c[_0x37f710(0x1ff)])||{};_0x369b4c['username']=_0x3d28c2,_0x369b4c[_0x37f710(0x1f7)]=_0x33b868;}),_0xdf001a[_0x4edf01(0x225)][_0x4edf01(0x22b)]!==_0x4edf01(0x1d1)&&_0x2c6501[_0x4edf01(0x1e3)](_0x1f0719=>_0x1f0719[_0x4edf01(0x1f7)]=(0x0,utils_1[_0x4edf01(0x212)])(_0x1f0719[_0x4edf01(0x1f7)])),_0x2c6501['forEach'](_0x158f04=>{const _0x4f3aa6=_0x4edf01;!_0x158f04[_0x4f3aa6(0x1f7)]&&(_0x158f04[_0x4f3aa6(0x1f7)]=(_0x158f04===null||_0x158f04===void 0x0?void 0x0:_0x158f04[_0x4f3aa6(0x1ff)])+'@nine.com'),!_0x158f04[_0x4f3aa6(0x220)]&&(_0x158f04[_0x4f3aa6(0x220)]='游客'+(_0x158f04===null||_0x158f04===void 0x0?void 0x0:_0x158f04[_0x4f3aa6(0x1ff)]));}),{'rows':_0x2c6501,'count':_0x12ca31};}async['chatList'](_0x145c90,_0x12996f){const _0x1b6746=_0x16aeea,{id:_0x28dfda}=_0x145c90[_0x1b6746(0x225)],{groupId:_0x437493}=_0x12996f,_0xd90c02={'userId':_0x28dfda,'isDelete':![]};_0x437493&&Object['assign'](_0xd90c02,{'groupId':_0x437493});if(_0x437493){const _0x8f51c9=await this['chatGroupEntity'][_0x1b6746(0x1fe)]({'where':{'isDelete':![]}});if(_0x8f51c9===0x0)return[];}const _0x2857dd=await this[_0x1b6746(0x1ea)]['find']({'where':_0xd90c02});return _0x2857dd[_0x1b6746(0x219)](_0x25dffc=>{const _0x52d2e8=_0x1b6746,{prompt:_0x27da14,role:_0x8f7806,answer:_0x23d3f4,createdAt:_0x3a2aec,model:_0x4deff0,conversationOptions:_0x4e4de5,requestOptions:_0x12b909,id:_0x28bad3}=_0x25dffc;return{'chatId':_0x28bad3,'dateTime':(0x0,utils_1[_0x52d2e8(0x1d7)])(_0x3a2aec),'text':_0x8f7806===_0x52d2e8(0x225)?_0x27da14:_0x23d3f4,'inversion':_0x8f7806==='user','error':![],'conversationOptions':_0x4e4de5?JSON['parse'](_0x4e4de5):null,'requestOptions':_0x12b909?JSON[_0x52d2e8(0x1e1)](_0x12b909):null};});}async['deleteChatLog'](_0x316a00,_0x51617c){const _0x4ca6b8=_0x16aeea,{id:_0x20b761}=_0x316a00['user'],{id:_0xd44c3b}=_0x51617c,_0x2d5ba4=await this['chatLogEntity']['findOne']({'where':{'id':_0xd44c3b,'userId':_0x20b761}});if(!_0x2d5ba4)throw new common_1[(_0x4ca6b8(0x221))](_0x4ca6b8(0x1f8),common_1[_0x4ca6b8(0x22d)]['BAD_REQUEST']);const _0x42c4ac=await this[_0x4ca6b8(0x1ea)][_0x4ca6b8(0x232)]({'id':_0xd44c3b},{'isDelete':!![]});if(_0x42c4ac['affected']>0x0)return _0x4ca6b8(0x21c);else throw new common_1[(_0x4ca6b8(0x221))]('你删除的对话记录不存在、请检查！',common_1[_0x4ca6b8(0x22d)]['BAD_REQUEST']);}async[_0x16aeea(0x200)](_0x3be923,_0x4577e5){const _0x1caf96=_0x16aeea,{groupId:_0x43b103}=_0x4577e5,{id:_0x2db702}=_0x3be923[_0x1caf96(0x225)],_0xd13fc8=await this[_0x1caf96(0x223)][_0x1caf96(0x1fc)]({'where':{'id':_0x43b103,'userId':_0x2db702}});if(!_0xd13fc8)throw new common_1[(_0x1caf96(0x221))]('你删除的对话记录不存在、请检查！',common_1['HttpStatus'][_0x1caf96(0x1ed)]);const _0x428d6a=await this['chatLogEntity']['update']({'groupId':_0x43b103},{'isDelete':!![]});if(_0x428d6a[_0x1caf96(0x228)]>0x0)return _0x1caf96(0x21c);if(_0x428d6a[_0x1caf96(0x228)]===0x0)throw new common_1[(_0x1caf96(0x221))](_0x1caf96(0x201),common_1[_0x1caf96(0x22d)]['BAD_REQUEST']);}async[_0x16aeea(0x1f2)](_0x428fbd,_0x63ddcd){const _0x291b96=_0x16aeea,{id:_0x4f0f04}=_0x428fbd['user'],{appId:_0x1714e2,page:page=0x1,size:size=0xa}=_0x63ddcd,[_0x590deb,_0x55f8b3]=await this[_0x291b96(0x1ea)][_0x291b96(0x1f6)]({'where':{'userId':_0x4f0f04,'appId':_0x1714e2,'role':_0x291b96(0x239)},'order':{'id':_0x291b96(0x23b)},'take':size,'skip':(page-0x1)*size});return{'rows':_0x590deb,'count':_0x55f8b3};}};ChatLogService=__decorate([(0x0,common_1[_0x16aeea(0x1e0)])(),__param(0x0,(0x0,typeorm_1[_0x16aeea(0x236)])(chatLog_entity_1[_0x16aeea(0x1f5)])),__param(0x1,(0x0,typeorm_1['InjectRepository'])(user_entity_1['UserEntity'])),__param(0x2,(0x0,typeorm_1['InjectRepository'])(chatGroup_entity_1['ChatGroupEntity'])),__metadata('design:paramtypes',[typeorm_2[_0x16aeea(0x1df)],typeorm_2[_0x16aeea(0x1df)],typeorm_2['Repository']])],ChatLogService),exports[_0x16aeea(0x20d)]=ChatLogService;function _0x587a(){const _0x225c7a=['你推荐的图片不存在、请检查！','DESC','getOwnPropertyDescriptor','typeorm','PAINT_TYPE','super','defineProperty','querDrawLog','回答答案','6uVegoM','../chatGroup/chatGroup.entity','formatDate','CHAT_TYPE','length','1360632HPPYfv','113054yhgvLS','提问问题','66qlsucb','/q/55','Repository','Injectable','parse','1365264gmlcba','forEach','recDrawImg','answer','setHeader','553ZadSvw','Not','Content-Type','chatLogEntity','addWorksheet','metadata','BAD_REQUEST','图片成功！','includes','components','__param','byAppId','write','@nestjs/typeorm','ChatLogEntity','findAndCount','email','你删除的对话记录不存在、请检查！','paintCount','你操作的图片不存在、请检查！','cos','findOne','extend','count','userId','delByGroupId','当前页面已经没有东西可以删除了！','ali','exportExcel','userEntity','Workbook','chatlog','querAllChatLog','model','thumbImg','DeductionKey','querAllDrawLog','__metadata','ChatLogService','13571930Hhnfja','message_id','?imageView2/1/w/','Like','maskEmail','attachment;\x20filename=','./chatLog.entity','chat.xlsx','10700694auDzLk','function','end','map','application/vnd.openxmlformats-officedocument.spreadsheetml.sheet','../../common/constants/balance.constant','删除对话记录成功！','save','3804795mnwEPV','__esModule','username','HttpException','group','chatGroupEntity','isGroup','user','assign','columns','affected','rec','tencent','role','xlsx','HttpStatus','prompt','object','find','118808mZEsBy','update','createdAt','decorate','type','InjectRepository','用户名','saveChatLog','assistant'];_0x587a=function(){return _0x225c7a;};return _0x587a();}