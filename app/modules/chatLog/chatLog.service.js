'use strict';function _0x550a(_0x1b3d03,_0x5eab52){const _0x174b4b=_0x174b();return _0x550a=function(_0x550a7c,_0x391886){_0x550a7c=_0x550a7c-0xb7;let _0x498e34=_0x174b4b[_0x550a7c];return _0x498e34;},_0x550a(_0x1b3d03,_0x5eab52);}const _0x1777da=_0x550a;(function(_0x297b56,_0x2b713d){const _0x527bac=_0x550a,_0x477667=_0x297b56();while(!![]){try{const _0x213da1=-parseInt(_0x527bac(0x11b))/0x1*(-parseInt(_0x527bac(0xb7))/0x2)+-parseInt(_0x527bac(0xde))/0x3+parseInt(_0x527bac(0x113))/0x4+parseInt(_0x527bac(0x138))/0x5+-parseInt(_0x527bac(0x132))/0x6+-parseInt(_0x527bac(0xd4))/0x7+parseInt(_0x527bac(0x10b))/0x8;if(_0x213da1===_0x2b713d)break;else _0x477667['push'](_0x477667['shift']());}catch(_0x21a10c){_0x477667['push'](_0x477667['shift']());}}}(_0x174b,0x85c00));function _0x174b(){const _0x2bbc02=['RedisCacheService','../aiLog/aiAgreeLog.entity','design:paramtypes','exportExcel','catch','__decorate','page','syncMusic','set','role','Like','email','transferFile','/q/55','6333216LzHUmd','aiAgreeLogEntity','maskEmail','typeorm','map','__param','1183255QLJYRL','recDrawImg','slice','isGroup','tencent','ChatLogService','prompt','../redisCache/redisCache.service','uploadService','BAD_REQUEST','addRow','defineProperty','write','1516850CwvCOB','model','Content-Disposition','type','save','../user/user.entity','%filesystem.site%','modelType','InjectRepository','HttpException','chatGroupEntity','userEntity','@nestjs/typeorm','match','assistant','rec','取消推荐','chat.xlsx','redisCacheService','findAndCount','columns','update','xlsx','deleteChatLog','components','Repository','?imageView2/1/w/','chatList','formatDate','6804602lzAvdj','delete','affected','提问问题','createdAt','setHeader','你操作的图片不存在、请检查！','__esModule','userId','musicLog','1645044YeUAkl','default','PAINT_TYPE','assign','find','IsNull','@nestjs/common','提问时间','super','group','用户名','Not','object','substring','connection','call','../chatGroup/chatGroup.entity','DESC','querAllChatLog','del','MUSIC_TRANSFER','../../common/utils','@nine.com','Logger','music','ali','thumbImg','decorate','username','DeductionKey','attachment;\x20filename=','message_id','getOwnPropertyDescriptor','relateId','chatLogEntity','extend','size','Workbook','user','includes','forEach','?x-oss-process=image/resize,w_','chatGptsList','querDrawLog','answer','9341232SRSgAn','function','__metadata','findOne','all','length','end','../../common/constants/balance.constant','3844320LVWJns','你删除的对话记录不存在、请检查！','你推荐的图片不存在、请检查！','./chatLog.entity','saveChatLog','lock','application/vnd.openxmlformats-officedocument.spreadsheetml.sheet','cos','1dKtMBo','CHAT_TYPE','ChatGroupEntity','error','HttpStatus','querAllDrawLog','metadata','parse','UploadService'];_0x174b=function(){return _0x2bbc02;};return _0x174b();}var __decorate=this&&this[_0x1777da(0x129)]||function(_0x15b59f,_0x19bc30,_0x4ef08d,_0x1780d5){const _0x41a6d3=_0x1777da;var _0x5b734e=arguments[_0x41a6d3(0x110)],_0x65c4e1=_0x5b734e<0x3?_0x19bc30:_0x1780d5===null?_0x1780d5=Object[_0x41a6d3(0xfe)](_0x19bc30,_0x4ef08d):_0x1780d5,_0x51126a;if(typeof Reflect===_0x41a6d3(0xea)&&typeof Reflect[_0x41a6d3(0xf9)]===_0x41a6d3(0x10c))_0x65c4e1=Reflect[_0x41a6d3(0xf9)](_0x15b59f,_0x19bc30,_0x4ef08d,_0x1780d5);else{for(var _0x3b77bd=_0x15b59f[_0x41a6d3(0x110)]-0x1;_0x3b77bd>=0x0;_0x3b77bd--)if(_0x51126a=_0x15b59f[_0x3b77bd])_0x65c4e1=(_0x5b734e<0x3?_0x51126a(_0x65c4e1):_0x5b734e>0x3?_0x51126a(_0x19bc30,_0x4ef08d,_0x65c4e1):_0x51126a(_0x19bc30,_0x4ef08d))||_0x65c4e1;}return _0x5b734e>0x3&&_0x65c4e1&&Object[_0x41a6d3(0x143)](_0x19bc30,_0x4ef08d,_0x65c4e1),_0x65c4e1;},__metadata=this&&this[_0x1777da(0x10d)]||function(_0x36bd9f,_0x38a8b9){const _0x1b9d30=_0x1777da;if(typeof Reflect===_0x1b9d30(0xea)&&typeof Reflect[_0x1b9d30(0x121)]===_0x1b9d30(0x10c))return Reflect['metadata'](_0x36bd9f,_0x38a8b9);},__param=this&&this[_0x1777da(0x137)]||function(_0x2eb5f8,_0x1766f2){return function(_0x6f5c9d,_0xe68059){_0x1766f2(_0x6f5c9d,_0xe68059,_0x2eb5f8);};};Object['defineProperty'](exports,_0x1777da(0xdb),{'value':!![]}),exports[_0x1777da(0x13d)]=void 0x0;const common_1=require(_0x1777da(0xe4)),typeorm_1=require(_0x1777da(0xc3)),chatLog_entity_1=require(_0x1777da(0x116)),typeorm_2=require(_0x1777da(0x135)),balance_constant_1=require(_0x1777da(0x112)),user_entity_1=require(_0x1777da(0xbc)),utils_1=require(_0x1777da(0xf3)),exceljs_1=require('exceljs'),chatGroup_entity_1=require(_0x1777da(0xee)),upload_service_1=require('../upload/upload.service'),redisCache_service_1=require(_0x1777da(0x13f)),redisKey_constant_1=require('../../common/constants/redisKey.constant'),aiAgreeLog_entity_1=require(_0x1777da(0x125));let ChatLogService=class ChatLogService{constructor(_0x28bd56,_0x52ca38,_0x2dcf94,_0x3d813d,_0x43f349,_0x3ac917,_0x5c054e){const _0x43363b=_0x1777da;this['chatLogEntity']=_0x28bd56,this[_0x43363b(0xc2)]=_0x52ca38,this[_0x43363b(0xc1)]=_0x2dcf94,this[_0x43363b(0x133)]=_0x3d813d,this[_0x43363b(0xec)]=_0x43f349,this[_0x43363b(0x140)]=_0x3ac917,this[_0x43363b(0xc9)]=_0x5c054e;}async[_0x1777da(0x117)](_0x528b03){const _0x21d31e=_0x1777da;return await this[_0x21d31e(0x100)][_0x21d31e(0xbb)](_0x528b03);}async[_0x1777da(0x109)](_0x1b30ea,_0x2f7247){const _0x157e13=_0x1777da,{id:_0x53ddb4}=_0x1b30ea[_0x157e13(0x104)],{model:_0x29267a}=_0x2f7247,_0x2d6875={'userId':_0x53ddb4,'type':balance_constant_1[_0x157e13(0xfb)][_0x157e13(0xe0)]};_0x29267a&&(_0x2d6875[_0x157e13(0xb8)]=_0x29267a);const _0x4f0ec8=await this[_0x157e13(0x100)][_0x157e13(0xe2)]({'where':_0x2d6875,'order':{'id':_0x157e13(0xef)},'select':['id',_0x157e13(0x10a),_0x157e13(0x13e),_0x157e13(0xfd),_0x157e13(0xe7),_0x157e13(0xb8),_0x157e13(0x101),_0x157e13(0xba)]});return _0x4f0ec8[_0x157e13(0x106)](_0x32e3a1=>{const _0x541efb=_0x157e13;if(_0x32e3a1[_0x541efb(0xba)]==='paintCount'){const _0x519569=_0x32e3a1[_0x541efb(0xb8)]==='mj'?0x136:0xa0,_0x98d930=_0x32e3a1['answer']['includes'](_0x541efb(0x11a))?'tencent':_0x541efb(0xf7),_0x5a9798=_0x98d930===_0x541efb(0x13c)?_0x541efb(0xd1)+_0x519569+_0x541efb(0x131):'?x-oss-process=image/resize,w_'+_0x519569;_0x32e3a1[_0x541efb(0xf8)]=_0x32e3a1[_0x541efb(0x10a)]+_0x5a9798;const _0x1232f6=_0x32e3a1[_0x541efb(0x101)]?JSON[_0x541efb(0x122)](_0x32e3a1[_0x541efb(0x101)]):null;_0x1232f6&&(_0x1232f6?_0x32e3a1[_0x541efb(0x13b)]=_0x1232f6?.[_0x541efb(0xcf)][0x0]?.[_0x541efb(0xcf)][_0x541efb(0x110)]===0x5:_0x32e3a1[_0x541efb(0x13b)]=![]);}}),_0x4f0ec8;}async[_0x1777da(0x120)](_0x595ae3){const _0x27b4ef=_0x1777da,{page:page=0x1,size:size=0x14,rec:_0x12f29d,userId:_0x323c2f,model:_0x8b71f6}=_0x595ae3,_0xd334bb={'type':balance_constant_1[_0x27b4ef(0xfb)][_0x27b4ef(0xe0)],'prompt':(0x0,typeorm_2[_0x27b4ef(0xe9)])(''),'answer':(0x0,typeorm_2['Not'])('')};_0x12f29d&&Object[_0x27b4ef(0xe1)](_0xd334bb,{'rec':_0x12f29d}),_0x323c2f&&Object[_0x27b4ef(0xe1)](_0xd334bb,{'userId':_0x323c2f}),_0x8b71f6&&Object['assign'](_0xd334bb,{'model':_0x8b71f6});const [_0x11164f,_0x5508ba]=await this[_0x27b4ef(0x100)]['findAndCount']({'order':{'id':_0x27b4ef(0xef)},'skip':(page-0x1)*size,'take':size,'where':_0xd334bb});return _0x11164f[_0x27b4ef(0x106)](_0x554e5d=>{const _0x1d21fb=_0x27b4ef;if(_0x554e5d[_0x1d21fb(0xba)]==='paintCount'){const _0x26858e=_0x554e5d[_0x1d21fb(0xb8)]==='mj'?0x136:0xa0,_0x5459cb=_0x554e5d['answer'][_0x1d21fb(0x105)](_0x1d21fb(0x11a))?_0x1d21fb(0x13c):_0x1d21fb(0xf7),_0x421f65=_0x5459cb===_0x1d21fb(0x13c)?_0x1d21fb(0xd1)+_0x26858e+_0x1d21fb(0x131):_0x1d21fb(0x107)+_0x26858e;_0x554e5d[_0x1d21fb(0xf8)]=_0x554e5d[_0x1d21fb(0x10a)]+_0x421f65;const _0xa2c173=_0x554e5d[_0x1d21fb(0x101)]?JSON['parse'](_0x554e5d[_0x1d21fb(0x101)]):null;_0xa2c173&&(_0xa2c173?_0x554e5d[_0x1d21fb(0x13b)]=_0xa2c173?.['components'][0x0]?.[_0x1d21fb(0xcf)][_0x1d21fb(0x110)]===0x5:_0x554e5d[_0x1d21fb(0x13b)]=![]);}}),{'rows':_0x11164f,'count':_0x5508ba};}async[_0x1777da(0x139)](_0x375cdf){const _0x34bceb=_0x1777da,{id:_0x43bae3}=_0x375cdf,_0x4e0ddb=await this[_0x34bceb(0x100)]['findOne']({'where':{'id':_0x43bae3,'type':balance_constant_1[_0x34bceb(0xfb)][_0x34bceb(0xe0)]}});if(!_0x4e0ddb)throw new common_1[(_0x34bceb(0xc0))](_0x34bceb(0x115),common_1[_0x34bceb(0x11f)][_0x34bceb(0x141)]);const _0x418d2f=_0x4e0ddb[_0x34bceb(0xc6)]===0x1?0x0:0x1,_0x405674=await this['chatLogEntity'][_0x34bceb(0xcc)]({'id':_0x43bae3},{'rec':_0x418d2f});if(_0x405674[_0x34bceb(0xd6)]>0x0)return(_0x418d2f?'推荐':_0x34bceb(0xc7))+'图片成功！';throw new common_1[(_0x34bceb(0xc0))](_0x34bceb(0xda),common_1[_0x34bceb(0x11f)][_0x34bceb(0x141)]);}async[_0x1777da(0x127)](_0x61dc86,_0x5b042b){const _0x3a4b4b=_0x1777da,_0x2f9813={'type':balance_constant_1[_0x3a4b4b(0xfb)][_0x3a4b4b(0x11c)]},{page:page=0x1,size:size=0x1e,prompt:_0x125220,email:_0xa8f05c}=_0x61dc86;_0x125220&&Object[_0x3a4b4b(0xe1)](_0x2f9813,{'prompt':(0x0,typeorm_2[_0x3a4b4b(0x12e)])('%'+_0x125220+'%')});if(_0xa8f05c){const _0x349611=await this[_0x3a4b4b(0xc2)][_0x3a4b4b(0x10e)]({'where':{'email':_0xa8f05c}});_0x349611?.['id']&&Object[_0x3a4b4b(0xe1)](_0x2f9813,{'userId':_0x349611['id']});}const [_0x457f4b,_0x1d70f0]=await this[_0x3a4b4b(0x100)][_0x3a4b4b(0xca)]({'order':{'id':_0x3a4b4b(0xef)},'skip':(page-0x1)*size,'take':size,'where':_0x2f9813}),_0x421222=_0x457f4b[_0x3a4b4b(0x136)](_0x53d4d7=>_0x53d4d7[_0x3a4b4b(0xdc)]),_0xe04279=await this[_0x3a4b4b(0xc2)][_0x3a4b4b(0xe2)]({'where':{'id':(0x0,typeorm_2['In'])(_0x421222)}}),_0x5c5ace=_0x457f4b['map'](_0x23d384=>{const _0x2655b5=_0x3a4b4b,_0x4de163=_0xe04279[_0x2655b5(0xe2)](_0x32c83c=>_0x32c83c['id']===_0x23d384['userId']);return{'username':_0x4de163?_0x4de163[_0x2655b5(0xfa)]:'','email':_0x4de163?_0x4de163['email']:'','prompt':_0x23d384['prompt'],'answer':_0x23d384[_0x2655b5(0x10a)],'createdAt':(0x0,utils_1[_0x2655b5(0xd3)])(_0x23d384[_0x2655b5(0xd8)])};}),_0x59cec6=new exceljs_1[(_0x3a4b4b(0xdf))][(_0x3a4b4b(0x103))](),_0x3269ef=_0x59cec6['addWorksheet']('chatlog');_0x3269ef[_0x3a4b4b(0xcb)]=[{'header':_0x3a4b4b(0xe8),'key':'username','width':0x14},{'header':'用户邮箱','key':_0x3a4b4b(0x12f),'width':0x14},{'header':_0x3a4b4b(0xe5),'key':_0x3a4b4b(0xd8),'width':0x14},{'header':_0x3a4b4b(0xd7),'key':_0x3a4b4b(0x13e),'width':0x50},{'header':'回答答案','key':_0x3a4b4b(0x10a),'width':0x96}],_0x5c5ace[_0x3a4b4b(0x106)](_0x35e2ba=>_0x3269ef[_0x3a4b4b(0x142)](_0x35e2ba)),_0x5b042b[_0x3a4b4b(0xd9)]('Content-Type',_0x3a4b4b(0x119)),_0x5b042b['setHeader'](_0x3a4b4b(0xb9),_0x3a4b4b(0xfc)+_0x3a4b4b(0xc8)),await _0x59cec6[_0x3a4b4b(0xcd)][_0x3a4b4b(0x144)](_0x5b042b),_0x5b042b[_0x3a4b4b(0x111)]();}async[_0x1777da(0xf0)](_0x1b0c3b,_0x2b9a8b){const _0x4c592f=_0x1777da,{page:page=0x1,size:size=0x14,userId:_0x105bb7,prompt:_0x43d610,modelType:_0x391c66}=_0x1b0c3b,_0x4ce5a7={'type':balance_constant_1['DeductionKey'][_0x4c592f(0x11c)],'prompt':(0x0,typeorm_2['Not'])('')};_0x105bb7&&Object[_0x4c592f(0xe1)](_0x4ce5a7,{'userId':_0x105bb7}),_0x43d610&&Object[_0x4c592f(0xe1)](_0x4ce5a7,{'prompt':(0x0,typeorm_2[_0x4c592f(0x12e)])('%'+_0x43d610+'%')});_0x391c66?_0x4ce5a7[_0x4c592f(0xbe)]=_0x391c66:_0x4ce5a7[_0x4c592f(0xbe)]=(0x0,typeorm_2[_0x4c592f(0xe3)])();const [_0x16a3a1,_0x108b60]=await this[_0x4c592f(0x100)][_0x4c592f(0xca)]({'order':{'id':_0x4c592f(0xef)},'skip':(page-0x1)*size,'take':size,'where':_0x4ce5a7}),_0x5586f0=_0x16a3a1[_0x4c592f(0x136)](_0x5bd9a4=>_0x5bd9a4[_0x4c592f(0xdc)]),_0x27d424=await this[_0x4c592f(0xc2)][_0x4c592f(0xe2)]({'where':{'id':(0x0,typeorm_2['In'])(_0x5586f0)},'select':['id','username','email']});return _0x16a3a1[_0x4c592f(0x106)](_0x33335f=>{const _0x42a314=_0x4c592f,{username:_0x5776c1,email:_0x28ae5a}=_0x27d424['find'](_0x43c274=>_0x43c274['id']===_0x33335f['userId'])||{};_0x33335f[_0x42a314(0xfa)]=_0x5776c1,_0x33335f[_0x42a314(0x12f)]=_0x28ae5a;}),_0x2b9a8b[_0x4c592f(0x104)][_0x4c592f(0x12d)]!==_0x4c592f(0xe6)&&_0x16a3a1[_0x4c592f(0x106)](_0x22dafa=>_0x22dafa[_0x4c592f(0x12f)]=(0x0,utils_1[_0x4c592f(0x134)])(_0x22dafa[_0x4c592f(0x12f)])),_0x16a3a1['forEach'](_0x461a60=>{const _0x1f4ca8=_0x4c592f;!_0x461a60[_0x1f4ca8(0x12f)]&&(_0x461a60[_0x1f4ca8(0x12f)]=_0x461a60?.[_0x1f4ca8(0xdc)]+_0x1f4ca8(0xf4)),!_0x461a60[_0x1f4ca8(0xfa)]&&(_0x461a60['username']='游客'+_0x461a60?.[_0x1f4ca8(0xdc)]);}),{'rows':_0x16a3a1,'count':_0x108b60};}async[_0x1777da(0xd2)](_0x2f47ef,_0xf1a2f8){const _0x5cbd9f=_0x1777da,{id:_0x3bd417}=_0x2f47ef[_0x5cbd9f(0x104)],{groupId:_0xb1e24b,logType:_0x18cc81}=_0xf1a2f8,_0x5a8cac={'userId':_0x3bd417,'isDelete':![]};_0xb1e24b&&Object[_0x5cbd9f(0xe1)](_0x5a8cac,{'groupId':_0xb1e24b}),_0x18cc81&&Object['assign'](_0x5a8cac,{'logType':_0x18cc81});const _0x1c3453=await this[_0x5cbd9f(0x100)][_0x5cbd9f(0xe2)]({'where':_0x5a8cac})[_0x5cbd9f(0x128)](_0x27015b=>{common_1['Logger']['error'](_0x27015b);});if(!_0x1c3453||_0x1c3453['length']===0x0)return[];return _0x1c3453[_0x5cbd9f(0x136)](_0x40c39d=>{const _0x79302c=_0x5cbd9f,{prompt:_0x38b410,role:_0x2cf806,answer:_0x4c14c0,createdAt:_0x58e87c,model:_0x31ccd3,conversationOptions:_0x47e8f2,requestOptions:_0x33418f,id:_0x25fdc7}=_0x40c39d;return{'chatId':_0x25fdc7,'dateTime':(0x0,utils_1[_0x79302c(0xd3)])(_0x58e87c),'text':_0x2cf806===_0x79302c(0x104)?_0x38b410:_0x4c14c0,'inversion':_0x2cf806===_0x79302c(0x104),'error':![],'conversationOptions':_0x47e8f2?JSON['parse'](_0x47e8f2):null,'requestOptions':_0x33418f?JSON[_0x79302c(0x122)](_0x33418f):null};});}async[_0x1777da(0xdd)](_0xfda01c,_0x3d59aa){const _0x4015ad=_0x1777da;try{const _0x152d11={'isDelete':![],'answer':(0x0,typeorm_2[_0x4015ad(0xe9)])((0x0,typeorm_2[_0x4015ad(0xe3)])()),'modelType':_0x4015ad(0xf6),'userId':_0xfda01c[_0x4015ad(0x104)]['id']},[_0x5a2e7b,_0xafcc63]=await this[_0x4015ad(0x100)][_0x4015ad(0xca)]({'where':_0x152d11,'take':_0x3d59aa[_0x4015ad(0x102)],'skip':(_0x3d59aa[_0x4015ad(0x12a)]-0x1)*_0x3d59aa[_0x4015ad(0x102)],'order':{'createdAt':_0x4015ad(0xef)}}),_0x3bc5ad=_0x5a2e7b[_0x4015ad(0x136)](_0xbc7bff=>_0xbc7bff['id']),_0x439eb0=new Map();if(_0x3bc5ad[_0x4015ad(0x110)]){const _0x540950=await this[_0x4015ad(0x133)][_0x4015ad(0xe2)]({'where':{'relateId':(0x0,typeorm_2['In'])(_0x3bc5ad),'userId':_0xfda01c[_0x4015ad(0x104)]['id']}});_0x540950[_0x4015ad(0x106)](_0x1f96d1=>{const _0x54936c=_0x4015ad;_0x439eb0[_0x54936c(0x12c)](_0x1f96d1[_0x54936c(0xff)],_0x1f96d1['action']);});}const _0x3d4ff7=_0x5a2e7b[_0x4015ad(0x136)](_0x19155d=>{const _0x10f8f8=_0x4015ad,{prompt:_0x4985a9,role:_0x3ba73e,answer:_0x2f11b4,createdAt:_0x4a018b,model:_0x2e9a14,conversationOptions:_0x132b48,requestOptions:_0x11253c,id:_0x362c60}=_0x19155d;return{'chatId':_0x362c60,'error':![],'inversion':_0x3ba73e===_0x10f8f8(0x104),'agree':_0x439eb0['get'](_0x362c60)||null,'dateTime':(0x0,utils_1[_0x10f8f8(0xd3)])(_0x4a018b),'text':_0x3ba73e===_0x10f8f8(0x104)?_0x4985a9:_0x2f11b4,'requestOptions':_0x11253c?JSON['parse'](_0x11253c):null,'conversationOptions':_0x132b48?JSON[_0x10f8f8(0x122)](_0x132b48):null};});return{'count':_0xafcc63,'records':_0x3d4ff7};}catch(_0x3b37d0){throw new common_1['HttpException'](_0x3b37d0['message'],common_1['HttpStatus'][_0x4015ad(0x141)]);}}async[_0x1777da(0x108)](_0x666d87,_0x2b63dd){const _0x11169d=_0x1777da,{id:_0x38288f}=_0x666d87[_0x11169d(0x104)],{groupId:_0x19fdaa}=_0x2b63dd,_0x232b2c={'userId':_0x38288f,'isDelete':![]};_0x19fdaa&&Object[_0x11169d(0xe1)](_0x232b2c,{'groupId':_0x19fdaa});const _0x2a5364=await this[_0x11169d(0x100)]['find']({'where':_0x232b2c});return _0x2a5364[_0x11169d(0x136)](_0x80d505=>{const _0x52e210=_0x11169d,{prompt:_0x4a0519,role:_0x5977b4,answer:_0x4d8396,createdAt:_0x4db3df,model:_0x31962a,conversationOptions:_0x2cd2e2,requestOptions:_0x86f158,id:_0x2e6f32}=_0x80d505;return{'chatId':_0x2e6f32,'dateTime':(0x0,utils_1['formatDate'])(_0x4db3df),'text':_0x5977b4===_0x52e210(0x104)?_0x4a0519:_0x4d8396,'inversion':_0x5977b4===_0x52e210(0x104),'error':![],'conversationOptions':_0x2cd2e2?JSON[_0x52e210(0x122)](_0x2cd2e2):null,'requestOptions':_0x86f158?JSON[_0x52e210(0x122)](_0x86f158):null};});}async[_0x1777da(0xce)](_0x17ce9e,_0x3d897f){const _0x488ee0=_0x1777da,{id:_0x20dbbf}=_0x17ce9e['user'],{id:_0x2d842f}=_0x3d897f,_0x5aac9d=await this[_0x488ee0(0x100)][_0x488ee0(0x10e)]({'where':{'id':_0x2d842f,'userId':_0x20dbbf}});if(!_0x5aac9d)throw new common_1[(_0x488ee0(0xc0))](_0x488ee0(0x114),common_1[_0x488ee0(0x11f)][_0x488ee0(0x141)]);const _0x5ebd76=await this[_0x488ee0(0x100)][_0x488ee0(0xcc)]({'id':_0x2d842f},{'isDelete':!![]});if(_0x5ebd76[_0x488ee0(0xd6)]>0x0)return'删除对话记录成功！';else throw new common_1[(_0x488ee0(0xc0))](_0x488ee0(0x114),common_1[_0x488ee0(0x11f)][_0x488ee0(0x141)]);}async['delByGroupId'](_0x4fd6f2,_0x252d9f){const _0x297ded=_0x1777da,{groupId:_0x845e04,type:_0x1c27ae}=_0x252d9f,{id:_0x3dce60}=_0x4fd6f2[_0x297ded(0x104)],_0x1ba97e=_0x1c27ae&&_0x1c27ae==='gpts'?{'groupId':_0x845e04,'userId':_0x3dce60}:{'groupId':_0x845e04,'userId':_0x3dce60},_0x2b0902=await this['chatLogEntity'][_0x297ded(0xd5)](_0x1ba97e);if(_0x2b0902[_0x297ded(0xd6)]>0x0)return!![];if(_0x2b0902[_0x297ded(0xd6)]===0x0)throw new common_1['HttpException']('当前页面已经没有东西可以删除了！',common_1[_0x297ded(0x11f)][_0x297ded(0x141)]);}async['removeLogsBatch'](_0x5c22c4){const _0x624a92=_0x1777da,{ids:_0x3a184f,userId:_0x1436a5}=_0x5c22c4;return await this[_0x624a92(0x100)][_0x624a92(0xd5)]({'groupId':(0x0,typeorm_2['In'])(_0x3a184f),'userId':_0x1436a5});}async['byAppId'](_0x1bc8a5,_0x2aef2b){const _0x232c1a=_0x1777da,{id:_0x536601}=_0x1bc8a5['user'],{appId:_0x4dca37,page:page=0x1,size:size=0xa}=_0x2aef2b,[_0x21e1c4,_0x18657c]=await this[_0x232c1a(0x100)]['findAndCount']({'where':{'userId':_0x536601,'appId':_0x4dca37,'role':_0x232c1a(0xc5)},'order':{'id':'DESC'},'take':size,'skip':(page-0x1)*size});return{'rows':_0x21e1c4,'count':_0x18657c};}async[_0x1777da(0x12b)](){const _0xffea1=_0x1777da,_0xc941f2=await this[_0xffea1(0x100)][_0xffea1(0xe2)]({'where':{'modelType':_0xffea1(0xf6),'answer':(0x0,typeorm_2[_0xffea1(0x12e)])(_0xffea1(0xbd))}});for(let _0x1ae76f=0x0;_0x1ae76f<_0xc941f2[_0xffea1(0x110)];_0x1ae76f++){const _0x2b8835=_0xc941f2[_0x1ae76f];if(!_0x2b8835['answer'])continue;const _0x26707f=redisKey_constant_1[_0xffea1(0xf2)]+_0x2b8835['id'];try{const _0x309a71=await this[_0xffea1(0xc9)]['get']({'key':_0x26707f});if(_0x309a71)continue;await this[_0xffea1(0xc9)][_0xffea1(0x12c)]({'key':_0x26707f,'val':_0xffea1(0x118)});const _0x40b315=_0x2b8835[_0xffea1(0x10a)][_0xffea1(0xc4)](/https:\/\/filesystem.site\/cdn(.+)\)/g);if(!_0x40b315)continue;const _0x4cf706=Array['prototype'][_0xffea1(0x13a)][_0xffea1(0xed)](_0x40b315)[_0xffea1(0x136)](_0x1b4396=>_0x1b4396[_0xffea1(0xeb)](0x0,_0x1b4396[_0xffea1(0x110)]-0x1));try{const _0x43b42a=await Promise[_0xffea1(0x10f)](_0x4cf706[_0xffea1(0x136)](_0x52631b=>this[_0xffea1(0x140)][_0xffea1(0x130)](_0x52631b)));for(let _0x2ba5d9=0x0;_0x2ba5d9<_0x43b42a[_0xffea1(0x110)];_0x2ba5d9++){_0x43b42a[_0x2ba5d9]&&(_0x2b8835['answer']=_0x2b8835['answer']['replace'](_0x4cf706[_0x2ba5d9],_0x43b42a[_0x2ba5d9]));}await this[_0xffea1(0x100)]['save'](_0x2b8835);}catch(_0x21043a){common_1[_0xffea1(0xf5)][_0xffea1(0x11e)](_0x21043a);}}finally{await this['redisCacheService'][_0xffea1(0xf1)]({'key':_0x26707f});}}}};ChatLogService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(chatLog_entity_1['ChatLogEntity'])),__param(0x1,(0x0,typeorm_1[_0x1777da(0xbf)])(user_entity_1['UserEntity'])),__param(0x2,(0x0,typeorm_1['InjectRepository'])(chatGroup_entity_1[_0x1777da(0x11d)])),__param(0x3,(0x0,typeorm_1['InjectRepository'])(aiAgreeLog_entity_1['AiAgreeLogEntity'])),__metadata(_0x1777da(0x126),[typeorm_2[_0x1777da(0xd0)],typeorm_2[_0x1777da(0xd0)],typeorm_2[_0x1777da(0xd0)],typeorm_2[_0x1777da(0xd0)],typeorm_2['Connection'],upload_service_1[_0x1777da(0x123)],redisCache_service_1[_0x1777da(0x124)]])],ChatLogService),exports[_0x1777da(0x13d)]=ChatLogService;