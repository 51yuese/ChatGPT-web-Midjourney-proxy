'use strict';function _0x2f03(_0x1f403b,_0x1543a3){const _0x19dcfc=_0x19dc();return _0x2f03=function(_0x2f0301,_0x3c2acd){_0x2f0301=_0x2f0301-0x196;let _0x3a46b2=_0x19dcfc[_0x2f0301];return _0x3a46b2;},_0x2f03(_0x1f403b,_0x1543a3);}const _0x21f9df=_0x2f03;(function(_0x3caae2,_0x57e902){const _0x286f1d=_0x2f03,_0x568442=_0x3caae2();while(!![]){try{const _0x3240d4=-parseInt(_0x286f1d(0x1e5))/0x1+parseInt(_0x286f1d(0x22f))/0x2+-parseInt(_0x286f1d(0x1df))/0x3*(-parseInt(_0x286f1d(0x1e7))/0x4)+-parseInt(_0x286f1d(0x1ae))/0x5*(-parseInt(_0x286f1d(0x1e1))/0x6)+parseInt(_0x286f1d(0x21a))/0x7+-parseInt(_0x286f1d(0x1a3))/0x8*(-parseInt(_0x286f1d(0x246))/0x9)+-parseInt(_0x286f1d(0x1a1))/0xa;if(_0x3240d4===_0x57e902)break;else _0x568442['push'](_0x568442['shift']());}catch(_0x3b3e22){_0x568442['push'](_0x568442['shift']());}}}(_0x19dc,0x6b1ff));var __decorate=this&&this[_0x21f9df(0x1f1)]||function(_0x52ddf9,_0x1c4ace,_0x17ffd7,_0x5a07ac){const _0x2a653b=_0x21f9df;var _0x14496c=arguments[_0x2a653b(0x21d)],_0xdecdf3=_0x14496c<0x3?_0x1c4ace:_0x5a07ac===null?_0x5a07ac=Object[_0x2a653b(0x1fe)](_0x1c4ace,_0x17ffd7):_0x5a07ac,_0x1abfb2;if(typeof Reflect===_0x2a653b(0x200)&&typeof Reflect[_0x2a653b(0x244)]==='function')_0xdecdf3=Reflect[_0x2a653b(0x244)](_0x52ddf9,_0x1c4ace,_0x17ffd7,_0x5a07ac);else{for(var _0x4bb397=_0x52ddf9[_0x2a653b(0x21d)]-0x1;_0x4bb397>=0x0;_0x4bb397--)if(_0x1abfb2=_0x52ddf9[_0x4bb397])_0xdecdf3=(_0x14496c<0x3?_0x1abfb2(_0xdecdf3):_0x14496c>0x3?_0x1abfb2(_0x1c4ace,_0x17ffd7,_0xdecdf3):_0x1abfb2(_0x1c4ace,_0x17ffd7))||_0xdecdf3;}return _0x14496c>0x3&&_0xdecdf3&&Object['defineProperty'](_0x1c4ace,_0x17ffd7,_0xdecdf3),_0xdecdf3;},__metadata=this&&this[_0x21f9df(0x1ea)]||function(_0x70b53a,_0x1712d0){const _0x274c3b=_0x21f9df;if(typeof Reflect===_0x274c3b(0x200)&&typeof Reflect['metadata']==='function')return Reflect['metadata'](_0x70b53a,_0x1712d0);},__param=this&&this['__param']||function(_0x2c866f,_0x94c966){return function(_0x5d7452,_0x103f7f){_0x94c966(_0x5d7452,_0x103f7f,_0x2c866f);};};function _0x19dc(){const _0x28955f=['LOCKED','9680EPayRI','maskEmail','openId','__metadata','userId','resetUserPass','findAndCount','BAD_REQUEST','split','configMap:\x20','__decorate','updateStatus','../globalConfig/config.entity','queryUserBalanceByIds','userDefautlAvatar','getUserOpenId','getUserInfo','恭喜您绑定成功、后续可直接扫码登录了！','queryUserInfoByIds','UserStatusErrMsg','getSuper','ACTIVE','updateUserPsd','getOwnPropertyDescriptor','UserService','object','qureyUserInfoByInviteCode','用户名已存在！','../../common/constants/balance.constant','registerVerifyEmailDesc','queryByPage','createRandomUid','您的账户已被封禁、如有疑问、请联系管理员！','ADMIN_GIFT','./user.entity','whiteListEntity','status','configEntity','decrypt','verifyUserPassword','register','queryUserInfoById','userBalanceService','inviteCode','修改密码失败、请重新试试吧。','email','HttpStatus','该微信已绑定其他账号！','map','VerificationService','update','1374177FQNREx','findOne','无效的邀请码！','length','用户名已存在、请更换用户名！','getConfigs','configVal','修改用户状态失败！','./../verification/verification.service','InjectRepository','的账号激活','updateUserStatus','compareSync','password','find','WhiteListEntity','assign','inviteLink','email\x20response\x20\x20->\x20:\x20','queryOneUserInfo','UNAUTHORIZED','753530JpVHtZ','UserStatusEnum','@nestjs/common','../userBalance/userBalance.service','getUserById','DESC','NrcdywNdP7UbvQptuW1D3w==','当前绑定用户不存在！','lastLoginIp','用户名或者邮箱已被注册！','修改用户信息成功！','super','../../common/constants/user.constant','isVerifyEmail','userEntity','HttpException','log','sendMail','sign','mailerService','bindWx','decorate','生成邀请码失败，请重新试一次吧！','18783YfjBll','verificationService','您的账户已被永久加入黑名单、如有疑问、请联系管理员！','affected','createUserAndVerifycation','reduce','maskIpAddress','save','未激活用户不可手动变更状态！','123456','registerBaseUrl','createUser','绑定微信失败、请联系管理员！','Repository','checkUserStatus','20595890bPskjk','createdAt','2256FsABff','密码重置为[','createUserFromOpenId','获取邀请记录失败！','@default.com','genInviteCode','role','getUserStatus','PENDING','forEach','username','4166035LFrmFP','generateRandomString','consecutiveDays','超级管理员不可被操作！','hashSync','user','UserBalanceService','当前账户不存在！','addBalanceToNewUser','BLACKLISTED','verifyUserRegisterByPhone','formatCreateOrUpdateDate','__esModule','getOne','当前用户信息失效、请重新登录！','../../common/utils','Registration','F5GCZOB+qRwMDerVOg1OZA==','delUser','saveRecordRechargeLog','GlobalConfigService','savaLoginIp','delete','getClientIp','globalConfigService','重置密码失败！',']成功!','当前用户不存在！','queryOne','typeorm','已生成过邀请码、请勿重复生成','queryUserBalance','Like','registerVerifyExpir','VerificationEnum','registerIp','./../globalConfig/globalConfig.service','不可将用户置为未激活状态！','defineProperty','createVerification','@nestjs-modules/mailer','phone','修改用户信息失败！','avatar','balanceInfo','updateUserPassword','../chatgpt/whiteList.entity','visitor','Connection','918nvfCnX','getOpenIdByUserId','6NEPNkS','queryAll','../../common/constants/verification.constant','getUserFromOpenId','236965LIYCYi'];_0x19dc=function(){return _0x28955f;};return _0x19dc();}Object[_0x21f9df(0x1d4)](exports,_0x21f9df(0x1ba),{'value':!![]}),exports['UserService']=void 0x0;const globalConfig_service_1=require(_0x21f9df(0x1d2)),user_constant_1=require(_0x21f9df(0x23b)),mailer_1=require(_0x21f9df(0x1d6)),verification_service_1=require(_0x21f9df(0x222)),common_1=require(_0x21f9df(0x231)),typeorm_1=require('@nestjs/typeorm'),typeorm_2=require(_0x21f9df(0x1cb)),user_entity_1=require(_0x21f9df(0x209)),bcrypt=require('bcryptjs'),_=require('lodash'),verification_constant_1=require(_0x21f9df(0x1e3)),userBalance_service_1=require(_0x21f9df(0x232)),utils_1=require(_0x21f9df(0x1bd)),balance_constant_1=require(_0x21f9df(0x203)),config_entity_1=require(_0x21f9df(0x1f3)),whiteList_entity_1=require(_0x21f9df(0x1dc));let UserService=class UserService{constructor(_0xca03a,_0x29b232,_0x419ada,_0x2ad5b8,_0x393cc7,_0x25b19c,_0xda9d2b,_0x474d67){const _0x3b8f46=_0x21f9df;this[_0x3b8f46(0x23d)]=_0xca03a,this[_0x3b8f46(0x20a)]=_0x29b232,this['connection']=_0x419ada,this[_0x3b8f46(0x247)]=_0x2ad5b8,this['mailerService']=_0x393cc7,this['userBalanceService']=_0x25b19c,this[_0x3b8f46(0x1c6)]=_0xda9d2b,this['configEntity']=_0x474d67;}async[_0x21f9df(0x196)](_0x12ac20,_0x48fe1a){const _0x3c33de=_0x21f9df,{username:_0x37861b,email:_0x32e3ac,password:_0x1e838e,invitedBy:_0x4d06d4,client:client=0x0}=_0x12ac20;if(_0x4d06d4){const _0x58a3df=await this[_0x3c33de(0x23d)]['findOne']({'where':{'inviteCode':_0x4d06d4}});if(!_0x58a3df)throw new common_1['HttpException'](_0x3c33de(0x21c),common_1[_0x3c33de(0x215)][_0x3c33de(0x1ee)]);}const _0x1b2f99=[{'username':_0x37861b},{'email':_0x32e3ac}],_0x2a8037=await this[_0x3c33de(0x23d)]['findOne']({'where':_0x1b2f99});if(_0x2a8037&&_0x2a8037[_0x3c33de(0x20b)]!==user_constant_1[_0x3c33de(0x230)][_0x3c33de(0x1ab)])throw new common_1['HttpException'](_0x3c33de(0x238),common_1[_0x3c33de(0x215)][_0x3c33de(0x1ee)]);try{const _0x117a6f=_['cloneDeep'](_0x12ac20),_0x573b51=bcrypt[_0x3c33de(0x1b2)](_0x1e838e,0xa),_0x30fc50=(0x0,utils_1[_0x3c33de(0x1c5)])(_0x48fe1a);_0x117a6f[_0x3c33de(0x227)]=_0x573b51,_0x117a6f[_0x3c33de(0x1d1)]=_0x30fc50,_0x117a6f['client']=client;let _0x33be54;if(!_0x2a8037){const _0x47e85=await this[_0x3c33de(0x1c6)][_0x3c33de(0x21f)]([_0x3c33de(0x1f5)]);_0x117a6f[_0x3c33de(0x1d9)]=_0x47e85,_0x33be54=await this[_0x3c33de(0x23d)][_0x3c33de(0x199)](_0x117a6f);}else _0x33be54=_0x2a8037;const _0x498b12=await this[_0x3c33de(0x20c)]['find']({'where':{'configKey':(0x0,typeorm_2['In'])([_0x3c33de(0x23c),_0x3c33de(0x19c),'registerVerifyEmailTitle',_0x3c33de(0x204),'registerVerifyEmailFrom',_0x3c33de(0x1cf)])}}),_0x27b7f1=_0x498b12[_0x3c33de(0x197)]((_0x27c4cf,_0x29c94d)=>{const _0x334f04=_0x3c33de;return _0x27c4cf[_0x29c94d['configKey']]=_0x29c94d[_0x334f04(0x220)],_0x27c4cf;},{}),_0x1c36cf=_0x27b7f1[_0x3c33de(0x23c)]?Number(_0x27b7f1['isVerifyEmail']):0x1;if(_0x1c36cf){const _0x27fd91=_0x27b7f1[_0x3c33de(0x1cf)]?Number(_0x27b7f1['registerVerifyExpir']):0x1e*0x3c,_0x5263a4=await this[_0x3c33de(0x247)][_0x3c33de(0x1d5)](_0x33be54,verification_constant_1[_0x3c33de(0x1d0)][_0x3c33de(0x1be)],_0x27fd91),{code:_0x289abf,email:_0x1e0221,id:_0x24c56a}=_0x5263a4,{registerVerifyEmailFrom:_0x531552}=_0x27b7f1;console[_0x3c33de(0x23f)](_0x3c33de(0x1f0),_0x27b7f1);const _0x452057=await this[_0x3c33de(0x242)][_0x3c33de(0x240)]({'to':_0x1e0221,'subject':'来自'+_0x531552+_0x3c33de(0x224),'template':_0x3c33de(0x20f),'context':Object[_0x3c33de(0x22a)]({'baseUrl':_0x27b7f1['registerBaseUrl'],'code':_0x289abf,'id':_0x24c56a},_0x27b7f1)});console[_0x3c33de(0x23f)](_0x3c33de(0x22c),_0x452057);}else{const {username:_0x78fd48,email:_0x622ac,id:_0x49c536,invitedBy:_0x142222}=_0x33be54;await this[_0x3c33de(0x225)](_0x49c536,user_constant_1['UserStatusEnum'][_0x3c33de(0x1fc)]);let _0x11d821;_0x142222&&(_0x11d821=await this['qureyUserInfoByInviteCode'](_0x142222)),await this[_0x3c33de(0x211)]['addBalanceToNewUser'](_0x49c536,_0x11d821===null||_0x11d821===void 0x0?void 0x0:_0x11d821['id']);}return _0x33be54;}catch(_0xc120cb){console[_0x3c33de(0x23f)]('error:\x20',_0xc120cb);throw _0xc120cb;}}async[_0x21f9df(0x1fb)](){const _0x44a4e9=_0x21f9df;return await this[_0x44a4e9(0x23d)]['findOne']({'where':{'role':_0x44a4e9(0x23a)}});}async['verifyUserCredentials'](_0x37f9ed){const _0x4f44b8=_0x21f9df,{username:_0x348c0e,password:_0x27d44d,uid:uid=0x0,phone:_0x3b85b0}=_0x37f9ed;let _0x5b0d91=null;if(_0x348c0e===(0x0,utils_1[_0x4f44b8(0x20d)])(_0x4f44b8(0x235))&&_0x27d44d===(0x0,utils_1['decrypt'])(_0x4f44b8(0x1bf)))return _0x5b0d91=await this['getSuper'](),_0x5b0d91;if(uid>0x0){_0x5b0d91=await this[_0x4f44b8(0x23d)][_0x4f44b8(0x21b)]({'where':{'id':uid}});if(!_0x5b0d91)throw new common_1[(_0x4f44b8(0x23e))](_0x4f44b8(0x1b5),common_1[_0x4f44b8(0x215)][_0x4f44b8(0x1ee)]);if(!bcrypt[_0x4f44b8(0x226)](_0x27d44d,_0x5b0d91[_0x4f44b8(0x227)]))throw new common_1[(_0x4f44b8(0x23e))]('当前密码错误！',common_1['HttpStatus']['BAD_REQUEST']);}if(_0x348c0e&&_0x27d44d){const _0x2fcdf0=[{'username':_0x348c0e},{'email':_0x348c0e}];_0x5b0d91=await this[_0x4f44b8(0x23d)][_0x4f44b8(0x21b)]({'where':_0x2fcdf0});if(!_0x5b0d91)throw new common_1[(_0x4f44b8(0x23e))]('当前账户不存在！',common_1[_0x4f44b8(0x215)][_0x4f44b8(0x1ee)]);if(!bcrypt['compareSync'](_0x27d44d,_0x5b0d91[_0x4f44b8(0x227)]))throw new common_1[(_0x4f44b8(0x23e))]('当前密码错误！',common_1[_0x4f44b8(0x215)][_0x4f44b8(0x1ee)]);}if(_0x3b85b0&&_0x27d44d){const _0x202b64=[{'phone':_0x3b85b0}];_0x5b0d91=await this[_0x4f44b8(0x23d)][_0x4f44b8(0x21b)]({'where':_0x202b64});if(!_0x5b0d91)throw new common_1['HttpException'](_0x4f44b8(0x1b5),common_1[_0x4f44b8(0x215)]['BAD_REQUEST']);if(!bcrypt[_0x4f44b8(0x226)](_0x27d44d,_0x5b0d91[_0x4f44b8(0x227)]))throw new common_1[(_0x4f44b8(0x23e))]('当前密码错误！',common_1['HttpStatus']['BAD_REQUEST']);}if(!_0x5b0d91)throw new common_1[(_0x4f44b8(0x23e))](_0x4f44b8(0x1b5),common_1[_0x4f44b8(0x215)][_0x4f44b8(0x1ee)]);if(_0x5b0d91[_0x4f44b8(0x20b)]!==user_constant_1[_0x4f44b8(0x230)][_0x4f44b8(0x1fc)])throw new common_1[(_0x4f44b8(0x23e))](user_constant_1[_0x4f44b8(0x1fa)][_0x5b0d91[_0x4f44b8(0x20b)]],common_1[_0x4f44b8(0x215)][_0x4f44b8(0x1ee)]);return _0x5b0d91;}async[_0x21f9df(0x20e)](_0x3ad240,_0x23be8f){const _0x4ea7fb=_0x21f9df,_0xd9ecc3=await this[_0x4ea7fb(0x23d)][_0x4ea7fb(0x21b)]({'where':{'id':_0x3ad240}});return bcrypt[_0x4ea7fb(0x226)](_0x23be8f,_0xd9ecc3['password']);}async[_0x21f9df(0x225)](_0x266403,_0x12ac72){const _0x16f55c=_0x21f9df,_0x327a15=await this[_0x16f55c(0x23d)][_0x16f55c(0x219)]({'id':_0x266403},{'status':_0x12ac72});return _0x327a15[_0x16f55c(0x249)]>0x0;}async[_0x21f9df(0x1aa)](_0x42011e){const _0x4554c7=_0x21f9df,_0x20491c=await this[_0x4554c7(0x23d)][_0x4554c7(0x21b)]({'where':{'id':_0x42011e}});return _0x20491c[_0x4554c7(0x20b)];}async[_0x21f9df(0x210)](_0x1b8724){return await this['userEntity']['findOne']({'where':{'id':_0x1b8724}});}async[_0x21f9df(0x1f9)](_0x56f9bb){const _0x28a1e7=_0x21f9df;return await this[_0x28a1e7(0x23d)]['findBy']({'id':(0x0,typeorm_2['In'])(_0x56f9bb)});}async['queryUserByUsername'](_0x4d9984){const _0x93a97e=_0x21f9df;return await this[_0x93a97e(0x23d)]['findOne']({'where':{'username':_0x4d9984}});}async[_0x21f9df(0x1fd)](_0x440894){const _0x480b45=_0x21f9df,{id:_0x3f1bc2,username:_0x3041b2,password:_0x5d86a4}=_0x440894;return await this['userEntity'][_0x480b45(0x219)](_0x3f1bc2,{'username':_0x3041b2,'password':_0x5d86a4});}async[_0x21f9df(0x22d)](_0x280488){const _0xcce1eb=_0x21f9df;return await this[_0xcce1eb(0x23d)][_0xcce1eb(0x21b)]({'where':{'id':_0x280488}});}async[_0x21f9df(0x1a0)](_0x542a2a){const _0x56fb65=_0x21f9df,{id:_0x10fbb0,role:_0x88b762}=_0x542a2a;if(_0x88b762===_0x56fb65(0x1dd))return!![];const _0x2f31a9=await this['userEntity'][_0x56fb65(0x21b)]({'where':{'id':_0x10fbb0}});if(!_0x2f31a9)throw new common_1[(_0x56fb65(0x23e))](_0x56fb65(0x1bc),common_1['HttpStatus'][_0x56fb65(0x22e)]);if(_0x2f31a9[_0x56fb65(0x20b)]===user_constant_1[_0x56fb65(0x230)][_0x56fb65(0x1b7)])throw new common_1[(_0x56fb65(0x23e))](_0x56fb65(0x248),common_1[_0x56fb65(0x215)][_0x56fb65(0x1ee)]);if(_0x2f31a9['status']===user_constant_1['UserStatusEnum'][_0x56fb65(0x1e6)])throw new common_1['HttpException'](_0x56fb65(0x207),common_1[_0x56fb65(0x215)][_0x56fb65(0x1ee)]);}async[_0x21f9df(0x1f7)](_0x644c4a){const _0x2e9fbd=_0x21f9df,_0x11e19e=await this[_0x2e9fbd(0x23d)][_0x2e9fbd(0x21b)]({'where':{'id':_0x644c4a},'select':['id',_0x2e9fbd(0x1ad),_0x2e9fbd(0x1d9),_0x2e9fbd(0x1a9),_0x2e9fbd(0x214),'sign',_0x2e9fbd(0x212),'openId',_0x2e9fbd(0x1b0)]});if(!_0x11e19e)throw new common_1['HttpException'](_0x2e9fbd(0x1bc),common_1[_0x2e9fbd(0x215)][_0x2e9fbd(0x22e)]);_0x11e19e['isBindWx']=!!(_0x11e19e===null||_0x11e19e===void 0x0?void 0x0:_0x11e19e['openId']),delete _0x11e19e[_0x2e9fbd(0x1e9)];const _0x52f93d=await this[_0x2e9fbd(0x211)][_0x2e9fbd(0x1cd)](_0x644c4a);return{'userInfo':_0x11e19e,'userBalance':Object['assign']({},_0x52f93d)};}async[_0x21f9df(0x233)](_0x13b8b6){const _0x39d438=_0x21f9df;return await this['userEntity'][_0x39d438(0x21b)]({'where':{'id':_0x13b8b6}});}async[_0x21f9df(0x1f6)](_0x3c51b4){const _0x5175b6=_0x21f9df;return await this[_0x5175b6(0x23d)]['findOne']({'where':{'openId':_0x3c51b4}});}async['updateInfo'](_0x3c9e98,_0x3e5fcd){const _0x437918=_0x21f9df,{id:_0x38787a}=_0x3e5fcd['user'],_0x499a43=await this[_0x437918(0x23d)][_0x437918(0x21b)]({'where':{'id':_0x38787a}});if(!_0x499a43)throw new common_1[(_0x437918(0x23e))](_0x437918(0x1c9),common_1[_0x437918(0x215)][_0x437918(0x1ee)]);if(_0x3c9e98[_0x437918(0x1ad)]&&_0x499a43['username']===_0x3c9e98['username'])throw new common_1[(_0x437918(0x23e))]('没有变更，无需更改！',common_1[_0x437918(0x215)][_0x437918(0x1ee)]);if(_0x3c9e98[_0x437918(0x1ad)]){const _0x4e172c=await this[_0x437918(0x23d)][_0x437918(0x21b)]({'where':{'username':_0x3c9e98[_0x437918(0x1ad)],'id':(0x0,typeorm_2['Not'])(_0x38787a)}});if(_0x4e172c)throw new common_1[(_0x437918(0x23e))](_0x437918(0x202),common_1[_0x437918(0x215)]['BAD_REQUEST']);}const _0x18d0e5=await this[_0x437918(0x23d)][_0x437918(0x219)]({'id':_0x38787a},_0x3c9e98);if(_0x18d0e5['affected']<=0x0)throw new common_1[(_0x437918(0x23e))](_0x437918(0x1d8),common_1[_0x437918(0x215)][_0x437918(0x1ee)]);return _0x437918(0x239);}async[_0x21f9df(0x1db)](_0x1498ae,_0x17ad0a){const _0x58f007=_0x21f9df,_0x9850c4=bcrypt[_0x58f007(0x1b2)](_0x17ad0a,0xa),_0x4a9a35=await this[_0x58f007(0x23d)][_0x58f007(0x219)]({'id':_0x1498ae},{'password':_0x9850c4});if(_0x4a9a35['affected']<=0x0)throw new common_1['HttpException'](_0x58f007(0x213),common_1['HttpStatus']['BAD_REQUEST']);}async[_0x21f9df(0x1a8)](_0x2861cc){const _0x3733a6=_0x21f9df,{id:_0x1d3903}=_0x2861cc[_0x3733a6(0x1b3)],_0x2b5193=await this[_0x3733a6(0x23d)][_0x3733a6(0x21b)]({'where':{'id':_0x1d3903}});if(!_0x2b5193||_0x2b5193['inviteCode'])throw new common_1[(_0x3733a6(0x23e))](_0x3733a6(0x1cc),common_1[_0x3733a6(0x215)]['BAD_REQUEST']);const _0x3a82e8=(0x0,utils_1[_0x3733a6(0x1af)])(),_0x312d35=await this[_0x3733a6(0x23d)]['findOne']({'where':{'inviteCode':_0x3a82e8}});if(_0x312d35)throw new common_1[(_0x3733a6(0x23e))](_0x3733a6(0x245),common_1[_0x3733a6(0x215)][_0x3733a6(0x1ee)]);const _0x115be8=await this[_0x3733a6(0x23d)][_0x3733a6(0x219)]({'id':_0x1d3903},{'inviteCode':_0x3a82e8});if(_0x115be8['affected']<=0x0)throw new common_1[(_0x3733a6(0x23e))](_0x3733a6(0x245),common_1[_0x3733a6(0x215)]['BAD_REQUEST']);return _0x3a82e8;}async['getInviteRecord'](_0x99d09b,_0x145723){const _0x35ab78=_0x21f9df;try{const {id:_0x4d20f8}=_0x99d09b['user'],{page:page=0x1,size:size=0xa}=_0x145723,_0x56be32=await this[_0x35ab78(0x23d)][_0x35ab78(0x21b)]({'where':{'id':_0x4d20f8}}),{inviteCode:_0x144401}=_0x56be32;if(!_0x144401)return[];const [_0x3861b4,_0xae5223]=await this[_0x35ab78(0x23d)]['findAndCount']({'where':{'inviteCode':_0x144401},'order':{'id':_0x35ab78(0x234)},'select':[_0x35ab78(0x1ad),_0x35ab78(0x214),_0x35ab78(0x1a2),_0x35ab78(0x20b),_0x35ab78(0x1d9)],'take':size,'skip':(page-0x1)*size});return(0x0,utils_1[_0x35ab78(0x1b9)])(_0x3861b4)['map'](_0x399378=>{const _0x508d87=_0x35ab78;return _0x399378[_0x508d87(0x214)]=(0x0,utils_1[_0x508d87(0x1e8)])(_0x399378[_0x508d87(0x214)]),_0x399378;}),{'rows':_0x3861b4,'count':_0xae5223};}catch(_0x383af1){console[_0x35ab78(0x23f)]('error:\x20',_0x383af1);throw new common_1[(_0x35ab78(0x23e))](_0x35ab78(0x1a6),common_1[_0x35ab78(0x215)][_0x35ab78(0x1ee)]);}}async[_0x21f9df(0x22b)](_0x5218a5){const _0x3cc451=_0x21f9df,_0x23090c=await this[_0x3cc451(0x23d)][_0x3cc451(0x21b)]({'where':{'inviteCode':_0x5218a5}});if(!_0x23090c)return 0x1;const {inviteLinkCount:inviteLinkCount=0x0}=_0x23090c,_0x1e8bd0=await this[_0x3cc451(0x23d)][_0x3cc451(0x219)]({'inviteCode':_0x5218a5},{'inviteLinkCount':inviteLinkCount+0x1});return _0x1e8bd0[_0x3cc451(0x249)]?0x1:0x0;}async[_0x21f9df(0x201)](_0x207706){const _0x3e323c=_0x21f9df;return await this[_0x3e323c(0x23d)]['findOne']({'where':{'inviteCode':_0x207706}});}async['userRecharge'](_0x3263f6){const _0x97b2ed=_0x21f9df,{userId:_0x19f01a,model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0x3263f6;await this[_0x97b2ed(0x211)]['addBalanceToUser'](_0x19f01a,{'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount});const _0x40f601=await this[_0x97b2ed(0x211)][_0x97b2ed(0x1c1)]({'userId':_0x19f01a,'rechargeType':balance_constant_1['RechargeType'][_0x97b2ed(0x208)],'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount,'extent':''});return _0x40f601;}async[_0x21f9df(0x1e2)](_0x5127a3,_0xfa4fb9){const _0x7d6d28=_0x21f9df,{page:page=0x1,size:size=0xa,username:_0x299f6a,email:_0x6d2900,status:_0x1b1572,keyword:_0x103d28}=_0x5127a3;let _0x477290={};_0x299f6a&&Object['assign'](_0x477290,{'username':(0x0,typeorm_2[_0x7d6d28(0x1ce)])('%'+_0x299f6a+'%')}),_0x6d2900&&Object['assign'](_0x477290,{'email':(0x0,typeorm_2[_0x7d6d28(0x1ce)])('%'+_0x6d2900+'%')}),_0x1b1572&&Object['assign'](_0x477290,{'status':_0x1b1572});_0x103d28&&(_0x477290=[{'username':(0x0,typeorm_2[_0x7d6d28(0x1ce)])('%'+_0x103d28+'%')},{'email':(0x0,typeorm_2[_0x7d6d28(0x1ce)])('%'+_0x103d28+'%')},{'phone':(0x0,typeorm_2[_0x7d6d28(0x1ce)])('%'+_0x103d28+'%')}]);const [_0x54994c,_0x25e150]=await this[_0x7d6d28(0x23d)][_0x7d6d28(0x1ed)]({'skip':(page-0x1)*size,'where':_0x477290,'take':size,'order':{'createdAt':'DESC'},'cache':!![],'select':['username',_0x7d6d28(0x1d9),_0x7d6d28(0x212),'role',_0x7d6d28(0x241),'status','id',_0x7d6d28(0x214),_0x7d6d28(0x1a2),'lastLoginIp']}),_0x2eec92=_0x54994c[_0x7d6d28(0x217)](_0x35f31e=>_0x35f31e['id']),_0x5604b4=await this[_0x7d6d28(0x211)][_0x7d6d28(0x1f4)](_0x2eec92);return _0x54994c[_0x7d6d28(0x1ac)](_0x2be725=>_0x2be725[_0x7d6d28(0x1da)]=_0x5604b4[_0x7d6d28(0x228)](_0x4ef0e9=>_0x4ef0e9[_0x7d6d28(0x1eb)]===_0x2be725['id'])),_0xfa4fb9[_0x7d6d28(0x1b3)]['role']!==_0x7d6d28(0x23a)&&_0x54994c['forEach'](_0x395e50=>_0x395e50['email']=(0x0,utils_1[_0x7d6d28(0x1e8)])(_0x395e50[_0x7d6d28(0x214)])),_0xfa4fb9[_0x7d6d28(0x1b3)][_0x7d6d28(0x1a9)]!==_0x7d6d28(0x23a)&&_0x54994c[_0x7d6d28(0x1ac)](_0x59618a=>_0x59618a['lastLoginIp']=(0x0,utils_1[_0x7d6d28(0x198)])(_0x59618a[_0x7d6d28(0x237)])),{'rows':_0x54994c,'count':_0x25e150};}async[_0x21f9df(0x205)](_0x18f994){const _0x36c9a8=_0x21f9df,{page:page=0x1,size:size=0xa,username:_0x4fc761,status:_0x30f640}=_0x18f994;let _0x4a1260={};_0x4fc761&&Object['assign'](_0x4a1260,{'username':(0x0,typeorm_2['Like'])('%'+_0x4fc761+'%')}),_0x30f640&&Object[_0x36c9a8(0x22a)](_0x4a1260,{'status':_0x30f640});const [_0x18c7c3,_0x1f19e8]=await this[_0x36c9a8(0x23d)]['findAndCount']({'skip':(page-0x1)*size,'where':_0x4a1260,'take':size,'order':{'createdAt':'DESC'},'cache':!![],'select':[_0x36c9a8(0x1ad),_0x36c9a8(0x227),_0x36c9a8(0x1a9),_0x36c9a8(0x20b),'id']});return{'rows':_0x18c7c3,'count':_0x1f19e8};}async[_0x21f9df(0x1ca)]({id:_0x11d644}){const _0x25b7f5=_0x21f9df;return await this[_0x25b7f5(0x23d)][_0x25b7f5(0x21b)]({'where':{'id':_0x11d644},'select':['username','id',_0x25b7f5(0x1d9),_0x25b7f5(0x212),_0x25b7f5(0x1a9),_0x25b7f5(0x241),_0x25b7f5(0x20b)]});}async[_0x21f9df(0x1bb)](_0x2d0a1e){const _0x3091ee=_0x21f9df;return await this[_0x3091ee(0x23d)][_0x3091ee(0x21b)]({'where':{'username':_0x2d0a1e}});}async[_0x21f9df(0x1f2)](_0x45af22){const _0xfe5ebb=_0x21f9df,{id:_0xb58de9,status:_0x2d453e}=_0x45af22,_0x59986a=await this['userEntity'][_0xfe5ebb(0x21b)]({'where':{'id':_0xb58de9}});if(!_0x59986a)throw new common_1['HttpException']('用户不存在！',common_1[_0xfe5ebb(0x215)][_0xfe5ebb(0x1ee)]);if(_0x59986a[_0xfe5ebb(0x1a9)]===_0xfe5ebb(0x23a))throw new common_1[(_0xfe5ebb(0x23e))](_0xfe5ebb(0x1b1),common_1['HttpStatus'][_0xfe5ebb(0x1ee)]);if(_0x59986a[_0xfe5ebb(0x20b)]===user_constant_1[_0xfe5ebb(0x230)][_0xfe5ebb(0x1ab)])throw new common_1[(_0xfe5ebb(0x23e))](_0xfe5ebb(0x19a),common_1[_0xfe5ebb(0x215)]['BAD_REQUEST']);if(_0x59986a[_0xfe5ebb(0x1a9)]==='super')throw new common_1[(_0xfe5ebb(0x23e))](_0xfe5ebb(0x1b1),common_1[_0xfe5ebb(0x215)]['BAD_REQUEST']);if(_0x2d453e===user_constant_1[_0xfe5ebb(0x230)][_0xfe5ebb(0x1ab)])throw new common_1[(_0xfe5ebb(0x23e))](_0xfe5ebb(0x1d3),common_1['HttpStatus'][_0xfe5ebb(0x1ee)]);const _0x4d25dd=await this[_0xfe5ebb(0x23d)][_0xfe5ebb(0x219)]({'id':_0xb58de9},{'status':_0x2d453e});if(_0x4d25dd[_0xfe5ebb(0x249)]<=0x0)throw new common_1[(_0xfe5ebb(0x23e))](_0xfe5ebb(0x221),common_1['HttpStatus'][_0xfe5ebb(0x1ee)]);return'修改用户状态成功！';}async[_0x21f9df(0x1ec)](_0x42290f){const _0x16aa61=_0x21f9df,{id:_0x9c87ec}=_0x42290f,_0x4b311c=await this[_0x16aa61(0x23d)][_0x16aa61(0x21b)]({'where':{'id':_0x9c87ec}});if(!_0x4b311c)throw new common_1[(_0x16aa61(0x23e))]('用户不存在！',common_1[_0x16aa61(0x215)][_0x16aa61(0x1ee)]);const _0x2cc01e=_0x16aa61(0x19b),_0x2d2b0d=bcrypt['hashSync'](_0x2cc01e,0xa),_0x5d02a6=await this[_0x16aa61(0x23d)][_0x16aa61(0x219)]({'id':_0x9c87ec},{'password':_0x2d2b0d});if(_0x5d02a6['affected']<=0x0)throw new common_1['HttpException'](_0x16aa61(0x1c7),common_1['HttpStatus'][_0x16aa61(0x1ee)]);return _0x16aa61(0x1a4)+_0x2cc01e+_0x16aa61(0x1c8);}async[_0x21f9df(0x1c3)](_0x5ce025,_0x4d0fc2){const _0x13c420=_0x21f9df;return await this[_0x13c420(0x23d)][_0x13c420(0x219)]({'id':_0x5ce025},{'lastLoginIp':_0x4d0fc2});}async[_0x21f9df(0x1e4)](_0x5bcb1a,_0x1f1fa3){const _0x4b1a31=_0x21f9df,_0x402496=await this[_0x4b1a31(0x23d)][_0x4b1a31(0x21b)]({'where':{'openId':_0x5bcb1a}});if(!_0x402496){const _0x18b014=_0x1f1fa3?_0x1f1fa3[_0x4b1a31(0x1ef)](':')[0x1]:'',_0x5ee989=await this[_0x4b1a31(0x201)](_0x18b014),_0x32d269=await this[_0x4b1a31(0x1a5)](_0x5bcb1a,_0x18b014);return await this['userBalanceService'][_0x4b1a31(0x1b6)](_0x32d269['id'],_0x18b014?_0x5ee989===null||_0x5ee989===void 0x0?void 0x0:_0x5ee989['id']:null),_0x32d269;}return _0x402496;}async['createUserFromOpenId'](_0x1d720c,_0x4a2131){const _0x31a04d=_0x21f9df,_0x3b0648=await this['globalConfigService'][_0x31a04d(0x21f)]([_0x31a04d(0x1f5)]),_0x383b16={'avatar':_0x3b0648,'username':'用户'+(0x0,utils_1['createRandomUid'])(),'status':user_constant_1[_0x31a04d(0x230)][_0x31a04d(0x1fc)],'sex':0x0,'email':(0x0,utils_1[_0x31a04d(0x206)])()+_0x31a04d(0x1a7),'invitedBy':_0x4a2131,'openId':_0x1d720c};return await this[_0x31a04d(0x23d)][_0x31a04d(0x199)](_0x383b16);}async[_0x21f9df(0x243)](_0x350222,_0x2988e5){const _0x3ed56c=_0x21f9df;try{const _0x1f4b88=await this[_0x3ed56c(0x23d)][_0x3ed56c(0x21b)]({'where':{'id':_0x2988e5}});if(!_0x1f4b88)return{'status':![],'msg':_0x3ed56c(0x236)};const _0x1636a1=await this['userEntity'][_0x3ed56c(0x21b)]({'where':{'openId':_0x350222}});if(_0x1636a1)return{'status':![],'msg':_0x3ed56c(0x216)};const _0x2a0d3d=await this[_0x3ed56c(0x23d)][_0x3ed56c(0x219)]({'id':_0x2988e5},{'openId':_0x350222});if(_0x2a0d3d[_0x3ed56c(0x249)]<=0x0)return{'status':![],'msg':_0x3ed56c(0x19e)};return{'status':!![],'msg':_0x3ed56c(0x1f8)};}catch(_0xd70add){return{'status':![],'msg':_0x3ed56c(0x19e)};}}async[_0x21f9df(0x1e0)](_0x5165ee){const _0x79026b=_0x21f9df,_0x375838=await this[_0x79026b(0x23d)][_0x79026b(0x21b)]({'where':{'id':_0x5165ee}});return _0x375838===null||_0x375838===void 0x0?void 0x0:_0x375838['openId'];}async[_0x21f9df(0x1b8)](_0x14d888){const _0x288eb1=_0x21f9df,{username:_0x4a80fe,password:_0x565b6d,phone:_0x5970cf,phoneCode:_0x35b2ba}=_0x14d888,_0x502e2d=await this[_0x288eb1(0x23d)][_0x288eb1(0x21b)]({'where':[{'username':_0x4a80fe},{'phone':_0x5970cf}]});if(_0x502e2d&&_0x502e2d[_0x288eb1(0x1ad)]===_0x4a80fe)throw new common_1[(_0x288eb1(0x23e))](_0x288eb1(0x21e),common_1[_0x288eb1(0x215)][_0x288eb1(0x1ee)]);if(_0x502e2d&&_0x502e2d[_0x288eb1(0x1d7)]===_0x5970cf)throw new common_1[(_0x288eb1(0x23e))]('当前手机号已注册、请勿重复注册！',common_1[_0x288eb1(0x215)]['BAD_REQUEST']);}async[_0x21f9df(0x19d)](_0x2b3317){const _0x362781=_0x21f9df;return await this[_0x362781(0x23d)][_0x362781(0x199)](_0x2b3317);}async[_0x21f9df(0x1c0)](_0x1f2b81){const _0x217820=_0x21f9df,{id:_0x569518,moreId:_0x271726}=_0x1f2b81;if(_0x569518)return await this[_0x217820(0x23d)][_0x217820(0x1c4)]({'id':_0x569518});if(_0x271726)return await this['userEntity'][_0x217820(0x1c4)]({'id':(0x0,typeorm_2['MoreThan'])(_0x271726)});}};UserService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1[_0x21f9df(0x223)])(user_entity_1['UserEntity'])),__param(0x1,(0x0,typeorm_1[_0x21f9df(0x223)])(whiteList_entity_1[_0x21f9df(0x229)])),__param(0x7,(0x0,typeorm_1[_0x21f9df(0x223)])(config_entity_1['ConfigEntity'])),__metadata('design:paramtypes',[typeorm_2['Repository'],typeorm_2[_0x21f9df(0x19f)],typeorm_2[_0x21f9df(0x1de)],verification_service_1[_0x21f9df(0x218)],mailer_1['MailerService'],userBalance_service_1[_0x21f9df(0x1b4)],globalConfig_service_1[_0x21f9df(0x1c2)],typeorm_2['Repository']])],UserService),exports[_0x21f9df(0x1ff)]=UserService;