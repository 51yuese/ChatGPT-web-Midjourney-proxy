'use strict';const _0x389538=_0x4002;(function(_0x4044f5,_0x30c023){const _0x12e5c0=_0x4002,_0x4c83ca=_0x4044f5();while(!![]){try{const _0x507bfe=parseInt(_0x12e5c0(0x10f))/0x1+parseInt(_0x12e5c0(0x12b))/0x2+parseInt(_0x12e5c0(0x13a))/0x3+parseInt(_0x12e5c0(0x113))/0x4*(-parseInt(_0x12e5c0(0x13f))/0x5)+parseInt(_0x12e5c0(0x128))/0x6*(parseInt(_0x12e5c0(0x138))/0x7)+-parseInt(_0x12e5c0(0x141))/0x8+-parseInt(_0x12e5c0(0x119))/0x9;if(_0x507bfe===_0x30c023)break;else _0x4c83ca['push'](_0x4c83ca['shift']());}catch(_0x3c8355){_0x4c83ca['push'](_0x4c83ca['shift']());}}}(_0x1383,0x50a77));var __decorate=this&&this[_0x389538(0x132)]||function(_0x24395f,_0x27d4ac,_0x29414c,_0x1ab7e3){const _0x121e57=_0x389538;var _0x23b392=arguments[_0x121e57(0x136)],_0x3aac48=_0x23b392<0x3?_0x27d4ac:_0x1ab7e3===null?_0x1ab7e3=Object[_0x121e57(0x129)](_0x27d4ac,_0x29414c):_0x1ab7e3,_0x4a5c58;if(typeof Reflect===_0x121e57(0x144)&&typeof Reflect['decorate']==='function')_0x3aac48=Reflect[_0x121e57(0x11f)](_0x24395f,_0x27d4ac,_0x29414c,_0x1ab7e3);else{for(var _0x2efc18=_0x24395f[_0x121e57(0x136)]-0x1;_0x2efc18>=0x0;_0x2efc18--)if(_0x4a5c58=_0x24395f[_0x2efc18])_0x3aac48=(_0x23b392<0x3?_0x4a5c58(_0x3aac48):_0x23b392>0x3?_0x4a5c58(_0x27d4ac,_0x29414c,_0x3aac48):_0x4a5c58(_0x27d4ac,_0x29414c))||_0x3aac48;}return _0x23b392>0x3&&_0x3aac48&&Object['defineProperty'](_0x27d4ac,_0x29414c,_0x3aac48),_0x3aac48;},__metadata=this&&this[_0x389538(0x13b)]||function(_0x105493,_0x2cbbe1){const _0x3487d8=_0x389538;if(typeof Reflect===_0x3487d8(0x144)&&typeof Reflect['metadata']===_0x3487d8(0x115))return Reflect[_0x3487d8(0x120)](_0x105493,_0x2cbbe1);},__param=this&&this['__param']||function(_0x5d3a87,_0x4c88e4){return function(_0x36e0bf,_0xb977a2){_0x4c88e4(_0x36e0bf,_0xb977a2,_0x5d3a87);};};Object['defineProperty'](exports,_0x389538(0x112),{'value':!![]}),exports['QueueService']=void 0x0;const common_1=require(_0x389538(0x142)),bull_1=require(_0x389538(0x114)),utils_1=require(_0x389538(0x125)),midjourney_service_1=require(_0x389538(0x11b)),midjourney_constant_1=require(_0x389538(0x10b)),userBalance_service_1=require(_0x389538(0x116)),globalConfig_service_1=require(_0x389538(0x126));let QueueService=class QueueService{constructor(_0x5de914,_0x6df7dc,_0x1a87a0,_0x3253b1){const _0x5272fc=_0x389538;this[_0x5272fc(0x11e)]=_0x5de914,this[_0x5272fc(0x140)]=_0x6df7dc,this[_0x5272fc(0x111)]=_0x1a87a0,this['globalConfigService']=_0x3253b1,this[_0x5272fc(0x133)]=[];}async[_0x389538(0x12f)](){const _0x1de4da=_0x389538;await this[_0x1de4da(0x11e)]['clean'](0x0,'active'),await this['midjourneyService']['cleanQueue']();}async[_0x389538(0x12d)](_0x2a5f5e,_0x1e383c){const _0x224d3c=_0x389538,{prompt:_0x9f74a7,imgUrl:_0x5efc49,extraParam:_0x5abe0b,orderId:_0x42f6fc,action:action=0x1,drawId:_0x409d01}=_0x2a5f5e;await this[_0x224d3c(0x140)][_0x224d3c(0x122)](_0x1e383c),await this[_0x224d3c(0x111)]['validateBalance'](_0x1e383c,_0x224d3c(0x10e),action===0x2?0x1:0x4);if(action===midjourney_constant_1['MidjourneyActionEnum']['DRAW']||action===midjourney_constant_1[_0x224d3c(0x11d)][_0x224d3c(0x109)]){const _0x1ea9db=''+(0x0,utils_1[_0x224d3c(0x11a)])(),_0x29b599=Object[_0x224d3c(0x130)](Object[_0x224d3c(0x130)]({},_0x2a5f5e),{'userId':_0x1e383c[_0x224d3c(0x10d)]['id'],'randomDrawId':_0x1ea9db}),_0x592892=await this[_0x224d3c(0x140)]['addDrawQueue'](_0x29b599),_0x1a255f=await this[_0x224d3c(0x123)][_0x224d3c(0x131)]([_0x224d3c(0x10c)])||0x30d40,_0x2b1e04=await this['mjDrawQueue'][_0x224d3c(0x118)](_0x224d3c(0x10e),{'id':_0x592892['id'],'action':_0x5efc49?0x4:0x1,'userId':_0x1e383c[_0x224d3c(0x10d)]['id']},{'delay':0x3e8,'timeout':+_0x1a255f});return this[_0x224d3c(0x133)][_0x224d3c(0x13c)](_0x2b1e04['id']),await this['userBalanceService'][_0x224d3c(0x13e)](_0x1e383c[_0x224d3c(0x10d)]['id'],_0x224d3c(0x10e),0x4,0x4),!![];}if(!_0x409d01||!_0x42f6fc)throw new common_1[(_0x224d3c(0x11c))](_0x224d3c(0x117),common_1['HttpStatus'][_0x224d3c(0x12e)]);if(action===midjourney_constant_1['MidjourneyActionEnum'][_0x224d3c(0x12a)]){const _0x5dc4c9=await this[_0x224d3c(0x140)][_0x224d3c(0x127)](action,_0x409d01,_0x42f6fc),{custom_id:_0x46ea02}=_0x5dc4c9;await this[_0x224d3c(0x140)][_0x224d3c(0x134)](_0x46ea02);const _0x464dfe=Object[_0x224d3c(0x130)](Object[_0x224d3c(0x130)](Object[_0x224d3c(0x130)]({},_0x2a5f5e),{'userId':_0x1e383c['user']['id']}),_0x5dc4c9),_0x230f5a=await this[_0x224d3c(0x140)][_0x224d3c(0x110)](_0x464dfe),_0x180077=await this[_0x224d3c(0x123)][_0x224d3c(0x131)]([_0x224d3c(0x10c)])||0x30d40,_0x3da2a8=await this[_0x224d3c(0x11e)][_0x224d3c(0x118)](_0x224d3c(0x10e),{'id':_0x230f5a['id'],'action':action,'userId':_0x1e383c[_0x224d3c(0x10d)]['id']},{'delay':0x3e8,'timeout':+_0x180077});await this['userBalanceService'][_0x224d3c(0x13e)](_0x1e383c['user']['id'],_0x224d3c(0x10e),0x1,0x1),this[_0x224d3c(0x133)][_0x224d3c(0x13c)](_0x3da2a8['id']);return;}if(action===midjourney_constant_1[_0x224d3c(0x11d)][_0x224d3c(0x12c)]){const _0x273762=await this[_0x224d3c(0x140)][_0x224d3c(0x127)](action,_0x409d01,_0x42f6fc),_0x245ebf=Object[_0x224d3c(0x130)](Object[_0x224d3c(0x130)](Object[_0x224d3c(0x130)]({},_0x2a5f5e),{'userId':_0x1e383c[_0x224d3c(0x10d)]['id']}),_0x273762),_0x33e592=await this['midjourneyService'][_0x224d3c(0x110)](_0x245ebf),_0x294a1e=await this[_0x224d3c(0x123)]['getConfigs']([_0x224d3c(0x10c)])||0x30d40,_0x210c66=await this['mjDrawQueue']['add'](_0x224d3c(0x10e),{'id':_0x33e592['id'],'action':action,'userId':_0x1e383c['user']['id']},{'delay':0x3e8,'timeout':+_0x294a1e});this[_0x224d3c(0x133)]['push'](_0x210c66['id']),await this['userBalanceService']['deductFromBalance'](_0x1e383c[_0x224d3c(0x10d)]['id'],'mjDraw',0x4,0x4);return;}if(action===midjourney_constant_1[_0x224d3c(0x11d)][_0x224d3c(0x10a)]){const _0x385fcf=await this[_0x224d3c(0x140)]['getDrawActionDetail'](action,_0x409d01,_0x42f6fc),_0x171728=Object[_0x224d3c(0x130)](Object[_0x224d3c(0x130)](Object[_0x224d3c(0x130)]({},_0x2a5f5e),{'userId':_0x1e383c['user']['id']}),_0x385fcf),_0x1d8887=await this[_0x224d3c(0x140)]['addDrawQueue'](_0x171728),_0x4cca13=await this[_0x224d3c(0x123)][_0x224d3c(0x131)]([_0x224d3c(0x10c)])||0x30d40,_0x167964=await this['mjDrawQueue'][_0x224d3c(0x118)](_0x224d3c(0x10e),{'id':_0x1d8887['id'],'action':action,'userId':_0x1e383c[_0x224d3c(0x10d)]['id']},{'delay':0x3e8,'timeout':+_0x4cca13});this[_0x224d3c(0x133)][_0x224d3c(0x13c)](_0x167964['id']),await this[_0x224d3c(0x111)][_0x224d3c(0x13e)](_0x1e383c[_0x224d3c(0x10d)]['id'],_0x224d3c(0x10e),0x4,0x4);return;}if(action===midjourney_constant_1[_0x224d3c(0x11d)][_0x224d3c(0x137)]){const _0x2a2ccd=await this['midjourneyService'][_0x224d3c(0x127)](action,_0x409d01,_0x42f6fc),_0xb36fc2=Object[_0x224d3c(0x130)](Object[_0x224d3c(0x130)](Object[_0x224d3c(0x130)]({},_0x2a5f5e),{'userId':_0x1e383c[_0x224d3c(0x10d)]['id']}),_0x2a2ccd),_0x45bff3=await this[_0x224d3c(0x140)]['addDrawQueue'](_0xb36fc2),_0x5729ea=await this[_0x224d3c(0x123)][_0x224d3c(0x131)]([_0x224d3c(0x10c)])||0x30d40,_0x4319ce=await this[_0x224d3c(0x11e)][_0x224d3c(0x118)]('mjDraw',{'id':_0x45bff3['id'],'action':action,'userId':_0x1e383c['user']['id']},{'delay':0x3e8,'timeout':+_0x5729ea});this[_0x224d3c(0x133)][_0x224d3c(0x13c)](_0x4319ce['id']),await this[_0x224d3c(0x111)][_0x224d3c(0x13e)](_0x1e383c[_0x224d3c(0x10d)]['id'],_0x224d3c(0x10e),0x4,0x4);return;}if(action===midjourney_constant_1[_0x224d3c(0x11d)]['ZOOM']){const _0x123513=await this[_0x224d3c(0x140)]['getDrawActionDetail'](action,_0x409d01,_0x42f6fc),_0x45c965=Object[_0x224d3c(0x130)](Object[_0x224d3c(0x130)](Object[_0x224d3c(0x130)]({},_0x2a5f5e),{'userId':_0x1e383c[_0x224d3c(0x10d)]['id']}),_0x123513),_0x44510c=await this[_0x224d3c(0x140)][_0x224d3c(0x110)](_0x45c965),_0x32e924=await this[_0x224d3c(0x123)]['getConfigs'](['mjTimeoutMs'])||0x30d40,_0x17d587=await this[_0x224d3c(0x11e)][_0x224d3c(0x118)]('mjDraw',{'id':_0x44510c['id'],'action':action,'userId':_0x1e383c[_0x224d3c(0x10d)]['id']},{'delay':0x3e8,'timeout':+_0x32e924});this[_0x224d3c(0x133)][_0x224d3c(0x13c)](_0x17d587['id']),await this[_0x224d3c(0x111)][_0x224d3c(0x13e)](_0x1e383c[_0x224d3c(0x10d)]['id'],_0x224d3c(0x10e),0x4,0x4);return;}}async[_0x389538(0x139)](){const _0x551369=_0x389538;return{'jobIds':this[_0x551369(0x133)]};}};function _0x4002(_0x330c75,_0x2b8aee){const _0x1383d6=_0x1383();return _0x4002=function(_0x40027b,_0x4b7568){_0x40027b=_0x40027b-0x109;let _0x545f43=_0x1383d6[_0x40027b];return _0x545f43;},_0x4002(_0x330c75,_0x2b8aee);}QueueService=__decorate([__param(0x0,(0x0,bull_1['InjectQueue'])(_0x389538(0x143))),__metadata(_0x389538(0x121),[Object,midjourney_service_1[_0x389538(0x124)],userBalance_service_1[_0x389538(0x13d)],globalConfig_service_1['GlobalConfigService']])],QueueService),exports[_0x389538(0x135)]=QueueService;function _0x1383(){const _0x20a986=['getDrawActionDetail','2019582SIWnBd','getOwnPropertyDescriptor','UPSCALE','1270660qCvwRB','VARIATION','addMjDrawQueue','BAD_REQUEST','onApplicationBootstrap','assign','getConfigs','__decorate','jobIds','checkIsUpscale','QueueService','length','VARY','7jItSvj','getQueue','366027vjwTte','__metadata','push','UserBalanceService','deductFromBalance','249245mxhidF','midjourneyService','283656eBYMPC','@nestjs/common','MJDRAW','object','GENERATE','REGENERATE','../../common/constants/midjourney.constant','mjTimeoutMs','user','mjDraw','67912uxJSlG','addDrawQueue','userBalanceService','__esModule','44zitYBM','@nestjs/bull','function','../userBalance/userBalance.service','缺少必要参数！','add','2229237yFpaDk','createRandomUid','../midjourney/midjourney.service','HttpException','MidjourneyActionEnum','mjDrawQueue','decorate','metadata','design:paramtypes','checkLimit','globalConfigService','MidjourneyService','../../common/utils','../globalConfig/globalConfig.service'];_0x1383=function(){return _0x20a986;};return _0x1383();}