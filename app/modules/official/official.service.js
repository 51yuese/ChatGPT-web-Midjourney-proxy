'use strict';const _0x38b96a=_0x1497;(function(_0x5ee61b,_0x2fca9c){const _0x1f709f=_0x1497,_0x44e895=_0x5ee61b();while(!![]){try{const _0x27d6c0=parseInt(_0x1f709f(0x1f3))/0x1+parseInt(_0x1f709f(0x1d6))/0x2*(parseInt(_0x1f709f(0x198))/0x3)+parseInt(_0x1f709f(0x1ce))/0x4*(parseInt(_0x1f709f(0x1ec))/0x5)+parseInt(_0x1f709f(0x1ab))/0x6+-parseInt(_0x1f709f(0x1af))/0x7+parseInt(_0x1f709f(0x195))/0x8*(-parseInt(_0x1f709f(0x1cc))/0x9)+parseInt(_0x1f709f(0x1e3))/0xa*(-parseInt(_0x1f709f(0x1db))/0xb);if(_0x27d6c0===_0x2fca9c)break;else _0x44e895['push'](_0x44e895['shift']());}catch(_0x5779f1){_0x44e895['push'](_0x44e895['shift']());}}}(_0x22d2,0x5aa60));var __decorate=this&&this[_0x38b96a(0x196)]||function(_0x601492,_0x24249f,_0x5676ad,_0x605088){const _0x1e8071=_0x38b96a;var _0x486bae=arguments['length'],_0x37a154=_0x486bae<0x3?_0x24249f:_0x605088===null?_0x605088=Object['getOwnPropertyDescriptor'](_0x24249f,_0x5676ad):_0x605088,_0x1a724d;if(typeof Reflect===_0x1e8071(0x1c1)&&typeof Reflect['decorate']===_0x1e8071(0x1f5))_0x37a154=Reflect[_0x1e8071(0x194)](_0x601492,_0x24249f,_0x5676ad,_0x605088);else{for(var _0x45df85=_0x601492[_0x1e8071(0x1c6)]-0x1;_0x45df85>=0x0;_0x45df85--)if(_0x1a724d=_0x601492[_0x45df85])_0x37a154=(_0x486bae<0x3?_0x1a724d(_0x37a154):_0x486bae>0x3?_0x1a724d(_0x24249f,_0x5676ad,_0x37a154):_0x1a724d(_0x24249f,_0x5676ad))||_0x37a154;}return _0x486bae>0x3&&_0x37a154&&Object['defineProperty'](_0x24249f,_0x5676ad,_0x37a154),_0x37a154;},__metadata=this&&this['__metadata']||function(_0x4745ea,_0x2e701e){const _0x506f5f=_0x38b96a;if(typeof Reflect===_0x506f5f(0x1c1)&&typeof Reflect[_0x506f5f(0x1a8)]==='function')return Reflect[_0x506f5f(0x1a8)](_0x4745ea,_0x2e701e);};function _0x22d2(){const _0x3e0b63=['genXmlMsgByConfig','checkAutoReply','</CreateTime>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<MsgType><![CDATA[text]]></MsgType>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<Content><![CDATA[','length','default','redisCacheService','../../common/utils','jsapi_ticket=','authService','97272VxHLFA','split','806932bvPoyP','@nestjs/common','get','getJsapiTicket','../redisCache/redisCache.service','getConfigs','autoreplyService','./../autoreply/autoreply.service','12192Rhcrif','str:\x20','&response_type=code&scope=snsapi_base&state=weChatLogin#wechat_redirect','&redirect_uri=','getJwtToken','69850CtCcxR','bindWxBySceneStr','QR_STR_SCENE','回跳跳转地址:\x20','getQRSceneStrByBind','globalConfigService','openId','post','1380JYWIBh','./vo/Login.vo','getQRCodeTicket','AutoreplyService','official','wechatOfficialToken','sha1','verify','loginBySceneStr','15HCdsTi','wechatAccessToken','HttpException','appId:\x20',']]></FromUserName>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<CreateTime>','user','__esModule','27130isJoQE','jsapiTicket:\x20','function','fromusername','scan','decorate','40eOLdVP','__decorate','loginByCode','333oqUWeH','createHash','getAccessToken','log','fetchQRCodeTicket','jiangly','RedisCacheService','https://api.weixin.qq.com/sns/oauth2/access_token?appid=',']]></Content>\x0a\x20\x20\x20\x20</xml>','Injectable','getQRSceneStr','&timestamp=','officialAutoReplyText','join','BAD_REQUEST','tousername','metadata','createRandomNonceStr','userService','4107378BLYDet','../../common/constants/redisKey.constant','&secret=','OfficialService','4843384vtnNrD','axios','scanedSceneStrMap','bindWx','digest','https://open.weixin.qq.com/connect/oauth2/authorize?appid=','wechatOfficialAppSecret','getTime','wechatOfficialAppId','genXmlMsg','hex','getUserOpenId','authToken',']]></ToUserName>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<FromUserName><![CDATA[','OfficialLoginVO','crypto','HttpStatus','\x0a\x20\x20\x20\x20<xml>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<ToUserName><![CDATA[','object','sceneStrMap'];_0x22d2=function(){return _0x3e0b63;};return _0x22d2();}Object['defineProperty'](exports,_0x38b96a(0x1f2),{'value':!![]}),exports[_0x38b96a(0x1ae)]=void 0x0;const globalConfig_service_1=require('./../globalConfig/globalConfig.service'),auth_service_1=require('./../auth/auth.service'),user_service_1=require('./../user/user.service'),autoreply_service_1=require(_0x38b96a(0x1d5)),common_1=require(_0x38b96a(0x1cf)),crypto=require(_0x38b96a(0x1be)),axios_1=require(_0x38b96a(0x1b0)),utils_1=require(_0x38b96a(0x1c9)),Login_vo_1=require(_0x38b96a(0x1e4)),redisKey_constant_1=require(_0x38b96a(0x1ac)),redisCache_service_1=require(_0x38b96a(0x1d2));function _0x1497(_0x290a96,_0x191e08){const _0x22d240=_0x22d2();return _0x1497=function(_0x1497a3,_0x256765){_0x1497a3=_0x1497a3-0x193;let _0x397d9d=_0x22d240[_0x1497a3];return _0x397d9d;},_0x1497(_0x290a96,_0x191e08);}let OfficialService=class OfficialService{constructor(_0x32c3e8,_0x3abe9f,_0x1ff503,_0x34dd4b,_0x3337e){const _0x2e6529=_0x38b96a;this[_0x2e6529(0x1d4)]=_0x32c3e8,this[_0x2e6529(0x1aa)]=_0x3abe9f,this[_0x2e6529(0x1cb)]=_0x1ff503,this['globalConfigService']=_0x34dd4b,this[_0x2e6529(0x1c8)]=_0x3337e,this[_0x2e6529(0x1c2)]={},this[_0x2e6529(0x1b1)]={};}async['onModuleInit'](){await this['globalConfigService']['getWechatAccessToken'](!![]);}async[_0x38b96a(0x1a2)](_0x33d6c4){const _0x423d3e=_0x38b96a,{invitedBy:_0x5bf7e4}=_0x33d6c4;let _0x4b39d2=(0x0,utils_1[_0x423d3e(0x1a9)])(0x20);return _0x5bf7e4&&(_0x4b39d2+=':'+_0x5bf7e4),this['sceneStrMap'][_0x4b39d2]=!![],_0x4b39d2;}async[_0x38b96a(0x1df)](_0x1ccd3e){const _0x2855d4=_0x38b96a,{id:_0x539c07}=_0x1ccd3e[_0x2855d4(0x1f1)],_0x1d10b7=(0x0,utils_1[_0x2855d4(0x1a9)])(0x20)+'/'+_0x539c07;return this['sceneStrMap'][_0x1d10b7]=!![],_0x1d10b7;}async[_0x38b96a(0x1e5)](_0x16a3ba){return this['fetchQRCodeTicket'](_0x16a3ba);}async['getRedirectUrl'](_0x5999ef){const _0x4f65bd=_0x38b96a,_0x34d695=await this[_0x4f65bd(0x1e0)][_0x4f65bd(0x1d3)]([_0x4f65bd(0x1b7)]),_0x361724=_0x4f65bd(0x1b4)+_0x34d695+_0x4f65bd(0x1d9)+encodeURIComponent(_0x5999ef)+_0x4f65bd(0x1d8);return console[_0x4f65bd(0x19b)](_0x4f65bd(0x1de),_0x361724),_0x361724;}async[_0x38b96a(0x1d1)](_0x22a881){const _0x126c7c=_0x38b96a,_0x2d810c=(0x0,utils_1[_0x126c7c(0x1a9)])(0x20),_0x30c180=(Date['now']()/0x3e8)['toFixed'](0x0),_0xe55fc8=await this['globalConfigService'][_0x126c7c(0x1d3)](['wechatJsapiTicket']);console[_0x126c7c(0x19b)](_0x126c7c(0x1f4),_0xe55fc8);const _0x359b76=await this[_0x126c7c(0x1e0)]['getConfigs'](['wechatOfficialAppId']);console[_0x126c7c(0x19b)](_0x126c7c(0x1ef),_0x359b76);const _0x5d1026=_0x126c7c(0x1ca)+_0xe55fc8+'&noncestr='+_0x2d810c+_0x126c7c(0x1a3)+_0x30c180+'&url='+_0x22a881;console[_0x126c7c(0x19b)](_0x126c7c(0x1d7),_0x5d1026);const _0x52b8ca=this['sha1'](_0x5d1026);return{'appId':_0x359b76,'nonceStr':_0x2d810c,'timestamp':_0x30c180,'signature':_0x52b8ca};}async[_0x38b96a(0x19c)](_0xa81305){const _0x408726=_0x38b96a,_0x25ea72=await this[_0x408726(0x1e0)][_0x408726(0x1d3)]([_0x408726(0x1ed)]),_0xa78027={'action_name':_0x408726(0x1dd),'action_info':{'scene':{'scene_str':_0xa81305}}},_0x237f77=await axios_1[_0x408726(0x1c7)][_0x408726(0x1e2)]('https://api.weixin.qq.com/cgi-bin/qrcode/create?access_token='+_0x25ea72,_0xa78027),{data:{errmsg:_0x50624a,ticket:_0x5a8610}}=_0x237f77;if(_0x50624a)throw new common_1['HttpException'](_0x50624a,common_1[_0x408726(0x1bf)][_0x408726(0x1a6)]);return _0x5a8610;}async[_0x38b96a(0x197)](_0x357101,_0x565623){const _0x463345=_0x38b96a,_0x53ca24=await this[_0x463345(0x1e0)][_0x463345(0x1d3)]([_0x463345(0x1b7)]),_0x317dfe=await this[_0x463345(0x1e0)][_0x463345(0x1d3)]([_0x463345(0x1b5)]),_0x31418b=await axios_1[_0x463345(0x1c7)][_0x463345(0x1d0)](_0x463345(0x19f)+_0x53ca24+_0x463345(0x1ad)+_0x317dfe+'&code='+_0x565623+'&grant_type=authorization_code'),{data:{errmsg:_0x3e95a0,openid:_0x3de6ad}}=_0x31418b;if(_0x3e95a0)throw new common_1[(_0x463345(0x1ee))](_0x3e95a0,common_1[_0x463345(0x1bf)][_0x463345(0x1a6)]);let _0x47ee00,_0x2f7740=new Login_vo_1[(_0x463345(0x1bd))]();return _0x2f7740[_0x463345(0x1e1)]=_0x3de6ad,_0x47ee00=await this['userService']['getUserOpenId'](_0x3de6ad),_0x47ee00&&(_0x2f7740[_0x463345(0x1bb)]=await this[_0x463345(0x1cb)][_0x463345(0x1da)](_0x47ee00,_0x357101)),_0x2f7740;}async[_0x38b96a(0x193)](_0x5931f6,_0x4f24cd){const _0xf4b954=_0x38b96a;if(!this[_0xf4b954(0x1c2)][_0x4f24cd])throw new common_1[(_0xf4b954(0x1ee))]('非法参数',common_1[_0xf4b954(0x1bf)][_0xf4b954(0x1a6)]);this[_0xf4b954(0x1b1)][_0x4f24cd]=_0x5931f6;}async[_0x38b96a(0x1eb)](_0x1bc3b7,_0x43c6b7){const _0xd002c=_0x38b96a;if(!this[_0xd002c(0x1c2)][_0x43c6b7])return;const _0xf971fc=this[_0xd002c(0x1b1)][_0x43c6b7];if(!_0xf971fc)return new Login_vo_1['OfficialLoginVO']();let _0x36c327,_0xdf683=new Login_vo_1[(_0xd002c(0x1bd))]();return _0xdf683[_0xd002c(0x1e1)]=_0xf971fc,_0x36c327=await this[_0xd002c(0x1aa)][_0xd002c(0x1ba)](_0xf971fc),_0x36c327&&(_0xdf683[_0xd002c(0x1bb)]=await this['authService']['getJwtToken'](_0x36c327,_0x1bc3b7)),delete this[_0xd002c(0x1b1)][_0x43c6b7],_0xdf683;}async['scanBindWx'](_0x3355a2,_0x132077){const _0x55afb9=_0x38b96a;if(!this[_0x55afb9(0x1c2)][_0x132077])throw new common_1[(_0x55afb9(0x1ee))]('非法参数',common_1['HttpStatus'][_0x55afb9(0x1a6)]);const _0x2896bd=_0x132077[_0x55afb9(0x1cd)]('/')[0x1],_0x55858c=await this[_0x55afb9(0x1aa)][_0x55afb9(0x1b2)](_0x3355a2,_0x2896bd);this[_0x55afb9(0x1b1)][_0x132077]=_0x55858c;}async[_0x38b96a(0x1dc)](_0x3f5005,_0x5660cb){const _0x3f1a24=_0x38b96a;if(!this[_0x3f1a24(0x1c2)][_0x5660cb])throw new common_1['HttpException']('非法参数',common_1[_0x3f1a24(0x1bf)][_0x3f1a24(0x1a6)]);const {id:_0x4ecf48}=_0x3f5005[_0x3f1a24(0x1f1)],_0x8ce858=this['scanedSceneStrMap'][_0x5660cb];if(!_0x8ce858)return'';return delete this['scanedSceneStrMap'][_0x5660cb],_0x8ce858;}async[_0x38b96a(0x1ea)](_0xac98e1,_0x47c36d,_0x58058c){const _0x32c865=_0x38b96a,_0x5a9de7=await this[_0x32c865(0x1e0)][_0x32c865(0x1d3)]([_0x32c865(0x1e8)])||_0x32c865(0x19d);return await this[_0x32c865(0x1e9)]([_0x5a9de7,_0x47c36d,_0x58058c]['sort']()[_0x32c865(0x1a5)](''))==_0xac98e1;}[_0x38b96a(0x1e9)](_0x5c15c2){const _0x534fd4=_0x38b96a;return crypto[_0x534fd4(0x199)]('sha1')['update'](_0x5c15c2)[_0x534fd4(0x1b3)](_0x534fd4(0x1b9));}async[_0x38b96a(0x1c3)](_0x24f880,_0x18ae2b){const _0x348084=_0x38b96a,_0x58b057=await this[_0x348084(0x1e0)][_0x348084(0x1d3)]([_0x18ae2b]);return this[_0x348084(0x1b8)](_0x24f880,_0x58b057);}async[_0x38b96a(0x1b8)](_0x51e34f,_0x41118d){const _0x3cdccf=_0x38b96a;return _0x3cdccf(0x1c0)+_0x51e34f[_0x3cdccf(0x1f6)][0x0]+_0x3cdccf(0x1bc)+_0x51e34f[_0x3cdccf(0x1a7)][0x0]+_0x3cdccf(0x1f0)+new Date()[_0x3cdccf(0x1b6)]()+_0x3cdccf(0x1c5)+_0x41118d+_0x3cdccf(0x1a0);}async['aotoPlay'](_0x178d98){const _0x278ea7=_0x38b96a;let _0x147bd6=await this['autoreplyService'][_0x278ea7(0x1c4)](_0x178d98);if(!_0x147bd6){const _0x5406a5=await this[_0x278ea7(0x1e0)][_0x278ea7(0x1d3)]([_0x278ea7(0x1a4)]);_0x147bd6=_0x5406a5;}return _0x147bd6;}async[_0x38b96a(0x19a)](_0x326212,_0x1da9fc){const _0x2079ce=_0x38b96a;console[_0x2079ce(0x19b)](_0x326212['ip']);if(_0x1da9fc===_0x2079ce(0x1e7)){const _0x3a52e8=await this['globalConfigService'][_0x2079ce(0x1d3)]([_0x2079ce(0x1ed)]);return _0x3a52e8;}else{if(_0x1da9fc==='mini'){const _0x322e25=await this[_0x2079ce(0x1c8)]['get']({'key':redisKey_constant_1['WE_MINI_ACCESS_KEY']});return _0x322e25;}else throw new common_1[(_0x2079ce(0x1ee))](null,common_1['HttpStatus']['BAD_REQUEST']);}}};OfficialService=__decorate([(0x0,common_1[_0x38b96a(0x1a1)])(),__metadata('design:paramtypes',[autoreply_service_1[_0x38b96a(0x1e6)],user_service_1['UserService'],auth_service_1['AuthService'],globalConfig_service_1['GlobalConfigService'],redisCache_service_1[_0x38b96a(0x19e)]])],OfficialService),exports['OfficialService']=OfficialService;