'use strict';const _0x3c15d9=_0x332f;function _0x5f4a(){const _0x1335ca=['updateGptsChat','object','initAllModelGroups','modelInfo','gptsModelEntity','set','decorate','@nestjs/typeorm','use_cnt','getAllGptsFormNetworkStore','IsNull','InjectRepository','ceil','metadata','当前应用已经开启了一个对话无需新建了！','has','data','favorite','getExistGpts','env','key','handleGetGroup','name','id\x20=\x20:id','findAndCount','Repository','groupId','UNAUTHORIZED','modelId','modelName','modelsService','BAD_REQUEST','GptsGroupEntity','useCount','../../common/constants/model.constant','非法操作、您在删除一个非法资源！','handleRemoveGroup','GptsModelEntity','DESC','__metadata','HttpStatus','demoData','onModuleInit','split','ModelsService','HttpException','recommend','getModelByType','useToken\x20+\x20','findOne','__param','8RtUHwD','20550oGaWEF','error:\x20','chatLogService','当前用户没有创建GPT对话！','UserAppsEntity','模型组不存在！','update','1176127jsBuyB','hideString','where','forEach','handleAddGptsBatch','affected','model','Injectable','super','Like','@nestjs/common','新对话','then','appId','Logger','模型组已存在！','defineProperty','39079007PxwjxD','add','logo','user','模型组存在GPTS应用,不允许删除！','config','log','axios','handleAddGpts','design:paramtypes','gid','../app/userApps.entity','GptsService','应用分类不存在！','10nZJQTL','28qgrgMF','389495UYHycB','gptsApp','delAllGptsChat','authorization','../../common/utils','36oFjnBJ','createQueryBuilder','save','title','canUpload','handleQueryGroup','execute','cleanAllGptOnlyOne','handleAddGroup','./gpts.chat.entity','listByFrontType','message','length','parse','random','userId','headers','mine','gptsChatEntity','handleCreateChat','filter','info','getGroupInfoFromId','catch','reduce','gptsGroupEntity','568746hAufLB','模型组不存在,无法删除！','JWT_SECRET','EModelType','includes','getOwnPropertyDescriptor','status','function','gpts','./gpts.group.entity','map','1637343uxmdtt','9356832hnnhel','role','stringify','userAppsEntity','./gpts.model.entity','handleUpdateGroup','isSticky','get','assign','collectCount','groupName','useCount\x20+\x201','handleGetChat','error','canAudio','count','https://gpts.ddaiai.com/open/gpts','popular','非法操作、您在使用一个不存在的应用！','GPTs对话组编号和用户编号不匹配，请登录之后创建新的对话！','APP','saveGptsUseLog','gpts不存在,无法删除！','请先登录！','desc','relModel','push','allGroupMap','delete','cleared\x20model\x20length','find','removeLogsBatch','order','tempModalMap'];_0x5f4a=function(){return _0x1335ca;};return _0x5f4a();}(function(_0xc66a2d,_0x108b85){const _0x4182fd=_0x332f,_0x507fc1=_0xc66a2d();while(!![]){try{const _0x323ba7=-parseInt(_0x4182fd(0xc8))/0x1+parseInt(_0x4182fd(0xc0))/0x2*(parseInt(_0x4182fd(0xc1))/0x3)+parseInt(_0x4182fd(0xee))/0x4*(-parseInt(_0x4182fd(0xe9))/0x5)+parseInt(_0x4182fd(0x108))/0x6*(parseInt(_0x4182fd(0xe8))/0x7)+-parseInt(_0x4182fd(0x114))/0x8+-parseInt(_0x4182fd(0x113))/0x9+-parseInt(_0x4182fd(0xe7))/0xa*(-parseInt(_0x4182fd(0xd9))/0xb);if(_0x323ba7===_0x108b85)break;else _0x507fc1['push'](_0x507fc1['shift']());}catch(_0x4e3416){_0x507fc1['push'](_0x507fc1['shift']());}}}(_0x5f4a,0xb2554));var __decorate=this&&this['__decorate']||function(_0x7f959a,_0xc56c6c,_0x48c014,_0x12693c){const _0x223a8c=_0x332f;var _0xf61d85=arguments[_0x223a8c(0xfa)],_0x4202bf=_0xf61d85<0x3?_0xc56c6c:_0x12693c===null?_0x12693c=Object[_0x223a8c(0x10d)](_0xc56c6c,_0x48c014):_0x12693c,_0x296eff;if(typeof Reflect==='object'&&typeof Reflect[_0x223a8c(0x13c)]===_0x223a8c(0x10f))_0x4202bf=Reflect['decorate'](_0x7f959a,_0xc56c6c,_0x48c014,_0x12693c);else{for(var _0x4a4f51=_0x7f959a['length']-0x1;_0x4a4f51>=0x0;_0x4a4f51--)if(_0x296eff=_0x7f959a[_0x4a4f51])_0x4202bf=(_0xf61d85<0x3?_0x296eff(_0x4202bf):_0xf61d85>0x3?_0x296eff(_0xc56c6c,_0x48c014,_0x4202bf):_0x296eff(_0xc56c6c,_0x48c014))||_0x4202bf;}return _0xf61d85>0x3&&_0x4202bf&&Object[_0x223a8c(0xd8)](_0xc56c6c,_0x48c014,_0x4202bf),_0x4202bf;},__metadata=this&&this[_0x3c15d9(0xb4)]||function(_0x1934c1,_0x2683d0){const _0x1a3d38=_0x3c15d9;if(typeof Reflect===_0x1a3d38(0x137)&&typeof Reflect['metadata']===_0x1a3d38(0x10f))return Reflect[_0x1a3d38(0x143)](_0x1934c1,_0x2683d0);},__param=this&&this[_0x3c15d9(0xbf)]||function(_0x4707ca,_0x2a285a){return function(_0x4c0120,_0x101a8c){_0x2a285a(_0x4c0120,_0x101a8c,_0x4707ca);};};Object[_0x3c15d9(0xd8)](exports,'__esModule',{'value':!![]}),exports[_0x3c15d9(0xe5)]=void 0x0;const common_1=require(_0x3c15d9(0xd2)),typeorm_1=require(_0x3c15d9(0x13d)),gpts_group_entity_1=require(_0x3c15d9(0x111)),typeorm_2=require('typeorm'),gpts_model_entity_1=require(_0x3c15d9(0x118)),axios_1=require(_0x3c15d9(0xe0)),jwt=require('jsonwebtoken'),gpts_chat_entity_1=require(_0x3c15d9(0xf7)),chatLog_service_1=require('../chatLog/chatLog.service'),utils_1=require(_0x3c15d9(0xed)),models_service_1=require('../models/models.service'),userApps_entity_1=require(_0x3c15d9(0xe4)),model_constant_1=require(_0x3c15d9(0xaf));function _0x332f(_0x31e655,_0x4bb51e){const _0x5f4aff=_0x5f4a();return _0x332f=function(_0x332f94,_0x1c97bb){_0x332f94=_0x332f94-0xaa;let _0x19a373=_0x5f4aff[_0x332f94];return _0x19a373;},_0x332f(_0x31e655,_0x4bb51e);}let GptsService=class GptsService{constructor(_0x5833dd,_0xb4288c,_0x5b0676,_0x23c503,_0x3bf65f,_0x188573){const _0x3be033=_0x3c15d9;this[_0x3be033(0x117)]=_0x5833dd,this['gptsGroupEntity']=_0xb4288c,this[_0x3be033(0x13a)]=_0x5b0676,this['gptsChatEntity']=_0x23c503,this[_0x3be033(0xab)]=_0x3bf65f,this[_0x3be033(0xc3)]=_0x188573,this['allGroupMap']={},this[_0x3be033(0x135)]=new Map();}async[_0x3c15d9(0xb7)](){await this['initAllModelGroups']();}async[_0x3c15d9(0x138)](){const _0x2746f6=_0x3c15d9;this[_0x2746f6(0x12f)]={};const _0x22788f=await this[_0x2746f6(0x107)]['find']();if(_0x22788f[_0x2746f6(0xfa)]===0x0)return![];return this[_0x2746f6(0x12f)]=_0x22788f['reduce']((_0x42fca8,_0x55914d)=>{return _0x42fca8[_0x55914d['id']]={'groupName':_0x55914d['groupName']},_0x42fca8;},{}),!![];}async[_0x3c15d9(0x13f)](){const _0x29cd61=_0x3c15d9,_0x351c17=await axios_1['default'][_0x29cd61(0x11b)](_0x29cd61(0x124))[_0x29cd61(0xd4)](_0x190ffe=>_0x190ffe[_0x29cd61(0x146)]);if(_0x351c17&&_0x351c17[_0x29cd61(0x110)]){const {gpts:_0x4f6a8e}=_0x351c17;if(_0x4f6a8e[_0x29cd61(0xfa)]){const _0x250ae0=_0x4f6a8e[_0x29cd61(0x112)](_0x362412=>{const _0x2f828c=_0x29cd61;return{'groupId':0x1,'useCount':~~_0x362412[_0x2f828c(0x13e)],'modelId':_0x362412[_0x2f828c(0xe3)],'logo':_0x362412[_0x2f828c(0xdb)],'desc':_0x362412[_0x2f828c(0x103)],'modelName':_0x362412[_0x2f828c(0x14c)],'remark':_0x362412['author_name']};});await this[_0x29cd61(0x13a)][_0x29cd61(0xf0)](_0x250ae0);}}}async[_0x3c15d9(0xf5)](){const _0x51caed=_0x3c15d9,_0x560900=await this[_0x51caed(0x13a)][_0x51caed(0x132)]();if(_0x560900[_0x51caed(0xfa)]===0x0)return;let _0x481a4a={};const _0x489efe=_0x560900[_0x51caed(0x106)]((_0xff3887,_0x1d53f5)=>{const _0x3b60e8=_0x51caed;return!_0x481a4a[_0x1d53f5[_0x3b60e8(0xaa)]]&&(_0x481a4a[_0x1d53f5[_0x3b60e8(0xaa)]]=_0x1d53f5[_0x3b60e8(0xaa)],_0xff3887[_0x3b60e8(0x12e)](_0x1d53f5)),_0xff3887;},[]);_0x489efe[_0x51caed(0xfa)]>0x0&&(console['log'](_0x51caed(0x131),_0x489efe[_0x51caed(0xfa)]),await this[_0x51caed(0x13a)][_0x51caed(0xf0)](_0x489efe));}async[_0x3c15d9(0xf6)](_0x4a4e26){const _0x1cf7e3=_0x3c15d9;try{const {groupName:_0x3f5953}=_0x4a4e26,_0x326d29=await this[_0x1cf7e3(0x107)][_0x1cf7e3(0xbe)]({'where':{'groupName':_0x3f5953}});if(_0x326d29)throw new common_1['HttpException'](_0x1cf7e3(0xd7),common_1['HttpStatus'][_0x1cf7e3(0xac)]);const _0x4fd313=await this[_0x1cf7e3(0x107)][_0x1cf7e3(0xf0)]({..._0x4a4e26})[_0x1cf7e3(0xd4)](_0x2fd538=>!!_0x2fd538);return await this[_0x1cf7e3(0x138)](),_0x4fd313;}catch(_0x9cca12){console[_0x1cf7e3(0xdf)](_0x1cf7e3(0xc2),_0x9cca12);}}async[_0x3c15d9(0x119)](_0x26f1e2){const _0x2e6b62=_0x3c15d9;try{const {id:_0x8233f5,timeout:_0x42a6f9,groupName:_0x4a0f6b,status:_0x143ee7,weight:_0x2de2df,key:_0x3e41ee,deductType:_0x55e891,deduct:_0x5f0ec7,maxRounds:_0x1d5218,maxResponseTokens:_0x55ad3c,maxModelTokens:_0x2712a9,useToken:_0x3d3638,useCount:_0x3498e2,remark:_0x813d89,proxyUrl:_0x283de0,groupLogo:_0x4f6a7c}=_0x26f1e2,_0x11ff2f=await this[_0x2e6b62(0x107)]['findOne']({'where':{'id':_0x8233f5}});if(!_0x11ff2f)throw new common_1[(_0x2e6b62(0xba))](_0x2e6b62(0xc6),common_1['HttpStatus'][_0x2e6b62(0xac)]);const _0x48ffc2=await this['gptsGroupEntity']['update'](_0x8233f5,{'groupName':_0x4a0f6b,'timeout':_0x42a6f9,'status':_0x143ee7,'weight':_0x2de2df,'key':_0x3e41ee,'deductType':_0x55e891,'deduct':_0x5f0ec7,'maxRounds':_0x1d5218,'maxResponseTokens':_0x55ad3c,'maxModelTokens':_0x2712a9,'useToken':_0x3d3638,'useCount':_0x3498e2,'remark':_0x813d89,'proxyUrl':_0x283de0,'groupLogo':_0x4f6a7c})[_0x2e6b62(0xd4)](_0x49607d=>_0x49607d['affected']>0x0);return await this[_0x2e6b62(0x138)](),_0x48ffc2;}catch(_0xdbc31d){throw new common_1['HttpException'](_0xdbc31d,common_1[_0x2e6b62(0xb5)][_0x2e6b62(0xac)]);}}async[_0x3c15d9(0xb1)](_0x58ed7d){const _0x724792=_0x3c15d9,{id:_0xe57e6}=_0x58ed7d,_0x3ad975=await this[_0x724792(0x107)]['findOne']({'where':{'id':_0xe57e6}});if(!_0x3ad975)throw new common_1[(_0x724792(0xba))](_0x724792(0x109),common_1[_0x724792(0xb5)][_0x724792(0xac)]);const _0x38807c=await this[_0x724792(0x13a)][_0x724792(0x123)]({'where':{'groupId':_0x3ad975['id']}});if(_0x38807c>0x0)throw new common_1[(_0x724792(0xba))](_0x724792(0xdd),common_1[_0x724792(0xb5)]['BAD_REQUEST']);else{const _0x4d5950=await this[_0x724792(0x107)][_0x724792(0x130)]({'id':_0xe57e6})[_0x724792(0xd4)](_0xafbc5=>_0xafbc5[_0x724792(0xcd)]>0x0);return await this[_0x724792(0x138)](),_0x4d5950;}}async[_0x3c15d9(0xf3)](_0x23c298,_0x799ccc){const _0x15fccc=_0x3c15d9;try{const {groupName:_0x4cd57c,page:page=0x1,status:_0x31b4cc,size:size=0x14}=_0x23c298,_0x47bbd2={};_0x4cd57c&&(_0x47bbd2['groupName']=_0x4cd57c),_0x31b4cc>=0x0&&(_0x47bbd2[_0x15fccc(0x10e)]=_0x31b4cc);const _0x1c3fd1=_0x799ccc['user'][_0x15fccc(0x115)],_0x52328e=_0x1c3fd1===_0x15fccc(0xd0);return await this['gptsGroupEntity'][_0x15fccc(0x14e)]({'skip':(page-0x1)*size,'take':size,'where':_0x47bbd2,'order':{'weight':_0x15fccc(0xb3),'id':_0x15fccc(0xb3)}})[_0x15fccc(0xd4)](([_0x4f93dd,_0x5f2046])=>({'rows':_0x4f93dd[_0x15fccc(0x112)](_0x3b1e6e=>{const _0x36f629=_0x15fccc;return{..._0x3b1e6e,'key':_0x52328e?_0x3b1e6e[_0x36f629(0x14a)]:(0x0,utils_1[_0x36f629(0xc9)])(_0x3b1e6e['key'])};}),'count':_0x5f2046}))['catch'](_0x496947=>{throw new Error(_0x496947);});}catch(_0x17c03a){console[_0x15fccc(0xdf)](_0x15fccc(0xc2),_0x17c03a);throw new common_1[(_0x15fccc(0xba))](_0x17c03a,common_1[_0x15fccc(0xb5)]['BAD_REQUEST']);}}async[_0x3c15d9(0x14b)](_0x32f2d8,_0x2db532){const _0x1d5661=_0x3c15d9;try{const _0x2b82f5=_0x2db532[_0x1d5661(0xdc)][_0x1d5661(0x115)],_0x3f3475=_0x2b82f5==='super',{groupId:_0x25d347}=_0x32f2d8;return await this[_0x1d5661(0x107)][_0x1d5661(0xbe)]({'where':{'id':Number(_0x25d347)}})[_0x1d5661(0xd4)](_0x12717e=>{const _0x4b0be1=_0x1d5661;return{..._0x12717e,'key':_0x3f3475?_0x12717e['key']:(0x0,utils_1[_0x4b0be1(0xc9)])(_0x12717e[_0x4b0be1(0x14a)])};})[_0x1d5661(0x105)](_0x7f44c1=>{throw new Error(_0x7f44c1);});}catch(_0x49767b){console[_0x1d5661(0xdf)](_0x1d5661(0xc2),_0x49767b);throw new common_1[(_0x1d5661(0xba))](_0x49767b,common_1['HttpStatus'][_0x1d5661(0xac)]);}}async[_0x3c15d9(0xe1)](_0x858ec5,_0x329c34){const _0x430756=_0x3c15d9;try{const _0x269b22=_0x858ec5[_0x430756(0xdc)]['id'],_0x5e24c6=Object[_0x430756(0x11c)](new gpts_model_entity_1[(_0x430756(0xb2))](),_0x329c34);_0x5e24c6[_0x430756(0x10e)]=Number(_0x329c34[_0x430756(0x10e)]);if(_0x5e24c6['id']){const _0x43c154=await this['gptsModelEntity'][_0x430756(0xbe)]({'where':{'id':_0x5e24c6['id']}});if(!_0x43c154)throw new common_1[(_0x430756(0xba))]('模型不存在！',common_1[_0x430756(0xb5)][_0x430756(0xac)]);if(_0x43c154['gptsApp']!==_0x5e24c6[_0x430756(0xea)])throw new common_1[(_0x430756(0xba))]('应用类型不可更改！',common_1[_0x430756(0xb5)][_0x430756(0xac)]);return await this['gptsModelEntity'][_0x430756(0xc7)]({'id':_0x5e24c6['id']},{..._0x5e24c6,'useCount':_0x5e24c6[_0x430756(0xae)]??_0x43c154[_0x430756(0xae)],'collectCount':_0x5e24c6[_0x430756(0x11d)]??_0x43c154[_0x430756(0x11d)]})[_0x430756(0xd4)](_0x427295=>_0x427295[_0x430756(0xcd)]>0x0)[_0x430756(0x105)](_0xc31bad=>{throw new Error(_0xc31bad);});}else{const _0x1e63c8=await this[_0x430756(0x107)][_0x430756(0xbe)]({'where':{'id':_0x5e24c6[_0x430756(0x150)]}});if(!_0x1e63c8)throw new common_1[(_0x430756(0xba))](_0x430756(0xe6),common_1['HttpStatus']['BAD_REQUEST']);return await this[_0x430756(0x13a)][_0x430756(0xf0)]({..._0x5e24c6,'userId':_0x269b22})[_0x430756(0xd4)](_0x1f9bb5=>!!_0x1f9bb5)['catch'](_0x343a09=>{throw new Error(_0x343a09);});}}catch(_0x1df927){throw new common_1[(_0x430756(0xba))](_0x1df927,common_1[_0x430756(0xb5)][_0x430756(0xac)]);}}async[_0x3c15d9(0x148)](){const _0x2ae452=_0x3c15d9;return await this[_0x2ae452(0x13a)]['find']()[_0x2ae452(0xd4)](_0x531a8a=>_0x531a8a[_0x2ae452(0x112)](_0x5c1e90=>_0x5c1e90[_0x2ae452(0xaa)]));}async[_0x3c15d9(0xcc)](_0x2521a2){const _0x336541=_0x3c15d9;try{const _0x1ab314=await this[_0x336541(0x148)](),_0x143ec2=_0x2521a2[_0x336541(0x102)](_0x234d6a=>!_0x1ab314[_0x336541(0x10c)](_0x234d6a[_0x336541(0xaa)]))['map'](_0x3fe63b=>({'groupId':_0x3fe63b[_0x336541(0x150)],'relModel':_0x3fe63b[_0x336541(0x12d)],'logo':_0x3fe63b[_0x336541(0xdb)],'desc':_0x3fe63b[_0x336541(0x12c)],'modelName':_0x3fe63b[_0x336541(0xaa)],'modelId':_0x3fe63b[_0x336541(0x152)]}));return await this[_0x336541(0x13a)][_0x336541(0xf0)](_0x143ec2)[_0x336541(0x105)](_0x6775ad=>{throw new Error(_0x6775ad);});}catch(_0x109b24){console[_0x336541(0xdf)](_0x336541(0xc2),_0x109b24);throw new common_1[(_0x336541(0xba))](_0x109b24,common_1['HttpStatus'][_0x336541(0xac)]);}}async['handleQueryGpts'](_0x1ac156,_0x1d92e4){const _0x409706=_0x3c15d9;try{let _0x4f9f03;const _0x4dfcfa=new Set(),_0x187e35=new Map();if(_0x1d92e4[_0x409706(0xfe)][_0x409706(0xec)]){const _0x348148=_0x1d92e4[_0x409706(0xfe)]['authorization']['split']('\x20'),_0xd96273=jwt['verify'](_0x348148[0x1],process[_0x409706(0x149)]['JWT_SECRET']);_0x4f9f03=_0xd96273['id'];}const {modelId:_0x1378bb,modelName:_0x4ca06b,groupId:_0xad6bcb,back:_0x482cc3,status:_0x412bc9,page:_0x1030ba,size:_0x176f0e}=_0x1ac156,_0x10fc4a={'delFlag':![]};_0x4f9f03?_0x10fc4a['userId']=(0x0,typeorm_2['Or'])((0x0,typeorm_2['Equal'])(_0x4f9f03),(0x0,typeorm_2[_0x409706(0x140)])()):_0x10fc4a[_0x409706(0xfd)]=(0x0,typeorm_2[_0x409706(0x140)])();!_0x482cc3?_0x10fc4a['status']=0x1:(_0x412bc9!==undefined&&(_0x10fc4a[_0x409706(0x10e)]=_0x412bc9),delete _0x10fc4a[_0x409706(0xfd)]);_0x1378bb&&(_0x10fc4a[_0x409706(0x152)]=_0x1378bb),_0xad6bcb&&(_0x10fc4a[_0x409706(0x150)]=_0xad6bcb),_0x4ca06b&&(_0x10fc4a['modelName']=(0x0,typeorm_2[_0x409706(0xd1)])('%'+_0x4ca06b+'%'));const [_0x4515ae,_0x5c4945]=await this[_0x409706(0x13a)][_0x409706(0x14e)]({'skip':(_0x1030ba-0x1)*_0x176f0e,'take':_0x176f0e,'where':_0x10fc4a,'order':{'sortId':_0x409706(0xb3)}});if(_0x4515ae['length']){const _0x2b4f12=[],_0x468fe6=[];_0x4515ae['forEach'](_0x198e2b=>{const _0xfd140a=_0x409706;_0x2b4f12['push'](_0x198e2b['id']),_0x468fe6[_0xfd140a(0x12e)](_0x198e2b[_0xfd140a(0x150)]);});const _0x580a39=await this[_0x409706(0x117)][_0x409706(0x132)]({'where':{'appId':(0x0,typeorm_2['In'])(_0x2b4f12)}});_0x580a39[_0x409706(0xcb)](_0x419767=>_0x4dfcfa[_0x409706(0xda)](_0x419767[_0x409706(0xd5)]));const _0x20072f=await this[_0x409706(0x107)]['find']({'where':{'id':(0x0,typeorm_2['In'])(_0x468fe6)}});_0x20072f[_0x409706(0xcb)](_0x4a7b73=>_0x187e35[_0x409706(0x13b)](_0x4a7b73['id'],_0x4a7b73));}return{'count':_0x5c4945,'rows':_0x4515ae['map'](_0x477442=>({..._0x477442,'collected':_0x4dfcfa[_0x409706(0x145)](_0x477442['id']),'groupName':_0x187e35['get'](_0x477442[_0x409706(0x150)])?.[_0x409706(0x11e)]}))};}catch(_0x3477ba){console[_0x409706(0xdf)](_0x409706(0xc2),_0x3477ba);throw new common_1['HttpException'](_0x3477ba,common_1[_0x409706(0xb5)]['BAD_REQUEST']);}}async[_0x3c15d9(0xf8)](_0x4beb58,_0x22b64d){const _0x538e90=_0x3c15d9;let _0x565270;if(_0x4beb58[_0x538e90(0xfe)][_0x538e90(0xec)]){const _0x3eed3f=_0x4beb58['headers'][_0x538e90(0xec)][_0x538e90(0xb8)]('\x20'),_0x44715c=jwt['verify'](_0x3eed3f[0x1],process[_0x538e90(0x149)][_0x538e90(0x10a)]);_0x565270=_0x44715c['id'];}const _0x108204={'take':0x1e};if(_0x22b64d==_0x538e90(0xbb))_0x108204[_0x538e90(0xca)]={'status':0x1,'delFlag':![],'recommend':!![]},_0x108204['order']={'createdAt':_0x538e90(0xb3)};else{if(_0x22b64d===_0x538e90(0x125))_0x108204[_0x538e90(0xca)]={'status':0x1,'delFlag':![]},_0x108204['order']={'useCount':_0x538e90(0xb3)};else{if(_0x22b64d===_0x538e90(0x147))_0x108204[_0x538e90(0xca)]={'status':0x1,'delFlag':![]},_0x108204['order']={'collectCount':'DESC'};else{if(_0x22b64d===_0x538e90(0xff)){if(!_0x565270)throw new common_1[(_0x538e90(0xba))](_0x538e90(0x12b),common_1[_0x538e90(0xb5)][_0x538e90(0x151)]);_0x108204['where']={'status':0x1,'delFlag':![],'userId':_0x565270},_0x108204[_0x538e90(0x134)]={'createdAt':'DESC'};}else _0x108204['where']={'status':0x1,'delFlag':![]},_0x108204[_0x538e90(0x134)]={'createdAt':_0x538e90(0xb3)};}}}const _0x1d478f=await this[_0x538e90(0x13a)][_0x538e90(0x132)](_0x108204),_0x3b2438=new Set(),_0x4fad82=new Map(),_0x2b76be=[],_0x3f2f76=[];_0x1d478f[_0x538e90(0xcb)](_0x7df2f0=>{const _0x4dba4e=_0x538e90;_0x2b76be[_0x4dba4e(0x12e)](_0x7df2f0['id']),_0x3f2f76['push'](_0x7df2f0[_0x4dba4e(0x150)]);});if(_0x2b76be['length']){if(_0x565270){const _0x4147fe=await this[_0x538e90(0x117)][_0x538e90(0x132)]({'where':{'userId':_0x565270,'appId':(0x0,typeorm_2['In'])(_0x2b76be)}});_0x4147fe[_0x538e90(0xcb)](_0xf8d471=>_0x3b2438[_0x538e90(0xda)](_0xf8d471[_0x538e90(0xd5)]));}const _0x3af93d=await this[_0x538e90(0x107)]['find']({'where':{'id':(0x0,typeorm_2['In'])(_0x3f2f76)}});_0x3af93d[_0x538e90(0xcb)](_0xc0db44=>_0x4fad82[_0x538e90(0x13b)](_0xc0db44['id'],_0xc0db44));}return _0x1d478f[_0x538e90(0x112)](_0x4ee18c=>({..._0x4ee18c,'collected':_0x3b2438[_0x538e90(0x145)](_0x4ee18c['id']),'groupName':_0x4fad82[_0x538e90(0x11b)](_0x4ee18c[_0x538e90(0x150)])?.[_0x538e90(0x11e)]}));}async['handleRemoveGpts'](_0x41353f){const _0x2c69ab=_0x3c15d9;try{const {id:_0x3c4632}=_0x41353f,_0x5a7506=await this['gptsModelEntity'][_0x2c69ab(0xbe)]({'where':{'id':_0x3c4632}});if(!_0x5a7506)throw new common_1[(_0x2c69ab(0xba))](_0x2c69ab(0x12a),common_1[_0x2c69ab(0xb5)][_0x2c69ab(0xac)]);return await this[_0x2c69ab(0x13a)][_0x2c69ab(0x130)](_0x3c4632)[_0x2c69ab(0xd4)](_0x53793b=>_0x53793b[_0x2c69ab(0xcd)]>0x0)[_0x2c69ab(0x105)](_0x4bf85d=>{throw new Error(_0x4bf85d);});}catch(_0x42b9a8){console['log'](_0x2c69ab(0xc2),_0x42b9a8);throw new common_1['HttpException'](_0x42b9a8,common_1['HttpStatus'][_0x2c69ab(0xac)]);}}async[_0x3c15d9(0x101)](_0x1c9495,_0x513e02){const _0x56a7eb=_0x3c15d9,_0x9457c7=_0x1c9495[_0x56a7eb(0xd5)],_0x56fae8=_0x513e02[_0x56a7eb(0xdc)]['id'];let _0x387703=null,_0xafd2d6={'title':_0x56a7eb(0xd3),'userId':_0x56fae8};try{_0x387703=await this[_0x56a7eb(0x13a)][_0x56a7eb(0xbe)]({'where':{'id':_0x9457c7}});if(!_0x387703)throw new Error(_0x56a7eb(0x126));if(_0x387703[_0x56a7eb(0x10e)]!==0x1)throw new Error('非法操作、您在使用一个未启用的应用！');const _0x259f23=await this['gptsChatEntity']['count']({'where':{'modelId':_0x9457c7,'userId':_0x56fae8,'isDelete':![]}});if(_0x259f23>0x0)throw new Error(_0x56a7eb(0x144));_0xafd2d6[_0x56a7eb(0x152)]=_0x387703['id'],_0xafd2d6[_0x56a7eb(0xce)]=_0x387703['modelId'],_0xafd2d6['groupId']=_0x387703['groupId'],_0xafd2d6[_0x56a7eb(0x12c)]=_0x387703[_0x56a7eb(0x12c)]||'',_0xafd2d6[_0x56a7eb(0xdb)]=_0x387703[_0x56a7eb(0xdb)]||'',_0xafd2d6[_0x56a7eb(0xf1)]=_0x387703['modelName'],_0xafd2d6[_0x56a7eb(0xb6)]=_0x387703['demoData']||'';let _0x1c4e66=await this[_0x56a7eb(0xab)][_0x56a7eb(0xbc)](model_constant_1['EModelType'][_0x56a7eb(0x128)]);_0x1c4e66[_0x56a7eb(0x139)][_0x56a7eb(0x122)]=_0x387703[_0x56a7eb(0x122)],_0x1c4e66['modelInfo'][_0x56a7eb(0xaa)]=_0x387703[_0x56a7eb(0xaa)],_0x1c4e66[_0x56a7eb(0x139)][_0x56a7eb(0xf2)]=_0x387703[_0x56a7eb(0xf2)];_0x387703[_0x56a7eb(0xea)]?_0x1c4e66[_0x56a7eb(0x139)][_0x56a7eb(0xce)]=_0x387703[_0x56a7eb(0x152)]:_0x1c4e66[_0x56a7eb(0x139)][_0x56a7eb(0xce)]=_0x387703['relModel'];_0xafd2d6[_0x56a7eb(0xde)]=JSON[_0x56a7eb(0x116)](_0x1c4e66);const _0x201887=await this[_0x56a7eb(0x100)]['save'](_0xafd2d6);return _0x387703&&(_0x387703['useCount']=_0x387703['useCount']+Math[_0x56a7eb(0x142)](Math[_0x56a7eb(0xfc)]()*0xa),await this[_0x56a7eb(0x13a)][_0x56a7eb(0xf0)](_0x387703)),_0x201887;}catch(_0x370be1){throw new common_1['HttpException'](_0x370be1[_0x56a7eb(0xf9)],common_1[_0x56a7eb(0xb5)][_0x56a7eb(0xac)]);}}async[_0x3c15d9(0x120)](_0x42d0fd){const _0x586a7c=_0x3c15d9;try{const _0x139770=_0x42d0fd[_0x586a7c(0xdc)]['id'],_0x3bc3fc={'userId':_0x139770,'isDelete':![]},_0x328c5c=await this['gptsChatEntity'][_0x586a7c(0x132)]({'where':_0x3bc3fc,'order':{'isSticky':_0x586a7c(0xb3),'id':_0x586a7c(0xb3)}}),_0x3a3375=new Set(),_0x37a42b=new Map(),_0x64b3b1=new Map(),_0x58f773=[],_0xe591de=[];_0x328c5c[_0x586a7c(0xcb)](_0x4f0ca3=>{const _0x5e8526=_0x586a7c;_0x58f773[_0x5e8526(0x12e)](_0x4f0ca3['modelId']),_0xe591de[_0x5e8526(0x12e)](_0x4f0ca3[_0x5e8526(0x150)]);});if(_0x58f773['length']){const _0x3b2df6=await this[_0x586a7c(0x117)][_0x586a7c(0x132)]({'where':{'userId':_0x139770,'appId':(0x0,typeorm_2['In'])(_0x58f773)}});_0x3b2df6[_0x586a7c(0xcb)](_0x11ae9b=>_0x3a3375[_0x586a7c(0xda)](_0x11ae9b[_0x586a7c(0xd5)]));const _0x3601f9=await this[_0x586a7c(0x13a)][_0x586a7c(0x132)]({'where':{'id':(0x0,typeorm_2['In'])(_0x58f773),'status':0x1,'delFlag':![]}});_0x3601f9[_0x586a7c(0xcb)](_0x41c737=>_0x37a42b[_0x586a7c(0x13b)](_0x41c737['id'],_0x41c737));const _0x4a8059=await this[_0x586a7c(0x107)][_0x586a7c(0x132)]({'where':{'id':(0x0,typeorm_2['In'])(_0xe591de)}});_0x4a8059['forEach'](_0xb60b34=>_0x64b3b1[_0x586a7c(0x13b)](_0xb60b34['id'],_0xb60b34));}return _0x328c5c[_0x586a7c(0x112)](_0x2ab826=>{const _0x5ba305=_0x586a7c,_0x5a7a05=_0x37a42b[_0x5ba305(0x11b)](_0x2ab826['modelId']);if(_0x5a7a05?.['gptsApp']){const _0x317332=JSON[_0x5ba305(0xfb)](_0x2ab826['config']);_0x317332['modelInfo'][_0x5ba305(0xce)]=_0x5a7a05[_0x5ba305(0x152)],_0x2ab826[_0x5ba305(0xde)]=JSON[_0x5ba305(0x116)](_0x317332);}return{..._0x2ab826,'modelName':_0x2ab826[_0x5ba305(0xf1)],'gptsApp':_0x5a7a05?.[_0x5ba305(0xea)],'collected':_0x3a3375[_0x5ba305(0x145)](_0x2ab826[_0x5ba305(0x152)]),'groupName':_0x64b3b1[_0x5ba305(0x11b)](_0x2ab826['groupId'])?.[_0x5ba305(0x11e)]};});}catch(_0x147936){console[_0x586a7c(0xdf)]('error:\x20',_0x147936);throw new common_1[(_0x586a7c(0xba))](_0x147936,common_1[_0x586a7c(0xb5)]['BAD_REQUEST']);}}async[_0x3c15d9(0x136)](_0x25e8df,_0x734208){const _0x3d2eac=_0x3c15d9,{title:_0x51b6e,isSticky:_0x28696b,groupId:_0xa4a267,config:_0x1de942}=_0x25e8df,{id:_0x4e735e}=_0x734208[_0x3d2eac(0xdc)],_0x1400f9=await this[_0x3d2eac(0x100)][_0x3d2eac(0xbe)]({'where':{'id':_0xa4a267,'userId':_0x4e735e}});if(!_0x1400f9)throw new common_1['HttpException'](_0x3d2eac(0x127),common_1[_0x3d2eac(0xb5)][_0x3d2eac(0xac)]);const _0x1e91f0={};_0x1e91f0[_0x3d2eac(0xf1)]=_0x51b6e||_0x1400f9[_0x3d2eac(0xf1)],_0x1e91f0[_0x3d2eac(0xde)]=_0x1de942||_0x1400f9[_0x3d2eac(0xde)],_0x1e91f0[_0x3d2eac(0x11a)]=_0x28696b??_0x1400f9[_0x3d2eac(0x11a)];const _0x420b04=await this[_0x3d2eac(0x100)][_0x3d2eac(0xc7)]({'id':_0xa4a267},_0x1e91f0);if(_0x420b04[_0x3d2eac(0xcd)])return!![];else throw new common_1[(_0x3d2eac(0xba))]('更新对话失败！',common_1[_0x3d2eac(0xb5)][_0x3d2eac(0xac)]);}async['delGptsChat'](_0x5a49a4,_0x425fd4){const _0xa977c4=_0x3c15d9;try{const {groupId:_0x268b61}=_0x5a49a4,{id:_0x22dbf6}=_0x425fd4['user'],_0xad222e=await this[_0xa977c4(0x100)][_0xa977c4(0xbe)]({'where':{'id':_0x268b61,'userId':_0x22dbf6}})[_0xa977c4(0x105)](_0x5505a=>{const _0x655541=_0xa977c4;common_1['Logger'][_0x655541(0x121)](_0x5505a);throw new Error(_0x5505a);});if(!_0xad222e)throw new Error(_0xa977c4(0xb0));await this['chatLogService'][_0xa977c4(0x133)]({'userId':_0x22dbf6,'ids':[_0x268b61]})[_0xa977c4(0x105)](_0x202519=>{throw new Error(_0x202519);});const _0x50f148=await this['gptsChatEntity'][_0xa977c4(0x130)]({'id':_0x268b61})['catch'](_0x3b895a=>{throw new Error(_0x3b895a);});if(!_0x50f148)throw new Error('删除失败！');return!![];}catch(_0x49d276){throw new common_1[(_0xa977c4(0xba))](_0x49d276,common_1[_0xa977c4(0xb5)][_0xa977c4(0xac)]);}}async[_0x3c15d9(0xeb)](_0x4442b0){const _0x2c0841=_0x3c15d9;try{const {id:_0x9dbbc8}=_0x4442b0[_0x2c0841(0xdc)],_0x13fd54=await this['gptsChatEntity'][_0x2c0841(0x132)]({'where':{'userId':_0x9dbbc8}})[_0x2c0841(0x105)](_0x4ec2d1=>{const _0x1cbf91=_0x2c0841;common_1[_0x1cbf91(0xd6)]['error'](_0x4ec2d1);throw new Error(_0x4ec2d1);});if(!_0x13fd54||_0x13fd54['length']===0x0)throw new Error(_0x2c0841(0xc4));const _0x1c5390=_0x13fd54[_0x2c0841(0x112)](_0x29733a=>_0x29733a['groupId']);await this[_0x2c0841(0xc3)][_0x2c0841(0x133)]({'ids':_0x1c5390,'userId':_0x9dbbc8})[_0x2c0841(0x105)](_0x747489=>{throw new Error(_0x747489);});const _0x3c6f3a=await this[_0x2c0841(0x100)][_0x2c0841(0x130)]({'userId':_0x9dbbc8,'isSticky':![]})['catch'](_0x257888=>{throw new Error(_0x257888);});if(!_0x3c6f3a)throw new Error('清空失败！');return!![];}catch(_0x5630fd){throw new common_1[(_0x2c0841(0xba))](_0x5630fd,common_1['HttpStatus']['BAD_REQUEST']);}}async[_0x3c15d9(0x104)](_0x30fe29){const _0x39d5ce=_0x3c15d9;return await this[_0x39d5ce(0x100)]['findOne']({'where':{'id':_0x30fe29}});}async['getCurrentModelKeyInfo'](_0x5861c2){const _0x2f422b=_0x3c15d9,_0x53cb3f=await this[_0x2f422b(0x100)][_0x2f422b(0xbe)]({'where':{'id':_0x5861c2}}),_0x5957f1=await this[_0x2f422b(0x13a)][_0x2f422b(0xbe)]({'where':{'id':_0x53cb3f[_0x2f422b(0x152)]}}),_0x335531=await this[_0x2f422b(0xab)][_0x2f422b(0xbc)](model_constant_1[_0x2f422b(0x10b)]['APP']),{id:_0x58bf7e,modelId:_0x4494a7,modelName:_0x3300a5,relModel:_0x307a96}=_0x5957f1,{key:_0x4305c8,timeout:_0x193e77,deduct:_0x41e57c,deductType:_0x346107,proxyUrl:_0x4f29bb}=_0x335531[_0x2f422b(0x139)],_0x32c043={'id':_0x58bf7e,'key':_0x4305c8,'deduct':_0x41e57c,'timeout':_0x193e77,'deductType':_0x346107,'modelName':_0x3300a5,'modelId':_0x4494a7||_0x307a96,'proxy':_0x4f29bb||'https://api.openai.com'};return this[_0x2f422b(0x135)]['set'](_0x5861c2,_0x32c043),_0x32c043;}async[_0x3c15d9(0x129)](_0x1f731d,_0x45e1dc){const _0x21c660=_0x3c15d9;await this['gptsGroupEntity'][_0x21c660(0xef)]()[_0x21c660(0xc7)](gpts_group_entity_1[_0x21c660(0xad)])['set']({'useCount':()=>_0x21c660(0x11f),'useToken':()=>_0x21c660(0xbd)+_0x45e1dc})[_0x21c660(0xca)](_0x21c660(0x14d),{'id':_0x1f731d})[_0x21c660(0xf4)]();}};GptsService=__decorate([(0x0,common_1[_0x3c15d9(0xcf)])(),__param(0x0,(0x0,typeorm_1[_0x3c15d9(0x141)])(userApps_entity_1[_0x3c15d9(0xc5)])),__param(0x1,(0x0,typeorm_1[_0x3c15d9(0x141)])(gpts_group_entity_1[_0x3c15d9(0xad)])),__param(0x2,(0x0,typeorm_1[_0x3c15d9(0x141)])(gpts_model_entity_1['GptsModelEntity'])),__param(0x3,(0x0,typeorm_1['InjectRepository'])(gpts_chat_entity_1['GptsChatEntity'])),__metadata(_0x3c15d9(0xe2),[typeorm_2[_0x3c15d9(0x14f)],typeorm_2[_0x3c15d9(0x14f)],typeorm_2[_0x3c15d9(0x14f)],typeorm_2[_0x3c15d9(0x14f)],models_service_1[_0x3c15d9(0xb9)],chatLog_service_1['ChatLogService']])],GptsService),exports[_0x3c15d9(0xe5)]=GptsService;