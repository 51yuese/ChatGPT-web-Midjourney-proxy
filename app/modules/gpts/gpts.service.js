'use strict';function _0x5f29(_0x515beb,_0x28bbc2){const _0x4522f1=_0x4522();return _0x5f29=function(_0x5f2988,_0x43e2de){_0x5f2988=_0x5f2988-0x8e;let _0x4a3987=_0x4522f1[_0x5f2988];return _0x4a3987;},_0x5f29(_0x515beb,_0x28bbc2);}const _0xc4469e=_0x5f29;(function(_0x45085b,_0x5c7662){const _0x28bfd2=_0x5f29,_0x7493cf=_0x45085b();while(!![]){try{const _0x3e086e=-parseInt(_0x28bfd2(0xd8))/0x1*(parseInt(_0x28bfd2(0xb5))/0x2)+parseInt(_0x28bfd2(0xbf))/0x3+-parseInt(_0x28bfd2(0xf6))/0x4*(-parseInt(_0x28bfd2(0xf8))/0x5)+-parseInt(_0x28bfd2(0xd2))/0x6+parseInt(_0x28bfd2(0xa9))/0x7*(parseInt(_0x28bfd2(0x10a))/0x8)+-parseInt(_0x28bfd2(0x130))/0x9+-parseInt(_0x28bfd2(0xae))/0xa*(-parseInt(_0x28bfd2(0xfd))/0xb);if(_0x3e086e===_0x5c7662)break;else _0x7493cf['push'](_0x7493cf['shift']());}catch(_0x3cedde){_0x7493cf['push'](_0x7493cf['shift']());}}}(_0x4522,0x50b00));var __decorate=this&&this[_0xc4469e(0xc8)]||function(_0x252eac,_0x2e8b5b,_0x9890c8,_0x177aa2){const _0x1547b7=_0xc4469e;var _0x29370e=arguments[_0x1547b7(0xc0)],_0x73bcf6=_0x29370e<0x3?_0x2e8b5b:_0x177aa2===null?_0x177aa2=Object['getOwnPropertyDescriptor'](_0x2e8b5b,_0x9890c8):_0x177aa2,_0x2662bf;if(typeof Reflect===_0x1547b7(0xcc)&&typeof Reflect[_0x1547b7(0x124)]==='function')_0x73bcf6=Reflect[_0x1547b7(0x124)](_0x252eac,_0x2e8b5b,_0x9890c8,_0x177aa2);else{for(var _0x6afad5=_0x252eac[_0x1547b7(0xc0)]-0x1;_0x6afad5>=0x0;_0x6afad5--)if(_0x2662bf=_0x252eac[_0x6afad5])_0x73bcf6=(_0x29370e<0x3?_0x2662bf(_0x73bcf6):_0x29370e>0x3?_0x2662bf(_0x2e8b5b,_0x9890c8,_0x73bcf6):_0x2662bf(_0x2e8b5b,_0x9890c8))||_0x73bcf6;}return _0x29370e>0x3&&_0x73bcf6&&Object['defineProperty'](_0x2e8b5b,_0x9890c8,_0x73bcf6),_0x73bcf6;},__metadata=this&&this['__metadata']||function(_0x13d38b,_0x52155b){const _0x3f8a88=_0xc4469e;if(typeof Reflect===_0x3f8a88(0xcc)&&typeof Reflect[_0x3f8a88(0xeb)]==='function')return Reflect[_0x3f8a88(0xeb)](_0x13d38b,_0x52155b);},__param=this&&this[_0xc4469e(0xa1)]||function(_0x53b666,_0x43e078){return function(_0xdc0b81,_0x19eeb4){_0x43e078(_0xdc0b81,_0x19eeb4,_0x53b666);};};Object['defineProperty'](exports,_0xc4469e(0x109),{'value':!![]}),exports[_0xc4469e(0xa8)]=void 0x0;const common_1=require(_0xc4469e(0x119)),typeorm_1=require(_0xc4469e(0xb8)),gpts_group_entity_1=require(_0xc4469e(0xf7)),typeorm_2=require(_0xc4469e(0xca)),gpts_model_entity_1=require(_0xc4469e(0xe2)),axios_1=require(_0xc4469e(0x8e)),jwt=require(_0xc4469e(0xf3)),gpts_chat_entity_1=require(_0xc4469e(0xe5)),chatLog_service_1=require(_0xc4469e(0xaa)),utils_1=require(_0xc4469e(0xa0)),models_service_1=require('../models/models.service'),userApps_entity_1=require(_0xc4469e(0x96)),model_constant_1=require(_0xc4469e(0x129));function _0x4522(){const _0x112351=['Logger','handleUpdateGroup','当前用户没有创建GPT对话！','handleGetGroup','demoData','GPTs对话组编号和用户编号不匹配，请登录之后创建新的对话！','cleanAllGptOnlyOne','__decorate','gpts','typeorm','verify','object','stringify','where','tempModalMap','update','execute','3049902VROjNE','UserAppsEntity','handleRemoveGpts','当前应用已经开启了一个对话无需新建了！','user','非法操作、您在删除一个非法资源！','362589lAfNZl','EModelType','appId','map','非法操作、您在使用一个未启用的应用！','handleRemoveGroup','then','handleCreateChat','findOne','hideString','./gpts.model.entity','gptsChatEntity','message','./gpts.chat.entity','非法操作、您在使用一个不存在的应用！','gptsGroupEntity','Repository','delAllGptsChat','set','metadata','ChatLogService','chatLogService','gptsModelEntity','logo','userAppsEntity','https://api.openai.com','allGroupMap','jsonwebtoken','forEach','gptsApp','4YUHasx','./gpts.group.entity','1313855InGyUc','authorization','get','relModel','favorite','3454wUnUKW','handleAddGpts','getAllGptsFormNetworkStore','Like','config','handleQueryGroup','groupName','BAD_REQUEST','reduce','modelName','author_name','gid','__esModule','334112hrtvjP','removeLogsBatch','delGptsChat','initAllModelGroups','getExistGpts','desc','save','affected','createQueryBuilder','default','模型组不存在！','modelsService','UNAUTHORIZED','handleAddGptsBatch','onModuleInit','@nestjs/common','model','isSticky','handleAddGroup','key','HttpStatus','error:\x20','add','useCount','super','InjectRepository','decorate','modelInfo','groupId','headers','userId','../../common/constants/model.constant','handleGetChat','getModelByType','新对话','更新对话失败！','log','模型组存在GPTS应用,不允许删除！','686502GLoGDA','env','push','axios','Equal','catch','split','IsNull','GptsModelEntity','getGroupInfoFromId','id\x20=\x20:id','../app/userApps.entity','JWT_SECRET','HttpException','删除失败！','parse','filter','has','find','canUpload','APP','../../common/utils','__param','assign','ModelsService','status','count','模型组已存在！','findAndCount','GptsService','28lYErmy','../chatLog/chatLog.service','GptsGroupEntity','GptsChatEntity','ceil','13570ganbLj','error','清空失败！','getCurrentModelKeyInfo','DESC','order','delete','2mfxlPE','title','updateGptsChat','@nestjs/typeorm','collectCount','canAudio','modelId','Injectable','模型组不存在,无法删除！','handleQueryGpts','1265265raUfDL','length'];_0x4522=function(){return _0x112351;};return _0x4522();}let GptsService=class GptsService{constructor(_0x3b88ec,_0x46ebb9,_0x1fad7a,_0x4a4e6d,_0x4cba88,_0x4dad40){const _0x22d308=_0xc4469e;this[_0x22d308(0xf0)]=_0x3b88ec,this['gptsGroupEntity']=_0x46ebb9,this[_0x22d308(0xee)]=_0x1fad7a,this[_0x22d308(0xe3)]=_0x4a4e6d,this[_0x22d308(0x115)]=_0x4cba88,this['chatLogService']=_0x4dad40,this[_0x22d308(0xf2)]={},this[_0x22d308(0xcf)]=new Map();}async[_0xc4469e(0x118)](){const _0x5d7159=_0xc4469e;await this[_0x5d7159(0x10d)]();}async[_0xc4469e(0x10d)](){const _0x458718=_0xc4469e;this[_0x458718(0xf2)]={};const _0x22c00a=await this[_0x458718(0xe7)][_0x458718(0x9d)]();if(_0x22c00a['length']===0x0)return![];return this[_0x458718(0xf2)]=_0x22c00a[_0x458718(0x105)]((_0x23046c,_0x12c66b)=>{const _0x50f4f5=_0x458718;return _0x23046c[_0x12c66b['id']]={'groupName':_0x12c66b[_0x50f4f5(0x103)]},_0x23046c;},{}),!![];}async[_0xc4469e(0xff)](){const _0x199a1d=_0xc4469e,_0x2e0722=await axios_1[_0x199a1d(0x113)][_0x199a1d(0xfa)]('https://gpts.ddaiai.com/open/gpts')[_0x199a1d(0xde)](_0x145889=>_0x145889['data']);if(_0x2e0722&&_0x2e0722[_0x199a1d(0xc9)]){const {gpts:_0xfd4a92}=_0x2e0722;if(_0xfd4a92['length']){const _0x126ea5=_0xfd4a92[_0x199a1d(0xdb)](_0x122a15=>{const _0x203f71=_0x199a1d;return{'groupId':0x1,'useCount':~~_0x122a15['use_cnt'],'modelId':_0x122a15[_0x203f71(0x108)],'logo':_0x122a15['logo'],'desc':_0x122a15['info'],'modelName':_0x122a15['name'],'remark':_0x122a15[_0x203f71(0x107)]};});await this[_0x199a1d(0xee)][_0x199a1d(0x110)](_0x126ea5);}}}async[_0xc4469e(0xc7)](){const _0x36ad61=_0xc4469e,_0x3a5160=await this[_0x36ad61(0xee)]['find']();if(_0x3a5160[_0x36ad61(0xc0)]===0x0)return;let _0x509b98={};const _0xede41c=_0x3a5160[_0x36ad61(0x105)]((_0x53eb05,_0x3e1721)=>{const _0x18ae4b=_0x36ad61;return!_0x509b98[_0x3e1721[_0x18ae4b(0x106)]]&&(_0x509b98[_0x3e1721[_0x18ae4b(0x106)]]=_0x3e1721[_0x18ae4b(0x106)],_0x53eb05[_0x18ae4b(0x132)](_0x3e1721)),_0x53eb05;},[]);_0xede41c[_0x36ad61(0xc0)]>0x0&&(console[_0x36ad61(0x12e)]('cleared\x20model\x20length',_0xede41c[_0x36ad61(0xc0)]),await this[_0x36ad61(0xee)]['save'](_0xede41c));}async[_0xc4469e(0x11c)](_0x4d981e){const _0x3dd036=_0xc4469e;try{const {groupName:_0x579fc3}=_0x4d981e,_0x973b44=await this[_0x3dd036(0xe7)][_0x3dd036(0xe0)]({'where':{'groupName':_0x579fc3}});if(_0x973b44)throw new common_1[(_0x3dd036(0x98))](_0x3dd036(0xa6),common_1['HttpStatus'][_0x3dd036(0x104)]);const _0xcc54b6=await this[_0x3dd036(0xe7)][_0x3dd036(0x110)]({..._0x4d981e})[_0x3dd036(0xde)](_0x27591c=>!!_0x27591c);return await this[_0x3dd036(0x10d)](),_0xcc54b6;}catch(_0x1f9708){console[_0x3dd036(0x12e)](_0x3dd036(0x11f),_0x1f9708);}}async[_0xc4469e(0xc2)](_0x1ac616){const _0xd0180a=_0xc4469e;try{const {id:_0x527f10,timeout:_0x4114e5,groupName:_0x2737db,status:_0x3840d5,weight:_0x150bfc,key:_0x2670d0,deductType:_0x30928d,deduct:_0x46104c,maxRounds:_0x364a64,maxResponseTokens:_0x3f03a2,maxModelTokens:_0x4241c6,useToken:_0xb902c1,useCount:_0x1abf40,remark:_0x5234f9,proxyUrl:_0x3444aa,groupLogo:_0x5c4461}=_0x1ac616,_0x26a335=await this[_0xd0180a(0xe7)]['findOne']({'where':{'id':_0x527f10}});if(!_0x26a335)throw new common_1[(_0xd0180a(0x98))](_0xd0180a(0x114),common_1[_0xd0180a(0x11e)][_0xd0180a(0x104)]);const _0x2414af=await this[_0xd0180a(0xe7)][_0xd0180a(0xd0)](_0x527f10,{'groupName':_0x2737db,'timeout':_0x4114e5,'status':_0x3840d5,'weight':_0x150bfc,'key':_0x2670d0,'deductType':_0x30928d,'deduct':_0x46104c,'maxRounds':_0x364a64,'maxResponseTokens':_0x3f03a2,'maxModelTokens':_0x4241c6,'useToken':_0xb902c1,'useCount':_0x1abf40,'remark':_0x5234f9,'proxyUrl':_0x3444aa,'groupLogo':_0x5c4461})['then'](_0x519b95=>_0x519b95[_0xd0180a(0x111)]>0x0);return await this['initAllModelGroups'](),_0x2414af;}catch(_0x37a6ec){throw new common_1[(_0xd0180a(0x98))](_0x37a6ec,common_1['HttpStatus'][_0xd0180a(0x104)]);}}async[_0xc4469e(0xdd)](_0x250cc4){const _0x3f263e=_0xc4469e,{id:_0x1cbaf}=_0x250cc4,_0x45d1f2=await this['gptsGroupEntity'][_0x3f263e(0xe0)]({'where':{'id':_0x1cbaf}});if(!_0x45d1f2)throw new common_1[(_0x3f263e(0x98))](_0x3f263e(0xbd),common_1[_0x3f263e(0x11e)]['BAD_REQUEST']);const _0x5071c5=await this['gptsModelEntity'][_0x3f263e(0xa5)]({'where':{'groupId':_0x45d1f2['id']}});if(_0x5071c5>0x0)throw new common_1[(_0x3f263e(0x98))](_0x3f263e(0x12f),common_1[_0x3f263e(0x11e)]['BAD_REQUEST']);else{const _0x42993f=await this[_0x3f263e(0xe7)][_0x3f263e(0xb4)]({'id':_0x1cbaf})[_0x3f263e(0xde)](_0x118311=>_0x118311[_0x3f263e(0x111)]>0x0);return await this['initAllModelGroups'](),_0x42993f;}}async[_0xc4469e(0x102)](_0x4feb13,_0x476a5a){const _0x2f3833=_0xc4469e;try{const {groupName:_0x265533,page:page=0x1,status:_0x417bb3,size:size=0x14}=_0x4feb13,_0x1a32c6={};_0x265533&&(_0x1a32c6[_0x2f3833(0x103)]=_0x265533),_0x417bb3>=0x0&&(_0x1a32c6['status']=_0x417bb3);const _0x5f4162=_0x476a5a[_0x2f3833(0xd6)]['role'],_0x58d768=_0x5f4162===_0x2f3833(0x122);return await this[_0x2f3833(0xe7)][_0x2f3833(0xa7)]({'skip':(page-0x1)*size,'take':size,'where':_0x1a32c6,'order':{'weight':_0x2f3833(0xb2),'id':_0x2f3833(0xb2)}})[_0x2f3833(0xde)](([_0x285a37,_0x22fa99])=>({'rows':_0x285a37[_0x2f3833(0xdb)](_0x587449=>{const _0x457976=_0x2f3833;return{..._0x587449,'key':_0x58d768?_0x587449[_0x457976(0x11d)]:(0x0,utils_1[_0x457976(0xe1)])(_0x587449['key'])};}),'count':_0x22fa99}))['catch'](_0x1806ad=>{throw new Error(_0x1806ad);});}catch(_0x47db5b){console[_0x2f3833(0x12e)](_0x2f3833(0x11f),_0x47db5b);throw new common_1[(_0x2f3833(0x98))](_0x47db5b,common_1[_0x2f3833(0x11e)][_0x2f3833(0x104)]);}}async[_0xc4469e(0xc4)](_0x167dec,_0x1376c3){const _0x33cb34=_0xc4469e;try{const _0xebbe0e=_0x1376c3[_0x33cb34(0xd6)]['role'],_0x4f7bc=_0xebbe0e===_0x33cb34(0x122),{groupId:_0x303098}=_0x167dec;return await this[_0x33cb34(0xe7)][_0x33cb34(0xe0)]({'where':{'id':Number(_0x303098)}})[_0x33cb34(0xde)](_0x10daea=>{const _0xd30a8d=_0x33cb34;return{..._0x10daea,'key':_0x4f7bc?_0x10daea[_0xd30a8d(0x11d)]:(0x0,utils_1[_0xd30a8d(0xe1)])(_0x10daea[_0xd30a8d(0x11d)])};})['catch'](_0x1ab9c6=>{throw new Error(_0x1ab9c6);});}catch(_0x45f41f){console[_0x33cb34(0x12e)](_0x33cb34(0x11f),_0x45f41f);throw new common_1[(_0x33cb34(0x98))](_0x45f41f,common_1['HttpStatus'][_0x33cb34(0x104)]);}}async[_0xc4469e(0xfe)](_0x57ed9b,_0x54db58){const _0x1fa47c=_0xc4469e;try{const _0x48ee62=_0x57ed9b[_0x1fa47c(0xd6)]['id'],_0x45bfe1=Object[_0x1fa47c(0xa2)](new gpts_model_entity_1['GptsModelEntity'](),_0x54db58);_0x45bfe1[_0x1fa47c(0xa4)]=Number(_0x54db58[_0x1fa47c(0xa4)]);if(_0x45bfe1['id']){const _0x85fed7=await this[_0x1fa47c(0xee)][_0x1fa47c(0xe0)]({'where':{'id':_0x45bfe1['id']}});if(!_0x85fed7)throw new common_1[(_0x1fa47c(0x98))]('模型不存在！',common_1[_0x1fa47c(0x11e)][_0x1fa47c(0x104)]);if(_0x85fed7[_0x1fa47c(0xf5)]!==_0x45bfe1[_0x1fa47c(0xf5)])throw new common_1[(_0x1fa47c(0x98))]('应用类型不可更改！',common_1['HttpStatus'][_0x1fa47c(0x104)]);return await this[_0x1fa47c(0xee)][_0x1fa47c(0xd0)]({'id':_0x45bfe1['id']},{..._0x45bfe1,'useCount':_0x45bfe1[_0x1fa47c(0x121)]??_0x85fed7[_0x1fa47c(0x121)],'collectCount':_0x45bfe1[_0x1fa47c(0xb9)]??_0x85fed7[_0x1fa47c(0xb9)]})[_0x1fa47c(0xde)](_0x28bce4=>_0x28bce4[_0x1fa47c(0x111)]>0x0)['catch'](_0x348917=>{throw new Error(_0x348917);});}else{const _0x1155c2=await this[_0x1fa47c(0xe7)][_0x1fa47c(0xe0)]({'where':{'id':_0x45bfe1[_0x1fa47c(0x126)]}});if(!_0x1155c2)throw new common_1['HttpException']('应用分类不存在！',common_1[_0x1fa47c(0x11e)][_0x1fa47c(0x104)]);return await this[_0x1fa47c(0xee)][_0x1fa47c(0x110)]({..._0x45bfe1,'userId':_0x48ee62})[_0x1fa47c(0xde)](_0x5c70cd=>!!_0x5c70cd)[_0x1fa47c(0x90)](_0x2bd251=>{throw new Error(_0x2bd251);});}}catch(_0x567edf){throw new common_1['HttpException'](_0x567edf,common_1['HttpStatus'][_0x1fa47c(0x104)]);}}async[_0xc4469e(0x10e)](){const _0x60fe17=_0xc4469e;return await this['gptsModelEntity'][_0x60fe17(0x9d)]()['then'](_0x527be6=>_0x527be6[_0x60fe17(0xdb)](_0x1619bc=>_0x1619bc[_0x60fe17(0x106)]));}async[_0xc4469e(0x117)](_0x16571b){const _0x581e3c=_0xc4469e;try{const _0x5c38e6=await this[_0x581e3c(0x10e)](),_0x500dbf=_0x16571b[_0x581e3c(0x9b)](_0x1b89e3=>!_0x5c38e6['includes'](_0x1b89e3[_0x581e3c(0x106)]))['map'](_0x1a110d=>({'groupId':_0x1a110d[_0x581e3c(0x126)],'relModel':_0x1a110d[_0x581e3c(0xfb)],'logo':_0x1a110d[_0x581e3c(0xef)],'desc':_0x1a110d['desc'],'modelName':_0x1a110d[_0x581e3c(0x106)],'modelId':_0x1a110d[_0x581e3c(0xbb)]}));return await this[_0x581e3c(0xee)]['save'](_0x500dbf)[_0x581e3c(0x90)](_0x20b775=>{throw new Error(_0x20b775);});}catch(_0x3719d4){console['log'](_0x581e3c(0x11f),_0x3719d4);throw new common_1['HttpException'](_0x3719d4,common_1['HttpStatus']['BAD_REQUEST']);}}async[_0xc4469e(0xbe)](_0x47eac7,_0x6b3b5d){const _0x56488b=_0xc4469e;try{let _0x324310;const _0xf574cc=new Set(),_0x2b0428=new Map();if(_0x6b3b5d[_0x56488b(0x127)][_0x56488b(0xf9)]){const _0x2039a2=_0x6b3b5d[_0x56488b(0x127)]['authorization'][_0x56488b(0x91)]('\x20'),_0xe73b9=jwt[_0x56488b(0xcb)](_0x2039a2[0x1],process[_0x56488b(0x131)][_0x56488b(0x97)]);_0x324310=_0xe73b9['id'];}const {modelId:_0x482d7d,modelName:_0x4b0751,groupId:_0x23408d,back:_0x426223,status:_0x586784,page:_0x2b82ab,size:_0x449e9c}=_0x47eac7,_0x1f9c6a={'delFlag':![]};_0x324310?_0x1f9c6a['userId']=(0x0,typeorm_2['Or'])((0x0,typeorm_2[_0x56488b(0x8f)])(_0x324310),(0x0,typeorm_2[_0x56488b(0x92)])()):_0x1f9c6a[_0x56488b(0x128)]=(0x0,typeorm_2['IsNull'])();!_0x426223?_0x1f9c6a[_0x56488b(0xa4)]=0x1:(_0x586784!==undefined&&(_0x1f9c6a[_0x56488b(0xa4)]=_0x586784),delete _0x1f9c6a['userId']);_0x482d7d&&(_0x1f9c6a[_0x56488b(0xbb)]=_0x482d7d),_0x23408d&&(_0x1f9c6a[_0x56488b(0x126)]=_0x23408d),_0x4b0751&&(_0x1f9c6a['modelName']=(0x0,typeorm_2[_0x56488b(0x100)])('%'+_0x4b0751+'%'));const [_0x10dfb2,_0x13228b]=await this['gptsModelEntity'][_0x56488b(0xa7)]({'skip':(_0x2b82ab-0x1)*_0x449e9c,'take':_0x449e9c,'where':_0x1f9c6a,'order':{'sortId':_0x56488b(0xb2)}});if(_0x10dfb2[_0x56488b(0xc0)]){const _0x25a6c2=[],_0x1e65c1=[];_0x10dfb2[_0x56488b(0xf4)](_0x43f75d=>{const _0x2703b4=_0x56488b;_0x25a6c2[_0x2703b4(0x132)](_0x43f75d['id']),_0x1e65c1[_0x2703b4(0x132)](_0x43f75d['groupId']);});const _0x45defd=await this[_0x56488b(0xf0)]['find']({'where':{'appId':(0x0,typeorm_2['In'])(_0x25a6c2)}});_0x45defd[_0x56488b(0xf4)](_0x509fb8=>_0xf574cc[_0x56488b(0x120)](_0x509fb8[_0x56488b(0xda)]));const _0x5bd006=await this[_0x56488b(0xe7)]['find']({'where':{'id':(0x0,typeorm_2['In'])(_0x1e65c1)}});_0x5bd006['forEach'](_0x556542=>_0x2b0428[_0x56488b(0xea)](_0x556542['id'],_0x556542));}return{'count':_0x13228b,'rows':_0x10dfb2[_0x56488b(0xdb)](_0x32afd0=>({..._0x32afd0,'collected':_0xf574cc['has'](_0x32afd0['id']),'groupName':_0x2b0428[_0x56488b(0xfa)](_0x32afd0[_0x56488b(0x126)])?.[_0x56488b(0x103)]}))};}catch(_0x19fa31){console[_0x56488b(0x12e)](_0x56488b(0x11f),_0x19fa31);throw new common_1[(_0x56488b(0x98))](_0x19fa31,common_1[_0x56488b(0x11e)][_0x56488b(0x104)]);}}async['listByFrontType'](_0x304c56,_0x428d6d){const _0x5265fc=_0xc4469e;let _0x21a46f;if(_0x304c56[_0x5265fc(0x127)][_0x5265fc(0xf9)]){const _0x3cd01a=_0x304c56[_0x5265fc(0x127)][_0x5265fc(0xf9)][_0x5265fc(0x91)]('\x20'),_0x3f0a63=jwt[_0x5265fc(0xcb)](_0x3cd01a[0x1],process[_0x5265fc(0x131)][_0x5265fc(0x97)]);_0x21a46f=_0x3f0a63['id'];}const _0x4ca08e={'take':0x1e};if(_0x428d6d=='recommend')_0x4ca08e['where']={'status':0x1,'delFlag':![],'recommend':!![]},_0x4ca08e[_0x5265fc(0xb3)]={'createdAt':_0x5265fc(0xb2)};else{if(_0x428d6d==='popular')_0x4ca08e['where']={'status':0x1,'delFlag':![]},_0x4ca08e[_0x5265fc(0xb3)]={'useCount':_0x5265fc(0xb2)};else{if(_0x428d6d===_0x5265fc(0xfc))_0x4ca08e[_0x5265fc(0xce)]={'status':0x1,'delFlag':![]},_0x4ca08e[_0x5265fc(0xb3)]={'collectCount':'DESC'};else{if(_0x428d6d==='mine'){if(!_0x21a46f)throw new common_1[(_0x5265fc(0x98))]('请先登录！',common_1[_0x5265fc(0x11e)][_0x5265fc(0x116)]);_0x4ca08e[_0x5265fc(0xce)]={'status':0x1,'delFlag':![],'userId':_0x21a46f},_0x4ca08e[_0x5265fc(0xb3)]={'createdAt':_0x5265fc(0xb2)};}else _0x4ca08e[_0x5265fc(0xce)]={'status':0x1,'delFlag':![]},_0x4ca08e[_0x5265fc(0xb3)]={'createdAt':_0x5265fc(0xb2)};}}}const _0x23fca4=await this[_0x5265fc(0xee)][_0x5265fc(0x9d)](_0x4ca08e),_0x1e0d4c=new Set(),_0x37f861=new Map(),_0x1fe670=[],_0x25d916=[];_0x23fca4[_0x5265fc(0xf4)](_0x557ab7=>{const _0x14ca61=_0x5265fc;_0x1fe670[_0x14ca61(0x132)](_0x557ab7['id']),_0x25d916[_0x14ca61(0x132)](_0x557ab7[_0x14ca61(0x126)]);});if(_0x1fe670[_0x5265fc(0xc0)]){if(_0x21a46f){const _0x59b7f7=await this[_0x5265fc(0xf0)][_0x5265fc(0x9d)]({'where':{'userId':_0x21a46f,'appId':(0x0,typeorm_2['In'])(_0x1fe670)}});_0x59b7f7['forEach'](_0x35870e=>_0x1e0d4c['add'](_0x35870e[_0x5265fc(0xda)]));}const _0x1658ac=await this[_0x5265fc(0xe7)][_0x5265fc(0x9d)]({'where':{'id':(0x0,typeorm_2['In'])(_0x25d916)}});_0x1658ac[_0x5265fc(0xf4)](_0x1c7f19=>_0x37f861['set'](_0x1c7f19['id'],_0x1c7f19));}return _0x23fca4['map'](_0x2a5160=>({..._0x2a5160,'collected':_0x1e0d4c[_0x5265fc(0x9c)](_0x2a5160['id']),'groupName':_0x37f861[_0x5265fc(0xfa)](_0x2a5160[_0x5265fc(0x126)])?.['groupName']}));}async[_0xc4469e(0xd4)](_0x389274){const _0x3ebebb=_0xc4469e;try{const {id:_0x320280}=_0x389274,_0xc79447=await this[_0x3ebebb(0xee)]['findOne']({'where':{'id':_0x320280}});if(!_0xc79447)throw new common_1['HttpException']('gpts不存在,无法删除！',common_1[_0x3ebebb(0x11e)][_0x3ebebb(0x104)]);return await this[_0x3ebebb(0xee)][_0x3ebebb(0xb4)](_0x320280)[_0x3ebebb(0xde)](_0xfdd1a6=>_0xfdd1a6['affected']>0x0)[_0x3ebebb(0x90)](_0xe55a46=>{throw new Error(_0xe55a46);});}catch(_0x3e4f24){console['log'](_0x3ebebb(0x11f),_0x3e4f24);throw new common_1[(_0x3ebebb(0x98))](_0x3e4f24,common_1[_0x3ebebb(0x11e)][_0x3ebebb(0x104)]);}}async[_0xc4469e(0xdf)](_0xb1fb4b,_0x29bb9d){const _0x53ffbd=_0xc4469e,_0x523d1f=_0xb1fb4b[_0x53ffbd(0xda)],_0x187bb9=_0x29bb9d[_0x53ffbd(0xd6)]['id'];let _0x579eb3=null,_0x1e8aa3={'title':_0x53ffbd(0x12c),'userId':_0x187bb9};try{_0x579eb3=await this[_0x53ffbd(0xee)][_0x53ffbd(0xe0)]({'where':{'id':_0x523d1f}});if(!_0x579eb3)throw new Error(_0x53ffbd(0xe6));if(_0x579eb3['status']!==0x1)throw new Error(_0x53ffbd(0xdc));const _0x287de0=await this[_0x53ffbd(0xe3)]['count']({'where':{'modelId':_0x523d1f,'userId':_0x187bb9,'isDelete':![]}});if(_0x287de0>0x0)throw new Error(_0x53ffbd(0xd5));_0x1e8aa3[_0x53ffbd(0xbb)]=_0x579eb3['id'],_0x1e8aa3[_0x53ffbd(0x11a)]=_0x579eb3['modelId'],_0x1e8aa3[_0x53ffbd(0x126)]=_0x579eb3[_0x53ffbd(0x126)],_0x1e8aa3[_0x53ffbd(0x10f)]=_0x579eb3['desc']||'',_0x1e8aa3['logo']=_0x579eb3[_0x53ffbd(0xef)]||'',_0x1e8aa3[_0x53ffbd(0xb6)]=_0x579eb3[_0x53ffbd(0x106)],_0x1e8aa3[_0x53ffbd(0xc5)]=_0x579eb3['demoData']||'';let _0xb41b4e=await this['modelsService'][_0x53ffbd(0x12b)](model_constant_1[_0x53ffbd(0xd9)][_0x53ffbd(0x9f)]);_0xb41b4e[_0x53ffbd(0x125)][_0x53ffbd(0xba)]=_0x579eb3['canAudio'],_0xb41b4e['modelInfo'][_0x53ffbd(0x106)]=_0x579eb3[_0x53ffbd(0x106)],_0xb41b4e['modelInfo'][_0x53ffbd(0x9e)]=_0x579eb3[_0x53ffbd(0x9e)];_0x579eb3['gptsApp']?_0xb41b4e[_0x53ffbd(0x125)][_0x53ffbd(0x11a)]=_0x579eb3[_0x53ffbd(0xbb)]:_0xb41b4e[_0x53ffbd(0x125)][_0x53ffbd(0x11a)]=_0x579eb3['relModel'];_0x1e8aa3[_0x53ffbd(0x101)]=JSON[_0x53ffbd(0xcd)](_0xb41b4e);const _0x9cbd5a=await this[_0x53ffbd(0xe3)][_0x53ffbd(0x110)](_0x1e8aa3);return _0x579eb3&&(_0x579eb3[_0x53ffbd(0x121)]=_0x579eb3[_0x53ffbd(0x121)]+Math[_0x53ffbd(0xad)](Math['random']()*0xa),await this[_0x53ffbd(0xee)][_0x53ffbd(0x110)](_0x579eb3)),_0x9cbd5a;}catch(_0x348f57){throw new common_1[(_0x53ffbd(0x98))](_0x348f57[_0x53ffbd(0xe4)],common_1[_0x53ffbd(0x11e)][_0x53ffbd(0x104)]);}}async[_0xc4469e(0x12a)](_0x148707){const _0x1440b0=_0xc4469e;try{const _0x2a7024=_0x148707['user']['id'],_0x676fd2={'userId':_0x2a7024,'isDelete':![]},_0x589dfd=await this[_0x1440b0(0xe3)][_0x1440b0(0x9d)]({'where':_0x676fd2,'order':{'isSticky':_0x1440b0(0xb2),'id':_0x1440b0(0xb2)}}),_0x574d70=new Set(),_0x2596d5=new Map(),_0x11e55f=new Map(),_0x594bec=[],_0x5734f0=[];_0x589dfd[_0x1440b0(0xf4)](_0x3b14da=>{const _0x101aad=_0x1440b0;_0x594bec['push'](_0x3b14da[_0x101aad(0xbb)]),_0x5734f0[_0x101aad(0x132)](_0x3b14da[_0x101aad(0x126)]);});if(_0x594bec[_0x1440b0(0xc0)]){const _0x3b9c86=await this[_0x1440b0(0xf0)][_0x1440b0(0x9d)]({'where':{'userId':_0x2a7024,'appId':(0x0,typeorm_2['In'])(_0x594bec)}});_0x3b9c86['forEach'](_0x36116a=>_0x574d70['add'](_0x36116a[_0x1440b0(0xda)]));const _0x4c0197=await this[_0x1440b0(0xee)][_0x1440b0(0x9d)]({'where':{'id':(0x0,typeorm_2['In'])(_0x594bec),'status':0x1,'delFlag':![]}});_0x4c0197[_0x1440b0(0xf4)](_0x55631f=>_0x2596d5[_0x1440b0(0xea)](_0x55631f['id'],_0x55631f));const _0x1fd00d=await this['gptsGroupEntity']['find']({'where':{'id':(0x0,typeorm_2['In'])(_0x5734f0)}});_0x1fd00d['forEach'](_0x3e7792=>_0x11e55f[_0x1440b0(0xea)](_0x3e7792['id'],_0x3e7792));}return _0x589dfd['map'](_0xe90355=>{const _0x53b32a=_0x1440b0,_0x63f7fa=_0x2596d5[_0x53b32a(0xfa)](_0xe90355[_0x53b32a(0xbb)]);if(_0x63f7fa?.['gptsApp']){const _0x314212=JSON[_0x53b32a(0x9a)](_0xe90355['config']);_0x314212[_0x53b32a(0x125)][_0x53b32a(0x11a)]=_0x63f7fa['modelId'],_0xe90355[_0x53b32a(0x101)]=JSON[_0x53b32a(0xcd)](_0x314212);}return{..._0xe90355,'modelName':_0xe90355[_0x53b32a(0xb6)],'gptsApp':_0x63f7fa?.[_0x53b32a(0xf5)],'collected':_0x574d70[_0x53b32a(0x9c)](_0xe90355[_0x53b32a(0xbb)]),'groupName':_0x11e55f[_0x53b32a(0xfa)](_0xe90355['groupId'])?.['groupName']};});}catch(_0x51cb39){console[_0x1440b0(0x12e)]('error:\x20',_0x51cb39);throw new common_1[(_0x1440b0(0x98))](_0x51cb39,common_1[_0x1440b0(0x11e)][_0x1440b0(0x104)]);}}async[_0xc4469e(0xb7)](_0x1f3578,_0x1d274a){const _0x11788a=_0xc4469e,{title:_0x2aa9d5,isSticky:_0x2ee50f,groupId:_0x23e5f6,config:_0x3c5225}=_0x1f3578,{id:_0x468009}=_0x1d274a[_0x11788a(0xd6)],_0x8e1778=await this[_0x11788a(0xe3)][_0x11788a(0xe0)]({'where':{'id':_0x23e5f6,'userId':_0x468009}});if(!_0x8e1778)throw new common_1[(_0x11788a(0x98))](_0x11788a(0xc6),common_1['HttpStatus'][_0x11788a(0x104)]);const _0x2e006f={};_0x2e006f[_0x11788a(0xb6)]=_0x2aa9d5||_0x8e1778['title'],_0x2e006f[_0x11788a(0x101)]=_0x3c5225||_0x8e1778[_0x11788a(0x101)],_0x2e006f[_0x11788a(0x11b)]=_0x2ee50f??_0x8e1778[_0x11788a(0x11b)];const _0x2904bd=await this[_0x11788a(0xe3)]['update']({'id':_0x23e5f6},_0x2e006f);if(_0x2904bd[_0x11788a(0x111)])return!![];else throw new common_1[(_0x11788a(0x98))](_0x11788a(0x12d),common_1[_0x11788a(0x11e)]['BAD_REQUEST']);}async[_0xc4469e(0x10c)](_0x1456fb,_0x1d7a2f){const _0x8e6acf=_0xc4469e;try{const {groupId:_0x24adc6}=_0x1456fb,{id:_0x283325}=_0x1d7a2f['user'],_0x14449f=await this[_0x8e6acf(0xe3)][_0x8e6acf(0xe0)]({'where':{'id':_0x24adc6,'userId':_0x283325}})[_0x8e6acf(0x90)](_0x3e4725=>{const _0x33c2e0=_0x8e6acf;common_1[_0x33c2e0(0xc1)]['error'](_0x3e4725);throw new Error(_0x3e4725);});if(!_0x14449f)throw new Error(_0x8e6acf(0xd7));await this[_0x8e6acf(0xed)][_0x8e6acf(0x10b)]({'userId':_0x283325,'ids':[_0x24adc6]})['catch'](_0x5e24d7=>{throw new Error(_0x5e24d7);});const _0x1f45ef=await this[_0x8e6acf(0xe3)]['delete']({'id':_0x24adc6})[_0x8e6acf(0x90)](_0x21eedf=>{throw new Error(_0x21eedf);});if(!_0x1f45ef)throw new Error(_0x8e6acf(0x99));return!![];}catch(_0x3e3015){throw new common_1['HttpException'](_0x3e3015,common_1[_0x8e6acf(0x11e)][_0x8e6acf(0x104)]);}}async[_0xc4469e(0xe9)](_0x4b29bd){const _0x45e218=_0xc4469e;try{const {id:_0x13a1d8}=_0x4b29bd[_0x45e218(0xd6)],_0x10bf22=await this[_0x45e218(0xe3)][_0x45e218(0x9d)]({'where':{'userId':_0x13a1d8}})[_0x45e218(0x90)](_0x3c8a0d=>{const _0x5403e8=_0x45e218;common_1['Logger'][_0x5403e8(0xaf)](_0x3c8a0d);throw new Error(_0x3c8a0d);});if(!_0x10bf22||_0x10bf22['length']===0x0)throw new Error(_0x45e218(0xc3));const _0x2eb003=_0x10bf22['map'](_0x3210ef=>_0x3210ef[_0x45e218(0x126)]);await this['chatLogService'][_0x45e218(0x10b)]({'ids':_0x2eb003,'userId':_0x13a1d8})[_0x45e218(0x90)](_0x414eb8=>{throw new Error(_0x414eb8);});const _0x1d2069=await this['gptsChatEntity'][_0x45e218(0xb4)]({'userId':_0x13a1d8,'isSticky':![]})[_0x45e218(0x90)](_0x27069b=>{throw new Error(_0x27069b);});if(!_0x1d2069)throw new Error(_0x45e218(0xb0));return!![];}catch(_0x216ffa){throw new common_1['HttpException'](_0x216ffa,common_1[_0x45e218(0x11e)][_0x45e218(0x104)]);}}async[_0xc4469e(0x94)](_0x2c3cf0){const _0x44409c=_0xc4469e;return await this[_0x44409c(0xe3)][_0x44409c(0xe0)]({'where':{'id':_0x2c3cf0}});}async[_0xc4469e(0xb1)](_0x4197dc){const _0x57fdb1=_0xc4469e,_0x3c018a=await this[_0x57fdb1(0xe3)][_0x57fdb1(0xe0)]({'where':{'id':_0x4197dc}}),_0x46474c=await this[_0x57fdb1(0xee)][_0x57fdb1(0xe0)]({'where':{'id':_0x3c018a[_0x57fdb1(0xbb)]}}),_0x223e66=await this[_0x57fdb1(0x115)][_0x57fdb1(0x12b)](model_constant_1[_0x57fdb1(0xd9)][_0x57fdb1(0x9f)]),{id:_0x3660d2,modelId:_0x1d247a,modelName:_0x207e1e,relModel:_0x4e1604}=_0x46474c,{key:_0x112d3f,timeout:_0x32145e,deduct:_0x168505,deductType:_0x4b8780,proxyUrl:_0x1b3c84}=_0x223e66[_0x57fdb1(0x125)],_0x2a948={'id':_0x3660d2,'key':_0x112d3f,'deduct':_0x168505,'timeout':_0x32145e,'deductType':_0x4b8780,'modelName':_0x207e1e,'modelId':_0x1d247a||_0x4e1604,'proxy':_0x1b3c84||_0x57fdb1(0xf1)};return this[_0x57fdb1(0xcf)]['set'](_0x4197dc,_0x2a948),_0x2a948;}async['saveGptsUseLog'](_0x5d36fd,_0x1cdeb4){const _0x3c7f9e=_0xc4469e;await this[_0x3c7f9e(0xe7)][_0x3c7f9e(0x112)]()[_0x3c7f9e(0xd0)](gpts_group_entity_1[_0x3c7f9e(0xab)])['set']({'useCount':()=>'useCount\x20+\x201','useToken':()=>'useToken\x20+\x20'+_0x1cdeb4})[_0x3c7f9e(0xce)](_0x3c7f9e(0x95),{'id':_0x5d36fd})[_0x3c7f9e(0xd1)]();}};GptsService=__decorate([(0x0,common_1[_0xc4469e(0xbc)])(),__param(0x0,(0x0,typeorm_1[_0xc4469e(0x123)])(userApps_entity_1[_0xc4469e(0xd3)])),__param(0x1,(0x0,typeorm_1[_0xc4469e(0x123)])(gpts_group_entity_1[_0xc4469e(0xab)])),__param(0x2,(0x0,typeorm_1['InjectRepository'])(gpts_model_entity_1[_0xc4469e(0x93)])),__param(0x3,(0x0,typeorm_1[_0xc4469e(0x123)])(gpts_chat_entity_1[_0xc4469e(0xac)])),__metadata('design:paramtypes',[typeorm_2['Repository'],typeorm_2[_0xc4469e(0xe8)],typeorm_2[_0xc4469e(0xe8)],typeorm_2[_0xc4469e(0xe8)],models_service_1[_0xc4469e(0xa3)],chatLog_service_1[_0xc4469e(0xec)]])],GptsService),exports[_0xc4469e(0xa8)]=GptsService;