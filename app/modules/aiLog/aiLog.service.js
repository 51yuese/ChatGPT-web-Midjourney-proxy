'use strict';const _0x3f570c=_0x44e7;function _0x518d(){const _0x57d25e=['Injectable','visitNum','__param','decorate','3184224RqXSUr','musicPlay','Connection','agree','5119630kBlObo','4647918vigRqg','defineProperty','relateType','../../common/constants/relate.contant','948045gKtLTb','metadata','@nestjs/typeorm','1599540HXQSGL','222398JixBLL','ELogRelateType','InjectRepository','round','agreeNum','playNum','increaseVisit','user','relateId','./aiAgreeLog.entity','AiLogService','BAD_REQUEST','random','aiLogExtEntity','143630aOgysh','HttpException','object','findOne','function','connection','__metadata','save','Repository','action','message','2655oYbpPy','getOwnPropertyDescriptor','AiAgreeLogEntity','@nestjs/common','getAgreeByRelateId','AiLogExtEntity','4pzjrEz','aiAgreeLogEntity','__decorate','66SnQdwg','length'];_0x518d=function(){return _0x57d25e;};return _0x518d();}function _0x44e7(_0x35c78a,_0x20b90f){const _0x518db5=_0x518d();return _0x44e7=function(_0x44e78b,_0x93ca89){_0x44e78b=_0x44e78b-0x16d;let _0x446678=_0x518db5[_0x44e78b];return _0x446678;},_0x44e7(_0x35c78a,_0x20b90f);}(function(_0x22fce4,_0x315740){const _0x16a3b5=_0x44e7,_0x573edc=_0x22fce4();while(!![]){try{const _0x25f693=-parseInt(_0x16a3b5(0x174))/0x1+-parseInt(_0x16a3b5(0x173))/0x2+-parseInt(_0x16a3b5(0x1a1))/0x3+parseInt(_0x16a3b5(0x193))/0x4*(parseInt(_0x16a3b5(0x1a0))/0x5)+parseInt(_0x16a3b5(0x196))/0x6*(-parseInt(_0x16a3b5(0x170))/0x7)+-parseInt(_0x16a3b5(0x19c))/0x8+-parseInt(_0x16a3b5(0x18d))/0x9*(-parseInt(_0x16a3b5(0x182))/0xa);if(_0x25f693===_0x315740)break;else _0x573edc['push'](_0x573edc['shift']());}catch(_0x1f42e5){_0x573edc['push'](_0x573edc['shift']());}}}(_0x518d,0xc3bbc));var __decorate=this&&this[_0x3f570c(0x195)]||function(_0x504455,_0x2b99c4,_0x5d5344,_0x58fb4e){const _0x4bb7a7=_0x3f570c;var _0x422053=arguments[_0x4bb7a7(0x197)],_0x228a7f=_0x422053<0x3?_0x2b99c4:_0x58fb4e===null?_0x58fb4e=Object[_0x4bb7a7(0x18e)](_0x2b99c4,_0x5d5344):_0x58fb4e,_0x567d47;if(typeof Reflect===_0x4bb7a7(0x184)&&typeof Reflect['decorate']==='function')_0x228a7f=Reflect[_0x4bb7a7(0x19b)](_0x504455,_0x2b99c4,_0x5d5344,_0x58fb4e);else{for(var _0x25a383=_0x504455[_0x4bb7a7(0x197)]-0x1;_0x25a383>=0x0;_0x25a383--)if(_0x567d47=_0x504455[_0x25a383])_0x228a7f=(_0x422053<0x3?_0x567d47(_0x228a7f):_0x422053>0x3?_0x567d47(_0x2b99c4,_0x5d5344,_0x228a7f):_0x567d47(_0x2b99c4,_0x5d5344))||_0x228a7f;}return _0x422053>0x3&&_0x228a7f&&Object['defineProperty'](_0x2b99c4,_0x5d5344,_0x228a7f),_0x228a7f;},__metadata=this&&this[_0x3f570c(0x188)]||function(_0x53b787,_0x1e43fa){const _0x242c09=_0x3f570c;if(typeof Reflect===_0x242c09(0x184)&&typeof Reflect[_0x242c09(0x171)]===_0x242c09(0x186))return Reflect[_0x242c09(0x171)](_0x53b787,_0x1e43fa);},__param=this&&this[_0x3f570c(0x19a)]||function(_0x108fa6,_0x13929b){return function(_0x205d47,_0x8f9968){_0x13929b(_0x205d47,_0x8f9968,_0x108fa6);};};Object[_0x3f570c(0x16d)](exports,'__esModule',{'value':!![]}),exports[_0x3f570c(0x17e)]=void 0x0;const typeorm_1=require('typeorm'),common_1=require(_0x3f570c(0x190)),typeorm_2=require(_0x3f570c(0x172)),relate_contant_1=require(_0x3f570c(0x16f)),aiLogExt_entity_1=require('./aiLogExt.entity'),aiAgreeLog_entity_1=require(_0x3f570c(0x17d));let AiLogService=class AiLogService{constructor(_0x1e497a,_0x2020a4,_0xb06537){const _0x1307e4=_0x3f570c;this['aiLogExtEntity']=_0x1e497a,this['aiAgreeLogEntity']=_0x2020a4,this[_0x1307e4(0x187)]=_0xb06537;}async[_0x3f570c(0x191)](_0x3731cc,_0x33b5c6){const _0x1db136=_0x3f570c,_0x30e8c4=await this[_0x1db136(0x194)]['findOne']({'where':{'relateId':_0x33b5c6,'relateType':_0x3731cc}});return _0x30e8c4;}async[_0x3f570c(0x19f)](_0x38c4d0,_0x3c7c54){const _0x40cf9f=_0x3f570c;try{const _0x2de39f=_0x38c4d0[_0x40cf9f(0x17b)]['id'],_0x1b3a42=await this[_0x40cf9f(0x194)][_0x40cf9f(0x185)]({'where':{'userId':_0x2de39f,'relateId':_0x3c7c54[_0x40cf9f(0x17c)],'relateType':_0x3c7c54[_0x40cf9f(0x16e)]}});return await this[_0x40cf9f(0x187)]['transaction'](async()=>{const _0x13f6bc=_0x40cf9f;if(_0x1b3a42&&_0x1b3a42[_0x13f6bc(0x18b)]===_0x3c7c54[_0x13f6bc(0x18b)])await this['aiAgreeLogEntity']['delete']({'id':_0x1b3a42['id']});else{const _0x2a0753={..._0x3c7c54,'userId':_0x2de39f,'relateId':_0x3c7c54[_0x13f6bc(0x17c)],'relateType':_0x3c7c54[_0x13f6bc(0x16e)],'id':_0x1b3a42?_0x1b3a42['id']:null};await this[_0x13f6bc(0x194)][_0x13f6bc(0x189)](_0x2a0753);}let _0x6ecf45=await this[_0x13f6bc(0x181)][_0x13f6bc(0x185)]({'where':{'relateId':_0x3c7c54[_0x13f6bc(0x17c)]}});!_0x6ecf45&&(_0x6ecf45=new aiLogExt_entity_1[(_0x13f6bc(0x192))](),_0x6ecf45['relateId']=_0x3c7c54[_0x13f6bc(0x17c)],_0x6ecf45[_0x13f6bc(0x16e)]=_0x3c7c54[_0x13f6bc(0x16e)],_0x6ecf45[_0x13f6bc(0x178)]=0x0),_0x1b3a42&&_0x1b3a42['action']===_0x3c7c54[_0x13f6bc(0x18b)]?_0x3c7c54[_0x13f6bc(0x18b)]==='agree'?_0x6ecf45[_0x13f6bc(0x178)]=_0x6ecf45[_0x13f6bc(0x178)]-0x1:_0x6ecf45[_0x13f6bc(0x178)]=_0x6ecf45[_0x13f6bc(0x178)]+0x1:_0x3c7c54[_0x13f6bc(0x18b)]===_0x13f6bc(0x19f)?_0x6ecf45[_0x13f6bc(0x178)]=_0x6ecf45[_0x13f6bc(0x178)]+Math[_0x13f6bc(0x177)](Math['random']()*0x14):_0x6ecf45[_0x13f6bc(0x178)]=_0x6ecf45[_0x13f6bc(0x178)]-0x1,_0x6ecf45['agreeNum']=_0x6ecf45[_0x13f6bc(0x178)]<0x0?0x0:_0x6ecf45['agreeNum'],await this[_0x13f6bc(0x181)][_0x13f6bc(0x189)](_0x6ecf45);}),!![];}catch(_0xebe3eb){throw new common_1[(_0x40cf9f(0x183))](_0xebe3eb[_0x40cf9f(0x18c)],common_1['HttpStatus'][_0x40cf9f(0x17f)]);}}async['getByRelateId'](_0x3e2625,_0x141079){const _0x49a643=_0x3f570c,_0x486bcc=await this['aiLogExtEntity'][_0x49a643(0x185)]({'where':{'relateId':_0x141079,'relateType':_0x3e2625}});return _0x486bcc;}async[_0x3f570c(0x19d)](_0x5582b5){const _0x37c3c6=_0x3f570c;let _0x2e9f01=await this[_0x37c3c6(0x181)][_0x37c3c6(0x185)]({'where':{'relateId':_0x5582b5,'relateType':relate_contant_1[_0x37c3c6(0x175)]['suno']}});!_0x2e9f01&&(_0x2e9f01=new aiLogExt_entity_1[(_0x37c3c6(0x192))](),_0x2e9f01[_0x37c3c6(0x17c)]=_0x5582b5,_0x2e9f01['relateType']=relate_contant_1[_0x37c3c6(0x175)]['suno']),_0x2e9f01[_0x37c3c6(0x179)]=_0x2e9f01['playNum']+Math[_0x37c3c6(0x177)](Math['random']()*0x14),await this[_0x37c3c6(0x181)][_0x37c3c6(0x189)](_0x2e9f01);}async[_0x3f570c(0x17a)](_0x3c0baa,_0x4ce2c8){const _0x29a727=_0x3f570c;let _0x311f2a=await this[_0x29a727(0x181)]['findOne']({'where':{'relateId':_0x4ce2c8,'relateType':_0x3c0baa}});!_0x311f2a&&(_0x311f2a=new aiLogExt_entity_1['AiLogExtEntity'](),_0x311f2a[_0x29a727(0x17c)]=_0x4ce2c8,_0x311f2a[_0x29a727(0x16e)]=_0x3c0baa),_0x311f2a[_0x29a727(0x199)]=_0x311f2a[_0x29a727(0x199)]+Math['round'](Math[_0x29a727(0x180)]()*0x14),await this[_0x29a727(0x181)][_0x29a727(0x189)](_0x311f2a);}};AiLogService=__decorate([(0x0,common_1[_0x3f570c(0x198)])(),__param(0x0,(0x0,typeorm_2['InjectRepository'])(aiLogExt_entity_1[_0x3f570c(0x192)])),__param(0x1,(0x0,typeorm_2[_0x3f570c(0x176)])(aiAgreeLog_entity_1[_0x3f570c(0x18f)])),__metadata('design:paramtypes',[typeorm_1['Repository'],typeorm_1[_0x3f570c(0x18a)],typeorm_1[_0x3f570c(0x19e)]])],AiLogService),exports['AiLogService']=AiLogService;