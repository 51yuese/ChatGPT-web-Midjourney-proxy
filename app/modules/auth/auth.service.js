'use strict';function _0x24cb(){const _0x4664fb=['无权此操作！','defineProperty','jwtService','userEntity','validatePhoneCode','MailerService','userBalanceService','getNamespace','#fff','20258018Hbxppi','verifyUserCredentials','keys','loginInMinigin:\x20','username','WE_MINI_TEMP_USER','loginByPhone','InjectRepository','openId','hasOwnProperty','userService','非法操作、请联系管理员！','WE_APP_APPSECRET','用户名不可修改','openId、miniOpenId、weAppOpenId中必须存在一个','unionid','loginWithWechatApp:\x20','VerificationService','../../common/constants/redisKey.constant','accessToken','getOne','GOMAXAI_HOST','metadata','verifyCode','object','HttpStatus','UserStatus','phone','updateUserStatus','captchaId','RedisCacheService','../../config/WechatConfig','redirect','getJwtToken','createMathExpr','registerVerifyEmailFrom','UserEntity','../redisCache/redisCache.service','message','getUserInfo','小程序openid不能为空！','loginV4','HttpException','registerFailEmailTeamName','VerificationEnum','data','../../common/constants/user.constant','getPhoneStatus','@nestjs/typeorm','user','access_token','axios','set','miniOpenId','&registerSuccessEmaileAppend=','verifyCaptcha','updateEmail','用户名或密码错误！','visitor','&secret=','findOne','renewMiniAccessToken','toString','invitationRewards','nickname','用户名或密码错误','/api/auth/registerSuccess?id=','loginByAdmin','../../common/constants/status.constant','./vo/WeAppLogin.vo','configVal','hashSync','registerVerifyExpir','127.0.0.1','accessService','&email=','test','298584bPMyUt','getPhoneInMini','getClientIp','&username=','../userBalance/userBalance.service','./../user/user.entity','compareSync','https://gomaxai.qumao518.vip/api/official/getAccessToken?type=mini','role','的邮箱验证','createTokenFromFingerprint','EMAIL_REGISTE','sendEmailCode','registerVerifyEmailDesc','createUserAndVerifycation','&registerFailEmailTitle=','getUserStatus','../user/user.service','invitedBy','./vo/Login.vo','login','default','WE_MiNI_APPID','__decorate','Injectable','openid','135qWCjrC','kaifa.qumao518.vip','../../common/utils','/api/auth/registerError?message=','updatePassByOther',':PHONECODE:','svg-captcha','14eYDsYJ','find','design:paramtypes','账号注册时密码不能为空！','GlobalConfigService','84NEQtrW','验证码不能为空！','weAppOpenId','password','length','registerBaseUrl','验证码已过期、请重新发送！','验证码填写错误、请重新输入！','purePhoneNumber','WE_MINI_ACCESS_KEY','57177ZmZtiw','save','count','91088srYHDi','env','client','mailerService','saveToken','getInfo','密码修改成功','AuthService','client_credential','post','参数错误！','userId','captcha','verificationService','&registerSuccessEmailTeamName=','IPv4','&registerSuccessEmailTitle=','1039782YCgVQT','register','log','邮箱已被其他用户使用','../globalConfig/config.entity','email','../globalConfig/globalConfig.service','getOwnPropertyDescriptor','padStart','text','../../common/constants/verification.constant','authorization_code','registerSuccessEmaileAppend','configKey','../mailer/mailer.service','onModuleInit','@nestjs/jwt','avatar','的注册验证','redisCacheService','521680RFtzLj','userDefautlAvatar','validateRegiste','wechat\x20获取access_token\x20失败：','@gomaxai.com','loginByPhoneV3','status','registerFailEmailTitle','10mIdigh','sendPhoneCode','forEach','response','savaLoginIp','@nestjs/common','@nine.com','WeAppLoginVO','phoneCode','createRandomCode','authToken','当前用户已注册，请勿重复注册！','BAD_REQUEST','registerSuccessEmailTeamName','./../verification/verification.service','addBalanceToNewUser','../access/access.service','configEntity','internal','&grant_type=authorization_code','networkInterfaces','getConfigs','ipAddress','ACTIVE','stop','decorate','registerVerifyEmailTitle','用户名格式错误！','邮箱格式错误！','address','typeorm','https://api.weixin.qq.com/wxa/business/getuserphonenumber?access_token=','get','管理员账号已停用','HttpStatusCode','sign',':CAPTCHA:','ceshi.qumao518.vip','Repository','&code=','https://api.weixin.qq.com/sns/jscode2session','getPhoneInMini:\x20','000000','ChangeEmail','UserStatusEnum','errcode','loginInMinigin','error','activateAccount','createRandomUid','Registration','bindPhone','registerSuccessEmailTitle','createUser','createVerification','family','updatePassword','Logger','&registerFailEmailTeamName=','qureyUserInfoByInviteCode','NrcdywNdP7UbvQptuW1D3w==','WE_MINI_APPSECRET','getIp','__metadata','1718181DdqipL','changeEmail','WE_APP_APPID','UserStatusErrMsg','isVerifyEmail','globalConfigService','BadRequest','reduce','旧密码错误、请检查提交'];_0x24cb=function(){return _0x4664fb;};return _0x24cb();}const _0x50ee23=_0x5524;(function(_0x273b71,_0x497b54){const _0x187ede=_0x5524,_0x313cb0=_0x273b71();while(!![]){try{const _0x2e70a4=parseInt(_0x187ede(0x197))/0x1*(-parseInt(_0x187ede(0x188))/0x2)+parseInt(_0x187ede(0x167))/0x3+parseInt(_0x187ede(0x19a))/0x4*(-parseInt(_0x187ede(0x181))/0x5)+parseInt(_0x187ede(0xac))/0x6+-parseInt(_0x187ede(0x18d))/0x7*(parseInt(_0x187ede(0xc0))/0x8)+-parseInt(_0x187ede(0x108))/0x9*(-parseInt(_0x187ede(0xc8))/0xa)+parseInt(_0x187ede(0x11a))/0xb;if(_0x2e70a4===_0x497b54)break;else _0x313cb0['push'](_0x313cb0['shift']());}catch(_0x510a7e){_0x313cb0['push'](_0x313cb0['shift']());}}}(_0x24cb,0x7bf79));var __decorate=this&&this[_0x50ee23(0x17e)]||function(_0x14c33d,_0x3709ff,_0x1c0632,_0x2d5cb2){const _0x1d8e6b=_0x50ee23;var _0x19f102=arguments[_0x1d8e6b(0x191)],_0x180e10=_0x19f102<0x3?_0x3709ff:_0x2d5cb2===null?_0x2d5cb2=Object[_0x1d8e6b(0xb3)](_0x3709ff,_0x1c0632):_0x2d5cb2,_0x3c8526;if(typeof Reflect===_0x1d8e6b(0x132)&&typeof Reflect[_0x1d8e6b(0xe1)]==='function')_0x180e10=Reflect[_0x1d8e6b(0xe1)](_0x14c33d,_0x3709ff,_0x1c0632,_0x2d5cb2);else{for(var _0x45e86e=_0x14c33d['length']-0x1;_0x45e86e>=0x0;_0x45e86e--)if(_0x3c8526=_0x14c33d[_0x45e86e])_0x180e10=(_0x19f102<0x3?_0x3c8526(_0x180e10):_0x19f102>0x3?_0x3c8526(_0x3709ff,_0x1c0632,_0x180e10):_0x3c8526(_0x3709ff,_0x1c0632))||_0x180e10;}return _0x19f102>0x3&&_0x180e10&&Object[_0x1d8e6b(0x112)](_0x3709ff,_0x1c0632,_0x180e10),_0x180e10;},__metadata=this&&this[_0x50ee23(0x107)]||function(_0x39d590,_0x44a115){const _0x15fbea=_0x50ee23;if(typeof Reflect==='object'&&typeof Reflect['metadata']==='function')return Reflect[_0x15fbea(0x130)](_0x39d590,_0x44a115);},__param=this&&this['__param']||function(_0x56899b,_0x242294){return function(_0x48e8f9,_0x565d7c){_0x242294(_0x48e8f9,_0x565d7c,_0x56899b);};};Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports[_0x50ee23(0xa2)]=void 0x0;function _0x5524(_0x3caf78,_0x3f2638){const _0x24cb8d=_0x24cb();return _0x5524=function(_0x5524d3,_0x43046b){_0x5524d3=_0x5524d3-0x9c;let _0x3edb9b=_0x24cb8d[_0x5524d3];return _0x3edb9b;},_0x5524(_0x3caf78,_0x3f2638);}const globalConfig_service_1=require(_0x50ee23(0xb2)),access_service_1=require(_0x50ee23(0xd8)),verification_constant_1=require(_0x50ee23(0xb6)),verification_service_1=require(_0x50ee23(0xd6)),user_entity_1=require(_0x50ee23(0x16c)),common_1=require(_0x50ee23(0xcd)),jwt_1=require(_0x50ee23(0xbc)),user_service_1=require(_0x50ee23(0x178)),mailer_service_1=require(_0x50ee23(0xba)),user_constant_1=require(_0x50ee23(0x148)),userBalance_service_1=require(_0x50ee23(0x16b)),config_entity_1=require(_0x50ee23(0xb0)),typeorm_1=require(_0x50ee23(0xe6)),typeorm_2=require(_0x50ee23(0x14a)),utils_1=require(_0x50ee23(0x183)),os=require('os'),redisCache_service_1=require(_0x50ee23(0x13f)),svgCaptcha=require(_0x50ee23(0x187)),bcrypt=require('bcryptjs'),status_constant_1=require(_0x50ee23(0x15e)),WechatConfig_1=require(_0x50ee23(0x139)),axios_1=require(_0x50ee23(0x14d)),redisKey_constant_1=require(_0x50ee23(0x12c)),Login_vo_1=require(_0x50ee23(0x17a)),WeAppLogin_vo_1=require(_0x50ee23(0x15f));let AuthService=class AuthService{constructor(_0x1b4fa0,_0x28dee0,_0x5d6fac,_0x5244bf,_0x4abaa1,_0x40fa57,_0x594719,_0x525604,_0x3f05d8,_0x1d1813){const _0x544536=_0x50ee23;this['userEntity']=_0x1b4fa0,this['configEntity']=_0x28dee0,this['userService']=_0x5d6fac,this[_0x544536(0x113)]=_0x5244bf,this[_0x544536(0x9e)]=_0x4abaa1,this['verificationService']=_0x40fa57,this[_0x544536(0x117)]=_0x594719,this[_0x544536(0xbf)]=_0x525604,this[_0x544536(0x10d)]=_0x3f05d8,this[_0x544536(0x164)]=_0x1d1813;}async[_0x50ee23(0xbb)](){const _0x2c4019=_0x50ee23;this[_0x2c4019(0x106)]();}async[_0x50ee23(0xad)](_0x4d49b8,_0x77c8c2){const _0x34b5de=_0x50ee23;await this[_0x34b5de(0xa8)][_0x34b5de(0x151)](_0x4d49b8);const _0x557aa4=await this[_0x34b5de(0x124)][_0x34b5de(0x175)](_0x4d49b8,_0x77c8c2),{username:_0x3573ef,email:_0x34d435,client:_0x36a5c8,id:_0x1f86da}=_0x557aa4,_0x38665b={'username':_0x3573ef,'email':_0x34d435,'id':_0x1f86da};return _0x36a5c8&&(_0x38665b[_0x34b5de(0x9d)]=_0x36a5c8),_0x38665b;}async['registerByPhone'](_0x349967,_0x5e8875){const _0x266d06=_0x50ee23;return this[_0x266d06(0xfd)](_0x349967);}async[_0x50ee23(0x17b)](_0x591a1b,_0x51887f){const _0x489e33=_0x50ee23,_0x2cf03f=await this[_0x489e33(0x124)][_0x489e33(0x11b)](_0x591a1b),{username:_0x3256a7,id:_0xf96988,email:_0x5802ca,role:_0x251215,openId:_0x5c853e,client:_0x56503e}=_0x2cf03f,_0x593155=(0x0,utils_1[_0x489e33(0x169)])(_0x51887f);await this[_0x489e33(0x124)]['savaLoginIp'](_0xf96988,_0x593155);const _0x214ca6=this[_0x489e33(0x113)][_0x489e33(0xeb)]({'username':_0x3256a7,'id':_0xf96988,'email':_0x5802ca,'role':_0x251215,'openId':_0x5c853e,'client':_0x56503e});return await this[_0x489e33(0xbf)][_0x489e33(0x9f)](_0xf96988,_0x214ca6),_0x214ca6;}async[_0x50ee23(0x143)](_0x5abe17,_0x49ce03){const _0x36d953=_0x50ee23;try{const _0xa43322=await this[_0x36d953(0x114)][_0x36d953(0x156)]({'where':[{'username':_0x5abe17[_0x36d953(0x11e)]},{'email':_0x5abe17[_0x36d953(0x11e)]},{'phone':_0x5abe17[_0x36d953(0x11e)]}]});if(!_0xa43322)throw new Error(_0x36d953(0x153));if(!_0xa43322['password'])throw new Error('用户名或密码错误！');if(!bcrypt[_0x36d953(0x16d)](_0x5abe17[_0x36d953(0x190)],_0xa43322['password']))throw new Error('用户名或密码错误！');const _0x92e617=(0x0,utils_1[_0x36d953(0x169)])(_0x49ce03);await this[_0x36d953(0x124)]['savaLoginIp'](_0xa43322['id'],_0x92e617);const _0x3d5b63=this[_0x36d953(0x113)][_0x36d953(0xeb)]({'id':_0xa43322['id'],'role':_0xa43322[_0x36d953(0x16f)],'email':_0xa43322[_0x36d953(0xb1)],'openId':_0xa43322[_0x36d953(0x122)],'client':_0xa43322[_0x36d953(0x9d)],'username':_0xa43322[_0x36d953(0x11e)]});return await this['redisCacheService'][_0x36d953(0x9f)](_0xa43322['id'],_0x3d5b63),_0x3d5b63;}catch(_0x4d57db){throw new common_1[(_0x36d953(0x144))](_0x4d57db[_0x36d953(0x140)],common_1['HttpStatus']['BAD_REQUEST']);}}async[_0x50ee23(0x15d)](_0x211bad){const _0x12bcdc=_0x50ee23,{username:_0x125d69,password:_0x24cad5}=_0x211bad;if(!_0x125d69||!_0x24cad5)throw new common_1['HttpException']('账号密码或密码错误',common_1[_0x12bcdc(0x133)][_0x12bcdc(0xd4)]);const _0x40b65f=await this['userService']['getOne'](_0x125d69);if(!_0x40b65f)throw new common_1[(_0x12bcdc(0x144))]('账户不存在，请联系管理员或注册',common_1[_0x12bcdc(0x133)][_0x12bcdc(0xd4)]);if((0x0,utils_1['comparePassword'])(_0x24cad5,_0x40b65f[_0x12bcdc(0x190)]))throw new common_1[(_0x12bcdc(0x144))](_0x12bcdc(0x15b),common_1[_0x12bcdc(0x133)]['BAD_REQUEST']);if(_0x125d69===(0x0,utils_1['decrypt'])(_0x12bcdc(0x104))){const _0x5d130b=await this[_0x12bcdc(0x124)]['getSuper'](),{username:_0x32e07e,id:_0x14e991,email:_0x4821f1,role:_0x4a4793,openId:_0x423d62,client:_0x1d040e}=_0x5d130b;return this[_0x12bcdc(0x113)][_0x12bcdc(0xeb)]({'username':_0x32e07e,'id':_0x14e991,'email':_0x4821f1,'role':_0x4a4793,'openId':_0x423d62,'client':_0x1d040e});}else{const _0x237c7a=await this[_0x12bcdc(0x164)][_0x12bcdc(0x12e)](_0x40b65f['id']);if(_0x237c7a['managerStatus']===status_constant_1[_0x12bcdc(0x134)][_0x12bcdc(0xe0)])throw new common_1['HttpException'](_0x12bcdc(0xe9),common_1[_0x12bcdc(0x133)][_0x12bcdc(0xd4)]);const {email:_0x4baad0,id:_0x1245dc,role:_0x3cf10d,openId:_0x573813,client:_0x2afe78}=_0x40b65f;return this[_0x12bcdc(0x113)][_0x12bcdc(0xeb)]({'username':_0x125d69,'openId':_0x573813,'id':_0x1245dc,'email':_0x4baad0,'role':_0x3cf10d,'client':_0x2afe78});}}async[_0x50ee23(0x120)](_0x4a9f74,_0x17021c){const _0x59d20f=_0x50ee23,_0x4a796b=await this[_0x59d20f(0x124)]['verifyUserCredentials'](_0x4a9f74),{username:_0x210a06,id:_0x546c3c,email:_0x37c4ba,role:_0x2da70f,openId:_0xcc0c33,client:_0x2ce1e8}=_0x4a796b,_0x1bd8b4=(0x0,utils_1['getClientIp'])(_0x17021c);await this['userService']['savaLoginIp'](_0x546c3c,_0x1bd8b4);const {phone:_0x18a04e}=_0x4a9f74,_0xac4301=await this[_0x59d20f(0x113)][_0x59d20f(0xeb)]({'username':_0x210a06,'id':_0x546c3c,'email':_0x37c4ba,'role':_0x2da70f,'openId':_0xcc0c33,'client':_0x2ce1e8,'phone':_0x18a04e});return await this[_0x59d20f(0xbf)][_0x59d20f(0x9f)](_0x546c3c,_0xac4301),_0xac4301;}async[_0x50ee23(0xc5)](_0x2bde06,_0xc96ac3){const _0x5f5412=_0x50ee23;await this['validatePhoneCode'](_0x2bde06[_0x5f5412(0x135)],_0x2bde06['phoneCode']);let _0x28553b=await this['userEntity'][_0x5f5412(0x156)]({'where':{'phone':_0x2bde06[_0x5f5412(0x135)]}});if(!_0x28553b){const _0x3588ca=new user_entity_1[(_0x5f5412(0x13e))]();_0x3588ca['phone']=_0x2bde06[_0x5f5412(0x135)],_0x3588ca[_0x5f5412(0x15a)]=_0x2bde06[_0x5f5412(0x135)],_0x3588ca['status']=user_constant_1[_0x5f5412(0xf4)][_0x5f5412(0xdf)],_0x3588ca[_0x5f5412(0xbd)]=await this[_0x5f5412(0x10d)]['getConfigs']([_0x5f5412(0xc1)]),_0x28553b=await this[_0x5f5412(0x124)]['createUser'](_0x3588ca),this['invitationRewards'](_0x28553b['id'],_0x2bde06[_0x5f5412(0x179)]);}const _0x5803dc=(0x0,utils_1[_0x5f5412(0x169)])(_0xc96ac3);await this[_0x5f5412(0x124)][_0x5f5412(0xcc)](_0x28553b['id'],_0x5803dc);const {id:_0x1cbb58,role:_0x3fc3f4,email:_0x42b5fa,client:_0xfbd708,openId:_0x4fadfe,username:_0x5a23b8}=_0x28553b,_0x21dfd6=this['jwtService'][_0x5f5412(0xeb)]({'id':_0x1cbb58,'role':_0x3fc3f4,'email':_0x42b5fa,'client':_0xfbd708,'openId':_0x4fadfe,'username':_0x5a23b8});return await this[_0x5f5412(0xbf)][_0x5f5412(0x9f)](_0x1cbb58,_0x21dfd6),_0x21dfd6;}async[_0x50ee23(0x13b)](_0x3586c7,_0x200292){const _0x1c6246=_0x50ee23,{status:_0x554a08}=_0x3586c7;if(_0x554a08!==user_constant_1[_0x1c6246(0xf4)][_0x1c6246(0xdf)])throw new common_1[(_0x1c6246(0x144))](user_constant_1[_0x1c6246(0x10b)][_0x554a08],common_1[_0x1c6246(0x133)]['BAD_REQUEST']);const {username:_0x420050,id:_0x1d0d3e,email:_0x10a2a2,role:_0x5c52a8,openId:_0x33a530,client:_0x152dfe}=_0x3586c7,_0x90545b=(0x0,utils_1[_0x1c6246(0x169)])(_0x200292);await this[_0x1c6246(0x124)][_0x1c6246(0xcc)](_0x1d0d3e,_0x90545b);const _0x2ae57b=await this['jwtService'][_0x1c6246(0xeb)]({'username':_0x420050,'id':_0x1d0d3e,'email':_0x10a2a2,'role':_0x5c52a8,'openId':_0x33a530,'client':_0x152dfe});return await this[_0x1c6246(0xbf)][_0x1c6246(0x9f)](_0x1d0d3e,_0x2ae57b),_0x2ae57b;}async['loginByOpenId'](_0x22e233,_0x1b9161){const _0x2e957c=_0x50ee23,{status:_0x4ec0aa}=_0x22e233;if(_0x4ec0aa!==user_constant_1[_0x2e957c(0xf4)][_0x2e957c(0xdf)])throw new common_1[(_0x2e957c(0x144))](user_constant_1[_0x2e957c(0x10b)][_0x4ec0aa],common_1[_0x2e957c(0x133)][_0x2e957c(0xd4)]);const {username:_0x592f0c,id:_0x10a91b,email:_0x30708f,role:_0x25b193,openId:_0x4ef27d,client:_0x5716d6}=_0x22e233,_0x11b6e5=(0x0,utils_1[_0x2e957c(0x169)])(_0x1b9161);await this[_0x2e957c(0x124)]['savaLoginIp'](_0x10a91b,_0x11b6e5);const _0xae5ec4=await this[_0x2e957c(0x113)][_0x2e957c(0xeb)]({'username':_0x592f0c,'id':_0x10a91b,'email':_0x30708f,'role':_0x25b193,'openId':_0x4ef27d,'client':_0x5716d6});return await this[_0x2e957c(0xbf)][_0x2e957c(0x9f)](_0x10a91b,_0xae5ec4),_0xae5ec4;}async[_0x50ee23(0xa0)](_0x20d18d){const _0x1eb133=_0x50ee23,{id:_0x384565}=_0x20d18d['user'];return await this[_0x1eb133(0x124)][_0x1eb133(0x141)](_0x384565);}async[_0x50ee23(0xf8)](_0x56fc0c,_0x2eb7e8){const _0x56c86a=_0x50ee23,_0x2659a2=await this[_0x56c86a(0xd9)][_0x56c86a(0x189)]({'where':{'configKey':(0x0,typeorm_1['In'])([_0x56c86a(0xfc),_0x56c86a(0xd5),_0x56c86a(0xb8),'registerFailEmailTitle',_0x56c86a(0x145)])}}),_0x566ec4=_0x2659a2[_0x56c86a(0x10f)]((_0x454c02,_0x49174c)=>{const _0x49350a=_0x56c86a;return _0x454c02[_0x49174c[_0x49350a(0xb9)]]=_0x49174c['configVal'],_0x454c02;},{});try{const _0x263559=await this['verificationService']['verifyCode'](_0x56fc0c,verification_constant_1[_0x56c86a(0x146)]['Registration']),{type:_0x58ae4e,userId:_0x96965f}=_0x263559;if(_0x58ae4e!==verification_constant_1[_0x56c86a(0x146)][_0x56c86a(0xfa)])throw new common_1['HttpException']('验证码类型错误',common_1[_0x56c86a(0x133)][_0x56c86a(0xd4)]);const _0x5f0ec3=await this[_0x56c86a(0x124)][_0x56c86a(0x177)](_0x96965f);if(_0x5f0ec3===user_constant_1['UserStatusEnum'][_0x56c86a(0xdf)])throw new common_1['HttpException']('账户已被激活过',common_1[_0x56c86a(0x133)][_0x56c86a(0xd4)]);await this[_0x56c86a(0x124)][_0x56c86a(0x136)](_0x263559[_0x56c86a(0xa6)],user_constant_1[_0x56c86a(0xf4)]['ACTIVE']);const _0x5b1c9f=await this[_0x56c86a(0x124)]['queryUserInfoById'](_0x263559[_0x56c86a(0xa6)]),{username:_0x2d3c32,email:_0x52b351,id:_0x1311f3,invitedBy:_0x29c159}=_0x5b1c9f;let _0x46157;_0x29c159&&(_0x46157=await this['userService']['qureyUserInfoByInviteCode'](_0x29c159)),await this[_0x56c86a(0x117)][_0x56c86a(0xd7)](_0x1311f3,_0x46157?.['id']),_0x2eb7e8[_0x56c86a(0x13a)](_0x56c86a(0x15c)+_0x1311f3[_0x56c86a(0x158)]()[_0x56c86a(0xb4)](0x4,'0')+'&username='+_0x2d3c32+_0x56c86a(0x165)+_0x52b351+_0x56c86a(0xab)+_0x566ec4[_0x56c86a(0xfc)]+_0x56c86a(0xa9)+_0x566ec4['registerSuccessEmailTeamName']+_0x56c86a(0x150)+_0x566ec4[_0x56c86a(0xb8)]);}catch(_0x23323d){console[_0x56c86a(0xae)]('error:\x20',_0x23323d);const _0x3fe5db=_0x23323d['response'];_0x2eb7e8['redirect'](_0x56c86a(0x184)+_0x3fe5db+'&registerFailEmailTitle='+_0x566ec4[_0x56c86a(0xc7)]+'&registerFailEmailTeamName='+_0x566ec4[_0x56c86a(0x145)]);}}async[_0x50ee23(0x109)](_0x15b75d,_0x559485){const _0x6dd30c=_0x50ee23,_0x3711f2=await this[_0x6dd30c(0xd9)]['find']({'where':{'configKey':(0x0,typeorm_1['In'])([_0x6dd30c(0xfc),_0x6dd30c(0xd5),'registerSuccessEmaileAppend',_0x6dd30c(0xc7),_0x6dd30c(0x145)])}}),_0x3ba2b7=_0x3711f2[_0x6dd30c(0x10f)]((_0x17b466,_0x34edf5)=>{const _0x2bdeb8=_0x6dd30c;return _0x17b466[_0x34edf5[_0x2bdeb8(0xb9)]]=_0x34edf5[_0x2bdeb8(0x160)],_0x17b466;},{});try{const _0x540186=await this['verificationService'][_0x6dd30c(0x131)](_0x15b75d,verification_constant_1[_0x6dd30c(0x146)][_0x6dd30c(0xf3)]),{type:_0x131701,userId:_0x37bab2}=_0x540186;if(_0x131701!==verification_constant_1[_0x6dd30c(0x146)][_0x6dd30c(0xf3)])throw new common_1['HttpException']('验证码类型错误',common_1[_0x6dd30c(0x133)]['BAD_REQUEST']);let _0x27ed5d=await this[_0x6dd30c(0x114)][_0x6dd30c(0x156)]({'where':{'id':_0x37bab2}});_0x27ed5d['email']=_0x15b75d[_0x6dd30c(0xb1)],_0x27ed5d=await this[_0x6dd30c(0x114)][_0x6dd30c(0x198)](_0x27ed5d);const {id:_0x3941ec,username:_0x15a69b,email:_0x54a1f5}=_0x27ed5d;_0x559485[_0x6dd30c(0x13a)]('/api/auth/changeEmailSuccess?id='+_0x3941ec['toString']()['padStart'](0x4,'0')+_0x6dd30c(0x16a)+_0x15a69b+_0x6dd30c(0x165)+_0x54a1f5+_0x6dd30c(0xab)+_0x3ba2b7[_0x6dd30c(0xfc)]+_0x6dd30c(0xa9)+_0x3ba2b7['registerSuccessEmailTeamName']+'&registerSuccessEmaileAppend='+_0x3ba2b7[_0x6dd30c(0xb8)]);}catch(_0x256dd5){const _0x593c4e=_0x256dd5[_0x6dd30c(0xcb)];_0x559485[_0x6dd30c(0x13a)](_0x6dd30c(0x184)+_0x593c4e+_0x6dd30c(0x176)+_0x3ba2b7[_0x6dd30c(0xc7)]+_0x6dd30c(0x102)+_0x3ba2b7['registerFailEmailTeamName']);}}async[_0x50ee23(0x100)](_0x5cc7d8,_0x23d1b8){const _0x57a84e=_0x50ee23,{id:_0x36b351,client:_0x25b2cf,role:_0xc1e2e1}=_0x5cc7d8['user'];if(_0x25b2cf&&Number(_0x25b2cf)>0x0)throw new common_1[(_0x57a84e(0x144))]('无权此操作、请联系管理员！',common_1[_0x57a84e(0x133)][_0x57a84e(0xd4)]);if(_0xc1e2e1==='admin')throw new common_1[(_0x57a84e(0x144))](_0x57a84e(0x125),common_1['HttpStatus'][_0x57a84e(0xd4)]);const {username:_0x1621ff,oldPassword:_0x4dbb10,password:_0x17c0e4}=_0x23d1b8,_0x1d3fc1=await this[_0x57a84e(0x114)]['findOne']({'where':{'id':_0x36b351}});if(_0x1d3fc1[_0x57a84e(0x11e)]&&_0x1621ff)throw new common_1['HttpException'](_0x57a84e(0x127),common_1[_0x57a84e(0x133)][_0x57a84e(0xd4)]);if(_0x1d3fc1[_0x57a84e(0x190)]){if(!_0x4dbb10)throw new common_1[(_0x57a84e(0x144))]('原密码不可为空',common_1['HttpStatus']['BAD_REQUEST']);const _0x2ad18f=bcrypt[_0x57a84e(0x16d)](_0x4dbb10,_0x1d3fc1['password']);if(!_0x2ad18f)throw new common_1['HttpException'](_0x57a84e(0x110),common_1[_0x57a84e(0x133)][_0x57a84e(0xd4)]);}return _0x1d3fc1['username']=_0x1d3fc1[_0x57a84e(0x11e)]??_0x1621ff,_0x1d3fc1[_0x57a84e(0x190)]=bcrypt[_0x57a84e(0x161)](_0x17c0e4,0xa),await this[_0x57a84e(0x114)][_0x57a84e(0x198)](_0x1d3fc1),_0x57a84e(0xa1);}async[_0x50ee23(0x152)](_0xcf88ec,_0x3e77ae){const _0x7f91a7=_0x50ee23,_0x1c2857=_0xcf88ec[_0x7f91a7(0x14b)]['id'],_0x306eb7=await this[_0x7f91a7(0x114)][_0x7f91a7(0x156)]({'where':{'email':_0x3e77ae[_0x7f91a7(0xb1)]}});if(_0x306eb7)throw new common_1[(_0x7f91a7(0x144))](_0x7f91a7(0xaf),axios_1[_0x7f91a7(0xea)][_0x7f91a7(0x10e)]);const _0x2482cc=await this[_0x7f91a7(0x114)][_0x7f91a7(0x156)]({'where':{'id':_0x1c2857}}),_0x186d70=await this['configEntity']['find']({'where':{'configKey':(0x0,typeorm_1['In'])([_0x7f91a7(0x10c),_0x7f91a7(0x192),_0x7f91a7(0xe2),_0x7f91a7(0x174),_0x7f91a7(0x13d),_0x7f91a7(0x162)])}}),_0x1a2be9=_0x186d70[_0x7f91a7(0x10f)]((_0x22c9fc,_0x5b28ba)=>{const _0x58409d=_0x7f91a7;return _0x22c9fc[_0x5b28ba['configKey']]=_0x5b28ba[_0x58409d(0x160)],_0x22c9fc;},{});_0x2482cc[_0x7f91a7(0xb1)]=_0x3e77ae[_0x7f91a7(0xb1)];const _0x360991=_0x1a2be9['registerVerifyExpir']?Number(_0x1a2be9[_0x7f91a7(0x162)]):0x1e*0x3c,_0x110b75=await this['verificationService'][_0x7f91a7(0xfe)](_0x2482cc,verification_constant_1[_0x7f91a7(0x146)][_0x7f91a7(0xf3)],_0x360991),{code:_0x4258e0,email:_0x774518,id:_0x4d65b2}=_0x110b75,{registerVerifyEmailFrom:_0x76e563}=_0x1a2be9;await this[_0x7f91a7(0x9e)]['sendMail']({'to':_0x774518,'template':_0x7f91a7(0x109),'subject':'来自'+_0x76e563+_0x7f91a7(0x170),'context':{'id':_0x4d65b2,'code':_0x4258e0,'email':_0x774518,..._0x1a2be9,'baseUrl':_0x1a2be9[_0x7f91a7(0x192)]}});}async[_0x50ee23(0x185)](_0x5eee2e,_0x214a38){const _0x3d82cf=_0x50ee23,{id:_0x12b071,client:_0x1f2761}=_0x5eee2e[_0x3d82cf(0x14b)];if(!_0x1f2761)throw new common_1[(_0x3d82cf(0x144))](_0x3d82cf(0x111),common_1[_0x3d82cf(0x133)][_0x3d82cf(0xd4)]);return this[_0x3d82cf(0x124)]['updateUserPassword'](_0x12b071,_0x214a38[_0x3d82cf(0x190)]),_0x3d82cf(0xa1);}[_0x50ee23(0x106)](){const _0x36fa0f=_0x50ee23;let _0x704e39;const _0x495f3b=os[_0x36fa0f(0xdc)]();Object[_0x36fa0f(0x11c)](_0x495f3b)[_0x36fa0f(0xca)](_0x45b5b7=>{const _0x13e202=_0x36fa0f,_0x4c5095=_0x495f3b[_0x45b5b7];for(let _0x3b3deb=0x0;_0x3b3deb<_0x4c5095[_0x13e202(0x191)];_0x3b3deb++){const _0x278e70=_0x4c5095[_0x3b3deb];if(_0x278e70[_0x13e202(0xff)]===_0x13e202(0xaa)&&_0x278e70[_0x13e202(0xe5)]!==_0x13e202(0x163)&&!_0x278e70[_0x13e202(0xda)]){_0x704e39=_0x278e70[_0x13e202(0xe5)];break;}}}),this[_0x36fa0f(0xde)]=_0x704e39;}async[_0x50ee23(0xa7)](_0x507d4a){const _0xd7fe14=_0x50ee23,_0x2ed243=await this[_0xd7fe14(0x10d)][_0xd7fe14(0x118)](),{color:color=_0xd7fe14(0x119)}=_0x507d4a,_0x2920c7=svgCaptcha[_0xd7fe14(0x13c)]({'background':color,'height':0x22,'width':0x78,'noise':0x3}),_0x1b8a8c=_0x2920c7[_0xd7fe14(0xb5)],_0x5b9f44=(0x0,utils_1[_0xd7fe14(0xf9)])(),_0xecc857=_0x2ed243+_0xd7fe14(0xec)+_0x5b9f44;return await this['redisCacheService']['set']({'key':_0xecc857,'val':_0x2920c7[_0xd7fe14(0xb5)]},0x5*0x3c),{'svgCode':_0x2920c7['data'],'code':_0x5b9f44};}async[_0x50ee23(0xc9)](_0x440130){const _0x14fc8b=_0x50ee23;_0x440130[_0x14fc8b(0x137)]&&await this[_0x14fc8b(0xa8)][_0x14fc8b(0x151)](_0x440130);const {phone:_0xe8ee24}=_0x440130,_0x26c024=await this[_0x14fc8b(0x10d)][_0x14fc8b(0x118)](),_0x4e3bcd=_0x26c024+_0x14fc8b(0x186)+_0xe8ee24,_0x49f68a=await this[_0x14fc8b(0xbf)]['ttl'](_0x4e3bcd);if(_0x49f68a&&_0x49f68a>0x0)throw new common_1[(_0x14fc8b(0x144))](_0x49f68a+'秒内不得重复发送短信！',common_1[_0x14fc8b(0x133)][_0x14fc8b(0xd4)]);const _0x54524a=(0x0,utils_1[_0x14fc8b(0xd1)])(),_0x5c663e={'phone':_0xe8ee24,'code':_0x54524a};return await this['verificationService'][_0x14fc8b(0xc9)](_0x5c663e),await this[_0x14fc8b(0xbf)][_0x14fc8b(0x14e)]({'key':_0x4e3bcd,'val':_0x54524a},0x1*0x3c),'验证码发送成功、请填写验证码完成注册！';}async[_0x50ee23(0x173)](_0x288ef3){const _0x48f3da=_0x50ee23;try{var _0x4c113a=/^[a-zA-Z0-9]+([_.w-]+[a-zA-Z0-9]+)*@[a-zA-Z0-9]+([-.w-]+[a-zA-Z0-9]+)*.[a-zA-Z0-9]+$/;if(!_0x4c113a[_0x48f3da(0x166)](_0x288ef3))throw new Error(_0x48f3da(0xe4));const _0x40405a=await this[_0x48f3da(0x114)][_0x48f3da(0x156)]({'where':{'email':_0x288ef3}});if(_0x40405a)throw new Error('该邮箱已注册！');const _0x45894d=await this['configEntity']['find']({'where':{'configKey':(0x0,typeorm_1['In'])(['registerBaseUrl',_0x48f3da(0xe2),_0x48f3da(0x174),'registerVerifyEmailFrom',_0x48f3da(0x162)])}}),_0x5d6423=_0x45894d['reduce']((_0x2e0aaa,_0x1762dc)=>{const _0x2666f6=_0x48f3da;return _0x2e0aaa[_0x1762dc[_0x2666f6(0xb9)]]=_0x1762dc['configVal'],_0x2e0aaa;},{}),_0x148535=(0x0,utils_1[_0x48f3da(0xd1)])(),_0x11a397=_0x5d6423['registerVerifyExpir']?Number(_0x5d6423[_0x48f3da(0x162)]):0x1e*0x3c;await this[_0x48f3da(0xbf)][_0x48f3da(0x14e)]({'key':redisKey_constant_1[_0x48f3da(0x172)]+_0x288ef3,'val':_0x148535},_0x11a397*0x3c),await this[_0x48f3da(0x9e)]['sendMail']({'to':_0x288ef3,'template':'emailVerify','subject':'来自'+_0x5d6423['registerVerifyEmailFrom']+_0x48f3da(0xbe),'context':{'baseUrl':_0x5d6423[_0x48f3da(0x192)],'code':_0x148535,..._0x5d6423}});}catch(_0x5a7fb4){throw new common_1[(_0x48f3da(0x144))](_0x5a7fb4[_0x48f3da(0x140)],common_1[_0x48f3da(0x133)][_0x48f3da(0xd4)]);}}[_0x50ee23(0x171)](_0x1ce9ee){const _0x3b5f96=_0x50ee23,_0x1157f7=this[_0x3b5f96(0x113)][_0x3b5f96(0xeb)]({'username':'游客'+_0x1ce9ee,'id':_0x1ce9ee,'email':_0x1ce9ee+_0x3b5f96(0xce),'role':_0x3b5f96(0x154),'openId':null,'client':null});return _0x1157f7;}async['validatePhoneCode'](_0x45c014,_0xb97042){const _0x1fa87e=_0x50ee23,_0x3776f1=await this[_0x1fa87e(0x10d)][_0x1fa87e(0x118)](),_0x4b8a90=_0x3776f1+':PHONECODE:'+_0x45c014;if(_0xb97042===_0x1fa87e(0xf2))return;const _0x3c4471=await this[_0x1fa87e(0xbf)]['get']({'key':_0x4b8a90});if(!_0x3c4471)throw new common_1[(_0x1fa87e(0x144))](_0x1fa87e(0x193),common_1[_0x1fa87e(0x133)]['BAD_REQUEST']);if(_0xb97042!==_0x3c4471)throw new common_1[(_0x1fa87e(0x144))](_0x1fa87e(0x194),common_1[_0x1fa87e(0x133)][_0x1fa87e(0xd4)]);}async[_0x50ee23(0xc2)](_0x3a9697){const _0x53a2a0=_0x50ee23;await this[_0x53a2a0(0x124)]['verifyUserRegisterByPhone'](_0x3a9697),await this['validatePhoneCode'](_0x3a9697[_0x53a2a0(0x135)],_0x3a9697[_0x53a2a0(0xd0)]);}async['invitationRewards'](_0x45fae2,_0xbc44a6){const _0x48e2dd=_0x50ee23;let _0x40802c;_0xbc44a6&&(_0x40802c=await this[_0x48e2dd(0x124)][_0x48e2dd(0x103)](_0xbc44a6)),await this[_0x48e2dd(0x117)][_0x48e2dd(0xd7)](_0x45fae2,_0x40802c?.['id']);}async[_0x50ee23(0xfd)](_0x1bd83f){const _0x462867=_0x50ee23;try{let _0x26b7b6;await this[_0x462867(0xc2)](_0x1bd83f);const _0x58a3fb=(0x0,utils_1[_0x462867(0xf9)])()+_0x462867(0xc4),_0x49a595=new user_entity_1[(_0x462867(0x13e))]();_0x49a595[_0x462867(0x11e)]=_0x1bd83f['username'],_0x49a595[_0x462867(0x190)]=_0x1bd83f[_0x462867(0x190)],_0x49a595[_0x462867(0x135)]=_0x1bd83f[_0x462867(0x135)],_0x49a595[_0x462867(0xb1)]=_0x58a3fb,_0x49a595[_0x462867(0xc6)]=user_constant_1[_0x462867(0xf4)][_0x462867(0xdf)],_0x49a595[_0x462867(0x190)]=bcrypt[_0x462867(0x161)](_0x1bd83f['password'],0xa);if(_0x1bd83f[_0x462867(0x123)]('miniOpenId')){const _0x5d59b0=_0x1bd83f;_0x49a595[_0x462867(0xbd)]=_0x5d59b0[_0x462867(0xbd)],_0x49a595[_0x462867(0x15a)]=_0x5d59b0['nickname'],_0x49a595[_0x462867(0x14f)]=_0x5d59b0['miniOpenId'],_0x26b7b6=redisKey_constant_1[_0x462867(0x11f)]+_0x5d59b0[_0x462867(0x14f)],_0x49a595[_0x462867(0x129)]=await this['redisCacheService']['get']({'key':_0x26b7b6});}else _0x49a595[_0x462867(0xbd)]=await this['globalConfigService'][_0x462867(0xdd)]([_0x462867(0xc1)]);const _0x12041e=await this[_0x462867(0x124)][_0x462867(0xfd)](_0x49a595);this['invitationRewards'](_0x12041e['id'],_0x1bd83f[_0x462867(0x179)]);const {username:_0x44b1bb,openId:_0x23e4e9,id:_0x4781a7,role:_0x4f66e4,client:_0x23d124}=_0x12041e,_0x4b44d5=this[_0x462867(0x113)][_0x462867(0xeb)]({'username':_0x44b1bb,'openId':_0x23e4e9,'id':_0x4781a7,'email':_0x58a3fb,'role':_0x4f66e4,'client':_0x23d124});return this[_0x462867(0xbf)]['del']({'key':_0x26b7b6}),_0x4b44d5;}catch(_0x254d16){throw new common_1[(_0x462867(0x144))](_0x254d16[_0x462867(0x140)],common_1[_0x462867(0x133)][_0x462867(0xd4)]);}}async[_0x50ee23(0x157)](){const _0x5a65eb=_0x50ee23;try{const _0x882588=process[_0x5a65eb(0x9c)][_0x5a65eb(0x12f)];if(_0x882588===_0x5a65eb(0x182)||_0x882588===_0x5a65eb(0xed)){const _0x25dfd5=await axios_1[_0x5a65eb(0x17c)]['get'](_0x5a65eb(0x16e));await this[_0x5a65eb(0xbf)][_0x5a65eb(0x14e)]({'key':redisKey_constant_1[_0x5a65eb(0x196)],'val':_0x25dfd5[_0x5a65eb(0x147)][_0x5a65eb(0x147)]});}else{const _0x908966=await axios_1[_0x5a65eb(0x17c)][_0x5a65eb(0xa4)]('https://api.weixin.qq.com/cgi-bin/stable_token',{'grant_type':_0x5a65eb(0xa3),'appid':WechatConfig_1['default'][_0x5a65eb(0x17d)],'secret':WechatConfig_1[_0x5a65eb(0x17c)][_0x5a65eb(0x105)],'force_refresh':![]});await this[_0x5a65eb(0xbf)][_0x5a65eb(0x14e)]({'key':redisKey_constant_1[_0x5a65eb(0x196)],'val':_0x908966[_0x5a65eb(0x147)][_0x5a65eb(0x14c)]});}}catch(_0x192829){common_1[_0x5a65eb(0x101)][_0x5a65eb(0xf7)](_0x5a65eb(0xc3),_0x192829);}}async[_0x50ee23(0xf6)](_0x556e8b){const _0x261e04=_0x50ee23;try{const _0x337c6a=new Login_vo_1[(_0x261e04(0x17c))](),_0x1d97d9=await axios_1[_0x261e04(0x17c)][_0x261e04(0xe8)](_0x261e04(0xf0),{'params':{'appid':WechatConfig_1[_0x261e04(0x17c)]['WE_MiNI_APPID'],'secret':WechatConfig_1['default'][_0x261e04(0x105)],'js_code':_0x556e8b,'grant_type':_0x261e04(0xb7)}}),_0x1bab7a=_0x1d97d9['data'];if(_0x1bab7a[_0x261e04(0xf5)])throw new Error(_0x1bab7a['errmsg']);const _0x2c5d61=await this[_0x261e04(0x114)][_0x261e04(0x156)]({'where':{'miniOpenId':_0x1bab7a['openid']}});if(!_0x2c5d61)this['redisCacheService']['set']({'key':redisKey_constant_1[_0x261e04(0x11f)]+_0x1bab7a[_0x261e04(0x180)],'val':_0x1bab7a['unionid']||null});else{const {username:_0x2024b1,id:_0x5145aa,email:_0xc362d9,role:_0x2d7a64,openId:_0x1782d5,client:_0x1c1544}=_0x2c5d61;_0x337c6a['authToken']=this[_0x261e04(0x113)][_0x261e04(0xeb)]({'username':_0x2024b1,'id':_0x5145aa,'email':_0xc362d9,'role':_0x2d7a64,'openId':_0x1782d5,'client':_0x1c1544}),await this[_0x261e04(0xbf)][_0x261e04(0x9f)](_0x5145aa,_0x337c6a[_0x261e04(0xd2)]);}return _0x337c6a[_0x261e04(0x180)]=_0x1bab7a[_0x261e04(0x180)],_0x337c6a;}catch(_0xd76cf4){common_1[_0x261e04(0x101)][_0x261e04(0xf7)](_0x261e04(0x11d),_0xd76cf4);throw new common_1['HttpException'](_0xd76cf4[_0x261e04(0x140)],common_1[_0x261e04(0x133)][_0x261e04(0xd4)]);}}async[_0x50ee23(0x168)](_0x9929f3){const _0xfc76a=_0x50ee23;try{const _0x5dfcdc=await this[_0xfc76a(0xbf)][_0xfc76a(0xe8)]({'key':redisKey_constant_1[_0xfc76a(0x196)]}),_0x1e4319=await axios_1[_0xfc76a(0x17c)][_0xfc76a(0xa4)](_0xfc76a(0xe7)+_0x5dfcdc,{'code':_0x9929f3});if(_0x1e4319['data'][_0xfc76a(0xf5)])throw new Error(_0x1e4319[_0xfc76a(0x147)]['errmsg']);return _0x1e4319[_0xfc76a(0x147)]['phone_info'][_0xfc76a(0x195)];}catch(_0x9e7231){common_1[_0xfc76a(0x101)][_0xfc76a(0xf7)](_0xfc76a(0xf1),_0x9e7231);throw new common_1['HttpException'](_0x9e7231[_0xfc76a(0x140)],common_1['HttpStatus'][_0xfc76a(0xd4)]);}}['registeInMini'](_0x237bb4){const _0x1cd8ce=_0x50ee23;if(!_0x237bb4['miniOpenId'])throw new common_1[(_0x1cd8ce(0x144))](_0x1cd8ce(0x142),common_1['HttpStatus']['BAD_REQUEST']);return this[_0x1cd8ce(0xfd)](_0x237bb4);}async['loginWithWechatApp'](_0x5b3f6b){const _0x3d75f7=_0x50ee23,_0x1a2ff3=new WeAppLogin_vo_1[(_0x3d75f7(0xcf))]();try{const _0x2f18b7=await axios_1['default']['get']('https://api.weixin.qq.com/sns/oauth2/access_token?appid='+WechatConfig_1['default'][_0x3d75f7(0x10a)]+_0x3d75f7(0x155)+WechatConfig_1['default'][_0x3d75f7(0x126)]+_0x3d75f7(0xef)+_0x5b3f6b+_0x3d75f7(0xdb));if(_0x2f18b7[_0x3d75f7(0x147)][_0x3d75f7(0xf5)])throw new Error(_0x2f18b7['data']['errmsg']);const _0x295609=_0x2f18b7[_0x3d75f7(0x147)],_0x48b9b2=await this['userEntity'][_0x3d75f7(0x156)]({'where':{'weAppOpenId':_0x295609[_0x3d75f7(0x180)]}});if(!_0x48b9b2)this[_0x3d75f7(0xbf)]['set']({'key':redisKey_constant_1['WE_APP_TEMP_USER']+_0x295609[_0x3d75f7(0x180)],'val':_0x295609[_0x3d75f7(0x129)]||null});else{const {username:_0x5826bb,id:_0x51228a,email:_0x110942,role:_0x137578,openId:_0x33d403,client:_0x26742c}=_0x48b9b2;_0x1a2ff3[_0x3d75f7(0xd2)]=this['jwtService'][_0x3d75f7(0xeb)]({'username':_0x5826bb,'id':_0x51228a,'email':_0x110942,'role':_0x137578,'openId':_0x33d403,'client':_0x26742c}),await this[_0x3d75f7(0xbf)]['saveToken'](_0x51228a,_0x1a2ff3['authToken']);}return _0x1a2ff3[_0x3d75f7(0x180)]=_0x295609[_0x3d75f7(0x180)],_0x1a2ff3[_0x3d75f7(0x12d)]=_0x295609[_0x3d75f7(0x14c)],_0x1a2ff3;}catch(_0x16e220){common_1['Logger']['error'](_0x3d75f7(0x12a),_0x16e220);throw new common_1[(_0x3d75f7(0x144))](_0x16e220[_0x3d75f7(0x140)],common_1[_0x3d75f7(0x133)]['BAD_REQUEST']);}}async['phoneWithOpenId4regist'](_0x5a80a2){const _0x161ad3=_0x50ee23;try{if(!_0x5a80a2['openId']&&!_0x5a80a2[_0x161ad3(0x14f)]&&!_0x5a80a2['weAppOpenId'])throw new Error(_0x161ad3(0x128));let _0x5d6ae7='openId',_0x3915f2={};if(_0x5a80a2[_0x161ad3(0x122)])_0x5d6ae7=_0x161ad3(0x122);else _0x5a80a2[_0x161ad3(0x14f)]?_0x5d6ae7=_0x161ad3(0x14f):_0x5d6ae7='weAppOpenId';_0x3915f2[_0x5d6ae7]=_0x5a80a2[_0x5d6ae7];const _0x31358b=await this['userEntity'][_0x161ad3(0x156)]({'where':_0x3915f2});if(_0x31358b&&_0x31358b[_0x161ad3(0x135)])return![];const _0x16d1dc=await this['userEntity'][_0x161ad3(0x156)]({'where':{'phone':_0x5a80a2[_0x161ad3(0x135)]}});if(_0x16d1dc)return!_0x16d1dc[_0x5d6ae7];return!![];}catch(_0x47005e){throw new common_1['HttpException'](_0x47005e[_0x161ad3(0x140)],common_1[_0x161ad3(0x133)]['BAD_REQUEST']);}}async['registeV3'](_0x5a04f8,_0x4eb72a){const _0x209a38=_0x50ee23;try{if(_0x5a04f8[_0x209a38(0x11e)]){if(!/^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d]+$/[_0x209a38(0x166)](_0x5a04f8[_0x209a38(0x11e)]))throw new Error(_0x209a38(0xe3));if(!_0x5a04f8[_0x209a38(0x190)])throw new Error(_0x209a38(0x18b));}else{if(!_0x5a04f8[_0x209a38(0x122)]&&!_0x5a04f8[_0x209a38(0x14f)]&&!_0x5a04f8[_0x209a38(0x18f)])throw new Error(_0x209a38(0xa5));}if(_0x5a04f8[_0x209a38(0x135)]&&!_0x5a04f8['phoneCode'])throw new Error(_0x209a38(0x18e));let _0x2fd191=null;if(_0x5a04f8[_0x209a38(0x135)])await this[_0x209a38(0x115)](_0x5a04f8[_0x209a38(0x135)],_0x5a04f8['phoneCode']),_0x2fd191=await this[_0x209a38(0x114)]['findOne']({'where':{'phone':_0x5a04f8['phone']}});else{if(_0x5a04f8[_0x209a38(0x122)]||_0x5a04f8[_0x209a38(0x14f)]||_0x5a04f8['weAppOpenId']){let _0x36502e='openId',_0x96ad40={};if(_0x5a04f8['openId'])_0x36502e=_0x209a38(0x122);else _0x5a04f8[_0x209a38(0x14f)]?_0x36502e='miniOpenId':_0x36502e=_0x209a38(0x18f);_0x96ad40[_0x36502e]=_0x5a04f8[_0x36502e],_0x2fd191=await this[_0x209a38(0x114)]['findOne']({'where':_0x96ad40});if(_0x2fd191)throw new Error(_0x209a38(0xd3));}else{_0x2fd191=await this['userEntity'][_0x209a38(0x156)]({'where':{'username':_0x5a04f8[_0x209a38(0x11e)]}});if(_0x2fd191)throw new Error(_0x209a38(0xd3));}}const _0x43aed5=new user_entity_1['UserEntity']();for(let _0x5608b2 in _0x5a04f8){_0x5a04f8[_0x5608b2]&&(_0x43aed5[_0x5608b2]=_0x5a04f8[_0x5608b2]);}_0x2fd191?_0x43aed5['id']=_0x2fd191['id']:(_0x43aed5[_0x209a38(0x190)]&&(_0x43aed5['password']=bcrypt['hashSync'](_0x5a04f8['password'],0xa)),_0x43aed5[_0x209a38(0xc6)]=user_constant_1[_0x209a38(0xf4)][_0x209a38(0xdf)],!_0x43aed5['nickname']&&(_0x43aed5['nickname']=_0x43aed5[_0x209a38(0x15a)]||'小智'),!_0x43aed5['avatar']&&(_0x43aed5[_0x209a38(0xbd)]=await this[_0x209a38(0x10d)][_0x209a38(0xdd)](['userDefautlAvatar'])));const _0x4e1ebb=await this[_0x209a38(0x124)][_0x209a38(0xfd)](_0x43aed5);!_0x2fd191&&this[_0x209a38(0x159)](_0x4e1ebb['id'],_0x5a04f8[_0x209a38(0x179)]);const _0x29a6a0=(0x0,utils_1[_0x209a38(0x169)])(_0x4eb72a);await this['userService'][_0x209a38(0xcc)](_0x4e1ebb['id'],_0x29a6a0);const {id:_0x376a15,role:_0x12d20e,email:_0x30e072,client:_0x498104,openId:_0x474211,username:_0x55ae1a}=_0x4e1ebb,_0x36e968=this[_0x209a38(0x113)]['sign']({'id':_0x376a15,'role':_0x12d20e,'email':_0x30e072,'client':_0x498104,'openId':_0x474211,'username':_0x55ae1a});return await this[_0x209a38(0xbf)]['saveToken'](_0x376a15,_0x36e968),_0x36e968;}catch(_0x3189aa){if(_0x3189aa instanceof common_1['HttpException'])throw _0x3189aa;else throw new common_1[(_0x209a38(0x144))](_0x3189aa[_0x209a38(0x140)],common_1[_0x209a38(0x133)][_0x209a38(0xd4)]);}}async[_0x50ee23(0x149)](_0x71b7ae){const _0x237885=_0x50ee23,_0x2481a9=await this[_0x237885(0x114)][_0x237885(0x199)]({'where':{'phone':_0x71b7ae}});return _0x2481a9>0x0;}async[_0x50ee23(0xfb)](_0xcb6363){const _0x6af0a4=_0x50ee23;return await this[_0x6af0a4(0x115)](_0xcb6363[_0x6af0a4(0x135)],_0xcb6363[_0x6af0a4(0xd0)]),await this['userEntity'][_0x6af0a4(0x198)]({'id':_0xcb6363[_0x6af0a4(0xa6)],'phone':_0xcb6363[_0x6af0a4(0x135)]}),!![];}};AuthService=__decorate([(0x0,common_1[_0x50ee23(0x17f)])(),__param(0x0,(0x0,typeorm_2[_0x50ee23(0x121)])(user_entity_1[_0x50ee23(0x13e)])),__param(0x1,(0x0,typeorm_2[_0x50ee23(0x121)])(config_entity_1['ConfigEntity'])),__metadata(_0x50ee23(0x18a),[typeorm_1[_0x50ee23(0xee)],typeorm_1['Repository'],user_service_1['UserService'],jwt_1['JwtService'],mailer_service_1[_0x50ee23(0x116)],verification_service_1[_0x50ee23(0x12b)],userBalance_service_1['UserBalanceService'],redisCache_service_1[_0x50ee23(0x138)],globalConfig_service_1[_0x50ee23(0x18c)],access_service_1['AccessService']])],AuthService),exports[_0x50ee23(0xa2)]=AuthService;