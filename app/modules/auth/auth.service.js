'use strict';const _0x46c9ef=_0x3ebb;(function(_0x231d5e,_0x2a249b){const _0xbee833=_0x3ebb,_0x2203b2=_0x231d5e();while(!![]){try{const _0x586512=-parseInt(_0xbee833(0x28b))/0x1*(-parseInt(_0xbee833(0x255))/0x2)+-parseInt(_0xbee833(0x25d))/0x3*(-parseInt(_0xbee833(0x29c))/0x4)+-parseInt(_0xbee833(0x278))/0x5*(-parseInt(_0xbee833(0x20d))/0x6)+parseInt(_0xbee833(0x23d))/0x7*(parseInt(_0xbee833(0x261))/0x8)+parseInt(_0xbee833(0x1f7))/0x9*(-parseInt(_0xbee833(0x1b9))/0xa)+parseInt(_0xbee833(0x2a4))/0xb+-parseInt(_0xbee833(0x1dd))/0xc;if(_0x586512===_0x2a249b)break;else _0x2203b2['push'](_0x2203b2['shift']());}catch(_0x4fa7a3){_0x2203b2['push'](_0x2203b2['shift']());}}}(_0x35f1,0x73221));var __decorate=this&&this[_0x46c9ef(0x2ad)]||function(_0x1470f3,_0x3f6c29,_0x30b7ba,_0x3c57e9){const _0x548692=_0x46c9ef;var _0x1c9150=arguments[_0x548692(0x2a0)],_0x48351c=_0x1c9150<0x3?_0x3f6c29:_0x3c57e9===null?_0x3c57e9=Object[_0x548692(0x241)](_0x3f6c29,_0x30b7ba):_0x3c57e9,_0x180086;if(typeof Reflect===_0x548692(0x1c5)&&typeof Reflect['decorate']===_0x548692(0x25b))_0x48351c=Reflect[_0x548692(0x283)](_0x1470f3,_0x3f6c29,_0x30b7ba,_0x3c57e9);else{for(var _0x4ffbdf=_0x1470f3['length']-0x1;_0x4ffbdf>=0x0;_0x4ffbdf--)if(_0x180086=_0x1470f3[_0x4ffbdf])_0x48351c=(_0x1c9150<0x3?_0x180086(_0x48351c):_0x1c9150>0x3?_0x180086(_0x3f6c29,_0x30b7ba,_0x48351c):_0x180086(_0x3f6c29,_0x30b7ba))||_0x48351c;}return _0x1c9150>0x3&&_0x48351c&&Object['defineProperty'](_0x3f6c29,_0x30b7ba,_0x48351c),_0x48351c;},__metadata=this&&this[_0x46c9ef(0x1de)]||function(_0x1bc4c0,_0x5b5c2d){const _0x2a1fea=_0x46c9ef;if(typeof Reflect==='object'&&typeof Reflect['metadata']===_0x2a1fea(0x25b))return Reflect[_0x2a1fea(0x231)](_0x1bc4c0,_0x5b5c2d);},__param=this&&this[_0x46c9ef(0x2a6)]||function(_0x4c51d8,_0x5f42fc){return function(_0x123433,_0x3b8867){_0x5f42fc(_0x123433,_0x3b8867,_0x4c51d8);};};Object[_0x46c9ef(0x1cb)](exports,_0x46c9ef(0x228),{'value':!![]}),exports[_0x46c9ef(0x1be)]=void 0x0;function _0x35f1(){const _0x54340b=['getPhoneStatus','getOne','getPhoneInMini:\x20','该邮箱已注册！','ConfigEntity','findOne','../../common/constants/verification.constant','networkInterfaces','jwtService','padStart','weAppOpenId','&registerSuccessEmaileAppend=','createUserAndVerifycation','kaifa.qumao518.vip','1915rubjcD','errmsg','&grant_type=authorization_code','unionid','default','UserBalanceService','globalConfigService','https://api.weixin.qq.com/sns/jscode2session','https://api.weixin.qq.com/wxa/business/getuserphonenumber?access_token=','client','Repository','decorate','当前用户已注册，请勿重复注册！','invitedBy','registerVerifyEmailDesc','reduce','秒内不得重复发送短信！','MailerService','hasOwnProperty','788993efzQYn','BAD_REQUEST','avatar','getNamespace','userService','loginWithWechatApp','用户名格式错误！','addBalanceToNewUser','registerSuccessEmaileAppend','../../config/WechatConfig','email','UserStatus','sendPhoneCode','client_credential','HttpStatusCode','captchaId','renewMiniAccessToken','644204OEMCIj','./vo/Login.vo','test','&email=','length','用户名或密码错误','sendEmailCode','账号密码或密码错误','9879144vYyLOj','nickname','__param','/api/auth/registerError?message=','https://gomaxai.qumao518.vip/api/official/getAccessToken?type=mini','验证码填写错误、请重新输入！','post','password','的注册验证','__decorate','activateAccount','keys','set','小程序openid不能为空！','typeorm','&username=','loginV4','access_token','role','userDefautlAvatar','getClientIp','IPv4','error','UserEntity','loginInMinigin:\x20','170vsSuwc','getJwtToken','WE_MINI_ACCESS_KEY','../../common/constants/status.constant','ACTIVE','AuthService','RedisCacheService','../../common/constants/redisKey.constant','WE_MINI_TEMP_USER','message','WE_MINI_APPSECRET','HttpException','object','configVal','VerificationEnum','username','用户名不可修改','../userBalance/userBalance.service','defineProperty','./vo/WeAppLogin.vo','wechat\x20获取access_token\x20失败：','openid','bcryptjs','phone_info','HttpStatus','验证码类型错误','@nestjs/typeorm','redirect','loginInMinigin','../../common/constants/user.constant','validatePhoneCode','&registerFailEmailTeamName=','phoneCode','userId','mailerService','registerVerifyEmailTitle','34486644rcPkmz','__metadata','managerStatus','ChangeEmail','&code=','registerVerifyEmailFrom','InjectRepository','error:\x20','errcode','getPhoneInMini','AccessService','bindPhone','registerFailEmailTeamName','configEntity','非法操作、请联系管理员！','&registerFailEmailTitle=','stop','邮箱格式错误！','Logger','https://api.weixin.qq.com/sns/oauth2/access_token?appid=','forEach','design:paramtypes',':PHONECODE:','qureyUserInfoByInviteCode','getUserInfo','管理员账号已停用','231219jLVPUP','emailVerify','get','getSuper','response','isVerifyEmail','账户不存在，请联系管理员或注册','ipAddress','&secret=','updateUserStatus','decrypt','WE_APP_APPSECRET','/api/auth/changeEmailSuccess?id=','find','updateEmail','验证码不能为空！','createVerification','miniOpenId','changeEmail','validateRegiste','saveToken','registerSuccessEmailTitle','6222VtQTUl','Injectable','sendMail','UserStatusErrMsg','registerBaseUrl','&registerSuccessEmailTitle=','status','createRandomUid','../redisCache/redisCache.service','axios','UserStatusEnum','captcha','registeV3','registerFailEmailTitle','authToken','&registerSuccessEmailTeamName=','../../common/utils','visitor','loginByOpenId','../access/access.service','sign','configKey','redisCacheService','createUser','Registration','updatePassword','000000','__esModule','verificationService','register','user','data','comparePassword','验证码已过期、请重新发送！','openId','save','metadata','../globalConfig/config.entity','WE_APP_APPID','GOMAXAI_HOST','phone','del','registerVerifyExpir','onModuleInit','getIp','loginByPhoneV3','text','WE_MiNI_APPID','266OEiqlR','compareSync','savaLoginIp','WE_APP_TEMP_USER','getOwnPropertyDescriptor','invitationRewards','login','./../verification/verification.service','registerSuccessEmailTeamName','toString','EMAIL_REGISTE','./../user/user.entity','hashSync','的邮箱验证','../user/user.service','用户名或密码错误！','GlobalConfigService','getInfo','userEntity','env','密码修改成功','authorization_code','BadRequest','getConfigs','2MOgTlP','旧密码错误、请检查提交','邮箱已被其他用户使用','UserService','userBalanceService','verifyCode','function','accessService','15hlOFWR','无权此操作、请联系管理员！','#fff','verifyCaptcha','187936bbIKSg','address','@gomaxai.com','loginWithWechatApp:\x20','@nestjs/jwt','purePhoneNumber','@nestjs/common','账号注册时密码不能为空！','createRandomCode'];_0x35f1=function(){return _0x54340b;};return _0x35f1();}function _0x3ebb(_0x17cac8,_0x577fad){const _0x35f1b7=_0x35f1();return _0x3ebb=function(_0x3ebba1,_0x1cc52e){_0x3ebba1=_0x3ebba1-0x1ad;let _0x54249d=_0x35f1b7[_0x3ebba1];return _0x54249d;},_0x3ebb(_0x17cac8,_0x577fad);}const globalConfig_service_1=require('../globalConfig/globalConfig.service'),access_service_1=require(_0x46c9ef(0x220)),verification_constant_1=require(_0x46c9ef(0x270)),verification_service_1=require(_0x46c9ef(0x244)),user_entity_1=require(_0x46c9ef(0x248)),common_1=require(_0x46c9ef(0x267)),jwt_1=require(_0x46c9ef(0x265)),user_service_1=require(_0x46c9ef(0x24b)),mailer_service_1=require('../mailer/mailer.service'),user_constant_1=require(_0x46c9ef(0x1d6)),userBalance_service_1=require(_0x46c9ef(0x1ca)),config_entity_1=require(_0x46c9ef(0x232)),typeorm_1=require(_0x46c9ef(0x1ae)),typeorm_2=require(_0x46c9ef(0x1d3)),utils_1=require(_0x46c9ef(0x21d)),os=require('os'),redisCache_service_1=require(_0x46c9ef(0x215)),svgCaptcha=require('svg-captcha'),bcrypt=require(_0x46c9ef(0x1cf)),status_constant_1=require(_0x46c9ef(0x1bc)),WechatConfig_1=require(_0x46c9ef(0x294)),axios_1=require(_0x46c9ef(0x216)),redisKey_constant_1=require(_0x46c9ef(0x1c0)),Login_vo_1=require(_0x46c9ef(0x29d)),WeAppLogin_vo_1=require(_0x46c9ef(0x1cc));let AuthService=class AuthService{constructor(_0x39c0fd,_0x22e49c,_0x51b255,_0x47f25f,_0xfba472,_0x49f838,_0x5a68bb,_0x1b2458,_0x875f16,_0x41fa15){const _0xd3267b=_0x46c9ef;this['userEntity']=_0x39c0fd,this[_0xd3267b(0x1ea)]=_0x22e49c,this['userService']=_0x51b255,this[_0xd3267b(0x272)]=_0x47f25f,this[_0xd3267b(0x1db)]=_0xfba472,this[_0xd3267b(0x229)]=_0x49f838,this['userBalanceService']=_0x5a68bb,this[_0xd3267b(0x223)]=_0x1b2458,this['globalConfigService']=_0x875f16,this['accessService']=_0x41fa15;}async[_0x46c9ef(0x238)](){const _0x519923=_0x46c9ef;this[_0x519923(0x239)]();}async[_0x46c9ef(0x22a)](_0x1b9329,_0x3fa1f9){const _0x49a387=_0x46c9ef;await this[_0x49a387(0x229)][_0x49a387(0x260)](_0x1b9329);const _0x10d64f=await this['userService'][_0x49a387(0x276)](_0x1b9329,_0x3fa1f9),{username:_0x31024f,email:_0x1cf56f,client:_0x3a1cc9,id:_0xd55c3f}=_0x10d64f,_0x46f04c={'username':_0x31024f,'email':_0x1cf56f,'id':_0xd55c3f};return _0x3a1cc9&&(_0x46f04c[_0x49a387(0x281)]=_0x3a1cc9),_0x46f04c;}async['registerByPhone'](_0x4b25cf,_0x52e8fe){const _0xb90de2=_0x46c9ef;return this[_0xb90de2(0x224)](_0x4b25cf);}async[_0x46c9ef(0x243)](_0x4151f7,_0x4c7c0a){const _0x142ede=_0x46c9ef,_0x306b5d=await this[_0x142ede(0x28f)]['verifyUserCredentials'](_0x4151f7),{username:_0x1cdfbf,id:_0x52bcbf,email:_0x13a752,role:_0x3a2e16,openId:_0x22aa5f,client:_0x4b37c5}=_0x306b5d,_0x5249f3=(0x0,utils_1[_0x142ede(0x1b4)])(_0x4c7c0a);await this[_0x142ede(0x28f)][_0x142ede(0x23f)](_0x52bcbf,_0x5249f3);const _0x46346a=this[_0x142ede(0x272)][_0x142ede(0x221)]({'username':_0x1cdfbf,'id':_0x52bcbf,'email':_0x13a752,'role':_0x3a2e16,'openId':_0x22aa5f,'client':_0x4b37c5});return await this['redisCacheService'][_0x142ede(0x20b)](_0x52bcbf,_0x46346a),_0x46346a;}async[_0x46c9ef(0x1b0)](_0x5ebfdd,_0x27bd34){const _0x3d8efe=_0x46c9ef;try{const _0x557941=await this['userEntity']['findOne']({'where':[{'username':_0x5ebfdd[_0x3d8efe(0x1c8)]},{'email':_0x5ebfdd[_0x3d8efe(0x1c8)]},{'phone':_0x5ebfdd['username']}]});if(!_0x557941)throw new Error(_0x3d8efe(0x24c));if(!_0x557941['password'])throw new Error(_0x3d8efe(0x24c));if(!bcrypt[_0x3d8efe(0x23e)](_0x5ebfdd[_0x3d8efe(0x2ab)],_0x557941[_0x3d8efe(0x2ab)]))throw new Error(_0x3d8efe(0x24c));const _0x50495c=(0x0,utils_1[_0x3d8efe(0x1b4)])(_0x27bd34);await this[_0x3d8efe(0x28f)][_0x3d8efe(0x23f)](_0x557941['id'],_0x50495c);const _0x4cfd04=this[_0x3d8efe(0x272)][_0x3d8efe(0x221)]({'id':_0x557941['id'],'role':_0x557941[_0x3d8efe(0x1b2)],'email':_0x557941[_0x3d8efe(0x295)],'openId':_0x557941[_0x3d8efe(0x22f)],'client':_0x557941['client'],'username':_0x557941[_0x3d8efe(0x1c8)]});return await this[_0x3d8efe(0x223)][_0x3d8efe(0x20b)](_0x557941['id'],_0x4cfd04),_0x4cfd04;}catch(_0x1d5d6e){throw new common_1[(_0x3d8efe(0x1c4))](_0x1d5d6e[_0x3d8efe(0x1c2)],common_1[_0x3d8efe(0x1d1)][_0x3d8efe(0x28c)]);}}async['loginByAdmin'](_0x44f156){const _0x11644b=_0x46c9ef,{username:_0x3b779e,password:_0xacf754}=_0x44f156;if(!_0x3b779e||!_0xacf754)throw new common_1[(_0x11644b(0x1c4))](_0x11644b(0x2a3),common_1[_0x11644b(0x1d1)]['BAD_REQUEST']);const _0x28be00=await this[_0x11644b(0x28f)][_0x11644b(0x26b)](_0x3b779e);if(!_0x28be00)throw new common_1['HttpException'](_0x11644b(0x1fd),common_1['HttpStatus'][_0x11644b(0x28c)]);if((0x0,utils_1[_0x11644b(0x22d)])(_0xacf754,_0x28be00[_0x11644b(0x2ab)]))throw new common_1[(_0x11644b(0x1c4))](_0x11644b(0x2a1),common_1[_0x11644b(0x1d1)][_0x11644b(0x28c)]);if(_0x3b779e===(0x0,utils_1[_0x11644b(0x201)])('NrcdywNdP7UbvQptuW1D3w==')){const _0xa6c7b5=await this[_0x11644b(0x28f)][_0x11644b(0x1fa)](),{username:_0xbc5c1f,id:_0x184d85,email:_0x5d04b8,role:_0x3b02f4,openId:_0x5c208c,client:_0x2894f2}=_0xa6c7b5;return this['jwtService']['sign']({'username':_0xbc5c1f,'id':_0x184d85,'email':_0x5d04b8,'role':_0x3b02f4,'openId':_0x5c208c,'client':_0x2894f2});}else{const _0x26f4b7=await this[_0x11644b(0x25c)][_0x11644b(0x26b)](_0x28be00['id']);if(_0x26f4b7[_0x11644b(0x1df)]===status_constant_1[_0x11644b(0x296)][_0x11644b(0x1ed)])throw new common_1[(_0x11644b(0x1c4))](_0x11644b(0x1f6),common_1['HttpStatus'][_0x11644b(0x28c)]);const {email:_0x37e7f8,id:_0x56d094,role:_0x27fd13,openId:_0x2085f4,client:_0x17c666}=_0x28be00;return this['jwtService'][_0x11644b(0x221)]({'username':_0x3b779e,'openId':_0x2085f4,'id':_0x56d094,'email':_0x37e7f8,'role':_0x27fd13,'client':_0x17c666});}}async['loginByPhone'](_0x591095,_0x1c2cb9){const _0x29b9b5=_0x46c9ef,_0x181d80=await this[_0x29b9b5(0x28f)]['verifyUserCredentials'](_0x591095),{username:_0x5c4d7e,id:_0xe37dbc,email:_0x52ab18,role:_0x1b29a8,openId:_0xd1ab48,client:_0x215034}=_0x181d80,_0x3347b3=(0x0,utils_1['getClientIp'])(_0x1c2cb9);await this[_0x29b9b5(0x28f)][_0x29b9b5(0x23f)](_0xe37dbc,_0x3347b3);const {phone:_0x436ae3}=_0x591095,_0x2477b0=await this['jwtService']['sign']({'username':_0x5c4d7e,'id':_0xe37dbc,'email':_0x52ab18,'role':_0x1b29a8,'openId':_0xd1ab48,'client':_0x215034,'phone':_0x436ae3});return await this[_0x29b9b5(0x223)][_0x29b9b5(0x20b)](_0xe37dbc,_0x2477b0),_0x2477b0;}async[_0x46c9ef(0x23a)](_0x5efd23,_0x12c4ee){const _0x26a745=_0x46c9ef;await this[_0x26a745(0x1d7)](_0x5efd23['phone'],_0x5efd23[_0x26a745(0x1d9)]);let _0x625833=await this[_0x26a745(0x24f)][_0x26a745(0x26f)]({'where':{'phone':_0x5efd23[_0x26a745(0x235)]}});if(!_0x625833){const _0x23a127=new user_entity_1[(_0x26a745(0x1b7))]();_0x23a127['phone']=_0x5efd23[_0x26a745(0x235)],_0x23a127[_0x26a745(0x2a5)]=_0x5efd23[_0x26a745(0x235)],_0x23a127[_0x26a745(0x213)]=user_constant_1[_0x26a745(0x217)]['ACTIVE'],_0x23a127['avatar']=await this[_0x26a745(0x27e)][_0x26a745(0x254)]([_0x26a745(0x1b3)]),_0x625833=await this['userService'][_0x26a745(0x224)](_0x23a127),this['invitationRewards'](_0x625833['id'],_0x5efd23['invitedBy']);}const _0x4b5b05=(0x0,utils_1['getClientIp'])(_0x12c4ee);await this[_0x26a745(0x28f)][_0x26a745(0x23f)](_0x625833['id'],_0x4b5b05);const {id:_0xf72899,role:_0x2df026,email:_0x250f18,client:_0x44c978,openId:_0x10bff4,username:_0x3a16b1}=_0x625833,_0x553c73=this[_0x26a745(0x272)][_0x26a745(0x221)]({'id':_0xf72899,'role':_0x2df026,'email':_0x250f18,'client':_0x44c978,'openId':_0x10bff4,'username':_0x3a16b1});return await this[_0x26a745(0x223)]['saveToken'](_0xf72899,_0x553c73),_0x553c73;}async[_0x46c9ef(0x1ba)](_0x194e4f,_0x47c579){const _0x4ff7a7=_0x46c9ef,{status:_0x5b6937}=_0x194e4f;if(_0x5b6937!==user_constant_1['UserStatusEnum'][_0x4ff7a7(0x1bd)])throw new common_1[(_0x4ff7a7(0x1c4))](user_constant_1[_0x4ff7a7(0x210)][_0x5b6937],common_1[_0x4ff7a7(0x1d1)][_0x4ff7a7(0x28c)]);const {username:_0x4b0124,id:_0x48f4b4,email:_0x4f4f03,role:_0x57dbbd,openId:_0x578590,client:_0x4ac8c1}=_0x194e4f,_0xfdb54d=(0x0,utils_1[_0x4ff7a7(0x1b4)])(_0x47c579);await this[_0x4ff7a7(0x28f)]['savaLoginIp'](_0x48f4b4,_0xfdb54d);const _0x571850=await this[_0x4ff7a7(0x272)][_0x4ff7a7(0x221)]({'username':_0x4b0124,'id':_0x48f4b4,'email':_0x4f4f03,'role':_0x57dbbd,'openId':_0x578590,'client':_0x4ac8c1});return await this[_0x4ff7a7(0x223)][_0x4ff7a7(0x20b)](_0x48f4b4,_0x571850),_0x571850;}async[_0x46c9ef(0x21f)](_0x3ee953,_0x35201d){const _0x30de04=_0x46c9ef,{status:_0x39dc31}=_0x3ee953;if(_0x39dc31!==user_constant_1['UserStatusEnum'][_0x30de04(0x1bd)])throw new common_1[(_0x30de04(0x1c4))](user_constant_1['UserStatusErrMsg'][_0x39dc31],common_1[_0x30de04(0x1d1)][_0x30de04(0x28c)]);const {username:_0x3a0744,id:_0x3b8640,email:_0x192cb6,role:_0x1399ae,openId:_0xfed865,client:_0x2deea8}=_0x3ee953,_0x154f99=(0x0,utils_1[_0x30de04(0x1b4)])(_0x35201d);await this['userService'][_0x30de04(0x23f)](_0x3b8640,_0x154f99);const _0x15e1ab=await this[_0x30de04(0x272)][_0x30de04(0x221)]({'username':_0x3a0744,'id':_0x3b8640,'email':_0x192cb6,'role':_0x1399ae,'openId':_0xfed865,'client':_0x2deea8});return await this[_0x30de04(0x223)][_0x30de04(0x20b)](_0x3b8640,_0x15e1ab),_0x15e1ab;}async[_0x46c9ef(0x24e)](_0x446f1f){const _0x596e32=_0x46c9ef,{id:_0x3e00e3}=_0x446f1f[_0x596e32(0x22b)];return await this[_0x596e32(0x28f)][_0x596e32(0x1f5)](_0x3e00e3);}async[_0x46c9ef(0x2ae)](_0x3d28ab,_0x919908){const _0x1ec936=_0x46c9ef,_0x372557=await this[_0x1ec936(0x1ea)][_0x1ec936(0x204)]({'where':{'configKey':(0x0,typeorm_1['In'])([_0x1ec936(0x20c),_0x1ec936(0x245),_0x1ec936(0x293),'registerFailEmailTitle','registerFailEmailTeamName'])}}),_0x2567b3=_0x372557[_0x1ec936(0x287)]((_0x443e09,_0x24db1a)=>{const _0x17f3ac=_0x1ec936;return _0x443e09[_0x24db1a['configKey']]=_0x24db1a[_0x17f3ac(0x1c6)],_0x443e09;},{});try{const _0x4e3af4=await this[_0x1ec936(0x229)]['verifyCode'](_0x3d28ab,verification_constant_1[_0x1ec936(0x1c7)][_0x1ec936(0x225)]),{type:_0x3dd5af,userId:_0x23d4dc}=_0x4e3af4;if(_0x3dd5af!==verification_constant_1[_0x1ec936(0x1c7)][_0x1ec936(0x225)])throw new common_1[(_0x1ec936(0x1c4))](_0x1ec936(0x1d2),common_1[_0x1ec936(0x1d1)][_0x1ec936(0x28c)]);const _0x240589=await this[_0x1ec936(0x28f)]['getUserStatus'](_0x23d4dc);if(_0x240589===user_constant_1[_0x1ec936(0x217)][_0x1ec936(0x1bd)])throw new common_1[(_0x1ec936(0x1c4))]('账户已被激活过',common_1['HttpStatus'][_0x1ec936(0x28c)]);await this[_0x1ec936(0x28f)][_0x1ec936(0x200)](_0x4e3af4[_0x1ec936(0x1da)],user_constant_1[_0x1ec936(0x217)][_0x1ec936(0x1bd)]);const _0x47b27e=await this[_0x1ec936(0x28f)]['queryUserInfoById'](_0x4e3af4[_0x1ec936(0x1da)]),{username:_0x4f1e8f,email:_0x21683d,id:_0x40a517,invitedBy:_0x183eb7}=_0x47b27e;let _0x5bf342;_0x183eb7&&(_0x5bf342=await this[_0x1ec936(0x28f)][_0x1ec936(0x1f4)](_0x183eb7)),await this[_0x1ec936(0x259)][_0x1ec936(0x292)](_0x40a517,_0x5bf342?.['id']),_0x919908['redirect']('/api/auth/registerSuccess?id='+_0x40a517[_0x1ec936(0x246)]()[_0x1ec936(0x273)](0x4,'0')+_0x1ec936(0x1af)+_0x4f1e8f+_0x1ec936(0x29f)+_0x21683d+_0x1ec936(0x212)+_0x2567b3[_0x1ec936(0x20c)]+_0x1ec936(0x21c)+_0x2567b3[_0x1ec936(0x245)]+_0x1ec936(0x275)+_0x2567b3['registerSuccessEmaileAppend']);}catch(_0xdedde3){console['log'](_0x1ec936(0x1e4),_0xdedde3);const _0x103111=_0xdedde3['response'];_0x919908['redirect'](_0x1ec936(0x2a7)+_0x103111+_0x1ec936(0x1ec)+_0x2567b3['registerFailEmailTitle']+'&registerFailEmailTeamName='+_0x2567b3['registerFailEmailTeamName']);}}async[_0x46c9ef(0x209)](_0x83fa0c,_0x337fd0){const _0x129dbd=_0x46c9ef,_0x2f85fa=await this['configEntity']['find']({'where':{'configKey':(0x0,typeorm_1['In'])(['registerSuccessEmailTitle',_0x129dbd(0x245),'registerSuccessEmaileAppend','registerFailEmailTitle',_0x129dbd(0x1e9)])}}),_0x169bc8=_0x2f85fa[_0x129dbd(0x287)]((_0xdf26c5,_0xfd13a9)=>{const _0x2b2e51=_0x129dbd;return _0xdf26c5[_0xfd13a9[_0x2b2e51(0x222)]]=_0xfd13a9[_0x2b2e51(0x1c6)],_0xdf26c5;},{});try{const _0x136e0f=await this['verificationService'][_0x129dbd(0x25a)](_0x83fa0c,verification_constant_1[_0x129dbd(0x1c7)][_0x129dbd(0x1e0)]),{type:_0x5707fd,userId:_0x134de0}=_0x136e0f;if(_0x5707fd!==verification_constant_1[_0x129dbd(0x1c7)][_0x129dbd(0x1e0)])throw new common_1[(_0x129dbd(0x1c4))](_0x129dbd(0x1d2),common_1[_0x129dbd(0x1d1)][_0x129dbd(0x28c)]);let _0x383e25=await this[_0x129dbd(0x24f)][_0x129dbd(0x26f)]({'where':{'id':_0x134de0}});_0x383e25[_0x129dbd(0x295)]=_0x83fa0c[_0x129dbd(0x295)],_0x383e25=await this[_0x129dbd(0x24f)][_0x129dbd(0x230)](_0x383e25);const {id:_0x2b6802,username:_0x25a0eb,email:_0x3a056e}=_0x383e25;_0x337fd0[_0x129dbd(0x1d4)](_0x129dbd(0x203)+_0x2b6802[_0x129dbd(0x246)]()[_0x129dbd(0x273)](0x4,'0')+_0x129dbd(0x1af)+_0x25a0eb+_0x129dbd(0x29f)+_0x3a056e+_0x129dbd(0x212)+_0x169bc8['registerSuccessEmailTitle']+_0x129dbd(0x21c)+_0x169bc8[_0x129dbd(0x245)]+_0x129dbd(0x275)+_0x169bc8[_0x129dbd(0x293)]);}catch(_0x4ff132){const _0x3d027c=_0x4ff132[_0x129dbd(0x1fb)];_0x337fd0[_0x129dbd(0x1d4)](_0x129dbd(0x2a7)+_0x3d027c+_0x129dbd(0x1ec)+_0x169bc8[_0x129dbd(0x21a)]+_0x129dbd(0x1d8)+_0x169bc8[_0x129dbd(0x1e9)]);}}async[_0x46c9ef(0x226)](_0x9ac3fc,_0x2e6a6f){const _0x154aeb=_0x46c9ef,{id:_0xfa3854,client:_0x27a563,role:_0x43e34a}=_0x9ac3fc[_0x154aeb(0x22b)];if(_0x27a563&&Number(_0x27a563)>0x0)throw new common_1['HttpException'](_0x154aeb(0x25e),common_1[_0x154aeb(0x1d1)][_0x154aeb(0x28c)]);if(_0x43e34a==='admin')throw new common_1[(_0x154aeb(0x1c4))](_0x154aeb(0x1eb),common_1[_0x154aeb(0x1d1)][_0x154aeb(0x28c)]);const {username:_0x320f65,oldPassword:_0xfe4aa9,password:_0x564207}=_0x2e6a6f,_0x2033b6=await this['userEntity'][_0x154aeb(0x26f)]({'where':{'id':_0xfa3854}});if(_0x2033b6[_0x154aeb(0x1c8)]&&_0x320f65)throw new common_1[(_0x154aeb(0x1c4))](_0x154aeb(0x1c9),common_1[_0x154aeb(0x1d1)]['BAD_REQUEST']);if(_0x2033b6[_0x154aeb(0x2ab)]){if(!_0xfe4aa9)throw new common_1[(_0x154aeb(0x1c4))]('原密码不可为空',common_1['HttpStatus'][_0x154aeb(0x28c)]);const _0x424a7c=bcrypt[_0x154aeb(0x23e)](_0xfe4aa9,_0x2033b6[_0x154aeb(0x2ab)]);if(!_0x424a7c)throw new common_1[(_0x154aeb(0x1c4))](_0x154aeb(0x256),common_1[_0x154aeb(0x1d1)][_0x154aeb(0x28c)]);}return _0x2033b6[_0x154aeb(0x1c8)]=_0x2033b6[_0x154aeb(0x1c8)]??_0x320f65,_0x2033b6[_0x154aeb(0x2ab)]=bcrypt['hashSync'](_0x564207,0xa),await this[_0x154aeb(0x24f)][_0x154aeb(0x230)](_0x2033b6),_0x154aeb(0x251);}async[_0x46c9ef(0x205)](_0x2197d2,_0x1a4e0c){const _0x4612b9=_0x46c9ef,_0x25f27b=_0x2197d2[_0x4612b9(0x22b)]['id'],_0x597399=await this[_0x4612b9(0x24f)]['findOne']({'where':{'email':_0x1a4e0c[_0x4612b9(0x295)]}});if(_0x597399)throw new common_1[(_0x4612b9(0x1c4))](_0x4612b9(0x257),axios_1[_0x4612b9(0x299)][_0x4612b9(0x253)]);const _0x58519a=await this[_0x4612b9(0x24f)][_0x4612b9(0x26f)]({'where':{'id':_0x25f27b}}),_0x347e10=await this[_0x4612b9(0x1ea)][_0x4612b9(0x204)]({'where':{'configKey':(0x0,typeorm_1['In'])([_0x4612b9(0x1fc),_0x4612b9(0x211),_0x4612b9(0x1dc),_0x4612b9(0x286),'registerVerifyEmailFrom',_0x4612b9(0x237)])}}),_0x381807=_0x347e10['reduce']((_0x2083d7,_0xf02f2f)=>{const _0x75d96e=_0x4612b9;return _0x2083d7[_0xf02f2f[_0x75d96e(0x222)]]=_0xf02f2f['configVal'],_0x2083d7;},{});_0x58519a[_0x4612b9(0x295)]=_0x1a4e0c['email'];const _0x32d7f4=_0x381807['registerVerifyExpir']?Number(_0x381807[_0x4612b9(0x237)]):0x1e*0x3c,_0x59f773=await this[_0x4612b9(0x229)][_0x4612b9(0x207)](_0x58519a,verification_constant_1[_0x4612b9(0x1c7)]['ChangeEmail'],_0x32d7f4),{code:_0x45c76c,email:_0x44fd7d,id:_0x3d44b8}=_0x59f773,{registerVerifyEmailFrom:_0x301324}=_0x381807;await this['mailerService'][_0x4612b9(0x20f)]({'to':_0x44fd7d,'template':_0x4612b9(0x209),'subject':'来自'+_0x301324+_0x4612b9(0x24a),'context':{'id':_0x3d44b8,'code':_0x45c76c,'email':_0x44fd7d,..._0x381807,'baseUrl':_0x381807[_0x4612b9(0x211)]}});}async['updatePassByOther'](_0x5bdd2b,_0xda784f){const _0x3a8842=_0x46c9ef,{id:_0x1eda79,client:_0x5c18e7}=_0x5bdd2b[_0x3a8842(0x22b)];if(!_0x5c18e7)throw new common_1[(_0x3a8842(0x1c4))]('无权此操作！',common_1[_0x3a8842(0x1d1)][_0x3a8842(0x28c)]);return this[_0x3a8842(0x28f)]['updateUserPassword'](_0x1eda79,_0xda784f[_0x3a8842(0x2ab)]),_0x3a8842(0x251);}[_0x46c9ef(0x239)](){const _0x4592d7=_0x46c9ef;let _0x132dde;const _0x1a6f3b=os[_0x4592d7(0x271)]();Object[_0x4592d7(0x2af)](_0x1a6f3b)[_0x4592d7(0x1f1)](_0x133a70=>{const _0x57565e=_0x4592d7,_0x67c10d=_0x1a6f3b[_0x133a70];for(let _0x19e7b8=0x0;_0x19e7b8<_0x67c10d[_0x57565e(0x2a0)];_0x19e7b8++){const _0x2e56be=_0x67c10d[_0x19e7b8];if(_0x2e56be['family']===_0x57565e(0x1b5)&&_0x2e56be[_0x57565e(0x262)]!=='127.0.0.1'&&!_0x2e56be['internal']){_0x132dde=_0x2e56be[_0x57565e(0x262)];break;}}}),this[_0x4592d7(0x1fe)]=_0x132dde;}async[_0x46c9ef(0x218)](_0x4715c2){const _0x46cae9=_0x46c9ef,_0x64560b=await this['globalConfigService']['getNamespace'](),{color:color=_0x46cae9(0x25f)}=_0x4715c2,_0x11f4b8=svgCaptcha['createMathExpr']({'background':color,'height':0x22,'width':0x78,'noise':0x3}),_0x229ea1=_0x11f4b8[_0x46cae9(0x23b)],_0x58a263=(0x0,utils_1[_0x46cae9(0x214)])(),_0x1e00bf=_0x64560b+':CAPTCHA:'+_0x58a263;return await this[_0x46cae9(0x223)][_0x46cae9(0x2b0)]({'key':_0x1e00bf,'val':_0x11f4b8[_0x46cae9(0x23b)]},0x5*0x3c),{'svgCode':_0x11f4b8[_0x46cae9(0x22c)],'code':_0x58a263};}async[_0x46c9ef(0x297)](_0x143f82){const _0x278e9a=_0x46c9ef;_0x143f82[_0x278e9a(0x29a)]&&await this[_0x278e9a(0x229)]['verifyCaptcha'](_0x143f82);const {phone:_0x4f6174}=_0x143f82,_0x28babf=await this[_0x278e9a(0x27e)][_0x278e9a(0x28e)](),_0x1c03de=_0x28babf+_0x278e9a(0x1f3)+_0x4f6174,_0x381216=await this[_0x278e9a(0x223)]['ttl'](_0x1c03de);if(_0x381216&&_0x381216>0x0)throw new common_1[(_0x278e9a(0x1c4))](_0x381216+_0x278e9a(0x288),common_1[_0x278e9a(0x1d1)][_0x278e9a(0x28c)]);const _0x2b1e1e=(0x0,utils_1[_0x278e9a(0x269)])(),_0x4a289f={'phone':_0x4f6174,'code':_0x2b1e1e};return await this['verificationService'][_0x278e9a(0x297)](_0x4a289f),await this[_0x278e9a(0x223)][_0x278e9a(0x2b0)]({'key':_0x1c03de,'val':_0x2b1e1e},0x1*0x3c),'验证码发送成功、请填写验证码完成注册！';}async[_0x46c9ef(0x2a2)](_0x5e8eca){const _0x203c5b=_0x46c9ef;try{var _0x2ef9bb=/^[a-zA-Z0-9]+([_.w-]+[a-zA-Z0-9]+)*@[a-zA-Z0-9]+([-.w-]+[a-zA-Z0-9]+)*.[a-zA-Z0-9]+$/;if(!_0x2ef9bb[_0x203c5b(0x29e)](_0x5e8eca))throw new Error(_0x203c5b(0x1ee));const _0x1c5a98=await this['userEntity'][_0x203c5b(0x26f)]({'where':{'email':_0x5e8eca}});if(_0x1c5a98)throw new Error(_0x203c5b(0x26d));const _0x44fa1e=await this[_0x203c5b(0x1ea)][_0x203c5b(0x204)]({'where':{'configKey':(0x0,typeorm_1['In'])([_0x203c5b(0x211),_0x203c5b(0x1dc),'registerVerifyEmailDesc',_0x203c5b(0x1e2),_0x203c5b(0x237)])}}),_0x57f2ca=_0x44fa1e['reduce']((_0x529187,_0x38c12f)=>{return _0x529187[_0x38c12f['configKey']]=_0x38c12f['configVal'],_0x529187;},{}),_0x508061=(0x0,utils_1[_0x203c5b(0x269)])(),_0x2f9a3a=_0x57f2ca['registerVerifyExpir']?Number(_0x57f2ca['registerVerifyExpir']):0x1e*0x3c;await this['redisCacheService'][_0x203c5b(0x2b0)]({'key':redisKey_constant_1[_0x203c5b(0x247)]+_0x5e8eca,'val':_0x508061},_0x2f9a3a*0x3c),await this[_0x203c5b(0x1db)][_0x203c5b(0x20f)]({'to':_0x5e8eca,'template':_0x203c5b(0x1f8),'subject':'来自'+_0x57f2ca[_0x203c5b(0x1e2)]+_0x203c5b(0x2ac),'context':{'baseUrl':_0x57f2ca[_0x203c5b(0x211)],'code':_0x508061,..._0x57f2ca}});}catch(_0x2bdb84){throw new common_1[(_0x203c5b(0x1c4))](_0x2bdb84[_0x203c5b(0x1c2)],common_1['HttpStatus'][_0x203c5b(0x28c)]);}}['createTokenFromFingerprint'](_0x57d2f6){const _0x538020=_0x46c9ef,_0x42d780=this[_0x538020(0x272)]['sign']({'username':'游客'+_0x57d2f6,'id':_0x57d2f6,'email':_0x57d2f6+'@nine.com','role':_0x538020(0x21e),'openId':null,'client':null});return _0x42d780;}async[_0x46c9ef(0x1d7)](_0x37364c,_0x8462d1){const _0x3115fa=_0x46c9ef,_0x5f1234=await this[_0x3115fa(0x27e)]['getNamespace'](),_0x398818=_0x5f1234+_0x3115fa(0x1f3)+_0x37364c;if(_0x8462d1===_0x3115fa(0x227))return;const _0xdb6c5a=await this[_0x3115fa(0x223)][_0x3115fa(0x1f9)]({'key':_0x398818});if(!_0xdb6c5a)throw new common_1[(_0x3115fa(0x1c4))](_0x3115fa(0x22e),common_1[_0x3115fa(0x1d1)]['BAD_REQUEST']);if(_0x8462d1!==_0xdb6c5a)throw new common_1[(_0x3115fa(0x1c4))](_0x3115fa(0x2a9),common_1['HttpStatus'][_0x3115fa(0x28c)]);}async[_0x46c9ef(0x20a)](_0x313c35){const _0x4a72ba=_0x46c9ef;await this[_0x4a72ba(0x28f)]['verifyUserRegisterByPhone'](_0x313c35),await this['validatePhoneCode'](_0x313c35[_0x4a72ba(0x235)],_0x313c35['phoneCode']);}async[_0x46c9ef(0x242)](_0x474595,_0x34d6d7){let _0xfdf8fb;_0x34d6d7&&(_0xfdf8fb=await this['userService']['qureyUserInfoByInviteCode'](_0x34d6d7)),await this['userBalanceService']['addBalanceToNewUser'](_0x474595,_0xfdf8fb?.['id']);}async[_0x46c9ef(0x224)](_0x51f8e4){const _0x265afc=_0x46c9ef;try{let _0x2cbda0;await this[_0x265afc(0x20a)](_0x51f8e4);const _0x5afeb4=(0x0,utils_1[_0x265afc(0x214)])()+_0x265afc(0x263),_0x33bb86=new user_entity_1[(_0x265afc(0x1b7))]();_0x33bb86['username']=_0x51f8e4[_0x265afc(0x1c8)],_0x33bb86[_0x265afc(0x2ab)]=_0x51f8e4[_0x265afc(0x2ab)],_0x33bb86[_0x265afc(0x235)]=_0x51f8e4['phone'],_0x33bb86[_0x265afc(0x295)]=_0x5afeb4,_0x33bb86[_0x265afc(0x213)]=user_constant_1[_0x265afc(0x217)][_0x265afc(0x1bd)],_0x33bb86[_0x265afc(0x2ab)]=bcrypt[_0x265afc(0x249)](_0x51f8e4['password'],0xa);if(_0x51f8e4[_0x265afc(0x28a)](_0x265afc(0x208))){const _0x127553=_0x51f8e4;_0x33bb86[_0x265afc(0x28d)]=_0x127553['avatar'],_0x33bb86['nickname']=_0x127553['nickname'],_0x33bb86[_0x265afc(0x208)]=_0x127553[_0x265afc(0x208)],_0x2cbda0=redisKey_constant_1[_0x265afc(0x1c1)]+_0x127553['miniOpenId'],_0x33bb86['unionid']=await this[_0x265afc(0x223)][_0x265afc(0x1f9)]({'key':_0x2cbda0});}else _0x33bb86[_0x265afc(0x28d)]=await this['globalConfigService'][_0x265afc(0x254)](['userDefautlAvatar']);const _0x297b62=await this['userService'][_0x265afc(0x224)](_0x33bb86);this[_0x265afc(0x242)](_0x297b62['id'],_0x51f8e4[_0x265afc(0x285)]);const {username:_0x229f7d,openId:_0x47e369,id:_0x423edd,role:_0x246ac3,client:_0x5d4d23}=_0x297b62,_0x3b6d5c=this[_0x265afc(0x272)][_0x265afc(0x221)]({'username':_0x229f7d,'openId':_0x47e369,'id':_0x423edd,'email':_0x5afeb4,'role':_0x246ac3,'client':_0x5d4d23});return this['redisCacheService'][_0x265afc(0x236)]({'key':_0x2cbda0}),_0x3b6d5c;}catch(_0x5e9eb2){throw new common_1[(_0x265afc(0x1c4))](_0x5e9eb2['message'],common_1[_0x265afc(0x1d1)][_0x265afc(0x28c)]);}}async[_0x46c9ef(0x29b)](){const _0x3728fc=_0x46c9ef;try{const _0x5a0c9d=process[_0x3728fc(0x250)][_0x3728fc(0x234)];if(_0x5a0c9d===_0x3728fc(0x277)||_0x5a0c9d==='ceshi.qumao518.vip'){const _0x11c506=await axios_1[_0x3728fc(0x27c)][_0x3728fc(0x1f9)](_0x3728fc(0x2a8));await this[_0x3728fc(0x223)][_0x3728fc(0x2b0)]({'key':redisKey_constant_1[_0x3728fc(0x1bb)],'val':_0x11c506[_0x3728fc(0x22c)][_0x3728fc(0x22c)]});}else{const _0x2cc589=await axios_1[_0x3728fc(0x27c)][_0x3728fc(0x2aa)]('https://api.weixin.qq.com/cgi-bin/stable_token',{'grant_type':_0x3728fc(0x298),'appid':WechatConfig_1[_0x3728fc(0x27c)][_0x3728fc(0x23c)],'secret':WechatConfig_1[_0x3728fc(0x27c)][_0x3728fc(0x1c3)],'force_refresh':![]});await this[_0x3728fc(0x223)][_0x3728fc(0x2b0)]({'key':redisKey_constant_1[_0x3728fc(0x1bb)],'val':_0x2cc589[_0x3728fc(0x22c)][_0x3728fc(0x1b1)]});}}catch(_0x28cd71){common_1['Logger'][_0x3728fc(0x1b6)](_0x3728fc(0x1cd),_0x28cd71);}}async[_0x46c9ef(0x1d5)](_0xea352d){const _0x249fc7=_0x46c9ef;try{const _0x526231=new Login_vo_1[(_0x249fc7(0x27c))](),_0x2930e1=await axios_1['default'][_0x249fc7(0x1f9)](_0x249fc7(0x27f),{'params':{'appid':WechatConfig_1[_0x249fc7(0x27c)][_0x249fc7(0x23c)],'secret':WechatConfig_1['default'][_0x249fc7(0x1c3)],'js_code':_0xea352d,'grant_type':_0x249fc7(0x252)}}),_0x357bfd=_0x2930e1[_0x249fc7(0x22c)];if(_0x357bfd[_0x249fc7(0x1e5)])throw new Error(_0x357bfd[_0x249fc7(0x279)]);const _0x4c887e=await this[_0x249fc7(0x24f)]['findOne']({'where':{'miniOpenId':_0x357bfd['openid']}});if(!_0x4c887e)this[_0x249fc7(0x223)][_0x249fc7(0x2b0)]({'key':redisKey_constant_1[_0x249fc7(0x1c1)]+_0x357bfd[_0x249fc7(0x1ce)],'val':_0x357bfd['unionid']||null});else{const {username:_0x2f1156,id:_0x47ec1f,email:_0x1a8430,role:_0x3e1078,openId:_0x34b00d,client:_0x537f15}=_0x4c887e;_0x526231['authToken']=this['jwtService'][_0x249fc7(0x221)]({'username':_0x2f1156,'id':_0x47ec1f,'email':_0x1a8430,'role':_0x3e1078,'openId':_0x34b00d,'client':_0x537f15}),await this[_0x249fc7(0x223)][_0x249fc7(0x20b)](_0x47ec1f,_0x526231[_0x249fc7(0x21b)]);}return _0x526231[_0x249fc7(0x1ce)]=_0x357bfd[_0x249fc7(0x1ce)],_0x526231;}catch(_0x211d3b){common_1[_0x249fc7(0x1ef)]['error'](_0x249fc7(0x1b8),_0x211d3b);throw new common_1[(_0x249fc7(0x1c4))](_0x211d3b['message'],common_1[_0x249fc7(0x1d1)]['BAD_REQUEST']);}}async[_0x46c9ef(0x1e6)](_0x2c8593){const _0x4421b1=_0x46c9ef;try{const _0x1362b9=await this['redisCacheService']['get']({'key':redisKey_constant_1[_0x4421b1(0x1bb)]}),_0x3bdc97=await axios_1['default'][_0x4421b1(0x2aa)](_0x4421b1(0x280)+_0x1362b9,{'code':_0x2c8593});if(_0x3bdc97['data'][_0x4421b1(0x1e5)])throw new Error(_0x3bdc97[_0x4421b1(0x22c)][_0x4421b1(0x279)]);return _0x3bdc97[_0x4421b1(0x22c)][_0x4421b1(0x1d0)][_0x4421b1(0x266)];}catch(_0xac6e4c){common_1[_0x4421b1(0x1ef)][_0x4421b1(0x1b6)](_0x4421b1(0x26c),_0xac6e4c);throw new common_1[(_0x4421b1(0x1c4))](_0xac6e4c[_0x4421b1(0x1c2)],common_1[_0x4421b1(0x1d1)][_0x4421b1(0x28c)]);}}['registeInMini'](_0x143904){const _0x10d020=_0x46c9ef;if(!_0x143904[_0x10d020(0x208)])throw new common_1[(_0x10d020(0x1c4))](_0x10d020(0x1ad),common_1[_0x10d020(0x1d1)][_0x10d020(0x28c)]);return this[_0x10d020(0x224)](_0x143904);}async[_0x46c9ef(0x290)](_0x1342ad){const _0x30eb5e=_0x46c9ef,_0x342a59=new WeAppLogin_vo_1['WeAppLoginVO']();try{const _0x5866f1=await axios_1['default'][_0x30eb5e(0x1f9)](_0x30eb5e(0x1f0)+WechatConfig_1[_0x30eb5e(0x27c)][_0x30eb5e(0x233)]+_0x30eb5e(0x1ff)+WechatConfig_1[_0x30eb5e(0x27c)][_0x30eb5e(0x202)]+_0x30eb5e(0x1e1)+_0x1342ad+_0x30eb5e(0x27a));if(_0x5866f1[_0x30eb5e(0x22c)][_0x30eb5e(0x1e5)])throw new Error(_0x5866f1[_0x30eb5e(0x22c)]['errmsg']);const _0xd1fe2d=_0x5866f1[_0x30eb5e(0x22c)],_0x3f72a7=await this[_0x30eb5e(0x24f)][_0x30eb5e(0x26f)]({'where':{'weAppOpenId':_0xd1fe2d[_0x30eb5e(0x1ce)]}});if(!_0x3f72a7)this[_0x30eb5e(0x223)]['set']({'key':redisKey_constant_1[_0x30eb5e(0x240)]+_0xd1fe2d['openid'],'val':_0xd1fe2d[_0x30eb5e(0x27b)]||null});else{const {username:_0xfa7baa,id:_0x5dbd06,email:_0x4f4f0d,role:_0x573703,openId:_0x5de5a3,client:_0x3d16de}=_0x3f72a7;_0x342a59[_0x30eb5e(0x21b)]=this['jwtService'][_0x30eb5e(0x221)]({'username':_0xfa7baa,'id':_0x5dbd06,'email':_0x4f4f0d,'role':_0x573703,'openId':_0x5de5a3,'client':_0x3d16de}),await this[_0x30eb5e(0x223)][_0x30eb5e(0x20b)](_0x5dbd06,_0x342a59['authToken']);}return _0x342a59[_0x30eb5e(0x1ce)]=_0xd1fe2d['openid'],_0x342a59['accessToken']=_0xd1fe2d[_0x30eb5e(0x1b1)],_0x342a59;}catch(_0x228846){common_1[_0x30eb5e(0x1ef)][_0x30eb5e(0x1b6)](_0x30eb5e(0x264),_0x228846);throw new common_1[(_0x30eb5e(0x1c4))](_0x228846[_0x30eb5e(0x1c2)],common_1[_0x30eb5e(0x1d1)]['BAD_REQUEST']);}}async['phoneWithOpenId4regist'](_0x39f13a){const _0xb91da5=_0x46c9ef;try{if(!_0x39f13a['openId']&&!_0x39f13a['miniOpenId']&&!_0x39f13a[_0xb91da5(0x274)])throw new Error('openId、miniOpenId、weAppOpenId中必须存在一个');let _0x2b4288=_0xb91da5(0x22f),_0x59e310={};if(_0x39f13a['openId'])_0x2b4288=_0xb91da5(0x22f);else _0x39f13a[_0xb91da5(0x208)]?_0x2b4288=_0xb91da5(0x208):_0x2b4288=_0xb91da5(0x274);_0x59e310[_0x2b4288]=_0x39f13a[_0x2b4288];const _0x34a010=await this[_0xb91da5(0x24f)][_0xb91da5(0x26f)]({'where':_0x59e310});if(_0x34a010&&_0x34a010[_0xb91da5(0x235)])return![];const _0x32f767=await this[_0xb91da5(0x24f)][_0xb91da5(0x26f)]({'where':{'phone':_0x39f13a[_0xb91da5(0x235)]}});if(_0x32f767)return!_0x32f767[_0x2b4288];return!![];}catch(_0x2f647a){throw new common_1[(_0xb91da5(0x1c4))](_0x2f647a[_0xb91da5(0x1c2)],common_1[_0xb91da5(0x1d1)][_0xb91da5(0x28c)]);}}async[_0x46c9ef(0x219)](_0xae9973,_0xe0a7a6){const _0x4239f7=_0x46c9ef;try{if(_0xae9973[_0x4239f7(0x1c8)]){if(!/^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d]+$/[_0x4239f7(0x29e)](_0xae9973[_0x4239f7(0x1c8)]))throw new Error(_0x4239f7(0x291));if(!_0xae9973[_0x4239f7(0x2ab)])throw new Error(_0x4239f7(0x268));}else{if(!_0xae9973[_0x4239f7(0x22f)]&&!_0xae9973[_0x4239f7(0x208)]&&!_0xae9973['weAppOpenId'])throw new Error('参数错误！');}if(_0xae9973[_0x4239f7(0x235)]&&!_0xae9973['phoneCode'])throw new Error(_0x4239f7(0x206));let _0x43b25a=null;if(_0xae9973[_0x4239f7(0x235)])await this['validatePhoneCode'](_0xae9973[_0x4239f7(0x235)],_0xae9973[_0x4239f7(0x1d9)]),_0x43b25a=await this['userEntity'][_0x4239f7(0x26f)]({'where':{'phone':_0xae9973[_0x4239f7(0x235)]}});else{if(_0xae9973[_0x4239f7(0x22f)]||_0xae9973[_0x4239f7(0x208)]||_0xae9973[_0x4239f7(0x274)]){let _0x1f1483=_0x4239f7(0x22f),_0x10167d={};if(_0xae9973[_0x4239f7(0x22f)])_0x1f1483='openId';else _0xae9973[_0x4239f7(0x208)]?_0x1f1483=_0x4239f7(0x208):_0x1f1483='weAppOpenId';_0x10167d[_0x1f1483]=_0xae9973[_0x1f1483],_0x43b25a=await this[_0x4239f7(0x24f)][_0x4239f7(0x26f)]({'where':_0x10167d});if(_0x43b25a)throw new Error(_0x4239f7(0x284));}else{_0x43b25a=await this[_0x4239f7(0x24f)][_0x4239f7(0x26f)]({'where':{'username':_0xae9973[_0x4239f7(0x1c8)]}});if(_0x43b25a)throw new Error(_0x4239f7(0x284));}}const _0xbbaf73=new user_entity_1[(_0x4239f7(0x1b7))]();for(let _0x4e7c0e in _0xae9973){_0xae9973[_0x4e7c0e]&&(_0xbbaf73[_0x4e7c0e]=_0xae9973[_0x4e7c0e]);}_0x43b25a?_0xbbaf73['id']=_0x43b25a['id']:(_0xbbaf73[_0x4239f7(0x2ab)]&&(_0xbbaf73[_0x4239f7(0x2ab)]=bcrypt['hashSync'](_0xae9973[_0x4239f7(0x2ab)],0xa)),_0xbbaf73[_0x4239f7(0x213)]=user_constant_1[_0x4239f7(0x217)][_0x4239f7(0x1bd)],!_0xbbaf73[_0x4239f7(0x2a5)]&&(_0xbbaf73['nickname']=_0xbbaf73[_0x4239f7(0x2a5)]||'小智'),!_0xbbaf73[_0x4239f7(0x28d)]&&(_0xbbaf73[_0x4239f7(0x28d)]=await this[_0x4239f7(0x27e)][_0x4239f7(0x254)]([_0x4239f7(0x1b3)])));const _0x2bc9bd=await this[_0x4239f7(0x28f)][_0x4239f7(0x224)](_0xbbaf73);!_0x43b25a&&this[_0x4239f7(0x242)](_0x2bc9bd['id'],_0xae9973[_0x4239f7(0x285)]);const _0x1eb01a=(0x0,utils_1['getClientIp'])(_0xe0a7a6);await this[_0x4239f7(0x28f)]['savaLoginIp'](_0x2bc9bd['id'],_0x1eb01a);const {id:_0x1bd5ff,role:_0x138ad4,email:_0x99ccc6,client:_0x23312e,openId:_0x782fee,username:_0x264032}=_0x2bc9bd,_0x54addd=this[_0x4239f7(0x272)][_0x4239f7(0x221)]({'id':_0x1bd5ff,'role':_0x138ad4,'email':_0x99ccc6,'client':_0x23312e,'openId':_0x782fee,'username':_0x264032});return await this['redisCacheService'][_0x4239f7(0x20b)](_0x1bd5ff,_0x54addd),_0x54addd;}catch(_0x1cc72f){if(_0x1cc72f instanceof common_1[_0x4239f7(0x1c4)])throw _0x1cc72f;else throw new common_1[(_0x4239f7(0x1c4))](_0x1cc72f[_0x4239f7(0x1c2)],common_1[_0x4239f7(0x1d1)][_0x4239f7(0x28c)]);}}async[_0x46c9ef(0x26a)](_0x8d5c94){const _0x2950b9=_0x46c9ef,_0x2e61f6=await this[_0x2950b9(0x24f)]['count']({'where':{'phone':_0x8d5c94}});return _0x2e61f6>0x0;}async[_0x46c9ef(0x1e8)](_0xb48bb8){const _0xf393ba=_0x46c9ef;return await this[_0xf393ba(0x1d7)](_0xb48bb8[_0xf393ba(0x235)],_0xb48bb8[_0xf393ba(0x1d9)]),await this['userEntity']['save']({'id':_0xb48bb8['userId'],'phone':_0xb48bb8[_0xf393ba(0x235)]}),!![];}};AuthService=__decorate([(0x0,common_1[_0x46c9ef(0x20e)])(),__param(0x0,(0x0,typeorm_2[_0x46c9ef(0x1e3)])(user_entity_1[_0x46c9ef(0x1b7)])),__param(0x1,(0x0,typeorm_2[_0x46c9ef(0x1e3)])(config_entity_1[_0x46c9ef(0x26e)])),__metadata(_0x46c9ef(0x1f2),[typeorm_1[_0x46c9ef(0x282)],typeorm_1[_0x46c9ef(0x282)],user_service_1[_0x46c9ef(0x258)],jwt_1['JwtService'],mailer_service_1[_0x46c9ef(0x289)],verification_service_1['VerificationService'],userBalance_service_1[_0x46c9ef(0x27d)],redisCache_service_1[_0x46c9ef(0x1bf)],globalConfig_service_1[_0x46c9ef(0x24d)],access_service_1[_0x46c9ef(0x1e7)]])],AuthService),exports[_0x46c9ef(0x1be)]=AuthService;