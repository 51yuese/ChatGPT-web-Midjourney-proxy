'use strict';const _0x218300=_0x4724;(function(_0x130d9b,_0x2697d9){const _0x5043dc=_0x4724,_0x19500f=_0x130d9b();while(!![]){try{const _0x363d78=-parseInt(_0x5043dc(0x14e))/0x1*(-parseInt(_0x5043dc(0x160))/0x2)+parseInt(_0x5043dc(0x183))/0x3*(-parseInt(_0x5043dc(0x141))/0x4)+parseInt(_0x5043dc(0x1ca))/0x5+parseInt(_0x5043dc(0x1ad))/0x6+parseInt(_0x5043dc(0x15c))/0x7*(parseInt(_0x5043dc(0x190))/0x8)+-parseInt(_0x5043dc(0x168))/0x9*(parseInt(_0x5043dc(0x14f))/0xa)+-parseInt(_0x5043dc(0x175))/0xb;if(_0x363d78===_0x2697d9)break;else _0x19500f['push'](_0x19500f['shift']());}catch(_0x5a1c17){_0x19500f['push'](_0x19500f['shift']());}}}(_0x1b28,0xe5197));function _0x4724(_0x1bedb3,_0x4b0a37){const _0x1b28b2=_0x1b28();return _0x4724=function(_0x472476,_0x43aa61){_0x472476=_0x472476-0x127;let _0x5bdc67=_0x1b28b2[_0x472476];return _0x5bdc67;},_0x4724(_0x1bedb3,_0x4b0a37);}var __decorate=this&&this[_0x218300(0x17e)]||function(_0x3f3a22,_0x38f553,_0x32db4f,_0x4a328f){const _0x4236bd=_0x218300;var _0x5ec288=arguments['length'],_0x360634=_0x5ec288<0x3?_0x38f553:_0x4a328f===null?_0x4a328f=Object[_0x4236bd(0x172)](_0x38f553,_0x32db4f):_0x4a328f,_0x284b7b;if(typeof Reflect===_0x4236bd(0x12a)&&typeof Reflect[_0x4236bd(0x148)]===_0x4236bd(0x1cd))_0x360634=Reflect[_0x4236bd(0x148)](_0x3f3a22,_0x38f553,_0x32db4f,_0x4a328f);else{for(var _0x54e89f=_0x3f3a22['length']-0x1;_0x54e89f>=0x0;_0x54e89f--)if(_0x284b7b=_0x3f3a22[_0x54e89f])_0x360634=(_0x5ec288<0x3?_0x284b7b(_0x360634):_0x5ec288>0x3?_0x284b7b(_0x38f553,_0x32db4f,_0x360634):_0x284b7b(_0x38f553,_0x32db4f))||_0x360634;}return _0x5ec288>0x3&&_0x360634&&Object['defineProperty'](_0x38f553,_0x32db4f,_0x360634),_0x360634;},__metadata=this&&this['__metadata']||function(_0x1825b6,_0xb59a23){const _0x22641a=_0x218300;if(typeof Reflect===_0x22641a(0x12a)&&typeof Reflect[_0x22641a(0x1d9)]===_0x22641a(0x1cd))return Reflect['metadata'](_0x1825b6,_0xb59a23);},__param=this&&this['__param']||function(_0x24678e,_0x54446e){return function(_0x405016,_0x52decf){_0x54446e(_0x405016,_0x52decf,_0x24678e);};};Object[_0x218300(0x165)](exports,'__esModule',{'value':!![]}),exports['MjService']=void 0x0;const globalConfig_service_1=require(_0x218300(0x19a)),upload_service_1=require(_0x218300(0x16a)),common_1=require('@nestjs/common'),axios_1=require(_0x218300(0x195)),chatLog_service_1=require(_0x218300(0x144)),balance_constant_1=require(_0x218300(0x1c9)),utils_1=require(_0x218300(0x139)),chatLog_entity_1=require('../chatLog/chatLog.entity'),typeorm_1=require(_0x218300(0x185)),typeorm_2=require(_0x218300(0x188)),balance_entity_1=require('../userBalance/balance.entity'),fanyi_service_1=require('../fanyi/fanyi.service'),badwords_service_1=require(_0x218300(0x19e));let MjService=class MjService{constructor(_0x2dc2bb,_0x3950e3,_0x312cfd,_0x27aea7,_0x308a72,_0x1d3f2c,_0x2f99fa){const _0x4a48e9=_0x218300;this[_0x4a48e9(0x1a3)]=_0x2dc2bb,this[_0x4a48e9(0x16b)]=_0x3950e3,this[_0x4a48e9(0x155)]=_0x312cfd,this['chatLogService']=_0x27aea7,this['globalConfigService']=_0x308a72,this['fanyiService']=_0x1d3f2c,this['badwordsService']=_0x2f99fa,this['rateLimits']={},this[_0x4a48e9(0x159)]=[],this[_0x4a48e9(0x1d1)]=[],this[_0x4a48e9(0x1bc)]=0x0,this[_0x4a48e9(0x151)]={};}async[_0x218300(0x1b5)](){}[_0x218300(0x1e2)](_0x334bca,_0x171b68){}async[_0x218300(0x196)](_0x1281d7,_0x523578){const _0x264dc6=_0x218300;await this['checkAuth'](_0x523578),await this[_0x264dc6(0x1be)][_0x264dc6(0x1a8)](_0x1281d7[_0x264dc6(0x1b6)],_0x523578[_0x264dc6(0x179)]['id']);const _0x19da01=_0x1281d7['prompt'];let _0x276d2a=_0x1281d7[_0x264dc6(0x1b6)];const {baiduFanyiAppId:_0x432dab,baiduFanyiSecret:_0x3703a4}=await this[_0x264dc6(0x19f)]['getConfigs'](['baiduFanyiAppId',_0x264dc6(0x13e)]);_0x432dab&&_0x3703a4&&(_0x276d2a=await this[_0x264dc6(0x1a6)][_0x264dc6(0x1cb)](_0x19da01));const _0x501115='['+(0x0,utils_1[_0x264dc6(0x130)])()+']',_0x37b774=_0x501115+'\x20'+_0x276d2a;console['log']('randomId:\x20',_0x501115),console['log'](_0x264dc6(0x1af),_0x37b774);const _0x12533e=this[_0x264dc6(0x159)][_0x264dc6(0x1b2)](_0x1a5b2a=>_0x1a5b2a[_0x264dc6(0x15d)](_0x1281d7['prompt']));if(_0x12533e)throw new common_1['HttpException'](_0x264dc6(0x16c),common_1[_0x264dc6(0x14d)]['BAD_REQUEST']);if(this['queueCount']>=0x3)throw new common_1[(_0x264dc6(0x1d2))](_0x264dc6(0x1de),common_1[_0x264dc6(0x14d)][_0x264dc6(0x162)]);await this[_0x264dc6(0x191)](_0x523578),this[_0x264dc6(0x1bc)]++,console['log'](_0x264dc6(0x146)+_0x523578['user']['id']+_0x264dc6(0x161),this[_0x264dc6(0x1bc)]);try{const _0x113017=await this[_0x264dc6(0x1a3)][_0x264dc6(0x1b2)]({'where':{'prompt':(0x0,typeorm_1[_0x264dc6(0x135)])('%'+_0x37b774+'%')}}),_0x43f981=_0x113017['map'](_0x476bc2=>_0x476bc2[_0x264dc6(0x15b)]);this['drawWorking'][_0x264dc6(0x1a7)](_0x37b774);let _0x592a36;const _0xa20de9=await this[_0x264dc6(0x1cf)](_0x37b774,_0x43f981,_0x501115);_0xa20de9?(console[_0x264dc6(0x171)](_0x264dc6(0x169)),_0x592a36=_0xa20de9):_0x592a36=await this[_0x264dc6(0x13b)](_0x37b774,_0x43f981,_0x501115);console[_0x264dc6(0x171)](_0x592a36),this[_0x264dc6(0x1bc)]--,this[_0x264dc6(0x1bc)]<0x0&&(this[_0x264dc6(0x1bc)]=0x0),console['log'](_0x264dc6(0x156),this[_0x264dc6(0x1bc)]);const {id:_0x5aa26f,content:_0x168e91,channel_id:_0x3e6419,attachments:attachments=[],timestamp:_0x2833b1}=_0x592a36;if(!attachments[_0x264dc6(0x1d4)]||!attachments[0x0][_0x264dc6(0x177)])throw new common_1[(_0x264dc6(0x1d2))](_0x264dc6(0x1b7),common_1['HttpStatus'][_0x264dc6(0x162)]);const {filename:_0x4212da,url:_0x4e15d7,width:_0x53d796,height:_0x23f21b,size:_0x377711}=attachments[0x0];console[_0x264dc6(0x171)](_0x264dc6(0x1c7),_0x4e15d7);const _0x512ec3=this[_0x264dc6(0x19f)][_0x264dc6(0x163)](['mjNotSaveImg']);let _0x5c6722='';(!Number(_0x512ec3)||Number(_0x512ec3)===0x0)&&(_0x5c6722=await this['uploadService']['uploadFileFromUrl']({'filename':_0x4212da,'url':_0x4e15d7}),console[_0x264dc6(0x171)](_0x264dc6(0x1a9),_0x5c6722));const _0xe31a2b={'mode':0x1,'curIp':(0x0,utils_1[_0x264dc6(0x1a5)])(_0x523578),'userId':_0x523578[_0x264dc6(0x179)]['id'],'type':balance_constant_1['DeductionKey'][_0x264dc6(0x1c5)],'prompt':_0x37b774,'answer':_0x5c6722,'model':'mj','extend':this[_0x264dc6(0x1d3)](JSON[_0x264dc6(0x1da)](_0x592a36)),'message_id':_0x5aa26f,'variationId':_0x5aa26f,'upscaleId':_0x5aa26f,'group':0x1,'isSaveImg':!Number(_0x512ec3)||Number(_0x512ec3)===0x0,'fileInfo':JSON[_0x264dc6(0x1da)]({'width':_0x53d796,'height':_0x23f21b,'size':_0x377711,'filename':_0x4212da,'cosUrl':_0x5c6722})};return await this[_0x264dc6(0x158)][_0x264dc6(0x14c)](_0xe31a2b),await this['deductBalance'](_0x523578),this[_0x264dc6(0x159)]=this[_0x264dc6(0x159)][_0x264dc6(0x129)](_0x46c360=>_0x46c360!==_0x1281d7[_0x264dc6(0x1b6)]),_0x5c6722;}catch(_0x3705a4){this['queueCount']--,this[_0x264dc6(0x1bc)]<0x0&&(this['queueCount']=0x0),console[_0x264dc6(0x171)](_0x264dc6(0x16d),this['queueCount']),this[_0x264dc6(0x159)]=this['drawWorking']['filter'](_0x3d4469=>_0x3d4469!==_0x1281d7[_0x264dc6(0x1b6)]);throw new common_1['HttpException'](_0x3705a4[_0x264dc6(0x12d)],common_1[_0x264dc6(0x14d)]['BAD_REQUEST']);}}async[_0x218300(0x1c0)](_0x544bbd,_0x11e37f){const _0x4c2256=_0x218300;if(this[_0x4c2256(0x1bc)]>=0x3)throw new common_1[(_0x4c2256(0x1d2))](_0x4c2256(0x1de),common_1[_0x4c2256(0x14d)][_0x4c2256(0x162)]);this[_0x4c2256(0x1bc)]++,console[_0x4c2256(0x171)]('用户'+_0x11e37f[_0x4c2256(0x179)]['id']+_0x4c2256(0x1b0),this[_0x4c2256(0x1bc)]);const {message_id:_0x4b86a8,orderId:_0x2f2779}=_0x544bbd;try{const _0x500bf5=await this['chatLogEntity'][_0x4c2256(0x18b)]({'where':{'message_id':_0x4b86a8}});if(!_0x500bf5)throw new common_1[(_0x4c2256(0x1d2))](_0x4c2256(0x131),common_1['HttpStatus'][_0x4c2256(0x162)]);const _0x3fd2e9=await this['chatLogEntity'][_0x4c2256(0x18b)]({'where':{'upscaleId':_0x4b86a8,'action':'enlarge','orderId':_0x2f2779}});if(_0x3fd2e9)throw new common_1[(_0x4c2256(0x1d2))](_0x4c2256(0x145),common_1[_0x4c2256(0x14d)][_0x4c2256(0x162)]);const {prompt:_0x1154ca,extend:_0x3231ee}=_0x500bf5,_0xd74c60=JSON['parse'](_0x3231ee),{components:components=[]}=_0xd74c60;if(!components[_0x4c2256(0x1d4)])throw new common_1[(_0x4c2256(0x1d2))]('当前图片没有绘画信息、无法放大!',common_1[_0x4c2256(0x14d)][_0x4c2256(0x162)]);const _0x55d92b=components[0x0][_0x4c2256(0x133)][_0x2f2779-0x1],{custom_id:_0xf104b1}=_0x55d92b;console['log'](_0x4c2256(0x154),_0xf104b1);const _0x4c33ac={'message_id':_0x4b86a8,'custom_id':_0xf104b1,'prompt':_0x1154ca,'orderId':_0x2f2779};await this[_0x4c2256(0x14a)](_0x4c33ac),console[_0x4c2256(0x171)](_0x4c2256(0x1a1));const _0x8f6fbc=await this['chatLogEntity'][_0x4c2256(0x1b2)]({'where':{'prompt':(0x0,typeorm_1[_0x4c2256(0x135)])('%'+_0x1154ca+'%')}}),_0x8be9f9=_0x8f6fbc[_0x4c2256(0x18a)](_0x38a833=>_0x38a833[_0x4c2256(0x15b)]);console[_0x4c2256(0x171)](_0x4c2256(0x1c4),_0x8be9f9);const _0x2823ae=await this[_0x4c2256(0x1c1)](_0x4c33ac,_0x8be9f9);this[_0x4c2256(0x1bc)]--,this[_0x4c2256(0x1bc)]<0x0&&(this[_0x4c2256(0x1bc)]=0x0),console[_0x4c2256(0x171)](_0x4c2256(0x181),this[_0x4c2256(0x1bc)]);const {id:_0x3337cc,content:_0x2e6288,channel_id:_0x145d45,attachments:attachments=[],timestamp:_0x8d9c5b}=_0x2823ae;if(!attachments[_0x4c2256(0x1d4)]||!attachments[0x0][_0x4c2256(0x177)])throw new common_1[(_0x4c2256(0x1d2))](_0x4c2256(0x184),common_1[_0x4c2256(0x14d)][_0x4c2256(0x162)]);const {filename:_0x4d489c,url:_0x101a28,width:_0x4bc655,height:_0x13b594,size:_0x3bfac7}=attachments[0x0],_0x9d101a=this[_0x4c2256(0x19f)]['getConfigs']([_0x4c2256(0x143)]);let _0x3c65e4='';(!Number(_0x9d101a)||Number(_0x9d101a)===0x0)&&(_0x3c65e4=await this[_0x4c2256(0x155)]['uploadFileFromUrl']({'filename':_0x4d489c,'url':_0x101a28}),console[_0x4c2256(0x171)](_0x4c2256(0x1a9),_0x3c65e4));const _0xb4fc3f={'curIp':(0x0,utils_1[_0x4c2256(0x1a5)])(_0x11e37f),'userId':_0x11e37f['user']['id'],'type':balance_constant_1['DeductionKey'][_0x4c2256(0x1c5)],'prompt':_0x1154ca,'answer':_0x3c65e4,'model':'mj','extend':this['removeEmoji'](JSON[_0x4c2256(0x1da)](_0x2823ae)),'message_id':_0x4b86a8,'upscaleId':_0x3337cc,'variationId':_0x3337cc,'action':_0x4c2256(0x174),'orderId':_0x4c33ac['orderId'],'isSaveImg':!Number(_0x9d101a)||Number(_0x9d101a)===0x0,'fileInfo':JSON[_0x4c2256(0x1da)]({'width':_0x4bc655,'height':_0x13b594,'size':_0x3bfac7,'filename':_0x4d489c,'cosUrl':_0x3c65e4})};return await this['chatLogService'][_0x4c2256(0x14c)](_0xb4fc3f),_0x3c65e4;}catch(_0x1075f9){console[_0x4c2256(0x171)](_0x4c2256(0x14b),_0x1075f9),this['queueCount']--,this['queueCount']<0x0&&(this['queueCount']=0x0),console['log']('放大图片任务异常中断\x20队列-1:\x20',this[_0x4c2256(0x1bc)]);throw new common_1[(_0x4c2256(0x1d2))](_0x1075f9[_0x4c2256(0x12d)],common_1[_0x4c2256(0x14d)][_0x4c2256(0x162)]);}}async[_0x218300(0x1b9)](_0x123c98,_0x2135a0){const _0xc7788f=_0x218300;if(this[_0xc7788f(0x1bc)]>=0x3)throw new common_1[(_0xc7788f(0x1d2))](_0xc7788f(0x1de),common_1[_0xc7788f(0x14d)][_0xc7788f(0x162)]);await this['checkAuth'](_0x2135a0),await this[_0xc7788f(0x191)](_0x2135a0),this[_0xc7788f(0x1bc)]++,console[_0xc7788f(0x171)]('用户'+_0x2135a0['user']['id']+_0xc7788f(0x19b),this[_0xc7788f(0x1bc)]);const {message_id:_0x7d133,orderId:_0x5d98f8}=_0x123c98;try{const _0x1451eb=await this[_0xc7788f(0x1a3)][_0xc7788f(0x18b)]({'where':{'message_id':_0x7d133}});if(!_0x1451eb)throw new common_1[(_0xc7788f(0x1d2))](_0xc7788f(0x167),common_1[_0xc7788f(0x14d)][_0xc7788f(0x162)]);const {prompt:_0x18a377,extend:_0x353d09}=_0x1451eb,_0x467419=JSON[_0xc7788f(0x1b3)](_0x353d09),{components:components=[]}=_0x467419;if(!components[_0xc7788f(0x1d4)])throw new common_1[(_0xc7788f(0x1d2))](_0xc7788f(0x197),common_1[_0xc7788f(0x14d)][_0xc7788f(0x162)]);const _0x2ce1a6=components[0x1][_0xc7788f(0x133)][_0x5d98f8-0x1],{custom_id:_0x3a737a}=_0x2ce1a6,_0x164c28=await this['chatLogEntity'][_0xc7788f(0x1b2)]({'where':{'variationId':(0x0,typeorm_1[_0xc7788f(0x187)])((0x0,typeorm_1[_0xc7788f(0x1ae)])()),'prompt':(0x0,typeorm_1[_0xc7788f(0x135)])('%'+_0x18a377+'%')}}),_0x28f4d6=_0x164c28['map'](_0xf3e0f1=>_0xf3e0f1[_0xc7788f(0x1ac)]),_0x7926e3={'message_id':_0x7d133,'custom_id':_0x3a737a,'prompt':_0x18a377,'orderId':_0x5d98f8};await this[_0xc7788f(0x14a)](_0x7926e3);const _0x2633bc=await this['pollForVariationResult'](_0x7926e3,_0x28f4d6);this['queueCount']--,this[_0xc7788f(0x1bc)]<0x0&&(this[_0xc7788f(0x1bc)]=0x0),console['log'](_0xc7788f(0x1ce),this[_0xc7788f(0x1bc)]);const {id:_0x35aee3,content:_0xa28aaf,channel_id:_0x12b80f,attachments:attachments=[],timestamp:_0x351212}=_0x2633bc;if(!attachments['length']||!attachments[0x0][_0xc7788f(0x177)])throw new common_1[(_0xc7788f(0x1d2))](_0xc7788f(0x1bb),common_1[_0xc7788f(0x14d)][_0xc7788f(0x162)]);const {filename:_0x243ba6,url:_0x2905a1,width:_0x14afcf,height:_0x1a3632,size:_0x486a58}=attachments[0x0],_0xdfcaa6=this[_0xc7788f(0x19f)][_0xc7788f(0x163)]([_0xc7788f(0x143)]);let _0x9ea65='';(!Number(_0xdfcaa6)||Number(_0xdfcaa6)===0x0)&&(_0x9ea65=await this[_0xc7788f(0x155)][_0xc7788f(0x164)]({'filename':_0x243ba6,'url':_0x2905a1}),console['log'](_0xc7788f(0x1a9),_0x9ea65));const _0x3f020a={'curIp':(0x0,utils_1[_0xc7788f(0x1a5)])(_0x2135a0),'userId':_0x2135a0['user']['id'],'type':balance_constant_1['DeductionKey'][_0xc7788f(0x1c5)],'prompt':_0x18a377,'answer':_0x9ea65,'model':'mj','group':0x1,'extend':this[_0xc7788f(0x1d3)](JSON[_0xc7788f(0x1da)](_0x2633bc)),'message_id':_0x35aee3,'upscaleId':_0x35aee3,'variationId':_0x35aee3,'action':_0xc7788f(0x174),'orderId':_0x7926e3['orderId'],'isSaveImg':!Number(_0xdfcaa6)||Number(_0xdfcaa6)===0x0,'fileInfo':JSON['stringify']({'width':_0x14afcf,'height':_0x1a3632,'size':_0x486a58,'filename':_0x243ba6,'cosUrl':_0x9ea65})};return await this[_0xc7788f(0x158)][_0xc7788f(0x14c)](_0x3f020a),_0x9ea65;}catch(_0x4d15b6){console[_0xc7788f(0x171)](_0xc7788f(0x14b),_0x4d15b6),this['queueCount']--,this[_0xc7788f(0x1bc)]<0x0&&(this['queueCount']=0x0),console[_0xc7788f(0x171)](_0xc7788f(0x1d0),this['queueCount']);throw new common_1['HttpException'](_0x4d15b6[_0xc7788f(0x12d)],common_1[_0xc7788f(0x14d)][_0xc7788f(0x162)]);}}async[_0x218300(0x14a)](_0x575232){const _0x5a5bed=_0x218300,{message_id:_0x40ac70,custom_id:_0x4d50c6}=_0x575232,{application_id:_0x3bdbb7,guild_id:_0x1f55f5,channel_id:_0x113d31,session_id:_0x115457,version:_0x23c891,id:_0x5eb927,authorization:_0x3cc7c3,mjProxy:_0x40006f}=await this['getMjDefaultParams'](),_0x50532c=_0x40006f==0x1?'http://172.247.48.137:8000/mj/draw':_0x5a5bed(0x12e),_0x3d5d21={'authorization':_0x3cc7c3},_0x455f9d={'type':0x3,'guild_id':_0x1f55f5,'channel_id':_0x113d31,'message_flags':0x0,'message_id':_0x40ac70,'application_id':_0x3bdbb7,'session_id':_0x115457,'data':{'component_type':0x2,'custom_id':_0x4d50c6}};try{await axios_1[_0x5a5bed(0x12c)]['post'](_0x50532c,_0x455f9d,{'headers':_0x3d5d21}),console[_0x5a5bed(0x171)](_0x5a5bed(0x12b));}catch(_0xa643c9){console[_0x5a5bed(0x171)](_0x5a5bed(0x14b),_0xa643c9);throw new common_1[(_0x5a5bed(0x1d2))](_0x5a5bed(0x1b4),common_1[_0x5a5bed(0x14d)][_0x5a5bed(0x162)]);}}async[_0x218300(0x1c1)](_0x116d57,_0x55d30e){const _0x1f903b=_0x218300,{message_id:_0x469e16,custom_id:_0x203062,prompt:_0x1e3177,orderId:_0x187a29}=_0x116d57;let _0x1f11dc=null,_0x43e896=0x0;while(!_0x1f11dc&&_0x43e896<0xa){try{const _0xbc3e2=Date[_0x1f903b(0x18f)](),_0x3dd82d=await this['queryMessageList']();console['log']('第\x20'+(_0x43e896+0x1)+_0x1f903b(0x1ab)+_0x3dd82d[_0x1f903b(0x1d4)]);_0x3dd82d&&_0x3dd82d['length']&&(_0x1f11dc=await this[_0x1f903b(0x16e)](_0x3dd82d,_0x116d57,_0x55d30e));const _0x26e975=Date['now']()-_0xbc3e2,_0x2ad8ac=0xbb8;await this['sleep'](Math[_0x1f903b(0x147)](_0x2ad8ac-_0x26e975,0x0)),_0x43e896++;}catch(_0x7bd88a){console[_0x1f903b(0x1c6)]('查询期间出现错误：'+_0x7bd88a['message']);}}return _0x1f11dc;}async[_0x218300(0x12f)](_0x251f89,_0x4b6c6d){const _0x1112c1=_0x218300,{message_id:_0x2ca002,custom_id:_0xba365c,prompt:_0x1a2241,orderId:_0x14a6fc}=_0x251f89;console['log'](_0x1112c1(0x1dc));let _0x53dd76=null,_0x41dbae=0x0;while(!_0x53dd76&&_0x41dbae<0xa){try{console[_0x1112c1(0x171)]('第\x20'+(_0x41dbae+0x1)+_0x1112c1(0x15a));const _0x3994af=Date[_0x1112c1(0x18f)](),_0x342b=await this[_0x1112c1(0x1d6)]();_0x342b&&_0x342b[_0x1112c1(0x1d4)]&&(_0x53dd76=await this[_0x1112c1(0x182)](_0x342b,_0x251f89,_0x4b6c6d));const _0x24d957=Date[_0x1112c1(0x18f)]()-_0x3994af,_0x571563=0x1f40;await this[_0x1112c1(0x1bd)](Math[_0x1112c1(0x147)](_0x571563-_0x24d957,0x0)),_0x41dbae++;}catch(_0x1c5517){console[_0x1112c1(0x1c6)](_0x1112c1(0x186)+_0x1c5517[_0x1112c1(0x170)]);}}if(!_0x53dd76)throw new common_1[(_0x1112c1(0x1d2))](_0x1112c1(0x142),common_1[_0x1112c1(0x14d)][_0x1112c1(0x162)]);return _0x53dd76;}async[_0x218300(0x16e)](_0x11785d,_0x5958b7,_0x17cd2f){const _0x41caf5=_0x218300,{message_id:_0x51e8eb,custom_id:_0xddaf65,prompt:_0x21d0c6,orderId:_0x5383c3}=_0x5958b7,_0x5d26cd=_0x21d0c6[_0x41caf5(0x18e)](0x0,0xc);console[_0x41caf5(0x171)](_0x41caf5(0x198),_0x5d26cd);const _0x61c029=_0x11785d['find'](_0x3078ae=>{const _0x5159fd=_0x41caf5,{content:_0x199f47}=_0x3078ae;if(!this[_0x5159fd(0x157)](_0x199f47))return![];const {prompt:_0x3f524c,order:_0x2c4e56}=this[_0x5159fd(0x157)](_0x199f47);return _0x3f524c[_0x5159fd(0x15d)](_0x5d26cd)&&_0x5958b7[_0x5159fd(0x1e0)]===_0x2c4e56&&!_0x17cd2f[_0x5159fd(0x15d)](_0x3078ae['id']);});return _0x61c029;}async[_0x218300(0x182)](_0x24b362,_0x446fe9,_0x2862c5){const _0x4ccc45=_0x218300,{message_id:_0x2cb375,custom_id:_0x511d50,prompt:_0x3da5c8,orderId:_0x52d864}=_0x446fe9,_0x45714b=_0x3da5c8[_0x4ccc45(0x18e)](0x0,0xc),_0x1ce61a=_0x24b362['find'](_0x1b58e5=>{const _0x11f3bd=_0x4ccc45,{content:_0x7179f0}=_0x1b58e5,_0x3df996=_0x7179f0['match'](/\*\*(.+?)\*\*/),_0x1e4b15=_0x3df996?_0x3df996[0x1]:'';if(!_0x1e4b15)return![];return _0x1e4b15[_0x11f3bd(0x15d)](_0x45714b)&&!_0x2862c5[_0x11f3bd(0x15d)](_0x1b58e5['id']);});return _0x1ce61a;}async[_0x218300(0x1cf)](_0x162fbb,_0x5f02b8,_0x33f776){const _0x5dbff6=_0x218300,_0x59f5c2=await this[_0x5dbff6(0x1d6)](),_0x44ff7c=await this[_0x5dbff6(0x194)](_0x59f5c2,_0x33f776,_0x5f02b8);if(_0x44ff7c)return console[_0x5dbff6(0x171)]('有历史信息之间返回:\x20',_0x44ff7c),_0x44ff7c;const {application_id:_0x59b41d,guild_id:_0x3b93e3,channel_id:_0x3f65c9,session_id:_0x4acd54,version:_0x530239,id:_0x589b40,authorization:_0x1e9523,mjProxy:_0x1c8cf7}=await this[_0x5dbff6(0x1e1)](),_0x292507={'type':0x2,'application_id':_0x59b41d,'guild_id':_0x3b93e3,'channel_id':_0x3f65c9,'session_id':_0x4acd54,'data':{'version':_0x530239,'id':_0x589b40,'name':_0x5dbff6(0x192),'type':0x1,'options':[{'type':0x3,'name':_0x5dbff6(0x1b6),'value':_0x162fbb}],'attachments':[]}};try{const _0x46d613=_0x1c8cf7==0x1?_0x5dbff6(0x15e):_0x5dbff6(0x12e),_0x26d06e={'authorization':_0x1e9523},_0x4c66dd=await axios_1[_0x5dbff6(0x12c)][_0x5dbff6(0x1c2)](_0x46d613,_0x292507,{'headers':_0x26d06e});return console['log'](_0x5dbff6(0x1dd),_0x4c66dd['data']),![];}catch(_0x36b438){console['log']('axios:\x20',_0x36b438);throw new common_1[(_0x5dbff6(0x1d2))](_0x5dbff6(0x149),common_1[_0x5dbff6(0x14d)][_0x5dbff6(0x162)]);}}async[_0x218300(0x13b)](_0x49c3a7,_0x5e6f9e,_0x3216c4){const _0x1be2f8=_0x218300;console['log'](_0x1be2f8(0x13c));const _0x3a71d2=Date['now']();try{const _0x49b82b=0xd,_0x377730=0x2ee0,_0x1ba047=0x1388,_0x41b54b=0x3c*0x3e8;let _0x555344=0x0,_0x3f889b=![],_0x410622=null;while(!_0x410622&&_0x555344<_0x49b82b){console[_0x1be2f8(0x171)]('第\x20'+(_0x555344+0x1)+_0x1be2f8(0x127));Date[_0x1be2f8(0x18f)]()-_0x3a71d2>=_0x41b54b&&(_0x3f889b=!![]);await this[_0x1be2f8(0x1bd)](_0x3f889b?_0x1ba047:_0x377730);const _0x3daccd=await this[_0x1be2f8(0x1d6)]();_0x410622=await this[_0x1be2f8(0x194)](_0x3daccd,_0x3216c4,_0x5e6f9e),_0x555344++;}if(!_0x410622)throw new common_1[(_0x1be2f8(0x1d2))](_0x1be2f8(0x1a0),common_1[_0x1be2f8(0x14d)]['BAD_REQUEST']);const _0x19c799=Date[_0x1be2f8(0x18f)]();return console[_0x1be2f8(0x171)](_0x1be2f8(0x150)+Math[_0x1be2f8(0x15f)]((_0x19c799-_0x3a71d2)/0x3e8)+'\x20S'),_0x410622;}catch(_0x581dcb){console[_0x1be2f8(0x1c6)](_0x581dcb[_0x1be2f8(0x170)]);throw new common_1[(_0x1be2f8(0x1d2))](_0x1be2f8(0x1db),common_1[_0x1be2f8(0x14d)][_0x1be2f8(0x193)]);}}async[_0x218300(0x194)](_0x300458,_0x5d8d73,_0x1f9127){const _0x321789=_0x218300;if(!_0x300458||!_0x300458[_0x321789(0x1d4)])return;console['log'](_0x321789(0x13d),_0x5d8d73);const _0x58df98=_0x300458[_0x321789(0x1b2)](_0x4a8133=>{const _0x3b329b=_0x321789,{attachments:attachments=[],content:_0x5db16f,edited_timestamp:_0x9e37e4}=_0x4a8133;return _0x5db16f[_0x3b329b(0x15d)](_0x5d8d73)&&attachments[_0x3b329b(0x1d4)]>0x0&&!_0x9e37e4&&!_0x1f9127['includes'](_0x4a8133['id']);});return _0x58df98||null;}async[_0x218300(0x1d6)](){const _0x45d310=_0x218300;try{const {application_id:_0x59c0ce,guild_id:_0x5bae91,channel_id:_0x54f365,session_id:_0x2e1e76,version:_0x166e2d,id:_0x313c09,authorization:_0x1f616e,mjProxy:_0x3a1f73}=await this[_0x45d310(0x1e1)](),_0x5ced0a=_0x3a1f73==0x1?_0x45d310(0x1b8)+_0x54f365:_0x45d310(0x16f)+_0x54f365+'/messages?limit=50',_0x207feb={'authorization':_0x1f616e},_0x45bddc=await axios_1[_0x45d310(0x12c)]['get'](_0x5ced0a,{'headers':_0x207feb});return _0x45bddc[_0x45d310(0x180)];}catch(_0x4cc732){console[_0x45d310(0x171)](_0x45d310(0x19d),_0x4cc732);throw new common_1[(_0x45d310(0x1d2))](_0x45d310(0x19c),common_1[_0x45d310(0x14d)][_0x45d310(0x162)]);}}async['sleep'](_0x54ee88){return new Promise(_0xe50ab2=>setTimeout(_0xe50ab2,_0x54ee88));}[_0x218300(0x157)](_0x15a3e4){const _0x1a44a3=_0x15a3e4['match'](/\*\*(.+?)\*\*/),_0x354a33=_0x15a3e4['match'](/- Image #(\d+)/);if(!_0x1a44a3||!_0x354a33)return null;const _0x5827d0=_0x1a44a3[0x1],_0x3eeed5=parseInt(_0x354a33[0x1]);return{'prompt':_0x5827d0,'order':_0x3eeed5};}async[_0x218300(0x1e1)](){const _0x46ee12=_0x218300,_0x2c3fda=await this[_0x46ee12(0x19f)]['getConfigs']([_0x46ee12(0x18c),_0x46ee12(0x1b1),_0x46ee12(0x152),'mjChannelId',_0x46ee12(0x134),_0x46ee12(0x136),_0x46ee12(0x17c),_0x46ee12(0x199),_0x46ee12(0x128)]),_0x11f539={'application_id':_0x2c3fda[_0x46ee12(0x1b1)],'guild_id':_0x2c3fda['mjGuildId'],'channel_id':_0x2c3fda['mjChannelId'],'session_id':_0x2c3fda[_0x46ee12(0x134)],'version':_0x2c3fda[_0x46ee12(0x136)],'id':_0x2c3fda[_0x46ee12(0x18c)],'authorization':_0x2c3fda[_0x46ee12(0x17c)],'mjRateLimit':_0x2c3fda['mjRateLimit'],'mjProxy':_0x2c3fda[_0x46ee12(0x128)]||0x0};return _0x11f539;}['removeEmoji'](_0x55473){const _0x14624d=/[\uD800-\uDBFF][\uDC00-\uDFFF]/g;return _0x55473['replace'](_0x14624d,'');}async[_0x218300(0x1d7)](_0x4a009b){const _0x24531d=_0x218300,_0x37d34a=await this[_0x24531d(0x16b)][_0x24531d(0x18b)]({'where':{'userId':_0x4a009b[_0x24531d(0x179)]['id']}})[_0x24531d(0x132)](_0x3bfb4a=>{const _0x2dc365=_0x24531d;common_1['Logger'][_0x2dc365(0x1c6)](_0x3bfb4a);});console[_0x24531d(0x171)](_0x37d34a);if(!_0x37d34a)return![];const {id:_0x416fe7,balance:_0x38da32}=_0x37d34a;if(!_0x38da32||_0x37d34a?.[_0x24531d(0x17f)]<0x1)throw new common_1[(_0x24531d(0x1d2))](_0x24531d(0x18d),common_1[_0x24531d(0x14d)][_0x24531d(0x162)]);return!![];}async[_0x218300(0x17b)](_0x1c0e20){const _0x50c242=_0x218300,{id:_0x2c7a93,role:_0x2181db}=_0x1c0e20[_0x50c242(0x179)];!this['freeQueueUsers'][_0x2c7a93]?this[_0x50c242(0x151)][_0x2c7a93]=0x1:this[_0x50c242(0x151)][_0x2c7a93]=this[_0x50c242(0x151)][_0x2c7a93]+0x1,console[_0x50c242(0x171)](_0x50c242(0x1ba)+_0x2c7a93+_0x50c242(0x13f),this['freeQueueUsers'][_0x2c7a93]);}async[_0x218300(0x191)](_0x411e1){const _0x3435fb=_0x218300,{id:_0x150481,role:_0x13601f}=_0x411e1['user'];if([_0x3435fb(0x17a),_0x3435fb(0x1c8)][_0x3435fb(0x15d)](_0x13601f))return!![];const {mjRateLimit:_0x2500f5}=await this[_0x3435fb(0x1e1)]();if(this[_0x3435fb(0x1df)][_0x150481]){const _0x2b2278=this[_0x3435fb(0x1df)][_0x150481];if(_0x2b2278>Date[_0x3435fb(0x18f)]()){console[_0x3435fb(0x171)](_0x3435fb(0x1d5)+_0x150481+_0x3435fb(0x178));throw new common_1['HttpException'](_0x3435fb(0x1a4)+_0x2500f5+_0x3435fb(0x1e3),common_1[_0x3435fb(0x14d)]['BAD_REQUEST']);}else this['rateLimits'][_0x150481]=Date['now']()+Number(_0x2500f5)*0x3e8;}else{const _0x2f525b=Date[_0x3435fb(0x18f)]();this['rateLimits'][_0x150481]=_0x2f525b+0x3e8*Number(_0x2500f5);}}async[_0x218300(0x13a)](_0x5f3be1){const _0x4d54ca=_0x218300;await this[_0x4d54ca(0x16b)]['createQueryBuilder']()[_0x4d54ca(0x1aa)](balance_entity_1[_0x4d54ca(0x17d)])[_0x4d54ca(0x1a2)]({'balance':()=>_0x4d54ca(0x138)})[_0x4d54ca(0x153)]('userId\x20=\x20:userId',{'userId':_0x5f3be1['user']['id']})[_0x4d54ca(0x1c3)]();}async[_0x218300(0x1cc)](){return 0x1;}};MjService=__decorate([(0x0,common_1[_0x218300(0x1d8)])(),__param(0x0,(0x0,typeorm_2[_0x218300(0x166)])(chatLog_entity_1['ChatLogEntity'])),__param(0x1,(0x0,typeorm_2[_0x218300(0x166)])(balance_entity_1[_0x218300(0x17d)])),__metadata(_0x218300(0x189),[typeorm_1[_0x218300(0x173)],typeorm_1[_0x218300(0x173)],upload_service_1[_0x218300(0x1bf)],chatLog_service_1['ChatLogService'],globalConfig_service_1[_0x218300(0x140)],fanyi_service_1[_0x218300(0x176)],badwords_service_1['BadwordsService']])],MjService),exports[_0x218300(0x137)]=MjService;function _0x1b28(){const _0x7f4d8d=['uploadFileFromUrl','defineProperty','InjectRepository','历史记录中不存在当前图片、请确认您需要变换的图片是否存在','18UbGZjW','历史中存在当前图片、直接获取！','./../upload/upload.service','balanceEntity','当前提示词已经在任务队列中了、请勿重复提交。。。','绘制图片任务异常中断\x20队列-1:\x20','findCurrentEnlargeImgResult','https://discord.com/api/v9/channels/','message','log','getOwnPropertyDescriptor','Repository','enlarge','7099609YoliyC','FanyiService','url','\x20请求过于频繁！','user','admin','checkFree','mjAuthorization','BalanceEntity','__decorate','balance','data','放大图片任务结束\x20队列-1:\x20','findCurrentVariationImgResult','87nQcMOi','放大当前图片失败','typeorm','查询期间出现错误：','Not','@nestjs/typeorm','design:paramtypes','map','findOne','mjId','您当前暂无MJ绘画余额！！！','substring','now','24afOOcK','checkRateLimit','imagine','INTERNAL_SERVER_ERROR','findCurrentPromptResult','axios','draw','当前图片没有绘画信息、无法变体!','本次放大图片的id:\x20','mjRateLimit','./../globalConfig/globalConfig.service','开始请求变换图片\x20队列+1:\x20','查询绘制结果失败...','axios\x20get:\x20','../badwords/badwords.service','globalConfigService','绘画超时，请稍后再试！','发送放大指令成功','set','chatLogEntity','由于速率限制、当前普通用户限制为','getClientIp','fanyiService','push','checkBadWords','存入图片完成:\x20','update','\x20次开始查询\x20=>\x20当前查询结果：','variationId','3010326HKORJa','IsNull','prompt\x20','开始请求放大图片\x20队列+1:\x20','mjApplicationId','find','parse','放大单张图片请求失败...','onModuleInit','prompt','绘画失败','http://172.247.48.137:8000/mj/list?channel_id=','variationSingleImg','当前用户','变换当前图片失败','queueCount','sleep','badwordsService','UploadService','upscaleSingleImg','pollForUpscaleResult','post','execute','历史这些id已经被获取过了\x20不能拿了:\x20','PAINT_TYPE','error','拿到了远程地址:\x20','super','../../common/constants/balance.constant','6951005bzoDIg','convertToEnglish','test','function','变换图片任务结束\x20队列-1:\x20','sendDrawInteractions','变化图片任务异常中断\x20队列-1:\x20','enlargeWorking','HttpException','removeEmoji','length','当前用户\x20','queryMessageList','checkAuth','Injectable','metadata','stringify','网络连接失败，请稍后再试！','开始轮询单张变换图片结果','发送绘画指令结果:\x20','当前绘图任务满载、请排队等候、队列任务完成后即可开始您的任务...','rateLimits','orderId','getMjDefaultParams','handleDrawTest','秒请求一次、请合理使用！','\x20次开始查询','mjProxy','filter','object','绘图指令完成','default','response','https://discord.com/api/v9/interactions','pollForVariationResult','createRandomUid','历史记录中不存在当前图片、请确认您放大的图片是否存在','catch','components','mjSessionId','Like','mjVersion','MjService','balance\x20-\x201','../../common/utils','deductBalance','pollForResult','开始查询绘画结果轮询','本次比对的随机ID:\x20','baiduFanyiSecret','使用的次数：','GlobalConfigService','116644IHgIcn','变换当前图片超时！','mjNotSaveImg','../chatLog/chatLog.service','当前图片已经放大过了、请勿重复放大!','开始请求用户','max','decorate','绘画请求失败、当前使用人数过多、请稍后试试吧、排队中...','sendSmInteractions','error:\x20','saveChatLog','HttpStatus','124DFBMII','8215930sQPbCb','本次绘图耗时:\x20','freeQueueUsers','mjGuildId','where','放大custom_id:\x20','uploadService','绘制图片任务结束\x20队列-1:\x20','extractContent','chatLogService','drawWorking','\x20次开始查询[变换图片]','message_id','3715803jPZbaJ','includes','http://172.247.48.137:8000/mj/draw','floor','9488hHhuur','\x20队列+1:\x20','BAD_REQUEST','getConfigs'];_0x1b28=function(){return _0x7f4d8d;};return _0x1b28();}