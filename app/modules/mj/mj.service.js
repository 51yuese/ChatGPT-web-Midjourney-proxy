'use strict';const _0x29cd62=_0x3872;(function(_0x3266d7,_0x46bb98){const _0xa81e6b=_0x3872,_0x5508a9=_0x3266d7();while(!![]){try{const _0x2d8b73=-parseInt(_0xa81e6b(0x214))/0x1*(-parseInt(_0xa81e6b(0x24e))/0x2)+parseInt(_0xa81e6b(0x207))/0x3*(parseInt(_0xa81e6b(0x20e))/0x4)+-parseInt(_0xa81e6b(0x24a))/0x5+parseInt(_0xa81e6b(0x1fd))/0x6+-parseInt(_0xa81e6b(0x1c3))/0x7*(parseInt(_0xa81e6b(0x262))/0x8)+-parseInt(_0xa81e6b(0x218))/0x9+parseInt(_0xa81e6b(0x205))/0xa*(parseInt(_0xa81e6b(0x25b))/0xb);if(_0x2d8b73===_0x46bb98)break;else _0x5508a9['push'](_0x5508a9['shift']());}catch(_0xdb0d73){_0x5508a9['push'](_0x5508a9['shift']());}}}(_0x4890,0x96490));function _0x3872(_0x2e5636,_0xe110c9){const _0x489007=_0x4890();return _0x3872=function(_0x387274,_0x954ba4){_0x387274=_0x387274-0x1c2;let _0x1cbd77=_0x489007[_0x387274];return _0x1cbd77;},_0x3872(_0x2e5636,_0xe110c9);}var __decorate=this&&this[_0x29cd62(0x215)]||function(_0x23b415,_0xcb9b7,_0x4d200a,_0x5f00ad){const _0x55b14a=_0x29cd62;var _0x2a109a=arguments[_0x55b14a(0x26b)],_0x1e91a0=_0x2a109a<0x3?_0xcb9b7:_0x5f00ad===null?_0x5f00ad=Object[_0x55b14a(0x242)](_0xcb9b7,_0x4d200a):_0x5f00ad,_0x21c623;if(typeof Reflect===_0x55b14a(0x227)&&typeof Reflect[_0x55b14a(0x23a)]===_0x55b14a(0x1f6))_0x1e91a0=Reflect['decorate'](_0x23b415,_0xcb9b7,_0x4d200a,_0x5f00ad);else{for(var _0x4a5eb5=_0x23b415[_0x55b14a(0x26b)]-0x1;_0x4a5eb5>=0x0;_0x4a5eb5--)if(_0x21c623=_0x23b415[_0x4a5eb5])_0x1e91a0=(_0x2a109a<0x3?_0x21c623(_0x1e91a0):_0x2a109a>0x3?_0x21c623(_0xcb9b7,_0x4d200a,_0x1e91a0):_0x21c623(_0xcb9b7,_0x4d200a))||_0x1e91a0;}return _0x2a109a>0x3&&_0x1e91a0&&Object[_0x55b14a(0x22c)](_0xcb9b7,_0x4d200a,_0x1e91a0),_0x1e91a0;},__metadata=this&&this[_0x29cd62(0x1dd)]||function(_0x8d42c5,_0x4dae85){const _0x4b4984=_0x29cd62;if(typeof Reflect===_0x4b4984(0x227)&&typeof Reflect[_0x4b4984(0x1c9)]===_0x4b4984(0x1f6))return Reflect[_0x4b4984(0x1c9)](_0x8d42c5,_0x4dae85);},__param=this&&this['__param']||function(_0x4531a0,_0x1cf09d){return function(_0x30d14e,_0x4008cc){_0x1cf09d(_0x30d14e,_0x4008cc,_0x4531a0);};};Object[_0x29cd62(0x22c)](exports,_0x29cd62(0x223),{'value':!![]}),exports['MjService']=void 0x0;const globalConfig_service_1=require(_0x29cd62(0x1d6)),upload_service_1=require(_0x29cd62(0x244)),common_1=require(_0x29cd62(0x236)),axios_1=require('axios'),chatLog_service_1=require('../chatLog/chatLog.service'),balance_constant_1=require(_0x29cd62(0x245)),utils_1=require(_0x29cd62(0x221)),chatLog_entity_1=require(_0x29cd62(0x20a)),typeorm_1=require('typeorm'),typeorm_2=require(_0x29cd62(0x1d2)),balance_entity_1=require('../userBalance/balance.entity'),fanyi_service_1=require(_0x29cd62(0x1c6)),badwords_service_1=require(_0x29cd62(0x208));function _0x4890(){const _0x2a86a1=['mjApplicationId','3netjyv','../badwords/badwords.service','拿到了远程地址:\x20','../chatLog/chatLog.entity','randomId:\x20','queryMessageList','当前用户','1654364uzNcoc','ChatLogService','includes','stringify','getConfigs','http://172.247.48.137:8000/mj/draw','43867JaysEi','__decorate','deductBalance','balanceEntity','10277910tzgEOX','chatLogEntity','url','checkFree','mjVersion','checkAuth','uploadService','绘画超时，请稍后再试！','error','../../common/utils','开始请求放大图片\x20队列+1:\x20','__esModule','orderId','\x20队列+1:\x20','enlarge','object','使用的次数：','user','历史中存在当前图片、直接获取！','mjProxy','defineProperty','max','map','mjId','getMjDefaultParams','convertToEnglish','有历史信息之间返回:\x20','mjSessionId','绘制图片任务结束\x20队列-1:\x20','checkRateLimit','@nestjs/common','放大单张图片请求失败...','get','HttpException','decorate','where','balance\x20-\x201','PAINT_TYPE','now','绘画失败','ChatLogEntity','message','getOwnPropertyDescriptor','upscaleSingleImg','./../upload/upload.service','../../common/constants/balance.constant','sendDrawInteractions','放大当前图片失败','BadwordsService','rateLimits','6099355PSsfmH','BalanceEntity','DeductionKey','replace','26DSUJYm','findCurrentPromptResult','axios\x20get:\x20','update','Injectable','\x20次开始查询','saveChatLog','/messages?limit=50','badwordsService','userId\x20=\x20:userId','sendSmInteractions','fanyiService','freeQueueUsers','33fXKSHS','uploadFileFromUrl','https://discord.com/api/v9/interactions','prompt','match','parse','extractContent','24ZdjwBQ','GlobalConfigService','发送放大指令成功','当前绘图任务满载、请排队等候、队列任务完成后即可开始您的任务...','历史记录中不存在当前图片、请确认您需要变换的图片是否存在','data','变换当前图片失败','error:\x20','drawWorking','length','design:paramtypes','axios:\x20','2327395aZJaBD','find','InjectRepository','../fanyi/fanyi.service','BAD_REQUEST','mjGuildId','metadata','pollForVariationResult','execute','\x20次开始查询[变换图片]','开始请求变换图片\x20队列+1:\x20','response','变换当前图片超时！','mjRateLimit','放大custom_id:\x20','@nestjs/typeorm','createQueryBuilder','开始轮询单张变换图片结果','globalConfigService','./../globalConfig/globalConfig.service','findCurrentVariationImgResult','post','绘画任务开始','IsNull','本次放大图片的id:\x20','filter','__metadata','substring','removeEmoji','绘制图片任务异常中断\x20队列-1:\x20','查询期间出现错误：','floor','FanyiService','查询绘制结果失败...','当前图片没有绘画信息、无法变体!','UploadService','getClientIp','chatLogService','开始请求用户','findOne','https://discord.com/api/v9/channels/','当前提示词已经在任务队列中了、请勿重复提交。。。','pollForUpscaleResult','push','Like','log','本次比对的随机ID:\x20','本次绘图耗时:\x20','enlargeWorking','历史记录中不存在当前图片、请确认您放大的图片是否存在','HttpStatus','function','mjNotSaveImg','message_id','imagine','admin','\x20请求过于频繁！','queueCount','5325270uypASc','variationId','findCurrentEnlargeImgResult','当前用户\x20','balance','prompt\x20-------->\x20\x20','mjDraw','sleep','7011590CSRGHv'];_0x4890=function(){return _0x2a86a1;};return _0x4890();}let MjService=class MjService{constructor(_0xcdaf46,_0x1e8574,_0x5c6663,_0x10acc8,_0xed9c91,_0x1d5bc6,_0x46772a){const _0x4d55f1=_0x29cd62;this[_0x4d55f1(0x219)]=_0xcdaf46,this[_0x4d55f1(0x217)]=_0x1e8574,this[_0x4d55f1(0x21e)]=_0x5c6663,this['chatLogService']=_0x10acc8,this[_0x4d55f1(0x1d5)]=_0xed9c91,this[_0x4d55f1(0x259)]=_0x1d5bc6,this[_0x4d55f1(0x256)]=_0x46772a,this['rateLimits']={},this[_0x4d55f1(0x26a)]=[],this[_0x4d55f1(0x1f3)]=[],this['queueCount']=0x0,this['freeQueueUsers']={};}async[_0x29cd62(0x203)](_0x15f520){const _0x8b9489=_0x29cd62,{jobId:_0x3beb1a,prompt:_0x4bab12,startTime:_0x57a169,userId:_0xccdedc}=_0x15f520;return console[_0x8b9489(0x1f0)](_0x8b9489(0x1d9),'mjservice'),await new Promise(_0x24303f=>setTimeout(_0x24303f,0x1388)),{'a':0x1,'b':0x2};}async['draw'](_0x38bdd0,_0x13a601){const _0x578db6=_0x29cd62;await this[_0x578db6(0x21d)](_0x13a601),await this['badwordsService']['checkBadWords'](_0x38bdd0[_0x578db6(0x25e)],_0x13a601[_0x578db6(0x229)]['id']);const _0x2d8be3=_0x38bdd0[_0x578db6(0x25e)];let _0x48a79a=_0x38bdd0['prompt'];const {baiduFanyiAppId:_0x21cbf2,baiduFanyiSecret:_0x59dfae}=await this['globalConfigService'][_0x578db6(0x212)](['baiduFanyiAppId','baiduFanyiSecret']);_0x21cbf2&&_0x59dfae&&(_0x48a79a=await this[_0x578db6(0x259)][_0x578db6(0x231)](_0x2d8be3));const _0x9842c0='['+(0x0,utils_1['createRandomUid'])()+']',_0x28d21d=_0x9842c0+'\x20'+_0x48a79a;console[_0x578db6(0x1f0)](_0x578db6(0x20b),_0x9842c0),console[_0x578db6(0x1f0)](_0x578db6(0x202),_0x28d21d);const _0xabddbd=this['drawWorking'][_0x578db6(0x1c4)](_0x6321f9=>_0x6321f9[_0x578db6(0x210)](_0x38bdd0[_0x578db6(0x25e)]));if(_0xabddbd)throw new common_1['HttpException'](_0x578db6(0x1ec),common_1[_0x578db6(0x1f5)]['BAD_REQUEST']);if(this[_0x578db6(0x1fc)]>=0x3)throw new common_1['HttpException']('当前绘图任务满载、请排队等候、队列任务完成后即可开始您的任务...',common_1['HttpStatus']['BAD_REQUEST']);await this[_0x578db6(0x235)](_0x13a601),this[_0x578db6(0x1fc)]++,console['log'](_0x578db6(0x1e9)+_0x13a601[_0x578db6(0x229)]['id']+_0x578db6(0x225),this[_0x578db6(0x1fc)]);try{const _0x1227fa=await this[_0x578db6(0x219)][_0x578db6(0x1c4)]({'where':{'prompt':(0x0,typeorm_1[_0x578db6(0x1ef)])('%'+_0x28d21d+'%')}}),_0x121bb7=_0x1227fa[_0x578db6(0x22e)](_0x4246eb=>_0x4246eb[_0x578db6(0x1f8)]);this[_0x578db6(0x26a)][_0x578db6(0x1ee)](_0x28d21d);let _0x4bbd30;const _0x5e7a7a=await this['sendDrawInteractions'](_0x28d21d,_0x121bb7,_0x9842c0);_0x5e7a7a?(console[_0x578db6(0x1f0)](_0x578db6(0x22a)),_0x4bbd30=_0x5e7a7a):_0x4bbd30=await this['pollForResult'](_0x28d21d,_0x121bb7,_0x9842c0);this[_0x578db6(0x1fc)]--,this[_0x578db6(0x1fc)]<0x0&&(this[_0x578db6(0x1fc)]=0x0),console['log'](_0x578db6(0x234),this['queueCount']);const {id:_0x34ef10,content:_0x435505,channel_id:_0x472ae7,attachments:attachments=[],timestamp:_0x195fad}=_0x4bbd30;if(!attachments[_0x578db6(0x26b)]||!attachments[0x0][_0x578db6(0x21a)])throw new common_1[(_0x578db6(0x239))](_0x578db6(0x23f),common_1[_0x578db6(0x1f5)]['BAD_REQUEST']);const {filename:_0x53b2e6,url:_0x3295ce,width:_0x4d4b9d,height:_0x25a54e,size:_0x583f92}=attachments[0x0];console[_0x578db6(0x1f0)](_0x578db6(0x209),_0x3295ce);const _0x22b90e=this[_0x578db6(0x1d5)][_0x578db6(0x212)](['mjNotSaveImg']);let _0x496713='';(!Number(_0x22b90e)||Number(_0x22b90e)===0x0)&&(_0x496713=await this[_0x578db6(0x21e)][_0x578db6(0x25c)]({'filename':_0x53b2e6,'url':_0x3295ce}),console[_0x578db6(0x1f0)]('存入图片完成:\x20',_0x496713));const _0x4a9c51={'curIp':(0x0,utils_1[_0x578db6(0x1e7)])(_0x13a601),'userId':_0x13a601[_0x578db6(0x229)]['id'],'type':balance_constant_1[_0x578db6(0x24c)][_0x578db6(0x23d)],'prompt':_0x28d21d,'answer':_0x496713,'model':'mj','extend':this[_0x578db6(0x1df)](JSON[_0x578db6(0x211)](_0x4bbd30)),'message_id':_0x34ef10,'variationId':_0x34ef10,'upscaleId':_0x34ef10,'group':0x1,'isSaveImg':!Number(_0x22b90e)||Number(_0x22b90e)===0x0,'fileInfo':JSON[_0x578db6(0x211)]({'width':_0x4d4b9d,'height':_0x25a54e,'size':_0x583f92,'filename':_0x53b2e6,'cosUrl':_0x496713})};return await this[_0x578db6(0x1e8)]['saveChatLog'](_0x4a9c51),await this[_0x578db6(0x216)](_0x13a601),this[_0x578db6(0x26a)]=this[_0x578db6(0x26a)][_0x578db6(0x1dc)](_0x198927=>_0x198927!==_0x38bdd0[_0x578db6(0x25e)]),_0x496713;}catch(_0x57d67f){this[_0x578db6(0x1fc)]--,this[_0x578db6(0x1fc)]<0x0&&(this['queueCount']=0x0),console[_0x578db6(0x1f0)](_0x578db6(0x1e0),this[_0x578db6(0x1fc)]),this[_0x578db6(0x26a)]=this[_0x578db6(0x26a)][_0x578db6(0x1dc)](_0x20227f=>_0x20227f!==_0x38bdd0['prompt']);throw new common_1['HttpException'](_0x57d67f[_0x578db6(0x1ce)],common_1['HttpStatus'][_0x578db6(0x1c7)]);}}async[_0x29cd62(0x243)](_0x3d3dc7,_0x4ee241){const _0x52e4ab=_0x29cd62;if(this['queueCount']>=0x3)throw new common_1[(_0x52e4ab(0x239))](_0x52e4ab(0x265),common_1[_0x52e4ab(0x1f5)][_0x52e4ab(0x1c7)]);this['queueCount']++,console[_0x52e4ab(0x1f0)]('用户'+_0x4ee241[_0x52e4ab(0x229)]['id']+_0x52e4ab(0x222),this[_0x52e4ab(0x1fc)]);const {message_id:_0x43c4d8,orderId:_0x319bfe}=_0x3d3dc7;try{const _0x1e90aa=await this['chatLogEntity'][_0x52e4ab(0x1ea)]({'where':{'message_id':_0x43c4d8}});if(!_0x1e90aa)throw new common_1['HttpException'](_0x52e4ab(0x1f4),common_1[_0x52e4ab(0x1f5)][_0x52e4ab(0x1c7)]);const _0x3f4105=await this['chatLogEntity'][_0x52e4ab(0x1ea)]({'where':{'upscaleId':_0x43c4d8,'action':_0x52e4ab(0x226),'orderId':_0x319bfe}});if(_0x3f4105)throw new common_1[(_0x52e4ab(0x239))]('当前图片已经放大过了、请勿重复放大!',common_1[_0x52e4ab(0x1f5)]['BAD_REQUEST']);const {prompt:_0x25288f,extend:_0x2c0745}=_0x1e90aa,_0xa90c94=JSON[_0x52e4ab(0x260)](_0x2c0745),{components:components=[]}=_0xa90c94;if(!components[_0x52e4ab(0x26b)])throw new common_1['HttpException']('当前图片没有绘画信息、无法放大!',common_1[_0x52e4ab(0x1f5)]['BAD_REQUEST']);const _0xaad68c=components[0x0]['components'][_0x319bfe-0x1],{custom_id:_0x38bf04}=_0xaad68c;console[_0x52e4ab(0x1f0)](_0x52e4ab(0x1d1),_0x38bf04);const _0xc1a40f={'message_id':_0x43c4d8,'custom_id':_0x38bf04,'prompt':_0x25288f,'orderId':_0x319bfe};await this[_0x52e4ab(0x258)](_0xc1a40f),console[_0x52e4ab(0x1f0)](_0x52e4ab(0x264));const _0x2e754d=await this['chatLogEntity'][_0x52e4ab(0x1c4)]({'where':{'prompt':(0x0,typeorm_1['Like'])('%'+_0x25288f+'%')}}),_0x56604b=_0x2e754d['map'](_0xf024eb=>_0xf024eb[_0x52e4ab(0x1f8)]);console[_0x52e4ab(0x1f0)]('历史这些id已经被获取过了\x20不能拿了:\x20',_0x56604b);const _0x4540f0=await this[_0x52e4ab(0x1ed)](_0xc1a40f,_0x56604b);this['queueCount']--,this[_0x52e4ab(0x1fc)]<0x0&&(this[_0x52e4ab(0x1fc)]=0x0),console[_0x52e4ab(0x1f0)]('放大图片任务结束\x20队列-1:\x20',this[_0x52e4ab(0x1fc)]);const {id:_0x2a4567,content:_0x337fb7,channel_id:_0x5e598b,attachments:attachments=[],timestamp:_0x4ea70f}=_0x4540f0;if(!attachments[_0x52e4ab(0x26b)]||!attachments[0x0]['url'])throw new common_1[(_0x52e4ab(0x239))](_0x52e4ab(0x247),common_1['HttpStatus'][_0x52e4ab(0x1c7)]);const {filename:_0x8924f2,url:_0x168568,width:_0x1aafd8,height:_0x5e88bf,size:_0x1577a4}=attachments[0x0],_0x131aa8=this[_0x52e4ab(0x1d5)][_0x52e4ab(0x212)](['mjNotSaveImg']);let _0x39add8='';(!Number(_0x131aa8)||Number(_0x131aa8)===0x0)&&(_0x39add8=await this['uploadService'][_0x52e4ab(0x25c)]({'filename':_0x8924f2,'url':_0x168568}),console['log']('存入图片完成:\x20',_0x39add8));const _0x5a1314={'curIp':(0x0,utils_1[_0x52e4ab(0x1e7)])(_0x4ee241),'userId':_0x4ee241[_0x52e4ab(0x229)]['id'],'type':balance_constant_1['DeductionKey'][_0x52e4ab(0x23d)],'prompt':_0x25288f,'answer':_0x39add8,'model':'mj','extend':this['removeEmoji'](JSON[_0x52e4ab(0x211)](_0x4540f0)),'message_id':_0x43c4d8,'upscaleId':_0x2a4567,'variationId':_0x2a4567,'action':_0x52e4ab(0x226),'orderId':_0xc1a40f[_0x52e4ab(0x224)],'isSaveImg':!Number(_0x131aa8)||Number(_0x131aa8)===0x0,'fileInfo':JSON[_0x52e4ab(0x211)]({'width':_0x1aafd8,'height':_0x5e88bf,'size':_0x1577a4,'filename':_0x8924f2,'cosUrl':_0x39add8})};return await this[_0x52e4ab(0x1e8)][_0x52e4ab(0x254)](_0x5a1314),_0x39add8;}catch(_0x5a5686){console[_0x52e4ab(0x1f0)](_0x52e4ab(0x269),_0x5a5686),this['queueCount']--,this[_0x52e4ab(0x1fc)]<0x0&&(this['queueCount']=0x0),console[_0x52e4ab(0x1f0)]('放大图片任务异常中断\x20队列-1:\x20',this[_0x52e4ab(0x1fc)]);throw new common_1[(_0x52e4ab(0x239))](_0x5a5686[_0x52e4ab(0x1ce)],common_1[_0x52e4ab(0x1f5)]['BAD_REQUEST']);}}async['variationSingleImg'](_0x25807a,_0x900613){const _0x2230f3=_0x29cd62;if(this[_0x2230f3(0x1fc)]>=0x3)throw new common_1[(_0x2230f3(0x239))](_0x2230f3(0x265),common_1[_0x2230f3(0x1f5)][_0x2230f3(0x1c7)]);await this[_0x2230f3(0x21d)](_0x900613),await this[_0x2230f3(0x235)](_0x900613),this[_0x2230f3(0x1fc)]++,console[_0x2230f3(0x1f0)]('用户'+_0x900613['user']['id']+_0x2230f3(0x1cd),this[_0x2230f3(0x1fc)]);const {message_id:_0x5c3eed,orderId:_0x10abab}=_0x25807a;try{const _0x257b25=await this['chatLogEntity'][_0x2230f3(0x1ea)]({'where':{'message_id':_0x5c3eed}});if(!_0x257b25)throw new common_1[(_0x2230f3(0x239))](_0x2230f3(0x266),common_1[_0x2230f3(0x1f5)][_0x2230f3(0x1c7)]);const {prompt:_0x157c09,extend:_0x191c0e}=_0x257b25,_0x2bd7f0=JSON[_0x2230f3(0x260)](_0x191c0e),{components:components=[]}=_0x2bd7f0;if(!components['length'])throw new common_1[(_0x2230f3(0x239))](_0x2230f3(0x1e5),common_1['HttpStatus'][_0x2230f3(0x1c7)]);const _0x35df63=components[0x1]['components'][_0x10abab-0x1],{custom_id:_0x2f48e3}=_0x35df63,_0x5f1356=await this['chatLogEntity'][_0x2230f3(0x1c4)]({'where':{'variationId':(0x0,typeorm_1['Not'])((0x0,typeorm_1[_0x2230f3(0x1da)])()),'prompt':(0x0,typeorm_1['Like'])('%'+_0x157c09+'%')}}),_0x2c8bee=_0x5f1356[_0x2230f3(0x22e)](_0xfc7571=>_0xfc7571[_0x2230f3(0x1fe)]),_0xd72d0e={'message_id':_0x5c3eed,'custom_id':_0x2f48e3,'prompt':_0x157c09,'orderId':_0x10abab};await this[_0x2230f3(0x258)](_0xd72d0e);const _0x429b53=await this[_0x2230f3(0x1ca)](_0xd72d0e,_0x2c8bee);this[_0x2230f3(0x1fc)]--,this[_0x2230f3(0x1fc)]<0x0&&(this[_0x2230f3(0x1fc)]=0x0),console[_0x2230f3(0x1f0)]('变换图片任务结束\x20队列-1:\x20',this[_0x2230f3(0x1fc)]);const {id:_0x4a3c51,content:_0x39231f,channel_id:_0x207310,attachments:attachments=[],timestamp:_0xfaa71b}=_0x429b53;if(!attachments['length']||!attachments[0x0][_0x2230f3(0x21a)])throw new common_1[(_0x2230f3(0x239))](_0x2230f3(0x268),common_1[_0x2230f3(0x1f5)][_0x2230f3(0x1c7)]);const {filename:_0x204690,url:_0x41c99d,width:_0x331921,height:_0x3c84c3,size:_0x462cec}=attachments[0x0],_0x4c1c28=this['globalConfigService'][_0x2230f3(0x212)]([_0x2230f3(0x1f7)]);let _0x3eb663='';(!Number(_0x4c1c28)||Number(_0x4c1c28)===0x0)&&(_0x3eb663=await this[_0x2230f3(0x21e)]['uploadFileFromUrl']({'filename':_0x204690,'url':_0x41c99d}),console[_0x2230f3(0x1f0)]('存入图片完成:\x20',_0x3eb663));const _0x305e93={'curIp':(0x0,utils_1[_0x2230f3(0x1e7)])(_0x900613),'userId':_0x900613[_0x2230f3(0x229)]['id'],'type':balance_constant_1[_0x2230f3(0x24c)][_0x2230f3(0x23d)],'prompt':_0x157c09,'answer':_0x3eb663,'model':'mj','group':0x1,'extend':this['removeEmoji'](JSON['stringify'](_0x429b53)),'message_id':_0x4a3c51,'upscaleId':_0x4a3c51,'variationId':_0x4a3c51,'action':_0x2230f3(0x226),'orderId':_0xd72d0e[_0x2230f3(0x224)],'isSaveImg':!Number(_0x4c1c28)||Number(_0x4c1c28)===0x0,'fileInfo':JSON[_0x2230f3(0x211)]({'width':_0x331921,'height':_0x3c84c3,'size':_0x462cec,'filename':_0x204690,'cosUrl':_0x3eb663})};return await this[_0x2230f3(0x1e8)]['saveChatLog'](_0x305e93),_0x3eb663;}catch(_0x470192){console['log'](_0x2230f3(0x269),_0x470192),this[_0x2230f3(0x1fc)]--,this[_0x2230f3(0x1fc)]<0x0&&(this['queueCount']=0x0),console[_0x2230f3(0x1f0)]('变化图片任务异常中断\x20队列-1:\x20',this[_0x2230f3(0x1fc)]);throw new common_1['HttpException'](_0x470192[_0x2230f3(0x1ce)],common_1[_0x2230f3(0x1f5)][_0x2230f3(0x1c7)]);}}async['sendSmInteractions'](_0x538fec){const _0x478b52=_0x29cd62,{message_id:_0x4f4be4,custom_id:_0x1898cd}=_0x538fec,{application_id:_0x9c088f,guild_id:_0x1204bf,channel_id:_0x196c03,session_id:_0x1a184a,version:_0x164ca3,id:_0x129e0f,authorization:_0x399b33,mjProxy:_0x1e6a61}=await this[_0x478b52(0x230)](),_0x305800=_0x1e6a61==0x1?_0x478b52(0x213):_0x478b52(0x25d),_0xfcb8cb={'authorization':_0x399b33},_0x141567={'type':0x3,'guild_id':_0x1204bf,'channel_id':_0x196c03,'message_flags':0x0,'message_id':_0x4f4be4,'application_id':_0x9c088f,'session_id':_0x1a184a,'data':{'component_type':0x2,'custom_id':_0x1898cd}};try{await axios_1['default'][_0x478b52(0x1d8)](_0x305800,_0x141567,{'headers':_0xfcb8cb}),console['log']('绘图指令完成');}catch(_0x5ead69){console['log'](_0x478b52(0x269),_0x5ead69);throw new common_1['HttpException'](_0x478b52(0x237),common_1['HttpStatus'][_0x478b52(0x1c7)]);}}async['pollForUpscaleResult'](_0x26f557,_0x2f70c6){const _0x532f03=_0x29cd62,{message_id:_0x1648e3,custom_id:_0x44fa8a,prompt:_0x183c7e,orderId:_0x4fc08b}=_0x26f557;let _0x317b19=null,_0x1ebdca=0x0;while(!_0x317b19&&_0x1ebdca<0xa){try{const _0x1816a0=Date['now'](),_0x2d5a73=await this[_0x532f03(0x20c)]();console['log']('第\x20'+(_0x1ebdca+0x1)+'\x20次开始查询\x20=>\x20当前查询结果：'+_0x2d5a73['length']);_0x2d5a73&&_0x2d5a73[_0x532f03(0x26b)]&&(_0x317b19=await this[_0x532f03(0x1ff)](_0x2d5a73,_0x26f557,_0x2f70c6));const _0x5a1d6b=Date[_0x532f03(0x23e)]()-_0x1816a0,_0xbb76bd=0xbb8;await this[_0x532f03(0x204)](Math['max'](_0xbb76bd-_0x5a1d6b,0x0)),_0x1ebdca++;}catch(_0x4451e8){console[_0x532f03(0x220)](_0x532f03(0x1e1)+_0x4451e8[_0x532f03(0x241)]);}}return _0x317b19;}async['pollForVariationResult'](_0x3db072,_0x1e0334){const _0x5e9a00=_0x29cd62,{message_id:_0xc5992d,custom_id:_0x3ffce4,prompt:_0x34c71f,orderId:_0x1c1031}=_0x3db072;console[_0x5e9a00(0x1f0)](_0x5e9a00(0x1d4));let _0x9b4b3=null,_0x564860=0x0;while(!_0x9b4b3&&_0x564860<0xa){try{console['log']('第\x20'+(_0x564860+0x1)+_0x5e9a00(0x1cc));const _0x3a2d95=Date[_0x5e9a00(0x23e)](),_0x2d95fb=await this[_0x5e9a00(0x20c)]();_0x2d95fb&&_0x2d95fb['length']&&(_0x9b4b3=await this[_0x5e9a00(0x1d7)](_0x2d95fb,_0x3db072,_0x1e0334));const _0x378037=Date['now']()-_0x3a2d95,_0x15eb59=0x1f40;await this['sleep'](Math[_0x5e9a00(0x22d)](_0x15eb59-_0x378037,0x0)),_0x564860++;}catch(_0x12d7f2){console['error'](_0x5e9a00(0x1e1)+_0x12d7f2[_0x5e9a00(0x241)]);}}if(!_0x9b4b3)throw new common_1[(_0x5e9a00(0x239))](_0x5e9a00(0x1cf),common_1[_0x5e9a00(0x1f5)][_0x5e9a00(0x1c7)]);return _0x9b4b3;}async[_0x29cd62(0x1ff)](_0x807cfc,_0x2f860a,_0x389008){const _0x392263=_0x29cd62,{message_id:_0x34f361,custom_id:_0x1c07a2,prompt:_0x41cb5d,orderId:_0x5834b9}=_0x2f860a,_0x1f6d5f=_0x41cb5d[_0x392263(0x1de)](0x0,0xc);console[_0x392263(0x1f0)](_0x392263(0x1db),_0x1f6d5f);const _0x4e8d1c=_0x807cfc['find'](_0x4c365a=>{const _0x2c3289=_0x392263,{content:_0x46ee61}=_0x4c365a;if(!this[_0x2c3289(0x261)](_0x46ee61))return![];const {prompt:_0x459fb2,order:_0x40209b}=this[_0x2c3289(0x261)](_0x46ee61);return _0x459fb2[_0x2c3289(0x210)](_0x1f6d5f)&&_0x2f860a['orderId']===_0x40209b&&!_0x389008[_0x2c3289(0x210)](_0x4c365a['id']);});return _0x4e8d1c;}async[_0x29cd62(0x1d7)](_0x2bf999,_0x1cd91f,_0x42aa65){const _0x48e13c=_0x29cd62,{message_id:_0x2d622f,custom_id:_0x59de35,prompt:_0x161ac0,orderId:_0x214553}=_0x1cd91f,_0x4c32ba=_0x161ac0[_0x48e13c(0x1de)](0x0,0xc),_0x1c91f5=_0x2bf999[_0x48e13c(0x1c4)](_0xbccaa1=>{const _0x6c1641=_0x48e13c,{content:_0x5712fd}=_0xbccaa1,_0x261b2e=_0x5712fd[_0x6c1641(0x25f)](/\*\*(.+?)\*\*/),_0x2d461b=_0x261b2e?_0x261b2e[0x1]:'';if(!_0x2d461b)return![];return _0x2d461b[_0x6c1641(0x210)](_0x4c32ba)&&!_0x42aa65[_0x6c1641(0x210)](_0xbccaa1['id']);});return _0x1c91f5;}async[_0x29cd62(0x246)](_0x485a54,_0x4935a3,_0x139fcb){const _0x1fc2d0=_0x29cd62,_0x54cb68=await this[_0x1fc2d0(0x20c)](),_0xa4720c=await this[_0x1fc2d0(0x24f)](_0x54cb68,_0x139fcb,_0x4935a3);if(_0xa4720c)return console['log'](_0x1fc2d0(0x232),_0xa4720c),_0xa4720c;const {application_id:_0x2aa147,guild_id:_0x2de237,channel_id:_0x73bf24,session_id:_0x3e52ff,version:_0x2bf844,id:_0x169f27,authorization:_0x398ebd,mjProxy:_0x334b78}=await this[_0x1fc2d0(0x230)](),_0x47a024={'type':0x2,'application_id':_0x2aa147,'guild_id':_0x2de237,'channel_id':_0x73bf24,'session_id':_0x3e52ff,'data':{'version':_0x2bf844,'id':_0x169f27,'name':_0x1fc2d0(0x1f9),'type':0x1,'options':[{'type':0x3,'name':_0x1fc2d0(0x25e),'value':_0x485a54}],'attachments':[]}};try{const _0x9758c6=_0x334b78==0x1?_0x1fc2d0(0x213):_0x1fc2d0(0x25d),_0x1fcb30={'authorization':_0x398ebd},_0x5509d=await axios_1['default'][_0x1fc2d0(0x1d8)](_0x9758c6,_0x47a024,{'headers':_0x1fcb30});return console['log']('发送绘画指令结果:\x20',_0x5509d['data']),![];}catch(_0x22d633){console['log'](_0x1fc2d0(0x1c2),_0x22d633);throw new common_1[(_0x1fc2d0(0x239))]('绘画请求失败、当前使用人数过多、请稍后试试吧、排队中...',common_1[_0x1fc2d0(0x1f5)][_0x1fc2d0(0x1c7)]);}}async['pollForResult'](_0x248329,_0x234d52,_0x303ef6){const _0x8ec133=_0x29cd62;console['log']('开始查询绘画结果轮询');const _0x4a7008=Date[_0x8ec133(0x23e)]();try{const _0x180852=0xd,_0x174ff0=0x2ee0,_0x547725=0x1388,_0x56b18f=0x3c*0x3e8;let _0x5054cd=0x0,_0x2ad542=![],_0x288a19=null;while(!_0x288a19&&_0x5054cd<_0x180852){console['log']('第\x20'+(_0x5054cd+0x1)+_0x8ec133(0x253));Date[_0x8ec133(0x23e)]()-_0x4a7008>=_0x56b18f&&(_0x2ad542=!![]);await this['sleep'](_0x2ad542?_0x547725:_0x174ff0);const _0x182fcf=await this[_0x8ec133(0x20c)]();_0x288a19=await this['findCurrentPromptResult'](_0x182fcf,_0x303ef6,_0x234d52),_0x5054cd++;}if(!_0x288a19)throw new common_1[(_0x8ec133(0x239))](_0x8ec133(0x21f),common_1[_0x8ec133(0x1f5)]['BAD_REQUEST']);const _0x2cb4dc=Date[_0x8ec133(0x23e)]();return console[_0x8ec133(0x1f0)](_0x8ec133(0x1f2)+Math[_0x8ec133(0x1e2)]((_0x2cb4dc-_0x4a7008)/0x3e8)+'\x20S'),_0x288a19;}catch(_0x53210c){console[_0x8ec133(0x220)](_0x53210c[_0x8ec133(0x241)]);throw new common_1[(_0x8ec133(0x239))]('网络连接失败，请稍后再试！',common_1[_0x8ec133(0x1f5)]['INTERNAL_SERVER_ERROR']);}}async[_0x29cd62(0x24f)](_0xe0335,_0x89e2d9,_0x726f06){const _0x5f44ca=_0x29cd62;if(!_0xe0335||!_0xe0335[_0x5f44ca(0x26b)])return;console['log'](_0x5f44ca(0x1f1),_0x89e2d9);const _0x4916fa=_0xe0335[_0x5f44ca(0x1c4)](_0x46c858=>{const _0x1afbce=_0x5f44ca,{attachments:attachments=[],content:_0x12ec02,edited_timestamp:_0x2410c8}=_0x46c858;return _0x12ec02[_0x1afbce(0x210)](_0x89e2d9)&&attachments[_0x1afbce(0x26b)]>0x0&&!_0x2410c8&&!_0x726f06['includes'](_0x46c858['id']);});return _0x4916fa||null;}async['queryMessageList'](){const _0x95e906=_0x29cd62;try{const {application_id:_0x311401,guild_id:_0x5cb60a,channel_id:_0xa97ec4,session_id:_0x3e97c1,version:_0x4cbd74,id:_0x1d0681,authorization:_0x52166a,mjProxy:_0x287a2d}=await this[_0x95e906(0x230)](),_0x4255c1=_0x287a2d==0x1?'http://172.247.48.137:8000/mj/list?channel_id='+_0xa97ec4:_0x95e906(0x1eb)+_0xa97ec4+_0x95e906(0x255),_0x5520e2={'authorization':_0x52166a},_0x1edc01=await axios_1['default'][_0x95e906(0x238)](_0x4255c1,{'headers':_0x5520e2});return _0x1edc01[_0x95e906(0x267)];}catch(_0x49639a){console['log'](_0x95e906(0x250),_0x49639a);throw new common_1[(_0x95e906(0x239))](_0x95e906(0x1e4),common_1[_0x95e906(0x1f5)][_0x95e906(0x1c7)]);}}async[_0x29cd62(0x204)](_0x2335e1){return new Promise(_0x3b636d=>setTimeout(_0x3b636d,_0x2335e1));}[_0x29cd62(0x261)](_0x4e2f23){const _0xc590c8=_0x29cd62,_0x1a36e4=_0x4e2f23['match'](/\*\*(.+?)\*\*/),_0x552d8c=_0x4e2f23[_0xc590c8(0x25f)](/- Image #(\d+)/);if(!_0x1a36e4||!_0x552d8c)return null;const _0x2de700=_0x1a36e4[0x1],_0x4f1c19=parseInt(_0x552d8c[0x1]);return{'prompt':_0x2de700,'order':_0x4f1c19};}async[_0x29cd62(0x230)](){const _0x32bc26=_0x29cd62,_0xc43541=await this[_0x32bc26(0x1d5)][_0x32bc26(0x212)]([_0x32bc26(0x22f),_0x32bc26(0x206),_0x32bc26(0x1c8),'mjChannelId',_0x32bc26(0x233),_0x32bc26(0x21c),'mjAuthorization',_0x32bc26(0x1d0),_0x32bc26(0x22b)]),_0x2c364c={'application_id':_0xc43541[_0x32bc26(0x206)],'guild_id':_0xc43541[_0x32bc26(0x1c8)],'channel_id':_0xc43541['mjChannelId'],'session_id':_0xc43541[_0x32bc26(0x233)],'version':_0xc43541['mjVersion'],'id':_0xc43541[_0x32bc26(0x22f)],'authorization':_0xc43541['mjAuthorization'],'mjRateLimit':_0xc43541[_0x32bc26(0x1d0)],'mjProxy':_0xc43541[_0x32bc26(0x22b)]||0x0};return _0x2c364c;}[_0x29cd62(0x1df)](_0x5922e0){const _0x3d5006=_0x29cd62,_0x3afb6e=/[\uD800-\uDBFF][\uDC00-\uDFFF]/g;return _0x5922e0[_0x3d5006(0x24d)](_0x3afb6e,'');}async['checkAuth'](_0x22e662){const _0x4125d0=_0x29cd62,_0x5d1862=await this[_0x4125d0(0x217)]['findOne']({'where':{'userId':_0x22e662[_0x4125d0(0x229)]['id']}}),{id:_0x119eed,balance:_0x4e3345}=_0x5d1862;if(!_0x4e3345||(_0x5d1862===null||_0x5d1862===void 0x0?void 0x0:_0x5d1862[_0x4125d0(0x201)])<0x1)throw new common_1[(_0x4125d0(0x239))]('您当前暂无MJ绘画余额！！！',common_1[_0x4125d0(0x1f5)][_0x4125d0(0x1c7)]);}async[_0x29cd62(0x21b)](_0x348ce4){const _0x17e7f5=_0x29cd62,{id:_0x14613b,role:_0x1f3171}=_0x348ce4[_0x17e7f5(0x229)];!this[_0x17e7f5(0x25a)][_0x14613b]?this[_0x17e7f5(0x25a)][_0x14613b]=0x1:this[_0x17e7f5(0x25a)][_0x14613b]=this[_0x17e7f5(0x25a)][_0x14613b]+0x1,console[_0x17e7f5(0x1f0)](_0x17e7f5(0x20d)+_0x14613b+_0x17e7f5(0x228),this[_0x17e7f5(0x25a)][_0x14613b]);}async[_0x29cd62(0x235)](_0x5a45f2){const _0x57cec9=_0x29cd62,{id:_0x44df62,role:_0x3dce11}=_0x5a45f2[_0x57cec9(0x229)];if([_0x57cec9(0x1fa),'super'][_0x57cec9(0x210)](_0x3dce11))return!![];const {mjRateLimit:_0x55fd75}=await this[_0x57cec9(0x230)]();if(this['rateLimits'][_0x44df62]){const _0x104743=this[_0x57cec9(0x249)][_0x44df62];if(_0x104743>Date['now']()){console[_0x57cec9(0x1f0)](_0x57cec9(0x200)+_0x44df62+_0x57cec9(0x1fb));throw new common_1['HttpException']('由于速率限制、当前普通用户限制为'+_0x55fd75+'秒请求一次、请合理使用！',common_1[_0x57cec9(0x1f5)]['BAD_REQUEST']);}else this[_0x57cec9(0x249)][_0x44df62]=Date['now']()+Number(_0x55fd75)*0x3e8;}else{const _0x4009c=Date[_0x57cec9(0x23e)]();this[_0x57cec9(0x249)][_0x44df62]=_0x4009c+0x3e8*Number(_0x55fd75);}}async[_0x29cd62(0x216)](_0xd41d18){const _0x41cece=_0x29cd62;await this['balanceEntity'][_0x41cece(0x1d3)]()[_0x41cece(0x251)](balance_entity_1[_0x41cece(0x24b)])['set']({'balance':()=>_0x41cece(0x23c)})[_0x41cece(0x23b)](_0x41cece(0x257),{'userId':_0xd41d18['user']['id']})[_0x41cece(0x1cb)]();}async['test'](){return 0x1;}};MjService=__decorate([(0x0,common_1[_0x29cd62(0x252)])(),__param(0x0,(0x0,typeorm_2[_0x29cd62(0x1c5)])(chatLog_entity_1[_0x29cd62(0x240)])),__param(0x1,(0x0,typeorm_2[_0x29cd62(0x1c5)])(balance_entity_1[_0x29cd62(0x24b)])),__metadata(_0x29cd62(0x26c),[typeorm_1['Repository'],typeorm_1['Repository'],upload_service_1[_0x29cd62(0x1e6)],chatLog_service_1[_0x29cd62(0x20f)],globalConfig_service_1[_0x29cd62(0x263)],fanyi_service_1[_0x29cd62(0x1e3)],badwords_service_1[_0x29cd62(0x248)]])],MjService),exports['MjService']=MjService;