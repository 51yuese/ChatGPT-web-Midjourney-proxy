'use strict';const _0x2ecfb0=_0x20b3;function _0x403c(){const _0x59d3a0=['../userBalance/balance.entity','queryMessageList','3524664kwreoW','message_id','@nestjs/common','deductBalance','badwordsService','extractContent','uploadFileFromUrl','uploadService','UploadService','https://discord.com/api/v9/interactions','InjectRepository','HttpStatus','秒请求一次、请合理使用！','now','由于速率限制、当前普通用户限制为','放大当前图片失败','decorate','/messages?limit=50','push','ChatLogService','当前图片已经放大过了、请勿重复放大!','GlobalConfigService','HttpException','pollForResult','../badwords/badwords.service','\x20请求过于频繁！','error:\x20','本次放大图片的id:\x20','prompt','test','变换当前图片失败','get','查询期间出现错误：','mjSessionId','mjId','../chatLog/chatLog.service','default','本次比对的随机ID:\x20','515KIktAU','components','483683mRFcST','balance','开始请求放大图片\x20队列+1:\x20','length','fanyiService','sleep','IsNull','历史记录中不存在当前图片、请确认您需要变换的图片是否存在','getClientIp','super','execute','mjApplicationId','checkRateLimit','baiduFanyiAppId','1777209lphGcs','Injectable','http://172.247.48.137:8000/mj/draw','includes','sendSmInteractions','__metadata','metadata','放大图片任务异常中断\x20队列-1:\x20','log','拿到了远程地址:\x20','sendDrawInteractions','mjAuthorization','axios\x20get:\x20','user','绘画请求失败、当前使用人数过多、请稍后试试吧、排队中...','DeductionKey','放大custom_id:\x20','balanceEntity','function','绘画失败','getConfigs','draw','response','../../common/constants/balance.constant','BAD_REQUEST','saveChatLog','drawWorking','放大单张图片请求失败...','mjNotSaveImg','PAINT_TYPE','当前提示词已经在任务队列中了、请勿重复提交。。。','freeQueueUsers','defineProperty','Repository','url','BalanceEntity','历史这些id已经被获取过了\x20不能拿了:\x20','Like','message','开始请求用户','parse','319374zoBMlZ','stringify','findCurrentVariationImgResult','removeEmoji','您当前暂无MJ绘画余额！！！','Not','object','历史中存在当前图片、直接获取！','admin','checkBadWords','variationSingleImg','./../upload/upload.service','mjGuildId','本次绘图耗时:\x20','绘画超时，请稍后再试！','set','历史记录中不存在当前图片、请确认您放大的图片是否存在','INTERNAL_SERVER_ERROR','enlarge','__decorate','mjRateLimit','变换当前图片超时！','findCurrentPromptResult','https://discord.com/api/v9/channels/','findCurrentEnlargeImgResult','prompt\x20','match','upscaleSingleImg','mjChannelId','imagine','开始轮询单张变换图片结果','pollForUpscaleResult','网络连接失败，请稍后再试！','design:paramtypes','queueCount','findOne','getMjDefaultParams','使用的次数：','post','\x20次开始查询\x20=>\x20当前查询结果：','Logger','@nestjs/typeorm','globalConfigService','chatLogEntity','FanyiService','randomId:\x20','\x20次开始查询[变换图片]','9879462RBClEQ','max','find','onModuleInit','7DUVqqk','4710928gBFhur','mjProxy','存入图片完成:\x20','../chatLog/chatLog.entity','userId\x20=\x20:userId','ChatLogEntity','replace','data','MjService','baiduFanyiSecret','当前绘图任务满载、请排队等候、队列任务完成后即可开始您的任务...','orderId','查询绘制结果失败...','开始请求变换图片\x20队列+1:\x20','rateLimits','convertToEnglish','error','当前用户','9224fyexiw','catch','绘图指令完成','createRandomUid','pollForVariationResult','checkAuth','chatLogService','map','变换图片任务结束\x20队列-1:\x20','mjVersion'];_0x403c=function(){return _0x59d3a0;};return _0x403c();}(function(_0x5df697,_0x4043f1){const _0x2ee112=_0x20b3,_0x3394d8=_0x5df697();while(!![]){try{const _0x1bdd8c=-parseInt(_0x2ee112(0x241))/0x1+parseInt(_0x2ee112(0x1c7))/0x2+-parseInt(_0x2ee112(0x24f))/0x3+-parseInt(_0x2ee112(0x20d))/0x4*(-parseInt(_0x2ee112(0x23f))/0x5)+parseInt(_0x2ee112(0x219))/0x6+-parseInt(_0x2ee112(0x1fa))/0x7*(parseInt(_0x2ee112(0x1fb))/0x8)+parseInt(_0x2ee112(0x1f6))/0x9;if(_0x1bdd8c===_0x4043f1)break;else _0x3394d8['push'](_0x3394d8['shift']());}catch(_0x2984a2){_0x3394d8['push'](_0x3394d8['shift']());}}}(_0x403c,0x65e87));var __decorate=this&&this[_0x2ecfb0(0x1da)]||function(_0x2beb00,_0x5428b8,_0x216669,_0x369e9d){const _0x4f313b=_0x2ecfb0;var _0x31bc5c=arguments[_0x4f313b(0x244)],_0x44fc85=_0x31bc5c<0x3?_0x5428b8:_0x369e9d===null?_0x369e9d=Object['getOwnPropertyDescriptor'](_0x5428b8,_0x216669):_0x369e9d,_0x4380b6;if(typeof Reflect===_0x4f313b(0x1cd)&&typeof Reflect[_0x4f313b(0x229)]===_0x4f313b(0x261))_0x44fc85=Reflect[_0x4f313b(0x229)](_0x2beb00,_0x5428b8,_0x216669,_0x369e9d);else{for(var _0x10b28e=_0x2beb00['length']-0x1;_0x10b28e>=0x0;_0x10b28e--)if(_0x4380b6=_0x2beb00[_0x10b28e])_0x44fc85=(_0x31bc5c<0x3?_0x4380b6(_0x44fc85):_0x31bc5c>0x3?_0x4380b6(_0x5428b8,_0x216669,_0x44fc85):_0x4380b6(_0x5428b8,_0x216669))||_0x44fc85;}return _0x31bc5c>0x3&&_0x44fc85&&Object[_0x4f313b(0x1be)](_0x5428b8,_0x216669,_0x44fc85),_0x44fc85;},__metadata=this&&this[_0x2ecfb0(0x254)]||function(_0xfe2866,_0x3c7c19){const _0x4f519=_0x2ecfb0;if(typeof Reflect===_0x4f519(0x1cd)&&typeof Reflect['metadata']===_0x4f519(0x261))return Reflect[_0x4f519(0x255)](_0xfe2866,_0x3c7c19);},__param=this&&this['__param']||function(_0x3a66e0,_0x288724){return function(_0x5a0b89,_0x4e4a50){_0x288724(_0x5a0b89,_0x4e4a50,_0x3a66e0);};};Object[_0x2ecfb0(0x1be)](exports,'__esModule',{'value':!![]}),exports[_0x2ecfb0(0x203)]=void 0x0;function _0x20b3(_0x2c58be,_0x49e93a){const _0x403c30=_0x403c();return _0x20b3=function(_0x20b30f,_0x14dede){_0x20b30f=_0x20b30f-0x1be;let _0x53655=_0x403c30[_0x20b30f];return _0x53655;},_0x20b3(_0x2c58be,_0x49e93a);}const globalConfig_service_1=require('./../globalConfig/globalConfig.service'),upload_service_1=require(_0x2ecfb0(0x1d2)),common_1=require(_0x2ecfb0(0x21b)),axios_1=require('axios'),chatLog_service_1=require(_0x2ecfb0(0x23c)),balance_constant_1=require(_0x2ecfb0(0x266)),utils_1=require('../../common/utils'),chatLog_entity_1=require(_0x2ecfb0(0x1fe)),typeorm_1=require('typeorm'),typeorm_2=require(_0x2ecfb0(0x1f0)),balance_entity_1=require(_0x2ecfb0(0x217)),fanyi_service_1=require('../fanyi/fanyi.service'),badwords_service_1=require(_0x2ecfb0(0x231));let MjService=class MjService{constructor(_0x5b45d2,_0x472d25,_0x8583b3,_0x469ad4,_0x48e1f5,_0x32cec8,_0x26c553){const _0xd2f1d=_0x2ecfb0;this['chatLogEntity']=_0x5b45d2,this[_0xd2f1d(0x260)]=_0x472d25,this[_0xd2f1d(0x220)]=_0x8583b3,this[_0xd2f1d(0x213)]=_0x469ad4,this[_0xd2f1d(0x1f1)]=_0x48e1f5,this[_0xd2f1d(0x245)]=_0x32cec8,this['badwordsService']=_0x26c553,this[_0xd2f1d(0x209)]={},this['drawWorking']=[],this['enlargeWorking']=[],this[_0xd2f1d(0x1e9)]=0x0,this['freeQueueUsers']={};}async[_0x2ecfb0(0x1f9)](){}['handleDrawTest'](_0x45b0d5,_0x3762f6){}async[_0x2ecfb0(0x264)](_0x2b10ee,_0x2c98cd){const _0x4c86af=_0x2ecfb0;await this['checkAuth'](_0x2c98cd),await this[_0x4c86af(0x21d)][_0x4c86af(0x1d0)](_0x2b10ee[_0x4c86af(0x235)],_0x2c98cd[_0x4c86af(0x25c)]['id']);const _0x2dec5b=_0x2b10ee[_0x4c86af(0x235)];let _0x2a3990=_0x2b10ee[_0x4c86af(0x235)];const {baiduFanyiAppId:_0x10645c,baiduFanyiSecret:_0x20d826}=await this[_0x4c86af(0x1f1)]['getConfigs']([_0x4c86af(0x24e),_0x4c86af(0x204)]);_0x10645c&&_0x20d826&&(_0x2a3990=await this['fanyiService'][_0x4c86af(0x20a)](_0x2dec5b));const _0x2e5471='['+(0x0,utils_1[_0x4c86af(0x210)])()+']',_0x323dc5=_0x2e5471+'\x20'+_0x2a3990;console[_0x4c86af(0x257)](_0x4c86af(0x1f4),_0x2e5471),console['log'](_0x4c86af(0x1e0),_0x323dc5);const _0x56de94=this[_0x4c86af(0x269)][_0x4c86af(0x1f8)](_0x28f559=>_0x28f559[_0x4c86af(0x252)](_0x2b10ee[_0x4c86af(0x235)]));if(_0x56de94)throw new common_1['HttpException'](_0x4c86af(0x26d),common_1['HttpStatus'][_0x4c86af(0x267)]);if(this['queueCount']>=0x3)throw new common_1[(_0x4c86af(0x22f))]('当前绘图任务满载、请排队等候、队列任务完成后即可开始您的任务...',common_1['HttpStatus'][_0x4c86af(0x267)]);await this[_0x4c86af(0x24d)](_0x2c98cd),this[_0x4c86af(0x1e9)]++,console[_0x4c86af(0x257)](_0x4c86af(0x1c5)+_0x2c98cd[_0x4c86af(0x25c)]['id']+'\x20队列+1:\x20',this[_0x4c86af(0x1e9)]);try{const _0x7b892d=await this[_0x4c86af(0x1f2)][_0x4c86af(0x1f8)]({'where':{'prompt':(0x0,typeorm_1[_0x4c86af(0x1c3)])('%'+_0x323dc5+'%')}}),_0x360b0a=_0x7b892d[_0x4c86af(0x214)](_0x46fc9b=>_0x46fc9b[_0x4c86af(0x21a)]);this['drawWorking'][_0x4c86af(0x22b)](_0x323dc5);let _0x24a72b;const _0x21686b=await this[_0x4c86af(0x259)](_0x323dc5,_0x360b0a,_0x2e5471);_0x21686b?(console[_0x4c86af(0x257)](_0x4c86af(0x1ce)),_0x24a72b=_0x21686b):_0x24a72b=await this['pollForResult'](_0x323dc5,_0x360b0a,_0x2e5471);console[_0x4c86af(0x257)](_0x24a72b),this[_0x4c86af(0x1e9)]--,this[_0x4c86af(0x1e9)]<0x0&&(this[_0x4c86af(0x1e9)]=0x0),console[_0x4c86af(0x257)]('绘制图片任务结束\x20队列-1:\x20',this['queueCount']);const {id:_0x29cda0,content:_0x2b96c7,channel_id:_0x8fcf2a,attachments:attachments=[],timestamp:_0x5383a8}=_0x24a72b;if(!attachments[_0x4c86af(0x244)]||!attachments[0x0][_0x4c86af(0x1c0)])throw new common_1[(_0x4c86af(0x22f))](_0x4c86af(0x262),common_1['HttpStatus'][_0x4c86af(0x267)]);const {filename:_0x36a602,url:_0x13dee5,width:_0x2b2e00,height:_0x149595,size:_0x38059a}=attachments[0x0];console['log'](_0x4c86af(0x258),_0x13dee5);const _0x28bfea=this[_0x4c86af(0x1f1)][_0x4c86af(0x263)]([_0x4c86af(0x26b)]);let _0x4a50fd='';(!Number(_0x28bfea)||Number(_0x28bfea)===0x0)&&(_0x4a50fd=await this['uploadService'][_0x4c86af(0x21f)]({'filename':_0x36a602,'url':_0x13dee5}),console[_0x4c86af(0x257)](_0x4c86af(0x1fd),_0x4a50fd));const _0x2670de={'mode':0x1,'curIp':(0x0,utils_1[_0x4c86af(0x249)])(_0x2c98cd),'userId':_0x2c98cd['user']['id'],'type':balance_constant_1[_0x4c86af(0x25e)][_0x4c86af(0x26c)],'prompt':_0x323dc5,'answer':_0x4a50fd,'model':'mj','extend':this[_0x4c86af(0x1ca)](JSON['stringify'](_0x24a72b)),'message_id':_0x29cda0,'variationId':_0x29cda0,'upscaleId':_0x29cda0,'group':0x1,'isSaveImg':!Number(_0x28bfea)||Number(_0x28bfea)===0x0,'fileInfo':JSON[_0x4c86af(0x1c8)]({'width':_0x2b2e00,'height':_0x149595,'size':_0x38059a,'filename':_0x36a602,'cosUrl':_0x4a50fd})};return await this[_0x4c86af(0x213)][_0x4c86af(0x268)](_0x2670de),await this[_0x4c86af(0x21c)](_0x2c98cd),this['drawWorking']=this['drawWorking']['filter'](_0x509075=>_0x509075!==_0x2b10ee['prompt']),_0x4a50fd;}catch(_0x3c3e50){this['queueCount']--,this[_0x4c86af(0x1e9)]<0x0&&(this[_0x4c86af(0x1e9)]=0x0),console[_0x4c86af(0x257)]('绘制图片任务异常中断\x20队列-1:\x20',this['queueCount']),this['drawWorking']=this[_0x4c86af(0x269)]['filter'](_0x4aa953=>_0x4aa953!==_0x2b10ee[_0x4c86af(0x235)]);throw new common_1[(_0x4c86af(0x22f))](_0x3c3e50['response'],common_1[_0x4c86af(0x224)][_0x4c86af(0x267)]);}}async[_0x2ecfb0(0x1e2)](_0x3f9d32,_0x5410fd){const _0x303a5a=_0x2ecfb0;if(this['queueCount']>=0x3)throw new common_1[(_0x303a5a(0x22f))](_0x303a5a(0x205),common_1[_0x303a5a(0x224)]['BAD_REQUEST']);this[_0x303a5a(0x1e9)]++,console[_0x303a5a(0x257)]('用户'+_0x5410fd[_0x303a5a(0x25c)]['id']+_0x303a5a(0x243),this[_0x303a5a(0x1e9)]);const {message_id:_0x4bb6fa,orderId:_0x3dff0f}=_0x3f9d32;try{const _0x8e7000=await this[_0x303a5a(0x1f2)][_0x303a5a(0x1ea)]({'where':{'message_id':_0x4bb6fa}});if(!_0x8e7000)throw new common_1[(_0x303a5a(0x22f))](_0x303a5a(0x1d7),common_1['HttpStatus'][_0x303a5a(0x267)]);const _0x1b9d9b=await this[_0x303a5a(0x1f2)][_0x303a5a(0x1ea)]({'where':{'upscaleId':_0x4bb6fa,'action':'enlarge','orderId':_0x3dff0f}});if(_0x1b9d9b)throw new common_1[(_0x303a5a(0x22f))](_0x303a5a(0x22d),common_1[_0x303a5a(0x224)][_0x303a5a(0x267)]);const {prompt:_0x189310,extend:_0x5ef081}=_0x8e7000,_0x404774=JSON[_0x303a5a(0x1c6)](_0x5ef081),{components:components=[]}=_0x404774;if(!components[_0x303a5a(0x244)])throw new common_1[(_0x303a5a(0x22f))]('当前图片没有绘画信息、无法放大!',common_1[_0x303a5a(0x224)]['BAD_REQUEST']);const _0x58a2f2=components[0x0][_0x303a5a(0x240)][_0x3dff0f-0x1],{custom_id:_0x24e8f7}=_0x58a2f2;console[_0x303a5a(0x257)](_0x303a5a(0x25f),_0x24e8f7);const _0x453251={'message_id':_0x4bb6fa,'custom_id':_0x24e8f7,'prompt':_0x189310,'orderId':_0x3dff0f};await this[_0x303a5a(0x253)](_0x453251),console[_0x303a5a(0x257)]('发送放大指令成功');const _0x123e76=await this['chatLogEntity'][_0x303a5a(0x1f8)]({'where':{'prompt':(0x0,typeorm_1['Like'])('%'+_0x189310+'%')}}),_0xde5bc1=_0x123e76[_0x303a5a(0x214)](_0x3c1da5=>_0x3c1da5['message_id']);console[_0x303a5a(0x257)](_0x303a5a(0x1c2),_0xde5bc1);const _0x5edb93=await this[_0x303a5a(0x1e6)](_0x453251,_0xde5bc1);this['queueCount']--,this[_0x303a5a(0x1e9)]<0x0&&(this[_0x303a5a(0x1e9)]=0x0),console[_0x303a5a(0x257)]('放大图片任务结束\x20队列-1:\x20',this['queueCount']);const {id:_0x18817b,content:_0x20e145,channel_id:_0x4c07ae,attachments:attachments=[],timestamp:_0x4a239b}=_0x5edb93;if(!attachments[_0x303a5a(0x244)]||!attachments[0x0][_0x303a5a(0x1c0)])throw new common_1[(_0x303a5a(0x22f))](_0x303a5a(0x228),common_1[_0x303a5a(0x224)][_0x303a5a(0x267)]);const {filename:_0x5274ba,url:_0x55ea23,width:_0x3010cb,height:_0x19c669,size:_0x505226}=attachments[0x0],_0x24a38e=this['globalConfigService'][_0x303a5a(0x263)]([_0x303a5a(0x26b)]);let _0x4e0e47='';(!Number(_0x24a38e)||Number(_0x24a38e)===0x0)&&(_0x4e0e47=await this[_0x303a5a(0x220)][_0x303a5a(0x21f)]({'filename':_0x5274ba,'url':_0x55ea23}),console['log'](_0x303a5a(0x1fd),_0x4e0e47));const _0x19f678={'curIp':(0x0,utils_1[_0x303a5a(0x249)])(_0x5410fd),'userId':_0x5410fd['user']['id'],'type':balance_constant_1['DeductionKey'][_0x303a5a(0x26c)],'prompt':_0x189310,'answer':_0x4e0e47,'model':'mj','extend':this['removeEmoji'](JSON[_0x303a5a(0x1c8)](_0x5edb93)),'message_id':_0x4bb6fa,'upscaleId':_0x18817b,'variationId':_0x18817b,'action':_0x303a5a(0x1d9),'orderId':_0x453251['orderId'],'isSaveImg':!Number(_0x24a38e)||Number(_0x24a38e)===0x0,'fileInfo':JSON['stringify']({'width':_0x3010cb,'height':_0x19c669,'size':_0x505226,'filename':_0x5274ba,'cosUrl':_0x4e0e47})};return await this['chatLogService'][_0x303a5a(0x268)](_0x19f678),_0x4e0e47;}catch(_0x6bdb7e){console[_0x303a5a(0x257)](_0x303a5a(0x233),_0x6bdb7e),this[_0x303a5a(0x1e9)]--,this[_0x303a5a(0x1e9)]<0x0&&(this[_0x303a5a(0x1e9)]=0x0),console[_0x303a5a(0x257)](_0x303a5a(0x256),this[_0x303a5a(0x1e9)]);throw new common_1[(_0x303a5a(0x22f))](_0x6bdb7e[_0x303a5a(0x265)],common_1['HttpStatus'][_0x303a5a(0x267)]);}}async[_0x2ecfb0(0x1d1)](_0x530532,_0x1464bd){const _0x40d2eb=_0x2ecfb0;if(this[_0x40d2eb(0x1e9)]>=0x3)throw new common_1[(_0x40d2eb(0x22f))](_0x40d2eb(0x205),common_1[_0x40d2eb(0x224)][_0x40d2eb(0x267)]);await this[_0x40d2eb(0x212)](_0x1464bd),await this[_0x40d2eb(0x24d)](_0x1464bd),this[_0x40d2eb(0x1e9)]++,console['log']('用户'+_0x1464bd[_0x40d2eb(0x25c)]['id']+_0x40d2eb(0x208),this['queueCount']);const {message_id:_0x4341e2,orderId:_0x4eda60}=_0x530532;try{const _0x54105b=await this[_0x40d2eb(0x1f2)][_0x40d2eb(0x1ea)]({'where':{'message_id':_0x4341e2}});if(!_0x54105b)throw new common_1[(_0x40d2eb(0x22f))](_0x40d2eb(0x248),common_1[_0x40d2eb(0x224)][_0x40d2eb(0x267)]);const {prompt:_0x604dde,extend:_0x4e80f9}=_0x54105b,_0x3656de=JSON[_0x40d2eb(0x1c6)](_0x4e80f9),{components:components=[]}=_0x3656de;if(!components[_0x40d2eb(0x244)])throw new common_1[(_0x40d2eb(0x22f))]('当前图片没有绘画信息、无法变体!',common_1[_0x40d2eb(0x224)]['BAD_REQUEST']);const _0x139004=components[0x1][_0x40d2eb(0x240)][_0x4eda60-0x1],{custom_id:_0x45b237}=_0x139004,_0x4ac3e2=await this[_0x40d2eb(0x1f2)][_0x40d2eb(0x1f8)]({'where':{'variationId':(0x0,typeorm_1[_0x40d2eb(0x1cc)])((0x0,typeorm_1[_0x40d2eb(0x247)])()),'prompt':(0x0,typeorm_1[_0x40d2eb(0x1c3)])('%'+_0x604dde+'%')}}),_0x585de1=_0x4ac3e2['map'](_0xc56f79=>_0xc56f79['variationId']),_0x29e399={'message_id':_0x4341e2,'custom_id':_0x45b237,'prompt':_0x604dde,'orderId':_0x4eda60};await this[_0x40d2eb(0x253)](_0x29e399);const _0x59bb7c=await this['pollForVariationResult'](_0x29e399,_0x585de1);this[_0x40d2eb(0x1e9)]--,this[_0x40d2eb(0x1e9)]<0x0&&(this['queueCount']=0x0),console[_0x40d2eb(0x257)](_0x40d2eb(0x215),this[_0x40d2eb(0x1e9)]);const {id:_0x1b2525,content:_0x5c8e18,channel_id:_0x2181e2,attachments:attachments=[],timestamp:_0x4b0e38}=_0x59bb7c;if(!attachments[_0x40d2eb(0x244)]||!attachments[0x0][_0x40d2eb(0x1c0)])throw new common_1[(_0x40d2eb(0x22f))](_0x40d2eb(0x237),common_1[_0x40d2eb(0x224)][_0x40d2eb(0x267)]);const {filename:_0x1b59d8,url:_0x17b688,width:_0x2fde62,height:_0x254482,size:_0xcc8ce4}=attachments[0x0],_0x5c348d=this[_0x40d2eb(0x1f1)][_0x40d2eb(0x263)]([_0x40d2eb(0x26b)]);let _0x38a791='';(!Number(_0x5c348d)||Number(_0x5c348d)===0x0)&&(_0x38a791=await this['uploadService'][_0x40d2eb(0x21f)]({'filename':_0x1b59d8,'url':_0x17b688}),console[_0x40d2eb(0x257)](_0x40d2eb(0x1fd),_0x38a791));const _0x462867={'curIp':(0x0,utils_1[_0x40d2eb(0x249)])(_0x1464bd),'userId':_0x1464bd[_0x40d2eb(0x25c)]['id'],'type':balance_constant_1['DeductionKey'][_0x40d2eb(0x26c)],'prompt':_0x604dde,'answer':_0x38a791,'model':'mj','group':0x1,'extend':this[_0x40d2eb(0x1ca)](JSON[_0x40d2eb(0x1c8)](_0x59bb7c)),'message_id':_0x1b2525,'upscaleId':_0x1b2525,'variationId':_0x1b2525,'action':_0x40d2eb(0x1d9),'orderId':_0x29e399['orderId'],'isSaveImg':!Number(_0x5c348d)||Number(_0x5c348d)===0x0,'fileInfo':JSON[_0x40d2eb(0x1c8)]({'width':_0x2fde62,'height':_0x254482,'size':_0xcc8ce4,'filename':_0x1b59d8,'cosUrl':_0x38a791})};return await this[_0x40d2eb(0x213)][_0x40d2eb(0x268)](_0x462867),_0x38a791;}catch(_0x2cb906){console['log'](_0x40d2eb(0x233),_0x2cb906),this[_0x40d2eb(0x1e9)]--,this[_0x40d2eb(0x1e9)]<0x0&&(this[_0x40d2eb(0x1e9)]=0x0),console['log']('变化图片任务异常中断\x20队列-1:\x20',this['queueCount']);throw new common_1[(_0x40d2eb(0x22f))](_0x2cb906[_0x40d2eb(0x265)],common_1[_0x40d2eb(0x224)][_0x40d2eb(0x267)]);}}async[_0x2ecfb0(0x253)](_0x1b96b0){const _0x11fd4e=_0x2ecfb0,{message_id:_0x4cdcf4,custom_id:_0x322a3c}=_0x1b96b0,{application_id:_0x5bb19b,guild_id:_0x246144,channel_id:_0x490d81,session_id:_0x369b00,version:_0x4dfc3d,id:_0x5f559b,authorization:_0x2f5e23,mjProxy:_0x26644f}=await this[_0x11fd4e(0x1eb)](),_0xc35db2=_0x26644f==0x1?_0x11fd4e(0x251):'https://discord.com/api/v9/interactions',_0xc5f9bc={'authorization':_0x2f5e23},_0x4b45e5={'type':0x3,'guild_id':_0x246144,'channel_id':_0x490d81,'message_flags':0x0,'message_id':_0x4cdcf4,'application_id':_0x5bb19b,'session_id':_0x369b00,'data':{'component_type':0x2,'custom_id':_0x322a3c}};try{await axios_1[_0x11fd4e(0x23d)]['post'](_0xc35db2,_0x4b45e5,{'headers':_0xc5f9bc}),console['log'](_0x11fd4e(0x20f));}catch(_0x3d1d8a){console[_0x11fd4e(0x257)](_0x11fd4e(0x233),_0x3d1d8a);throw new common_1[(_0x11fd4e(0x22f))](_0x11fd4e(0x26a),common_1[_0x11fd4e(0x224)]['BAD_REQUEST']);}}async[_0x2ecfb0(0x1e6)](_0xec8c33,_0x451f11){const _0x4b952a=_0x2ecfb0,{message_id:_0x288ec2,custom_id:_0x23ac1a,prompt:_0x3c3aa2,orderId:_0x5e58fb}=_0xec8c33;let _0x32c931=null,_0x542e90=0x0;while(!_0x32c931&&_0x542e90<0xa){try{const _0x139a00=Date[_0x4b952a(0x226)](),_0x1ae3cb=await this[_0x4b952a(0x218)]();console[_0x4b952a(0x257)]('第\x20'+(_0x542e90+0x1)+_0x4b952a(0x1ee)+_0x1ae3cb[_0x4b952a(0x244)]);_0x1ae3cb&&_0x1ae3cb[_0x4b952a(0x244)]&&(_0x32c931=await this['findCurrentEnlargeImgResult'](_0x1ae3cb,_0xec8c33,_0x451f11));const _0x13ebd9=Date['now']()-_0x139a00,_0x1288ef=0xbb8;await this[_0x4b952a(0x246)](Math['max'](_0x1288ef-_0x13ebd9,0x0)),_0x542e90++;}catch(_0x2dfccd){console[_0x4b952a(0x20b)](_0x4b952a(0x239)+_0x2dfccd[_0x4b952a(0x1c4)]);}}return _0x32c931;}async[_0x2ecfb0(0x211)](_0xead795,_0x235493){const _0x5e0cb0=_0x2ecfb0,{message_id:_0x47569d,custom_id:_0x11f7d0,prompt:_0x572bfc,orderId:_0x286609}=_0xead795;console[_0x5e0cb0(0x257)](_0x5e0cb0(0x1e5));let _0x2bf48a=null,_0x2a1133=0x0;while(!_0x2bf48a&&_0x2a1133<0xa){try{console['log']('第\x20'+(_0x2a1133+0x1)+_0x5e0cb0(0x1f5));const _0x5ded19=Date[_0x5e0cb0(0x226)](),_0x97723e=await this[_0x5e0cb0(0x218)]();_0x97723e&&_0x97723e['length']&&(_0x2bf48a=await this['findCurrentVariationImgResult'](_0x97723e,_0xead795,_0x235493));const _0x2b82ad=Date[_0x5e0cb0(0x226)]()-_0x5ded19,_0x9f6cb3=0x1f40;await this[_0x5e0cb0(0x246)](Math[_0x5e0cb0(0x1f7)](_0x9f6cb3-_0x2b82ad,0x0)),_0x2a1133++;}catch(_0x145696){console[_0x5e0cb0(0x20b)](_0x5e0cb0(0x239)+_0x145696[_0x5e0cb0(0x1c4)]);}}if(!_0x2bf48a)throw new common_1['HttpException'](_0x5e0cb0(0x1dc),common_1[_0x5e0cb0(0x224)][_0x5e0cb0(0x267)]);return _0x2bf48a;}async[_0x2ecfb0(0x1df)](_0x1ff1f2,_0x2dc01f,_0x1bc390){const _0x1abddd=_0x2ecfb0,{message_id:_0x3d4e44,custom_id:_0x22df6f,prompt:_0x199757,orderId:_0x44e423}=_0x2dc01f,_0xac6836=_0x199757['substring'](0x0,0xc);console[_0x1abddd(0x257)](_0x1abddd(0x234),_0xac6836);const _0x5e9ed6=_0x1ff1f2[_0x1abddd(0x1f8)](_0x34c275=>{const _0x308adb=_0x1abddd,{content:_0xb97805}=_0x34c275;if(!this['extractContent'](_0xb97805))return![];const {prompt:_0x182c95,order:_0x4c2b6f}=this[_0x308adb(0x21e)](_0xb97805);return _0x182c95[_0x308adb(0x252)](_0xac6836)&&_0x2dc01f[_0x308adb(0x206)]===_0x4c2b6f&&!_0x1bc390['includes'](_0x34c275['id']);});return _0x5e9ed6;}async[_0x2ecfb0(0x1c9)](_0x5ee7df,_0x4cce38,_0xe90507){const _0x35e64d=_0x2ecfb0,{message_id:_0x462b35,custom_id:_0x350b61,prompt:_0x1e2b59,orderId:_0x233754}=_0x4cce38,_0x523629=_0x1e2b59['substring'](0x0,0xc),_0x2c6581=_0x5ee7df[_0x35e64d(0x1f8)](_0x5782fb=>{const _0x40e55a=_0x35e64d,{content:_0x2fd47a}=_0x5782fb,_0x32419b=_0x2fd47a[_0x40e55a(0x1e1)](/\*\*(.+?)\*\*/),_0x138425=_0x32419b?_0x32419b[0x1]:'';if(!_0x138425)return![];return _0x138425[_0x40e55a(0x252)](_0x523629)&&!_0xe90507['includes'](_0x5782fb['id']);});return _0x2c6581;}async[_0x2ecfb0(0x259)](_0x5f8f93,_0x3cdf71,_0x25e2c8){const _0x1dfd80=_0x2ecfb0,_0x3cbebc=await this[_0x1dfd80(0x218)](),_0x5d9628=await this[_0x1dfd80(0x1dd)](_0x3cbebc,_0x25e2c8,_0x3cdf71);if(_0x5d9628)return console[_0x1dfd80(0x257)]('有历史信息之间返回:\x20',_0x5d9628),_0x5d9628;const {application_id:_0x3422b6,guild_id:_0x4249a7,channel_id:_0x604afc,session_id:_0xbba15b,version:_0x2e6bfb,id:_0x5dd971,authorization:_0x5ab30b,mjProxy:_0x44a451}=await this[_0x1dfd80(0x1eb)](),_0xc2e4f6={'type':0x2,'application_id':_0x3422b6,'guild_id':_0x4249a7,'channel_id':_0x604afc,'session_id':_0xbba15b,'data':{'version':_0x2e6bfb,'id':_0x5dd971,'name':_0x1dfd80(0x1e4),'type':0x1,'options':[{'type':0x3,'name':'prompt','value':_0x5f8f93}],'attachments':[]}};try{const _0x33ff51=_0x44a451==0x1?'http://172.247.48.137:8000/mj/draw':_0x1dfd80(0x222),_0x1fd26c={'authorization':_0x5ab30b},_0x405020=await axios_1['default'][_0x1dfd80(0x1ed)](_0x33ff51,_0xc2e4f6,{'headers':_0x1fd26c});return console['log']('发送绘画指令结果:\x20',_0x405020[_0x1dfd80(0x202)]),![];}catch(_0x3451c4){console['log']('axios:\x20',_0x3451c4);throw new common_1[(_0x1dfd80(0x22f))](_0x1dfd80(0x25d),common_1[_0x1dfd80(0x224)]['BAD_REQUEST']);}}async[_0x2ecfb0(0x230)](_0x1a2b45,_0x9966ee,_0x1385c2){const _0x413486=_0x2ecfb0;console[_0x413486(0x257)]('开始查询绘画结果轮询');const _0x2e1f4f=Date[_0x413486(0x226)]();try{const _0x54d008=0xd,_0x3da5ae=0x2ee0,_0xccd218=0x1388,_0x225e09=0x3c*0x3e8;let _0x3b30f4=0x0,_0x623d09=![],_0x1bce5f=null;while(!_0x1bce5f&&_0x3b30f4<_0x54d008){console[_0x413486(0x257)]('第\x20'+(_0x3b30f4+0x1)+'\x20次开始查询');Date[_0x413486(0x226)]()-_0x2e1f4f>=_0x225e09&&(_0x623d09=!![]);await this[_0x413486(0x246)](_0x623d09?_0xccd218:_0x3da5ae);const _0x38cc6f=await this[_0x413486(0x218)]();_0x1bce5f=await this[_0x413486(0x1dd)](_0x38cc6f,_0x1385c2,_0x9966ee),_0x3b30f4++;}if(!_0x1bce5f)throw new common_1[(_0x413486(0x22f))](_0x413486(0x1d5),common_1[_0x413486(0x224)][_0x413486(0x267)]);const _0x30c71b=Date['now']();return console[_0x413486(0x257)](_0x413486(0x1d4)+Math['floor']((_0x30c71b-_0x2e1f4f)/0x3e8)+'\x20S'),_0x1bce5f;}catch(_0x4e1e49){console['error'](_0x4e1e49[_0x413486(0x1c4)]);throw new common_1[(_0x413486(0x22f))](_0x413486(0x1e7),common_1[_0x413486(0x224)][_0x413486(0x1d8)]);}}async[_0x2ecfb0(0x1dd)](_0x149884,_0x11fe83,_0x303750){const _0x2ccfa0=_0x2ecfb0;if(!_0x149884||!_0x149884[_0x2ccfa0(0x244)])return;console[_0x2ccfa0(0x257)](_0x2ccfa0(0x23e),_0x11fe83);const _0x19e3ce=_0x149884[_0x2ccfa0(0x1f8)](_0x2006eb=>{const _0x21910a=_0x2ccfa0,{attachments:attachments=[],content:_0x1e9942,edited_timestamp:_0x273d77}=_0x2006eb;return _0x1e9942[_0x21910a(0x252)](_0x11fe83)&&attachments['length']>0x0&&!_0x273d77&&!_0x303750['includes'](_0x2006eb['id']);});return _0x19e3ce||null;}async[_0x2ecfb0(0x218)](){const _0x20d5e0=_0x2ecfb0;try{const {application_id:_0x32ef8a,guild_id:_0x48c5ba,channel_id:_0xe137fe,session_id:_0x28e3bc,version:_0x565f78,id:_0x2a1a22,authorization:_0x2ebdd9,mjProxy:_0x457173}=await this[_0x20d5e0(0x1eb)](),_0x26ac4a=_0x457173==0x1?'http://172.247.48.137:8000/mj/list?channel_id='+_0xe137fe:_0x20d5e0(0x1de)+_0xe137fe+_0x20d5e0(0x22a),_0x3be528={'authorization':_0x2ebdd9},_0x305257=await axios_1[_0x20d5e0(0x23d)][_0x20d5e0(0x238)](_0x26ac4a,{'headers':_0x3be528});return _0x305257[_0x20d5e0(0x202)];}catch(_0x27adc8){console[_0x20d5e0(0x257)](_0x20d5e0(0x25b),_0x27adc8);throw new common_1[(_0x20d5e0(0x22f))](_0x20d5e0(0x207),common_1[_0x20d5e0(0x224)][_0x20d5e0(0x267)]);}}async[_0x2ecfb0(0x246)](_0x5294cd){return new Promise(_0x3fa72b=>setTimeout(_0x3fa72b,_0x5294cd));}[_0x2ecfb0(0x21e)](_0x1d8a82){const _0x50ec5e=_0x2ecfb0,_0x90387f=_0x1d8a82[_0x50ec5e(0x1e1)](/\*\*(.+?)\*\*/),_0x232329=_0x1d8a82[_0x50ec5e(0x1e1)](/- Image #(\d+)/);if(!_0x90387f||!_0x232329)return null;const _0x41f147=_0x90387f[0x1],_0x1b170d=parseInt(_0x232329[0x1]);return{'prompt':_0x41f147,'order':_0x1b170d};}async[_0x2ecfb0(0x1eb)](){const _0x3c3285=_0x2ecfb0,_0x54fa35=await this[_0x3c3285(0x1f1)][_0x3c3285(0x263)]([_0x3c3285(0x23b),'mjApplicationId','mjGuildId',_0x3c3285(0x1e3),'mjSessionId',_0x3c3285(0x216),_0x3c3285(0x25a),_0x3c3285(0x1db),_0x3c3285(0x1fc)]),_0x3c494c={'application_id':_0x54fa35[_0x3c3285(0x24c)],'guild_id':_0x54fa35[_0x3c3285(0x1d3)],'channel_id':_0x54fa35[_0x3c3285(0x1e3)],'session_id':_0x54fa35[_0x3c3285(0x23a)],'version':_0x54fa35[_0x3c3285(0x216)],'id':_0x54fa35[_0x3c3285(0x23b)],'authorization':_0x54fa35[_0x3c3285(0x25a)],'mjRateLimit':_0x54fa35[_0x3c3285(0x1db)],'mjProxy':_0x54fa35[_0x3c3285(0x1fc)]||0x0};return _0x3c494c;}['removeEmoji'](_0x10e3b7){const _0x2ee013=_0x2ecfb0,_0x31d66e=/[\uD800-\uDBFF][\uDC00-\uDFFF]/g;return _0x10e3b7[_0x2ee013(0x201)](_0x31d66e,'');}async['checkAuth'](_0x357da5){const _0x5f17ab=_0x2ecfb0,_0x562249=await this[_0x5f17ab(0x260)][_0x5f17ab(0x1ea)]({'where':{'userId':_0x357da5[_0x5f17ab(0x25c)]['id']}})[_0x5f17ab(0x20e)](_0x2fa021=>{const _0x11a67e=_0x5f17ab;common_1[_0x11a67e(0x1ef)][_0x11a67e(0x20b)](_0x2fa021);});console[_0x5f17ab(0x257)](_0x562249);if(!_0x562249)return![];const {id:_0x14a425,balance:_0x569943}=_0x562249;if(!_0x569943||_0x562249?.[_0x5f17ab(0x242)]<0x1)throw new common_1[(_0x5f17ab(0x22f))](_0x5f17ab(0x1cb),common_1[_0x5f17ab(0x224)][_0x5f17ab(0x267)]);return!![];}async['checkFree'](_0x164efc){const _0x1864a9=_0x2ecfb0,{id:_0x2b19a7,role:_0x35087b}=_0x164efc[_0x1864a9(0x25c)];!this[_0x1864a9(0x26e)][_0x2b19a7]?this['freeQueueUsers'][_0x2b19a7]=0x1:this['freeQueueUsers'][_0x2b19a7]=this[_0x1864a9(0x26e)][_0x2b19a7]+0x1,console[_0x1864a9(0x257)](_0x1864a9(0x20c)+_0x2b19a7+_0x1864a9(0x1ec),this[_0x1864a9(0x26e)][_0x2b19a7]);}async[_0x2ecfb0(0x24d)](_0x19b3f6){const _0x5c2401=_0x2ecfb0,{id:_0x503d5f,role:_0x5828c6}=_0x19b3f6[_0x5c2401(0x25c)];if([_0x5c2401(0x1cf),_0x5c2401(0x24a)][_0x5c2401(0x252)](_0x5828c6))return!![];const {mjRateLimit:_0x585f34}=await this[_0x5c2401(0x1eb)]();if(this['rateLimits'][_0x503d5f]){const _0x35a485=this[_0x5c2401(0x209)][_0x503d5f];if(_0x35a485>Date[_0x5c2401(0x226)]()){console['log']('当前用户\x20'+_0x503d5f+_0x5c2401(0x232));throw new common_1[(_0x5c2401(0x22f))](_0x5c2401(0x227)+_0x585f34+_0x5c2401(0x225),common_1['HttpStatus'][_0x5c2401(0x267)]);}else this[_0x5c2401(0x209)][_0x503d5f]=Date[_0x5c2401(0x226)]()+Number(_0x585f34)*0x3e8;}else{const _0x15b769=Date[_0x5c2401(0x226)]();this[_0x5c2401(0x209)][_0x503d5f]=_0x15b769+0x3e8*Number(_0x585f34);}}async['deductBalance'](_0x35bcd3){const _0x2b521e=_0x2ecfb0;await this[_0x2b521e(0x260)]['createQueryBuilder']()['update'](balance_entity_1[_0x2b521e(0x1c1)])[_0x2b521e(0x1d6)]({'balance':()=>'balance\x20-\x201'})['where'](_0x2b521e(0x1ff),{'userId':_0x35bcd3['user']['id']})[_0x2b521e(0x24b)]();}async[_0x2ecfb0(0x236)](){return 0x1;}};MjService=__decorate([(0x0,common_1[_0x2ecfb0(0x250)])(),__param(0x0,(0x0,typeorm_2[_0x2ecfb0(0x223)])(chatLog_entity_1[_0x2ecfb0(0x200)])),__param(0x1,(0x0,typeorm_2[_0x2ecfb0(0x223)])(balance_entity_1[_0x2ecfb0(0x1c1)])),__metadata(_0x2ecfb0(0x1e8),[typeorm_1['Repository'],typeorm_1[_0x2ecfb0(0x1bf)],upload_service_1[_0x2ecfb0(0x221)],chatLog_service_1[_0x2ecfb0(0x22c)],globalConfig_service_1[_0x2ecfb0(0x22e)],fanyi_service_1[_0x2ecfb0(0x1f3)],badwords_service_1['BadwordsService']])],MjService),exports[_0x2ecfb0(0x203)]=MjService;