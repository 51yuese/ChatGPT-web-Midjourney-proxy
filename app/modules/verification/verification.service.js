'use strict';const _0x8a8576=_0x3a5a;(function(_0x530dd3,_0x460415){const _0x1cf110=_0x3a5a,_0x5fbae2=_0x530dd3();while(!![]){try{const _0x136b4d=-parseInt(_0x1cf110(0x201))/0x1*(parseInt(_0x1cf110(0x204))/0x2)+-parseInt(_0x1cf110(0x1d6))/0x3*(parseInt(_0x1cf110(0x1e7))/0x4)+-parseInt(_0x1cf110(0x1d2))/0x5*(-parseInt(_0x1cf110(0x1ed))/0x6)+parseInt(_0x1cf110(0x1ef))/0x7*(-parseInt(_0x1cf110(0x1e8))/0x8)+parseInt(_0x1cf110(0x1f6))/0x9+parseInt(_0x1cf110(0x203))/0xa+-parseInt(_0x1cf110(0x1cb))/0xb;if(_0x136b4d===_0x460415)break;else _0x5fbae2['push'](_0x5fbae2['shift']());}catch(_0x45cef8){_0x5fbae2['push'](_0x5fbae2['shift']());}}}(_0x2e7f,0x8384f));function _0x2e7f(){const _0x3c0b1c=['length','getNamespace','HttpStatus','getOwnPropertyDescriptor','__param','4ZyLHor','验证码不存在','7514330ugmfAY','78236kYrIwj','__esModule','metadata','request','VerificationUseStatusEnum','verifyCode','save','expiresAt','__decorate','createRandomCode','typeorm','验证码发送失败！','7906514OuUyTS','get','HttpException','图形验证码已过期、请重新输入!','VerificationService','确实必要参数错误！','../../common/utils','402575jBDkdk','BAD_REQUEST','verifycationEntity','InjectRepository','1288587RYjpwp','Message','图形验证码错误、请检查填写!','2017-05-25','验证码已过期','object','update','@nestjs/typeorm','getTime','POST','@alicloud/pop-core','./../../common/constants/status.constant','SendSms','redisCacheService','getPhoneVerifyConfig','Code','globalConfigService','8dVMToC','8824NlCRzJ','function','USED','createVerification','@nestjs/common','78YThEqS','S内不得重新发送','1680LRqvDg','https://dysmsapi.aliyuncs.com','findOne','decorate','now','design:paramtypes','../redisCache/redisCache.service','6656391YogzCz','createdAt','ceil','__metadata','stringify','DESC'];_0x2e7f=function(){return _0x3c0b1c;};return _0x2e7f();}function _0x3a5a(_0x207387,_0x8b592e){const _0x2e7f16=_0x2e7f();return _0x3a5a=function(_0x3a5a7f,_0x55115d){_0x3a5a7f=_0x3a5a7f-0x1cb;let _0x13bd3e=_0x2e7f16[_0x3a5a7f];return _0x13bd3e;},_0x3a5a(_0x207387,_0x8b592e);}var __decorate=this&&this[_0x8a8576(0x20c)]||function(_0x136525,_0x395fff,_0x456dce,_0x5be982){const _0x470641=_0x8a8576;var _0x814341=arguments[_0x470641(0x1fc)],_0x13ae25=_0x814341<0x3?_0x395fff:_0x5be982===null?_0x5be982=Object[_0x470641(0x1ff)](_0x395fff,_0x456dce):_0x5be982,_0x38b431;if(typeof Reflect===_0x470641(0x1db)&&typeof Reflect[_0x470641(0x1f2)]===_0x470641(0x1e9))_0x13ae25=Reflect['decorate'](_0x136525,_0x395fff,_0x456dce,_0x5be982);else{for(var _0x34a025=_0x136525[_0x470641(0x1fc)]-0x1;_0x34a025>=0x0;_0x34a025--)if(_0x38b431=_0x136525[_0x34a025])_0x13ae25=(_0x814341<0x3?_0x38b431(_0x13ae25):_0x814341>0x3?_0x38b431(_0x395fff,_0x456dce,_0x13ae25):_0x38b431(_0x395fff,_0x456dce))||_0x13ae25;}return _0x814341>0x3&&_0x13ae25&&Object['defineProperty'](_0x395fff,_0x456dce,_0x13ae25),_0x13ae25;},__metadata=this&&this[_0x8a8576(0x1f9)]||function(_0x11262d,_0x28cf7b){const _0x28521d=_0x8a8576;if(typeof Reflect===_0x28521d(0x1db)&&typeof Reflect['metadata']==='function')return Reflect[_0x28521d(0x206)](_0x11262d,_0x28cf7b);},__param=this&&this[_0x8a8576(0x200)]||function(_0xd8db23,_0x5512a7){return function(_0x3c7bcf,_0xbca07){_0x5512a7(_0x3c7bcf,_0xbca07,_0xd8db23);};};Object['defineProperty'](exports,_0x8a8576(0x205),{'value':!![]}),exports['VerificationService']=void 0x0;const globalConfig_service_1=require('../globalConfig/globalConfig.service'),status_constant_1=require(_0x8a8576(0x1e1)),typeorm_1=require(_0x8a8576(0x1dd)),typeorm_2=require(_0x8a8576(0x20e)),verifycation_entity_1=require('./verifycation.entity'),common_1=require(_0x8a8576(0x1ec)),utils_1=require(_0x8a8576(0x1d1)),redisCache_service_1=require(_0x8a8576(0x1f5)),Core=require(_0x8a8576(0x1e0));let VerificationService=class VerificationService{constructor(_0x1073fe,_0x59f204,_0x52e9cb){const _0x53cccd=_0x8a8576;this[_0x53cccd(0x1d4)]=_0x1073fe,this[_0x53cccd(0x1e6)]=_0x59f204,this['redisCacheService']=_0x52e9cb;}async[_0x8a8576(0x1eb)](_0x1a40cf,_0x599910,_0x2fa5bf=0x1e*0x3c){const _0x4f3d43=_0x8a8576,_0x425ca8=await this[_0x4f3d43(0x1d4)][_0x4f3d43(0x1f1)]({'where':{'userId':_0x1a40cf['id'],'type':_0x599910},'order':{'createdAt':_0x4f3d43(0x1fb)}});if(_0x425ca8&&_0x425ca8[_0x4f3d43(0x1f7)][_0x4f3d43(0x1de)]()+0x1*0x3c*0x3e8>Date[_0x4f3d43(0x1f3)]()){const _0x43a239=Math[_0x4f3d43(0x1f8)]((_0x425ca8['createdAt']['getTime']()+0x1*0x3c*0x3e8-Date[_0x4f3d43(0x1f3)]())/0x3e8);throw new common_1['HttpException'](_0x43a239+_0x4f3d43(0x1ee),common_1[_0x4f3d43(0x1fe)][_0x4f3d43(0x1d3)]);}const _0x3a5492=(0x0,utils_1[_0x4f3d43(0x20d)])(),_0x5e31cc=new Date(Date[_0x4f3d43(0x1f3)]()+_0x2fa5bf*0x3e8),{id:_0x1b1b8c,email:_0x22e3ee}=_0x1a40cf,_0x13301c={'userId':_0x1b1b8c,'type':_0x599910,'code':_0x3a5492,'expiresAt':_0x5e31cc,'email':_0x22e3ee};return await this[_0x4f3d43(0x1d4)][_0x4f3d43(0x20a)](_0x13301c);}async[_0x8a8576(0x209)]({code:_0x399df2,id:_0x53ce84},_0x2fb7f9){const _0x1a4779=_0x8a8576,_0x334b11=await this['verifycationEntity'][_0x1a4779(0x1f1)]({'where':{'id':_0x53ce84,'type':_0x2fb7f9},'order':{'createdAt':_0x1a4779(0x1fb)}});if(!_0x334b11)throw new common_1['HttpException'](_0x1a4779(0x202),common_1[_0x1a4779(0x1fe)][_0x1a4779(0x1d3)]);if(_0x334b11['used']===status_constant_1[_0x1a4779(0x208)][_0x1a4779(0x1ea)])throw new common_1[(_0x1a4779(0x1cd))]('当前验证码已被使用！',common_1['HttpStatus'][_0x1a4779(0x1d3)]);else _0x334b11['used']=status_constant_1[_0x1a4779(0x208)]['USED'],await this[_0x1a4779(0x1d4)][_0x1a4779(0x1dc)]({'id':_0x53ce84},_0x334b11);if(Number(_0x334b11['code'])!==Number(_0x399df2))throw new common_1[(_0x1a4779(0x1cd))]('验证码错误',common_1['HttpStatus'][_0x1a4779(0x1d3)]);if(_0x334b11[_0x1a4779(0x20b)]<new Date())throw new common_1[(_0x1a4779(0x1cd))](_0x1a4779(0x1da),common_1[_0x1a4779(0x1fe)]['BAD_REQUEST']);return _0x334b11;}async['verifyCaptcha'](_0x2b82a4){const _0x437ecf=_0x8a8576,{captchaId:_0x579bc2,captchaCode:_0x4ec652}=_0x2b82a4,_0xb1b341=await this[_0x437ecf(0x1e6)][_0x437ecf(0x1fd)](),_0x4f7e70=_0xb1b341+':CAPTCHA:'+_0x579bc2,_0x2f1b10=await this[_0x437ecf(0x1e3)][_0x437ecf(0x1cc)]({'key':_0x4f7e70});await this['redisCacheService']['del']({'key':_0x4f7e70});if(!_0x2f1b10)throw new common_1[(_0x437ecf(0x1cd))](_0x437ecf(0x1ce),common_1[_0x437ecf(0x1fe)]['BAD_REQUEST']);if(!_0x2f1b10||_0x2f1b10!==_0x4ec652)throw new common_1[(_0x437ecf(0x1cd))](_0x437ecf(0x1d8),common_1['HttpStatus'][_0x437ecf(0x1d3)]);}async['sendPhoneCode'](_0x62f9d7){const _0x4bd8a8=_0x8a8576;var _0x27ed03;const {accessKeyId:_0x539e48,accessKeySecret:_0x70c57,SignName:_0x51f7b3,TemplateCode:_0x866c61}=await this['globalConfigService'][_0x4bd8a8(0x1e4)](),{phone:_0x415431,code:_0x2a96ee}=_0x62f9d7;if(!_0x415431||!_0x2a96ee)throw new common_1[(_0x4bd8a8(0x1cd))](_0x4bd8a8(0x1d0),common_1[_0x4bd8a8(0x1fe)][_0x4bd8a8(0x1d3)]);const _0x206f89=new Core({'accessKeyId':_0x539e48,'accessKeySecret':_0x70c57,'endpoint':_0x4bd8a8(0x1f0),'apiVersion':_0x4bd8a8(0x1d9)}),_0xf19d83={'PhoneNumbers':_0x415431,'SignName':_0x51f7b3,'TemplateCode':_0x866c61,'TemplateParam':JSON[_0x4bd8a8(0x1fa)]({'code':_0x2a96ee})},_0x819d28={'method':_0x4bd8a8(0x1df),'formatParams':![]};try{const _0x3ecaed=await _0x206f89[_0x4bd8a8(0x207)](_0x4bd8a8(0x1e2),_0xf19d83,_0x819d28);if(_0x3ecaed[_0x4bd8a8(0x1e5)]==='OK')return!![];else throw new common_1[(_0x4bd8a8(0x1cd))](_0x3ecaed[_0x4bd8a8(0x1d7)]||_0x4bd8a8(0x20f),common_1[_0x4bd8a8(0x1fe)][_0x4bd8a8(0x1d3)]);}catch(_0x3bc858){throw new common_1['HttpException'](((_0x27ed03=_0x3bc858===null||_0x3bc858===void 0x0?void 0x0:_0x3bc858['data'])===null||_0x27ed03===void 0x0?void 0x0:_0x27ed03[_0x4bd8a8(0x1d7)])||'验证码发送失败！',common_1[_0x4bd8a8(0x1fe)][_0x4bd8a8(0x1d3)]);}}};VerificationService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1[_0x8a8576(0x1d5)])(verifycation_entity_1['VerifycationEntity'])),__metadata(_0x8a8576(0x1f4),[typeorm_2['Repository'],globalConfig_service_1['GlobalConfigService'],redisCache_service_1['RedisCacheService']])],VerificationService),exports[_0x8a8576(0x1cf)]=VerificationService;