'use strict';const _0x46bbcf=_0x42ff;(function(_0xa8fef2,_0x17809a){const _0x123342=_0x42ff,_0x38023c=_0xa8fef2();while(!![]){try{const _0x2737db=-parseInt(_0x123342(0x238))/0x1*(-parseInt(_0x123342(0x19d))/0x2)+parseInt(_0x123342(0x1db))/0x3*(parseInt(_0x123342(0x20a))/0x4)+-parseInt(_0x123342(0x25b))/0x5+parseInt(_0x123342(0x1bb))/0x6*(parseInt(_0x123342(0x210))/0x7)+-parseInt(_0x123342(0x1b8))/0x8*(parseInt(_0x123342(0x1ae))/0x9)+parseInt(_0x123342(0x1b1))/0xa+-parseInt(_0x123342(0x218))/0xb*(parseInt(_0x123342(0x23f))/0xc);if(_0x2737db===_0x17809a)break;else _0x38023c['push'](_0x38023c['shift']());}catch(_0x5bfafc){_0x38023c['push'](_0x38023c['shift']());}}}(_0x364f,0x1c738));var __decorate=this&&this['__decorate']||function(_0x360a7d,_0xb1dc3,_0x5b31b5,_0x5c9578){const _0x57e4ab=_0x42ff;var _0xd76587=arguments['length'],_0x39b4b0=_0xd76587<0x3?_0xb1dc3:_0x5c9578===null?_0x5c9578=Object[_0x57e4ab(0x1ac)](_0xb1dc3,_0x5b31b5):_0x5c9578,_0x117fd8;if(typeof Reflect===_0x57e4ab(0x1b4)&&typeof Reflect[_0x57e4ab(0x253)]===_0x57e4ab(0x197))_0x39b4b0=Reflect[_0x57e4ab(0x253)](_0x360a7d,_0xb1dc3,_0x5b31b5,_0x5c9578);else{for(var _0x59a5b0=_0x360a7d[_0x57e4ab(0x1ec)]-0x1;_0x59a5b0>=0x0;_0x59a5b0--)if(_0x117fd8=_0x360a7d[_0x59a5b0])_0x39b4b0=(_0xd76587<0x3?_0x117fd8(_0x39b4b0):_0xd76587>0x3?_0x117fd8(_0xb1dc3,_0x5b31b5,_0x39b4b0):_0x117fd8(_0xb1dc3,_0x5b31b5))||_0x39b4b0;}return _0xd76587>0x3&&_0x39b4b0&&Object[_0x57e4ab(0x1cd)](_0xb1dc3,_0x5b31b5,_0x39b4b0),_0x39b4b0;},__metadata=this&&this[_0x46bbcf(0x1b3)]||function(_0x823c31,_0x25f989){const _0x13bfaf=_0x46bbcf;if(typeof Reflect==='object'&&typeof Reflect[_0x13bfaf(0x23b)]===_0x13bfaf(0x197))return Reflect[_0x13bfaf(0x23b)](_0x823c31,_0x25f989);},__param=this&&this[_0x46bbcf(0x1c2)]||function(_0x4b8c16,_0x5ad264){return function(_0x56f2a4,_0x32cd19){_0x5ad264(_0x56f2a4,_0x32cd19,_0x4b8c16);};};function _0x42ff(_0x3cea5e,_0x50abd6){const _0x364f46=_0x364f();return _0x42ff=function(_0x42ff2b,_0x57cbc0){_0x42ff2b=_0x42ff2b-0x18d;let _0x4c5b35=_0x364f46[_0x42ff2b];return _0x4c5b35;},_0x42ff(_0x3cea5e,_0x50abd6);}Object[_0x46bbcf(0x1cd)](exports,'__esModule',{'value':!![]}),exports['UserBalanceService']=void 0x0;const globalConfig_service_1=require(_0x46bbcf(0x1d6)),typeorm_1=require(_0x46bbcf(0x1cb)),balance_entity_1=require(_0x46bbcf(0x1cc)),common_1=require(_0x46bbcf(0x1bd)),typeorm_2=require('typeorm'),balance_constant_1=require(_0x46bbcf(0x202)),accountLog_entity_1=require('./accountLog.entity'),utils_1=require(_0x46bbcf(0x22d)),config_entity_1=require(_0x46bbcf(0x23a)),cramiPackage_entity_1=require(_0x46bbcf(0x1d4)),userBalance_entity_1=require(_0x46bbcf(0x254)),date_1=require(_0x46bbcf(0x19f)),user_entity_1=require(_0x46bbcf(0x200)),salesUsers_entity_1=require('../sales/salesUsers.entity'),sales_service_1=require(_0x46bbcf(0x203)),whiteList_entity_1=require(_0x46bbcf(0x225)),fingerprint_entity_1=require(_0x46bbcf(0x1da)),chatLog_entity_1=require('../chatLog/chatLog.entity'),chatGroup_entity_1=require(_0x46bbcf(0x259)),midjourney_entity_1=require(_0x46bbcf(0x24e));let UserBalanceService=class UserBalanceService{constructor(_0x389f99,_0x3e99d0,_0x178447,_0x577638,_0x18daf1,_0x4885f1,_0x173486,_0x37d77d,_0x94a26,_0x537b1a,_0x4b25f3,_0x3a4b14,_0x2b70a0,_0x46fb79){const _0x204154=_0x46bbcf;this[_0x204154(0x1c1)]=_0x389f99,this[_0x204154(0x1e2)]=_0x3e99d0,this[_0x204154(0x1f8)]=_0x178447,this[_0x204154(0x230)]=_0x577638,this['configEntity']=_0x18daf1,this[_0x204154(0x220)]=_0x4885f1,this[_0x204154(0x251)]=_0x173486,this[_0x204154(0x1fc)]=_0x37d77d,this[_0x204154(0x1dd)]=_0x94a26,this['chatGroupEntity']=_0x537b1a,this[_0x204154(0x229)]=_0x4b25f3,this[_0x204154(0x1f0)]=_0x3a4b14,this[_0x204154(0x22c)]=_0x2b70a0,this[_0x204154(0x18e)]=_0x46fb79;}async[_0x46bbcf(0x209)](_0x527fec,_0x5e26c4){const _0x36b8c0=_0x46bbcf;try{const _0x9c1dd4=await this['configEntity'][_0x36b8c0(0x20e)]({'where':{'configKey':(0x0,typeorm_2['In'])([_0x36b8c0(0x22a),'registerSendModel3Count',_0x36b8c0(0x206),'registerSendDrawMjCount',_0x36b8c0(0x1ab),_0x36b8c0(0x1fe),_0x36b8c0(0x243),'firstRregisterSendModel4Count',_0x36b8c0(0x1d7),_0x36b8c0(0x1f7),_0x36b8c0(0x191),_0x36b8c0(0x21f),_0x36b8c0(0x1d8),'invitedGuestSendModel3Count',_0x36b8c0(0x1bf),'invitedGuestSendModel4Count'])}}),_0x4a80d0=_0x9c1dd4[_0x36b8c0(0x249)]((_0xe9327b,_0x59141d)=>{const _0xdddb1a=_0x36b8c0,_0x172177=Number(_0x59141d[_0xdddb1a(0x1dc)]),_0x47f9fc=Number['isInteger'](_0x172177)&&_0x172177>0x0?_0x172177:0x0;return _0xe9327b[_0x59141d[_0xdddb1a(0x247)]]=_0x47f9fc,_0xe9327b;},{});let _0x209cf2=0x0,_0x3497c7=0x0,_0x54ceb8=0x0;_0x4a80d0[_0x36b8c0(0x22a)]===0x1&&(_0x209cf2=_0x209cf2+_0x4a80d0[_0x36b8c0(0x241)],_0x3497c7=_0x3497c7+_0x4a80d0[_0x36b8c0(0x206)],_0x54ceb8=_0x54ceb8+_0x4a80d0[_0x36b8c0(0x20c)]),_0x4a80d0['registerSendStatus']===0x1&&_0x4a80d0[_0x36b8c0(0x1ab)]===0x1&&_0x527fec<=_0x4a80d0['firstRegisterSendRank']&&(_0x209cf2=_0x209cf2+_0x4a80d0[_0x36b8c0(0x243)],_0x3497c7=_0x3497c7+_0x4a80d0['firstRregisterSendModel4Count'],_0x54ceb8=_0x54ceb8+_0x4a80d0[_0x36b8c0(0x1d7)]),await this['saveRecordRechargeLog']({'userId':_0x527fec,'rechargeType':balance_constant_1[_0x36b8c0(0x1e8)][_0x36b8c0(0x1b9)],'model3Count':_0x209cf2,'drawMjCount':_0x54ceb8,'model4Count':_0x3497c7}),_0x5e26c4&&(Number(_0x4a80d0[_0x36b8c0(0x1f7)])===0x1&&(_0x209cf2=_0x209cf2+Number(_0x4a80d0['invitedGuestSendModel3Count']),_0x3497c7=_0x3497c7+Number(_0x4a80d0[_0x36b8c0(0x23d)]),_0x54ceb8=_0x54ceb8+Number(_0x4a80d0[_0x36b8c0(0x1bf)]),await this[_0x36b8c0(0x22e)]({'userId':_0x527fec,'rechargeType':balance_constant_1[_0x36b8c0(0x1e8)][_0x36b8c0(0x1f4)],'model3Count':_0x4a80d0[_0x36b8c0(0x1f5)],'model4Count':_0x4a80d0[_0x36b8c0(0x23d)],'drawMjCount':_0x4a80d0[_0x36b8c0(0x1bf)]}),await this[_0x36b8c0(0x255)](_0x5e26c4,{'model3Count':_0x4a80d0['inviteGiveSendModel3Count'],'model4Count':_0x4a80d0['inviteGiveSendModel4Count'],'drawMjCount':_0x4a80d0[_0x36b8c0(0x1d8)]}),await this[_0x36b8c0(0x22e)]({'userId':_0x5e26c4,'rechargeType':balance_constant_1[_0x36b8c0(0x1e8)]['REFER_GIFT'],'model3Count':_0x4a80d0[_0x36b8c0(0x191)],'model4Count':_0x4a80d0[_0x36b8c0(0x21f)],'drawMjCount':_0x4a80d0[_0x36b8c0(0x1d8)]}))),await this[_0x36b8c0(0x1e2)][_0x36b8c0(0x1ce)]({'userId':_0x527fec,'model3Count':_0x209cf2,'model4Count':_0x3497c7,'drawMjCount':_0x54ceb8,'useTokens':0x0});}catch(_0x33cebf){console['log'](_0x36b8c0(0x20d),_0x33cebf);throw new common_1[(_0x36b8c0(0x1cf))]('注册赠送失败,请联系管理员！',common_1[_0x36b8c0(0x1b7)]['BAD_REQUEST']);}}async[_0x46bbcf(0x216)](_0x24cb50,_0x33cfda,_0x3e7c5e){const _0x2fe18b=_0x46bbcf,{id:_0x3160e8,role:_0x2f4560}=_0x24cb50['user'];let _0xa041a9=await this[_0x2fe18b(0x1e2)]['findOne']({'where':{'userId':_0x3160e8}})[_0x2fe18b(0x250)](_0x3128e2=>{const _0x31caa4=_0x2fe18b;common_1[_0x31caa4(0x231)][_0x31caa4(0x226)](_0x3128e2);});!_0xa041a9&&(_0xa041a9=await this[_0x2fe18b(0x1b0)](_0x3160e8)[_0x2fe18b(0x250)](_0x2d07f7=>{const _0x1fbfb0=_0x2fe18b;common_1[_0x1fbfb0(0x231)]['error'](_0x2d07f7);}));if(_0x2f4560===_0x2fe18b(0x1c6))return this[_0x2fe18b(0x190)](_0x24cb50,_0x33cfda,_0x3e7c5e)[_0x2fe18b(0x250)](_0x24608d=>{const _0x5d7674=_0x2fe18b;common_1[_0x5d7674(0x231)]['error'](_0x24608d);});const _0x3c6ff9=await this[_0x2fe18b(0x23e)][_0x2fe18b(0x21b)]({'where':{'configKey':_0x2fe18b(0x1bc)}})[_0x2fe18b(0x250)](_0x140f47=>{const _0x206247=_0x2fe18b;common_1[_0x206247(0x231)]['error'](_0x140f47);}),_0x552512=_0x3c6ff9?_0x3c6ff9[_0x2fe18b(0x1dc)]:'---',_0x109ead=_0x33cfda==='model3'?_0x2fe18b(0x1ed):_0x33cfda===_0x2fe18b(0x256)?'memberModel4Count':_0x33cfda===_0x2fe18b(0x1ef)?_0x2fe18b(0x1e4):null,_0x550744=_0x33cfda===_0x2fe18b(0x1e3)?'model3Count':_0x33cfda===_0x2fe18b(0x256)?'model4Count':_0x33cfda==='mjDraw'?_0x2fe18b(0x239):null;if(!_0xa041a9)throw new common_1[(_0x2fe18b(0x1cf))]('您的账户余额不足,如果想继续体验服务,请联系管理员\x20<VX:\x20'+_0x552512+_0x2fe18b(0x22b),common_1[_0x2fe18b(0x1b7)]['PAYMENT_REQUIRED']);if(_0xa041a9[_0x2fe18b(0x201)]&&_0xa041a9[_0x109ead]<_0x3e7c5e){if(_0xa041a9[_0x550744]<_0x3e7c5e)throw new common_1['HttpException']('您的账户余额不足,如果想继续体验服务,请联系管理员\x20<VX:\x20'+_0x552512+_0x2fe18b(0x22b),common_1['HttpStatus'][_0x2fe18b(0x1d0)]);}if(!_0xa041a9['packageId']&&_0xa041a9[_0x550744]<_0x3e7c5e)throw new common_1[(_0x2fe18b(0x1cf))](_0x2fe18b(0x208)+_0x552512+_0x2fe18b(0x22b),common_1[_0x2fe18b(0x1b7)]['PAYMENT_REQUIRED']);return _0xa041a9;}async[_0x46bbcf(0x190)](_0x34905b,_0x94ae9e,_0x2e6460){const _0x52e404=_0x46bbcf,{id:_0x35100c}=_0x34905b[_0x52e404(0x1d9)],_0x5d77a7=_0x94ae9e===_0x52e404(0x1e3)?'model3Count':_0x94ae9e===_0x52e404(0x256)?_0x52e404(0x21e):_0x94ae9e===_0x52e404(0x1ef)?_0x52e404(0x239):null,_0x200e9c=await this[_0x52e404(0x1dd)][_0x52e404(0x21b)]({'where':{'fingerprint':_0x35100c+''}}),{visitorModel3Num:_0x3f90e2,visitorModel4Num:_0x7aded1,visitorMJNum:_0x31ce10}=await this[_0x52e404(0x18e)][_0x52e404(0x196)]([_0x52e404(0x222),'visitorModel4Num','visitorMJNum']),_0x50d5ce={'model3Count':_0x3f90e2?Number(_0x3f90e2):0x0,'model4Count':_0x7aded1?Number(_0x7aded1):0x0,'drawMjCount':_0x31ce10?Number(_0x31ce10):0x0};if(!_0x200e9c){let _0x491565={'fingerprint':_0x35100c,'model3Count':0x0,'model4Count':0x0,'drawMjCount':0x0};_0x491565[_0x5d77a7]=_0x491565[_0x5d77a7]+_0x2e6460;if(_0x491565[_0x5d77a7]>_0x50d5ce[_0x5d77a7])throw new common_1[(_0x52e404(0x1cf))]('今日当前类型免费额度已经使用完毕、建议您注册账户体验更加完整的服务内容！',common_1['HttpStatus'][_0x52e404(0x1d0)]);else return await this[_0x52e404(0x1dd)]['save'](_0x491565),!![];}else{const {model3Count:_0x2579ea,model4Count:_0x4b8502,drawMjCount:_0x10074c}=_0x200e9c;let _0x3df8bb={'model3Count':_0x2579ea,'model4Count':_0x4b8502,'drawMjCount':_0x10074c};const _0x25d500=Number(new Date(_0x200e9c[_0x52e404(0x20b)])),_0x3265fc=this[_0x52e404(0x1a9)](_0x25d500);_0x3265fc?_0x3df8bb[_0x5d77a7]=_0x3df8bb[_0x5d77a7]+_0x2e6460:(_0x3df8bb={'model3Count':0x0,'model4Count':0x0,'drawMjCount':0x0},_0x3df8bb[_0x5d77a7]=_0x3df8bb[_0x5d77a7]+_0x2e6460);if(_0x3df8bb[_0x5d77a7]>_0x50d5ce[_0x5d77a7])throw new common_1[(_0x52e404(0x1cf))]('今日当前类型免费额度已经使用完毕、建议您注册账户体验更加完整的服务内容！',common_1['HttpStatus'][_0x52e404(0x1d0)]);else return await this[_0x52e404(0x1dd)][_0x52e404(0x1b6)]({'fingerprint':_0x35100c+''},_0x3df8bb),!![];}}[_0x46bbcf(0x1a9)](_0x572dcd){const _0x20fa31=_0x46bbcf,_0x1704d1=new Date(),_0x4f78d1=new Date(_0x1704d1[_0x20fa31(0x1de)](),_0x1704d1[_0x20fa31(0x1b2)](),_0x1704d1[_0x20fa31(0x1c9)]());return _0x572dcd>=_0x4f78d1;}async[_0x46bbcf(0x1ca)](_0x504f23,_0x5df9a1,_0x146c64,_0x24a465=0x0){const _0x228652=_0x46bbcf,_0x4e244e=await this['userBalanceEntity'][_0x228652(0x21b)]({'where':{'userId':_0x504f23}});if(!_0x4e244e)throw new common_1[(_0x228652(0x1cf))](_0x228652(0x1a0),common_1[_0x228652(0x1b7)][_0x228652(0x1fa)]);const _0x85f47d=_0x5df9a1==='model3'?_0x228652(0x1ed):_0x5df9a1===_0x228652(0x256)?_0x228652(0x204):_0x5df9a1===_0x228652(0x1ef)?'memberDrawMjCount':null,_0x36a8fe=_0x5df9a1===_0x228652(0x1e3)?'model3Count':_0x5df9a1===_0x228652(0x256)?'model4Count':_0x5df9a1===_0x228652(0x1ef)?_0x228652(0x239):null,_0x2a59ba=_0x4e244e[_0x228652(0x201)]&&_0x4e244e[_0x85f47d]<_0x146c64?_0x36a8fe:_0x4e244e[_0x228652(0x201)]?_0x85f47d:_0x36a8fe;let _0x4fba74=null;_0x2a59ba[_0x228652(0x232)](_0x228652(0x18f))&&(_0x4fba74=_0x228652(0x1c3));_0x2a59ba[_0x228652(0x232)](_0x228652(0x227))&&(_0x4fba74=_0x228652(0x20f));_0x2a59ba[_0x228652(0x232)](_0x228652(0x192))&&(_0x4fba74=_0x228652(0x1d2));const _0x5f2a0e={[_0x2a59ba]:_0x4e244e[_0x2a59ba]-_0x146c64<0x0?0x0:_0x4e244e[_0x2a59ba]-_0x146c64,[_0x4fba74]:_0x4e244e[_0x4fba74]+_0x24a465};_0x4fba74===_0x228652(0x1c3)&&(_0x5f2a0e[_0x228652(0x24c)]=_0x4e244e[_0x228652(0x24c)]+0x1),_0x4fba74===_0x228652(0x20f)&&(_0x5f2a0e[_0x228652(0x1e9)]=_0x4e244e['useModel4Count']+0x1);const _0x1a0ac9=await this[_0x228652(0x1e2)][_0x228652(0x21b)]({'where':{'userId':_0x504f23}}),_0x91ee54=await this[_0x228652(0x1e2)][_0x228652(0x1b6)]({'userId':_0x504f23},_0x5f2a0e),_0x3a0427=await this[_0x228652(0x1e2)][_0x228652(0x21b)]({'where':{'userId':_0x504f23}}),_0x4b7225=await this[_0x228652(0x1f8)][_0x228652(0x21b)]({'where':{'userId':_0x504f23},'order':{'createdAt':_0x228652(0x1ba)}});if(_0x4b7225){const _0x249183=new accountLog_entity_1[(_0x228652(0x1a3))]();_0x249183['userId']=_0x504f23,_0x249183[_0x228652(0x21d)]='',_0x249183[_0x228652(0x1f1)]=_0x4b7225[_0x228652(0x1f1)],_0x249183[_0x228652(0x237)]=balance_constant_1[_0x228652(0x1e8)][_0x228652(0x211)],_0x249183[_0x228652(0x1a2)]=_0x3a0427[_0x228652(0x1ed)],_0x249183[_0x228652(0x21e)]=_0x3a0427['memberModel4Count'],_0x249183[_0x228652(0x239)]=_0x3a0427[_0x228652(0x1e4)],_0x249183[_0x228652(0x1df)]=_0x3a0427[_0x228652(0x1ed)]-_0x1a0ac9['memberModel3Count'],_0x249183[_0x228652(0x1e1)]=_0x3a0427[_0x228652(0x204)]-_0x1a0ac9['memberModel4Count'],_0x249183[_0x228652(0x212)]=_0x3a0427[_0x228652(0x1e4)]-_0x1a0ac9[_0x228652(0x1e4)],await this[_0x228652(0x1f8)][_0x228652(0x1ce)](_0x249183);}if(_0x91ee54[_0x228652(0x21a)]===0x0)throw new common_1[(_0x228652(0x1cf))](_0x228652(0x24d),common_1[_0x228652(0x1b7)]['BAD_REQUEST']);return!![];}async[_0x46bbcf(0x1a4)](_0xb83b32,_0x25a9d8){const _0x17284a=_0x46bbcf,_0x3cd96e=await this['userBalanceEntity'][_0x17284a(0x21b)]({'where':{'userId':_0xb83b32}});if(!_0x3cd96e)throw new common_1[(_0x17284a(0x1cf))](_0x17284a(0x1a0),common_1[_0x17284a(0x1b7)]['BAD_REQUEST']);const _0x41b3d8={['drawMjCount']:_0x3cd96e['drawMjCount']+_0x25a9d8,['useDrawMjToken']:_0x3cd96e[_0x17284a(0x1d2)]-_0x25a9d8},_0x4c6e4c=await this[_0x17284a(0x1e2)][_0x17284a(0x1b6)]({'userId':_0xb83b32},_0x41b3d8);if(_0x4c6e4c[_0x17284a(0x21a)]===0x0)throw new common_1[(_0x17284a(0x1cf))](_0x17284a(0x24d),common_1[_0x17284a(0x1b7)]['BAD_REQUEST']);}async['queryUserBalance'](_0x2a45bc){const _0x58f02e=_0x46bbcf;try{const _0x2c8b48=await this[_0x58f02e(0x1e2)][_0x58f02e(0x21b)]({'where':{'userId':_0x2a45bc},'select':['packageId','model3Count',_0x58f02e(0x21e),_0x58f02e(0x239),_0x58f02e(0x1ed),'memberModel4Count',_0x58f02e(0x1e4),_0x58f02e(0x24c),_0x58f02e(0x1e9),_0x58f02e(0x1c3),_0x58f02e(0x20f),_0x58f02e(0x1d2),_0x58f02e(0x1d1)]});if(!_0x2c8b48){const _0x1a2ad9=await this['createBaseUserBalance'](_0x2a45bc);if(_0x1a2ad9)return await this[_0x58f02e(0x235)](_0x2a45bc);else throw new common_1[(_0x58f02e(0x1cf))]('查询当前用户余额失败！',common_1[_0x58f02e(0x1b7)][_0x58f02e(0x1fa)]);}return _0x2c8b48[_0x58f02e(0x1d3)]=_0x2c8b48[_0x58f02e(0x201)]?_0x2c8b48[_0x58f02e(0x1a2)]+_0x2c8b48[_0x58f02e(0x1ed)]:_0x2c8b48[_0x58f02e(0x1a2)],_0x2c8b48[_0x58f02e(0x215)]=_0x2c8b48[_0x58f02e(0x201)]?_0x2c8b48[_0x58f02e(0x21e)]+_0x2c8b48[_0x58f02e(0x204)]:_0x2c8b48[_0x58f02e(0x21e)],_0x2c8b48[_0x58f02e(0x224)]=_0x2c8b48[_0x58f02e(0x201)]?_0x2c8b48[_0x58f02e(0x239)]+_0x2c8b48[_0x58f02e(0x1e4)]:_0x2c8b48['drawMjCount'],_0x2c8b48[_0x58f02e(0x1d1)]=_0x2c8b48['expirationTime']?(0x0,date_1['formatDate'])(_0x2c8b48['expirationTime'],_0x58f02e(0x19c)):null,_0x2c8b48;}catch(_0x5e70d3){console[_0x58f02e(0x1f3)](_0x58f02e(0x20d),_0x5e70d3);}}async['saveRecordRechargeLog'](_0x361040){const _0x1b5a60=_0x46bbcf,{userId:_0xdf82dc,rechargeType:_0x4868ca,model3Count:_0x5243cc,model4Count:_0xbbfe3,drawMjCount:_0x271116,days:days=-0x1,pkgName:pkgName='',extent:extent=''}=_0x361040;if(!_0xdf82dc)throw new common_1[(_0x1b5a60(0x1cf))](_0x1b5a60(0x19e),common_1[_0x1b5a60(0x1b7)][_0x1b5a60(0x1fa)]);const _0x3e4cb5=(0x0,utils_1[_0x1b5a60(0x1c8)])();return await this[_0x1b5a60(0x1f8)][_0x1b5a60(0x1ce)]({'userId':_0xdf82dc,'rechargeType':_0x4868ca,'model3Count':_0x5243cc,'model4Count':_0xbbfe3,'drawMjCount':_0x271116,'days':days,'extent':extent,'uid':_0x3e4cb5,'pkgName':pkgName});}async[_0x46bbcf(0x1b0)](_0x24747b,_0x2720b2={}){const _0x557bf3=_0x46bbcf,{model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0x2720b2,_0x9b5866=await this['userBalanceEntity'][_0x557bf3(0x21b)]({'where':{'userId':_0x24747b}});if(_0x9b5866)throw new common_1[(_0x557bf3(0x1cf))]('当前用户无需创建账户信息！',common_1[_0x557bf3(0x1b7)][_0x557bf3(0x1fa)]);return await this[_0x557bf3(0x1e2)][_0x557bf3(0x1ce)]({'userId':_0x24747b,'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount});}async[_0x46bbcf(0x255)](_0x26a0ff,_0x3773a5,_0x2c1d7e=-0x1){const _0x381317=_0x46bbcf;try{const _0x13cec0=await this[_0x381317(0x1e2)]['findOne']({'where':{'userId':_0x26a0ff}})||await this[_0x381317(0x1b0)](_0x26a0ff);if(!_0x13cec0)throw new common_1[(_0x381317(0x1cf))](_0x381317(0x221),common_1[_0x381317(0x1b7)][_0x381317(0x1fa)]);const {model3Count:_0x113bd6,model4Count:_0x53127a,drawMjCount:_0x191b33,memberModel3Count:_0x365933,memberModel4Count:_0x4b8ad4,memberDrawMjCount:_0x1b4b6e}=_0x13cec0;let _0x3ccfd5={};if(_0x2c1d7e>0x0){const {packageId:_0x5f0edf}=_0x3773a5;if(!_0x5f0edf)throw new common_1[(_0x381317(0x1cf))](_0x381317(0x1eb),common_1[_0x381317(0x1b7)][_0x381317(0x1fa)]);const _0x521abe=await this['cramiPackageEntity'][_0x381317(0x21b)]({'where':{'id':_0x5f0edf}});if(!_0x521abe)throw new common_1[(_0x381317(0x1cf))](_0x381317(0x1c4),common_1[_0x381317(0x1b7)][_0x381317(0x1fa)]);const {weight:_0x7d94f7}=_0x521abe;if(!_0x13cec0[_0x381317(0x201)])_0x3ccfd5={'memberModel3Count':_0x113bd6+_0x3773a5[_0x381317(0x1a2)],'memberModel4Count':_0x53127a+_0x3773a5[_0x381317(0x21e)],'memberDrawMjCount':_0x191b33+_0x3773a5[_0x381317(0x239)],'expirationTime':(0x0,date_1['default'])()[_0x381317(0x245)](_0x2c1d7e>0x0?_0x2c1d7e:0x0,_0x381317(0x195))[_0x381317(0x1e6)]('YYYY-MM-DD\x20HH:mm:ss'),'packageId':_0x5f0edf};else{const _0x1963a5=await this[_0x381317(0x230)]['findOne']({'where':{'id':_0x13cec0[_0x381317(0x201)]}});_0x7d94f7>=_0x1963a5['weight']&&(_0x3ccfd5={'memberModel3Count':_0x365933+_0x3773a5[_0x381317(0x1a2)],'memberModel4Count':_0x4b8ad4+_0x3773a5[_0x381317(0x21e)],'memberDrawMjCount':_0x1b4b6e+_0x3773a5[_0x381317(0x239)],'expirationTime':(0x0,date_1[_0x381317(0x1ad)])(_0x13cec0[_0x381317(0x1d1)])[_0x381317(0x245)](_0x2c1d7e>0x0?_0x2c1d7e:0x0,_0x381317(0x195))[_0x381317(0x1e6)]('YYYY-MM-DD\x20HH:mm:ss'),'packageId':_0x5f0edf}),_0x7d94f7<_0x1963a5['weight']&&(_0x3ccfd5={'memberModel3Count':_0x365933+_0x3773a5[_0x381317(0x1a2)],'memberModel4Count':_0x4b8ad4+_0x3773a5[_0x381317(0x21e)],'memberDrawMjCount':_0x1b4b6e+_0x3773a5['drawMjCount']});}}_0x2c1d7e<=0x0&&(_0x3ccfd5={'model3Count':_0x113bd6+_0x3773a5[_0x381317(0x1a2)],'model4Count':_0x53127a+_0x3773a5[_0x381317(0x21e)],'drawMjCount':_0x191b33+_0x3773a5[_0x381317(0x239)]});const _0x913692=await this[_0x381317(0x1e2)][_0x381317(0x1b6)]({'userId':_0x26a0ff},_0x3ccfd5);if(_0x913692['affected']===0x0)throw new common_1['HttpException'](_0x26a0ff+_0x381317(0x19a),common_1['HttpStatus'][_0x381317(0x1fa)]);}catch(_0x1c8bb6){console['log'](_0x381317(0x20d),_0x1c8bb6);throw new common_1['HttpException'](_0x381317(0x1f9),common_1[_0x381317(0x1b7)][_0x381317(0x1fa)]);}}async[_0x46bbcf(0x217)](_0x2453ec){const _0x5d0654=_0x46bbcf;console['log']('充值的工单信息:',_0x2453ec);try{const {userId:_0x54bbd8,goodsId:_0x5cc7c5}=_0x2453ec,_0x3fed7d=await this[_0x5d0654(0x230)][_0x5d0654(0x21b)]({'where':{'id':_0x2453ec['goodsId'],'status':0x1}});if(!_0x3fed7d)throw new common_1[(_0x5d0654(0x1cf))](_0x5d0654(0x1c7),common_1[_0x5d0654(0x1b7)]['BAD_REQUEST']);const {model3Count:_0x592110,model4Count:_0x108355,drawMjCount:_0x3e7aaa,days:_0x5c6df7,name:_0x14122c}=_0x3fed7d,_0x24cb28={'model3Count':_0x592110,'model4Count':_0x108355,'drawMjCount':_0x3e7aaa,'days':_0x5c6df7,'packageId':_0x2453ec['goodsId']};await this[_0x5d0654(0x255)](_0x54bbd8,_0x24cb28,_0x5c6df7),await this[_0x5d0654(0x22e)]({'userId':_0x54bbd8,'rechargeType':balance_constant_1[_0x5d0654(0x1e8)]['SCAN_PAY'],'model3Count':_0x592110,'model4Count':_0x108355,'drawMjCount':_0x3e7aaa,'pkgName':_0x14122c,'days':_0x5c6df7});const _0x14a856=await this[_0x5d0654(0x220)][_0x5d0654(0x21b)]({'where':{'id':_0x54bbd8}}),{invitedBy:_0x4990aa}=_0x14a856;if(_0x4990aa){const _0x2025ea=await this[_0x5d0654(0x220)][_0x5d0654(0x21b)]({'where':{'inviteCode':_0x4990aa}}),_0x2d87e4=await this[_0x5d0654(0x251)]['findOne']({'where':{'userId':_0x2025ea['id']}});if(!_0x2025ea)return;const {id:_0x245a76}=_0x2025ea,{performanceRatio:_0x23f258}=_0x2d87e4,_0x1cd6d7={'inviterUserId':_0x245a76,'inviteeUserId':_0x54bbd8,'orderId':_0x2453ec['id'],'orderPrice':_0x2453ec[_0x5d0654(0x1ff)],'commissionPercentage':_0x23f258,'commissionAmount':(_0x2453ec[_0x5d0654(0x1ff)]*_0x23f258/0x64)[_0x5d0654(0x213)](0x2)};await this[_0x5d0654(0x22c)][_0x5d0654(0x257)](_0x1cd6d7),await this[_0x5d0654(0x22c)][_0x5d0654(0x1f6)](_0x245a76,_0x1cd6d7[_0x5d0654(0x1fd)]);}}catch(_0x2ce38f){console['log'](_0x5d0654(0x20d),_0x2ce38f);throw new common_1['HttpException']('充值失败！',common_1[_0x5d0654(0x1b7)]['BAD_REQUEST']);}}async[_0x46bbcf(0x242)](_0x24eaca,_0x69a389){const _0x5a56ef=_0x46bbcf,{page:page=0x1,size:size=0x14}=_0x69a389,{id:_0x4c8ba8}=_0x24eaca[_0x5a56ef(0x1d9)],[_0x29c3ec,_0x160cce]=await this[_0x5a56ef(0x1f8)][_0x5a56ef(0x1fb)]({'where':{'userId':_0x4c8ba8},'order':{'id':_0x5a56ef(0x1ba)},'skip':(page-0x1)*size,'take':size});return _0x29c3ec[_0x5a56ef(0x1e7)](_0x304397=>{const _0x33d9a0=_0x5a56ef;_0x304397[_0x33d9a0(0x214)]=_0x304397['days']>0x0?_0x304397[_0x33d9a0(0x1f1)]+'天':'永久';}),{'rows':(0x0,date_1[_0x5a56ef(0x234)])(_0x29c3ec),'count':_0x160cce};}async[_0x46bbcf(0x1be)](_0x446642,_0x53846e){const _0x1239be=_0x46bbcf;try{const {page:page=0x1,size:size=0xa,userId:_0x4a8fd2,rechargeType:_0x4049e4,packageId:_0x5f460a}=_0x53846e,{role:_0x31b028}=_0x446642[_0x1239be(0x1d9)],_0x2723bf={};_0x4049e4&&(_0x2723bf['rechargeType']=_0x4049e4),_0x2723bf[_0x1239be(0x1a7)]=_0x4a8fd2||(0x0,typeorm_2[_0x1239be(0x1a5)])(0x186a0),_0x5f460a&&(_0x2723bf[_0x1239be(0x201)]={'$like':'%'+_0x5f460a+'%'});const [_0x96f8d,_0x29a150]=await this[_0x1239be(0x1f8)][_0x1239be(0x1fb)]({'where':_0x2723bf,'order':{'id':_0x1239be(0x1ba)},'skip':(page-0x1)*size,'take':size}),_0x5ad3cf=_0x96f8d[_0x1239be(0x23c)](_0x287458=>_0x287458[_0x1239be(0x1a7)]),_0x32b5fb=await this[_0x1239be(0x220)][_0x1239be(0x20e)]({'where':{'id':(0x0,typeorm_2['In'])(_0x5ad3cf)}});return _0x96f8d[_0x1239be(0x1e7)](_0x5b2521=>{const _0x59a78f=_0x1239be,_0x4e7a47=_0x32b5fb[_0x59a78f(0x20e)](_0x3ef391=>_0x3ef391['id']===_0x5b2521[_0x59a78f(0x1a7)]);_0x5b2521[_0x59a78f(0x19b)]=_0x4e7a47?.[_0x59a78f(0x19b)],_0x5b2521[_0x59a78f(0x244)]=_0x4e7a47?.[_0x59a78f(0x244)],_0x5b2521[_0x59a78f(0x193)]=_0x4e7a47?.[_0x59a78f(0x193)],_0x5b2521[_0x59a78f(0x18d)]=_0x4e7a47?.[_0x59a78f(0x18d)],_0x5b2521[_0x59a78f(0x1a8)]=_0x4e7a47?.[_0x59a78f(0x1a8)];}),_0x31b028!==_0x1239be(0x219)&&_0x96f8d['forEach'](_0x4e18ce=>{const _0x1600c6=_0x1239be;_0x4e18ce[_0x1600c6(0x244)]=_0x4e18ce[_0x1600c6(0x244)]?(0x0,utils_1[_0x1600c6(0x1a6)])(_0x4e18ce[_0x1600c6(0x244)]):'',_0x4e18ce[_0x1600c6(0x193)]=_0x4e18ce[_0x1600c6(0x193)]?(0x0,utils_1[_0x1600c6(0x1a6)])(_0x4e18ce['phone']):'';}),{'rows':_0x96f8d,'count':_0x29a150};}catch(_0x430c27){console[_0x1239be(0x1f3)](_0x1239be(0x20d),_0x430c27);throw new common_1[(_0x1239be(0x1cf))](_0x1239be(0x1e5),common_1[_0x1239be(0x1b7)][_0x1239be(0x1fa)]);}}async[_0x46bbcf(0x1c5)](_0x375e08){const _0x3450e4=_0x46bbcf;return await this['userBalanceEntity'][_0x3450e4(0x20e)]({'where':{'userId':(0x0,typeorm_2['In'])(_0x375e08)}});}async[_0x46bbcf(0x21c)](){const _0x4c6747=_0x46bbcf,_0x478926=await this[_0x4c6747(0x220)][_0x4c6747(0x20e)]();if(!_0x478926[_0x4c6747(0x1ec)])return;const _0x369e4a=await this['globalConfigService'][_0x4c6747(0x196)]([_0x4c6747(0x1ee)]);if(!_0x369e4a)await this['globalConfigService'][_0x4c6747(0x1aa)]({'settings':[{'configKey':_0x4c6747(0x1ee),'configVal':'1'}]});else throw new common_1[(_0x4c6747(0x1cf))](_0x4c6747(0x1ea),common_1[_0x4c6747(0x1b7)][_0x4c6747(0x1fa)]);_0x478926[_0x4c6747(0x1e7)](_0x5d5852=>{const _0x3bf43f=_0x4c6747,{id:_0x4fa7b1}=_0x5d5852;this[_0x3bf43f(0x1c1)][_0x3bf43f(0x21b)]({'where':{'userId':_0x4fa7b1}})[_0x3bf43f(0x25a)](_0x3d7a18=>{const _0x36da0b=_0x3bf43f;if(!_0x3d7a18)return;this[_0x36da0b(0x228)](_0x4fa7b1,_0x3d7a18);});});}async[_0x46bbcf(0x228)](_0x26435b,_0x28037f){const _0x4fd7fc=_0x46bbcf,{balance:balance=0x0,usesLeft:usesLeft=0x0,paintCount:paintCount=0x0,useTokens:useTokens=0x0,useChats:useChats=0x0,usePaints:usePaints=0x0}=_0x28037f,_0x2dd6b2=await this[_0x4fd7fc(0x1fc)][_0x4fd7fc(0x21b)]({'where':{'userId':_0x26435b}}),_0x149d6d={'userId':_0x26435b,'model3Count':Number(usesLeft),'model4Count':_0x2dd6b2?.[_0x4fd7fc(0x198)]||0x0,'drawMjCount':Number(balance),'useModel3Count':Number(useChats),'useModel4Count':_0x2dd6b2?.['useCount']||0x0,'useDrawMjCount':Number(usePaints),'useModel3Token':Number(useTokens),'useModel4Token':0x0,'useDrawMjToken':0x0},_0x159e41=await this[_0x4fd7fc(0x1e2)][_0x4fd7fc(0x21b)]({'where':{'userId':_0x26435b}});_0x159e41?common_1[_0x4fd7fc(0x231)]['debug']('用户'+_0x26435b+_0x4fd7fc(0x1d5),'BalanceService'):this[_0x4fd7fc(0x1e2)][_0x4fd7fc(0x1ce)](_0x149d6d)[_0x4fd7fc(0x25a)](_0x398e2d=>{const _0x384081=_0x4fd7fc;common_1[_0x384081(0x231)]['debug']('用户'+_0x26435b+'旧账户信息迁移成功',_0x384081(0x252));})['catch'](_0x5d9cd4=>{const _0x527180=_0x4fd7fc;console[_0x527180(0x1f3)](_0x527180(0x20d),_0x5d9cd4),common_1[_0x527180(0x231)][_0x527180(0x223)]('用户'+_0x26435b+_0x527180(0x1f2),'BalanceService');});}async[_0x46bbcf(0x205)](_0x1d7230){const _0x3d0e80=_0x46bbcf,{fingerprint:_0x146bbe}=_0x1d7230[_0x3d0e80(0x207)],{id:_0x19b86b}=_0x1d7230[_0x3d0e80(0x1d9)];return await this['chatLogEntity'][_0x3d0e80(0x1b6)]({'userId':Number(_0x146bbe)},{'userId':_0x19b86b}),await this[_0x3d0e80(0x199)][_0x3d0e80(0x1b6)]({'userId':Number(_0x146bbe)},{'userId':_0x19b86b}),await this[_0x3d0e80(0x1f0)][_0x3d0e80(0x1b6)]({'userId':Number(_0x146bbe)},{'userId':_0x19b86b}),0x1;}async['getVisitorCount'](_0x20b402){const _0x52fc3b=_0x46bbcf,{fingerprint:_0x15e0c2}=_0x20b402[_0x52fc3b(0x207)],_0x5563f8=await this[_0x52fc3b(0x229)][_0x52fc3b(0x198)]({'where':{'userId':_0x15e0c2}}),_0x27b75a=await this['chatGroupEntity']['count']({'where':{'userId':_0x15e0c2}}),_0x2a3a5c=await this[_0x52fc3b(0x1f0)][_0x52fc3b(0x198)]({'where':{'userId':_0x15e0c2}});return _0x5563f8||_0x27b75a||_0x2a3a5c||0x0;}};UserBalanceService=__decorate([(0x0,common_1[_0x46bbcf(0x233)])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(balance_entity_1[_0x46bbcf(0x1af)])),__param(0x1,(0x0,typeorm_1[_0x46bbcf(0x240)])(userBalance_entity_1[_0x46bbcf(0x194)])),__param(0x2,(0x0,typeorm_1[_0x46bbcf(0x240)])(accountLog_entity_1['AccountLogEntity'])),__param(0x3,(0x0,typeorm_1[_0x46bbcf(0x240)])(cramiPackage_entity_1[_0x46bbcf(0x1e0)])),__param(0x4,(0x0,typeorm_1[_0x46bbcf(0x240)])(config_entity_1[_0x46bbcf(0x1c0)])),__param(0x5,(0x0,typeorm_1[_0x46bbcf(0x240)])(user_entity_1[_0x46bbcf(0x1b5)])),__param(0x6,(0x0,typeorm_1[_0x46bbcf(0x240)])(salesUsers_entity_1[_0x46bbcf(0x246)])),__param(0x7,(0x0,typeorm_1[_0x46bbcf(0x240)])(whiteList_entity_1[_0x46bbcf(0x258)])),__param(0x8,(0x0,typeorm_1['InjectRepository'])(fingerprint_entity_1[_0x46bbcf(0x24b)])),__param(0x9,(0x0,typeorm_1[_0x46bbcf(0x240)])(chatGroup_entity_1[_0x46bbcf(0x1a1)])),__param(0xa,(0x0,typeorm_1[_0x46bbcf(0x240)])(chatLog_entity_1[_0x46bbcf(0x248)])),__param(0xb,(0x0,typeorm_1[_0x46bbcf(0x240)])(midjourney_entity_1['MidjourneyEntity'])),__metadata('design:paramtypes',[typeorm_2['Repository'],typeorm_2[_0x46bbcf(0x24a)],typeorm_2[_0x46bbcf(0x24a)],typeorm_2[_0x46bbcf(0x24a)],typeorm_2['Repository'],typeorm_2[_0x46bbcf(0x24a)],typeorm_2['Repository'],typeorm_2['Repository'],typeorm_2[_0x46bbcf(0x24a)],typeorm_2['Repository'],typeorm_2[_0x46bbcf(0x24a)],typeorm_2['Repository'],sales_service_1[_0x46bbcf(0x22f)],globalConfig_service_1[_0x46bbcf(0x236)]])],UserBalanceService),exports[_0x46bbcf(0x24f)]=UserBalanceService;function _0x364f(){const _0x4832d3=['useDrawMjToken','sumModel3Count','../crami/cramiPackage.entity','账户信息已经存在、迁移无效','./../globalConfig/globalConfig.service','firstRregisterSendDrawMjCount','inviteGiveSendDrawMjCount','user','./fingerprint.entity','3zBMOiC','configVal','fingerprintLogEntity','getFullYear','model3Dis','CramiPackageEntity','model4Dis','userBalanceEntity','model3','memberDrawMjCount','查询用户账户失败！','format','forEach','RechargeType','useModel4Count','您已经升级过了、请勿重复操作！','缺失当前套餐ID、充值失败！','length','memberModel3Count','upgradeStatus','mjDraw','midjourneyEntity','days','旧账户信息迁移失败','log','INVITE_GIFT','invitedGuestSendModel3Count','saveCommissionAmount','inviteSendStatus','accountLogEntity','用户充值失败！','BAD_REQUEST','findAndCount','whiteListEntity','commissionAmount','firstRegisterSendRank','total','../user/user.entity','packageId','../../common/constants/balance.constant','../sales/sales.service','memberModel4Count','inheritVisitorData','registerSendModel4Count','headers','您的账户余额不足,如果想继续体验服务,请联系管理员\x20<VX:\x20','addBalanceToNewUser','879420ZYRqar','updatedAt','registerSendDrawMjCount','error:\x20','find','useModel4Token','56YKcNkf','COST','drawMjDis','toFixed','expireDateCn','sumModel4Count','validateBalance','addBalanceToOrder','3480851DLpTOi','super','affected','findOne','upgradeBalance','uid','model4Count','inviteGiveSendModel4Count','userEntity','查询用户账户信息失败！','visitorModel3Num','debug','sumDrawMjCount','../chatgpt/whiteList.entity','error','odel4','writeOldBalanceToNewTable','chatLogEntity','registerSendStatus','>\x20或购买专属套餐\x20！','salesService','../../common/utils','saveRecordRechargeLog','SalesService','cramiPackageEntity','Logger','includes','Injectable','formatCreateOrUpdateDate','queryUserBalance','GlobalConfigService','rechargeType','4687WByvSp','drawMjCount','../globalConfig/config.entity','metadata','map','invitedGuestSendModel4Count','configEntity','12XlwNKu','InjectRepository','registerSendModel3Count','getRechargeLog','firstRregisterSendModel3Count','email','add','SalesUsersEntity','configKey','ChatLogEntity','reduce','Repository','FingerprintLogEntity','useModel3Count','消费余额失败！','../midjourney/midjourney.entity','UserBalanceService','catch','salesUsersEntity','BalanceService','decorate','./userBalance.entity','addBalanceToUser','model4','createSalesRecords','WhiteListEntity','../chatGroup/chatGroup.entity','then','1092780ZGHpkA','status','globalConfigService','odel3','validateVisitorBalance','inviteGiveSendModel3Count','MjCount','phone','UserBalanceEntity','day','getConfigs','function','count','chatGroupEntity','充值失败','username','YYYY-MM-DD','92XRARzo','当前用户不存在,记录充值日志异常','../../common/utils/date','缺失当前用户账户记录！','ChatGroupEntity','model3Count','AccountLogEntity','refundMjBalance','LessThan','hideString','userId','avatar','isUpdatedToday','setConfig','firstRegisterSendStatus','getOwnPropertyDescriptor','default','360eEnjYE','BalanceEntity','createBaseUserBalance','2241640pjgcmw','getMonth','__metadata','object','UserEntity','update','HttpStatus','12056UMCQvi','REG_GIFT','DESC','39144koISNd','vxNumber','@nestjs/common','getAccountLog','invitedGuestSendDrawMjCount','ConfigEntity','balanceEntity','__param','useModel3Token','当前套餐不存在！','queryUserBalanceByIds','visitor','非法操作、当前充值套餐暂不存在！','createRandomUid','getDate','deductFromBalance','@nestjs/typeorm','./balance.entity','defineProperty','save','HttpException','PAYMENT_REQUIRED','expirationTime'];_0x364f=function(){return _0x4832d3;};return _0x364f();}