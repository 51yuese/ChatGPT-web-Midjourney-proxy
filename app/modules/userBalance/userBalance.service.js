'use strict';function _0x4e23(_0x44fe15,_0x4582b8){const _0x350758=_0x3507();return _0x4e23=function(_0x4e237a,_0x4407e2){_0x4e237a=_0x4e237a-0x11b;let _0x451728=_0x350758[_0x4e237a];return _0x451728;},_0x4e23(_0x44fe15,_0x4582b8);}const _0x24a6fc=_0x4e23;(function(_0x567235,_0x4476ba){const _0x414cbe=_0x4e23,_0x3aa177=_0x567235();while(!![]){try{const _0x375339=-parseInt(_0x414cbe(0x147))/0x1*(parseInt(_0x414cbe(0x191))/0x2)+parseInt(_0x414cbe(0x124))/0x3+parseInt(_0x414cbe(0x1b3))/0x4*(-parseInt(_0x414cbe(0x1a4))/0x5)+-parseInt(_0x414cbe(0x141))/0x6*(-parseInt(_0x414cbe(0x1c2))/0x7)+parseInt(_0x414cbe(0x159))/0x8*(parseInt(_0x414cbe(0x15c))/0x9)+-parseInt(_0x414cbe(0x149))/0xa*(-parseInt(_0x414cbe(0x142))/0xb)+parseInt(_0x414cbe(0x1ad))/0xc;if(_0x375339===_0x4476ba)break;else _0x3aa177['push'](_0x3aa177['shift']());}catch(_0x158409){_0x3aa177['push'](_0x3aa177['shift']());}}}(_0x3507,0x97275));var __decorate=this&&this[_0x24a6fc(0x1a9)]||function(_0x7c6fc9,_0x15351e,_0x8cf97f,_0x1539e9){const _0x40a7b7=_0x24a6fc;var _0x49978f=arguments[_0x40a7b7(0x188)],_0x1f5e33=_0x49978f<0x3?_0x15351e:_0x1539e9===null?_0x1539e9=Object[_0x40a7b7(0x1ab)](_0x15351e,_0x8cf97f):_0x1539e9,_0x36405b;if(typeof Reflect==='object'&&typeof Reflect['decorate']===_0x40a7b7(0x13d))_0x1f5e33=Reflect['decorate'](_0x7c6fc9,_0x15351e,_0x8cf97f,_0x1539e9);else{for(var _0x2397f9=_0x7c6fc9[_0x40a7b7(0x188)]-0x1;_0x2397f9>=0x0;_0x2397f9--)if(_0x36405b=_0x7c6fc9[_0x2397f9])_0x1f5e33=(_0x49978f<0x3?_0x36405b(_0x1f5e33):_0x49978f>0x3?_0x36405b(_0x15351e,_0x8cf97f,_0x1f5e33):_0x36405b(_0x15351e,_0x8cf97f))||_0x1f5e33;}return _0x49978f>0x3&&_0x1f5e33&&Object[_0x40a7b7(0x12b)](_0x15351e,_0x8cf97f,_0x1f5e33),_0x1f5e33;},__metadata=this&&this[_0x24a6fc(0x13b)]||function(_0x555681,_0x29f722){const _0x572445=_0x24a6fc;if(typeof Reflect===_0x572445(0x14f)&&typeof Reflect['metadata']===_0x572445(0x13d))return Reflect[_0x572445(0x1b0)](_0x555681,_0x29f722);},__param=this&&this['__param']||function(_0x23240b,_0x3573aa){return function(_0x4495b6,_0x4c0c32){_0x3573aa(_0x4495b6,_0x4c0c32,_0x23240b);};};Object[_0x24a6fc(0x12b)](exports,_0x24a6fc(0x151),{'value':!![]}),exports[_0x24a6fc(0x199)]=void 0x0;const globalConfig_service_1=require(_0x24a6fc(0x1c8)),typeorm_1=require(_0x24a6fc(0x13a)),balance_entity_1=require(_0x24a6fc(0x130)),common_1=require(_0x24a6fc(0x19b)),typeorm_2=require(_0x24a6fc(0x164)),balance_constant_1=require('../../common/constants/balance.constant'),accountLog_entity_1=require(_0x24a6fc(0x15d)),utils_1=require('../../common/utils'),config_entity_1=require(_0x24a6fc(0x11d)),cramiPackage_entity_1=require(_0x24a6fc(0x1af)),userBalance_entity_1=require(_0x24a6fc(0x1a8)),date_1=require('../../common/utils/date'),user_entity_1=require('../user/user.entity'),salesUsers_entity_1=require(_0x24a6fc(0x1a2)),sales_service_1=require('../sales/sales.service'),whiteList_entity_1=require('../chatgpt/whiteList.entity'),fingerprint_entity_1=require(_0x24a6fc(0x12e)),chatLog_entity_1=require(_0x24a6fc(0x193)),chatGroup_entity_1=require(_0x24a6fc(0x176)),midjourney_entity_1=require(_0x24a6fc(0x177));function _0x3507(){const _0x4da9ab=['MidjourneyEntity','expireDateCn','configVal','@nestjs/typeorm','__metadata','当前套餐不存在！','function','查询当前用户余额失败！','status','globalConfigService','3033204kKoBAs','3223wcPuLE','MjCount','useModel3Token','userBalanceEntity','error:\x20','9757wkyPrl','cramiPackageEntity','27210MKOJSl','addBalanceToNewUser','registerSendDrawMjCount','includes','userEntity','---','object','add','__esModule','firstRregisterSendModel3Count','充值失败！','design:paramtypes','saveCommissionAmount','forEach','model4Dis','fingerprintLogEntity','2488GvRWLu','email','GlobalConfigService','16155WfxdoY','./accountLog.entity','BalanceService','充值失败','chatLogEntity','balanceEntity','findOne','memberDrawMjCount','typeorm','deductFromBalance','InjectRepository','vxNumber','uid','headers','当前用户无需创建账户信息！','phone','>\x20或购买专属套餐\x20！','SCAN_PAY','addBalanceToUser','formatCreateOrUpdateDate','model4Count','total','registerSendModel3Count','validateBalance','ConfigEntity','visitorModel4Num','../chatGroup/chatGroup.entity','../midjourney/midjourney.entity','您已经升级过了、请勿重复操作！','findAndCount','registerSendModel4Count','saveRecordRechargeLog','commissionAmount','error','invitedGuestSendModel3Count','queryUserBalance','旧账户信息迁移成功','salesService','HttpStatus','getConfigs','invitedGuestSendModel4Count','days','注册赠送失败,请联系管理员！','账户信息已经存在、迁移无效','length','default','username','super','salesUsersEntity','avatar','update','inviteSendStatus','旧账户信息迁移失败','214lBXSkD','firstRregisterSendModel4Count','../chatLog/chatLog.entity','upgradeStatus','expirationTime','缺失当前用户账户记录！','inviteGiveSendModel4Count','查询用户账户失败！','UserBalanceService','log','@nestjs/common','configKey','odel3','SalesService','day','mjDraw','weight','../sales/salesUsers.entity','非法操作、当前充值套餐暂不存在！','20wIhSgI','firstRegisterSendStatus','Repository','rechargeType','./userBalance.entity','__decorate','LessThan','getOwnPropertyDescriptor','model3Dis','8184396XvlnOI','useCount','../crami/cramiPackage.entity','metadata','catch','odel4','886364aetzdE','RechargeType','createBaseUserBalance','getRechargeLog','accountLogEntity','UserEntity','CramiPackageEntity','Injectable','inviteGiveSendDrawMjCount','userId','REG_GIFT','user','drawMjCount','WhiteListEntity','AccountLogEntity','7MPjwKZ','您的账户余额不足,如果想继续体验服务,请联系管理员\x20<VX:\x20','model3Count','ChatLogEntity','invitedGuestSendDrawMjCount','DESC','./../globalConfig/globalConfig.service','visitorModel3Num','validateVisitorBalance','whiteListEntity','reduce','createSalesRecords','sumModel3Count','Logger','PAYMENT_REQUIRED','createRandomUid','packageId','visitorMJNum','drawMjDis','save','firstRegisterSendRank','format','UserBalanceEntity','今日当前类型免费额度已经使用完毕、建议您注册账户体验更加完整的服务内容！','goodsId','inviteGiveSendModel3Count','then','registerSendStatus','firstRregisterSendDrawMjCount','hideString','ChatGroupEntity','debug','useModel4Token','count','midjourneyEntity','model4','用户充值失败！','../globalConfig/config.entity','affected','inheritVisitorData','sumDrawMjCount','查询用户账户信息失败！','useModel4Count','SalesUsersEntity','19269OqpmHk','BAD_REQUEST','getAccountLog','setConfig','memberModel4Count','isInteger','HttpException','defineProperty','upgradeBalance','writeOldBalanceToNewTable','./fingerprint.entity','configEntity','./balance.entity','model3','memberModel3Count','chatGroupEntity','REFER_GIFT','find','useModel3Count'];_0x3507=function(){return _0x4da9ab;};return _0x3507();}let UserBalanceService=class UserBalanceService{constructor(_0x265992,_0x303b80,_0x33da62,_0x2aaa46,_0x183990,_0xe83e3f,_0x180981,_0x1ef007,_0x58f49e,_0x20d946,_0x394de7,_0x3d3681,_0x4bc9f0,_0x54004c){const _0xfa29ef=_0x24a6fc;this[_0xfa29ef(0x161)]=_0x265992,this[_0xfa29ef(0x145)]=_0x303b80,this[_0xfa29ef(0x1b7)]=_0x33da62,this[_0xfa29ef(0x148)]=_0x2aaa46,this[_0xfa29ef(0x12f)]=_0x183990,this[_0xfa29ef(0x14d)]=_0xe83e3f,this[_0xfa29ef(0x18c)]=_0x180981,this[_0xfa29ef(0x1cb)]=_0x1ef007,this[_0xfa29ef(0x158)]=_0x58f49e,this['chatGroupEntity']=_0x20d946,this[_0xfa29ef(0x160)]=_0x394de7,this[_0xfa29ef(0x1e4)]=_0x3d3681,this[_0xfa29ef(0x181)]=_0x4bc9f0,this[_0xfa29ef(0x140)]=_0x54004c;}async[_0x24a6fc(0x14a)](_0x309254,_0x46c6e9){const _0x4ba2ef=_0x24a6fc;try{const _0x284fcb=await this[_0x4ba2ef(0x12f)][_0x4ba2ef(0x135)]({'where':{'configKey':(0x0,typeorm_2['In'])([_0x4ba2ef(0x1dd),_0x4ba2ef(0x172),_0x4ba2ef(0x17a),_0x4ba2ef(0x14b),_0x4ba2ef(0x1a5),_0x4ba2ef(0x1d6),_0x4ba2ef(0x152),_0x4ba2ef(0x192),'firstRregisterSendDrawMjCount','inviteSendStatus','inviteGiveSendModel3Count','inviteGiveSendModel4Count',_0x4ba2ef(0x1bb),_0x4ba2ef(0x17e),_0x4ba2ef(0x1c6),'invitedGuestSendModel4Count'])}}),_0x5e3c61=_0x284fcb[_0x4ba2ef(0x1cc)]((_0x498377,_0x142120)=>{const _0x43b16c=_0x4ba2ef,_0xfe21c1=Number(_0x142120[_0x43b16c(0x139)]),_0x1942dc=Number[_0x43b16c(0x129)](_0xfe21c1)&&_0xfe21c1>0x0?_0xfe21c1:0x0;return _0x498377[_0x142120[_0x43b16c(0x19c)]]=_0x1942dc,_0x498377;},{});let _0xfc841f=0x0,_0x69bf19=0x0,_0x2756d9=0x0;_0x5e3c61['registerSendStatus']===0x1&&(_0xfc841f=_0xfc841f+_0x5e3c61[_0x4ba2ef(0x172)],_0x69bf19=_0x69bf19+_0x5e3c61['registerSendModel4Count'],_0x2756d9=_0x2756d9+_0x5e3c61[_0x4ba2ef(0x14b)]),_0x5e3c61[_0x4ba2ef(0x1dd)]===0x1&&_0x5e3c61[_0x4ba2ef(0x1a5)]===0x1&&_0x309254<=_0x5e3c61[_0x4ba2ef(0x1d6)]&&(_0xfc841f=_0xfc841f+_0x5e3c61[_0x4ba2ef(0x152)],_0x69bf19=_0x69bf19+_0x5e3c61[_0x4ba2ef(0x192)],_0x2756d9=_0x2756d9+_0x5e3c61[_0x4ba2ef(0x1de)]),await this[_0x4ba2ef(0x17b)]({'userId':_0x309254,'rechargeType':balance_constant_1[_0x4ba2ef(0x1b4)][_0x4ba2ef(0x1bd)],'model3Count':_0xfc841f,'drawMjCount':_0x2756d9,'model4Count':_0x69bf19}),_0x46c6e9&&(Number(_0x5e3c61[_0x4ba2ef(0x18f)])===0x1&&(_0xfc841f=_0xfc841f+Number(_0x5e3c61['invitedGuestSendModel3Count']),_0x69bf19=_0x69bf19+Number(_0x5e3c61[_0x4ba2ef(0x184)]),_0x2756d9=_0x2756d9+Number(_0x5e3c61[_0x4ba2ef(0x1c6)]),await this['saveRecordRechargeLog']({'userId':_0x309254,'rechargeType':balance_constant_1[_0x4ba2ef(0x1b4)]['INVITE_GIFT'],'model3Count':_0x5e3c61[_0x4ba2ef(0x17e)],'model4Count':_0x5e3c61[_0x4ba2ef(0x184)],'drawMjCount':_0x5e3c61[_0x4ba2ef(0x1c6)]}),await this[_0x4ba2ef(0x16e)](_0x46c6e9,{'model3Count':_0x5e3c61[_0x4ba2ef(0x1db)],'model4Count':_0x5e3c61['inviteGiveSendModel4Count'],'drawMjCount':_0x5e3c61[_0x4ba2ef(0x1bb)]}),await this[_0x4ba2ef(0x17b)]({'userId':_0x46c6e9,'rechargeType':balance_constant_1[_0x4ba2ef(0x1b4)][_0x4ba2ef(0x134)],'model3Count':_0x5e3c61[_0x4ba2ef(0x1db)],'model4Count':_0x5e3c61[_0x4ba2ef(0x197)],'drawMjCount':_0x5e3c61[_0x4ba2ef(0x1bb)]}))),await this[_0x4ba2ef(0x145)]['save']({'userId':_0x309254,'model3Count':_0xfc841f,'model4Count':_0x69bf19,'drawMjCount':_0x2756d9,'useTokens':0x0});}catch(_0x487292){console[_0x4ba2ef(0x19a)]('error:\x20',_0x487292);throw new common_1[(_0x4ba2ef(0x12a))](_0x4ba2ef(0x186),common_1[_0x4ba2ef(0x182)][_0x4ba2ef(0x125)]);}}async[_0x24a6fc(0x173)](_0x1b2c71,_0x16b637,_0x430354){const _0x8ac87b=_0x24a6fc,{id:_0x49f1c7,role:_0x19d315}=_0x1b2c71[_0x8ac87b(0x1be)];let _0x9a0547=await this[_0x8ac87b(0x145)][_0x8ac87b(0x162)]({'where':{'userId':_0x49f1c7}})['catch'](_0x19bc47=>{const _0x42ea18=_0x8ac87b;common_1[_0x42ea18(0x1cf)][_0x42ea18(0x17d)](_0x19bc47);});!_0x9a0547&&(_0x9a0547=await this[_0x8ac87b(0x1b5)](_0x49f1c7)['catch'](_0x5b9547=>{const _0x12e4d7=_0x8ac87b;common_1[_0x12e4d7(0x1cf)][_0x12e4d7(0x17d)](_0x5b9547);}));if(_0x19d315==='visitor')return this[_0x8ac87b(0x1ca)](_0x1b2c71,_0x16b637,_0x430354)[_0x8ac87b(0x1b1)](_0x3b87a3=>{const _0x41c22f=_0x8ac87b;common_1['Logger'][_0x41c22f(0x17d)](_0x3b87a3);});const _0x215503=await this[_0x8ac87b(0x12f)][_0x8ac87b(0x162)]({'where':{'configKey':_0x8ac87b(0x167)}})[_0x8ac87b(0x1b1)](_0x4dc380=>{const _0x15f8a0=_0x8ac87b;common_1[_0x15f8a0(0x1cf)][_0x15f8a0(0x17d)](_0x4dc380);}),_0x246d00=_0x215503?_0x215503[_0x8ac87b(0x139)]:_0x8ac87b(0x14e),_0x24034d=_0x16b637===_0x8ac87b(0x131)?_0x8ac87b(0x132):_0x16b637===_0x8ac87b(0x11b)?'memberModel4Count':_0x16b637===_0x8ac87b(0x1a0)?_0x8ac87b(0x163):null,_0x4960b5=_0x16b637===_0x8ac87b(0x131)?_0x8ac87b(0x1c4):_0x16b637===_0x8ac87b(0x11b)?_0x8ac87b(0x170):_0x16b637===_0x8ac87b(0x1a0)?_0x8ac87b(0x1bf):null;if(!_0x9a0547)throw new common_1[(_0x8ac87b(0x12a))](_0x8ac87b(0x1c3)+_0x246d00+_0x8ac87b(0x16c),common_1[_0x8ac87b(0x182)][_0x8ac87b(0x1d0)]);if(_0x9a0547[_0x8ac87b(0x1d2)]&&_0x9a0547[_0x24034d]<_0x430354){if(_0x9a0547[_0x4960b5]<_0x430354)throw new common_1[(_0x8ac87b(0x12a))](_0x8ac87b(0x1c3)+_0x246d00+_0x8ac87b(0x16c),common_1[_0x8ac87b(0x182)][_0x8ac87b(0x1d0)]);}if(!_0x9a0547[_0x8ac87b(0x1d2)]&&_0x9a0547[_0x4960b5]<_0x430354)throw new common_1[(_0x8ac87b(0x12a))]('您的账户余额不足,如果想继续体验服务,请联系管理员\x20<VX:\x20'+_0x246d00+'>\x20或购买专属套餐\x20！',common_1[_0x8ac87b(0x182)]['PAYMENT_REQUIRED']);return _0x9a0547;}async['validateVisitorBalance'](_0x381d82,_0x403d5c,_0x20ce42){const _0x1e56fe=_0x24a6fc,{id:_0x34185e}=_0x381d82[_0x1e56fe(0x1be)],_0x5ab217=_0x403d5c===_0x1e56fe(0x131)?_0x1e56fe(0x1c4):_0x403d5c===_0x1e56fe(0x11b)?_0x1e56fe(0x170):_0x403d5c==='mjDraw'?_0x1e56fe(0x1bf):null,_0x977376=await this[_0x1e56fe(0x158)][_0x1e56fe(0x162)]({'where':{'fingerprint':_0x34185e+''}}),{visitorModel3Num:_0x4d756c,visitorModel4Num:_0x4f1643,visitorMJNum:_0x192301}=await this[_0x1e56fe(0x140)]['getConfigs']([_0x1e56fe(0x1c9),_0x1e56fe(0x175),_0x1e56fe(0x1d3)]),_0xfa3d2e={'model3Count':_0x4d756c?Number(_0x4d756c):0x0,'model4Count':_0x4f1643?Number(_0x4f1643):0x0,'drawMjCount':_0x192301?Number(_0x192301):0x0};if(!_0x977376){let _0xf36eec={'fingerprint':_0x34185e,'model3Count':0x0,'model4Count':0x0,'drawMjCount':0x0};_0xf36eec[_0x5ab217]=_0xf36eec[_0x5ab217]+_0x20ce42;if(_0xf36eec[_0x5ab217]>_0xfa3d2e[_0x5ab217])throw new common_1[(_0x1e56fe(0x12a))](_0x1e56fe(0x1d9),common_1[_0x1e56fe(0x182)][_0x1e56fe(0x1d0)]);else return await this['fingerprintLogEntity'][_0x1e56fe(0x1d5)](_0xf36eec),!![];}else{const {model3Count:_0x10deef,model4Count:_0x314e1b,drawMjCount:_0x41e594}=_0x977376;let _0x47f00f={'model3Count':_0x10deef,'model4Count':_0x314e1b,'drawMjCount':_0x41e594};const _0x3392c0=Number(new Date(_0x977376['updatedAt'])),_0x134a7b=this['isUpdatedToday'](_0x3392c0);_0x134a7b?_0x47f00f[_0x5ab217]=_0x47f00f[_0x5ab217]+_0x20ce42:(_0x47f00f={'model3Count':0x0,'model4Count':0x0,'drawMjCount':0x0},_0x47f00f[_0x5ab217]=_0x47f00f[_0x5ab217]+_0x20ce42);if(_0x47f00f[_0x5ab217]>_0xfa3d2e[_0x5ab217])throw new common_1['HttpException'](_0x1e56fe(0x1d9),common_1['HttpStatus'][_0x1e56fe(0x1d0)]);else return await this[_0x1e56fe(0x158)][_0x1e56fe(0x18e)]({'fingerprint':_0x34185e+''},_0x47f00f),!![];}}['isUpdatedToday'](_0x347c2a){const _0x21f3cb=new Date(),_0x45c44e=new Date(_0x21f3cb['getFullYear'](),_0x21f3cb['getMonth'](),_0x21f3cb['getDate']());return _0x347c2a>=_0x45c44e;}async[_0x24a6fc(0x165)](_0x10fb5d,_0x4e6bc0,_0x43ddb2,_0xc5a6f8=0x0){const _0x3b4a3d=_0x24a6fc,_0x221a84=await this[_0x3b4a3d(0x145)][_0x3b4a3d(0x162)]({'where':{'userId':_0x10fb5d}});if(!_0x221a84)throw new common_1[(_0x3b4a3d(0x12a))](_0x3b4a3d(0x196),common_1[_0x3b4a3d(0x182)][_0x3b4a3d(0x125)]);const _0x45900f=_0x4e6bc0===_0x3b4a3d(0x131)?_0x3b4a3d(0x132):_0x4e6bc0===_0x3b4a3d(0x11b)?'memberModel4Count':_0x4e6bc0===_0x3b4a3d(0x1a0)?'memberDrawMjCount':null,_0x285a7d=_0x4e6bc0==='model3'?_0x3b4a3d(0x1c4):_0x4e6bc0===_0x3b4a3d(0x11b)?_0x3b4a3d(0x170):_0x4e6bc0===_0x3b4a3d(0x1a0)?_0x3b4a3d(0x1bf):null,_0x47f76f=_0x221a84[_0x3b4a3d(0x1d2)]&&_0x221a84[_0x45900f]<_0x43ddb2?_0x285a7d:_0x221a84[_0x3b4a3d(0x1d2)]?_0x45900f:_0x285a7d;let _0xb9756f=null;_0x47f76f[_0x3b4a3d(0x14c)](_0x3b4a3d(0x19d))&&(_0xb9756f=_0x3b4a3d(0x144));_0x47f76f['includes'](_0x3b4a3d(0x1b2))&&(_0xb9756f=_0x3b4a3d(0x1e2));_0x47f76f['includes'](_0x3b4a3d(0x143))&&(_0xb9756f='useDrawMjToken');const _0x48f861={[_0x47f76f]:_0x221a84[_0x47f76f]-_0x43ddb2<0x0?0x0:_0x221a84[_0x47f76f]-_0x43ddb2,[_0xb9756f]:_0x221a84[_0xb9756f]+_0xc5a6f8};_0xb9756f==='useModel3Token'&&(_0x48f861[_0x3b4a3d(0x136)]=_0x221a84[_0x3b4a3d(0x136)]+0x1),_0xb9756f===_0x3b4a3d(0x1e2)&&(_0x48f861[_0x3b4a3d(0x122)]=_0x221a84[_0x3b4a3d(0x122)]+0x1);const _0x58370e=await this['userBalanceEntity'][_0x3b4a3d(0x162)]({'where':{'userId':_0x10fb5d}}),_0x16d55b=await this[_0x3b4a3d(0x145)][_0x3b4a3d(0x18e)]({'userId':_0x10fb5d},_0x48f861),_0x550d5f=await this[_0x3b4a3d(0x145)]['findOne']({'where':{'userId':_0x10fb5d}}),_0x59c594=await this[_0x3b4a3d(0x1b7)]['findOne']({'where':{'userId':_0x10fb5d},'order':{'createdAt':_0x3b4a3d(0x1c7)}});if(_0x59c594){const _0x1989c3=new accountLog_entity_1['AccountLogEntity']();_0x1989c3[_0x3b4a3d(0x1bc)]=_0x10fb5d,_0x1989c3[_0x3b4a3d(0x168)]='',_0x1989c3['days']=_0x59c594[_0x3b4a3d(0x185)],_0x1989c3[_0x3b4a3d(0x1a7)]=balance_constant_1[_0x3b4a3d(0x1b4)]['COST'],_0x1989c3[_0x3b4a3d(0x1c4)]=_0x550d5f[_0x3b4a3d(0x132)],_0x1989c3[_0x3b4a3d(0x170)]=_0x550d5f[_0x3b4a3d(0x128)],_0x1989c3[_0x3b4a3d(0x1bf)]=_0x550d5f['memberDrawMjCount'],_0x1989c3[_0x3b4a3d(0x1ac)]=_0x550d5f[_0x3b4a3d(0x132)]-_0x58370e[_0x3b4a3d(0x132)],_0x1989c3[_0x3b4a3d(0x157)]=_0x550d5f[_0x3b4a3d(0x128)]-_0x58370e[_0x3b4a3d(0x128)],_0x1989c3[_0x3b4a3d(0x1d4)]=_0x550d5f['memberDrawMjCount']-_0x58370e[_0x3b4a3d(0x163)],await this[_0x3b4a3d(0x1b7)][_0x3b4a3d(0x1d5)](_0x1989c3);}if(_0x16d55b[_0x3b4a3d(0x11e)]===0x0)throw new common_1['HttpException']('消费余额失败！',common_1[_0x3b4a3d(0x182)][_0x3b4a3d(0x125)]);return!![];}async['refundMjBalance'](_0x2287ab,_0x2e960b){const _0xc419ba=_0x24a6fc,_0x11644=await this['userBalanceEntity'][_0xc419ba(0x162)]({'where':{'userId':_0x2287ab}});if(!_0x11644)throw new common_1['HttpException'](_0xc419ba(0x196),common_1[_0xc419ba(0x182)][_0xc419ba(0x125)]);const _0x3b7147={[_0xc419ba(0x1bf)]:_0x11644[_0xc419ba(0x1bf)]+_0x2e960b,['useDrawMjToken']:_0x11644['useDrawMjToken']-_0x2e960b},_0x3a9b90=await this[_0xc419ba(0x145)][_0xc419ba(0x18e)]({'userId':_0x2287ab},_0x3b7147);if(_0x3a9b90[_0xc419ba(0x11e)]===0x0)throw new common_1[(_0xc419ba(0x12a))]('消费余额失败！',common_1['HttpStatus'][_0xc419ba(0x125)]);}async[_0x24a6fc(0x17f)](_0x250627){const _0x2cfa90=_0x24a6fc;try{const _0x47c24e=await this[_0x2cfa90(0x145)][_0x2cfa90(0x162)]({'where':{'userId':_0x250627},'select':[_0x2cfa90(0x1d2),_0x2cfa90(0x1c4),'model4Count',_0x2cfa90(0x1bf),'memberModel3Count','memberModel4Count',_0x2cfa90(0x163),_0x2cfa90(0x136),_0x2cfa90(0x122),'useModel3Token','useModel4Token','useDrawMjToken',_0x2cfa90(0x195)]});if(!_0x47c24e){const _0x1bc9a3=await this[_0x2cfa90(0x1b5)](_0x250627);if(_0x1bc9a3)return await this[_0x2cfa90(0x17f)](_0x250627);else throw new common_1[(_0x2cfa90(0x12a))](_0x2cfa90(0x13e),common_1[_0x2cfa90(0x182)][_0x2cfa90(0x125)]);}return _0x47c24e[_0x2cfa90(0x1ce)]=_0x47c24e[_0x2cfa90(0x1d2)]?_0x47c24e['model3Count']+_0x47c24e['memberModel3Count']:_0x47c24e[_0x2cfa90(0x1c4)],_0x47c24e['sumModel4Count']=_0x47c24e[_0x2cfa90(0x1d2)]?_0x47c24e[_0x2cfa90(0x170)]+_0x47c24e[_0x2cfa90(0x128)]:_0x47c24e[_0x2cfa90(0x170)],_0x47c24e[_0x2cfa90(0x120)]=_0x47c24e[_0x2cfa90(0x1d2)]?_0x47c24e[_0x2cfa90(0x1bf)]+_0x47c24e[_0x2cfa90(0x163)]:_0x47c24e['drawMjCount'],_0x47c24e[_0x2cfa90(0x195)]=_0x47c24e[_0x2cfa90(0x195)]?(0x0,date_1['formatDate'])(_0x47c24e[_0x2cfa90(0x195)],'YYYY-MM-DD'):null,_0x47c24e;}catch(_0x2da68f){console[_0x2cfa90(0x19a)](_0x2cfa90(0x146),_0x2da68f);}}async[_0x24a6fc(0x17b)](_0xe97610){const _0x26d9d1=_0x24a6fc,{userId:_0x19e591,rechargeType:_0x39c083,model3Count:_0x415b17,model4Count:_0x17fe8a,drawMjCount:_0x1d7a7c,days:days=-0x1,pkgName:pkgName='',extent:extent=''}=_0xe97610;if(!_0x19e591)throw new common_1[(_0x26d9d1(0x12a))]('当前用户不存在,记录充值日志异常',common_1[_0x26d9d1(0x182)][_0x26d9d1(0x125)]);const _0x561e73=(0x0,utils_1[_0x26d9d1(0x1d1)])();return await this[_0x26d9d1(0x1b7)][_0x26d9d1(0x1d5)]({'userId':_0x19e591,'rechargeType':_0x39c083,'model3Count':_0x415b17,'model4Count':_0x17fe8a,'drawMjCount':_0x1d7a7c,'days':days,'extent':extent,'uid':_0x561e73,'pkgName':pkgName});}async[_0x24a6fc(0x1b5)](_0x462022,_0x3cbfba={}){const _0x362bf7=_0x24a6fc,{model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0x3cbfba,_0x532f21=await this[_0x362bf7(0x145)][_0x362bf7(0x162)]({'where':{'userId':_0x462022}});if(_0x532f21)throw new common_1[(_0x362bf7(0x12a))](_0x362bf7(0x16a),common_1[_0x362bf7(0x182)][_0x362bf7(0x125)]);return await this['userBalanceEntity']['save']({'userId':_0x462022,'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount});}async[_0x24a6fc(0x16e)](_0x200185,_0x95d58b,_0x3be57b=-0x1){const _0x37031c=_0x24a6fc;try{const _0x5a8846=await this['userBalanceEntity']['findOne']({'where':{'userId':_0x200185}})||await this[_0x37031c(0x1b5)](_0x200185);if(!_0x5a8846)throw new common_1[(_0x37031c(0x12a))](_0x37031c(0x121),common_1[_0x37031c(0x182)][_0x37031c(0x125)]);const {model3Count:_0x352461,model4Count:_0x33d0b1,drawMjCount:_0x214cb5,memberModel3Count:_0x17a429,memberModel4Count:_0x357fd4,memberDrawMjCount:_0x38ae39}=_0x5a8846;let _0xa8b721={};if(_0x3be57b>0x0){const {packageId:_0x2d4076}=_0x95d58b;if(!_0x2d4076)throw new common_1[(_0x37031c(0x12a))]('缺失当前套餐ID、充值失败！',common_1[_0x37031c(0x182)][_0x37031c(0x125)]);const _0x1b9f5c=await this[_0x37031c(0x148)][_0x37031c(0x162)]({'where':{'id':_0x2d4076}});if(!_0x1b9f5c)throw new common_1['HttpException'](_0x37031c(0x13c),common_1[_0x37031c(0x182)]['BAD_REQUEST']);const {weight:_0x4b0d71}=_0x1b9f5c;if(!_0x5a8846[_0x37031c(0x1d2)])_0xa8b721={'memberModel3Count':_0x352461+_0x95d58b[_0x37031c(0x1c4)],'memberModel4Count':_0x33d0b1+_0x95d58b[_0x37031c(0x170)],'memberDrawMjCount':_0x214cb5+_0x95d58b[_0x37031c(0x1bf)],'expirationTime':(0x0,date_1[_0x37031c(0x189)])()[_0x37031c(0x150)](_0x3be57b>0x0?_0x3be57b:0x0,_0x37031c(0x19f))[_0x37031c(0x1d7)]('YYYY-MM-DD\x20HH:mm:ss'),'packageId':_0x2d4076};else{const _0x3b9653=await this['cramiPackageEntity'][_0x37031c(0x162)]({'where':{'id':_0x5a8846['packageId']}});_0x4b0d71>=_0x3b9653[_0x37031c(0x1a1)]&&(_0xa8b721={'memberModel3Count':_0x17a429+_0x95d58b[_0x37031c(0x1c4)],'memberModel4Count':_0x357fd4+_0x95d58b[_0x37031c(0x170)],'memberDrawMjCount':_0x38ae39+_0x95d58b['drawMjCount'],'expirationTime':(0x0,date_1[_0x37031c(0x189)])(_0x5a8846[_0x37031c(0x195)])['add'](_0x3be57b>0x0?_0x3be57b:0x0,_0x37031c(0x19f))['format']('YYYY-MM-DD\x20HH:mm:ss'),'packageId':_0x2d4076}),_0x4b0d71<_0x3b9653['weight']&&(_0xa8b721={'memberModel3Count':_0x17a429+_0x95d58b[_0x37031c(0x1c4)],'memberModel4Count':_0x357fd4+_0x95d58b['model4Count'],'memberDrawMjCount':_0x38ae39+_0x95d58b['drawMjCount']});}}_0x3be57b<=0x0&&(_0xa8b721={'model3Count':_0x352461+_0x95d58b[_0x37031c(0x1c4)],'model4Count':_0x33d0b1+_0x95d58b['model4Count'],'drawMjCount':_0x214cb5+_0x95d58b[_0x37031c(0x1bf)]});const _0x5caca2=await this[_0x37031c(0x145)][_0x37031c(0x18e)]({'userId':_0x200185},_0xa8b721);if(_0x5caca2['affected']===0x0)throw new common_1[(_0x37031c(0x12a))](_0x200185+_0x37031c(0x15f),common_1[_0x37031c(0x182)]['BAD_REQUEST']);}catch(_0x39d0e){console[_0x37031c(0x19a)](_0x37031c(0x146),_0x39d0e);throw new common_1[(_0x37031c(0x12a))](_0x37031c(0x11c),common_1[_0x37031c(0x182)]['BAD_REQUEST']);}}async['addBalanceToOrder'](_0x10a82a){const _0x469bab=_0x24a6fc;console[_0x469bab(0x19a)]('充值的工单信息:',_0x10a82a);try{const {userId:_0x40728b,goodsId:_0x36e7d3}=_0x10a82a,_0xff4b0a=await this[_0x469bab(0x148)][_0x469bab(0x162)]({'where':{'id':_0x10a82a[_0x469bab(0x1da)],'status':0x1}});if(!_0xff4b0a)throw new common_1[(_0x469bab(0x12a))](_0x469bab(0x1a3),common_1[_0x469bab(0x182)]['BAD_REQUEST']);const {model3Count:_0x138155,model4Count:_0x2daf5f,drawMjCount:_0x268646,days:_0xe9faf5,name:_0x5c0a88}=_0xff4b0a,_0x5bb270={'model3Count':_0x138155,'model4Count':_0x2daf5f,'drawMjCount':_0x268646,'days':_0xe9faf5,'packageId':_0x10a82a[_0x469bab(0x1da)]};await this[_0x469bab(0x16e)](_0x40728b,_0x5bb270,_0xe9faf5),await this[_0x469bab(0x17b)]({'userId':_0x40728b,'rechargeType':balance_constant_1[_0x469bab(0x1b4)][_0x469bab(0x16d)],'model3Count':_0x138155,'model4Count':_0x2daf5f,'drawMjCount':_0x268646,'pkgName':_0x5c0a88,'days':_0xe9faf5});const _0x4e0350=await this[_0x469bab(0x14d)][_0x469bab(0x162)]({'where':{'id':_0x40728b}}),{invitedBy:_0x1f308e}=_0x4e0350;if(_0x1f308e){const _0x230d58=await this[_0x469bab(0x14d)][_0x469bab(0x162)]({'where':{'inviteCode':_0x1f308e}}),_0x41773f=await this[_0x469bab(0x18c)][_0x469bab(0x162)]({'where':{'userId':_0x230d58['id']}});if(!_0x230d58)return;const {id:_0x39cdbb}=_0x230d58,{performanceRatio:_0x1adace}=_0x41773f,_0x39ad17={'inviterUserId':_0x39cdbb,'inviteeUserId':_0x40728b,'orderId':_0x10a82a['id'],'orderPrice':_0x10a82a[_0x469bab(0x171)],'commissionPercentage':_0x1adace,'commissionAmount':(_0x10a82a[_0x469bab(0x171)]*_0x1adace/0x64)['toFixed'](0x2)};await this['salesService'][_0x469bab(0x1cd)](_0x39ad17),await this[_0x469bab(0x181)][_0x469bab(0x155)](_0x39cdbb,_0x39ad17[_0x469bab(0x17c)]);}}catch(_0x3b6c08){console['log']('error:\x20',_0x3b6c08);throw new common_1[(_0x469bab(0x12a))](_0x469bab(0x153),common_1[_0x469bab(0x182)][_0x469bab(0x125)]);}}async[_0x24a6fc(0x1b6)](_0x1aaf9f,_0x3a21b9){const _0x32d42b=_0x24a6fc,{page:page=0x1,size:size=0x14}=_0x3a21b9,{id:_0x5f4af7}=_0x1aaf9f[_0x32d42b(0x1be)],[_0x43f998,_0x5c13da]=await this['accountLogEntity'][_0x32d42b(0x179)]({'where':{'userId':_0x5f4af7},'order':{'id':_0x32d42b(0x1c7)},'skip':(page-0x1)*size,'take':size});return _0x43f998[_0x32d42b(0x156)](_0x3f7c71=>{const _0x5b8335=_0x32d42b;_0x3f7c71[_0x5b8335(0x138)]=_0x3f7c71[_0x5b8335(0x185)]>0x0?_0x3f7c71[_0x5b8335(0x185)]+'天':'永久';}),{'rows':(0x0,date_1[_0x32d42b(0x16f)])(_0x43f998),'count':_0x5c13da};}async[_0x24a6fc(0x126)](_0x5afa47,_0x14a694){const _0x4b9a47=_0x24a6fc;try{const {page:page=0x1,size:size=0xa,userId:_0x191160,rechargeType:_0x50792c,packageId:_0x2a3e79}=_0x14a694,{role:_0x304999}=_0x5afa47[_0x4b9a47(0x1be)],_0x23c33e={};_0x50792c&&(_0x23c33e[_0x4b9a47(0x1a7)]=_0x50792c),_0x23c33e[_0x4b9a47(0x1bc)]=_0x191160||(0x0,typeorm_2[_0x4b9a47(0x1aa)])(0x186a0),_0x2a3e79&&(_0x23c33e[_0x4b9a47(0x1d2)]={'$like':'%'+_0x2a3e79+'%'});const [_0x5ee965,_0x3b1ae4]=await this[_0x4b9a47(0x1b7)][_0x4b9a47(0x179)]({'where':_0x23c33e,'order':{'id':_0x4b9a47(0x1c7)},'skip':(page-0x1)*size,'take':size}),_0xa73ac0=_0x5ee965['map'](_0x2442c6=>_0x2442c6[_0x4b9a47(0x1bc)]),_0x4f456f=await this[_0x4b9a47(0x14d)][_0x4b9a47(0x135)]({'where':{'id':(0x0,typeorm_2['In'])(_0xa73ac0)}});return _0x5ee965[_0x4b9a47(0x156)](_0x5ae06e=>{const _0x51f9d2=_0x4b9a47,_0x5d1249=_0x4f456f[_0x51f9d2(0x135)](_0x36fdb0=>_0x36fdb0['id']===_0x5ae06e[_0x51f9d2(0x1bc)]);_0x5ae06e[_0x51f9d2(0x18a)]=_0x5d1249?.[_0x51f9d2(0x18a)],_0x5ae06e[_0x51f9d2(0x15a)]=_0x5d1249?.[_0x51f9d2(0x15a)],_0x5ae06e['phone']=_0x5d1249?.[_0x51f9d2(0x16b)],_0x5ae06e[_0x51f9d2(0x13f)]=_0x5d1249?.[_0x51f9d2(0x13f)],_0x5ae06e[_0x51f9d2(0x18d)]=_0x5d1249?.[_0x51f9d2(0x18d)];}),_0x304999!==_0x4b9a47(0x18b)&&_0x5ee965[_0x4b9a47(0x156)](_0x50de33=>{const _0x5831f6=_0x4b9a47;_0x50de33['email']=_0x50de33[_0x5831f6(0x15a)]?(0x0,utils_1[_0x5831f6(0x1df)])(_0x50de33[_0x5831f6(0x15a)]):'',_0x50de33[_0x5831f6(0x16b)]=_0x50de33['phone']?(0x0,utils_1[_0x5831f6(0x1df)])(_0x50de33[_0x5831f6(0x16b)]):'';}),{'rows':_0x5ee965,'count':_0x3b1ae4};}catch(_0x5f07a8){console[_0x4b9a47(0x19a)](_0x4b9a47(0x146),_0x5f07a8);throw new common_1[(_0x4b9a47(0x12a))](_0x4b9a47(0x198),common_1[_0x4b9a47(0x182)][_0x4b9a47(0x125)]);}}async['queryUserBalanceByIds'](_0x1fa77b){const _0x150b61=_0x24a6fc;return await this[_0x150b61(0x145)]['find']({'where':{'userId':(0x0,typeorm_2['In'])(_0x1fa77b)}});}async[_0x24a6fc(0x12c)](){const _0x4f5e9e=_0x24a6fc,_0x12706c=await this[_0x4f5e9e(0x14d)][_0x4f5e9e(0x135)]();if(!_0x12706c[_0x4f5e9e(0x188)])return;const _0x6d5481=await this[_0x4f5e9e(0x140)][_0x4f5e9e(0x183)]([_0x4f5e9e(0x194)]);if(!_0x6d5481)await this['globalConfigService'][_0x4f5e9e(0x127)]({'settings':[{'configKey':'upgradeStatus','configVal':'1'}]});else throw new common_1[(_0x4f5e9e(0x12a))](_0x4f5e9e(0x178),common_1[_0x4f5e9e(0x182)][_0x4f5e9e(0x125)]);_0x12706c[_0x4f5e9e(0x156)](_0x55705f=>{const _0x215bbf=_0x4f5e9e,{id:_0x4664a4}=_0x55705f;this['balanceEntity'][_0x215bbf(0x162)]({'where':{'userId':_0x4664a4}})[_0x215bbf(0x1dc)](_0x1bad9f=>{const _0x5761b8=_0x215bbf;if(!_0x1bad9f)return;this[_0x5761b8(0x12d)](_0x4664a4,_0x1bad9f);});});}async[_0x24a6fc(0x12d)](_0x2152c4,_0x57d335){const _0x457fda=_0x24a6fc,{balance:balance=0x0,usesLeft:usesLeft=0x0,paintCount:paintCount=0x0,useTokens:useTokens=0x0,useChats:useChats=0x0,usePaints:usePaints=0x0}=_0x57d335,_0x25f680=await this[_0x457fda(0x1cb)][_0x457fda(0x162)]({'where':{'userId':_0x2152c4}}),_0x3f4820={'userId':_0x2152c4,'model3Count':Number(usesLeft),'model4Count':_0x25f680?.[_0x457fda(0x1e3)]||0x0,'drawMjCount':Number(balance),'useModel3Count':Number(useChats),'useModel4Count':_0x25f680?.[_0x457fda(0x1ae)]||0x0,'useDrawMjCount':Number(usePaints),'useModel3Token':Number(useTokens),'useModel4Token':0x0,'useDrawMjToken':0x0},_0x37b385=await this[_0x457fda(0x145)][_0x457fda(0x162)]({'where':{'userId':_0x2152c4}});_0x37b385?common_1[_0x457fda(0x1cf)][_0x457fda(0x1e1)]('用户'+_0x2152c4+_0x457fda(0x187),_0x457fda(0x15e)):this[_0x457fda(0x145)][_0x457fda(0x1d5)](_0x3f4820)[_0x457fda(0x1dc)](_0x5ab271=>{const _0x8e392b=_0x457fda;common_1[_0x8e392b(0x1cf)][_0x8e392b(0x1e1)]('用户'+_0x2152c4+_0x8e392b(0x180),_0x8e392b(0x15e));})[_0x457fda(0x1b1)](_0x7b2298=>{const _0x12d309=_0x457fda;console[_0x12d309(0x19a)](_0x12d309(0x146),_0x7b2298),common_1[_0x12d309(0x1cf)][_0x12d309(0x1e1)]('用户'+_0x2152c4+_0x12d309(0x190),_0x12d309(0x15e));});}async[_0x24a6fc(0x11f)](_0x4e073d){const _0x2efa2e=_0x24a6fc,{fingerprint:_0x38e45c}=_0x4e073d[_0x2efa2e(0x169)],{id:_0x49c6b9}=_0x4e073d[_0x2efa2e(0x1be)];return await this['chatLogEntity']['update']({'userId':Number(_0x38e45c)},{'userId':_0x49c6b9}),await this[_0x2efa2e(0x133)][_0x2efa2e(0x18e)]({'userId':Number(_0x38e45c)},{'userId':_0x49c6b9}),await this[_0x2efa2e(0x1e4)][_0x2efa2e(0x18e)]({'userId':Number(_0x38e45c)},{'userId':_0x49c6b9}),0x1;}async['getVisitorCount'](_0x203001){const _0x37e88a=_0x24a6fc,{fingerprint:_0x53f011}=_0x203001[_0x37e88a(0x169)],_0x7661db=await this[_0x37e88a(0x160)]['count']({'where':{'userId':_0x53f011}}),_0x4531ca=await this[_0x37e88a(0x133)][_0x37e88a(0x1e3)]({'where':{'userId':_0x53f011}}),_0x222668=await this[_0x37e88a(0x1e4)]['count']({'where':{'userId':_0x53f011}});return _0x7661db||_0x4531ca||_0x222668||0x0;}};UserBalanceService=__decorate([(0x0,common_1[_0x24a6fc(0x1ba)])(),__param(0x0,(0x0,typeorm_1[_0x24a6fc(0x166)])(balance_entity_1['BalanceEntity'])),__param(0x1,(0x0,typeorm_1[_0x24a6fc(0x166)])(userBalance_entity_1[_0x24a6fc(0x1d8)])),__param(0x2,(0x0,typeorm_1[_0x24a6fc(0x166)])(accountLog_entity_1[_0x24a6fc(0x1c1)])),__param(0x3,(0x0,typeorm_1[_0x24a6fc(0x166)])(cramiPackage_entity_1[_0x24a6fc(0x1b9)])),__param(0x4,(0x0,typeorm_1[_0x24a6fc(0x166)])(config_entity_1[_0x24a6fc(0x174)])),__param(0x5,(0x0,typeorm_1[_0x24a6fc(0x166)])(user_entity_1[_0x24a6fc(0x1b8)])),__param(0x6,(0x0,typeorm_1['InjectRepository'])(salesUsers_entity_1[_0x24a6fc(0x123)])),__param(0x7,(0x0,typeorm_1[_0x24a6fc(0x166)])(whiteList_entity_1[_0x24a6fc(0x1c0)])),__param(0x8,(0x0,typeorm_1['InjectRepository'])(fingerprint_entity_1['FingerprintLogEntity'])),__param(0x9,(0x0,typeorm_1[_0x24a6fc(0x166)])(chatGroup_entity_1[_0x24a6fc(0x1e0)])),__param(0xa,(0x0,typeorm_1[_0x24a6fc(0x166)])(chatLog_entity_1[_0x24a6fc(0x1c5)])),__param(0xb,(0x0,typeorm_1[_0x24a6fc(0x166)])(midjourney_entity_1[_0x24a6fc(0x137)])),__metadata(_0x24a6fc(0x154),[typeorm_2[_0x24a6fc(0x1a6)],typeorm_2[_0x24a6fc(0x1a6)],typeorm_2[_0x24a6fc(0x1a6)],typeorm_2[_0x24a6fc(0x1a6)],typeorm_2['Repository'],typeorm_2['Repository'],typeorm_2[_0x24a6fc(0x1a6)],typeorm_2[_0x24a6fc(0x1a6)],typeorm_2[_0x24a6fc(0x1a6)],typeorm_2[_0x24a6fc(0x1a6)],typeorm_2['Repository'],typeorm_2[_0x24a6fc(0x1a6)],sales_service_1[_0x24a6fc(0x19e)],globalConfig_service_1[_0x24a6fc(0x15b)]])],UserBalanceService),exports[_0x24a6fc(0x199)]=UserBalanceService;