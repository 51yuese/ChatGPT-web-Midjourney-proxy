'use strict';const _0x45dbab=_0x64ab;(function(_0x2edd4a,_0x333d44){const _0xa55877=_0x64ab,_0x5d1391=_0x2edd4a();while(!![]){try{const _0x21f8d4=parseInt(_0xa55877(0x212))/0x1+parseInt(_0xa55877(0x20b))/0x2*(parseInt(_0xa55877(0x266))/0x3)+parseInt(_0xa55877(0x263))/0x4*(-parseInt(_0xa55877(0x24c))/0x5)+-parseInt(_0xa55877(0x217))/0x6*(parseInt(_0xa55877(0x271))/0x7)+parseInt(_0xa55877(0x27e))/0x8+parseInt(_0xa55877(0x21e))/0x9*(parseInt(_0xa55877(0x2ad))/0xa)+-parseInt(_0xa55877(0x2a2))/0xb*(parseInt(_0xa55877(0x280))/0xc);if(_0x21f8d4===_0x333d44)break;else _0x5d1391['push'](_0x5d1391['shift']());}catch(_0x5a6a67){_0x5d1391['push'](_0x5d1391['shift']());}}}(_0x3f97,0xf03f9));function _0x3f97(){const _0x4b759b=['useDrawMjToken','commissionAmount','旧账户信息迁移成功','rechargeType','@nestjs/typeorm','查询用户账户失败！','187tPZmGg','UserEntity','getRechargeLog','sumModel3Count','salesUsersEntity','expirationTime','../../common/utils/date','registerSendModel3Count','PAYMENT_REQUIRED','./balance.entity','LessThan','320KWzJWo','---','forEach','../../common/constants/balance.constant','firstRregisterSendModel4Count','invitedGuestSendModel4Count','goodsId','registerSendDrawMjCount','YYYY-MM-DD','object','memberModel3Count','Logger','HttpStatus','REFER_GIFT','inheritVisitorData','error:\x20','odel3','firstRegisterSendRank','toFixed','消费余额失败！','MidjourneyEntity','map','今日当前类型免费额度已经使用完毕、建议您注册账户体验更加完整的服务内容！','affected','userBalanceEntity','SalesUsersEntity','upgradeStatus','YYYY-MM-DD\x20HH:mm:ss','weight','add','firstRegisterSendStatus','../chatLog/chatLog.entity','typeorm','WhiteListEntity','__esModule','GlobalConfigService','format','../user/user.entity','../../common/utils','34282tyZeAE','model4Count','length','decorate','odel4','log','inviteGiveSendModel4Count','1786514VPjthj','find','reduce','balanceEntity','includes','798AJbYSe','midjourneyEntity','mjDraw','addBalanceToNewUser','status','function','INVITE_GIFT','387324PHXNAN','../crami/cramiPackage.entity','./fingerprint.entity','cramiPackageEntity','formatCreateOrUpdateDate','visitorModel3Num','setConfig','用户充值失败！','InjectRepository','vxNumber','chatGroupEntity','当前用户无需创建账户信息！','getOwnPropertyDescriptor','findAndCount','getFullYear','deductFromBalance','registerSendStatus','configEntity','validateBalance','writeOldBalanceToNewTable','useModel4Token','count','ConfigEntity','inviteGiveSendModel3Count','visitorModel4Num','hideString','getVisitorCount','userEntity','headers','phone','ChatLogEntity','catch','createBaseUserBalance','globalConfigService','BalanceService','MjCount','缺失当前用户账户记录！','../sales/salesUsers.entity','createSalesRecords','invitedGuestSendModel3Count','model3','isInteger','AccountLogEntity','whiteListEntity','useCount','getDate','70475cPFvtw','update','addBalanceToUser','email','../midjourney/midjourney.entity','>\x20或购买专属套餐\x20！','debug','accountLogEntity','Repository','registerSendModel4Count','packageId','chatLogEntity','isUpdatedToday','firstRregisterSendDrawMjCount','SalesService','saveCommissionAmount','sumDrawMjCount','useModel3Count','useModel4Count','Injectable','__metadata','REG_GIFT','username','328LpGHgc','useModel3Token','createRandomUid','147dSPFDQ','salesService','userId','expireDateCn','inviteGiveSendDrawMjCount','SCAN_PAY','./userBalance.entity','metadata','__decorate','RechargeType','memberDrawMjCount','46928GBqpfJ','user','您已经升级过了、请勿重复操作！','configKey','avatar','findOne','save','visitorMJNum','queryUserBalance','UserBalanceService','drawMjCount','total','缺失当前套餐ID、充值失败！','7417424RrWLit','@nestjs/common','1340664PIsHaY','model3Count','FingerprintLogEntity','saveRecordRechargeLog','充值的工单信息:','default','refundMjBalance','sumModel4Count','getMonth','getConfigs','configVal','fingerprintLogEntity','days','./accountLog.entity','model4','then','DESC','./../globalConfig/globalConfig.service','CramiPackageEntity','memberModel4Count','../sales/sales.service','firstRregisterSendModel3Count','HttpException','BAD_REQUEST','invitedGuestSendDrawMjCount','queryUserBalanceByIds','addBalanceToOrder','充值失败'];_0x3f97=function(){return _0x4b759b;};return _0x3f97();}var __decorate=this&&this[_0x45dbab(0x26e)]||function(_0x24e141,_0x3d7a82,_0x2a5221,_0x517559){const _0x910f05=_0x45dbab;var _0x4d7c8f=arguments['length'],_0x3c4f78=_0x4d7c8f<0x3?_0x3d7a82:_0x517559===null?_0x517559=Object[_0x910f05(0x22a)](_0x3d7a82,_0x2a5221):_0x517559,_0x75063d;if(typeof Reflect==='object'&&typeof Reflect[_0x910f05(0x20e)]===_0x910f05(0x21c))_0x3c4f78=Reflect[_0x910f05(0x20e)](_0x24e141,_0x3d7a82,_0x2a5221,_0x517559);else{for(var _0x2842a2=_0x24e141[_0x910f05(0x20d)]-0x1;_0x2842a2>=0x0;_0x2842a2--)if(_0x75063d=_0x24e141[_0x2842a2])_0x3c4f78=(_0x4d7c8f<0x3?_0x75063d(_0x3c4f78):_0x4d7c8f>0x3?_0x75063d(_0x3d7a82,_0x2a5221,_0x3c4f78):_0x75063d(_0x3d7a82,_0x2a5221))||_0x3c4f78;}return _0x4d7c8f>0x3&&_0x3c4f78&&Object['defineProperty'](_0x3d7a82,_0x2a5221,_0x3c4f78),_0x3c4f78;},__metadata=this&&this[_0x45dbab(0x260)]||function(_0x205c68,_0x116dc5){const _0x464ba4=_0x45dbab;if(typeof Reflect===_0x464ba4(0x1ed)&&typeof Reflect[_0x464ba4(0x26d)]===_0x464ba4(0x21c))return Reflect[_0x464ba4(0x26d)](_0x205c68,_0x116dc5);},__param=this&&this['__param']||function(_0x269c3d,_0x2b2361){return function(_0x54e9fd,_0x5e2d21){_0x2b2361(_0x54e9fd,_0x5e2d21,_0x269c3d);};};Object['defineProperty'](exports,_0x45dbab(0x206),{'value':!![]}),exports[_0x45dbab(0x27a)]=void 0x0;const globalConfig_service_1=require(_0x45dbab(0x291)),typeorm_1=require(_0x45dbab(0x2a0)),balance_entity_1=require(_0x45dbab(0x2ab)),common_1=require(_0x45dbab(0x27f)),typeorm_2=require(_0x45dbab(0x204)),balance_constant_1=require(_0x45dbab(0x2b0)),accountLog_entity_1=require(_0x45dbab(0x28d)),utils_1=require(_0x45dbab(0x20a)),config_entity_1=require('../globalConfig/config.entity'),cramiPackage_entity_1=require(_0x45dbab(0x21f)),userBalance_entity_1=require(_0x45dbab(0x26c)),date_1=require(_0x45dbab(0x2a8)),user_entity_1=require(_0x45dbab(0x209)),salesUsers_entity_1=require(_0x45dbab(0x243)),sales_service_1=require(_0x45dbab(0x294)),whiteList_entity_1=require('../chatgpt/whiteList.entity'),fingerprint_entity_1=require(_0x45dbab(0x220)),chatLog_entity_1=require(_0x45dbab(0x203)),chatGroup_entity_1=require('../chatGroup/chatGroup.entity'),midjourney_entity_1=require(_0x45dbab(0x250));function _0x64ab(_0x548217,_0x150bfd){const _0x3f9759=_0x3f97();return _0x64ab=function(_0x64abce,_0x5c5880){_0x64abce=_0x64abce-0x1e8;let _0x45447a=_0x3f9759[_0x64abce];return _0x45447a;},_0x64ab(_0x548217,_0x150bfd);}let UserBalanceService=class UserBalanceService{constructor(_0x105aa3,_0x24170f,_0x44fc42,_0x356078,_0x4d91e4,_0x13de85,_0x4ea236,_0x3583eb,_0xbdf2d1,_0x318a4b,_0x126c6f,_0x592d28,_0x2e6582,_0x2a168a){const _0x802702=_0x45dbab;this['balanceEntity']=_0x105aa3,this[_0x802702(0x1fc)]=_0x24170f,this[_0x802702(0x253)]=_0x44fc42,this[_0x802702(0x221)]=_0x356078,this['configEntity']=_0x4d91e4,this[_0x802702(0x239)]=_0x13de85,this['salesUsersEntity']=_0x4ea236,this['whiteListEntity']=_0x3583eb,this[_0x802702(0x28b)]=_0xbdf2d1,this[_0x802702(0x228)]=_0x318a4b,this[_0x802702(0x257)]=_0x126c6f,this[_0x802702(0x218)]=_0x592d28,this[_0x802702(0x267)]=_0x2e6582,this[_0x802702(0x23f)]=_0x2a168a;}async[_0x45dbab(0x21a)](_0x47dc51,_0x542829){const _0x56dd3b=_0x45dbab;try{const _0x13eb0d=await this[_0x56dd3b(0x22f)]['find']({'where':{'configKey':(0x0,typeorm_2['In'])([_0x56dd3b(0x22e),_0x56dd3b(0x2a9),_0x56dd3b(0x255),_0x56dd3b(0x1eb),_0x56dd3b(0x202),_0x56dd3b(0x1f5),_0x56dd3b(0x295),_0x56dd3b(0x1e8),'firstRregisterSendDrawMjCount','inviteSendStatus',_0x56dd3b(0x235),_0x56dd3b(0x211),_0x56dd3b(0x26a),'invitedGuestSendModel3Count',_0x56dd3b(0x298),_0x56dd3b(0x1e9)])}}),_0x2ce84b=_0x13eb0d[_0x56dd3b(0x214)]((_0x15c4f7,_0x15e2ca)=>{const _0x50ad73=_0x56dd3b,_0x577fc9=Number(_0x15e2ca[_0x50ad73(0x28a)]),_0x1b7981=Number[_0x50ad73(0x247)](_0x577fc9)&&_0x577fc9>0x0?_0x577fc9:0x0;return _0x15c4f7[_0x15e2ca[_0x50ad73(0x274)]]=_0x1b7981,_0x15c4f7;},{});let _0x4599c6=0x0,_0x23abb2=0x0,_0x1abcaf=0x0;_0x2ce84b[_0x56dd3b(0x22e)]===0x1&&(_0x4599c6=_0x4599c6+_0x2ce84b[_0x56dd3b(0x2a9)],_0x23abb2=_0x23abb2+_0x2ce84b[_0x56dd3b(0x255)],_0x1abcaf=_0x1abcaf+_0x2ce84b['registerSendDrawMjCount']),_0x2ce84b['registerSendStatus']===0x1&&_0x2ce84b[_0x56dd3b(0x202)]===0x1&&_0x47dc51<=_0x2ce84b[_0x56dd3b(0x1f5)]&&(_0x4599c6=_0x4599c6+_0x2ce84b[_0x56dd3b(0x295)],_0x23abb2=_0x23abb2+_0x2ce84b['firstRregisterSendModel4Count'],_0x1abcaf=_0x1abcaf+_0x2ce84b[_0x56dd3b(0x259)]),await this[_0x56dd3b(0x283)]({'userId':_0x47dc51,'rechargeType':balance_constant_1['RechargeType'][_0x56dd3b(0x261)],'model3Count':_0x4599c6,'drawMjCount':_0x1abcaf,'model4Count':_0x23abb2}),_0x542829&&(Number(_0x2ce84b['inviteSendStatus'])===0x1&&(_0x4599c6=_0x4599c6+Number(_0x2ce84b[_0x56dd3b(0x245)]),_0x23abb2=_0x23abb2+Number(_0x2ce84b[_0x56dd3b(0x1e9)]),_0x1abcaf=_0x1abcaf+Number(_0x2ce84b[_0x56dd3b(0x298)]),await this['saveRecordRechargeLog']({'userId':_0x47dc51,'rechargeType':balance_constant_1[_0x56dd3b(0x26f)][_0x56dd3b(0x21d)],'model3Count':_0x2ce84b[_0x56dd3b(0x245)],'model4Count':_0x2ce84b[_0x56dd3b(0x1e9)],'drawMjCount':_0x2ce84b[_0x56dd3b(0x298)]}),await this['addBalanceToUser'](_0x542829,{'model3Count':_0x2ce84b[_0x56dd3b(0x235)],'model4Count':_0x2ce84b['inviteGiveSendModel4Count'],'drawMjCount':_0x2ce84b[_0x56dd3b(0x26a)]}),await this[_0x56dd3b(0x283)]({'userId':_0x542829,'rechargeType':balance_constant_1['RechargeType'][_0x56dd3b(0x1f1)],'model3Count':_0x2ce84b['inviteGiveSendModel3Count'],'model4Count':_0x2ce84b[_0x56dd3b(0x211)],'drawMjCount':_0x2ce84b[_0x56dd3b(0x26a)]}))),await this[_0x56dd3b(0x1fc)][_0x56dd3b(0x277)]({'userId':_0x47dc51,'model3Count':_0x4599c6,'model4Count':_0x23abb2,'drawMjCount':_0x1abcaf,'useTokens':0x0});}catch(_0x48fb09){console[_0x56dd3b(0x210)](_0x56dd3b(0x1f3),_0x48fb09);throw new common_1['HttpException']('注册赠送失败,请联系管理员！',common_1['HttpStatus'][_0x56dd3b(0x297)]);}}async[_0x45dbab(0x230)](_0x22ee25,_0x5aa90f,_0x288a5f){const _0x2ae400=_0x45dbab,{id:_0x3cf8ad,role:_0x1418a5}=_0x22ee25[_0x2ae400(0x272)];let _0x545712=await this['userBalanceEntity']['findOne']({'where':{'userId':_0x3cf8ad}});!_0x545712&&(_0x545712=await this[_0x2ae400(0x23e)](_0x3cf8ad));if(_0x1418a5==='visitor')return this['validateVisitorBalance'](_0x22ee25,_0x5aa90f,_0x288a5f);const _0x38ab7d=await this['configEntity'][_0x2ae400(0x276)]({'where':{'configKey':_0x2ae400(0x227)}}),_0x262d0a=_0x38ab7d?_0x38ab7d[_0x2ae400(0x28a)]:_0x2ae400(0x2ae),_0x3f8887=_0x5aa90f===_0x2ae400(0x246)?_0x2ae400(0x1ee):_0x5aa90f===_0x2ae400(0x28e)?_0x2ae400(0x293):_0x5aa90f===_0x2ae400(0x219)?_0x2ae400(0x270):null,_0x3516bc=_0x5aa90f===_0x2ae400(0x246)?_0x2ae400(0x281):_0x5aa90f==='model4'?_0x2ae400(0x20c):_0x5aa90f===_0x2ae400(0x219)?_0x2ae400(0x27b):null;if(_0x545712[_0x2ae400(0x256)]&&_0x545712[_0x3f8887]<_0x288a5f){if(_0x545712[_0x3516bc]<_0x288a5f)throw new common_1['HttpException']('您的账户余额不足,如果想继续体验服务,请联系管理员\x20<VX:\x20'+_0x262d0a+'>\x20或购买专属套餐\x20！',common_1[_0x2ae400(0x1f0)][_0x2ae400(0x2aa)]);}if(!_0x545712[_0x2ae400(0x256)]&&_0x545712[_0x3516bc]<_0x288a5f)throw new common_1[(_0x2ae400(0x296))]('您的账户余额不足,如果想继续体验服务,请联系管理员\x20<VX:\x20'+_0x262d0a+_0x2ae400(0x251),common_1[_0x2ae400(0x1f0)]['PAYMENT_REQUIRED']);return _0x545712;}async['validateVisitorBalance'](_0xe36e97,_0x392345,_0x2a15b6){const _0x15af44=_0x45dbab,{id:_0xec0a38}=_0xe36e97[_0x15af44(0x272)],_0x31067a=_0x392345===_0x15af44(0x246)?_0x15af44(0x281):_0x392345===_0x15af44(0x28e)?_0x15af44(0x20c):_0x392345===_0x15af44(0x219)?_0x15af44(0x27b):null,_0x411d30=new Date(),_0x7dabfd=await this[_0x15af44(0x28b)][_0x15af44(0x276)]({'where':{'fingerprint':_0xec0a38}}),{visitorModel3Num:_0xcbb106,visitorModel4Num:_0xf6e4a0,visitorMJNum:_0x1fcdf5}=await this[_0x15af44(0x23f)][_0x15af44(0x289)]([_0x15af44(0x223),_0x15af44(0x236),_0x15af44(0x278)]),_0x356ffa={'model3Count':_0xcbb106?Number(_0xcbb106):0x0,'model4Count':_0xf6e4a0?Number(_0xf6e4a0):0x0,'drawMjCount':_0x1fcdf5?Number(_0x1fcdf5):0x0};if(!_0x7dabfd){let _0x2f9a50={'fingerprint':_0xec0a38,'model3Count':0x0,'model4Count':0x0,'drawMjCount':0x0};_0x2f9a50[_0x31067a]=_0x2f9a50[_0x31067a]+_0x2a15b6;if(_0x2f9a50[_0x31067a]>_0x356ffa[_0x31067a])throw new common_1[(_0x15af44(0x296))](_0x15af44(0x1fa),common_1[_0x15af44(0x1f0)]['PAYMENT_REQUIRED']);else return await this[_0x15af44(0x28b)][_0x15af44(0x277)](_0x2f9a50),!![];}else{const {model3Count:_0x2b385a,model4Count:_0x108d0f,drawMjCount:_0x4037c4}=_0x7dabfd;let _0x113170={'model3Count':_0x2b385a,'model4Count':_0x108d0f,'drawMjCount':_0x4037c4};const _0x41cdfa=Number(new Date(_0x7dabfd['updatedAt'])),_0x37c1c3=this[_0x15af44(0x258)](_0x41cdfa);_0x37c1c3?_0x113170[_0x31067a]=_0x113170[_0x31067a]+_0x2a15b6:(_0x113170={'model3Count':0x0,'model4Count':0x0,'drawMjCount':0x0},_0x113170[_0x31067a]=_0x113170[_0x31067a]+_0x2a15b6);if(_0x113170[_0x31067a]>_0x356ffa[_0x31067a])throw new common_1['HttpException'](_0x15af44(0x1fa),common_1['HttpStatus'][_0x15af44(0x2aa)]);else return await this[_0x15af44(0x28b)][_0x15af44(0x24d)]({'fingerprint':_0xec0a38},_0x113170),!![];}}['isUpdatedToday'](_0x358aee){const _0x114986=_0x45dbab,_0x2d435a=new Date(),_0x42f46c=new Date(_0x2d435a[_0x114986(0x22c)](),_0x2d435a[_0x114986(0x288)](),_0x2d435a[_0x114986(0x24b)]());return _0x358aee>=_0x42f46c;}async[_0x45dbab(0x22d)](_0x186613,_0x7929e8,_0x287a2f,_0x97a04d=0x0){const _0x5968c6=_0x45dbab,_0x45a700=await this['userBalanceEntity'][_0x5968c6(0x276)]({'where':{'userId':_0x186613}});if(!_0x45a700)throw new common_1[(_0x5968c6(0x296))](_0x5968c6(0x242),common_1[_0x5968c6(0x1f0)][_0x5968c6(0x297)]);const _0x425ce5=_0x7929e8===_0x5968c6(0x246)?_0x5968c6(0x1ee):_0x7929e8==='model4'?'memberModel4Count':_0x7929e8==='mjDraw'?'memberDrawMjCount':null,_0x53e7fb=_0x7929e8===_0x5968c6(0x246)?_0x5968c6(0x281):_0x7929e8===_0x5968c6(0x28e)?_0x5968c6(0x20c):_0x7929e8===_0x5968c6(0x219)?'drawMjCount':null,_0x21d054=_0x45a700[_0x5968c6(0x256)]&&_0x45a700[_0x425ce5]<_0x287a2f?_0x53e7fb:_0x45a700['packageId']?_0x425ce5:_0x53e7fb;let _0x28eaed=null;_0x21d054['includes'](_0x5968c6(0x1f4))&&(_0x28eaed=_0x5968c6(0x264));_0x21d054[_0x5968c6(0x216)](_0x5968c6(0x20f))&&(_0x28eaed=_0x5968c6(0x232));_0x21d054['includes'](_0x5968c6(0x241))&&(_0x28eaed=_0x5968c6(0x29c));const _0x3266a4={[_0x21d054]:_0x45a700[_0x21d054]-_0x287a2f<0x0?0x0:_0x45a700[_0x21d054]-_0x287a2f,[_0x28eaed]:_0x45a700[_0x28eaed]+_0x97a04d};_0x28eaed==='useModel3Token'&&(_0x3266a4[_0x5968c6(0x25d)]=_0x45a700[_0x5968c6(0x25d)]+0x1),_0x28eaed==='useModel4Token'&&(_0x3266a4[_0x5968c6(0x25e)]=_0x45a700[_0x5968c6(0x25e)]+0x1);const _0x14a60e=await this['userBalanceEntity'][_0x5968c6(0x24d)]({'userId':_0x186613},_0x3266a4);if(_0x14a60e['affected']===0x0)throw new common_1[(_0x5968c6(0x296))](_0x5968c6(0x1f7),common_1[_0x5968c6(0x1f0)][_0x5968c6(0x297)]);}async[_0x45dbab(0x279)](_0xa53a18){const _0x24cc02=_0x45dbab;try{const _0x217ad=await this[_0x24cc02(0x1fc)]['findOne']({'where':{'userId':_0xa53a18},'select':[_0x24cc02(0x256),_0x24cc02(0x281),'model4Count',_0x24cc02(0x27b),_0x24cc02(0x1ee),_0x24cc02(0x293),_0x24cc02(0x270),_0x24cc02(0x25d),_0x24cc02(0x25e),'useModel3Token','useModel4Token',_0x24cc02(0x29c),_0x24cc02(0x2a7)]});if(!_0x217ad){const _0x337f7e=await this[_0x24cc02(0x23e)](_0xa53a18);if(_0x337f7e)return await this[_0x24cc02(0x279)](_0xa53a18);else throw new common_1[(_0x24cc02(0x296))]('查询当前用户余额失败！',common_1[_0x24cc02(0x1f0)][_0x24cc02(0x297)]);}return _0x217ad[_0x24cc02(0x2a5)]=_0x217ad[_0x24cc02(0x256)]?_0x217ad['model3Count']+_0x217ad['memberModel3Count']:_0x217ad[_0x24cc02(0x281)],_0x217ad[_0x24cc02(0x287)]=_0x217ad['packageId']?_0x217ad[_0x24cc02(0x20c)]+_0x217ad[_0x24cc02(0x293)]:_0x217ad['model4Count'],_0x217ad[_0x24cc02(0x25c)]=_0x217ad[_0x24cc02(0x256)]?_0x217ad[_0x24cc02(0x27b)]+_0x217ad['memberDrawMjCount']:_0x217ad[_0x24cc02(0x27b)],_0x217ad[_0x24cc02(0x2a7)]=_0x217ad['expirationTime']?(0x0,date_1['formatDate'])(_0x217ad[_0x24cc02(0x2a7)],_0x24cc02(0x1ec)):null,_0x217ad;}catch(_0x28308f){console[_0x24cc02(0x210)](_0x24cc02(0x1f3),_0x28308f);}}async[_0x45dbab(0x283)](_0x2422aa){const _0x5ded01=_0x45dbab,{userId:_0x2bf294,rechargeType:_0x594e85,model3Count:_0x3c0d45,model4Count:_0x42ec44,drawMjCount:_0x5f2a1e,days:days=-0x1,pkgName:pkgName='',extent:extent=''}=_0x2422aa;if(!_0x2bf294)throw new common_1[(_0x5ded01(0x296))]('当前用户不存在,记录充值日志异常',common_1['HttpStatus'][_0x5ded01(0x297)]);const _0x3998a5=(0x0,utils_1[_0x5ded01(0x265)])();return await this[_0x5ded01(0x253)]['save']({'userId':_0x2bf294,'rechargeType':_0x594e85,'model3Count':_0x3c0d45,'model4Count':_0x42ec44,'drawMjCount':_0x5f2a1e,'days':days,'extent':extent,'uid':_0x3998a5,'pkgName':pkgName});}async[_0x45dbab(0x23e)](_0xcbc0d6,_0x2ee58d={}){const _0x260727=_0x45dbab,{model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0x2ee58d,_0x5068a0=await this['userBalanceEntity'][_0x260727(0x276)]({'where':{'userId':_0xcbc0d6}});if(_0x5068a0)throw new common_1['HttpException'](_0x260727(0x229),common_1[_0x260727(0x1f0)][_0x260727(0x297)]);return await this[_0x260727(0x1fc)][_0x260727(0x277)]({'userId':_0xcbc0d6,'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount});}async[_0x45dbab(0x24e)](_0x8c6924,_0x1971d0,_0x2be062=-0x1){const _0x2e5c20=_0x45dbab;try{const _0x2ebf91=await this[_0x2e5c20(0x1fc)][_0x2e5c20(0x276)]({'where':{'userId':_0x8c6924}})||await this['createBaseUserBalance'](_0x8c6924);if(!_0x2ebf91)throw new common_1[(_0x2e5c20(0x296))]('查询用户账户信息失败！',common_1[_0x2e5c20(0x1f0)]['BAD_REQUEST']);const {model3Count:_0x48106b,model4Count:_0x4c95f9,drawMjCount:_0x2ea407,memberModel3Count:_0x32ec32,memberModel4Count:_0x362aa8,memberDrawMjCount:_0x3b5caa}=_0x2ebf91;let _0xb3ce74={};if(_0x2be062>0x0){const {packageId:_0x16e450}=_0x1971d0;if(!_0x16e450)throw new common_1[(_0x2e5c20(0x296))](_0x2e5c20(0x27d),common_1[_0x2e5c20(0x1f0)][_0x2e5c20(0x297)]);const _0xffba5e=await this[_0x2e5c20(0x221)][_0x2e5c20(0x276)]({'where':{'id':_0x16e450}});if(!_0xffba5e)throw new common_1[(_0x2e5c20(0x296))]('当前套餐不存在！',common_1[_0x2e5c20(0x1f0)][_0x2e5c20(0x297)]);const {weight:_0xfe6a06}=_0xffba5e;if(!_0x2ebf91['packageId'])_0xb3ce74={'memberModel3Count':_0x48106b+_0x1971d0[_0x2e5c20(0x281)],'memberModel4Count':_0x4c95f9+_0x1971d0[_0x2e5c20(0x20c)],'memberDrawMjCount':_0x2ea407+_0x1971d0['drawMjCount'],'expirationTime':(0x0,date_1[_0x2e5c20(0x285)])()[_0x2e5c20(0x201)](_0x2be062>0x0?_0x2be062:0x0,'day')[_0x2e5c20(0x208)]('YYYY-MM-DD\x20HH:mm:ss'),'packageId':_0x16e450};else{const _0xb0140c=await this['cramiPackageEntity'][_0x2e5c20(0x276)]({'where':{'id':_0x2ebf91[_0x2e5c20(0x256)]}});_0xfe6a06>=_0xb0140c[_0x2e5c20(0x200)]&&(_0xb3ce74={'memberModel3Count':_0x32ec32+_0x1971d0['model3Count'],'memberModel4Count':_0x362aa8+_0x1971d0[_0x2e5c20(0x20c)],'memberDrawMjCount':_0x3b5caa+_0x1971d0[_0x2e5c20(0x27b)],'expirationTime':(0x0,date_1[_0x2e5c20(0x285)])(_0x2ebf91[_0x2e5c20(0x2a7)])[_0x2e5c20(0x201)](_0x2be062>0x0?_0x2be062:0x0,'day')['format'](_0x2e5c20(0x1ff)),'packageId':_0x16e450}),_0xfe6a06<_0xb0140c[_0x2e5c20(0x200)]&&(_0xb3ce74={'memberModel3Count':_0x32ec32+_0x1971d0['model3Count'],'memberModel4Count':_0x362aa8+_0x1971d0[_0x2e5c20(0x20c)],'memberDrawMjCount':_0x3b5caa+_0x1971d0[_0x2e5c20(0x27b)]});}}_0x2be062<=0x0&&(_0xb3ce74={'model3Count':_0x48106b+_0x1971d0['model3Count'],'model4Count':_0x4c95f9+_0x1971d0['model4Count'],'drawMjCount':_0x2ea407+_0x1971d0[_0x2e5c20(0x27b)]});const _0x1e21cf=await this[_0x2e5c20(0x1fc)][_0x2e5c20(0x24d)]({'userId':_0x8c6924},_0xb3ce74);if(_0x1e21cf[_0x2e5c20(0x1fb)]===0x0)throw new common_1['HttpException'](_0x8c6924+_0x2e5c20(0x29b),common_1[_0x2e5c20(0x1f0)][_0x2e5c20(0x297)]);}catch(_0xa36f17){console[_0x2e5c20(0x210)](_0x2e5c20(0x1f3),_0xa36f17);throw new common_1[(_0x2e5c20(0x296))](_0x2e5c20(0x225),common_1[_0x2e5c20(0x1f0)][_0x2e5c20(0x297)]);}}async[_0x45dbab(0x29a)](_0x3a7162){const _0x506d81=_0x45dbab;console[_0x506d81(0x210)](_0x506d81(0x284),_0x3a7162);try{const {userId:_0x24b1f1,goodsId:_0x339725}=_0x3a7162,_0x235942=await this[_0x506d81(0x221)]['findOne']({'where':{'id':_0x3a7162[_0x506d81(0x1ea)],'status':0x1}});if(!_0x235942)throw new common_1[(_0x506d81(0x296))]('非法操作、当前充值套餐暂不存在！',common_1[_0x506d81(0x1f0)]['BAD_REQUEST']);const {model3Count:_0x24e9f5,model4Count:_0x5e9511,drawMjCount:_0x4dbd79,days:_0x481f6f,name:_0x3ba88c}=_0x235942,_0x42232c={'model3Count':_0x24e9f5,'model4Count':_0x5e9511,'drawMjCount':_0x4dbd79,'days':_0x481f6f,'packageId':_0x3a7162['goodsId']};await this[_0x506d81(0x24e)](_0x24b1f1,_0x42232c,_0x481f6f),await this[_0x506d81(0x283)]({'userId':_0x24b1f1,'rechargeType':balance_constant_1[_0x506d81(0x26f)][_0x506d81(0x26b)],'model3Count':_0x24e9f5,'model4Count':_0x5e9511,'drawMjCount':_0x4dbd79,'pkgName':_0x3ba88c,'days':_0x481f6f});const _0x3d49b0=await this['userEntity']['findOne']({'where':{'id':_0x24b1f1}}),{invitedBy:_0x38b334}=_0x3d49b0;if(_0x38b334){const _0x4665c8=await this[_0x506d81(0x239)]['findOne']({'where':{'inviteCode':_0x38b334}}),_0x3a7cff=await this[_0x506d81(0x2a6)][_0x506d81(0x276)]({'where':{'userId':_0x4665c8['id']}});if(!_0x4665c8)return;const {id:_0x542897}=_0x4665c8,{performanceRatio:_0xe58431}=_0x3a7cff,_0x23240c={'inviterUserId':_0x542897,'inviteeUserId':_0x24b1f1,'orderId':_0x3a7162['id'],'orderPrice':_0x3a7162[_0x506d81(0x27c)],'commissionPercentage':_0xe58431,'commissionAmount':(_0x3a7162[_0x506d81(0x27c)]*_0xe58431/0x64)[_0x506d81(0x1f6)](0x2)};await this['salesService'][_0x506d81(0x244)](_0x23240c),await this[_0x506d81(0x267)][_0x506d81(0x25b)](_0x542897,_0x23240c[_0x506d81(0x29d)]);}}catch(_0x3cc22a){console[_0x506d81(0x210)](_0x506d81(0x1f3),_0x3cc22a);throw new common_1[(_0x506d81(0x296))]('充值失败！',common_1[_0x506d81(0x1f0)][_0x506d81(0x297)]);}}async[_0x45dbab(0x2a4)](_0x3b6403,_0x284fe0){const _0x53d3aa=_0x45dbab,{page:page=0x1,size:size=0x14}=_0x284fe0,{id:_0xd7b447}=_0x3b6403['user'],[_0x12abd6,_0x470fb9]=await this[_0x53d3aa(0x253)][_0x53d3aa(0x22b)]({'where':{'userId':_0xd7b447},'order':{'id':'DESC'},'skip':(page-0x1)*size,'take':size});return _0x12abd6[_0x53d3aa(0x2af)](_0x52eeef=>{const _0x51b6ed=_0x53d3aa;_0x52eeef[_0x51b6ed(0x269)]=_0x52eeef[_0x51b6ed(0x28c)]>0x0?_0x52eeef['days']+'天':'永久';}),{'rows':(0x0,date_1[_0x53d3aa(0x222)])(_0x12abd6),'count':_0x470fb9};}async['getAccountLog'](_0x5636c6,_0x16fbe9){const _0x473b7e=_0x45dbab;try{const {page:page=0x1,size:size=0xa,userId:_0x57f1a9,rechargeType:_0x3175dc,packageId:_0x125e00}=_0x16fbe9,{role:_0x323d60}=_0x5636c6['user'],_0x22f798={};_0x3175dc&&(_0x22f798[_0x473b7e(0x29f)]=_0x3175dc),_0x22f798[_0x473b7e(0x268)]=_0x57f1a9||(0x0,typeorm_2[_0x473b7e(0x2ac)])(0x186a0),_0x125e00&&(_0x22f798[_0x473b7e(0x256)]={'$like':'%'+_0x125e00+'%'});const [_0x2bc833,_0x3adb50]=await this[_0x473b7e(0x253)][_0x473b7e(0x22b)]({'where':_0x22f798,'order':{'id':_0x473b7e(0x290)},'skip':(page-0x1)*size,'take':size}),_0x20ae6e=_0x2bc833[_0x473b7e(0x1f9)](_0x430c68=>_0x430c68['userId']),_0x4dd10e=await this[_0x473b7e(0x239)][_0x473b7e(0x213)]({'where':{'id':(0x0,typeorm_2['In'])(_0x20ae6e)}});return _0x2bc833[_0x473b7e(0x2af)](_0x313637=>{const _0xc58b4a=_0x473b7e,_0x30e407=_0x4dd10e[_0xc58b4a(0x213)](_0x14d2d7=>_0x14d2d7['id']===_0x313637['userId']);_0x313637[_0xc58b4a(0x262)]=_0x30e407===null||_0x30e407===void 0x0?void 0x0:_0x30e407[_0xc58b4a(0x262)],_0x313637[_0xc58b4a(0x24f)]=_0x30e407===null||_0x30e407===void 0x0?void 0x0:_0x30e407[_0xc58b4a(0x24f)],_0x313637[_0xc58b4a(0x23b)]=_0x30e407===null||_0x30e407===void 0x0?void 0x0:_0x30e407[_0xc58b4a(0x23b)],_0x313637[_0xc58b4a(0x21b)]=_0x30e407===null||_0x30e407===void 0x0?void 0x0:_0x30e407['status'],_0x313637[_0xc58b4a(0x275)]=_0x30e407===null||_0x30e407===void 0x0?void 0x0:_0x30e407[_0xc58b4a(0x275)];}),_0x323d60!=='super'&&_0x2bc833[_0x473b7e(0x2af)](_0x8fb3b8=>{const _0x398f86=_0x473b7e;_0x8fb3b8[_0x398f86(0x24f)]=_0x8fb3b8[_0x398f86(0x24f)]?(0x0,utils_1[_0x398f86(0x237)])(_0x8fb3b8[_0x398f86(0x24f)]):'',_0x8fb3b8['phone']=_0x8fb3b8[_0x398f86(0x23b)]?(0x0,utils_1['hideString'])(_0x8fb3b8[_0x398f86(0x23b)]):'';}),{'rows':_0x2bc833,'count':_0x3adb50};}catch(_0x4cba9e){console[_0x473b7e(0x210)](_0x473b7e(0x1f3),_0x4cba9e);throw new common_1['HttpException'](_0x473b7e(0x2a1),common_1[_0x473b7e(0x1f0)][_0x473b7e(0x297)]);}}async[_0x45dbab(0x299)](_0x21ae22){const _0xebc49d=_0x45dbab;return await this[_0xebc49d(0x1fc)][_0xebc49d(0x213)]({'where':{'userId':(0x0,typeorm_2['In'])(_0x21ae22)}});}async[_0x45dbab(0x286)](_0xc37c7c,_0x1e1a21){}async['upgradeBalance'](){const _0x535df7=_0x45dbab,_0x3c68c7=await this[_0x535df7(0x239)][_0x535df7(0x213)]();if(!_0x3c68c7[_0x535df7(0x20d)])return;const _0x523e28=await this[_0x535df7(0x23f)][_0x535df7(0x289)]([_0x535df7(0x1fe)]);if(!_0x523e28)await this['globalConfigService'][_0x535df7(0x224)]({'settings':[{'configKey':_0x535df7(0x1fe),'configVal':'1'}]});else throw new common_1[(_0x535df7(0x296))](_0x535df7(0x273),common_1[_0x535df7(0x1f0)]['BAD_REQUEST']);_0x3c68c7[_0x535df7(0x2af)](_0x4eea49=>{const _0x25b4ac=_0x535df7,{id:_0xc2c13f}=_0x4eea49;this[_0x25b4ac(0x215)][_0x25b4ac(0x276)]({'where':{'userId':_0xc2c13f}})[_0x25b4ac(0x28f)](_0x86933a=>{const _0x170e36=_0x25b4ac;if(!_0x86933a)return;this[_0x170e36(0x231)](_0xc2c13f,_0x86933a);});});}async[_0x45dbab(0x231)](_0xf0016e,_0x17acec){const _0x4aa38f=_0x45dbab,{balance:balance=0x0,usesLeft:usesLeft=0x0,paintCount:paintCount=0x0,useTokens:useTokens=0x0,useChats:useChats=0x0,usePaints:usePaints=0x0}=_0x17acec,_0x28857d=await this[_0x4aa38f(0x249)][_0x4aa38f(0x276)]({'where':{'userId':_0xf0016e}}),_0x2fdcf3={'userId':_0xf0016e,'model3Count':Number(usesLeft),'model4Count':(_0x28857d===null||_0x28857d===void 0x0?void 0x0:_0x28857d[_0x4aa38f(0x233)])||0x0,'drawMjCount':Number(balance),'useModel3Count':Number(useChats),'useModel4Count':(_0x28857d===null||_0x28857d===void 0x0?void 0x0:_0x28857d[_0x4aa38f(0x24a)])||0x0,'useDrawMjCount':Number(usePaints),'useModel3Token':Number(useTokens),'useModel4Token':0x0,'useDrawMjToken':0x0},_0x5888dc=await this[_0x4aa38f(0x1fc)]['findOne']({'where':{'userId':_0xf0016e}});_0x5888dc?common_1['Logger'][_0x4aa38f(0x252)]('用户'+_0xf0016e+'账户信息已经存在、迁移无效','BalanceService'):this[_0x4aa38f(0x1fc)]['save'](_0x2fdcf3)[_0x4aa38f(0x28f)](_0x40ec97=>{const _0xd4916c=_0x4aa38f;common_1[_0xd4916c(0x1ef)]['debug']('用户'+_0xf0016e+_0xd4916c(0x29e),_0xd4916c(0x240));})[_0x4aa38f(0x23d)](_0x576f88=>{const _0x3bb6c8=_0x4aa38f;console['log']('error:\x20',_0x576f88),common_1[_0x3bb6c8(0x1ef)][_0x3bb6c8(0x252)]('用户'+_0xf0016e+'旧账户信息迁移失败',_0x3bb6c8(0x240));});}async[_0x45dbab(0x1f2)](_0x251fc0){const _0x4136c4=_0x45dbab,{fingerprint:_0x29948a}=_0x251fc0[_0x4136c4(0x23a)],{id:_0x47b5dc}=_0x251fc0[_0x4136c4(0x272)];return await this[_0x4136c4(0x257)]['update']({'userId':Number(_0x29948a)},{'userId':_0x47b5dc}),await this['chatGroupEntity'][_0x4136c4(0x24d)]({'userId':Number(_0x29948a)},{'userId':_0x47b5dc}),await this['midjourneyEntity'][_0x4136c4(0x24d)]({'userId':Number(_0x29948a)},{'userId':_0x47b5dc}),0x1;}async[_0x45dbab(0x238)](_0x20a921){const _0x1f9204=_0x45dbab,{fingerprint:_0x263b91}=_0x20a921[_0x1f9204(0x23a)],_0x595df6=await this[_0x1f9204(0x257)][_0x1f9204(0x233)]({'where':{'userId':_0x263b91}}),_0x454d66=await this[_0x1f9204(0x228)][_0x1f9204(0x233)]({'where':{'userId':_0x263b91}}),_0x1d6773=await this['midjourneyEntity']['count']({'where':{'userId':_0x263b91}});return _0x595df6||_0x454d66||_0x1d6773||0x0;}};UserBalanceService=__decorate([(0x0,common_1[_0x45dbab(0x25f)])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(balance_entity_1['BalanceEntity'])),__param(0x1,(0x0,typeorm_1['InjectRepository'])(userBalance_entity_1['UserBalanceEntity'])),__param(0x2,(0x0,typeorm_1[_0x45dbab(0x226)])(accountLog_entity_1[_0x45dbab(0x248)])),__param(0x3,(0x0,typeorm_1[_0x45dbab(0x226)])(cramiPackage_entity_1[_0x45dbab(0x292)])),__param(0x4,(0x0,typeorm_1[_0x45dbab(0x226)])(config_entity_1[_0x45dbab(0x234)])),__param(0x5,(0x0,typeorm_1[_0x45dbab(0x226)])(user_entity_1[_0x45dbab(0x2a3)])),__param(0x6,(0x0,typeorm_1[_0x45dbab(0x226)])(salesUsers_entity_1[_0x45dbab(0x1fd)])),__param(0x7,(0x0,typeorm_1[_0x45dbab(0x226)])(whiteList_entity_1[_0x45dbab(0x205)])),__param(0x8,(0x0,typeorm_1[_0x45dbab(0x226)])(fingerprint_entity_1[_0x45dbab(0x282)])),__param(0x9,(0x0,typeorm_1['InjectRepository'])(chatGroup_entity_1['ChatGroupEntity'])),__param(0xa,(0x0,typeorm_1['InjectRepository'])(chatLog_entity_1[_0x45dbab(0x23c)])),__param(0xb,(0x0,typeorm_1[_0x45dbab(0x226)])(midjourney_entity_1[_0x45dbab(0x1f8)])),__metadata('design:paramtypes',[typeorm_2['Repository'],typeorm_2[_0x45dbab(0x254)],typeorm_2[_0x45dbab(0x254)],typeorm_2['Repository'],typeorm_2[_0x45dbab(0x254)],typeorm_2['Repository'],typeorm_2[_0x45dbab(0x254)],typeorm_2[_0x45dbab(0x254)],typeorm_2['Repository'],typeorm_2[_0x45dbab(0x254)],typeorm_2[_0x45dbab(0x254)],typeorm_2[_0x45dbab(0x254)],sales_service_1[_0x45dbab(0x25a)],globalConfig_service_1[_0x45dbab(0x207)]])],UserBalanceService),exports['UserBalanceService']=UserBalanceService;