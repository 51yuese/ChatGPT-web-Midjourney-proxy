'use strict';function _0x8f87(){const _0x4f0202=['delete','SUM(order.price)','queryWeChat','defineProperty','total_price','CramiPackageEntity','name','__param','订单不存在!','InjectRepository','DESC','../globalConfig/globalConfig.service','../userBalance/userBalance.service','function','TRADE_CLOSED','syncWeixinOrder','design:paramtypes','price','save','queryAliPay','218620SpRDJs','1620346dpnqav','findOne','getOwnPropertyDescriptor','select','length','set','../../common/utils','883594LbuLgX','addBalanceToOrder','goodsInfo','RedisCacheService','PayService','订单不存在！','object','HttpException','userInfo','syncOrder','where','map','./dto/WxPayStatus.emun','status\x20=\x201','createOrderId','BAD_REQUEST','find','UNAUTHORIZED','goodsId','WxPayStatus','getRawOne','userBalanceService','get','1915808FKcUIc','syncAliOrder','pay','user','9vglRTf','TRADE_FINISHED','globalConfigService','transaction','30215aEJMXG','buy','connection','6yBqXxI','__decorate','GlobalConfigService','deleteOrder','redisCacheService','message','SUCCESS','UserBalanceService','username','query','createQueryBuilder','status','page4self','payService','trade_state','lock','queryAllOrder','create','orderId','@nestjs/common','cancel','__esModule','findAndCount','@nestjs/typeorm','cramiPackageEntity','count','请先注册账号后购买商品！','REVOKED','Injectable','../crami/cramiPackage.entity','metadata','buyInMini','PAY_UPDATE_ORDER','AliPayStatus','Repository','orderEntity','typeorm','del','channel','wechat','payPlatform','order','__metadata','userId','forEach','do\x20','./order.entity','UserEntity','220aFMZth','1021905BwuxWw','decorate','tradeStatus','HttpStatus','PAYERROR','deleteNotPay','userEntity','./../user/user.entity','total','9085430LbUnce'];_0x8f87=function(){return _0x4f0202;};return _0x8f87();}const _0x35d6e1=_0x545a;function _0x545a(_0x274fb6,_0x3db8e9){const _0x8f87db=_0x8f87();return _0x545a=function(_0x545ac0,_0x4c2a33){_0x545ac0=_0x545ac0-0x160;let _0x480fcb=_0x8f87db[_0x545ac0];return _0x480fcb;},_0x545a(_0x274fb6,_0x3db8e9);}(function(_0x51d584,_0x547cc2){const _0x41b30d=_0x545a,_0x1f542f=_0x51d584();while(!![]){try{const _0x22c7f7=-parseInt(_0x41b30d(0x16d))/0x1+-parseInt(_0x41b30d(0x175))/0x2+-parseInt(_0x41b30d(0x1c8))/0x3+-parseInt(_0x41b30d(0x1c7))/0x4*(-parseInt(_0x41b30d(0x194))/0x5)+parseInt(_0x41b30d(0x197))/0x6*(parseInt(_0x41b30d(0x16e))/0x7)+-parseInt(_0x41b30d(0x18c))/0x8+-parseInt(_0x41b30d(0x190))/0x9*(-parseInt(_0x41b30d(0x1d1))/0xa);if(_0x22c7f7===_0x547cc2)break;else _0x1f542f['push'](_0x1f542f['shift']());}catch(_0x30495b){_0x1f542f['push'](_0x1f542f['shift']());}}}(_0x8f87,0x389b2));var __decorate=this&&this[_0x35d6e1(0x198)]||function(_0x3309fe,_0x174eea,_0x2754a3,_0x29b9d7){const _0x34e793=_0x35d6e1;var _0x34260d=arguments[_0x34e793(0x172)],_0x24e9fd=_0x34260d<0x3?_0x174eea:_0x29b9d7===null?_0x29b9d7=Object[_0x34e793(0x170)](_0x174eea,_0x2754a3):_0x29b9d7,_0x32224c;if(typeof Reflect===_0x34e793(0x17b)&&typeof Reflect[_0x34e793(0x1c9)]===_0x34e793(0x166))_0x24e9fd=Reflect[_0x34e793(0x1c9)](_0x3309fe,_0x174eea,_0x2754a3,_0x29b9d7);else{for(var _0x3a745d=_0x3309fe['length']-0x1;_0x3a745d>=0x0;_0x3a745d--)if(_0x32224c=_0x3309fe[_0x3a745d])_0x24e9fd=(_0x34260d<0x3?_0x32224c(_0x24e9fd):_0x34260d>0x3?_0x32224c(_0x174eea,_0x2754a3,_0x24e9fd):_0x32224c(_0x174eea,_0x2754a3))||_0x24e9fd;}return _0x34260d>0x3&&_0x24e9fd&&Object[_0x34e793(0x1d5)](_0x174eea,_0x2754a3,_0x24e9fd),_0x24e9fd;},__metadata=this&&this[_0x35d6e1(0x1c1)]||function(_0x1d1bd8,_0x4bb8d5){const _0x2238cb=_0x35d6e1;if(typeof Reflect===_0x2238cb(0x17b)&&typeof Reflect[_0x2238cb(0x1b5)]===_0x2238cb(0x166))return Reflect[_0x2238cb(0x1b5)](_0x1d1bd8,_0x4bb8d5);},__param=this&&this[_0x35d6e1(0x160)]||function(_0x5de432,_0x359bb0){return function(_0x13c007,_0x324d6e){_0x359bb0(_0x13c007,_0x324d6e,_0x5de432);};};Object[_0x35d6e1(0x1d5)](exports,_0x35d6e1(0x1ac),{'value':!![]}),exports['OrderService']=void 0x0;const user_entity_1=require(_0x35d6e1(0x1cf)),typeorm_1=require(_0x35d6e1(0x1ae)),common_1=require(_0x35d6e1(0x1aa)),typeorm_2=require(_0x35d6e1(0x1bb)),order_entity_1=require(_0x35d6e1(0x1c5)),cramiPackage_entity_1=require(_0x35d6e1(0x1b4)),utils_1=require(_0x35d6e1(0x174)),pay_service_1=require('../pay/pay.service'),globalConfig_service_1=require(_0x35d6e1(0x164)),WxPayStatus_emun_1=require(_0x35d6e1(0x181)),redisKey_constant_1=require('../../common/constants/redisKey.constant'),redisCache_service_1=require('../redisCache/redisCache.service'),userBalance_service_1=require(_0x35d6e1(0x165));let OrderService=class OrderService{constructor(_0x46ee1f,_0x7f275,_0x5bf15d,_0xf88118,_0x1bec49,_0x4b5423,_0x53e699,_0x442889){const _0x1cccb4=_0x35d6e1;this['orderEntity']=_0x46ee1f,this[_0x1cccb4(0x1af)]=_0x7f275,this[_0x1cccb4(0x1ce)]=_0x5bf15d,this[_0x1cccb4(0x1a4)]=_0xf88118,this['globalConfigService']=_0x1bec49,this[_0x1cccb4(0x19b)]=_0x4b5423,this[_0x1cccb4(0x18a)]=_0x53e699,this['connection']=_0x442889;}async[_0x35d6e1(0x195)](_0x3b7f16,_0x234e86){const _0x17cd24=_0x35d6e1;try{const _0x5186f3=_0x234e86['user']['id'],{goodsId:_0x3a3162,count:count=0x1,payType:_0x209270,payPlatform:_0x5405a4}=_0x3b7f16;if(_0x5186f3>0xf4240)throw new common_1[(_0x17cd24(0x17c))](_0x17cd24(0x1b1),common_1[_0x17cd24(0x1cb)][_0x17cd24(0x186)]);const _0x4bd0e8=await this[_0x17cd24(0x1a8)](_0x5186f3,_0x3a3162,count,_0x209270,_0x5405a4),_0x34fa84=await this['payService'][_0x17cd24(0x18e)](_0x5186f3,_0x4bd0e8['orderId'],_0x209270);return{..._0x34fa84,'total':_0x4bd0e8['total'],'orderId':_0x4bd0e8[_0x17cd24(0x1a9)],'platform':_0x4bd0e8['payPlatform']};}catch(_0x480366){if(_0x480366[_0x17cd24(0x1a2)]===0x191)throw new common_1[(_0x17cd24(0x17c))](_0x480366[_0x17cd24(0x19c)],common_1[_0x17cd24(0x1cb)][_0x17cd24(0x186)]);throw new common_1[(_0x17cd24(0x17c))](_0x480366[_0x17cd24(0x19c)]||'购买失败!',common_1[_0x17cd24(0x1cb)][_0x17cd24(0x184)]);}}async[_0x35d6e1(0x1b6)](_0x14062e){const _0x52ff49=_0x35d6e1;try{const {userId:_0x10ceb6,goodsId:_0x42a435,count:count=0x1,payType:_0x15628d,payPlatform:_0x166b0b}=_0x14062e,_0x308385=await this['create'](_0x10ceb6,_0x42a435,count,_0x15628d,_0x166b0b),_0x497339=await this[_0x52ff49(0x1a4)][_0x52ff49(0x18e)](_0x10ceb6,_0x308385[_0x52ff49(0x1a9)],_0x15628d);return{..._0x497339,'orderId':_0x308385[_0x52ff49(0x1a9)]};}catch(_0x14a712){throw new common_1['HttpException'](_0x14a712[_0x52ff49(0x19c)],common_1[_0x52ff49(0x1cb)][_0x52ff49(0x184)]);}}async['queryByOrderId'](_0x2cd672,_0x221c3d){const _0x1ca602=_0x35d6e1,{id:_0x4d0af5}=_0x2cd672['user'],{orderId:_0x458d00}=_0x221c3d;let _0x543643='',_0x46f772=await this[_0x1ca602(0x1ba)][_0x1ca602(0x16f)]({'where':{'userId':_0x4d0af5,'orderId':_0x458d00}});if(_0x46f772['status']===0x0){await this['syncOrder'](_0x46f772),_0x46f772=await this[_0x1ca602(0x1ba)]['findOne']({'where':{'userId':_0x4d0af5,'orderId':_0x458d00}});const _0x32863b=await this[_0x1ca602(0x1af)]['findOne']({'where':{'id':_0x46f772[_0x1ca602(0x187)]}});_0x543643=_0x32863b['name'];}if(!_0x46f772)throw new common_1[(_0x1ca602(0x17c))]('订单不存在!',common_1[_0x1ca602(0x1cb)][_0x1ca602(0x184)]);return{..._0x46f772,'goodsName':_0x543643};}async[_0x35d6e1(0x1a8)](_0x731d20,_0x1c235c,_0x4ff6c0,_0xea603f,_0x5b1270){const _0x4e4454=_0x35d6e1,_0x172c3d=await this[_0x4e4454(0x192)]['queryPayType'](_0x5b1270),_0x3bd633=await this[_0x4e4454(0x1af)][_0x4e4454(0x16f)]({'where':{'id':_0x1c235c}});if(!_0x3bd633)throw new common_1[(_0x4e4454(0x17c))]('套餐不存在!',common_1[_0x4e4454(0x1cb)]['BAD_REQUEST']);const _0x1c108d={};_0x1c108d[_0x4e4454(0x1a9)]=(0x0,utils_1[_0x4e4454(0x183)])(),console['log'](_0x4e4454(0x1c4),_0x1c108d['orderId']),_0x1c108d['userId']=_0x731d20,_0x1c108d[_0x4e4454(0x187)]=_0x1c235c,_0x1c108d['price']=Number(_0x3bd633[_0x4e4454(0x16a)]),_0x1c108d[_0x4e4454(0x1b0)]=_0x4ff6c0,_0x1c108d[_0x4e4454(0x1d0)]=Number(_0x3bd633[_0x4e4454(0x16a)])*_0x4ff6c0,_0x1c108d[_0x4e4454(0x1bf)]=_0x172c3d,_0x1c108d[_0x4e4454(0x1bd)]=_0xea603f;const _0x1d67c5=await this['orderEntity']['save'](_0x1c108d);return _0x1d67c5;}async[_0x35d6e1(0x1ab)](_0x54d935){const _0x5d6cf0=_0x35d6e1;try{const _0x1cc3b4=await this['orderEntity'][_0x5d6cf0(0x16f)]({'where':{'orderId':_0x54d935}});if(!_0x1cc3b4)throw new Error(_0x5d6cf0(0x17a));await this[_0x5d6cf0(0x1a4)][_0x5d6cf0(0x1ab)](_0x1cc3b4);}catch(_0x53f77d){throw new common_1[(_0x5d6cf0(0x17c))](_0x53f77d[_0x5d6cf0(0x19c)],common_1[_0x5d6cf0(0x1cb)][_0x5d6cf0(0x184)]);}}async[_0x35d6e1(0x1a0)](_0x30a0bc,_0x1af544,_0x349e18){const _0x2f33d6=_0x35d6e1;return await this['orderEntity']['findAndCount']({'where':{'userId':_0x30a0bc},'order':{'id':_0x2f33d6(0x163)},'skip':(_0x1af544-0x1)*_0x349e18,'take':_0x349e18});}async['queryAllOrder'](_0x52a5b0){const _0x301591=_0x35d6e1,{page:_0x36e6f4,size:_0x19a5f6,userId:_0x1105a4,platform:_0x4744a7,status:_0x235edc}=_0x52a5b0,_0xd9c441={};if(_0x1105a4)_0xd9c441['userId']=_0x1105a4;if(_0x4744a7)_0xd9c441[_0x301591(0x1bf)]=_0x4744a7;if(_0x235edc)_0xd9c441['status']=_0x235edc;const [_0x3b2f53,_0x42e677]=await this[_0x301591(0x1ba)][_0x301591(0x1ad)]({'order':{'id':'DESC'},'where':_0xd9c441,'skip':(_0x36e6f4-0x1)*_0x19a5f6,'take':_0x19a5f6}),_0x9a08e9=_0x3b2f53['map'](_0x583de8=>_0x583de8['userId']),_0x46f9af=_0x3b2f53[_0x301591(0x180)](_0x69fde9=>_0x69fde9[_0x301591(0x187)]),_0x285cc5=await this['userEntity'][_0x301591(0x185)]({'where':{'id':(0x0,typeorm_2['In'])(_0x9a08e9)},'select':['id',_0x301591(0x19f),'email']}),_0x377e06=await this[_0x301591(0x1af)][_0x301591(0x185)]({'where':{'id':(0x0,typeorm_2['In'])(_0x46f9af)},'select':['id',_0x301591(0x1d8),'coverImg','des']});_0x3b2f53[_0x301591(0x1c3)](_0x3c0d8f=>{const _0x1a57ae=_0x301591;_0x3c0d8f[_0x1a57ae(0x17d)]=_0x285cc5['find'](_0x17350e=>_0x17350e['id']===_0x3c0d8f[_0x1a57ae(0x1c2)]),_0x3c0d8f[_0x1a57ae(0x177)]=_0x377e06[_0x1a57ae(0x185)](_0x5018e1=>_0x5018e1['id']===_0x3c0d8f[_0x1a57ae(0x187)]);});const _0x3c0ce0=await this[_0x301591(0x1ba)][_0x301591(0x1a1)](_0x301591(0x1c0))[_0x301591(0x171)](_0x301591(0x1d3),_0x301591(0x1d6))[_0x301591(0x17f)](_0x301591(0x182))[_0x301591(0x189)]();return{'rows':_0x3b2f53,'count':_0x42e677,..._0x3c0ce0};}[_0x35d6e1(0x1a3)](_0x192826,_0x471de4){const _0x21ad19=_0x35d6e1,{id:_0x19fee4}=_0x471de4[_0x21ad19(0x18f)];return this[_0x21ad19(0x1a7)]({..._0x192826,'userId':_0x19fee4});}async[_0x35d6e1(0x19a)](_0x192990){const _0x28983e=_0x35d6e1,{orderId:_0x13306c}=_0x192990,_0x18ea7c=await this[_0x28983e(0x1ba)][_0x28983e(0x16f)]({'where':{'orderId':_0x13306c}});if(!_0x18ea7c)throw new common_1['HttpException'](_0x28983e(0x161),common_1[_0x28983e(0x1cb)][_0x28983e(0x184)]);return await this[_0x28983e(0x1ba)][_0x28983e(0x1d2)]({'orderId':_0x13306c});}async[_0x35d6e1(0x1cd)](){const _0x1136d7=_0x35d6e1;return await this[_0x1136d7(0x1ba)][_0x1136d7(0x1d2)]({'status':0x0});}async[_0x35d6e1(0x17e)](_0x13a77c){const _0x2f591e=_0x35d6e1;if(_0x13a77c['payPlatform']==='alipay')return this[_0x2f591e(0x18d)](_0x13a77c);if(_0x13a77c[_0x2f591e(0x1bf)]===_0x2f591e(0x1be))return this[_0x2f591e(0x168)](_0x13a77c);}async[_0x35d6e1(0x18d)](_0x573061){const _0x1f5f59=_0x35d6e1,_0x266014=redisKey_constant_1[_0x1f5f59(0x1b7)]+_0x573061['orderId'],_0x596131=await this[_0x1f5f59(0x19b)][_0x1f5f59(0x18b)]({'key':_0x266014});if(_0x596131)return;this['redisCacheService'][_0x1f5f59(0x173)]({'key':_0x266014,'val':'lock'});const _0x8adb69=_0x573061[_0x1f5f59(0x1bd)],_0x406c1e=await this[_0x1f5f59(0x1a4)][_0x1f5f59(0x16c)](_0x573061[_0x1f5f59(0x1a9)],_0x8adb69);switch(_0x406c1e[_0x1f5f59(0x1ca)]){case WxPayStatus_emun_1[_0x1f5f59(0x1b8)]['TRADE_SUCCESS']:case WxPayStatus_emun_1['AliPayStatus'][_0x1f5f59(0x191)]:{_0x573061['status']=0x1,await this[_0x1f5f59(0x196)][_0x1f5f59(0x193)](async _0x446a7a=>{const _0x5c8669=_0x1f5f59;await this[_0x5c8669(0x1ba)]['save'](_0x573061),await this['userBalanceService']['addBalanceToOrder'](_0x573061);});break;}case WxPayStatus_emun_1['AliPayStatus'][_0x1f5f59(0x167)]:{_0x573061['status']=0x2,await this[_0x1f5f59(0x1ba)][_0x1f5f59(0x16b)](_0x573061);break;}default:{}}return this[_0x1f5f59(0x19b)][_0x1f5f59(0x1bc)]({'key':_0x266014}),_0x573061;}async[_0x35d6e1(0x168)](_0x3cc7e5){const _0x5e3161=_0x35d6e1,_0x139cfd=redisKey_constant_1[_0x5e3161(0x1b7)]+_0x3cc7e5[_0x5e3161(0x1a9)],_0x10d114=await this[_0x5e3161(0x19b)][_0x5e3161(0x18b)]({'key':_0x139cfd});if(_0x10d114)return;this['redisCacheService']['set']({'key':_0x139cfd,'val':_0x5e3161(0x1a6)});const _0x15023e=_0x3cc7e5['channel'],_0x5210da=await this[_0x5e3161(0x1a4)][_0x5e3161(0x1d4)](_0x3cc7e5[_0x5e3161(0x1a9)],_0x15023e);switch(_0x5210da[_0x5e3161(0x1a5)]){case WxPayStatus_emun_1[_0x5e3161(0x188)][_0x5e3161(0x19d)]:{_0x3cc7e5[_0x5e3161(0x1a2)]=0x1,await this[_0x5e3161(0x196)][_0x5e3161(0x193)](async _0x38828e=>{const _0x4df85f=_0x5e3161;await this[_0x4df85f(0x1ba)][_0x4df85f(0x16b)](_0x3cc7e5),await this[_0x4df85f(0x18a)][_0x4df85f(0x176)](_0x3cc7e5);});break;}case WxPayStatus_emun_1['WxPayStatus']['CLOSED']:case WxPayStatus_emun_1['WxPayStatus'][_0x5e3161(0x1b2)]:case WxPayStatus_emun_1[_0x5e3161(0x188)][_0x5e3161(0x1cc)]:{_0x3cc7e5[_0x5e3161(0x1a2)]=0x2,await this['orderEntity']['save'](_0x3cc7e5);break;}default:{}}return this['redisCacheService'][_0x5e3161(0x1bc)]({'key':_0x139cfd}),_0x3cc7e5;}};OrderService=__decorate([(0x0,common_1[_0x35d6e1(0x1b3)])(),__param(0x0,(0x0,typeorm_1[_0x35d6e1(0x162)])(order_entity_1['OrderEntity'])),__param(0x1,(0x0,typeorm_1[_0x35d6e1(0x162)])(cramiPackage_entity_1[_0x35d6e1(0x1d7)])),__param(0x2,(0x0,typeorm_1['InjectRepository'])(user_entity_1[_0x35d6e1(0x1c6)])),__metadata(_0x35d6e1(0x169),[typeorm_2['Repository'],typeorm_2['Repository'],typeorm_2[_0x35d6e1(0x1b9)],pay_service_1[_0x35d6e1(0x179)],globalConfig_service_1[_0x35d6e1(0x199)],redisCache_service_1[_0x35d6e1(0x178)],userBalance_service_1[_0x35d6e1(0x19e)],typeorm_2['Connection']])],OrderService),exports['OrderService']=OrderService;