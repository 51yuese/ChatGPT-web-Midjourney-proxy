'use strict';const _0x3995cc=_0x56d3;function _0x56d3(_0x1fa31f,_0x182e50){const _0x3b6ce8=_0x3b6c();return _0x56d3=function(_0x56d363,_0x1b039d){_0x56d363=_0x56d363-0x1d1;let _0x8638a5=_0x3b6ce8[_0x56d363];return _0x8638a5;},_0x56d3(_0x1fa31f,_0x182e50);}(function(_0x51c9ab,_0x51b8d7){const _0x115143=_0x56d3,_0x20ef09=_0x51c9ab();while(!![]){try{const _0x367bb4=parseInt(_0x115143(0x21d))/0x1*(-parseInt(_0x115143(0x1fd))/0x2)+-parseInt(_0x115143(0x239))/0x3*(parseInt(_0x115143(0x23d))/0x4)+parseInt(_0x115143(0x218))/0x5*(parseInt(_0x115143(0x23a))/0x6)+-parseInt(_0x115143(0x1d9))/0x7*(-parseInt(_0x115143(0x216))/0x8)+parseInt(_0x115143(0x22f))/0x9+parseInt(_0x115143(0x229))/0xa*(parseInt(_0x115143(0x1ec))/0xb)+parseInt(_0x115143(0x224))/0xc*(-parseInt(_0x115143(0x210))/0xd);if(_0x367bb4===_0x51b8d7)break;else _0x20ef09['push'](_0x20ef09['shift']());}catch(_0x2ca41f){_0x20ef09['push'](_0x20ef09['shift']());}}}(_0x3b6c,0x2162b));var __decorate=this&&this[_0x3995cc(0x1e8)]||function(_0x43be97,_0x2ab102,_0x3b7159,_0x4eb515){const _0x1af2d1=_0x3995cc;var _0x18047c=arguments[_0x1af2d1(0x240)],_0x4e75c3=_0x18047c<0x3?_0x2ab102:_0x4eb515===null?_0x4eb515=Object[_0x1af2d1(0x222)](_0x2ab102,_0x3b7159):_0x4eb515,_0x208fac;if(typeof Reflect===_0x1af2d1(0x1dd)&&typeof Reflect[_0x1af2d1(0x212)]===_0x1af2d1(0x1e0))_0x4e75c3=Reflect[_0x1af2d1(0x212)](_0x43be97,_0x2ab102,_0x3b7159,_0x4eb515);else{for(var _0x363aea=_0x43be97[_0x1af2d1(0x240)]-0x1;_0x363aea>=0x0;_0x363aea--)if(_0x208fac=_0x43be97[_0x363aea])_0x4e75c3=(_0x18047c<0x3?_0x208fac(_0x4e75c3):_0x18047c>0x3?_0x208fac(_0x2ab102,_0x3b7159,_0x4e75c3):_0x208fac(_0x2ab102,_0x3b7159))||_0x4e75c3;}return _0x18047c>0x3&&_0x4e75c3&&Object[_0x1af2d1(0x247)](_0x2ab102,_0x3b7159,_0x4e75c3),_0x4e75c3;},__metadata=this&&this[_0x3995cc(0x203)]||function(_0x16b69e,_0x3e4369){const _0x10cd5b=_0x3995cc;if(typeof Reflect===_0x10cd5b(0x1dd)&&typeof Reflect[_0x10cd5b(0x1f0)]===_0x10cd5b(0x1e0))return Reflect[_0x10cd5b(0x1f0)](_0x16b69e,_0x3e4369);},__param=this&&this[_0x3995cc(0x1de)]||function(_0x4203f6,_0x5233f4){return function(_0x33705d,_0xacb422){_0x5233f4(_0x33705d,_0xacb422,_0x4203f6);};};Object[_0x3995cc(0x247)](exports,'__esModule',{'value':!![]}),exports['OrderService']=void 0x0;const user_entity_1=require(_0x3995cc(0x1f2)),typeorm_1=require(_0x3995cc(0x1ef)),common_1=require('@nestjs/common'),typeorm_2=require(_0x3995cc(0x20c)),order_entity_1=require(_0x3995cc(0x1ee)),cramiPackage_entity_1=require(_0x3995cc(0x1da)),utils_1=require('../../common/utils'),pay_service_1=require(_0x3995cc(0x1e1)),globalConfig_service_1=require(_0x3995cc(0x1d6)),WxPayStatus_emun_1=require(_0x3995cc(0x246)),redisKey_constant_1=require(_0x3995cc(0x215)),redisCache_service_1=require(_0x3995cc(0x1ea)),userBalance_service_1=require('../userBalance/userBalance.service');function _0x3b6c(){const _0x4363ab=['userBalanceService','object','__param','RedisCacheService','function','../pay/pay.service','Repository','订单不存在！','Injectable','price','addBalanceToOrder','map','__decorate','create','../redisCache/redisCache.service','do\x20','11aFdpfP','queryByOrderId','./order.entity','@nestjs/typeorm','metadata','AliPayStatus','./../user/user.entity','SUM(order.price)','SUCCESS','message','redisCacheService','cancel','order','deleteOrder','connection','queryAllOrder','HttpException','952OntsTd','UNAUTHORIZED','goodsInfo','status\x20=\x201','find','createOrderId','__metadata','design:paramtypes','delete','name','OrderService','userInfo','userEntity','orderEntity','pay','typeorm','select','CLOSED','getRawOne','2349633NeLhdE','购买失败!','decorate','log','createQueryBuilder','../../common/constants/redisKey.constant','131496ejPHZe','deleteNotPay','10MzWXyJ','des','where','status','forEach','553IIVxLe','TRADE_SUCCESS','findAndCount','goodsId','GlobalConfigService','getOwnPropertyDescriptor','queryPayType','12HgPgqE','WxPayStatus','page4self','alipay','UserEntity','1135010GDMsAD','BAD_REQUEST','syncOrder','total','get','InjectRepository','1857474snpuMt','cramiPackageEntity','total_price','syncAliOrder','findOne','set','TRADE_CLOSED','buy','save','userId','3QHnAcb','731118leLdpJ','count','lock','63004QGtKiq','HttpStatus','transaction','length','payPlatform','payService','channel','tradeStatus','del','./dto/WxPayStatus.emun','defineProperty','syncWeixinOrder','PAY_UPDATE_ORDER','queryWeChat','套餐不存在!','orderId','../globalConfig/globalConfig.service','REVOKED','username','14xjwnwJ','../crami/cramiPackage.entity','PayService'];_0x3b6c=function(){return _0x4363ab;};return _0x3b6c();}let OrderService=class OrderService{constructor(_0x316b3e,_0x3b3230,_0x3f5be4,_0x5480a0,_0x282f8f,_0x2ec100,_0x553af7,_0x4503d3){const _0x4a2b6b=_0x3995cc;this[_0x4a2b6b(0x20a)]=_0x316b3e,this[_0x4a2b6b(0x230)]=_0x3b3230,this[_0x4a2b6b(0x209)]=_0x3f5be4,this[_0x4a2b6b(0x242)]=_0x5480a0,this['globalConfigService']=_0x282f8f,this['redisCacheService']=_0x2ec100,this[_0x4a2b6b(0x1dc)]=_0x553af7,this['connection']=_0x4503d3;}async[_0x3995cc(0x236)](_0x2192ae,_0x4e823c){const _0xe521bf=_0x3995cc;try{const _0x567d14=_0x4e823c['user']['id'],{goodsId:_0x858091,count:count=0x1,payType:_0x21650e,payPlatform:_0x80704e}=_0x2192ae;if(_0x567d14>0xf4240)throw new common_1[(_0xe521bf(0x1fc))]('请先注册账号后购买商品！',common_1[_0xe521bf(0x23e)][_0xe521bf(0x1fe)]);const _0xb5140=await this['create'](_0x567d14,_0x858091,count,_0x21650e,_0x80704e),_0xa2476d=await this[_0xe521bf(0x242)][_0xe521bf(0x20b)](_0x567d14,_0xb5140['orderId'],_0x21650e);return{..._0xa2476d,'total':_0xb5140[_0xe521bf(0x22c)],'orderId':_0xb5140[_0xe521bf(0x1d5)],'platform':_0xb5140[_0xe521bf(0x241)]};}catch(_0x5d52fb){if(_0x5d52fb[_0xe521bf(0x21b)]===0x191)throw new common_1[(_0xe521bf(0x1fc))](_0x5d52fb[_0xe521bf(0x1f5)],common_1[_0xe521bf(0x23e)][_0xe521bf(0x1fe)]);throw new common_1[(_0xe521bf(0x1fc))](_0x5d52fb[_0xe521bf(0x1f5)]||_0xe521bf(0x211),common_1[_0xe521bf(0x23e)][_0xe521bf(0x22a)]);}}async['buyInMini'](_0x1bf05f){const _0x5d5cbd=_0x3995cc;try{const {userId:_0x254585,goodsId:_0x23ded5,count:count=0x1,payType:_0x1bf4c5,payPlatform:_0x4568c6}=_0x1bf05f,_0x1c78b5=await this[_0x5d5cbd(0x1e9)](_0x254585,_0x23ded5,count,_0x1bf4c5,_0x4568c6),_0x3e9c97=await this['payService'][_0x5d5cbd(0x20b)](_0x254585,_0x1c78b5[_0x5d5cbd(0x1d5)],_0x1bf4c5);return{..._0x3e9c97,'orderId':_0x1c78b5['orderId']};}catch(_0x3e9212){throw new common_1[(_0x5d5cbd(0x1fc))](_0x3e9212[_0x5d5cbd(0x1f5)],common_1[_0x5d5cbd(0x23e)][_0x5d5cbd(0x22a)]);}}async[_0x3995cc(0x1ed)](_0x575e58,_0x88b801){const _0x56be1d=_0x3995cc,{id:_0x3d359b}=_0x575e58['user'],{orderId:_0x13d953}=_0x88b801;let _0x1a3698='',_0x1299bd=await this[_0x56be1d(0x20a)]['findOne']({'where':{'userId':_0x3d359b,'orderId':_0x13d953}});if(_0x1299bd[_0x56be1d(0x21b)]===0x0){await this[_0x56be1d(0x22b)](_0x1299bd),_0x1299bd=await this['orderEntity'][_0x56be1d(0x233)]({'where':{'userId':_0x3d359b,'orderId':_0x13d953}});const _0x404b51=await this[_0x56be1d(0x230)]['findOne']({'where':{'id':_0x1299bd[_0x56be1d(0x220)]}});_0x1a3698=_0x404b51[_0x56be1d(0x206)];}if(!_0x1299bd)throw new common_1[(_0x56be1d(0x1fc))]('订单不存在!',common_1[_0x56be1d(0x23e)][_0x56be1d(0x22a)]);return{..._0x1299bd,'goodsName':_0x1a3698};}async[_0x3995cc(0x1e9)](_0x23dda3,_0x3197f7,_0x151171,_0x255c64,_0x5a7cb7){const _0x7a26=_0x3995cc,_0x421fcc=await this['globalConfigService'][_0x7a26(0x223)](_0x5a7cb7),_0x610e13=await this['cramiPackageEntity'][_0x7a26(0x233)]({'where':{'id':_0x3197f7}});if(!_0x610e13)throw new common_1[(_0x7a26(0x1fc))](_0x7a26(0x1d4),common_1[_0x7a26(0x23e)][_0x7a26(0x22a)]);const _0x75a3c={};_0x75a3c[_0x7a26(0x1d5)]=(0x0,utils_1[_0x7a26(0x202)])(),console[_0x7a26(0x213)](_0x7a26(0x1eb),_0x75a3c[_0x7a26(0x1d5)]),_0x75a3c['userId']=_0x23dda3,_0x75a3c[_0x7a26(0x220)]=_0x3197f7,_0x75a3c['price']=Number(_0x610e13[_0x7a26(0x1e5)]),_0x75a3c[_0x7a26(0x23b)]=_0x151171,_0x75a3c[_0x7a26(0x22c)]=Number(_0x610e13[_0x7a26(0x1e5)])*_0x151171,_0x75a3c['payPlatform']=_0x421fcc,_0x75a3c[_0x7a26(0x243)]=_0x255c64;const _0x813544=await this['orderEntity'][_0x7a26(0x237)](_0x75a3c);return _0x813544;}async[_0x3995cc(0x1f7)](_0x1c1f53){const _0x1e70f0=_0x3995cc;try{const _0x37cd1f=await this['orderEntity'][_0x1e70f0(0x233)]({'where':{'orderId':_0x1c1f53}});if(!_0x37cd1f)throw new Error(_0x1e70f0(0x1e3));await this['payService'][_0x1e70f0(0x1f7)](_0x37cd1f);}catch(_0xc983){throw new common_1[(_0x1e70f0(0x1fc))](_0xc983[_0x1e70f0(0x1f5)],common_1['HttpStatus'][_0x1e70f0(0x22a)]);}}async['query'](_0x1753cf,_0x5643b3,_0x2794c4){const _0xf9d641=_0x3995cc;return await this[_0xf9d641(0x20a)]['findAndCount']({'where':{'userId':_0x1753cf},'order':{'id':'DESC'},'skip':(_0x5643b3-0x1)*_0x2794c4,'take':_0x2794c4});}async['queryAllOrder'](_0x4758fd){const _0x2a4270=_0x3995cc,{page:_0x22fecc,size:_0x11d9e0,userId:_0x430254,platform:_0x4e2f25,status:_0x1b22c5}=_0x4758fd,_0x4cb42b={};if(_0x430254)_0x4cb42b[_0x2a4270(0x238)]=_0x430254;if(_0x4e2f25)_0x4cb42b[_0x2a4270(0x241)]=_0x4e2f25;if(_0x1b22c5)_0x4cb42b[_0x2a4270(0x21b)]=_0x1b22c5;const [_0x4a3044,_0xb51fd7]=await this[_0x2a4270(0x20a)][_0x2a4270(0x21f)]({'order':{'id':'DESC'},'where':_0x4cb42b,'skip':(_0x22fecc-0x1)*_0x11d9e0,'take':_0x11d9e0}),_0x317784=_0x4a3044[_0x2a4270(0x1e7)](_0x422580=>_0x422580[_0x2a4270(0x238)]),_0x63962=_0x4a3044[_0x2a4270(0x1e7)](_0x574934=>_0x574934[_0x2a4270(0x220)]),_0x25020c=await this['userEntity'][_0x2a4270(0x201)]({'where':{'id':(0x0,typeorm_2['In'])(_0x317784)},'select':['id',_0x2a4270(0x1d8),'email']}),_0x2432b8=await this['cramiPackageEntity'][_0x2a4270(0x201)]({'where':{'id':(0x0,typeorm_2['In'])(_0x63962)},'select':['id',_0x2a4270(0x206),'coverImg',_0x2a4270(0x219)]});_0x4a3044[_0x2a4270(0x21c)](_0x200fb9=>{const _0x1750be=_0x2a4270;_0x200fb9[_0x1750be(0x208)]=_0x25020c[_0x1750be(0x201)](_0x78b69=>_0x78b69['id']===_0x200fb9['userId']),_0x200fb9[_0x1750be(0x1ff)]=_0x2432b8[_0x1750be(0x201)](_0x4b4ab4=>_0x4b4ab4['id']===_0x200fb9[_0x1750be(0x220)]);});const _0x2e21cd=await this['orderEntity'][_0x2a4270(0x214)](_0x2a4270(0x1f8))[_0x2a4270(0x20d)](_0x2a4270(0x1f3),_0x2a4270(0x231))[_0x2a4270(0x21a)](_0x2a4270(0x200))[_0x2a4270(0x20f)]();return{'rows':_0x4a3044,'count':_0xb51fd7,..._0x2e21cd};}[_0x3995cc(0x226)](_0x4ed42c,_0x4ab7dd){const _0x5cc3bd=_0x3995cc,{id:_0x57063a}=_0x4ab7dd['user'];return this[_0x5cc3bd(0x1fb)]({..._0x4ed42c,'userId':_0x57063a});}async[_0x3995cc(0x1f9)](_0x27da23){const _0x4cdc15=_0x3995cc,{orderId:_0x24f56c}=_0x27da23,_0x2089f7=await this[_0x4cdc15(0x20a)][_0x4cdc15(0x233)]({'where':{'orderId':_0x24f56c}});if(!_0x2089f7)throw new common_1['HttpException']('订单不存在!',common_1['HttpStatus'][_0x4cdc15(0x22a)]);return await this['orderEntity']['delete']({'orderId':_0x24f56c});}async[_0x3995cc(0x217)](){const _0x31a4bc=_0x3995cc;return await this[_0x31a4bc(0x20a)][_0x31a4bc(0x205)]({'status':0x0});}async[_0x3995cc(0x22b)](_0x36a4ec){const _0x59dd45=_0x3995cc;if(_0x36a4ec[_0x59dd45(0x241)]===_0x59dd45(0x227))return this[_0x59dd45(0x232)](_0x36a4ec);if(_0x36a4ec[_0x59dd45(0x241)]==='wechat')return this['syncWeixinOrder'](_0x36a4ec);}async[_0x3995cc(0x232)](_0x5c94c8){const _0x1f7e64=_0x3995cc,_0x64115f=redisKey_constant_1[_0x1f7e64(0x1d2)]+_0x5c94c8[_0x1f7e64(0x1d5)],_0x18ab8e=await this[_0x1f7e64(0x1f6)][_0x1f7e64(0x22d)]({'key':_0x64115f});if(_0x18ab8e)return;this[_0x1f7e64(0x1f6)][_0x1f7e64(0x234)]({'key':_0x64115f,'val':_0x1f7e64(0x23c)});const _0x677489=_0x5c94c8[_0x1f7e64(0x243)],_0x45dd94=await this['payService']['queryAliPay'](_0x5c94c8['orderId'],_0x677489);switch(_0x45dd94[_0x1f7e64(0x244)]){case WxPayStatus_emun_1[_0x1f7e64(0x1f1)][_0x1f7e64(0x21e)]:case WxPayStatus_emun_1[_0x1f7e64(0x1f1)]['TRADE_FINISHED']:{_0x5c94c8[_0x1f7e64(0x21b)]=0x1,await this['connection']['transaction'](async _0x441b5f=>{const _0x2f1010=_0x1f7e64;await this[_0x2f1010(0x20a)][_0x2f1010(0x237)](_0x5c94c8),await this[_0x2f1010(0x1dc)][_0x2f1010(0x1e6)](_0x5c94c8);});break;}case WxPayStatus_emun_1[_0x1f7e64(0x1f1)][_0x1f7e64(0x235)]:{_0x5c94c8[_0x1f7e64(0x21b)]=0x2,await this['orderEntity']['save'](_0x5c94c8);break;}default:{}}return this['redisCacheService'][_0x1f7e64(0x245)]({'key':_0x64115f}),_0x5c94c8;}async[_0x3995cc(0x1d1)](_0x5327c5){const _0x1f4b08=_0x3995cc,_0x3602d2=redisKey_constant_1[_0x1f4b08(0x1d2)]+_0x5327c5[_0x1f4b08(0x1d5)],_0x16a9a9=await this[_0x1f4b08(0x1f6)]['get']({'key':_0x3602d2});if(_0x16a9a9)return;this[_0x1f4b08(0x1f6)][_0x1f4b08(0x234)]({'key':_0x3602d2,'val':_0x1f4b08(0x23c)});const _0x3ce858=_0x5327c5[_0x1f4b08(0x243)],_0x5bd5d9=await this[_0x1f4b08(0x242)][_0x1f4b08(0x1d3)](_0x5327c5[_0x1f4b08(0x1d5)],_0x3ce858);switch(_0x5bd5d9['trade_state']){case WxPayStatus_emun_1[_0x1f4b08(0x225)][_0x1f4b08(0x1f4)]:{_0x5327c5['status']=0x1,await this[_0x1f4b08(0x1fa)][_0x1f4b08(0x23f)](async _0x416ad1=>{const _0x4513cc=_0x1f4b08;await this[_0x4513cc(0x20a)][_0x4513cc(0x237)](_0x5327c5),await this['userBalanceService'][_0x4513cc(0x1e6)](_0x5327c5);});break;}case WxPayStatus_emun_1['WxPayStatus'][_0x1f4b08(0x20e)]:case WxPayStatus_emun_1[_0x1f4b08(0x225)][_0x1f4b08(0x1d7)]:case WxPayStatus_emun_1['WxPayStatus']['PAYERROR']:{_0x5327c5[_0x1f4b08(0x21b)]=0x2,await this['orderEntity'][_0x1f4b08(0x237)](_0x5327c5);break;}default:{}}return this[_0x1f4b08(0x1f6)]['del']({'key':_0x3602d2}),_0x5327c5;}};OrderService=__decorate([(0x0,common_1[_0x3995cc(0x1e4)])(),__param(0x0,(0x0,typeorm_1[_0x3995cc(0x22e)])(order_entity_1['OrderEntity'])),__param(0x1,(0x0,typeorm_1['InjectRepository'])(cramiPackage_entity_1['CramiPackageEntity'])),__param(0x2,(0x0,typeorm_1[_0x3995cc(0x22e)])(user_entity_1[_0x3995cc(0x228)])),__metadata(_0x3995cc(0x204),[typeorm_2[_0x3995cc(0x1e2)],typeorm_2[_0x3995cc(0x1e2)],typeorm_2[_0x3995cc(0x1e2)],pay_service_1[_0x3995cc(0x1db)],globalConfig_service_1[_0x3995cc(0x221)],redisCache_service_1[_0x3995cc(0x1df)],userBalance_service_1['UserBalanceService'],typeorm_2['Connection']])],OrderService),exports[_0x3995cc(0x207)]=OrderService;