'use strict';const _0x21405e=_0x2384;(function(_0x22a148,_0x1ac6d7){const _0x185968=_0x2384,_0x428854=_0x22a148();while(!![]){try{const _0xf91fcc=parseInt(_0x185968(0xc0))/0x1*(-parseInt(_0x185968(0x165))/0x2)+-parseInt(_0x185968(0x174))/0x3*(parseInt(_0x185968(0x1da))/0x4)+-parseInt(_0x185968(0xf8))/0x5*(-parseInt(_0x185968(0xd0))/0x6)+-parseInt(_0x185968(0xb6))/0x7*(parseInt(_0x185968(0x15e))/0x8)+parseInt(_0x185968(0x18f))/0x9+-parseInt(_0x185968(0x182))/0xa+parseInt(_0x185968(0x21c))/0xb*(parseInt(_0x185968(0x202))/0xc);if(_0xf91fcc===_0x1ac6d7)break;else _0x428854['push'](_0x428854['shift']());}catch(_0x4a95b0){_0x428854['push'](_0x428854['shift']());}}}(_0x32b7,0x99fb0));function _0x2384(_0x273a81,_0x11f0db){const _0x32b76f=_0x32b7();return _0x2384=function(_0x23847a,_0x536df6){_0x23847a=_0x23847a-0x8e;let _0x161af8=_0x32b76f[_0x23847a];return _0x161af8;},_0x2384(_0x273a81,_0x11f0db);}var __decorate=this&&this['__decorate']||function(_0x50ae48,_0xc2cef9,_0x4637fb,_0x54a151){const _0x380e56=_0x2384;var _0x5dd6e3=arguments[_0x380e56(0x170)],_0x44edd5=_0x5dd6e3<0x3?_0xc2cef9:_0x54a151===null?_0x54a151=Object[_0x380e56(0xcc)](_0xc2cef9,_0x4637fb):_0x54a151,_0x4ec85d;if(typeof Reflect===_0x380e56(0x1c8)&&typeof Reflect[_0x380e56(0x1e4)]===_0x380e56(0x192))_0x44edd5=Reflect[_0x380e56(0x1e4)](_0x50ae48,_0xc2cef9,_0x4637fb,_0x54a151);else{for(var _0x3b2670=_0x50ae48[_0x380e56(0x170)]-0x1;_0x3b2670>=0x0;_0x3b2670--)if(_0x4ec85d=_0x50ae48[_0x3b2670])_0x44edd5=(_0x5dd6e3<0x3?_0x4ec85d(_0x44edd5):_0x5dd6e3>0x3?_0x4ec85d(_0xc2cef9,_0x4637fb,_0x44edd5):_0x4ec85d(_0xc2cef9,_0x4637fb))||_0x44edd5;}return _0x5dd6e3>0x3&&_0x44edd5&&Object[_0x380e56(0x17a)](_0xc2cef9,_0x4637fb,_0x44edd5),_0x44edd5;},__metadata=this&&this[_0x21405e(0x16c)]||function(_0x4e287e,_0xb5c057){const _0xbfa1=_0x21405e;if(typeof Reflect==='object'&&typeof Reflect[_0xbfa1(0x1b1)]==='function')return Reflect[_0xbfa1(0x1b1)](_0x4e287e,_0xb5c057);},__param=this&&this[_0x21405e(0x12e)]||function(_0x55d2f0,_0xb069d8){return function(_0x1e80be,_0x327b9d){_0xb069d8(_0x1e80be,_0x327b9d,_0x55d2f0);};};Object[_0x21405e(0x17a)](exports,'__esModule',{'value':!![]}),exports[_0x21405e(0x1ff)]=void 0x0;const upload_service_1=require(_0x21405e(0x203)),user_service_1=require(_0x21405e(0x12c)),openai_1=require(_0x21405e(0x1d7)),common_1=require(_0x21405e(0xa4)),FormData=require(_0x21405e(0x19d)),errorMessage_constant_1=require('../../common/constants/errorMessage.constant'),utils_1=require(_0x21405e(0x8f)),axios_1=require(_0x21405e(0x116)),userBalance_service_1=require(_0x21405e(0xbe)),balance_constant_1=require(_0x21405e(0x1f4)),chatLog_service_1=require(_0x21405e(0xf2)),uuid=require(_0x21405e(0x12b)),fs_1=require('fs'),typeorm_1=require(_0x21405e(0x8e)),typeorm_2=require('@nestjs/typeorm'),badwords_service_1=require('../badwords/badwords.service'),autoreply_service_1=require(_0x21405e(0x212)),gptKeys_entity_1=require(_0x21405e(0x136)),globalConfig_service_1=require('../globalConfig/globalConfig.service'),whiteList_entity_1=require(_0x21405e(0xab)),user_entity_1=require('../user/user.entity'),dayjs=require('dayjs'),app_entity_1=require(_0x21405e(0x95)),chatGroup_service_1=require(_0x21405e(0xe4)),models_service_1=require('../models/models.service'),baidu_1=require(_0x21405e(0xa8)),helper_1=require(_0x21405e(0x9c)),store_1=require('./store'),zhipu_1=require(_0x21405e(0x153)),spark_1=require(_0x21405e(0x190)),model_constant_1=require(_0x21405e(0x1bb)),fs_2=require('fs'),path_1=require(_0x21405e(0xa1)),COS=require('cos-nodejs-sdk-v5'),gpts_service_1=require('../gpts/gpts.service'),aiAgreeLog_entity_1=require(_0x21405e(0x193)),chatLog_entity_1=require(_0x21405e(0x18e)),jwt=require(_0x21405e(0xc7));let ChatgptService=class ChatgptService{constructor(_0x2d925e,_0x413cdf,_0x97163f,_0x555b3a,_0x2073c5,_0x7e2eb4,_0x1c9aaf,_0x42d711,_0x361d4f,_0x148c30,_0x3e10da,_0x206486,_0x4a1ced,_0x488dd6,_0x1d89bb,_0x6cdca4,_0x15b915){const _0x41ba52=_0x21405e;this[_0x41ba52(0xba)]=_0x2d925e,this[_0x41ba52(0x1b4)]=_0x413cdf,this['whiteListEntity']=_0x97163f,this[_0x41ba52(0x188)]=_0x555b3a,this[_0x41ba52(0x1a7)]=_0x2073c5,this[_0x41ba52(0xea)]=_0x7e2eb4,this['userBalanceService']=_0x1c9aaf,this[_0x41ba52(0xb3)]=_0x42d711,this[_0x41ba52(0xe9)]=_0x361d4f,this['uploadService']=_0x148c30,this[_0x41ba52(0x200)]=_0x3e10da,this[_0x41ba52(0x1b6)]=_0x206486,this[_0x41ba52(0x160)]=_0x4a1ced,this[_0x41ba52(0x137)]=_0x488dd6,this['modelsService']=_0x1d89bb,this['gptsService']=_0x6cdca4,this[_0x41ba52(0x18c)]=_0x15b915,this[_0x41ba52(0x1b9)]=_0x41ba52(0xdc),this['gomaxAiStore']=null,this['keyPool']={'list3':[],'list4':[]},this[_0x41ba52(0xdb)]=_0x677d65=>{const _0x567ff2=_0x41ba52;return fs_1[_0x567ff2(0x1d8)][_0x567ff2(0x146)](_0x677d65,_0x4e9925=>{const _0xd7e43d=_0x567ff2;_0x4e9925?console[_0xd7e43d(0xf3)](_0xd7e43d(0xe6),_0x4e9925):console[_0xd7e43d(0xf3)]('remove\x20file\x20%s\x20success',_0x677d65);});};}async[_0x21405e(0x14f)](){const _0x4b63fe=_0x21405e;let _0x6cf814=await(0x0,utils_1['importDynamic'])(_0x4b63fe(0x100)),_0x1a8f38=await(0x0,utils_1[_0x4b63fe(0x132)])(_0x4b63fe(0xf4)),_0x560698=await(0x0,utils_1[_0x4b63fe(0x132)])(_0x4b63fe(0x1d5));_0x6cf814=_0x6cf814?.[_0x4b63fe(0x1d8)]?_0x6cf814[_0x4b63fe(0x1d8)]:_0x6cf814,_0x1a8f38=_0x1a8f38?.['default']?_0x1a8f38[_0x4b63fe(0x1d8)]:_0x1a8f38,_0x560698=_0x560698?.[_0x4b63fe(0x1d8)]?_0x560698['default']:_0x560698;const {ChatGPTAPI:_0x5d2cd1,ChatGPTError:_0x331d11,ChatGPTUnofficialProxyAPI:_0x23fb53}=_0x6cf814,_0xb6f517=+process[_0x4b63fe(0xb0)][_0x4b63fe(0xf1)],_0x24631c=process['env'][_0x4b63fe(0xd7)],_0x1a6f0=process[_0x4b63fe(0xb0)][_0x4b63fe(0x15f)],_0x59d22c=process[_0x4b63fe(0xb0)][_0x4b63fe(0x1cd)],_0x2c12d1=_0x4b63fe(0x194)+(_0x59d22c||'')+':'+(_0x1a6f0||'')+'@'+_0x24631c+':'+_0xb6f517,_0x5e3ed0=new _0x1a8f38(_0x2c12d1),_0x466c20=new _0x560698({'store':_0x5e3ed0,'namespace':_0x4b63fe(0x1cb)});this['gomaxAiStore']=new store_1[(_0x4b63fe(0x1bf))]({'store':_0x466c20,'namespace':_0x4b63fe(0x154)}),this[_0x4b63fe(0x181)]=new _0x5d2cd1({'apiKey':'gomaxai-default-key','apiBaseUrl':this[_0x4b63fe(0x1b9)]+_0x4b63fe(0x130),'messageStore':_0x466c20}),!this['openAi']&&this[_0x4b63fe(0x131)](),await this[_0x4b63fe(0x164)](!![]);}[_0x21405e(0x131)](){const _0x4b7334=_0x21405e;this['openAi']=new openai_1[(_0x4b7334(0x1d8))]({'apiKey':_0x4b7334(0x145),'baseURL':this['defaultBaseUrl']+'/v1'});}async['getTencentCOSStorage'](_0x24c26c=![]){const _0x4911a3=_0x21405e,{cosSecretId:_0x113049,cosSecretKey:_0x22fa2c}=await this[_0x4911a3(0x160)][_0x4911a3(0x198)]([_0x4911a3(0x18b),_0x4911a3(0x19e)]);if(!_0x113049||!_0x22fa2c)return common_1[_0x4911a3(0x17f)]['error'](_0x4911a3(0x19f),_0x4911a3(0x1c7));this[_0x4911a3(0x1a6)]=new COS({'SecretId':_0x113049,'SecretKey':_0x22fa2c}),common_1[_0x4911a3(0x17f)]['log'](_0x4911a3(0x173));}async[_0x21405e(0x13e)](_0x53dde0){const _0x3022c1=_0x21405e,{list3:_0x2623eb,list4:_0x546b0d}=this[_0x3022c1(0x207)];if(_0x2623eb['length']===0x0&&_0x546b0d[_0x3022c1(0x170)]===0x0)throw new common_1[(_0x3022c1(0x1a8))]('未配置有效key、请先前往后台系统配置！',common_1[_0x3022c1(0x201)]['BAD_REQUEST']);if(_0x53dde0===0x3){if(_0x2623eb[_0x3022c1(0x170)]===0x0)throw new common_1[(_0x3022c1(0x1a8))](_0x3022c1(0xc2),common_1[_0x3022c1(0x201)][_0x3022c1(0xf6)]);return(0x0,utils_1[_0x3022c1(0x1be)])(_0x2623eb);}if(_0x53dde0===0x4){if(_0x546b0d['length']===0x0){const _0x32d4d3=await this[_0x3022c1(0x160)][_0x3022c1(0x198)]([_0x3022c1(0x98)]);if(Number(_0x32d4d3)!==0x1)throw new common_1[(_0x3022c1(0x1a8))](_0x3022c1(0x13c),common_1[_0x3022c1(0x201)]['BAD_REQUEST']);common_1['Logger'][_0x3022c1(0x1fb)](_0x3022c1(0x155));if(_0x2623eb[_0x3022c1(0x170)]===0x0)throw new common_1[(_0x3022c1(0x1a8))](_0x3022c1(0x17d),common_1['HttpStatus']['BAD_REQUEST']);else return(0x0,utils_1[_0x3022c1(0x1be)])(_0x2623eb);}else return(0x0,utils_1['selectKeyWithWeight'])(_0x546b0d);}}async[_0x21405e(0x152)](_0x1a8acf,_0x512ae6,_0x5f3328,_0x573fa3){const _0x941c0b=_0x21405e,{timeout:timeout=0x3c}=_0x5f3328,{topN:_0x5cb96a,model:_0xf80da0}=_0x573fa3,{parentMessageId:parentMessageId=0x0}=_0x1a8acf,_0x338f7c=await this['globalConfigService'][_0x941c0b(0x198)](['openaiTimeoutMs']),_0x28f7a2=timeout*0x3e8||_0x338f7c||0x64*0x3e8;common_1[_0x941c0b(0x17f)][_0x941c0b(0xf3)](_0x28f7a2,'timeoutMs'),common_1['Logger'][_0x941c0b(0xf3)](_0x338f7c,_0x941c0b(0x1b5));const _0x11177f={'parentMessageId':parentMessageId,'timeoutMs':+_0x28f7a2,'completionParams':{'model':_0xf80da0,'temperature':_0x5cb96a}};return _0x512ae6&&(_0x11177f[_0x941c0b(0x109)]=_0x512ae6),_0x11177f;}async['chatProcess'](_0x181e4b,_0x495690,_0x5203f9){const _0x34fe65=_0x21405e,_0x1fb65a=_0x495690[_0x34fe65(0x1ab)],{options:options={},prompt:_0x12cf99,appId:_0x5ac409,cusromPrompt:_0x29865c,systemMessage:systemMessage=''}=_0x181e4b;let _0x1a8f90=systemMessage;const {groupId:_0x5ad6a9,usingNetwork:_0x1be0db,parentMessageId:_0x40d030,type:_0x5ce1af}=options;let _0x52bf73;_0x5ce1af&&_0x5ce1af===_0x34fe65(0x1c0)?_0x52bf73=await this[_0x34fe65(0xfd)][_0x34fe65(0xc1)](_0x5ad6a9):_0x52bf73=await this[_0x34fe65(0x137)][_0x34fe65(0xc1)](_0x5ad6a9);let _0x9149c4;_0x52bf73?_0x9149c4=JSON['parse'](_0x52bf73['config']):_0x9149c4=await this[_0x34fe65(0xac)][_0x34fe65(0x1ed)](model_constant_1['EModelType'][_0x34fe65(0x180)]);if(!_0x9149c4)throw new common_1['HttpException'](_0x34fe65(0x161),common_1[_0x34fe65(0x201)][_0x34fe65(0xf6)]);let {model:_0x104466,keyType:_0x434fd2,modelType:_0x10dcf3,id:_0x40f64f,topN:_0x3d6710,systemMessage:_0x5648b5,rounds:_0x4b0bcd}=_0x9149c4['modelInfo'],_0x34fd47=null;if(!_0x29865c&&!_0x5ce1af)_0x34fd47=await this[_0x34fe65(0xac)][_0x34fe65(0x1c4)](_0x104466),_0x9149c4[_0x34fe65(0x1ba)][_0x34fe65(0x1fc)]===model_constant_1[_0x34fe65(0x1fd)]['MUSIC']&&(_0x104466=_0x181e4b['mv']||_0x34fe65(0x1e8),options[_0x34fe65(0x1df)]=_0x104466,_0x9149c4['modelInfo'][_0x34fe65(0xa6)]=_0x104466);else{if(_0x5ce1af==='gpts')_0x34fd47=await this[_0x34fe65(0xfd)]['getCurrentModelKeyInfo'](_0x5ad6a9),_0x34fd47[_0x34fe65(0x1df)]&&(_0x104466=_0x34fd47[_0x34fe65(0x1df)],options['modelId']=_0x104466,_0x9149c4[_0x34fe65(0x1ba)][_0x34fe65(0xa6)]=_0x104466);else _0x29865c?_0x34fd47=await this[_0x34fe65(0xac)][_0x34fe65(0xbb)](model_constant_1[_0x34fe65(0x1fd)][_0x34fe65(0x180)]):_0x34fd47=await this[_0x34fe65(0xac)][_0x34fe65(0xbb)](model_constant_1['EModelType'][_0x34fe65(0x10d)]);}if(!_0x34fd47)throw new common_1[(_0x34fe65(0x1a8))]('当前流程所需要的模型已被管理员下架、请联系管理员上架专属模型！',common_1[_0x34fe65(0x201)][_0x34fe65(0xf6)]);const {deduct:_0x312506,deductType:_0x168f02,key:_0x43984d,modelName:_0x56e611,id:_0x3a2b88,accessToken:_0x4df57f,proxy:_0x21137e}=_0x34fd47;await this[_0x34fe65(0xe9)]['checkUserStatus'](_0x495690[_0x34fe65(0x20f)]),await this[_0x34fe65(0x1f5)][_0x34fe65(0x178)](_0x495690,_0x168f02===0x1?'model3':'model4',_0x312506),_0x5203f9&&_0x5203f9[_0x34fe65(0x1a3)](_0x34fe65(0x210),_0x34fe65(0x114)),await this[_0x34fe65(0x200)][_0x34fe65(0x14c)](_0x12cf99,_0x495690['user']['id']);const _0x425c26=await this[_0x34fe65(0x1b6)]['checkAutoReply'](_0x12cf99);if(_0x425c26&&_0x5203f9){const _0x547f5f={'message':_0x425c26,'code':0x1f4};return _0x5203f9[_0x34fe65(0x120)](JSON[_0x34fe65(0x1a0)](_0x547f5f)),_0x5203f9['end']();}if(_0x5ac409){const _0x3b89ad=await this['appEntity'][_0x34fe65(0x1ee)]({'where':{'id':_0x5ac409,'status':(0x0,typeorm_1['In'])([0x1,0x3,0x4,0x5])}});if(!_0x3b89ad)throw new common_1[(_0x34fe65(0x1a8))](_0x34fe65(0x1aa),common_1[_0x34fe65(0x201)]['BAD_REQUEST']);_0x3b89ad[_0x34fe65(0x108)]&&(_0x1a8f90=_0x3b89ad[_0x34fe65(0x108)]);}else{if(_0x29865c)_0x1a8f90=systemMessage;else{if(_0x5648b5)_0x1a8f90=_0x5648b5;else{const _0x218c14=new Date()[_0x34fe65(0x19a)]()[_0x34fe65(0x171)]('T')[0x0];let _0x4d9be9='';_0x5ce1af!=='gpts'&&(_0x4d9be9=await this[_0x34fe65(0x160)][_0x34fe65(0x198)]([_0x34fe65(0xbd)]),_0x1a8f90=_0x4d9be9+(_0x34fe65(0xe2)+_0x218c14));}}}let _0x3ce0ff='';if(_0x1be0db){_0x3ce0ff=await(0x0,utils_1[_0x34fe65(0xfc)])(_0x12cf99);const _0x25ba79=new Date()[_0x34fe65(0x19a)]()[_0x34fe65(0x171)]('T')[0x0],_0x153d2a=await this[_0x34fe65(0x160)][_0x34fe65(0x198)](['systemPreMessage']);_0x1a8f90=_0x153d2a+('\x0a\x20Respond\x20using\x20markdown.\x20\x0a\x20Current\x20date:\x20'+_0x25ba79);}const _0x5d4424=await this[_0x34fe65(0x152)](options,_0x1a8f90,_0x34fd47,_0x9149c4[_0x34fe65(0x1ba)]);console[_0x34fe65(0xf3)](_0x34fe65(0x1b7),_0x5d4424);const {maxModelTokens:maxModelTokens=0x1f40,maxResponseTokens:maxResponseTokens=0x1000}=_0x34fd47,_0x374e17=_0x5ce1af==='gpts'?_0x21137e:await this[_0x34fe65(0x11b)](_0x34fd47);this[_0x34fe65(0x181)]['apiKey']=(0x0,utils_1['removeSpecialCharacters'])(_0x43984d),console['log'](_0x34fe65(0x1eb),this['api'][_0x34fe65(0x106)]),console[_0x34fe65(0xf3)](_0x34fe65(0x1d9),_0x374e17+_0x34fe65(0x130)),this['api'][_0x34fe65(0xe5)]=_0x374e17+_0x34fe65(0x130),this[_0x34fe65(0x181)][_0x34fe65(0xb9)]=maxModelTokens,this['api'][_0x34fe65(0x214)]=maxResponseTokens>=maxModelTokens?Math[_0x34fe65(0x9a)](Math['floor'](maxModelTokens/0x2)):maxResponseTokens,_0x5203f9&&_0x5203f9[_0x34fe65(0x1bc)](0xc8);let _0x5007be=null,_0x529bbd=null;try{if(_0x5203f9){let _0x48ed7a=null,_0x58dcfc=![];_0x5203f9['on'](_0x34fe65(0x1f3),async()=>{const _0x4e693e=_0x34fe65;if(_0x58dcfc)return;_0x1fb65a['abort']();const _0x3694c5=await this[_0x4e693e(0x181)][_0x4e693e(0xed)](_0x12cf99)||0x0,_0x26eeb6=await this[_0x4e693e(0x181)][_0x4e693e(0xed)](_0x48ed7a?.['text']||''),_0x3b12fc=_0x3694c5+_0x26eeb6,_0x32dfd2=(0x0,utils_1[_0x4e693e(0x1c5)])(_0x495690);await this['chatLogService'][_0x4e693e(0xd8)]({'appId':_0x5ac409,'curIp':_0x32dfd2,'logType':_0x5ce1af===_0x4e693e(0x1c0)?0x2:0x1,'userId':_0x495690['user']['id'],'type':balance_constant_1[_0x4e693e(0xeb)][_0x4e693e(0x196)],'prompt':_0x12cf99,'answer':'','promptTokens':_0x3694c5,'completionTokens':0x0,'totalTokens':_0x3694c5,'model':_0x104466,'role':'user','groupId':_0x5ad6a9,'requestOptions':JSON[_0x4e693e(0x1a0)]({'options':null,'prompt':_0x12cf99}),'modelId':_0x40f64f,'modelType':_0x10dcf3}),await this['chatLogService'][_0x4e693e(0xd8)]({'appId':_0x5ac409,'curIp':_0x32dfd2,'logType':_0x5ce1af==='gpts'?0x2:0x1,'userId':_0x495690[_0x4e693e(0x20f)]['id'],'type':balance_constant_1[_0x4e693e(0xeb)][_0x4e693e(0x196)],'prompt':_0x12cf99,'answer':_0x48ed7a?.[_0x4e693e(0xd6)],'promptTokens':_0x3694c5,'completionTokens':_0x26eeb6,'totalTokens':_0x3b12fc,'model':_0x104466,'role':_0x4e693e(0xe0),'groupId':_0x5ad6a9,'requestOptions':JSON[_0x4e693e(0x1a0)]({'options':{'model':_0x104466,'temperature':_0x3d6710},'prompt':_0x12cf99}),'conversationOptions':JSON['stringify']({'conversationId':_0x48ed7a?.[_0x4e693e(0xaa)],'model':_0x104466,'parentMessageId':_0x48ed7a?.['id'],'temperature':_0x3d6710}),'modelId':_0x40f64f,'modelType':_0x10dcf3}),await this[_0x4e693e(0x1f5)][_0x4e693e(0xfb)](_0x495690[_0x4e693e(0x20f)]['id'],'model'+(_0x168f02===0x1?0x3:0x4),0x1,_0x3b12fc);}),_0x5203f9['on']('error',_0xeddcb6=>{console['log'](_0xeddcb6);});if(Number(_0x434fd2)===0x1){let _0x26dfaf=!![];_0x5007be=await this['api']['sendMessage'](_0x1be0db?_0x3ce0ff:_0x12cf99,{..._0x5d4424,'onProgress':_0x4a08e7=>{const _0x4ea8e3=_0x34fe65;_0x5203f9[_0x4ea8e3(0x120)](_0x26dfaf?JSON[_0x4ea8e3(0x1a0)](_0x4a08e7):'\x0a'+JSON[_0x4ea8e3(0x1a0)](_0x4a08e7)),_0x26dfaf=![],_0x48ed7a=_0x4a08e7;},'abortSignal':_0x1fb65a['signal']}),_0x58dcfc=!![];}if(Number(_0x434fd2)===0x2){let _0x3e33c1=!![];const _0x3bbcf1=await this[_0x34fe65(0xa3)][_0x34fe65(0x13b)](_0x1be0db?_0x3ce0ff:_0x12cf99,{'parentMessageId':_0x40d030,'maxRounds':(0x0,helper_1[_0x34fe65(0x1b3)])(_0x4b0bcd)});_0x5007be=await(0x0,baidu_1[_0x34fe65(0x215)])(_0x1be0db?_0x3ce0ff:_0x3bbcf1,{'temperature':_0x3d6710,'accessToken':_0x4df57f,'model':_0x104466,'onProgress':_0x301343=>{const _0x42f6c8=_0x34fe65;_0x5203f9[_0x42f6c8(0x120)](_0x3e33c1?JSON['stringify'](_0x301343):'\x0a'+JSON[_0x42f6c8(0x1a0)](_0x301343)),_0x3e33c1=![],_0x48ed7a=_0x301343;}}),_0x58dcfc=!![];}if(Number(_0x434fd2)===0x3){let _0x3ece19=!![];const _0x5816c9=await this[_0x34fe65(0xa3)][_0x34fe65(0x13b)](_0x1be0db?_0x3ce0ff:_0x12cf99,{'parentMessageId':_0x40d030,'maxRounds':(0x0,helper_1[_0x34fe65(0x1b3)])(_0x4b0bcd)});_0x5007be=await(0x0,zhipu_1['sendMessageFromZhipu'])(_0x1be0db?_0x3ce0ff:_0x5816c9,{'temperature':_0x3d6710,'key':_0x43984d,'model':_0x104466,'onProgress':_0x14f60f=>{const _0x192f9d=_0x34fe65;_0x5203f9[_0x192f9d(0x120)](_0x3ece19?JSON[_0x192f9d(0x1a0)](_0x14f60f):'\x0a'+JSON[_0x192f9d(0x1a0)](_0x14f60f)),_0x3ece19=![],_0x48ed7a=_0x14f60f;}}),_0x58dcfc=!![];}if(Number(_0x434fd2)===0x4){let _0x1211cb=!![];const {key:_0x3f1791,appid:_0x50f67b,secret:_0x4edc1e,model:_0x54e5d3}=_0x34fd47,_0x54b1fe=await this[_0x34fe65(0xa3)][_0x34fe65(0x13b)](_0x1be0db?_0x3ce0ff:_0x12cf99,{'parentMessageId':_0x40d030,'maxRounds':(0x0,helper_1['addOneIfOdd'])(_0x4b0bcd)}),_0x34bbd8=new spark_1[(_0x34fe65(0x18d))]({'appid':_0x50f67b,'secret':_0x4edc1e,'key':_0x3f1791});_0x5007be=await _0x34bbd8[_0x34fe65(0x159)](_0x1be0db?_0x3ce0ff:_0x54b1fe,{'temperature':_0x3d6710,'model':_0x54e5d3,'onProgress':_0x17a48e=>{const _0x3de2c1=_0x34fe65;_0x5203f9[_0x3de2c1(0x120)](_0x1211cb?JSON[_0x3de2c1(0x1a0)](_0x17a48e):'\x0a'+JSON['stringify'](_0x17a48e)),_0x1211cb=![],_0x48ed7a=_0x17a48e;},'abortController':_0x1fb65a}),_0x58dcfc=!![];}const _0x3e4100={'id':this[_0x34fe65(0xa3)]['getUuid'](),'text':_0x12cf99,'role':_0x34fe65(0x20f),'name':undefined,'usage':null,'parentMessageId':_0x40d030,'conversationId':_0x5007be?.[_0x34fe65(0xaa)]||null};_0x529bbd={'model':_0x104466,'parentMessageId':_0x40d030},await this[_0x34fe65(0xa3)][_0x34fe65(0xe7)](_0x3e4100);const _0x2e0651={'id':_0x5007be?.['id']||this[_0x34fe65(0xa3)][_0x34fe65(0x20a)](),'text':_0x5007be[_0x34fe65(0xd6)],'role':'assistant','name':undefined,'usage':_0x5007be['usage'],'parentMessageId':_0x3e4100['id'],'conversationId':_0x5007be?.[_0x34fe65(0xaa)]};await this['gomaxAiStore'][_0x34fe65(0xe7)](_0x2e0651),_0x529bbd={'model':_0x104466,'parentMessageId':_0x3e4100['id']};}else console[_0x34fe65(0xf3)](_0x34fe65(0x119)),_0x5007be=await this['api'][_0x34fe65(0xee)](_0x1be0db?_0x3ce0ff:_0x12cf99,_0x5d4424);const _0x15fee8=(0x0,helper_1[_0x34fe65(0x1c2)])(_0x434fd2,_0x5007be,_0x529bbd),{prompt_tokens:prompt_tokens=0x0,completion_tokens:completion_tokens=0x0,total_tokens:total_tokens=0x0}=_0x15fee8['usage'];await this['userBalanceService']['deductFromBalance'](_0x495690[_0x34fe65(0x20f)]['id'],_0x34fe65(0xa6)+(_0x168f02===0x1?0x3:0x4),_0x312506,total_tokens);_0x5ce1af===_0x34fe65(0x1c0)?await this[_0x34fe65(0xfd)]['saveGptsUseLog'](_0x3a2b88,total_tokens):await this['modelsService'][_0x34fe65(0x129)](_0x3a2b88,total_tokens);const _0x5039e6=(0x0,utils_1['getClientIp'])(_0x495690);await this['chatLogService'][_0x34fe65(0xd8)]({'appId':_0x5ac409,'curIp':_0x5039e6,'logType':_0x5ce1af===_0x34fe65(0x1c0)?0x2:0x1,'userId':_0x495690[_0x34fe65(0x20f)]['id'],'type':balance_constant_1[_0x34fe65(0xeb)]['CHAT_TYPE'],'prompt':_0x12cf99,'answer':'','promptTokens':prompt_tokens,'completionTokens':0x0,'totalTokens':total_tokens,'model':_0x15fee8['model'],'role':_0x34fe65(0x20f),'groupId':_0x5ad6a9,'requestOptions':JSON[_0x34fe65(0x1a0)]({'options':null,'prompt':_0x12cf99}),'modelId':_0x40f64f,'modelType':_0x10dcf3});const _0x4e15b0=await this[_0x34fe65(0xb3)][_0x34fe65(0xd8)]({'appId':_0x5ac409,'curIp':_0x5039e6,'logType':_0x5ce1af==='gpts'?0x2:0x1,'userId':_0x495690[_0x34fe65(0x20f)]['id'],'type':balance_constant_1[_0x34fe65(0xeb)][_0x34fe65(0x196)],'prompt':_0x12cf99,'answer':_0x15fee8?.[_0x34fe65(0xd6)],'promptTokens':prompt_tokens,'completionTokens':completion_tokens,'totalTokens':total_tokens,'model':_0x104466,'role':_0x34fe65(0xe0),'groupId':_0x5ad6a9,'requestOptions':JSON[_0x34fe65(0x1a0)]({'options':{'model':_0x104466,'temperature':_0x3d6710},'prompt':_0x12cf99}),'conversationOptions':JSON['stringify']({'conversationId':_0x5007be[_0x34fe65(0xaa)],'model':_0x104466,'parentMessageId':_0x5007be['id'],'temperature':_0x3d6710}),'modelId':_0x40f64f,'modelType':_0x10dcf3});common_1[_0x34fe65(0x17f)][_0x34fe65(0x12d)](_0x34fe65(0xfa)+_0x495690['user']['id']+_0x34fe65(0x117)+_0x104466+'\x20key\x20->\x20'+_0x43984d+_0x34fe65(0xff)+_0x56e611+',\x20模型token:\x20'+maxModelTokens+_0x34fe65(0x15d)+maxResponseTokens,_0x34fe65(0x1ff));const _0x2df7fe=await this[_0x34fe65(0x1f5)][_0x34fe65(0x99)](_0x495690[_0x34fe65(0x20f)]['id']);return _0x5007be[_0x34fe65(0x16a)]={..._0x2df7fe},_0x5007be[_0x34fe65(0x102)]&&(_0x5007be[_0x34fe65(0x102)]=''),_0x5007be['is_end']=!![],_0x5007be[_0x34fe65(0xc5)]=_0x4e15b0['id'],_0x5203f9?_0x5203f9[_0x34fe65(0x120)]('\x0a'+JSON[_0x34fe65(0x1a0)](_0x5007be)):_0x5007be['text'];}catch(_0x477f15){console[_0x34fe65(0xf3)]('chat-error',_0x43984d,_0x477f15);const _0x5e97c4=_0x477f15['statusCode'];if(_0x477f15[_0x34fe65(0x1bc)]&&_0x477f15[_0x34fe65(0x1bc)]===0x192){const _0xceaa64={'message':'Catch\x20Error\x20'+_0x477f15[_0x34fe65(0x1d6)],'code':0x192};if(_0x5203f9)return _0x5203f9['write'](JSON[_0x34fe65(0x1a0)](_0xceaa64));else throw new common_1[(_0x34fe65(0x1a8))](_0x477f15[_0x34fe65(0x1d6)],common_1[_0x34fe65(0x201)][_0x34fe65(0x184)]);}if(!_0x5e97c4){if(_0x5203f9)return _0x5203f9[_0x34fe65(0x120)](JSON[_0x34fe65(0x1a0)]({'message':_0x477f15[_0x34fe65(0x1d6)],'code':0x1f4}));else throw new common_1[(_0x34fe65(0x1a8))](_0x477f15[_0x34fe65(0x1d6)],common_1[_0x34fe65(0x201)][_0x34fe65(0xf6)]);}let _0x54cfcf=errorMessage_constant_1[_0x34fe65(0x204)][_0x5e97c4]?errorMessage_constant_1['OpenAiErrorCodeMessage'][_0x5e97c4]:_0x34fe65(0xae);_0x477f15?.[_0x34fe65(0x1d6)][_0x34fe65(0x14d)](_0x34fe65(0xdf))&&Number(_0x434fd2)===0x1&&(await this['modelsService']['lockKey'](_0x3a2b88,_0x34fe65(0x101),-0x1),_0x54cfcf=_0x34fe65(0xbc));_0x477f15?.[_0x34fe65(0x14e)]===0x1ad&&_0x477f15[_0x34fe65(0x1d6)][_0x34fe65(0x14d)]('You\x20exceeded\x20your\x20current\x20quota,\x20please\x20check\x20your\x20plan\x20and\x20billing\x20details.')&&Number(_0x434fd2)===0x1&&(await this[_0x34fe65(0xac)]['lockKey'](_0x3a2b88,'当前模型key余额已耗尽、已冻结当前调用Key、尝试重新对话试试吧！',-0x3),_0x54cfcf=_0x34fe65(0x16e));_0x477f15?.[_0x34fe65(0x14e)]===0x191&&_0x477f15['message'][_0x34fe65(0x14d)](_0x34fe65(0xd9))&&Number(_0x434fd2)===0x1&&(await this[_0x34fe65(0xac)][_0x34fe65(0x1e9)](_0x3a2b88,_0x34fe65(0x1de),-0x2),_0x54cfcf=_0x34fe65(0x1ec));_0x477f15?.[_0x34fe65(0x14e)]===0x191&&Number(_0x434fd2)===0x1&&(_0x54cfcf=_0x34fe65(0x1ec));_0x477f15?.[_0x34fe65(0x14e)]===0x191&&_0x477f15['message'][_0x34fe65(0x14d)](_0x34fe65(0x1e1))&&Number(_0x434fd2)===0x1&&(await this[_0x34fe65(0xac)][_0x34fe65(0x1e9)](_0x3a2b88,_0x34fe65(0x1de),-0x2),_0x54cfcf=_0x34fe65(0x1ec));_0x477f15?.[_0x34fe65(0x14e)]===0x194&&_0x477f15[_0x34fe65(0x1d6)][_0x34fe65(0x14d)]('This\x20is\x20not\x20a\x20chat\x20model\x20and\x20thus\x20not\x20supported')&&Number(_0x434fd2)===0x1&&(await this[_0x34fe65(0xac)][_0x34fe65(0x1e9)](_0x3a2b88,_0x34fe65(0x20d),-0x4),_0x54cfcf=_0x34fe65(0x20e));_0x5e97c4===0x190&&console[_0x34fe65(0xf3)](_0x34fe65(0x11f),_0x477f15,_0x477f15[_0x34fe65(0x1d6)]);const _0x530b6a={'message':_0x54cfcf||_0x34fe65(0x151),'code':_0x5e97c4===0x191?0x191:_0x5e97c4||0x1f4};if(_0x5203f9)_0x5203f9['statusCode']=0x190,_0x5203f9[_0x34fe65(0x120)](JSON[_0x34fe65(0x1a0)](_0x530b6a));else throw new common_1[(_0x34fe65(0x1a8))](_0x530b6a[_0x34fe65(0x1d6)],common_1[_0x34fe65(0x201)][_0x34fe65(0xf6)]);}finally{_0x5203f9&&_0x5203f9[_0x34fe65(0x162)]();}}async['chatRealTime'](_0x5e5660,_0x294bac,_0x26ec25){const _0x32760e=_0x21405e,{audio:_0x1098a6,voice:_0x4f281c}=_0x5e5660,_0x4eb9f9=_0x294bac[_0x32760e(0x1ab)],_0x298699=await this[_0x32760e(0xac)][_0x32760e(0x105)]();if(!_0x298699)throw _0x32760e(0x176);const {deduct:_0x398dfc,deductType:_0x59913d,key:_0xa1cfc3,timeout:_0x2ed3e4,proxyUrl:_0x360a7f}=_0x298699;await this[_0x32760e(0xe9)][_0x32760e(0x134)](_0x294bac[_0x32760e(0x20f)]),await this[_0x32760e(0x1f5)][_0x32760e(0x178)](_0x294bac,_0x59913d===0x1?'model3':_0x32760e(0x189),_0x398dfc),console[_0x32760e(0xf3)](_0x32760e(0xda),_0xa1cfc3,_0x360a7f),this['openAi'][_0x32760e(0x106)]=_0xa1cfc3,this[_0x32760e(0x186)][_0x32760e(0x209)]=(_0x360a7f||this[_0x32760e(0x1b9)])+_0x32760e(0x130),this[_0x32760e(0x186)][_0x32760e(0x15a)]=0x989680;const _0x4a1f8e=await this[_0x32760e(0x186)][_0x32760e(0xf7)][_0x32760e(0x10f)][_0x32760e(0x9f)]({'file':(0x0,fs_2['createReadStream'])((0x0,path_1[_0x32760e(0x1f6)])(_0x1098a6[_0x32760e(0xa1)])),'model':_0x32760e(0x1fe),'language':'zh','response_format':_0x32760e(0x1f7),'temperature':0x0})[_0x32760e(0x1f1)](_0x1b4b88=>_0x1b4b88[_0x32760e(0xd6)])[_0x32760e(0x1d1)](_0x19b2b6=>{const _0x19e84c=_0x32760e;common_1[_0x19e84c(0x17f)][_0x19e84c(0x1fb)](_0x19b2b6);});console['log']('audio2text\x20',_0x4a1f8e);if(!_0x4a1f8e){this[_0x32760e(0xdb)]((0x0,path_1[_0x32760e(0x1f6)])(_0x1098a6['path']));throw new common_1['HttpException']('语音转文本失败',common_1['HttpStatus'][_0x32760e(0xf6)]);}const _0x101ae8=await this['requestFromGpt']({'userId':_0x294bac[_0x32760e(0x20f)]['id'],'prompt':_0x4a1f8e,'abortController':_0x4eb9f9})[_0x32760e(0x1d1)](_0x36a304=>{const _0x3af903=_0x32760e;common_1[_0x3af903(0x17f)][_0x3af903(0x1fb)](_0x36a304);});console[_0x32760e(0xf3)]('request\x20gpt\x20',_0x101ae8);if(!_0x101ae8){this[_0x32760e(0xdb)]((0x0,path_1[_0x32760e(0x1f6)])(_0x1098a6[_0x32760e(0xa1)]));throw new common_1[(_0x32760e(0x1a8))](_0x32760e(0xdd),common_1[_0x32760e(0x201)]['BAD_REQUEST']);}console[_0x32760e(0xf3)]('response.length',_0x101ae8[_0x32760e(0x170)]);let _0x49d691=_0x101ae8[_0x32760e(0x170)]>0x1000?_0x101ae8[_0x32760e(0x1e3)](0x0,0xfff):_0x101ae8;const _0x21a481=await this[_0x32760e(0x186)]['audio'][_0x32760e(0x1f0)][_0x32760e(0x9f)]({'input':_0x49d691,'model':'tts-1','response_format':'aac','voice':_0x4f281c,'speed':0x1})['then'](_0xd29fe5=>_0xd29fe5['arrayBuffer']())[_0x32760e(0x1d1)](_0x1f8718=>{const _0x4b6960=_0x32760e;common_1[_0x4b6960(0x17f)][_0x4b6960(0x1fb)](_0x1f8718);});if(!_0x21a481){this[_0x32760e(0xdb)]((0x0,path_1[_0x32760e(0x1f6)])(_0x1098a6[_0x32760e(0xa1)]));throw new common_1['HttpException'](_0x32760e(0x195),common_1[_0x32760e(0x201)][_0x32760e(0xf6)]);}const _0x57fb84=Buffer['from'](_0x21a481);return _0x26ec25[_0x32760e(0x1a3)](_0x32760e(0x210),_0x32760e(0x111)),_0x26ec25[_0x32760e(0x120)](_0x57fb84),_0x26ec25[_0x32760e(0x162)](_0x57fb84),this[_0x32760e(0xdb)]((0x0,path_1[_0x32760e(0x1f6)])(_0x1098a6['path'])),_0x57fb84;}async['requestFromGpt'](_0x5a4757){const _0x4254f8=_0x21405e,{prompt:_0x37c96a,userId:_0x1a656e,abortController:_0x4961a1}=_0x5a4757,_0x1bd19a=await this['modelsService'][_0x4254f8(0x1ed)](model_constant_1['EModelType'][_0x4254f8(0x10d)]),{keyType:_0x3b4103,model:_0x31cacd,topN:_0x173078}=_0x1bd19a[_0x4254f8(0x1ba)];let _0x4e2d89=await this[_0x4254f8(0xac)]['getCurrentModelKeyInfo'](_0x31cacd);if(!_0x4e2d89)throw new common_1[(_0x4254f8(0x1a8))]('当前流程所需要的模型已被管理员下架、请联系管理员上架专属模型！',common_1['HttpStatus'][_0x4254f8(0xf6)]);const {deduct:_0x3e5014,deductType:_0x11bf3c,key:_0x1d7628,id:_0x56b975,parentMessageId:_0x16ed1b,timeoutMs:_0x31f353}=_0x4e2d89,{maxModelTokens:maxModelTokens=0x1f40,maxResponseTokens:maxResponseTokens=0x1000}=_0x4e2d89,_0x38ab86=await this[_0x4254f8(0x11b)](_0x4e2d89);this[_0x4254f8(0x181)][_0x4254f8(0x106)]=(0x0,utils_1[_0x4254f8(0xe3)])(_0x1d7628),this[_0x4254f8(0x181)]['apiBaseUrl']=_0x38ab86+_0x4254f8(0x130),this[_0x4254f8(0x181)][_0x4254f8(0xb9)]=maxModelTokens,this[_0x4254f8(0x181)][_0x4254f8(0x214)]=maxResponseTokens>=maxModelTokens?Math[_0x4254f8(0x9a)](Math[_0x4254f8(0x107)](maxModelTokens/0x2)):maxResponseTokens;let _0x22cf25=null,_0x15504a=null;try{const _0xfc3b6={'parentMessageId':_0x16ed1b,'timeoutMs':+_0x31f353,'completionParams':{'model':_0x31cacd,'temperature':_0x173078}};_0x22cf25=await this[_0x4254f8(0x181)][_0x4254f8(0xee)](_0x37c96a,{..._0xfc3b6,'abortSignal':_0x4961a1[_0x4254f8(0x140)]});const _0x3c4317=(0x0,helper_1[_0x4254f8(0x1c2)])(_0x3b4103,_0x22cf25,_0x15504a),{total_tokens:total_tokens=0x0}=_0x3c4317[_0x4254f8(0x1a2)];return await this['userBalanceService'][_0x4254f8(0xfb)](_0x1a656e,_0x4254f8(0xa6)+(_0x11bf3c===0x1?0x3:0x4),_0x3e5014,total_tokens),await this[_0x4254f8(0xac)][_0x4254f8(0x129)](_0x56b975,total_tokens),_0x22cf25['text'];}catch(_0x3798a8){common_1['Logger'][_0x4254f8(0xf3)](_0x3798a8);const _0x2bf93b=_0x3798a8['statusCode'];console[_0x4254f8(0xf3)](_0x2bf93b);if(_0x3798a8['status']&&_0x3798a8['status']===0x192){const _0x138d33={'message':'Catch\x20Error\x20'+_0x3798a8['message'],'code':0x192};throw new common_1[(_0x4254f8(0x1a8))](_0x3798a8[_0x4254f8(0x1d6)],common_1[_0x4254f8(0x201)][_0x4254f8(0x184)]);}if(!_0x2bf93b)throw new common_1[(_0x4254f8(0x1a8))](_0x3798a8[_0x4254f8(0x1d6)],common_1[_0x4254f8(0x201)]['BAD_REQUEST']);let _0x364ca5=errorMessage_constant_1[_0x4254f8(0x204)][_0x2bf93b]?errorMessage_constant_1[_0x4254f8(0x204)][_0x2bf93b]:'服务异常、请重新试试吧！！！';_0x3798a8?.[_0x4254f8(0x1d6)][_0x4254f8(0x14d)](_0x4254f8(0xdf))&&Number(_0x3b4103)===0x1&&(await this[_0x4254f8(0xac)][_0x4254f8(0x1e9)](_0x56b975,_0x4254f8(0x101),-0x1),_0x364ca5=_0x4254f8(0xbc));_0x3798a8?.[_0x4254f8(0x14e)]===0x1ad&&_0x3798a8[_0x4254f8(0x1d6)][_0x4254f8(0x14d)](_0x4254f8(0xad))&&Number(_0x3b4103)===0x1&&(await this[_0x4254f8(0xac)][_0x4254f8(0x1e9)](_0x56b975,_0x4254f8(0x11e),-0x3),_0x364ca5='当前模型key余额已耗尽');_0x3798a8?.[_0x4254f8(0x14e)]===0x191&&_0x3798a8[_0x4254f8(0x1d6)]['includes']('Incorrect\x20API\x20key\x20provided')&&Number(_0x3b4103)===0x1&&(await this[_0x4254f8(0xac)][_0x4254f8(0x1e9)](_0x56b975,_0x4254f8(0x1c9),-0x2),_0x364ca5=_0x4254f8(0x90));_0x3798a8?.[_0x4254f8(0x14e)]===0x191&&_0x3798a8['message'][_0x4254f8(0x14d)]('Unauthorized')&&Number(_0x3b4103)===0x1&&(await this['modelsService'][_0x4254f8(0x1e9)](_0x56b975,_0x4254f8(0x16e),-0x2),_0x364ca5=_0x4254f8(0x20b));_0x3798a8?.[_0x4254f8(0x14e)]===0x194&&_0x3798a8['message'][_0x4254f8(0x14d)](_0x4254f8(0x1dd))&&Number(_0x3b4103)===0x1&&(await this[_0x4254f8(0xac)]['lockKey'](_0x56b975,_0x4254f8(0x20d),-0x4),_0x364ca5='当前模型不是聊天模型、已冻结当前调用Key、请重新尝试对话！');_0x3798a8?.[_0x4254f8(0x14e)]===0x133&&_0x3798a8[_0x4254f8(0x1d6)][_0x4254f8(0x14d)](_0x4254f8(0x11a))&&Number(_0x3b4103)===0x1&&(console['log']('333333333333333'),_0x364ca5='\x20！');_0x2bf93b===0x190&&console[_0x4254f8(0xf3)](_0x4254f8(0x11f),_0x3798a8,_0x3798a8[_0x4254f8(0x1d6)]);const _0x50c788={'message':_0x364ca5||'Please\x20check\x20the\x20back-end\x20console','code':_0x2bf93b===0x191?0x191:_0x2bf93b||0x1f4};throw new common_1[(_0x4254f8(0x1a8))](_0x50c788[_0x4254f8(0x1d6)],common_1[_0x4254f8(0x201)][_0x4254f8(0xf6)]);}}async[_0x21405e(0x103)](_0x5bf3dc,_0x3effa3){const _0x4634f9=_0x21405e;await this[_0x4634f9(0x200)][_0x4634f9(0x14c)](_0x5bf3dc['prompt'],_0x3effa3[_0x4634f9(0x20f)]['id']),common_1[_0x4634f9(0x17f)][_0x4634f9(0xf3)](_0x4634f9(0x16f)+_0x5bf3dc[_0x4634f9(0x1e0)],_0x4634f9(0xb4)),await this[_0x4634f9(0xe9)][_0x4634f9(0x134)](_0x3effa3[_0x4634f9(0x20f)]),await this[_0x4634f9(0x1f5)][_0x4634f9(0x178)](_0x3effa3,balance_constant_1[_0x4634f9(0xeb)][_0x4634f9(0x21a)],_0x5bf3dc['n']||0x1);let _0x31c1eb=[];const _0x231797=await this['modelsService'][_0x4634f9(0xbb)](model_constant_1['EModelType']['DRAW']),{key:_0x294332,model:_0x40bfc2,proxyUrl:_0x11a1c5}=await this[_0x4634f9(0x183)](_0x231797),_0x405b58=_0x11a1c5+_0x4634f9(0x1b0);try{const _0x352bd5=await axios_1[_0x4634f9(0x1d8)][_0x4634f9(0x18a)](_0x405b58,{..._0x5bf3dc,'model':_0x40bfc2,'response_format':_0x4634f9(0x10b)},{'headers':{'Authorization':_0x4634f9(0x1a1)+_0x294332}});_0x31c1eb=_0x352bd5[_0x4634f9(0x1c1)]['data'];}catch(_0x2a1229){console[_0x4634f9(0xf3)](_0x4634f9(0xd4),_0x2a1229);const _0x1edb50=_0x2a1229?.[_0x4634f9(0x1cc)]?.['status']||0x1f4,_0x1bd276=_0x2a1229?.[_0x4634f9(0x1cc)]?.[_0x4634f9(0x1c1)]?.[_0x4634f9(0x1fb)]?.['message'];if(_0x1edb50===0x1ad)throw new common_1['HttpException']('当前请求已过载、请稍等会儿再试试吧！',common_1['HttpStatus'][_0x4634f9(0xf6)]);if(_0x1edb50===0x190||_0x1bd276['includes'](_0x4634f9(0x12a)))throw new common_1[(_0x4634f9(0x1a8))](_0x4634f9(0x113),common_1[_0x4634f9(0x201)][_0x4634f9(0xf6)]);if(_0x1edb50===0x1f4)throw new common_1[(_0x4634f9(0x1a8))](_0x4634f9(0xfe),common_1[_0x4634f9(0x201)][_0x4634f9(0xf6)]);if(_0x1edb50===0x191)throw new common_1['HttpException'](_0x4634f9(0x91),common_1[_0x4634f9(0x201)][_0x4634f9(0xf6)]);throw new common_1['HttpException'](_0x4634f9(0xf0),common_1[_0x4634f9(0x201)][_0x4634f9(0xf6)]);}const _0x9570cc=[];for(const _0x5100a3 of _0x31c1eb){const _0x44002f=uuid['v4']()[_0x4634f9(0x1e3)](0x0,0xa)+_0x4634f9(0x187),_0x405048=Buffer['from'](_0x5100a3[_0x4634f9(0x10b)],_0x4634f9(0x1d0));_0x9570cc['push'](this[_0x4634f9(0x139)][_0x4634f9(0x208)]({'filename':_0x44002f,'buffer':_0x405048}));}const _0x33ac4b=await Promise[_0x4634f9(0x1a9)](_0x9570cc);await this[_0x4634f9(0x1f5)][_0x4634f9(0xfb)](_0x3effa3[_0x4634f9(0x20f)]['id'],'model3',_0x5bf3dc['n'],_0x5bf3dc['n']||0x1);const _0x258974=(0x0,utils_1['getClientIp'])(_0x3effa3),_0x1263cf=[],_0x183235=await this['uploadService'][_0x4634f9(0x135)](),[_0x53205c,_0x45b272]=_0x5bf3dc[_0x4634f9(0xcd)][_0x4634f9(0x171)]('x');return _0x33ac4b['forEach'](_0x282ad0=>{const _0x4ce4b6=_0x4634f9;_0x1263cf[_0x4ce4b6(0x138)](this[_0x4ce4b6(0xb3)][_0x4ce4b6(0xd8)]({'curIp':_0x258974,'logType':0x3,'userId':_0x3effa3[_0x4ce4b6(0x20f)]['id'],'type':balance_constant_1[_0x4ce4b6(0xeb)][_0x4ce4b6(0x21a)],'prompt':_0x5bf3dc['prompt'],'answer':_0x282ad0,'fileInfo':JSON[_0x4ce4b6(0x1a0)]({'cosType':_0x183235,'width':_0x53205c,'height':_0x45b272,'cosUrl':_0x282ad0}),'promptTokens':0x0,'completionTokens':0x0,'totalTokens':0x0,'model':_0x4ce4b6(0x1ea)}));}),await Promise[_0x4634f9(0x1a9)](_0x1263cf),_0x33ac4b;}async[_0x21405e(0x172)](_0x35e2d7){const _0x17fa53=_0x21405e,_0x5cb909=await this['globalConfigService']['getConfigs']([_0x17fa53(0x168)])||'https://api.openai.com';try{const _0x1095b0={'Content-Type':_0x17fa53(0x1a4),'Authorization':_0x17fa53(0x1a1)+_0x35e2d7},_0x39ea43=dayjs()[_0x17fa53(0x211)](_0x17fa53(0x10c)),_0x3083ba=dayjs()[_0x17fa53(0xbf)](0x63,'day')[_0x17fa53(0x211)](_0x17fa53(0x10c)),_0x52fb86=await axios_1[_0x17fa53(0x1d8)][_0x17fa53(0x1e6)](_0x5cb909+_0x17fa53(0x118)+_0x3083ba+_0x17fa53(0x1af)+_0x39ea43,{'headers':_0x1095b0}),_0x5be4b3=_0x52fb86?.[_0x17fa53(0x1c1)]['total_usage']??0x0,_0x21a111=await axios_1['default'][_0x17fa53(0x1e6)](_0x5cb909+'/v1/dashboard/billing/subscription',{'headers':_0x1095b0}),{has_payment_method:_0x119e3d,hard_limit_usd:_0x4d73c1,access_until:_0x73eb4b}=_0x21a111['data'],_0x5be413=(_0x5be4b3/0x64)[_0x17fa53(0xcb)](0x2),_0x1ce66a=Number(_0x4d73c1)['toFixed'](0x0);return{'totalAmount':_0x1ce66a+'$','useAmount':_0x5be413+'$','balance':(Number(_0x1ce66a)-Number(_0x5be413))['toFixed'](0x2)+'$','isBindCard':_0x119e3d,'expirDate':dayjs(_0x73eb4b*0x3e8)[_0x17fa53(0x211)](_0x17fa53(0x217)),'status':0x1};}catch(_0x292e45){return{'status':-0x1};}}async[_0x21405e(0x15c)](_0x5d0c2b,_0x43dee9){const _0x61bc0a=_0x21405e;let _0x1b5c93={};_0x43dee9===0x3?_0x1b5c93=await this[_0x61bc0a(0x13e)](0x3):_0x1b5c93=await this['getRandomGptKeyDetail'](0x4);const {model:_0x4cf0f2,key:_0x294148,id:_0x169a10}=_0x1b5c93;return await this[_0x61bc0a(0x1b4)][_0x61bc0a(0x206)]()['update'](gptKeys_entity_1[_0x61bc0a(0x197)])[_0x61bc0a(0x1f2)]({'useCount':()=>_0x61bc0a(0x1db)})[_0x61bc0a(0x11c)](_0x61bc0a(0x115),{'id':_0x169a10})[_0x61bc0a(0x191)](),_0x1b5c93;}async[_0x21405e(0x213)](_0x3ed25f){const _0x9a4bc8=_0x21405e,_0x386447=await this[_0x9a4bc8(0x160)][_0x9a4bc8(0x198)]([_0x9a4bc8(0x168)])||_0x9a4bc8(0xdc),_0x7ed29f=_0x386447+_0x9a4bc8(0xa5);try{const _0x2c9798=await axios_1[_0x9a4bc8(0x1d8)]['get'](_0x7ed29f,{'headers':{'Authorization':_0x9a4bc8(0x1a1)+_0x3ed25f}}),_0x5cbe10=_0x2c9798['data'][_0x9a4bc8(0x1c1)][_0x9a4bc8(0x1bd)](_0x39e053=>_0x39e053['id']);return model_constant_1[_0x9a4bc8(0xde)][_0x9a4bc8(0xe1)](_0x1c423e=>_0x5cbe10[_0x9a4bc8(0x14d)](_0x1c423e));}catch(_0x126f60){throw new common_1[(_0x9a4bc8(0x1a8))](_0x9a4bc8(0x122),common_1[_0x9a4bc8(0x201)][_0x9a4bc8(0xf6)]);}}async[_0x21405e(0xa0)](_0x46b5f7,_0x2ccd23){const _0x11dd89=_0x21405e;try{const _0x1fdd09={},{page:page=0x1,size:size=0xa,key:_0x149a09,status:_0x5d8d87,keyStatus:_0x23ca52,model:_0x42dba1}=_0x46b5f7;_0x149a09&&(_0x1fdd09[_0x11dd89(0x205)]=(0x0,typeorm_1['Like'])('%'+_0x149a09+'%')),_0x23ca52&&(_0x1fdd09[_0x11dd89(0x10a)]=_0x23ca52),_0x42dba1&&(_0x1fdd09[_0x11dd89(0xa6)]=_0x42dba1),[0x0,0x1,'0','1','-1',-0x1]['includes'](_0x5d8d87)&&(_0x1fdd09[_0x11dd89(0x1bc)]=_0x5d8d87);const [_0x4fca3f,_0x30a15a]=await this[_0x11dd89(0x1b4)][_0x11dd89(0x20c)]({'skip':(page-0x1)*size,'take':size,'where':_0x1fdd09,'order':{'id':'DESC'}}),_0x4c7025=[];_0x4fca3f[_0x11dd89(0x177)](_0x42bbb4=>_0x4c7025['push'](this['getKeyDetail'](_0x42bbb4[_0x11dd89(0x205)])));const _0x500fdb=await Promise[_0x11dd89(0x1a9)](_0x4c7025);return _0x4fca3f['forEach']((_0x21de8b,_0x5be618)=>_0x21de8b['keyDetail']=_0x500fdb[_0x5be618]),_0x2ccd23['user'][_0x11dd89(0x17e)]!==_0x11dd89(0x112)&&_0x4fca3f[_0x11dd89(0x177)](_0x406d77=>{const _0x4eb211=_0x11dd89;_0x406d77[_0x4eb211(0x205)]=_0x406d77[_0x4eb211(0x205)]?(0x0,utils_1[_0x4eb211(0x1dc)])(_0x406d77['key']):'',_0x406d77[_0x4eb211(0x94)]=_0x406d77[_0x4eb211(0x94)]?(0x0,utils_1[_0x4eb211(0x1dc)])(_0x406d77['openaiProxyUrl']):'';}),{'rows':_0x4fca3f,'count':_0x30a15a};}catch(_0x333bbc){console[_0x11dd89(0xf3)](_0x11dd89(0x1ae),_0x333bbc);throw new common_1[(_0x11dd89(0x1a8))](_0x11dd89(0x21e),common_1[_0x11dd89(0x201)][_0x11dd89(0xf6)]);}}async[_0x21405e(0x97)](_0x1f3918){const _0x23f7f6=_0x21405e,{key:_0x3cbf83}=_0x1f3918,_0x1aafc4=await this[_0x23f7f6(0x1b4)][_0x23f7f6(0x1ee)]({'where':{'key':_0x3cbf83}});if(_0x1aafc4)throw new common_1[(_0x23f7f6(0x1a8))](_0x23f7f6(0x219),common_1[_0x23f7f6(0x201)][_0x23f7f6(0xf6)]);const _0x489f26=await this['gptKeysEntity'][_0x23f7f6(0x143)](_0x1f3918);return await this['getAllKeyList'](),_0x489f26;}async[_0x21405e(0x13a)](_0x4953cb){const _0x1a6b61=_0x21405e,{keyList:_0x39a614}=_0x4953cb,_0x52d7de=await this[_0x1a6b61(0x1b4)][_0x1a6b61(0x166)]({'where':{'key':(0x0,typeorm_1['In'])(_0x39a614)}}),_0x35fc2d=_0x52d7de[_0x1a6b61(0x1bd)](_0x231b68=>_0x231b68['key']),_0x38676e=_0x39a614[_0x1a6b61(0xe1)](_0x19e16b=>!_0x35fc2d[_0x1a6b61(0x14d)](_0x19e16b)),_0x5e27ac=_0x38676e[_0x1a6b61(0x1bd)](_0x121a6f=>{return{'key':_0x121a6f,'status':0x1,'model':'gpt-3.5-turbo-16k-0613'};}),_0x13108d=await this[_0x1a6b61(0x1b4)]['save'](_0x5e27ac);let _0x3f4c4b=_0x1a6b61(0x149)+_0x5e27ac[_0x1a6b61(0x170)]+_0x1a6b61(0x1ce);return _0x35fc2d[_0x1a6b61(0x170)]&&(_0x3f4c4b+=_0x1a6b61(0x147)+_0x35fc2d[_0x1a6b61(0x170)]+_0x1a6b61(0x1d2)),_0x3f4c4b;}async[_0x21405e(0x144)](_0xeb231c){const _0x333ba0=_0x21405e,{id:_0xba7463}=_0xeb231c,_0x4293fa=await this[_0x333ba0(0x1b4)]['findOne']({'where':{'id':_0xba7463}});if(!_0x4293fa)throw new common_1[(_0x333ba0(0x1a8))](_0x333ba0(0x185),common_1[_0x333ba0(0x201)][_0x333ba0(0xf6)]);const _0x5cc331=await this[_0x333ba0(0x1b4)]['update']({'id':_0xba7463},_0xeb231c);if(_0x5cc331['affected']>0x0)return await this[_0x333ba0(0x150)](),_0x333ba0(0xd2);else throw new common_1[(_0x333ba0(0x1a8))](_0x333ba0(0x218),common_1[_0x333ba0(0x201)][_0x333ba0(0xf6)]);}async[_0x21405e(0xa9)](_0x4276bc){const _0xc12c85=_0x21405e,{id:_0x58a1df}=_0x4276bc,_0x26f6d3=await this['gptKeysEntity'][_0xc12c85(0x1ee)]({'where':{'id':_0x58a1df}});if(!_0x26f6d3)throw new common_1[(_0xc12c85(0x1a8))](_0xc12c85(0x185),common_1[_0xc12c85(0x201)][_0xc12c85(0xf6)]);const _0x2d4a7d=await this[_0xc12c85(0x1b4)][_0xc12c85(0xcf)]({'id':_0x58a1df});if(_0x2d4a7d[_0xc12c85(0x127)]>0x0)return await this['getAllKeyList'](),_0xc12c85(0x19c);else throw new common_1[(_0xc12c85(0x1a8))](_0xc12c85(0xa2),common_1['HttpStatus']['BAD_REQUEST']);}async[_0x21405e(0x150)](){const _0x3fed89=_0x21405e,_0x2348d8=await this[_0x3fed89(0x1b4)][_0x3fed89(0x166)]({'where':{'status':0x1},'select':['id',_0x3fed89(0x205),_0x3fed89(0xce),_0x3fed89(0xa6),'maxModelTokens',_0x3fed89(0x214),'openaiProxyUrl','openaiTimeoutMs']}),_0x1a94ed=_0x2348d8[_0x3fed89(0xe1)](_0x4e7f5e=>_0x4e7f5e[_0x3fed89(0xa6)]['includes'](_0x3fed89(0x12f))),_0x502f86=_0x2348d8[_0x3fed89(0xe1)](_0x59a09b=>_0x59a09b[_0x3fed89(0xa6)][_0x3fed89(0x14d)]('gpt-4'));this['keyPool']={'list3':_0x1a94ed,'list4':_0x502f86};}async[_0x21405e(0x17b)](){const _0x78c829=_0x21405e;return await this[_0x78c829(0x1e5)][_0x78c829(0x166)]({'where':{'status':0x1,'count':(0x0,typeorm_1[_0x78c829(0x142)])(0x0)},'select':[_0x78c829(0x14a)]});}async['addWhiteUser'](_0x4a952a){const _0x202201=_0x21405e,{userId:_0x2f280,count:_0x5846b9}=_0x4a952a,_0xf6cc1c=await this['whiteListEntity'][_0x202201(0x1ee)]({'where':{'userId':_0x2f280}});if(_0xf6cc1c)throw new common_1[(_0x202201(0x1a8))](_0x202201(0x199),common_1[_0x202201(0x201)][_0x202201(0xf6)]);const _0x43a5ab=await this[_0x202201(0x1e5)][_0x202201(0x143)](_0x4a952a);return await this['getUserWhiteList'](),_0x43a5ab;}async[_0x21405e(0x1e7)](_0x4e8e5d){const _0x1a717e=_0x21405e,{id:_0x33e0af}=_0x4e8e5d,_0x31f2af=await this[_0x1a717e(0x1e5)]['findOne']({'where':{'id':_0x33e0af}});if(!_0x31f2af)throw new common_1[(_0x1a717e(0x1a8))](_0x1a717e(0x1b8),common_1[_0x1a717e(0x201)][_0x1a717e(0xf6)]);const _0x4b5e7d=await this['whiteListEntity'][_0x1a717e(0xa7)]({'id':_0x33e0af},_0x4e8e5d);if(_0x4b5e7d[_0x1a717e(0x127)]>0x0)return await this[_0x1a717e(0x17b)](),'修改白名单成功';else throw new common_1[(_0x1a717e(0x1a8))](_0x1a717e(0xd1),common_1[_0x1a717e(0x201)]['BAD_REQUEST']);}async[_0x21405e(0x110)](_0xadbd09,_0x4230bb){const _0x2696f2=_0x21405e,{page:page=0x1,size:size=0xa}=_0xadbd09,[_0x59aa8d,_0x2713ed]=await this[_0x2696f2(0x1e5)][_0x2696f2(0x20c)]({'skip':(page-0x1)*size,'take':size,'order':{'id':_0x2696f2(0x1c6)}}),_0x594aa1=_0x59aa8d['map'](_0x2f1ae6=>_0x2f1ae6['userId']),_0x1b753e=await this[_0x2696f2(0xba)][_0x2696f2(0x166)]({'where':{'id':(0x0,typeorm_1['In'])(_0x594aa1)}});return _0x59aa8d[_0x2696f2(0x177)](_0x583799=>{const _0x443334=_0x2696f2,_0x1c11e0=_0x1b753e['find'](_0x22eadc=>_0x22eadc['id']===_0x583799[_0x443334(0x14a)]);_0x583799[_0x443334(0x1d4)]=_0x1c11e0?.[_0x443334(0x1d4)]??'',_0x583799[_0x443334(0xb2)]=_0x1c11e0?.['email']??'';}),_0x4230bb[_0x2696f2(0x20f)][_0x2696f2(0x17e)]!=='super'&&_0x59aa8d[_0x2696f2(0x177)](_0x3b2660=>_0x3b2660[_0x2696f2(0xb2)]=(0x0,utils_1['maskEmail'])(_0x3b2660[_0x2696f2(0xb2)])),{'rows':_0x59aa8d,'count':_0x2713ed};}async['getModelProxyUrl'](_0x1bbede){const _0x3e6113=_0x21405e,{proxyUrl:_0xf3cc3e}=_0x1bbede,_0xb0a284=await this[_0x3e6113(0x160)][_0x3e6113(0x198)]([_0x3e6113(0x168)]);return _0xf3cc3e||_0xb0a284||_0x3e6113(0xdc);}async['uploadFile'](_0x2fd00e,_0x42b7ee){const _0x157b34=_0x21405e;try{const {cosBucket:_0xd14a78,cosRegion:_0x4d6a68,tencentCosStatus:_0x5affc7,tencentCosAcceleratedDomain:_0x4a01ad}=await this[_0x157b34(0x160)][_0x157b34(0x198)]([_0x157b34(0x16b),_0x157b34(0x1fa),'tencentCosStatus',_0x157b34(0xb7)]);if(_0x5affc7!=='1')throw new common_1[(_0x157b34(0x1a8))](_0x157b34(0x216),common_1['HttpStatus'][_0x157b34(0xf6)]);!this[_0x157b34(0x1a6)]&&await this[_0x157b34(0x164)](!![]);const _0x129baf=_0x157b34(0xc4),_0x5d996d=(0x0,path_1[_0x157b34(0x96)])(_0x42b7ee[_0x157b34(0x21d)]),_0x2946e4=await this[_0x157b34(0x1a6)][_0x157b34(0x11d)]({'Bucket':_0xd14a78,'Region':_0x4d6a68,'Key':_0x129baf+Date[_0x157b34(0x1d3)]()+(''+_0x5d996d),'Body':(0x0,fs_2['createReadStream'])((0x0,path_1[_0x157b34(0x1f6)])(_0x42b7ee['path'])),'onProgress':_0x1d4c58=>{const _0x203c2a=_0x157b34;common_1[_0x203c2a(0x17f)][_0x203c2a(0xf3)](_0x1d4c58,_0x203c2a(0x1ac));}})[_0x157b34(0x1d1)](_0x17595c=>{throw _0x17595c;});return _0x157b34(0xb8)+_0x2946e4[_0x157b34(0x9d)];}catch(_0x514f95){return console['log'](_0x514f95),Promise[_0x157b34(0x1ad)](_0x514f95);}}async['uploadGpt'](_0x3d11a2){const _0x594836=_0x21405e,{purpose:_0x2655da,files:_0x477333}=_0x3d11a2,_0x258848=new FormData(),_0x2550ba=(0x0,fs_2[_0x594836(0x128)])((0x0,path_1['resolve'])(_0x477333['path']));_0x258848[_0x594836(0x13f)](_0x594836(0x17c),_0x2655da),_0x258848[_0x594836(0x13f)](_0x594836(0x133),_0x2550ba);const _0xb01b1d=_0x258848[_0x594836(0x19b)](),_0x50b4b3=()=>{return new Promise((_0x2b1664,_0x885be5)=>{_0x258848['getLength']((_0x3c64f9,_0x39b09e)=>{if(_0x3c64f9)_0x885be5(_0x3c64f9);console['log']('length',_0x39b09e),_0x2b1664(_0x39b09e);});});};_0xb01b1d['content-length']=await _0x50b4b3();const _0x4b53d6=await this[_0x594836(0x160)]['getConfigs'](['openaiBaseUrl']),_0x343a84='',_0x3b8919=_0x343a84||_0x4b53d6||_0x594836(0xdc);await axios_1[_0x594836(0x1d8)][_0x594836(0xb5)]({'baseURL':_0x3b8919+'/v1/files','method':_0x594836(0x18a),'headers':_0xb01b1d,'data':_0x258848,'onUploadProgress':_0x5937a9=>{const _0x5d31c1=_0x594836;console[_0x5d31c1(0xf3)](_0x5937a9);}})[_0x594836(0x1f1)](_0x1229d4=>{const _0x183846=_0x594836;console[_0x183846(0xf3)](_0x1229d4);});}async[_0x21405e(0x183)](_0x39aa3c){const _0x312f41=_0x21405e,{openaiModel3MaxTokens:openaiModel3MaxTokens=0x0,openaiModel3MaxTokensRes:openaiModel3MaxTokensRes=0x0,openaiModel3MaxTokens16k:openaiModel3MaxTokens16k=0x0,openaiModel3MaxTokens16kRes:openaiModel3MaxTokens16kRes=0x0,openaiModel4MaxTokens:openaiModel4MaxTokens=0x0,openaiModel4MaxTokensRes:openaiModel4MaxTokensRes=0x0,openaiModel4MaxTokens32k:openaiModel4MaxTokens32k=0x0,openaiModel4MaxTokens32kRes:openaiModel4MaxTokens32kRes=0x0,openaiBaseUrl:openaiBaseUrl=''}=await this[_0x312f41(0x160)][_0x312f41(0x198)]([_0x312f41(0xc8),_0x312f41(0xef),'openaiModel3MaxTokens16k',_0x312f41(0x1cf),_0x312f41(0xf9),_0x312f41(0x124),_0x312f41(0x125),_0x312f41(0x14b),'openaiBaseUrl']);let _0x3f7799=null,_0x1364c0=null,_0xe83e3d=null;const {model:_0x3f1715,maxModelTokens:maxModelTokens=0x0,maxResponseTokens:maxResponseTokens=0x0,proxyUrl:_0x599b81,key:_0x433175}=_0x39aa3c;return _0x3f1715['toLowerCase']()[_0x312f41(0x14d)]('gpt-4')&&(_0x3f1715[_0x312f41(0x121)]()[_0x312f41(0x14d)](_0x312f41(0x13d))?(_0x3f7799=maxModelTokens||openaiModel4MaxTokens32k||0x8000,_0x1364c0=maxResponseTokens||openaiModel4MaxTokens32kRes||0x4000):(_0x3f7799=maxModelTokens||openaiModel4MaxTokens||0x2000,_0x1364c0=maxResponseTokens||openaiModel4MaxTokensRes||0x1000)),_0x3f1715[_0x312f41(0x121)]()['includes']('gpt-3')&&(_0x3f1715[_0x312f41(0x121)]()['includes'](_0x312f41(0x1f9))?(_0x3f7799=maxModelTokens||openaiModel3MaxTokens16k||0x4000,_0x1364c0=maxResponseTokens||openaiModel3MaxTokens16kRes||0x2000):(_0x3f7799=maxModelTokens||openaiModel3MaxTokens||0x1000,_0x1364c0=maxResponseTokens||openaiModel3MaxTokensRes||0x3e8)),_0xe83e3d=_0x599b81||openaiBaseUrl||'https://api.openai.com',_0x1364c0>=_0x3f7799&&(_0x1364c0=Math[_0x312f41(0x107)](_0x3f7799/0x2),common_1['Logger'][_0x312f41(0x12d)](_0x312f41(0x158)+_0x433175+_0x312f41(0x16d)+_0x1364c0)),{'key':_0x433175,'model':_0x3f1715,'maxToken':_0x3f7799,'maxTokenRes':_0x1364c0,'proxyUrl':_0xe83e3d};}async['musicSquare'](_0x2d83ea,_0x369869){const _0x4ae271=_0x21405e;let _0x2f088f;if(_0x2d83ea['headers'][_0x4ae271(0xc6)]){const _0x2cad48=_0x2d83ea[_0x4ae271(0xca)]['authorization']['split']('\x20'),_0x48f301=jwt[_0x4ae271(0x169)](_0x2cad48[0x1],process['env'][_0x4ae271(0x92)]);_0x2f088f=_0x48f301['id'];}try{const {page:page=0x1,size:size=0x14,order:_0x3d2285,keyword:_0x2dc25c}=_0x369869,_0xc18ef8=await this[_0x4ae271(0x18c)][_0x4ae271(0x21b)](_0x4ae271(0x126)+(_0x2dc25c?_0x4ae271(0xf5)+_0x2dc25c+_0x4ae271(0x93)+_0x2dc25c+_0x4ae271(0x179):'')+_0x4ae271(0x1f8)),_0x45f36e=await this[_0x4ae271(0x18c)][_0x4ae271(0x21b)](_0x4ae271(0x1ef)+(_0x2dc25c?_0x4ae271(0xf5)+_0x2dc25c+_0x4ae271(0x93)+_0x2dc25c+_0x4ae271(0x179):'')+_0x4ae271(0x157)+(_0x3d2285?_0x3d2285:_0x4ae271(0xaf))+'\x20DESC\x20\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20LIMIT\x20'+size+_0x4ae271(0x1c3)+(page-0x1)*size+'\x0a\x20\x20\x20\x20\x20\x20'),_0x407299=_0x45f36e['map'](_0x382111=>_0x382111['id']),_0x5087e3=new Map();if(_0x2f088f&&_0x407299[_0x4ae271(0x170)]){const _0x5d9047=await this[_0x4ae271(0xea)][_0x4ae271(0x166)]({'where':{'userId':_0x2f088f,'relateId':(0x0,typeorm_1['In'])(_0x407299)}});_0x5d9047[_0x4ae271(0x177)](_0x367c89=>{const _0x52db00=_0x4ae271;_0x5087e3[_0x52db00(0x1f2)](_0x367c89[_0x52db00(0x167)],_0x367c89[_0x52db00(0x9b)]);});}const _0x1babcc=_0x45f36e[_0x4ae271(0x1bd)](_0xbc44fe=>{const _0x45b99b=_0x4ae271,{prompt:_0x470601,role:_0x1c7dc7,answer:_0x52bb14,createdAt:_0x2b80b5,model:_0x2ad411,conversationOptions:_0x137c91,requestOptions:_0x3bdd1f,id:_0x557cf3}=_0xbc44fe;return{'chatId':_0x557cf3,'error':![],'playNum':_0xbc44fe[_0x45b99b(0x156)],'agreeNum':_0xbc44fe[_0x45b99b(0x15b)],'inversion':_0x1c7dc7===_0x45b99b(0x20f),'agree':_0x5087e3['get'](_0x557cf3)||null,'dateTime':(0x0,utils_1[_0x45b99b(0xc9)])(_0x2b80b5),'text':_0x1c7dc7===_0x45b99b(0x20f)?_0x470601:_0x52bb14,'requestOptions':_0x3bdd1f?JSON[_0x45b99b(0xd3)](_0x3bdd1f):null,'conversationOptions':_0x137c91?JSON[_0x45b99b(0xd3)](_0x137c91):null};});return{'records':_0x1babcc,'count':Number(_0xc18ef8[0x0]?.[_0x4ae271(0xb1)]||0x0)};}catch(_0x42f5d8){throw new common_1[(_0x4ae271(0x1a8))](_0x42f5d8['message'],common_1[_0x4ae271(0x201)][_0x4ae271(0xf6)]);}}};function _0x32b7(){const _0x220b5a=['role','Logger','OTHER','api','11726760kFsfHs','formatModelToken','PAYMENT_REQUIRED','key不存在','openAi','.png','appEntity','model4','post','cosSecretId','connection','XunFeiSpark','../chatLog/chatLog.entity','6072129ZEAlKA','./spark','execute','function','../aiLog/aiAgreeLog.entity','redis://','语音转换失败','CHAT_TYPE','GptkeysEntity','getConfigs','用户已在白名单中！','toISOString','getHeaders','删除成功','form-data','cosSecretKey','还未配置腾讯云COS存储的的SecretId和SecretKey、配置后才可进行gpt文件上传操作！！！','stringify','Bearer\x20','usage','setHeader','application/json','GlobalConfigService','cosApi','chatLogEntity','HttpException','all','你当前使用的应用已被下架、请删除当前对话开启新的对话吧！','abortController','upload\x20cos','reject','error:\x20','&end_date=','/v1/images/generations','metadata','UserService','addOneIfOdd','gptKeysEntity','globalTimeoutMs','autoreplyService','mergedOptions','当前记录不存在！','defaultBaseUrl','modelInfo','../../common/constants/model.constant','status','map','selectKeyWithWeight','NineStore','gpts','data','unifiedFormattingResponse','\x20OFFSET\x20','getCurrentModelKeyInfo','getClientIp','DESC','ChatGptService','object','提供了错误的模型秘钥','Connection','gomaxai-chatlog','response','REDIS_USER','个key','openaiModel3MaxTokens16kRes','base64','catch','个已被排除！','now','username','keyv','message','openai','default','this.api.apiBaseUrl','4klyKSr','useCount\x20+\x201','hideString','This\x20is\x20not\x20a\x20chat\x20model\x20and\x20thus\x20not\x20supported','模型秘钥错误或模型余额不足','modelId','prompt','Unauthorized','UploadService','slice','decorate','whiteListEntity','get','updateWhiteUser','suno-v3','lockKey','DALL-E2','this.api.apiKey','模型秘钥错误或模型金额不足，请联系管理员！','getModelByType','findOne','\x0a\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20c.*,\x0a\x20\x20\x20\x20\x20\x20\x20\x20IFNULL(ale.play_num,0)\x20as\x20playNum,\x0a\x20\x20\x20\x20\x20\x20\x20\x20IFNULL(ale.agree_num,0)\x20as\x20agreeNum\x0a\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20chatlog\x20c\x0a\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20ai_log_ext\x20ale\x20ON\x20ale.relate_id\x20=\x20c.id\x20AND\x20ale.relate_type\x20=\x20\x27suno\x27\x20\x0a\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20c.isDelete\x20=\x200\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20c.role\x20=\x20\x27assistant\x27\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20c.modelType\x20=\x20\x27music\x27\x20\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20','speech','then','set','close','../../common/constants/balance.constant','userBalanceService','resolve','json','\x0a\x20\x20\x20\x20\x20\x20','16k','cosRegion','error','modelType','EModelType','whisper-1','ChatgptService','badwordsService','HttpStatus','4488ZIakHi','./../upload/upload.service','OpenAiErrorCodeMessage','key','createQueryBuilder','keyPool','uploadFile','baseURL','getUuid','当前模型key余额已耗尽，请充值！','findAndCount','当前模型不是聊天模型','当前模型不是聊天模型、已冻结当前调用Key、请重新尝试对话！','user','Content-type','format','../autoreply/autoreply.service','getGptModelList','maxResponseTokens','sendMessageFromBaidu','请开启并配置腾讯云COS存储参数后再使用','YYYY年M月D日','修改失败','key已存在','PAINT_TYPE','query','78760fpaBcf','filename','查询key列表失败','typeorm','../../common/utils','提供了错误的模型秘钥、已冻结当前调用Key、请重新尝试对话！','绘制图片失败，此次绘画被拒绝了！','JWT_SECRET','%\x27\x20OR\x20c.answer\x20LIKE\x20\x27%','openaiProxyUrl','../app/app.entity','extname','addKey','openaiaAtoDowngrade','queryUserBalance','abs','action','./helper','Location','ChatGroupService','create','getKeyList','path','删除失败','gomaxAiStore','@nestjs/common','/v1/models','model','update','./baidu','deleteKey','conversationId','./whiteList.entity','modelsService','You\x20exceeded\x20your\x20current\x20quota,\x20please\x20check\x20your\x20plan\x20and\x20billing\x20details.','服务异常、请重新试试吧！！！','c.createdAt','env','count','email','chatLogService','DrawService','request','7jFwbEY','tencentCosAcceleratedDomain','https://','maxModelTokens','userEntity','getRandomKey','当前模型key已被封禁','systemPreMessage','../userBalance/userBalance.service','subtract','53ZOrqZc','getGroupInfoFromId','未配置[卡池3]的有效key、请先前往后台系统配置！','Repository','uploaded/','chatLogId','authorization','jsonwebtoken','openaiModel3MaxTokens','formatDate','headers','toFixed','getOwnPropertyDescriptor','size','weight','delete','3257130JCEyFS','修改白名单失败','修改成功','parse','openai-draw','AutoreplyService','text','REDIS_HOST','saveChatLog','Incorrect\x20API\x20key\x20provided','key\x20%s,\x20proxy\x20%s','removeFile','https://api.openai.com','内容提取失败','MODEL_LIST','The\x20OpenAI\x20account\x20associated\x20with\x20this\x20API\x20key\x20has\x20been\x20deactivated.','assistant','filter','\x0a\x20Respond\x20using\x20markdown.\x20\x0a\x20Current\x20date:\x20','removeSpecialCharacters','../chatGroup/chatGroup.service','apiBaseUrl','remove\x20file\x20','setData','ChatLogEntity','userService','aiAgreeLogEntity','DeductionKey','GptsService','getTokenCount','sendMessage','openaiModel3MaxTokensRes','绘制图片失败，请稍后试试吧！','REDIS_PORT','../chatLog/chatLog.service','log','@keyv/redis','AND\x20(\x20c.prompt\x20LIKE\x20\x27%','BAD_REQUEST','audio','10IUnVgI','openaiModel4MaxTokens','本次调用:\x20','deductFromBalance','compileNetwork','gptsService','绘制图片失败，请检查你的提示词是否有非法描述！',',\x20模型名称:\x20','chatgpt-nine-ai','当前模型key已被封禁、已冻结当前调用Key、尝试重新对话试试吧！','result','draw','BadwordsService','getRandomAudioKey','apiKey','floor','preset','systemMessage','keyStatus','b64_json','YYYY-MM-DD','CHAT','InjectRepository','transcriptions','getWhiteListUser','application/octet-stream','super','您的请求已被系统拒绝。您的提示可能存在一些非法的文本。','application/octet-stream;\x20charset=utf-8','id\x20=\x20:id','axios','\x20model:\x20','/v1/dashboard/billing/usage?start_date=','fanyi\x20mj-associate','bad\x20response\x20status\x20code\x20307','getModelProxyUrl','where','putObject','当前模型key余额已耗尽、已冻结当前调用Key、尝试重新对话试试吧！','400\x20error','write','toLowerCase','获取模型列表失败，请检查你的key是否正确！','AppEntity','openaiModel4MaxTokensRes','openaiModel4MaxTokens32k','\x0a\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20COUNT(*)\x20as\x20count\x0a\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20chatlog\x20c\x0a\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20ai_log_ext\x20ale\x20ON\x20ale.relate_id\x20=\x20c.id\x20AND\x20ale.relate_type\x20=\x20\x27suno\x27\x20\x0a\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20c.isDelete\x20=\x200\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20c.role\x20=\x20\x27assistant\x27\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20c.modelType\x20=\x20\x27music\x27\x20\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20','affected','createReadStream','saveUseLog','Your\x20request\x20was\x20rejected\x20as\x20a\x20result\x20of\x20our\x20safety\x20system','uuid','./../user/user.service','debug','__param','gpt-3','/v1','initOpenAi','importDynamic','file','checkUserStatus','getUploadType','./gptKeys.entity','chatGroupService','push','uploadService','bulkCreateKey','buildMessageFromParentMessageId','未配置[卡池4]的有效key、请先前往后台系统配置！','32k','getRandomGptKeyDetail','append','signal','UserEntity','MoreThan','save','updateKey','gomaxai-default-key','unlink','、重复key','AiAgreeLogEntity','本次成功添加','userId','openaiModel4MaxTokens32kRes','checkBadWords','includes','statusCode','onModuleInit','getAllKeyList','Please\x20check\x20the\x20back-end\x20console','getRequestParams','./zhipu','chat','有4的权限但是卡池没有配置、降级为3的卡池','playNum','\x0a\x20\x20\x20\x20\x20\x20ORDER\x20BY\x0a\x20\x20\x20\x20\x20\x20\x20\x20','key:\x20','sendMessageFromXunFei','timeout','agreeNum','getModelAndKeyFromUser',',\x20最大回复token:\x20','8273304rxOWky','REDIS_PASSWORD','globalConfigService','未获取到模型基础配置，请前往后台配置并启用','end','design:paramtypes','getTencentCOSStorage','30518uSDbtb','find','relateId','openaiBaseUrl','verify','userBanance','cosBucket','__metadata','\x20回复数不得大于等于模型上下文数,\x20已自动调整为\x20maxTokenRes:\x20','当前模型key余额已耗尽','draw\x20paompt\x20info\x20<======*******======>\x20','length','split','getKeyDetail','腾讯云COS连接成功','2375883KmPMra','ChatLogService','未配置语音模型或语音模型key，请配置并启用语音功能！','forEach','validateBalance','%\x27\x20)','defineProperty','getUserWhiteList','purpose','未配置有效key、请先前往后台系统配置！'];_0x32b7=function(){return _0x220b5a;};return _0x32b7();}ChatgptService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_2[_0x21405e(0x10e)])(user_entity_1[_0x21405e(0x141)])),__param(0x1,(0x0,typeorm_2[_0x21405e(0x10e)])(gptKeys_entity_1['GptkeysEntity'])),__param(0x2,(0x0,typeorm_2[_0x21405e(0x10e)])(whiteList_entity_1['WhiteListEntity'])),__param(0x3,(0x0,typeorm_2[_0x21405e(0x10e)])(app_entity_1[_0x21405e(0x123)])),__param(0x4,(0x0,typeorm_2['InjectRepository'])(chatLog_entity_1[_0x21405e(0xe8)])),__param(0x5,(0x0,typeorm_2[_0x21405e(0x10e)])(aiAgreeLog_entity_1[_0x21405e(0x148)])),__metadata(_0x21405e(0x163),[typeorm_1[_0x21405e(0xc3)],typeorm_1[_0x21405e(0xc3)],typeorm_1[_0x21405e(0xc3)],typeorm_1[_0x21405e(0xc3)],typeorm_1[_0x21405e(0xc3)],typeorm_1[_0x21405e(0xc3)],userBalance_service_1['UserBalanceService'],chatLog_service_1[_0x21405e(0x175)],user_service_1[_0x21405e(0x1b2)],upload_service_1[_0x21405e(0x1e2)],badwords_service_1[_0x21405e(0x104)],autoreply_service_1[_0x21405e(0xd5)],globalConfig_service_1[_0x21405e(0x1a5)],chatGroup_service_1[_0x21405e(0x9e)],models_service_1['ModelsService'],gpts_service_1[_0x21405e(0xec)],typeorm_1[_0x21405e(0x1ca)]])],ChatgptService),exports[_0x21405e(0x1ff)]=ChatgptService;