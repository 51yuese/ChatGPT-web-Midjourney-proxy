'use strict';function _0x51e0(_0x5108b5,_0x5e6139){const _0x5b516a=_0x5b51();return _0x51e0=function(_0x51e08a,_0x3784f3){_0x51e08a=_0x51e08a-0x1de;let _0x2ddb5f=_0x5b516a[_0x51e08a];return _0x2ddb5f;},_0x51e0(_0x5108b5,_0x5e6139);}const _0x1ecdb1=_0x51e0;(function(_0x1ba4ca,_0x4c72a8){const _0x264c79=_0x51e0,_0x4d1e6e=_0x1ba4ca();while(!![]){try{const _0x1b48ef=-parseInt(_0x264c79(0x295))/0x1+parseInt(_0x264c79(0x288))/0x2*(-parseInt(_0x264c79(0x27d))/0x3)+parseInt(_0x264c79(0x1f4))/0x4+-parseInt(_0x264c79(0x1fa))/0x5*(-parseInt(_0x264c79(0x297))/0x6)+-parseInt(_0x264c79(0x1fd))/0x7*(parseInt(_0x264c79(0x311))/0x8)+parseInt(_0x264c79(0x23f))/0x9*(parseInt(_0x264c79(0x2c9))/0xa)+parseInt(_0x264c79(0x2de))/0xb;if(_0x1b48ef===_0x4c72a8)break;else _0x4d1e6e['push'](_0x4d1e6e['shift']());}catch(_0x5e24f9){_0x4d1e6e['push'](_0x4d1e6e['shift']());}}}(_0x5b51,0xad6ea));var __decorate=this&&this[_0x1ecdb1(0x20c)]||function(_0x33092d,_0x352415,_0x73c5d1,_0x3cdfb4){const _0x3819df=_0x1ecdb1;var _0x4108f1=arguments['length'],_0x3ccb6a=_0x4108f1<0x3?_0x352415:_0x3cdfb4===null?_0x3cdfb4=Object['getOwnPropertyDescriptor'](_0x352415,_0x73c5d1):_0x3cdfb4,_0x1c58f0;if(typeof Reflect===_0x3819df(0x23e)&&typeof Reflect[_0x3819df(0x235)]===_0x3819df(0x27a))_0x3ccb6a=Reflect[_0x3819df(0x235)](_0x33092d,_0x352415,_0x73c5d1,_0x3cdfb4);else{for(var _0x3da1af=_0x33092d[_0x3819df(0x271)]-0x1;_0x3da1af>=0x0;_0x3da1af--)if(_0x1c58f0=_0x33092d[_0x3da1af])_0x3ccb6a=(_0x4108f1<0x3?_0x1c58f0(_0x3ccb6a):_0x4108f1>0x3?_0x1c58f0(_0x352415,_0x73c5d1,_0x3ccb6a):_0x1c58f0(_0x352415,_0x73c5d1))||_0x3ccb6a;}return _0x4108f1>0x3&&_0x3ccb6a&&Object['defineProperty'](_0x352415,_0x73c5d1,_0x3ccb6a),_0x3ccb6a;},__metadata=this&&this[_0x1ecdb1(0x305)]||function(_0x1935ce,_0x34c953){const _0x45f572=_0x1ecdb1;if(typeof Reflect===_0x45f572(0x23e)&&typeof Reflect['metadata']===_0x45f572(0x27a))return Reflect[_0x45f572(0x249)](_0x1935ce,_0x34c953);},__param=this&&this[_0x1ecdb1(0x2ee)]||function(_0x4c0561,_0x44a0d1){return function(_0x7e1c85,_0x523cc6){_0x44a0d1(_0x7e1c85,_0x523cc6,_0x4c0561);};};Object['defineProperty'](exports,_0x1ecdb1(0x1fb),{'value':!![]}),exports[_0x1ecdb1(0x2ca)]=void 0x0;const upload_service_1=require('./../upload/upload.service'),user_service_1=require('./../user/user.service'),nestjs_config_1=require(_0x1ecdb1(0x2c2)),common_1=require(_0x1ecdb1(0x237)),FormData=require(_0x1ecdb1(0x2e9)),errorMessage_constant_1=require(_0x1ecdb1(0x294)),utils_1=require(_0x1ecdb1(0x2d5)),axios_1=require(_0x1ecdb1(0x1e4)),userBalance_service_1=require(_0x1ecdb1(0x265)),balance_constant_1=require(_0x1ecdb1(0x2b7)),chatLog_service_1=require('../chatLog/chatLog.service'),uuid=require('uuid'),config_entity_1=require(_0x1ecdb1(0x2c4)),typeorm_1=require(_0x1ecdb1(0x28f)),typeorm_2=require(_0x1ecdb1(0x2a8)),badwords_service_1=require(_0x1ecdb1(0x2cc)),autoreply_service_1=require(_0x1ecdb1(0x301)),gptKeys_entity_1=require(_0x1ecdb1(0x2e0)),globalConfig_service_1=require('../globalConfig/globalConfig.service'),whiteList_entity_1=require(_0x1ecdb1(0x1e0)),user_entity_1=require(_0x1ecdb1(0x2ff)),fanyi_service_1=require('../fanyi/fanyi.service'),dayjs=require(_0x1ecdb1(0x1fc)),app_entity_1=require('../app/app.entity'),chatGroup_service_1=require(_0x1ecdb1(0x2f8)),models_service_1=require(_0x1ecdb1(0x26f)),baidu_1=require(_0x1ecdb1(0x31b)),helper_1=require('./helper'),store_1=require(_0x1ecdb1(0x1e7)),zhipu_1=require('./zhipu'),spark_1=require(_0x1ecdb1(0x2d7)),model_constant_1=require(_0x1ecdb1(0x27f)),fs_1=require('fs'),path_1=require(_0x1ecdb1(0x25b)),COS=require(_0x1ecdb1(0x2ea));function _0x5b51(){const _0x29d469=['openaiModel3MaxTokens16kRes','getModelProxyUrl','post','Incorrect\x20API\x20key\x20provided','UserService','Logger','saveUseLog','/v1/dashboard/billing/subscription','getClientIp','total_usage','get','getHeaders','badwordsService','end','chat-error','subtract','Please\x20check\x20the\x20back-end\x20console','key不存在','腾讯云COS连接成功','删除成功','message','keyPool','gpt-4','Bearer\x20','decorate','status','@nestjs/common','openai-draw','text','formatModelToken','getKeyDetail','chatGroupService','DESC','object','18JlENEm','YYYY-MM-DD','ChatLogService','GlobalConfigService','getRandomDrawKey','close','putObject','MoreThan','weight','buildMessageFromParentMessageId','metadata','REDIS_PASSWORD','toFixed','有4的权限但是卡池没有配置、降级为3的卡池','deleteKey','REDIS_HOST','map','then','\x20key\x20->\x20','16k','redis://','DeductionKey','openaiaAtoDowngrade','还未配置腾讯云COS存储的的SecretId和SecretKey、配置后才可进行gpt文件上传操作！！！','BadwordsService','draw','请开启并配置腾讯云COS存储参数后再使用','checkBadWords','path','write','model4','parse','userBanance','is_end','stringify','openaiModel3MaxTokensRes','\x20model:\x20','ConfigService','../userBalance/userBalance.service','file','response','globalConfigService','unifiedFormattingResponse','push','YYYY年M月D日','OpenAiErrorCodeMessage','AutoreplyService','key已存在','../models/models.service','用户已在白名单中！','length','/v1/models','获取模型列表失败，请检查你的key是否正确！','Injectable','/v1/files','forEach','sendMessageFromBaidu','lockKey','includes','function','importDynamic','getConfigs','4100388jCRgSb','keyDetail','../../common/constants/model.constant','systemPreMessage','upload\x20cos','configService','userId','chatProcess','setData','getKeyList','key:\x20','2RTaPaG','tencentCosStatus','slice','data','error','deductFromBalance','affected','typeorm','当前流程所需要的模型已被管理员下架、请联系管理员上架专属模型！','XunFeiSpark','当前模型不是聊天模型、已冻结当前调用Key、请重新尝试对话！','gpt-3','../../common/constants/errorMessage.constant','373523LPKFGt','userBalanceService','94158CWjBHJ','timeoutMs','bulkCreateKey','configEntity','error:\x20','getUploadType','The\x20OpenAI\x20account\x20associated\x20with\x20this\x20API\x20key\x20has\x20been\x20deactivated.','服务异常、请重新试试吧！！！','chatLogService','修改失败','DrawService','nine-ai-default-key','nineStore','openaiModel4MaxTokens32k','user','execute','useCount\x20+\x201','@nestjs/typeorm','addOneIfOdd','GptKeysEntity','where','ModelsService','filter','Catch\x20Error\x20','sendMessageFromXunFei','\x20回复数不得大于等于模型上下文数,\x20已自动调整为\x20maxTokenRes:\x20','createReadStream','updateWhiteUser','当前模型key余额已耗尽，请充值！','createQueryBuilder','env','DALL-E2','../../common/constants/balance.constant','api','statusCode','当前模型key余额已耗尽','abort','role','HttpException','maxResponseTokens','chatgpt-nine-ai','cosRegion','当前记录不存在！','nestjs-config','catch','../globalConfig/config.entity','PAYMENT_REQUIRED','绘制图片失败，请检查你的提示词是否有非法描述！','update','Your\x20request\x20was\x20rejected\x20as\x20a\x20result\x20of\x20our\x20safety\x20system','1382730zVOkoG','ChatgptService','BAD_REQUEST','../badwords/badwords.service','signal','getGroupInfoFromId','email','assistant','查询key列表失败','model3','updateKey','https://api.openai.com','../../common/utils','key','./spark','userService','toISOString','hideString','selectKeyWithWeight','delete','cosBucket','12086338IWnDVm','本次成功添加','./gptKeys.entity','keyv','UploadService','append','super','gpt-3.5-turbo-16k-0613','提供了错误的模型秘钥、已冻结当前调用Key、请重新尝试对话！','prompt','autoreplyService','form-data','cos-nodejs-sdk-v5','request','HttpStatus','gptKeysEntity','__param','修改成功','checkUserStatus','floor','usage','application/json','reject',',\x20模型token:\x20','whiteListEntity','globalTimeoutMs','../chatGroup/chatGroup.service','@keyv/redis','InjectRepository','getRequestParams','uploaded/','debug','all','../user/user.entity','openaiBaseUrl','../autoreply/autoreply.service','/v1','appEntity','base64','__metadata','purpose','getCurrentModelKeyInfo','split','getRandomGptKeyDetail','save','getTencentCOSStorage','uploadService','maxModelTokens','from','size','application/octet-stream;\x20charset=utf-8','93888kBxOGI','sendMessage','model','default','cosApi','conversationId','saveChatLog','Location','&end_date=','未配置[卡池3]的有效key、请先前往后台系统配置！','./baidu','CHAT_TYPE','id\x20=\x20:id','./whiteList.entity','validateBalance','openaiTimeoutMs','openaiModel3MaxTokens','axios','filename','modelsService','./store','preset','find','queryUserBalance','getAllKeyList','openaiModel4MaxTokens32kRes','getUuid','keyStatus','getUserWhiteList','UserBalanceService','draw\x20paompt\x20info\x20<======*******======>\x20','getGptModelList','修改白名单失败','4194724CDQLHJ','findAndCount','PAINT_TYPE','assign','未配置有效key、请先前往后台系统配置！','toLowerCase','360DQUbTT','__esModule','dayjs','658fFinoc','modelInfo','apiKey','addWhiteUser','userEntity','compileNetwork','绘制图片失败，请稍后试试吧！','ChatGptService','Content-type','onModuleInit','当前模型不是聊天模型','getBaseConfig','/v1/images/generations','修改白名单成功','openaiProxyUrl','__decorate','findOne','config','Repository','log','resolve','绘制图片失败，此次绘画被拒绝了！','username','extname','getModelAndKeyFromUser','defaultBaseUrl','b64_json','format','MODEL_LIST',',\x20最大回复token:\x20','checkAutoReply','\x0a\x20Respond\x20using\x20markdown.\x20\x0a\x20Current\x20date:\x20'];_0x5b51=function(){return _0x29d469;};return _0x5b51();}let ChatgptService=class ChatgptService{constructor(_0x527292,_0x2cc7ad,_0x435c69,_0x51ba9c,_0xa7ce41,_0x48b91d,_0x2cb51f,_0x3f477e,_0x1b64f6,_0x2f09c9,_0x1ed9aa,_0x50df82,_0x21697f,_0x48656f,_0x42d143,_0x5b1738){const _0x1d9e4e=_0x1ecdb1;this[_0x1d9e4e(0x201)]=_0x527292,this[_0x1d9e4e(0x2ed)]=_0x2cc7ad,this[_0x1d9e4e(0x29a)]=_0x435c69,this[_0x1d9e4e(0x2f6)]=_0x51ba9c,this[_0x1d9e4e(0x303)]=_0xa7ce41,this[_0x1d9e4e(0x282)]=_0x48b91d,this[_0x1d9e4e(0x296)]=_0x2cb51f,this[_0x1d9e4e(0x29f)]=_0x3f477e,this[_0x1d9e4e(0x2d8)]=_0x1b64f6,this[_0x1d9e4e(0x30c)]=_0x2f09c9,this[_0x1d9e4e(0x229)]=_0x1ed9aa,this[_0x1d9e4e(0x2e8)]=_0x50df82,this[_0x1d9e4e(0x268)]=_0x21697f,this['fanyiService']=_0x48656f,this[_0x1d9e4e(0x23c)]=_0x42d143,this[_0x1d9e4e(0x1e6)]=_0x5b1738,this['defaultBaseUrl']=_0x1d9e4e(0x2d4),this[_0x1d9e4e(0x2a3)]=null,this['keyPool']={'list3':[],'list4':[]};}async[_0x1ecdb1(0x206)](){const _0x232e02=_0x1ecdb1;let _0x174c02=await(0x0,utils_1[_0x232e02(0x27b)])(_0x232e02(0x2bf)),_0x342ad0=await(0x0,utils_1[_0x232e02(0x27b)])(_0x232e02(0x2f9)),_0x1793b9=await(0x0,utils_1[_0x232e02(0x27b)])(_0x232e02(0x2e1));_0x174c02=(_0x174c02===null||_0x174c02===void 0x0?void 0x0:_0x174c02[_0x232e02(0x314)])?_0x174c02[_0x232e02(0x314)]:_0x174c02,_0x342ad0=(_0x342ad0===null||_0x342ad0===void 0x0?void 0x0:_0x342ad0[_0x232e02(0x314)])?_0x342ad0[_0x232e02(0x314)]:_0x342ad0,_0x1793b9=(_0x1793b9===null||_0x1793b9===void 0x0?void 0x0:_0x1793b9[_0x232e02(0x314)])?_0x1793b9[_0x232e02(0x314)]:_0x1793b9;const {ChatGPTAPI:_0x36ce55,ChatGPTError:_0x24205,ChatGPTUnofficialProxyAPI:_0xf7db3b}=_0x174c02,_0x390f0a=+process['env']['REDIS_PORT'],_0x3ab3b2=process['env'][_0x232e02(0x24e)],_0x2d0714=process['env'][_0x232e02(0x24a)],_0x221d93=process[_0x232e02(0x2b5)]['REDIS_USER'],_0x36e3eb=_0x232e02(0x253)+(_0x221d93||'')+':'+(_0x2d0714||'')+'@'+_0x3ab3b2+':'+_0x390f0a,_0x14d5fc=new _0x342ad0(_0x36e3eb),_0x3a0064=new _0x1793b9({'store':_0x14d5fc,'namespace':'nineai-chatlog'});this['nineStore']=new store_1['NineStore']({'store':_0x3a0064,'namespace':'chat'}),this[_0x232e02(0x2b8)]=new _0x36ce55({'apiKey':_0x232e02(0x2a2),'apiBaseUrl':this[_0x232e02(0x216)]+'/v1','messageStore':_0x3a0064}),await this[_0x232e02(0x30b)](!![]);}async['getTencentCOSStorage'](_0x4d89f2=![]){const _0x3caac7=_0x1ecdb1,{cosSecretId:_0x263113,cosSecretKey:_0x3cc36c}=await this[_0x3caac7(0x268)]['getConfigs'](['cosSecretId','cosSecretKey']);if(!_0x263113||!_0x3cc36c)return common_1[_0x3caac7(0x222)][_0x3caac7(0x28c)](_0x3caac7(0x256),_0x3caac7(0x204));this[_0x3caac7(0x315)]=new COS({'SecretId':_0x263113,'SecretKey':_0x3cc36c}),common_1[_0x3caac7(0x222)][_0x3caac7(0x210)](_0x3caac7(0x22f));}async['getRandomGptKeyDetail'](_0x1e138a){const _0x5d755a=_0x1ecdb1,{list3:_0x26b7da,list4:_0xa30307}=this['keyPool'];if(_0x26b7da[_0x5d755a(0x271)]===0x0&&_0xa30307[_0x5d755a(0x271)]===0x0)throw new common_1[(_0x5d755a(0x2bd))](_0x5d755a(0x1f8),common_1[_0x5d755a(0x2ec)][_0x5d755a(0x2cb)]);if(_0x1e138a===0x3){if(_0x26b7da[_0x5d755a(0x271)]===0x0)throw new common_1[(_0x5d755a(0x2bd))](_0x5d755a(0x31a),common_1['HttpStatus'][_0x5d755a(0x2cb)]);return(0x0,utils_1[_0x5d755a(0x2db)])(_0x26b7da);}if(_0x1e138a===0x4){if(_0xa30307[_0x5d755a(0x271)]===0x0){const _0xa261ab=await this[_0x5d755a(0x268)][_0x5d755a(0x27c)]([_0x5d755a(0x255)]);if(Number(_0xa261ab)!==0x1)throw new common_1[(_0x5d755a(0x2bd))]('未配置[卡池4]的有效key、请先前往后台系统配置！',common_1[_0x5d755a(0x2ec)][_0x5d755a(0x2cb)]);common_1[_0x5d755a(0x222)][_0x5d755a(0x28c)](_0x5d755a(0x24c));if(_0x26b7da['length']===0x0)throw new common_1[(_0x5d755a(0x2bd))](_0x5d755a(0x1f8),common_1[_0x5d755a(0x2ec)]['BAD_REQUEST']);else return(0x0,utils_1[_0x5d755a(0x2db)])(_0x26b7da);}else return(0x0,utils_1['selectKeyWithWeight'])(_0xa30307);}}async[_0x1ecdb1(0x2fb)](_0x4bbede,_0xa7cff0,_0x3ff07c,_0x25a940){const _0x23ea76=_0x1ecdb1;!_0x25a940&&(_0x25a940=await this[_0x23ea76(0x1e6)][_0x23ea76(0x208)]());const {timeout:timeout=0x3c}=_0x3ff07c,{topN:_0x168e81,model:_0xef434}=_0x25a940,{parentMessageId:parentMessageId=0x0}=_0x4bbede,_0x2b87a9=await this[_0x23ea76(0x268)][_0x23ea76(0x27c)]([_0x23ea76(0x1e2)]),_0x15d2a7=timeout*0x3e8||_0x2b87a9||0x64*0x3e8;common_1['Logger'][_0x23ea76(0x210)](_0x15d2a7,_0x23ea76(0x298)),common_1[_0x23ea76(0x222)][_0x23ea76(0x210)](_0x2b87a9,_0x23ea76(0x2f7));const _0x4a3aba={'parentMessageId':parentMessageId,'timeoutMs':+_0x15d2a7,'completionParams':{'model':_0xef434,'temperature':_0x168e81}};return _0xa7cff0&&(_0x4a3aba['systemMessage']=_0xa7cff0),_0x4a3aba;}async[_0x1ecdb1(0x284)](_0x1da6a7,_0x209c4a,_0x2af5b0){const _0x2da248=_0x1ecdb1,_0x50dad6=_0x209c4a['abortController'],{options:options={},appId:_0x57b0b8,cusromPrompt:_0x6b8f1a,systemMessage:systemMessage=''}=_0x1da6a7;let _0x40c9ad=systemMessage;const {parentMessageId:_0x1af856}=options,{prompt:_0xa6e04e}=_0x1da6a7,{groupId:_0x470b10,usingNetwork:_0x43092e}=options,_0x4c662f=await this['chatGroupService'][_0x2da248(0x2ce)](_0x470b10),_0x4f8701=(_0x4c662f===null||_0x4c662f===void 0x0?void 0x0:_0x4c662f[_0x2da248(0x20e)])?JSON[_0x2da248(0x25e)](_0x4c662f[_0x2da248(0x20e)]):await this[_0x2da248(0x1e6)]['getBaseConfig'](),{keyType:_0x2cf2d3,model:_0x3b6906,topN:_0x31cb51,systemMessage:_0x188692,rounds:_0x4e8ab1}=_0x4f8701[_0x2da248(0x1fe)];let _0x51094d=null;!_0x6b8f1a?_0x51094d=await this[_0x2da248(0x1e6)][_0x2da248(0x307)](_0x3b6906):_0x51094d=await this[_0x2da248(0x1e6)]['getRandomDrawKey']();if(!_0x51094d)throw new common_1[(_0x2da248(0x2bd))](_0x2da248(0x290),common_1['HttpStatus'][_0x2da248(0x2cb)]);const {deduct:_0xee9983,deductType:_0x5cedfd,key:_0x1cd198,secret:_0x5e1271,modelName:_0x3ab029,id:_0x21122f,accessToken:_0x3afc5d}=_0x51094d;await this[_0x2da248(0x2d8)]['checkUserStatus'](_0x209c4a[_0x2da248(0x2a5)]),await this[_0x2da248(0x296)][_0x2da248(0x1e1)](_0x209c4a,_0x5cedfd===0x1?_0x2da248(0x2d2):_0x2da248(0x25d),_0xee9983),_0x2af5b0&&_0x2af5b0['setHeader'](_0x2da248(0x205),_0x2da248(0x310)),await this['badwordsService'][_0x2da248(0x25a)](_0xa6e04e,_0x209c4a[_0x2da248(0x2a5)]['id']);const _0x4f4977=await this[_0x2da248(0x2e8)][_0x2da248(0x21b)](_0xa6e04e);if(_0x4f4977&&_0x2af5b0){const _0x5676c5={'message':_0x4f4977,'code':0x1f4};return _0x2af5b0['write'](JSON['stringify'](_0x5676c5)),_0x2af5b0[_0x2da248(0x22a)]();}if(_0x57b0b8){const _0x345aac=await this[_0x2da248(0x303)][_0x2da248(0x20d)]({'where':{'id':_0x57b0b8,'status':(0x0,typeorm_1['In'])([0x1,0x3,0x4,0x5])}});if(!_0x345aac)throw new common_1[(_0x2da248(0x2bd))]('你当前使用的应用已被下架、请删除当前对话开启新的对话吧！',common_1['HttpStatus'][_0x2da248(0x2cb)]);_0x345aac[_0x2da248(0x1e8)]&&(_0x40c9ad=_0x345aac[_0x2da248(0x1e8)]);}else{if(_0x6b8f1a)_0x40c9ad=systemMessage;else{if(_0x188692)_0x40c9ad=_0x188692;else{const _0x4c2022=new Date()[_0x2da248(0x2d9)]()['split']('T')[0x0],_0x3b71bc=await this['globalConfigService']['getConfigs'](['systemPreMessage']);_0x40c9ad=_0x3b71bc+('\x0a\x20Respond\x20using\x20markdown.\x20\x0a\x20Current\x20date:\x20'+_0x4c2022);}}}let _0x556e86='';if(_0x43092e){_0x556e86=await(0x0,utils_1[_0x2da248(0x202)])(_0xa6e04e);const _0x285a87=new Date()[_0x2da248(0x2d9)]()['split']('T')[0x0],_0x5c204d=await this[_0x2da248(0x268)][_0x2da248(0x27c)]([_0x2da248(0x280)]);_0x40c9ad=_0x5c204d+(_0x2da248(0x21c)+_0x285a87);}const _0x1f5182=await this[_0x2da248(0x2fb)](options,_0x40c9ad,_0x51094d,_0x4f8701[_0x2da248(0x1fe)]),{maxModelTokens:maxModelTokens=0x1f40,maxResponseTokens:maxResponseTokens=0x1000,key:_0x1df947}=_0x51094d,_0x2d5f15=await this[_0x2da248(0x21e)](_0x51094d);this['api'][_0x2da248(0x1ff)]=(0x0,utils_1['removeSpecialCharacters'])(_0x1df947),this[_0x2da248(0x2b8)]['apiBaseUrl']=_0x2d5f15+_0x2da248(0x302),this[_0x2da248(0x2b8)][_0x2da248(0x30d)]=maxModelTokens,this[_0x2da248(0x2b8)][_0x2da248(0x2be)]=maxResponseTokens>=maxModelTokens?Math['abs'](Math[_0x2da248(0x2f1)](maxModelTokens/0x2)):maxResponseTokens,_0x2af5b0&&_0x2af5b0[_0x2da248(0x236)](0xc8);let _0x58c94a=null,_0x5b1333=null;try{if(_0x2af5b0){let _0x2261c9=null,_0x362f66=![];_0x2af5b0['on'](_0x2da248(0x244),async()=>{const _0x37c40b=_0x2da248;if(_0x362f66)return;_0x50dad6[_0x37c40b(0x2bb)]();const _0x3f691c=await this[_0x37c40b(0x2b8)]['getTokenCount'](_0xa6e04e)||0x0,_0x5e4dd0=await this['api']['getTokenCount']((_0x2261c9===null||_0x2261c9===void 0x0?void 0x0:_0x2261c9[_0x37c40b(0x239)])||''),_0x16b254=_0x3f691c+_0x5e4dd0,_0x238b26=(0x0,utils_1[_0x37c40b(0x225)])(_0x209c4a);await this[_0x37c40b(0x29f)]['saveChatLog']({'appId':_0x57b0b8,'curIp':_0x238b26,'userId':_0x209c4a[_0x37c40b(0x2a5)]['id'],'type':balance_constant_1['DeductionKey'][_0x37c40b(0x1de)],'prompt':_0xa6e04e,'answer':'','promptTokens':_0x3f691c,'completionTokens':0x0,'totalTokens':_0x3f691c,'model':_0x3b6906,'role':'user','groupId':_0x470b10,'requestOptions':JSON[_0x37c40b(0x261)]({'options':null,'prompt':_0xa6e04e})}),await this[_0x37c40b(0x29f)][_0x37c40b(0x317)]({'appId':_0x57b0b8,'curIp':_0x238b26,'userId':_0x209c4a[_0x37c40b(0x2a5)]['id'],'type':balance_constant_1[_0x37c40b(0x254)][_0x37c40b(0x1de)],'prompt':_0xa6e04e,'answer':_0x2261c9===null||_0x2261c9===void 0x0?void 0x0:_0x2261c9[_0x37c40b(0x239)],'promptTokens':_0x3f691c,'completionTokens':_0x5e4dd0,'totalTokens':_0x16b254,'model':_0x3b6906,'role':_0x37c40b(0x2d0),'groupId':_0x470b10,'requestOptions':JSON[_0x37c40b(0x261)]({'options':{'model':_0x3b6906,'temperature':_0x31cb51},'prompt':_0xa6e04e}),'conversationOptions':JSON['stringify']({'conversationId':_0x2261c9===null||_0x2261c9===void 0x0?void 0x0:_0x2261c9['conversationId'],'model':_0x3b6906,'parentMessageId':_0x2261c9===null||_0x2261c9===void 0x0?void 0x0:_0x2261c9['id'],'temperature':_0x31cb51})}),await this['userBalanceService'][_0x37c40b(0x28d)](_0x209c4a['user']['id'],_0x37c40b(0x313)+(_0x5cedfd===0x1?0x3:0x4),0x1,_0x16b254);}),_0x2af5b0['on'](_0x2da248(0x28c),_0x4c9e96=>{const _0x35eb4e=_0x2da248;console[_0x35eb4e(0x210)](_0x4c9e96);});if(Number(_0x2cf2d3)===0x1){let _0x986fa8=!![];_0x58c94a=await this[_0x2da248(0x2b8)][_0x2da248(0x312)](_0x43092e?_0x556e86:_0xa6e04e,Object[_0x2da248(0x1f7)](Object[_0x2da248(0x1f7)]({},_0x1f5182),{'onProgress':_0x5a6870=>{const _0x20ee9f=_0x2da248;_0x2af5b0[_0x20ee9f(0x25c)](_0x986fa8?JSON[_0x20ee9f(0x261)](_0x5a6870):'\x0a'+JSON[_0x20ee9f(0x261)](_0x5a6870)),_0x986fa8=![],_0x2261c9=_0x5a6870;},'abortSignal':_0x50dad6[_0x2da248(0x2cd)]})),_0x362f66=!![];}if(Number(_0x2cf2d3)===0x2){let _0x405294=!![];const _0x88e914=await this['nineStore']['buildMessageFromParentMessageId'](_0x43092e?_0x556e86:_0xa6e04e,{'parentMessageId':_0x1af856,'maxRounds':(0x0,helper_1[_0x2da248(0x2a9)])(_0x4e8ab1)});_0x58c94a=await(0x0,baidu_1[_0x2da248(0x277)])(_0x43092e?_0x556e86:_0x88e914,{'temperature':_0x31cb51,'accessToken':_0x3afc5d,'model':_0x3b6906,'onProgress':_0x3f2a40=>{const _0x9e9dfa=_0x2da248;_0x2af5b0[_0x9e9dfa(0x25c)](_0x405294?JSON['stringify'](_0x3f2a40):'\x0a'+JSON[_0x9e9dfa(0x261)](_0x3f2a40)),_0x405294=![],_0x2261c9=_0x3f2a40;}}),_0x362f66=!![];}if(Number(_0x2cf2d3)===0x3){let _0xf0994c=!![];const _0x380761=await this[_0x2da248(0x2a3)][_0x2da248(0x248)](_0x43092e?_0x556e86:_0xa6e04e,{'parentMessageId':_0x1af856,'maxRounds':(0x0,helper_1[_0x2da248(0x2a9)])(_0x4e8ab1)});_0x58c94a=await(0x0,zhipu_1['sendMessageFromZhipu'])(_0x43092e?_0x556e86:_0x380761,{'temperature':_0x31cb51,'key':_0x1df947,'model':_0x3b6906,'onProgress':_0xd4e502=>{const _0x57a2bf=_0x2da248;_0x2af5b0['write'](_0xf0994c?JSON['stringify'](_0xd4e502):'\x0a'+JSON[_0x57a2bf(0x261)](_0xd4e502)),_0xf0994c=![],_0x2261c9=_0xd4e502;}}),_0x362f66=!![];}if(Number(_0x2cf2d3)===0x4){let _0x4730c5=!![];const {key:_0x45463b,appid:_0x29a899,secret:_0x307d2c,model:_0x8ef742}=_0x51094d,_0x34056f=await this['nineStore']['buildMessageFromParentMessageId'](_0x43092e?_0x556e86:_0xa6e04e,{'parentMessageId':_0x1af856,'maxRounds':(0x0,helper_1[_0x2da248(0x2a9)])(_0x4e8ab1)}),_0x2b29b2=new spark_1[(_0x2da248(0x291))]({'appid':_0x29a899,'secret':_0x307d2c,'key':_0x45463b});_0x58c94a=await _0x2b29b2[_0x2da248(0x2af)](_0x43092e?_0x556e86:_0x34056f,{'temperature':_0x31cb51,'model':_0x8ef742,'onProgress':_0x51ef80=>{const _0x2303a1=_0x2da248;_0x2af5b0[_0x2303a1(0x25c)](_0x4730c5?JSON[_0x2303a1(0x261)](_0x51ef80):'\x0a'+JSON[_0x2303a1(0x261)](_0x51ef80)),_0x4730c5=![],_0x2261c9=_0x51ef80;},'abortController':_0x50dad6}),_0x362f66=!![];}const _0x14579f={'id':this[_0x2da248(0x2a3)][_0x2da248(0x1ed)](),'text':_0xa6e04e,'role':_0x2da248(0x2a5),'name':undefined,'usage':null,'parentMessageId':_0x1af856,'conversationId':(_0x58c94a===null||_0x58c94a===void 0x0?void 0x0:_0x58c94a['conversationId'])||null};_0x5b1333={'model':_0x3b6906,'parentMessageId':_0x1af856},await this[_0x2da248(0x2a3)][_0x2da248(0x285)](_0x14579f);const _0x5f3eae={'id':(_0x58c94a===null||_0x58c94a===void 0x0?void 0x0:_0x58c94a['id'])||this['nineStore'][_0x2da248(0x1ed)](),'text':_0x58c94a['text'],'role':_0x2da248(0x2d0),'name':undefined,'usage':_0x58c94a[_0x2da248(0x2f2)],'parentMessageId':_0x14579f['id'],'conversationId':_0x58c94a===null||_0x58c94a===void 0x0?void 0x0:_0x58c94a[_0x2da248(0x316)]};await this['nineStore'][_0x2da248(0x285)](_0x5f3eae),_0x5b1333={'model':_0x3b6906,'parentMessageId':_0x14579f['id']};}else _0x58c94a=await this[_0x2da248(0x2b8)][_0x2da248(0x312)](_0x43092e?_0x556e86:_0xa6e04e,_0x1f5182);const _0x26d10b=(0x0,helper_1[_0x2da248(0x269)])(_0x2cf2d3,_0x58c94a,_0x5b1333),{prompt_tokens:prompt_tokens=0x0,completion_tokens:completion_tokens=0x0,total_tokens:total_tokens=0x0}=_0x26d10b[_0x2da248(0x2f2)];await this[_0x2da248(0x296)][_0x2da248(0x28d)](_0x209c4a[_0x2da248(0x2a5)]['id'],'model'+(_0x5cedfd===0x1?0x3:0x4),_0xee9983,total_tokens),await this[_0x2da248(0x1e6)][_0x2da248(0x223)](_0x21122f,total_tokens);const _0x59e2c=(0x0,utils_1[_0x2da248(0x225)])(_0x209c4a);await this[_0x2da248(0x29f)]['saveChatLog']({'appId':_0x57b0b8,'curIp':_0x59e2c,'userId':_0x209c4a[_0x2da248(0x2a5)]['id'],'type':balance_constant_1[_0x2da248(0x254)][_0x2da248(0x1de)],'prompt':_0xa6e04e,'answer':'','promptTokens':prompt_tokens,'completionTokens':0x0,'totalTokens':total_tokens,'model':_0x26d10b[_0x2da248(0x313)],'role':_0x2da248(0x2a5),'groupId':_0x470b10,'requestOptions':JSON[_0x2da248(0x261)]({'options':null,'prompt':_0xa6e04e})}),await this['chatLogService'][_0x2da248(0x317)]({'appId':_0x57b0b8,'curIp':_0x59e2c,'userId':_0x209c4a[_0x2da248(0x2a5)]['id'],'type':balance_constant_1[_0x2da248(0x254)][_0x2da248(0x1de)],'prompt':_0xa6e04e,'answer':_0x26d10b===null||_0x26d10b===void 0x0?void 0x0:_0x26d10b[_0x2da248(0x239)],'promptTokens':prompt_tokens,'completionTokens':completion_tokens,'totalTokens':total_tokens,'model':_0x3b6906,'role':_0x2da248(0x2d0),'groupId':_0x470b10,'requestOptions':JSON[_0x2da248(0x261)]({'options':{'model':_0x3b6906,'temperature':_0x31cb51},'prompt':_0xa6e04e}),'conversationOptions':JSON['stringify']({'conversationId':_0x58c94a['conversationId'],'model':_0x3b6906,'parentMessageId':_0x58c94a['id'],'temperature':_0x31cb51})}),common_1[_0x2da248(0x222)][_0x2da248(0x2fd)]('本次调用:\x20'+_0x209c4a[_0x2da248(0x2a5)]['id']+_0x2da248(0x263)+_0x3b6906+_0x2da248(0x251)+_0x1df947+',\x20模型名称:\x20'+_0x3ab029+_0x2da248(0x2f5)+maxModelTokens+_0x2da248(0x21a)+maxResponseTokens,_0x2da248(0x2ca));const _0x151c8b=await this[_0x2da248(0x296)][_0x2da248(0x1ea)](_0x209c4a[_0x2da248(0x2a5)]['id']);return _0x58c94a[_0x2da248(0x25f)]=Object[_0x2da248(0x1f7)]({},_0x151c8b),_0x58c94a['result']&&(_0x58c94a['result']=''),_0x58c94a[_0x2da248(0x260)]=!![],_0x2af5b0?_0x2af5b0['write']('\x0a'+JSON['stringify'](_0x58c94a)):_0x58c94a['text'];}catch(_0x211cdc){console[_0x2da248(0x210)](_0x2da248(0x22b),_0x1cd198,_0x211cdc);const _0x10f0d6=_0x211cdc['statusCode'];if(_0x211cdc['status']&&_0x211cdc['status']===0x192){const _0x4660c5={'message':_0x2da248(0x2ae)+_0x211cdc[_0x2da248(0x231)],'code':0x192};if(_0x2af5b0)return _0x2af5b0[_0x2da248(0x25c)](JSON['stringify'](_0x4660c5));else throw new common_1['HttpException'](_0x211cdc['message'],common_1[_0x2da248(0x2ec)][_0x2da248(0x2c5)]);}if(!_0x10f0d6){if(_0x2af5b0)return _0x2af5b0['write'](JSON[_0x2da248(0x261)]({'message':_0x211cdc['message'],'code':0x1f4}));else throw new common_1[(_0x2da248(0x2bd))](_0x211cdc[_0x2da248(0x231)],common_1[_0x2da248(0x2ec)][_0x2da248(0x2cb)]);}let _0x2b07c5=errorMessage_constant_1[_0x2da248(0x26c)][_0x10f0d6]?errorMessage_constant_1[_0x2da248(0x26c)][_0x10f0d6]:_0x2da248(0x29e);(_0x211cdc===null||_0x211cdc===void 0x0?void 0x0:_0x211cdc[_0x2da248(0x231)][_0x2da248(0x279)](_0x2da248(0x29d)))&&Number(_0x2cf2d3)===0x1&&(await this['modelsService']['lockKey'](_0x21122f,'当前模型key已被封禁、已冻结当前调用Key、尝试重新对话试试吧！',-0x1),_0x2b07c5='当前模型key已被封禁');(_0x211cdc===null||_0x211cdc===void 0x0?void 0x0:_0x211cdc[_0x2da248(0x2b9)])===0x1ad&&_0x211cdc['message'][_0x2da248(0x279)]('You\x20exceeded\x20your\x20current\x20quota,\x20please\x20check\x20your\x20plan\x20and\x20billing\x20details.')&&Number(_0x2cf2d3)===0x1&&(await this[_0x2da248(0x1e6)][_0x2da248(0x278)](_0x21122f,'当前模型key余额已耗尽、已冻结当前调用Key、尝试重新对话试试吧！',-0x3),_0x2b07c5=_0x2da248(0x2ba));(_0x211cdc===null||_0x211cdc===void 0x0?void 0x0:_0x211cdc[_0x2da248(0x2b9)])===0x191&&_0x211cdc[_0x2da248(0x231)][_0x2da248(0x279)](_0x2da248(0x220))&&Number(_0x2cf2d3)===0x1&&(await this['modelsService'][_0x2da248(0x278)](_0x21122f,'提供了错误的模型秘钥',-0x2),_0x2b07c5=_0x2da248(0x2e6));(_0x211cdc===null||_0x211cdc===void 0x0?void 0x0:_0x211cdc[_0x2da248(0x2b9)])===0x191&&_0x211cdc[_0x2da248(0x231)][_0x2da248(0x279)]('Unauthorized')&&Number(_0x2cf2d3)===0x1&&(await this[_0x2da248(0x1e6)]['lockKey'](_0x21122f,_0x2da248(0x2ba),-0x2),_0x2b07c5=_0x2da248(0x2b3));(_0x211cdc===null||_0x211cdc===void 0x0?void 0x0:_0x211cdc[_0x2da248(0x2b9)])===0x194&&_0x211cdc[_0x2da248(0x231)][_0x2da248(0x279)]('This\x20is\x20not\x20a\x20chat\x20model\x20and\x20thus\x20not\x20supported')&&Number(_0x2cf2d3)===0x1&&(await this['modelsService']['lockKey'](_0x21122f,_0x2da248(0x207),-0x4),_0x2b07c5=_0x2da248(0x292));_0x10f0d6===0x190&&console[_0x2da248(0x210)]('400\x20error',_0x211cdc,_0x211cdc[_0x2da248(0x231)]);const _0x85178c={'message':_0x2b07c5||_0x2da248(0x22d),'code':_0x10f0d6===0x191?0x191:_0x10f0d6||0x1f4};if(_0x2af5b0)return _0x2af5b0['write'](JSON[_0x2da248(0x261)](_0x85178c));else throw new common_1[(_0x2da248(0x2bd))](_0x85178c['message'],common_1['HttpStatus'][_0x2da248(0x2cb)]);}finally{_0x2af5b0&&_0x2af5b0[_0x2da248(0x22a)]();}}async[_0x1ecdb1(0x258)](_0x321a5b,_0x27e293){const _0x3a09bd=_0x1ecdb1;var _0xf77650,_0x5169aa,_0x404088,_0x4b215b;await this['badwordsService'][_0x3a09bd(0x25a)](_0x321a5b['prompt'],_0x27e293[_0x3a09bd(0x2a5)]['id']),common_1[_0x3a09bd(0x222)][_0x3a09bd(0x210)](_0x3a09bd(0x1f1)+_0x321a5b[_0x3a09bd(0x2e7)],_0x3a09bd(0x2a1)),await this['userService'][_0x3a09bd(0x2f0)](_0x27e293[_0x3a09bd(0x2a5)]),await this[_0x3a09bd(0x296)][_0x3a09bd(0x1e1)](_0x27e293,balance_constant_1['DeductionKey'][_0x3a09bd(0x1f6)],_0x321a5b['n']||0x1);let _0x11a0b5=[];const _0x1ff4d5=await this[_0x3a09bd(0x1e6)][_0x3a09bd(0x243)](),{key:_0x12cdec,proxyUrl:_0x45b116}=await this[_0x3a09bd(0x23a)](_0x1ff4d5),_0x3f4aea=_0x45b116+_0x3a09bd(0x209);try{const _0x4ec6f0=await axios_1['default'][_0x3a09bd(0x21f)](_0x3f4aea,Object['assign'](Object[_0x3a09bd(0x1f7)]({},_0x321a5b),{'response_format':'b64_json'}),{'headers':{'Authorization':_0x3a09bd(0x234)+_0x12cdec}});_0x11a0b5=_0x4ec6f0[_0x3a09bd(0x28b)][_0x3a09bd(0x28b)];}catch(_0x5df972){console[_0x3a09bd(0x210)](_0x3a09bd(0x238),_0x5df972);const _0x21d828=((_0xf77650=_0x5df972===null||_0x5df972===void 0x0?void 0x0:_0x5df972[_0x3a09bd(0x267)])===null||_0xf77650===void 0x0?void 0x0:_0xf77650[_0x3a09bd(0x236)])||0x1f4,_0x5408ec=(_0x4b215b=(_0x404088=(_0x5169aa=_0x5df972===null||_0x5df972===void 0x0?void 0x0:_0x5df972[_0x3a09bd(0x267)])===null||_0x5169aa===void 0x0?void 0x0:_0x5169aa[_0x3a09bd(0x28b)])===null||_0x404088===void 0x0?void 0x0:_0x404088['error'])===null||_0x4b215b===void 0x0?void 0x0:_0x4b215b[_0x3a09bd(0x231)];if(_0x21d828===0x1ad)throw new common_1[(_0x3a09bd(0x2bd))]('当前请求已过载、请稍等会儿再试试吧！',common_1[_0x3a09bd(0x2ec)][_0x3a09bd(0x2cb)]);if(_0x21d828===0x190||_0x5408ec[_0x3a09bd(0x279)](_0x3a09bd(0x2c8)))throw new common_1['HttpException']('您的请求已被系统拒绝。您的提示可能存在一些非法的文本。',common_1[_0x3a09bd(0x2ec)][_0x3a09bd(0x2cb)]);if(_0x21d828===0x1f4)throw new common_1[(_0x3a09bd(0x2bd))](_0x3a09bd(0x2c6),common_1[_0x3a09bd(0x2ec)][_0x3a09bd(0x2cb)]);if(_0x21d828===0x191)throw new common_1['HttpException'](_0x3a09bd(0x212),common_1[_0x3a09bd(0x2ec)][_0x3a09bd(0x2cb)]);throw new common_1[(_0x3a09bd(0x2bd))](_0x3a09bd(0x203),common_1[_0x3a09bd(0x2ec)]['BAD_REQUEST']);}const _0x5f12f3=[];for(const _0x9729f7 of _0x11a0b5){const _0x3d29a7=uuid['v4']()[_0x3a09bd(0x28a)](0x0,0xa)+'.png',_0x468105=Buffer[_0x3a09bd(0x30e)](_0x9729f7[_0x3a09bd(0x217)],_0x3a09bd(0x304));_0x5f12f3[_0x3a09bd(0x26a)](this[_0x3a09bd(0x30c)]['uploadFile']({'filename':_0x3d29a7,'buffer':_0x468105}));}const _0x26fc8b=await Promise['all'](_0x5f12f3);await this[_0x3a09bd(0x296)][_0x3a09bd(0x28d)](_0x27e293[_0x3a09bd(0x2a5)]['id'],'model3',_0x321a5b['n'],_0x321a5b['n']||0x1);const _0x2f3a69=(0x0,utils_1['getClientIp'])(_0x27e293),_0x373385=[],_0x29f780=await this[_0x3a09bd(0x30c)][_0x3a09bd(0x29c)](),[_0x5eb785,_0x2ba62f]=_0x321a5b[_0x3a09bd(0x30f)][_0x3a09bd(0x308)]('x');return _0x26fc8b[_0x3a09bd(0x276)](_0x3767ab=>{const _0x3dbe6f=_0x3a09bd;_0x373385[_0x3dbe6f(0x26a)](this[_0x3dbe6f(0x29f)][_0x3dbe6f(0x317)]({'curIp':_0x2f3a69,'userId':_0x27e293[_0x3dbe6f(0x2a5)]['id'],'type':balance_constant_1[_0x3dbe6f(0x254)][_0x3dbe6f(0x1f6)],'prompt':_0x321a5b['prompt'],'answer':_0x3767ab,'fileInfo':JSON[_0x3dbe6f(0x261)]({'cosType':_0x29f780,'width':_0x5eb785,'height':_0x2ba62f,'cosUrl':_0x3767ab}),'promptTokens':0x0,'completionTokens':0x0,'totalTokens':0x0,'model':_0x3dbe6f(0x2b6)}));}),await Promise[_0x3a09bd(0x2fe)](_0x373385),_0x26fc8b;}async[_0x1ecdb1(0x23b)](_0x5e04ac){const _0x4a76cf=_0x1ecdb1;var _0x589c5f;const _0x1c1c37=await this[_0x4a76cf(0x268)][_0x4a76cf(0x27c)]([_0x4a76cf(0x300)])||'https://api.openai.com';try{const _0x213f46={'Content-Type':_0x4a76cf(0x2f3),'Authorization':'Bearer\x20'+_0x5e04ac},_0x48814e=dayjs()[_0x4a76cf(0x218)]('YYYY-MM-DD'),_0x572f49=dayjs()[_0x4a76cf(0x22c)](0x63,'day')[_0x4a76cf(0x218)](_0x4a76cf(0x240)),_0x5d4017=await axios_1[_0x4a76cf(0x314)][_0x4a76cf(0x227)](_0x1c1c37+'/v1/dashboard/billing/usage?start_date='+_0x572f49+_0x4a76cf(0x319)+_0x48814e,{'headers':_0x213f46}),_0x3e3e68=(_0x589c5f=_0x5d4017===null||_0x5d4017===void 0x0?void 0x0:_0x5d4017['data'][_0x4a76cf(0x226)])!==null&&_0x589c5f!==void 0x0?_0x589c5f:0x0,_0x1be027=await axios_1[_0x4a76cf(0x314)][_0x4a76cf(0x227)](_0x1c1c37+_0x4a76cf(0x224),{'headers':_0x213f46}),{has_payment_method:_0x2b99fb,hard_limit_usd:_0x42c963,access_until:_0x2738d7}=_0x1be027['data'],_0xb9915d=(_0x3e3e68/0x64)[_0x4a76cf(0x24b)](0x2),_0x8dafd3=Number(_0x42c963)['toFixed'](0x0);return{'totalAmount':_0x8dafd3+'$','useAmount':_0xb9915d+'$','balance':(Number(_0x8dafd3)-Number(_0xb9915d))[_0x4a76cf(0x24b)](0x2)+'$','isBindCard':_0x2b99fb,'expirDate':dayjs(_0x2738d7*0x3e8)['format'](_0x4a76cf(0x26b)),'status':0x1};}catch(_0x36b745){return{'status':-0x1};}}async[_0x1ecdb1(0x215)](_0x36c1c7,_0x4a1e61){const _0x2fbca3=_0x1ecdb1;let _0x9a0be={};_0x4a1e61===0x3?_0x9a0be=await this[_0x2fbca3(0x309)](0x3):_0x9a0be=await this[_0x2fbca3(0x309)](0x4);const {model:_0x47589e,key:_0x2a5931,id:_0x610fad}=_0x9a0be;return await this[_0x2fbca3(0x2ed)][_0x2fbca3(0x2b4)]()['update'](gptKeys_entity_1[_0x2fbca3(0x2aa)])['set']({'useCount':()=>_0x2fbca3(0x2a7)})[_0x2fbca3(0x2ab)](_0x2fbca3(0x1df),{'id':_0x610fad})[_0x2fbca3(0x2a6)](),_0x9a0be;}async[_0x1ecdb1(0x1f2)](_0x1ccaf9){const _0x8264fd=_0x1ecdb1,_0x8d76cc=await this[_0x8264fd(0x268)][_0x8264fd(0x27c)]([_0x8264fd(0x300)])||'https://api.openai.com',_0x14214d=_0x8d76cc+_0x8264fd(0x272);try{const _0x4c41be=await axios_1[_0x8264fd(0x314)][_0x8264fd(0x227)](_0x14214d,{'headers':{'Authorization':_0x8264fd(0x234)+_0x1ccaf9}}),_0x5475c7=_0x4c41be['data'][_0x8264fd(0x28b)]['map'](_0x545368=>_0x545368['id']);return model_constant_1[_0x8264fd(0x219)][_0x8264fd(0x2ad)](_0x34c9b5=>_0x5475c7[_0x8264fd(0x279)](_0x34c9b5));}catch(_0x16ac74){throw new common_1[(_0x8264fd(0x2bd))](_0x8264fd(0x273),common_1['HttpStatus']['BAD_REQUEST']);}}async[_0x1ecdb1(0x286)](_0x17a744,_0xc40dd5){const _0xbd6d7e=_0x1ecdb1;try{const _0x3c458a={},{page:page=0x1,size:size=0xa,key:_0xda6b0c,status:_0x2f25e5,keyStatus:_0x1ae81d,model:_0x59897a}=_0x17a744;_0xda6b0c&&(_0x3c458a['key']=(0x0,typeorm_1['Like'])('%'+_0xda6b0c+'%')),_0x1ae81d&&(_0x3c458a[_0xbd6d7e(0x1ee)]=_0x1ae81d),_0x59897a&&(_0x3c458a['model']=_0x59897a),[0x0,0x1,'0','1','-1',-0x1][_0xbd6d7e(0x279)](_0x2f25e5)&&(_0x3c458a[_0xbd6d7e(0x236)]=_0x2f25e5);const [_0x40d612,_0x24da48]=await this['gptKeysEntity'][_0xbd6d7e(0x1f5)]({'skip':(page-0x1)*size,'take':size,'where':_0x3c458a,'order':{'id':_0xbd6d7e(0x23d)}}),_0x41b94a=[];_0x40d612[_0xbd6d7e(0x276)](_0x436a06=>_0x41b94a['push'](this['getKeyDetail'](_0x436a06[_0xbd6d7e(0x2d6)])));const _0x4e4f43=await Promise[_0xbd6d7e(0x2fe)](_0x41b94a);return _0x40d612[_0xbd6d7e(0x276)]((_0x31bdc1,_0x135b1d)=>_0x31bdc1[_0xbd6d7e(0x27e)]=_0x4e4f43[_0x135b1d]),_0xc40dd5[_0xbd6d7e(0x2a5)]['role']!==_0xbd6d7e(0x2e4)&&_0x40d612[_0xbd6d7e(0x276)](_0x33934b=>{const _0x2cb090=_0xbd6d7e;_0x33934b['key']=_0x33934b[_0x2cb090(0x2d6)]?(0x0,utils_1[_0x2cb090(0x2da)])(_0x33934b['key']):'',_0x33934b[_0x2cb090(0x20b)]=_0x33934b[_0x2cb090(0x20b)]?(0x0,utils_1[_0x2cb090(0x2da)])(_0x33934b['openaiProxyUrl']):'';}),{'rows':_0x40d612,'count':_0x24da48};}catch(_0x357ae2){console[_0xbd6d7e(0x210)](_0xbd6d7e(0x29b),_0x357ae2);throw new common_1[(_0xbd6d7e(0x2bd))](_0xbd6d7e(0x2d1),common_1[_0xbd6d7e(0x2ec)][_0xbd6d7e(0x2cb)]);}}async['addKey'](_0x53e9d3){const _0x550e65=_0x1ecdb1,{key:_0x27ae00}=_0x53e9d3,_0x3cff0c=await this[_0x550e65(0x2ed)][_0x550e65(0x20d)]({'where':{'key':_0x27ae00}});if(_0x3cff0c)throw new common_1[(_0x550e65(0x2bd))](_0x550e65(0x26e),common_1[_0x550e65(0x2ec)]['BAD_REQUEST']);const _0x36c951=await this[_0x550e65(0x2ed)][_0x550e65(0x30a)](_0x53e9d3);return await this[_0x550e65(0x1eb)](),_0x36c951;}async[_0x1ecdb1(0x299)](_0x1747b9){const _0xd6b346=_0x1ecdb1,{keyList:_0x5389e4}=_0x1747b9,_0x272ce9=await this[_0xd6b346(0x2ed)][_0xd6b346(0x1e9)]({'where':{'key':(0x0,typeorm_1['In'])(_0x5389e4)}}),_0x33fbe8=_0x272ce9['map'](_0x559da5=>_0x559da5[_0xd6b346(0x2d6)]),_0x4538ec=_0x5389e4[_0xd6b346(0x2ad)](_0x358955=>!_0x33fbe8[_0xd6b346(0x279)](_0x358955)),_0xe7498b=_0x4538ec[_0xd6b346(0x24f)](_0x5c2a18=>{const _0x7bbd42=_0xd6b346;return{'key':_0x5c2a18,'status':0x1,'model':_0x7bbd42(0x2e5)};}),_0x139275=await this[_0xd6b346(0x2ed)][_0xd6b346(0x30a)](_0xe7498b);let _0x492fc9=_0xd6b346(0x2df)+_0xe7498b[_0xd6b346(0x271)]+'个key';return _0x33fbe8[_0xd6b346(0x271)]&&(_0x492fc9+='、重复key'+_0x33fbe8[_0xd6b346(0x271)]+'个已被排除！'),_0x492fc9;}async[_0x1ecdb1(0x2d3)](_0x44440d){const _0x43d5d7=_0x1ecdb1,{id:_0x4529e7}=_0x44440d,_0x1819eb=await this[_0x43d5d7(0x2ed)][_0x43d5d7(0x20d)]({'where':{'id':_0x4529e7}});if(!_0x1819eb)throw new common_1[(_0x43d5d7(0x2bd))](_0x43d5d7(0x22e),common_1[_0x43d5d7(0x2ec)][_0x43d5d7(0x2cb)]);const _0x23cdeb=await this[_0x43d5d7(0x2ed)]['update']({'id':_0x4529e7},_0x44440d);if(_0x23cdeb[_0x43d5d7(0x28e)]>0x0)return await this[_0x43d5d7(0x1eb)](),_0x43d5d7(0x2ef);else throw new common_1[(_0x43d5d7(0x2bd))](_0x43d5d7(0x2a0),common_1[_0x43d5d7(0x2ec)][_0x43d5d7(0x2cb)]);}async[_0x1ecdb1(0x24d)](_0x3d75ab){const _0x3e1556=_0x1ecdb1,{id:_0x19610b}=_0x3d75ab,_0x4a71d5=await this[_0x3e1556(0x2ed)]['findOne']({'where':{'id':_0x19610b}});if(!_0x4a71d5)throw new common_1['HttpException']('key不存在',common_1[_0x3e1556(0x2ec)][_0x3e1556(0x2cb)]);const _0x492cfe=await this[_0x3e1556(0x2ed)][_0x3e1556(0x2dc)]({'id':_0x19610b});if(_0x492cfe[_0x3e1556(0x28e)]>0x0)return await this[_0x3e1556(0x1eb)](),_0x3e1556(0x230);else throw new common_1['HttpException']('删除失败',common_1[_0x3e1556(0x2ec)][_0x3e1556(0x2cb)]);}async[_0x1ecdb1(0x1eb)](){const _0x5677b0=_0x1ecdb1,_0x368ad5=await this[_0x5677b0(0x2ed)]['find']({'where':{'status':0x1},'select':['id',_0x5677b0(0x2d6),_0x5677b0(0x247),_0x5677b0(0x313),'maxModelTokens',_0x5677b0(0x2be),'openaiProxyUrl',_0x5677b0(0x1e2)]}),_0x4269a9=_0x368ad5['filter'](_0x2b5348=>_0x2b5348[_0x5677b0(0x313)]['includes'](_0x5677b0(0x293))),_0x22caf3=_0x368ad5[_0x5677b0(0x2ad)](_0x1959f0=>_0x1959f0[_0x5677b0(0x313)]['includes']('gpt-4'));this[_0x5677b0(0x232)]={'list3':_0x4269a9,'list4':_0x22caf3};}async['getUserWhiteList'](){const _0x33eed5=_0x1ecdb1;return await this[_0x33eed5(0x2f6)][_0x33eed5(0x1e9)]({'where':{'status':0x1,'count':(0x0,typeorm_1[_0x33eed5(0x246)])(0x0)},'select':[_0x33eed5(0x283)]});}async[_0x1ecdb1(0x200)](_0x3e7c24){const _0x1f2d15=_0x1ecdb1,{userId:_0xa4abc7,count:_0x2871c5}=_0x3e7c24,_0x32829d=await this[_0x1f2d15(0x2f6)]['findOne']({'where':{'userId':_0xa4abc7}});if(_0x32829d)throw new common_1[(_0x1f2d15(0x2bd))](_0x1f2d15(0x270),common_1['HttpStatus'][_0x1f2d15(0x2cb)]);const _0x3bf0f2=await this[_0x1f2d15(0x2f6)][_0x1f2d15(0x30a)](_0x3e7c24);return await this[_0x1f2d15(0x1ef)](),_0x3bf0f2;}async[_0x1ecdb1(0x2b2)](_0x92d04d){const _0x588a5e=_0x1ecdb1,{id:_0x5f24d3}=_0x92d04d,_0x2634e8=await this[_0x588a5e(0x2f6)][_0x588a5e(0x20d)]({'where':{'id':_0x5f24d3}});if(!_0x2634e8)throw new common_1[(_0x588a5e(0x2bd))](_0x588a5e(0x2c1),common_1[_0x588a5e(0x2ec)][_0x588a5e(0x2cb)]);const _0x1439d3=await this[_0x588a5e(0x2f6)][_0x588a5e(0x2c7)]({'id':_0x5f24d3},_0x92d04d);if(_0x1439d3[_0x588a5e(0x28e)]>0x0)return await this[_0x588a5e(0x1ef)](),_0x588a5e(0x20a);else throw new common_1[(_0x588a5e(0x2bd))](_0x588a5e(0x1f3),common_1['HttpStatus'][_0x588a5e(0x2cb)]);}async['getWhiteListUser'](_0xb07580,_0x377e4c){const _0x10542b=_0x1ecdb1,{page:page=0x1,size:size=0xa}=_0xb07580,[_0x222ae7,_0x424920]=await this[_0x10542b(0x2f6)][_0x10542b(0x1f5)]({'skip':(page-0x1)*size,'take':size,'order':{'id':_0x10542b(0x23d)}}),_0x1245e5=_0x222ae7['map'](_0x1f7fce=>_0x1f7fce['userId']),_0x2c2bbc=await this['userEntity'][_0x10542b(0x1e9)]({'where':{'id':(0x0,typeorm_1['In'])(_0x1245e5)}});return _0x222ae7['forEach'](_0xa6f97=>{const _0x32deb5=_0x10542b;var _0xef8b66,_0x34df03;const _0x204f67=_0x2c2bbc[_0x32deb5(0x1e9)](_0x29f1ac=>_0x29f1ac['id']===_0xa6f97[_0x32deb5(0x283)]);_0xa6f97[_0x32deb5(0x213)]=(_0xef8b66=_0x204f67===null||_0x204f67===void 0x0?void 0x0:_0x204f67['username'])!==null&&_0xef8b66!==void 0x0?_0xef8b66:'',_0xa6f97[_0x32deb5(0x2cf)]=(_0x34df03=_0x204f67===null||_0x204f67===void 0x0?void 0x0:_0x204f67[_0x32deb5(0x2cf)])!==null&&_0x34df03!==void 0x0?_0x34df03:'';}),_0x377e4c['user'][_0x10542b(0x2bc)]!=='super'&&_0x222ae7[_0x10542b(0x276)](_0x41a240=>_0x41a240[_0x10542b(0x2cf)]=(0x0,utils_1['maskEmail'])(_0x41a240['email'])),{'rows':_0x222ae7,'count':_0x424920};}async[_0x1ecdb1(0x21e)](_0xdbba02){const _0xf2a80c=_0x1ecdb1,{proxyUrl:_0x813462}=_0xdbba02,_0x561758=await this[_0xf2a80c(0x268)][_0xf2a80c(0x27c)]([_0xf2a80c(0x300)]);return _0x813462||_0x561758||_0xf2a80c(0x2d4);}async['uploadFile'](_0x6df5eb,_0x158da0){const _0x4d7318=_0x1ecdb1,{purpose:_0x95b7b9}=_0x6df5eb;try{const {cosBucket:_0x159317,cosRegion:_0x8557f7,tencentCosStatus:_0x1edf4c,tencentCosAcceleratedDomain:_0x471779}=await this[_0x4d7318(0x268)][_0x4d7318(0x27c)]([_0x4d7318(0x2dd),_0x4d7318(0x2c0),_0x4d7318(0x289),'tencentCosAcceleratedDomain']);if(_0x1edf4c!=='1')throw new common_1[(_0x4d7318(0x2bd))](_0x4d7318(0x259),common_1[_0x4d7318(0x2ec)][_0x4d7318(0x2cb)]);!this[_0x4d7318(0x315)]&&await this[_0x4d7318(0x30b)](!![]);const _0x24480e=_0x4d7318(0x2fc),_0x2af561=(0x0,path_1[_0x4d7318(0x214)])(_0x158da0[_0x4d7318(0x1e5)]),_0x4cd3ab=await this[_0x4d7318(0x315)][_0x4d7318(0x245)]({'Bucket':_0x159317,'Region':_0x8557f7,'Key':_0x24480e+Date['now']()+(''+_0x2af561),'Body':(0x0,fs_1[_0x4d7318(0x2b1)])((0x0,path_1[_0x4d7318(0x211)])(_0x158da0[_0x4d7318(0x25b)])),'onProgress':_0x1041c1=>{const _0x3cbf69=_0x4d7318;common_1[_0x3cbf69(0x222)][_0x3cbf69(0x210)](_0x1041c1,_0x3cbf69(0x281));}})[_0x4d7318(0x2c3)](_0xa1808e=>{throw _0xa1808e;});return'https://'+_0x4cd3ab[_0x4d7318(0x318)];}catch(_0x515592){return console[_0x4d7318(0x210)](_0x515592),Promise[_0x4d7318(0x2f4)](_0x515592);}}async['uploadGpt'](_0x235e44){const _0x349e27=_0x1ecdb1,{purpose:_0x3771a3,files:_0x2fcbb7}=_0x235e44,_0x53f6ea=new FormData(),_0x33e040=(0x0,fs_1['createReadStream'])((0x0,path_1[_0x349e27(0x211)])(_0x2fcbb7[_0x349e27(0x25b)]));_0x53f6ea[_0x349e27(0x2e3)](_0x349e27(0x306),_0x3771a3),_0x53f6ea[_0x349e27(0x2e3)](_0x349e27(0x266),_0x33e040);const _0x571f39=_0x53f6ea[_0x349e27(0x228)](),_0x133ad8=()=>{return new Promise((_0x1f9cc8,_0x209fe0)=>{_0x53f6ea['getLength']((_0x5682a2,_0xc03b70)=>{const _0x57a592=_0x51e0;if(_0x5682a2)_0x209fe0(_0x5682a2);console[_0x57a592(0x210)](_0x57a592(0x271),_0xc03b70),_0x1f9cc8(_0xc03b70);});});};_0x571f39['content-length']=await _0x133ad8();const _0x4c6da9=await this[_0x349e27(0x268)][_0x349e27(0x27c)](['openaiBaseUrl']),_0x5cbe12='',_0x1e0390=_0x5cbe12||_0x4c6da9||_0x349e27(0x2d4);await axios_1['default'][_0x349e27(0x2eb)]({'baseURL':_0x1e0390+_0x349e27(0x275),'method':'post','headers':_0x571f39,'data':_0x53f6ea,'onUploadProgress':_0x39e5ef=>{const _0x4dad60=_0x349e27;console[_0x4dad60(0x210)](_0x39e5ef);}})[_0x349e27(0x250)](_0x2815c8=>{const _0x147077=_0x349e27;console[_0x147077(0x210)](_0x2815c8);});}async['formatModelToken'](_0x51c2fc){const _0x28f6f6=_0x1ecdb1,{openaiModel3MaxTokens:openaiModel3MaxTokens=0x0,openaiModel3MaxTokensRes:openaiModel3MaxTokensRes=0x0,openaiModel3MaxTokens16k:openaiModel3MaxTokens16k=0x0,openaiModel3MaxTokens16kRes:openaiModel3MaxTokens16kRes=0x0,openaiModel4MaxTokens:openaiModel4MaxTokens=0x0,openaiModel4MaxTokensRes:openaiModel4MaxTokensRes=0x0,openaiModel4MaxTokens32k:openaiModel4MaxTokens32k=0x0,openaiModel4MaxTokens32kRes:openaiModel4MaxTokens32kRes=0x0,openaiBaseUrl:openaiBaseUrl=''}=await this[_0x28f6f6(0x268)][_0x28f6f6(0x27c)]([_0x28f6f6(0x1e3),_0x28f6f6(0x262),'openaiModel3MaxTokens16k',_0x28f6f6(0x21d),'openaiModel4MaxTokens','openaiModel4MaxTokensRes',_0x28f6f6(0x2a4),_0x28f6f6(0x1ec),_0x28f6f6(0x300)]);let _0x34cdf2=null,_0x1ac037=null,_0x3cb9fc=null;const {model:_0x4140b5,maxModelTokens:maxModelTokens=0x0,maxResponseTokens:maxResponseTokens=0x0,openaiProxyUrl:openaiProxyUrl='',key:_0x52afaf}=_0x51c2fc;return _0x4140b5[_0x28f6f6(0x1f9)]()[_0x28f6f6(0x279)](_0x28f6f6(0x233))&&(_0x4140b5['toLowerCase']()[_0x28f6f6(0x279)]('32k')?(_0x34cdf2=maxModelTokens||openaiModel4MaxTokens32k||0x8000,_0x1ac037=maxResponseTokens||openaiModel4MaxTokens32kRes||0x4000):(_0x34cdf2=maxModelTokens||openaiModel4MaxTokens||0x2000,_0x1ac037=maxResponseTokens||openaiModel4MaxTokensRes||0x1000)),_0x4140b5[_0x28f6f6(0x1f9)]()[_0x28f6f6(0x279)](_0x28f6f6(0x293))&&(_0x4140b5[_0x28f6f6(0x1f9)]()[_0x28f6f6(0x279)](_0x28f6f6(0x252))?(_0x34cdf2=maxModelTokens||openaiModel3MaxTokens16k||0x4000,_0x1ac037=maxResponseTokens||openaiModel3MaxTokens16kRes||0x2000):(_0x34cdf2=maxModelTokens||openaiModel3MaxTokens||0x1000,_0x1ac037=maxResponseTokens||openaiModel3MaxTokensRes||0x3e8)),_0x3cb9fc=openaiProxyUrl||openaiBaseUrl||_0x28f6f6(0x2d4),_0x1ac037>=_0x34cdf2&&(_0x1ac037=Math[_0x28f6f6(0x2f1)](_0x34cdf2/0x2),common_1[_0x28f6f6(0x222)]['debug'](_0x28f6f6(0x287)+_0x52afaf+_0x28f6f6(0x2b0)+_0x1ac037)),{'key':_0x52afaf,'maxToken':_0x34cdf2,'maxTokenRes':_0x1ac037,'proxyUrl':_0x3cb9fc};}};ChatgptService=__decorate([(0x0,common_1[_0x1ecdb1(0x274)])(),__param(0x0,(0x0,typeorm_2[_0x1ecdb1(0x2fa)])(user_entity_1['UserEntity'])),__param(0x1,(0x0,typeorm_2[_0x1ecdb1(0x2fa)])(gptKeys_entity_1['GptKeysEntity'])),__param(0x2,(0x0,typeorm_2[_0x1ecdb1(0x2fa)])(config_entity_1['ConfigEntity'])),__param(0x3,(0x0,typeorm_2[_0x1ecdb1(0x2fa)])(whiteList_entity_1['WhiteListEntity'])),__param(0x4,(0x0,typeorm_2[_0x1ecdb1(0x2fa)])(app_entity_1['AppEntity'])),__metadata('design:paramtypes',[typeorm_1[_0x1ecdb1(0x20f)],typeorm_1[_0x1ecdb1(0x20f)],typeorm_1[_0x1ecdb1(0x20f)],typeorm_1[_0x1ecdb1(0x20f)],typeorm_1[_0x1ecdb1(0x20f)],nestjs_config_1[_0x1ecdb1(0x264)],userBalance_service_1[_0x1ecdb1(0x1f0)],chatLog_service_1[_0x1ecdb1(0x241)],user_service_1[_0x1ecdb1(0x221)],upload_service_1[_0x1ecdb1(0x2e2)],badwords_service_1[_0x1ecdb1(0x257)],autoreply_service_1[_0x1ecdb1(0x26d)],globalConfig_service_1[_0x1ecdb1(0x242)],fanyi_service_1['FanyiService'],chatGroup_service_1['ChatGroupService'],models_service_1[_0x1ecdb1(0x2ac)]])],ChatgptService),exports[_0x1ecdb1(0x2ca)]=ChatgptService;