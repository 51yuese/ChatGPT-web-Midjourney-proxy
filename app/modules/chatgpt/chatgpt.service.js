'use strict';const _0x27aeda=_0x4136;(function(_0x55399b,_0x45d92d){const _0x1f1645=_0x4136,_0xbbe604=_0x55399b();while(!![]){try{const _0x194be4=-parseInt(_0x1f1645(0x108))/0x1+-parseInt(_0x1f1645(0x1a7))/0x2+-parseInt(_0x1f1645(0xd9))/0x3*(-parseInt(_0x1f1645(0x1f1))/0x4)+-parseInt(_0x1f1645(0x12c))/0x5+parseInt(_0x1f1645(0xf1))/0x6+-parseInt(_0x1f1645(0x179))/0x7*(parseInt(_0x1f1645(0xbe))/0x8)+parseInt(_0x1f1645(0x121))/0x9*(parseInt(_0x1f1645(0x1cb))/0xa);if(_0x194be4===_0x45d92d)break;else _0xbbe604['push'](_0xbbe604['shift']());}catch(_0x25abd2){_0xbbe604['push'](_0xbbe604['shift']());}}}(_0x30a9,0xf3b9c));function _0x4136(_0x17a3ab,_0x12b09e){const _0x30a980=_0x30a9();return _0x4136=function(_0x413643,_0x24dd97){_0x413643=_0x413643-0x69;let _0x37aaf8=_0x30a980[_0x413643];return _0x37aaf8;},_0x4136(_0x17a3ab,_0x12b09e);}var __decorate=this&&this[_0x27aeda(0x1cc)]||function(_0x5e4dfe,_0x2c754a,_0xf9cd12,_0x13db42){const _0x5cf5d9=_0x27aeda;var _0x5ab34e=arguments[_0x5cf5d9(0x6d)],_0x448d9d=_0x5ab34e<0x3?_0x2c754a:_0x13db42===null?_0x13db42=Object[_0x5cf5d9(0xca)](_0x2c754a,_0xf9cd12):_0x13db42,_0x51be81;if(typeof Reflect===_0x5cf5d9(0x12f)&&typeof Reflect['decorate']===_0x5cf5d9(0x99))_0x448d9d=Reflect['decorate'](_0x5e4dfe,_0x2c754a,_0xf9cd12,_0x13db42);else{for(var _0x1b1928=_0x5e4dfe[_0x5cf5d9(0x6d)]-0x1;_0x1b1928>=0x0;_0x1b1928--)if(_0x51be81=_0x5e4dfe[_0x1b1928])_0x448d9d=(_0x5ab34e<0x3?_0x51be81(_0x448d9d):_0x5ab34e>0x3?_0x51be81(_0x2c754a,_0xf9cd12,_0x448d9d):_0x51be81(_0x2c754a,_0xf9cd12))||_0x448d9d;}return _0x5ab34e>0x3&&_0x448d9d&&Object[_0x5cf5d9(0xe2)](_0x2c754a,_0xf9cd12,_0x448d9d),_0x448d9d;},__metadata=this&&this[_0x27aeda(0x135)]||function(_0x3bfbaa,_0x4d1320){const _0x2db5d7=_0x27aeda;if(typeof Reflect==='object'&&typeof Reflect['metadata']===_0x2db5d7(0x99))return Reflect[_0x2db5d7(0x189)](_0x3bfbaa,_0x4d1320);},__param=this&&this[_0x27aeda(0xf6)]||function(_0x3007d5,_0xc643ad){return function(_0x298895,_0x4e7784){_0xc643ad(_0x298895,_0x4e7784,_0x3007d5);};};Object[_0x27aeda(0xe2)](exports,'__esModule',{'value':!![]}),exports[_0x27aeda(0x17e)]=void 0x0;const upload_service_1=require(_0x27aeda(0x16e)),user_service_1=require(_0x27aeda(0x157)),openai_1=require('openai'),common_1=require('@nestjs/common'),FormData=require('form-data'),errorMessage_constant_1=require(_0x27aeda(0x164)),utils_1=require(_0x27aeda(0x18a)),axios_1=require(_0x27aeda(0x19e)),userBalance_service_1=require('../userBalance/userBalance.service'),balance_constant_1=require(_0x27aeda(0x1c9)),chatLog_service_1=require(_0x27aeda(0xe3)),uuid=require(_0x27aeda(0x118)),fs_1=require('fs'),typeorm_1=require(_0x27aeda(0x1ee)),typeorm_2=require(_0x27aeda(0x165)),badwords_service_1=require(_0x27aeda(0x12a)),autoreply_service_1=require(_0x27aeda(0x10e)),gptKeys_entity_1=require(_0x27aeda(0x94)),globalConfig_service_1=require(_0x27aeda(0x151)),whiteList_entity_1=require(_0x27aeda(0xfa)),user_entity_1=require(_0x27aeda(0xfb)),dayjs=require('dayjs'),app_entity_1=require(_0x27aeda(0xd8)),chatGroup_service_1=require(_0x27aeda(0x84)),models_service_1=require(_0x27aeda(0x9b)),baidu_1=require(_0x27aeda(0x18d)),helper_1=require(_0x27aeda(0xfe)),store_1=require(_0x27aeda(0x186)),zhipu_1=require('./zhipu'),spark_1=require(_0x27aeda(0x1ae)),model_constant_1=require('../../common/constants/model.constant'),fs_2=require('fs'),path_1=require(_0x27aeda(0x1f2)),COS=require(_0x27aeda(0x77)),gpts_service_1=require(_0x27aeda(0x82)),aiAgreeLog_entity_1=require(_0x27aeda(0xf3)),chatLog_entity_1=require(_0x27aeda(0xe8)),jwt=require(_0x27aeda(0x1d7));let ChatgptService=class ChatgptService{constructor(_0x607bdc,_0x10dbf8,_0x1f16a0,_0x320e26,_0x16532f,_0x596efb,_0x301ccb,_0x5edb56,_0x253018,_0x12290d,_0x5199a8,_0x7b0975,_0x4d0963,_0x1f841b,_0x2b5bba,_0x5eb19e,_0x472f49){const _0x46ff67=_0x27aeda;this[_0x46ff67(0x15d)]=_0x607bdc,this[_0x46ff67(0x87)]=_0x10dbf8,this[_0x46ff67(0xa8)]=_0x1f16a0,this['appEntity']=_0x320e26,this['chatLogEntity']=_0x16532f,this[_0x46ff67(0x1c0)]=_0x596efb,this[_0x46ff67(0x1e9)]=_0x301ccb,this['chatLogService']=_0x5edb56,this[_0x46ff67(0xe6)]=_0x253018,this[_0x46ff67(0x11d)]=_0x12290d,this[_0x46ff67(0xf2)]=_0x5199a8,this[_0x46ff67(0x89)]=_0x7b0975,this['globalConfigService']=_0x4d0963,this[_0x46ff67(0x100)]=_0x1f841b,this[_0x46ff67(0xc2)]=_0x2b5bba,this[_0x46ff67(0x125)]=_0x5eb19e,this['connection']=_0x472f49,this[_0x46ff67(0x128)]=_0x46ff67(0x1bf),this[_0x46ff67(0x1a4)]=null,this['keyPool']={'list3':[],'list4':[]},this[_0x46ff67(0x13e)]=_0x8ef1d4=>{const _0x1df20a=_0x46ff67;return fs_1[_0x1df20a(0x83)]['unlink'](_0x8ef1d4,_0xbbc272=>{const _0x1db3dd=_0x1df20a;_0xbbc272?console[_0x1db3dd(0x1ea)](_0x1db3dd(0x169),_0xbbc272):console['log'](_0x1db3dd(0x1a6),_0x8ef1d4);});};}async[_0x27aeda(0x7d)](){const _0x516acb=_0x27aeda;let _0x4fc912=await(0x0,utils_1[_0x516acb(0xdb)])(_0x516acb(0x177)),_0x551f1a=await(0x0,utils_1[_0x516acb(0xdb)])(_0x516acb(0x1db)),_0x531c2d=await(0x0,utils_1[_0x516acb(0xdb)])('keyv');_0x4fc912=_0x4fc912?.[_0x516acb(0x83)]?_0x4fc912['default']:_0x4fc912,_0x551f1a=_0x551f1a?.[_0x516acb(0x83)]?_0x551f1a[_0x516acb(0x83)]:_0x551f1a,_0x531c2d=_0x531c2d?.[_0x516acb(0x83)]?_0x531c2d[_0x516acb(0x83)]:_0x531c2d;const {ChatGPTAPI:_0x44ae88,ChatGPTError:_0x1d6a95,ChatGPTUnofficialProxyAPI:_0x316bac}=_0x4fc912,_0x503c34=+process[_0x516acb(0x110)][_0x516acb(0x162)],_0x35e7e2=process['env'][_0x516acb(0xcf)],_0x13cdfa=process[_0x516acb(0x110)][_0x516acb(0x1e4)],_0x115372=process[_0x516acb(0x110)][_0x516acb(0x1e0)],_0x554cf6=_0x516acb(0xff)+(_0x115372||'')+':'+(_0x13cdfa||'')+'@'+_0x35e7e2+':'+_0x503c34,_0x4dfe95=new _0x551f1a(_0x554cf6),_0x148b02=new _0x531c2d({'store':_0x4dfe95,'namespace':_0x516acb(0x167)});this['gomaxAiStore']=new store_1[(_0x516acb(0x1b7))]({'store':_0x148b02,'namespace':_0x516acb(0x173)}),this[_0x516acb(0x1b3)]=new _0x44ae88({'apiKey':_0x516acb(0xe4),'apiBaseUrl':this[_0x516acb(0x128)]+_0x516acb(0x16a),'messageStore':_0x148b02}),!this[_0x516acb(0x88)]&&this[_0x516acb(0x142)](),await this[_0x516acb(0x11e)](!![]);}[_0x27aeda(0x142)](){const _0x55b435=_0x27aeda;this[_0x55b435(0x88)]=new openai_1[(_0x55b435(0x83))]({'apiKey':_0x55b435(0xe4),'baseURL':this[_0x55b435(0x128)]+_0x55b435(0x16a)});}async[_0x27aeda(0x11e)](_0x16fde6=![]){const _0x3e3f32=_0x27aeda,{cosSecretId:_0x1b770b,cosSecretKey:_0x32ae82}=await this[_0x3e3f32(0x1ce)][_0x3e3f32(0x10a)]([_0x3e3f32(0x1ab),'cosSecretKey']);if(!_0x1b770b||!_0x32ae82)return common_1[_0x3e3f32(0x178)][_0x3e3f32(0x17d)](_0x3e3f32(0xd1),'ChatGptService');this[_0x3e3f32(0x1cf)]=new COS({'SecretId':_0x1b770b,'SecretKey':_0x32ae82}),common_1[_0x3e3f32(0x178)][_0x3e3f32(0x1ea)](_0x3e3f32(0x1dd));}async[_0x27aeda(0xaa)](_0x26166c){const _0x4ae634=_0x27aeda,{list3:_0x5d7244,list4:_0x3e9fd7}=this[_0x4ae634(0x198)];if(_0x5d7244[_0x4ae634(0x6d)]===0x0&&_0x3e9fd7[_0x4ae634(0x6d)]===0x0)throw new common_1[(_0x4ae634(0xae))](_0x4ae634(0xd2),common_1[_0x4ae634(0xa1)]['BAD_REQUEST']);if(_0x26166c===0x3){if(_0x5d7244[_0x4ae634(0x6d)]===0x0)throw new common_1['HttpException'](_0x4ae634(0x1c4),common_1[_0x4ae634(0xa1)][_0x4ae634(0x13c)]);return(0x0,utils_1[_0x4ae634(0x150)])(_0x5d7244);}if(_0x26166c===0x4){if(_0x3e9fd7[_0x4ae634(0x6d)]===0x0){const _0x102097=await this['globalConfigService'][_0x4ae634(0x10a)]([_0x4ae634(0x1ef)]);if(Number(_0x102097)!==0x1)throw new common_1['HttpException'](_0x4ae634(0xef),common_1[_0x4ae634(0xa1)][_0x4ae634(0x13c)]);common_1[_0x4ae634(0x178)]['error'](_0x4ae634(0x133));if(_0x5d7244[_0x4ae634(0x6d)]===0x0)throw new common_1[(_0x4ae634(0xae))](_0x4ae634(0xd2),common_1[_0x4ae634(0xa1)]['BAD_REQUEST']);else return(0x0,utils_1[_0x4ae634(0x150)])(_0x5d7244);}else return(0x0,utils_1[_0x4ae634(0x150)])(_0x3e9fd7);}}async[_0x27aeda(0x9f)](_0x59685c,_0x6eee70,_0x100f43,_0x30a3b6){const _0x47f379=_0x27aeda,{timeout:timeout=0x3c}=_0x100f43,{topN:_0x21bb72,model:_0x3fa572}=_0x30a3b6,{parentMessageId:parentMessageId=0x0}=_0x59685c,_0x390098=await this[_0x47f379(0x1ce)][_0x47f379(0x10a)]([_0x47f379(0x1b2)]),_0xc0f47a=timeout*0x3e8||_0x390098||0x64*0x3e8;common_1[_0x47f379(0x178)][_0x47f379(0x1ea)](_0xc0f47a,_0x47f379(0x6a)),common_1[_0x47f379(0x178)]['log'](_0x390098,_0x47f379(0x18e));const _0x266410={'parentMessageId':parentMessageId,'timeoutMs':+_0xc0f47a,'completionParams':{'model':_0x3fa572,'temperature':_0x21bb72}};return _0x6eee70&&(_0x266410[_0x47f379(0x171)]=_0x6eee70),_0x266410;}async['chatProcess'](_0x5bda89,_0x4728c0,_0x243ba1){const _0x54237a=_0x27aeda,_0xad4892=_0x4728c0[_0x54237a(0x155)],{options:options={},prompt:_0x22b539,appId:_0x14e99c,cusromPrompt:_0xe9c8b6,systemMessage:systemMessage=''}=_0x5bda89;let _0x1f6d62=systemMessage;const {groupId:_0x165311,usingNetwork:_0x137059,parentMessageId:_0x5232a1,type:_0x3feeb6}=options;let _0x1de139;_0x3feeb6&&_0x3feeb6===_0x54237a(0x1ec)?_0x1de139=await this[_0x54237a(0x125)]['getGroupInfoFromId'](_0x165311):_0x1de139=await this[_0x54237a(0x100)][_0x54237a(0xbb)](_0x165311);let _0x322e37;_0x1de139?_0x322e37=JSON['parse'](_0x1de139[_0x54237a(0xcc)]):_0x322e37=await this['modelsService'][_0x54237a(0x17c)](model_constant_1[_0x54237a(0x1e2)][_0x54237a(0x1eb)]);if(!_0x322e37)throw new common_1[(_0x54237a(0xae))](_0x54237a(0x124),common_1[_0x54237a(0xa1)][_0x54237a(0x13c)]);let {model:_0x37eb50,keyType:_0x1b983e,modelType:_0x5b52dd,id:_0x27e78b,topN:_0x218ddf,systemMessage:_0x5b7732,rounds:_0x284147}=_0x322e37[_0x54237a(0x156)],_0x110de8=null;if(!_0xe9c8b6&&!_0x3feeb6)_0x110de8=await this[_0x54237a(0xc2)][_0x54237a(0xc0)](_0x37eb50),_0x322e37['modelInfo'][_0x54237a(0x159)]===model_constant_1[_0x54237a(0x1e2)][_0x54237a(0xc3)]&&(_0x37eb50=_0x5bda89['mv']||_0x54237a(0x15c),options[_0x54237a(0xad)]=_0x37eb50,_0x322e37[_0x54237a(0x156)][_0x54237a(0x1bc)]=_0x37eb50);else{if(_0x3feeb6===_0x54237a(0x1ec))_0x110de8=await this[_0x54237a(0x125)][_0x54237a(0xc0)](_0x165311),_0x110de8[_0x54237a(0xad)]&&(_0x37eb50=_0x110de8[_0x54237a(0xad)],options[_0x54237a(0xad)]=_0x37eb50,_0x322e37[_0x54237a(0x156)][_0x54237a(0x1bc)]=_0x37eb50);else _0xe9c8b6?_0x110de8=await this[_0x54237a(0xc2)][_0x54237a(0xe0)](model_constant_1[_0x54237a(0x1e2)][_0x54237a(0x1eb)]):_0x110de8=await this[_0x54237a(0xc2)][_0x54237a(0xe0)](model_constant_1['EModelType'][_0x54237a(0x12e)]);}if(!_0x110de8)throw new common_1[(_0x54237a(0xae))](_0x54237a(0x1a5),common_1[_0x54237a(0xa1)][_0x54237a(0x13c)]);const {deduct:_0x3a88aa,deductType:_0x146b08,key:_0x3f57bb,modelName:_0xa044a8,id:_0x5dc58e,accessToken:_0xe12c0b,proxy:_0x351192}=_0x110de8;await this[_0x54237a(0xe6)]['checkUserStatus'](_0x4728c0[_0x54237a(0x1a9)]),await this[_0x54237a(0x1e9)][_0x54237a(0x1de)](_0x4728c0,_0x146b08===0x1?'model3':_0x54237a(0x78),_0x3a88aa),_0x243ba1&&_0x243ba1[_0x54237a(0x1b1)]('Content-type',_0x54237a(0x93)),await this[_0x54237a(0xf2)][_0x54237a(0x1a1)](_0x22b539,_0x4728c0[_0x54237a(0x1a9)]['id']);const _0x2311b1=await this[_0x54237a(0x89)][_0x54237a(0x16c)](_0x22b539);if(_0x2311b1&&_0x243ba1){const _0x3fc34c={'message':_0x2311b1,'code':0x1f4};return _0x243ba1['write'](JSON['stringify'](_0x3fc34c)),_0x243ba1['end']();}if(_0x14e99c){const _0x36d96a=await this[_0x54237a(0x1c3)][_0x54237a(0x1d9)]({'where':{'id':_0x14e99c,'status':(0x0,typeorm_1['In'])([0x1,0x3,0x4,0x5])}});if(!_0x36d96a)throw new common_1[(_0x54237a(0xae))](_0x54237a(0x95),common_1[_0x54237a(0xa1)][_0x54237a(0x13c)]);_0x36d96a[_0x54237a(0x188)]&&(_0x1f6d62=_0x36d96a[_0x54237a(0x188)]);}else{if(_0xe9c8b6)_0x1f6d62=systemMessage;else{if(_0x5b7732)_0x1f6d62=_0x5b7732;else{const _0x3711bc=new Date()[_0x54237a(0x79)]()[_0x54237a(0xb3)]('T')[0x0];let _0x1021af='';_0x3feeb6!==_0x54237a(0x1ec)&&(_0x1021af=await this[_0x54237a(0x1ce)][_0x54237a(0x10a)]([_0x54237a(0x153)]),_0x1f6d62=_0x1021af+(_0x54237a(0x16b)+_0x3711bc));}}}let _0x22e665='';if(_0x137059){_0x22e665=await(0x0,utils_1[_0x54237a(0x1e6)])(_0x22b539);const _0x17597b=new Date()[_0x54237a(0x79)]()[_0x54237a(0xb3)]('T')[0x0],_0x403d25=await this[_0x54237a(0x1ce)][_0x54237a(0x10a)]([_0x54237a(0x153)]);_0x1f6d62=_0x403d25+(_0x54237a(0x16b)+_0x17597b);}const _0x570422=await this['getRequestParams'](options,_0x1f6d62,_0x110de8,_0x322e37[_0x54237a(0x156)]);console[_0x54237a(0x1ea)]('mergedOptions',_0x570422);const {maxModelTokens:maxModelTokens=0x1f40,maxResponseTokens:maxResponseTokens=0x1000}=_0x110de8,_0x2d651c=_0x3feeb6===_0x54237a(0x1ec)?_0x351192:await this[_0x54237a(0x6c)](_0x110de8);this[_0x54237a(0x1b3)][_0x54237a(0x185)]=(0x0,utils_1[_0x54237a(0x147)])(_0x3f57bb),console['log'](_0x54237a(0xfd),this[_0x54237a(0x1b3)]['apiKey']),console[_0x54237a(0x1ea)]('this.api.apiBaseUrl',_0x2d651c+_0x54237a(0x16a)),this[_0x54237a(0x1b3)][_0x54237a(0xd6)]=_0x2d651c+'/v1',this[_0x54237a(0x1b3)][_0x54237a(0xaf)]=maxModelTokens,this['api']['maxResponseTokens']=maxResponseTokens>=maxModelTokens?Math[_0x54237a(0x13b)](Math['floor'](maxModelTokens/0x2)):maxResponseTokens,_0x243ba1&&_0x243ba1[_0x54237a(0x144)](0xc8);let _0x4d8df7=null,_0x5458c0=null;try{if(_0x243ba1){let _0x4e87aa=null,_0x537da9=![];_0x243ba1['on'](_0x54237a(0x13d),async()=>{const _0x543b11=_0x54237a;if(_0x537da9)return;_0xad4892['abort']();const _0x54a12f=await this[_0x543b11(0x1b3)][_0x543b11(0xf5)](_0x22b539)||0x0,_0x3739bd=await this['api']['getTokenCount'](_0x4e87aa?.['text']||''),_0x3eb8da=_0x54a12f+_0x3739bd,_0x23a1b9=(0x0,utils_1[_0x543b11(0x1b8)])(_0x4728c0);await this[_0x543b11(0x74)][_0x543b11(0x149)]({'appId':_0x14e99c,'curIp':_0x23a1b9,'logType':_0x3feeb6===_0x543b11(0x1ec)?0x2:0x1,'userId':_0x4728c0[_0x543b11(0x1a9)]['id'],'type':balance_constant_1[_0x543b11(0x105)][_0x543b11(0x143)],'prompt':_0x22b539,'answer':'','promptTokens':_0x54a12f,'completionTokens':0x0,'totalTokens':_0x54a12f,'model':_0x37eb50,'role':_0x543b11(0x1a9),'groupId':_0x165311,'requestOptions':JSON[_0x543b11(0x11b)]({'options':null,'prompt':_0x22b539}),'modelId':_0x27e78b,'modelType':_0x5b52dd}),await this[_0x543b11(0x74)][_0x543b11(0x149)]({'appId':_0x14e99c,'curIp':_0x23a1b9,'logType':_0x3feeb6==='gpts'?0x2:0x1,'userId':_0x4728c0[_0x543b11(0x1a9)]['id'],'type':balance_constant_1[_0x543b11(0x105)][_0x543b11(0x143)],'prompt':_0x22b539,'answer':_0x4e87aa?.['text'],'promptTokens':_0x54a12f,'completionTokens':_0x3739bd,'totalTokens':_0x3eb8da,'model':_0x37eb50,'role':_0x543b11(0xda),'groupId':_0x165311,'requestOptions':JSON[_0x543b11(0x11b)]({'options':{'model':_0x37eb50,'temperature':_0x218ddf},'prompt':_0x22b539}),'conversationOptions':JSON[_0x543b11(0x11b)]({'conversationId':_0x4e87aa?.[_0x543b11(0xd0)],'model':_0x37eb50,'parentMessageId':_0x4e87aa?.['id'],'temperature':_0x218ddf}),'modelId':_0x27e78b,'modelType':_0x5b52dd}),await this[_0x543b11(0x1e9)][_0x543b11(0x146)](_0x4728c0['user']['id'],_0x543b11(0x1bc)+(_0x146b08===0x1?0x3:0x4),0x1,_0x3eb8da);}),_0x243ba1['on'](_0x54237a(0x17d),_0x3e4b96=>{const _0x28c4c5=_0x54237a;console[_0x28c4c5(0x1ea)](_0x3e4b96);});if(Number(_0x1b983e)===0x1){let _0x454a0a=!![];_0x4d8df7=await this[_0x54237a(0x1b3)]['sendMessage'](_0x137059?_0x22e665:_0x22b539,{..._0x570422,'onProgress':_0x5ef95a=>{const _0x39d281=_0x54237a;_0x243ba1[_0x39d281(0x10d)](_0x454a0a?JSON[_0x39d281(0x11b)](_0x5ef95a):'\x0a'+JSON[_0x39d281(0x11b)](_0x5ef95a)),_0x454a0a=![],_0x4e87aa=_0x5ef95a;},'abortSignal':_0xad4892[_0x54237a(0xb0)]}),_0x537da9=!![];}if(Number(_0x1b983e)===0x2){let _0xe69b77=!![];const _0x263220=await this[_0x54237a(0x1a4)][_0x54237a(0x192)](_0x137059?_0x22e665:_0x22b539,{'parentMessageId':_0x5232a1,'maxRounds':(0x0,helper_1['addOneIfOdd'])(_0x284147)});_0x4d8df7=await(0x0,baidu_1[_0x54237a(0x19b)])(_0x137059?_0x22e665:_0x263220,{'temperature':_0x218ddf,'accessToken':_0xe12c0b,'model':_0x37eb50,'onProgress':_0xd78f31=>{const _0x1410bd=_0x54237a;_0x243ba1[_0x1410bd(0x10d)](_0xe69b77?JSON['stringify'](_0xd78f31):'\x0a'+JSON['stringify'](_0xd78f31)),_0xe69b77=![],_0x4e87aa=_0xd78f31;}}),_0x537da9=!![];}if(Number(_0x1b983e)===0x3){let _0x39e593=!![];const _0x57e100=await this[_0x54237a(0x1a4)][_0x54237a(0x192)](_0x137059?_0x22e665:_0x22b539,{'parentMessageId':_0x5232a1,'maxRounds':(0x0,helper_1[_0x54237a(0xd5)])(_0x284147)});_0x4d8df7=await(0x0,zhipu_1[_0x54237a(0x10f)])(_0x137059?_0x22e665:_0x57e100,{'temperature':_0x218ddf,'key':_0x3f57bb,'model':_0x37eb50,'onProgress':_0x4fb799=>{_0x243ba1['write'](_0x39e593?JSON['stringify'](_0x4fb799):'\x0a'+JSON['stringify'](_0x4fb799)),_0x39e593=![],_0x4e87aa=_0x4fb799;}}),_0x537da9=!![];}if(Number(_0x1b983e)===0x4){let _0x2036a0=!![];const {key:_0x36bb1b,appid:_0x3f8ae7,secret:_0x3ba462,model:_0x2952bb}=_0x110de8,_0x1c81ea=await this[_0x54237a(0x1a4)][_0x54237a(0x192)](_0x137059?_0x22e665:_0x22b539,{'parentMessageId':_0x5232a1,'maxRounds':(0x0,helper_1[_0x54237a(0xd5)])(_0x284147)}),_0xd01f95=new spark_1['XunFeiSpark']({'appid':_0x3f8ae7,'secret':_0x3ba462,'key':_0x36bb1b});_0x4d8df7=await _0xd01f95[_0x54237a(0x91)](_0x137059?_0x22e665:_0x1c81ea,{'temperature':_0x218ddf,'model':_0x2952bb,'onProgress':_0x58dd9a=>{const _0x48cc1e=_0x54237a;_0x243ba1[_0x48cc1e(0x10d)](_0x2036a0?JSON[_0x48cc1e(0x11b)](_0x58dd9a):'\x0a'+JSON['stringify'](_0x58dd9a)),_0x2036a0=![],_0x4e87aa=_0x58dd9a;},'abortController':_0xad4892}),_0x537da9=!![];}const _0x518b49={'id':this[_0x54237a(0x1a4)][_0x54237a(0x184)](),'text':_0x22b539,'role':_0x54237a(0x1a9),'name':undefined,'usage':null,'parentMessageId':_0x5232a1,'conversationId':_0x4d8df7?.[_0x54237a(0xd0)]||null};_0x5458c0={'model':_0x37eb50,'parentMessageId':_0x5232a1},await this[_0x54237a(0x1a4)][_0x54237a(0x17b)](_0x518b49);const _0x5ee31b={'id':_0x4d8df7?.['id']||this['gomaxAiStore'][_0x54237a(0x184)](),'text':_0x4d8df7['text'],'role':_0x54237a(0xda),'name':undefined,'usage':_0x4d8df7[_0x54237a(0x1c8)],'parentMessageId':_0x518b49['id'],'conversationId':_0x4d8df7?.['conversationId']};await this['gomaxAiStore'][_0x54237a(0x17b)](_0x5ee31b),_0x5458c0={'model':_0x37eb50,'parentMessageId':_0x518b49['id']};}else console[_0x54237a(0x1ea)](_0x54237a(0x11c)),_0x4d8df7=await this[_0x54237a(0x1b3)][_0x54237a(0x1e1)](_0x137059?_0x22e665:_0x22b539,_0x570422);const _0x3b7e55=(0x0,helper_1[_0x54237a(0x117)])(_0x1b983e,_0x4d8df7,_0x5458c0),{prompt_tokens:prompt_tokens=0x0,completion_tokens:completion_tokens=0x0,total_tokens:total_tokens=0x0}=_0x3b7e55[_0x54237a(0x1c8)];await this['userBalanceService'][_0x54237a(0x146)](_0x4728c0[_0x54237a(0x1a9)]['id'],_0x54237a(0x1bc)+(_0x146b08===0x1?0x3:0x4),_0x3a88aa,total_tokens);_0x3feeb6===_0x54237a(0x1ec)?await this['gptsService'][_0x54237a(0x7e)](_0x5dc58e,total_tokens):await this[_0x54237a(0xc2)][_0x54237a(0x154)](_0x5dc58e,total_tokens);const _0x32e5ab=(0x0,utils_1[_0x54237a(0x1b8)])(_0x4728c0);await this[_0x54237a(0x74)][_0x54237a(0x149)]({'appId':_0x14e99c,'curIp':_0x32e5ab,'logType':_0x3feeb6===_0x54237a(0x1ec)?0x2:0x1,'userId':_0x4728c0[_0x54237a(0x1a9)]['id'],'type':balance_constant_1[_0x54237a(0x105)][_0x54237a(0x143)],'prompt':_0x22b539,'answer':'','promptTokens':prompt_tokens,'completionTokens':0x0,'totalTokens':total_tokens,'model':_0x3b7e55[_0x54237a(0x1bc)],'role':'user','groupId':_0x165311,'requestOptions':JSON[_0x54237a(0x11b)]({'options':null,'prompt':_0x22b539}),'modelId':_0x27e78b,'modelType':_0x5b52dd});const _0x34078f=await this['chatLogService'][_0x54237a(0x149)]({'appId':_0x14e99c,'curIp':_0x32e5ab,'logType':_0x3feeb6===_0x54237a(0x1ec)?0x2:0x1,'userId':_0x4728c0[_0x54237a(0x1a9)]['id'],'type':balance_constant_1[_0x54237a(0x105)][_0x54237a(0x143)],'prompt':_0x22b539,'answer':_0x3b7e55?.[_0x54237a(0x1c2)],'promptTokens':prompt_tokens,'completionTokens':completion_tokens,'totalTokens':total_tokens,'model':_0x37eb50,'role':_0x54237a(0xda),'groupId':_0x165311,'requestOptions':JSON[_0x54237a(0x11b)]({'options':{'model':_0x37eb50,'temperature':_0x218ddf},'prompt':_0x22b539}),'conversationOptions':JSON[_0x54237a(0x11b)]({'conversationId':_0x4d8df7[_0x54237a(0xd0)],'model':_0x37eb50,'parentMessageId':_0x4d8df7['id'],'temperature':_0x218ddf}),'modelId':_0x27e78b,'modelType':_0x5b52dd});common_1[_0x54237a(0x178)]['debug'](_0x54237a(0x1d0)+_0x4728c0['user']['id']+'\x20model:\x20'+_0x37eb50+_0x54237a(0x183)+_0x3f57bb+_0x54237a(0xa6)+_0xa044a8+_0x54237a(0x1be)+maxModelTokens+_0x54237a(0x11a)+maxResponseTokens,_0x54237a(0x17e));const _0x5d38a2=await this[_0x54237a(0x1e9)][_0x54237a(0xa0)](_0x4728c0[_0x54237a(0x1a9)]['id']);return _0x4d8df7['userBanance']={..._0x5d38a2},_0x4d8df7['result']&&(_0x4d8df7['result']=''),_0x4d8df7[_0x54237a(0x71)]=!![],_0x4d8df7[_0x54237a(0x80)]=_0x34078f['id'],_0x243ba1?_0x243ba1[_0x54237a(0x10d)]('\x0a'+JSON[_0x54237a(0x11b)](_0x4d8df7)):_0x4d8df7[_0x54237a(0x1c2)];}catch(_0x326ed4){console[_0x54237a(0x1ea)](_0x54237a(0xbc),_0x3f57bb,_0x326ed4);const _0x4d712a=_0x326ed4[_0x54237a(0x1d8)];if(_0x326ed4[_0x54237a(0x144)]&&_0x326ed4[_0x54237a(0x144)]===0x192){const _0x593766={'message':_0x54237a(0xc1)+_0x326ed4[_0x54237a(0x1bb)],'code':0x192};if(_0x243ba1)return _0x243ba1[_0x54237a(0x10d)](JSON[_0x54237a(0x11b)](_0x593766));else throw new common_1['HttpException'](_0x326ed4[_0x54237a(0x1bb)],common_1[_0x54237a(0xa1)][_0x54237a(0x194)]);}if(!_0x4d712a){if(_0x243ba1)return _0x243ba1[_0x54237a(0x10d)](JSON[_0x54237a(0x11b)]({'message':_0x326ed4['message'],'code':0x1f4}));else throw new common_1['HttpException'](_0x326ed4[_0x54237a(0x1bb)],common_1['HttpStatus'][_0x54237a(0x13c)]);}let _0x5a1dcf=errorMessage_constant_1['OpenAiErrorCodeMessage'][_0x4d712a]?errorMessage_constant_1[_0x54237a(0x190)][_0x4d712a]:_0x54237a(0x85);_0x326ed4?.[_0x54237a(0x1bb)]['includes'](_0x54237a(0x1c1))&&Number(_0x1b983e)===0x1&&(await this[_0x54237a(0xc2)]['lockKey'](_0x5dc58e,'当前模型key已被封禁、已冻结当前调用Key、尝试重新对话试试吧！',-0x1),_0x5a1dcf=_0x54237a(0xd7));_0x326ed4?.['statusCode']===0x1ad&&_0x326ed4['message'][_0x54237a(0xc7)](_0x54237a(0x139))&&Number(_0x1b983e)===0x1&&(await this[_0x54237a(0xc2)]['lockKey'](_0x5dc58e,_0x54237a(0x1b6),-0x3),_0x5a1dcf=_0x54237a(0x1c6));_0x326ed4?.['statusCode']===0x191&&_0x326ed4[_0x54237a(0x1bb)][_0x54237a(0xc7)]('Incorrect\x20API\x20key\x20provided')&&Number(_0x1b983e)===0x1&&(await this['modelsService']['lockKey'](_0x5dc58e,'模型秘钥错误或模型余额不足',-0x2),_0x5a1dcf='模型秘钥错误或模型金额不足，请联系管理员！');_0x326ed4?.[_0x54237a(0x1d8)]===0x191&&Number(_0x1b983e)===0x1&&(_0x5a1dcf=_0x54237a(0xa9));_0x326ed4?.['statusCode']===0x191&&_0x326ed4[_0x54237a(0x1bb)][_0x54237a(0xc7)](_0x54237a(0x8c))&&Number(_0x1b983e)===0x1&&(await this['modelsService'][_0x54237a(0xea)](_0x5dc58e,_0x54237a(0xd3),-0x2),_0x5a1dcf=_0x54237a(0xa9));_0x326ed4?.[_0x54237a(0x1d8)]===0x194&&_0x326ed4[_0x54237a(0x1bb)][_0x54237a(0xc7)]('This\x20is\x20not\x20a\x20chat\x20model\x20and\x20thus\x20not\x20supported')&&Number(_0x1b983e)===0x1&&(await this[_0x54237a(0xc2)][_0x54237a(0xea)](_0x5dc58e,_0x54237a(0x145),-0x4),_0x5a1dcf=_0x54237a(0x86));_0x4d712a===0x190&&console[_0x54237a(0x1ea)](_0x54237a(0x174),_0x326ed4,_0x326ed4[_0x54237a(0x1bb)]);const _0x54d66f={'message':_0x5a1dcf||_0x54237a(0x7b),'code':_0x4d712a===0x191?0x191:_0x4d712a||0x1f4};if(_0x243ba1)_0x243ba1[_0x54237a(0x1d8)]=0x190,_0x243ba1['write'](JSON[_0x54237a(0x11b)](_0x54d66f));else throw new common_1[(_0x54237a(0xae))](_0x54d66f[_0x54237a(0x1bb)],common_1[_0x54237a(0xa1)]['BAD_REQUEST']);}finally{_0x243ba1&&_0x243ba1[_0x54237a(0xac)]();}}async['chatRealTime'](_0x1bfd02,_0x2639b1,_0x2bbadb){const _0x31c6cb=_0x27aeda,{audio:_0x596259,voice:_0x8149f9}=_0x1bfd02,_0xb569a3=_0x2639b1[_0x31c6cb(0x155)],_0x24e56f=await this[_0x31c6cb(0xc2)][_0x31c6cb(0x1a3)]();if(!_0x24e56f)throw _0x31c6cb(0x15f);const {deduct:_0x1214ea,deductType:_0x93aad,key:_0x2a216b,timeout:_0x4bec07,proxyUrl:_0x17314c}=_0x24e56f;await this[_0x31c6cb(0xe6)][_0x31c6cb(0x11f)](_0x2639b1[_0x31c6cb(0x1a9)]),await this['userBalanceService'][_0x31c6cb(0x1de)](_0x2639b1,_0x93aad===0x1?'model3':_0x31c6cb(0x78),_0x1214ea),console[_0x31c6cb(0x1ea)](_0x31c6cb(0x176),_0x2a216b,_0x17314c),this[_0x31c6cb(0x88)][_0x31c6cb(0x185)]=_0x2a216b,this[_0x31c6cb(0x88)][_0x31c6cb(0x114)]=(_0x17314c||this[_0x31c6cb(0x128)])+_0x31c6cb(0x16a),this[_0x31c6cb(0x88)][_0x31c6cb(0x1b5)]=0x989680;const _0x3b8ca5=await this[_0x31c6cb(0x88)][_0x31c6cb(0x1f0)]['transcriptions'][_0x31c6cb(0x1ba)]({'file':(0x0,fs_2[_0x31c6cb(0x81)])((0x0,path_1[_0x31c6cb(0xc4)])(_0x596259['path'])),'model':_0x31c6cb(0x13a),'language':'zh','response_format':_0x31c6cb(0x127),'temperature':0x0})[_0x31c6cb(0x148)](_0x41c78e=>_0x41c78e['text'])[_0x31c6cb(0x12d)](_0x3926ce=>{const _0x1eb9fd=_0x31c6cb;common_1['Logger'][_0x1eb9fd(0x17d)](_0x3926ce);});console[_0x31c6cb(0x1ea)]('audio2text\x20',_0x3b8ca5);if(!_0x3b8ca5){this[_0x31c6cb(0x13e)]((0x0,path_1[_0x31c6cb(0xc4)])(_0x596259[_0x31c6cb(0x1f2)]));throw new common_1['HttpException']('语音转文本失败',common_1[_0x31c6cb(0xa1)][_0x31c6cb(0x13c)]);}const _0x32a484=await this[_0x31c6cb(0x13f)]({'userId':_0x2639b1[_0x31c6cb(0x1a9)]['id'],'prompt':_0x3b8ca5,'abortController':_0xb569a3})['catch'](_0x1d0c31=>{const _0x171233=_0x31c6cb;common_1[_0x171233(0x178)]['error'](_0x1d0c31);});console[_0x31c6cb(0x1ea)](_0x31c6cb(0xf9),_0x32a484);if(!_0x32a484){this['removeFile']((0x0,path_1[_0x31c6cb(0xc4)])(_0x596259['path']));throw new common_1[(_0x31c6cb(0xae))]('内容提取失败',common_1[_0x31c6cb(0xa1)][_0x31c6cb(0x13c)]);}console['log'](_0x31c6cb(0x7f),_0x32a484[_0x31c6cb(0x6d)]);let _0x545c28=_0x32a484[_0x31c6cb(0x6d)]>0x1000?_0x32a484[_0x31c6cb(0x14b)](0x0,0xfff):_0x32a484;const _0xe3eb52=await this['openAi']['audio'][_0x31c6cb(0x1ac)][_0x31c6cb(0x1ba)]({'input':_0x545c28,'model':'tts-1','response_format':_0x31c6cb(0x1d3),'voice':_0x8149f9,'speed':0x1})[_0x31c6cb(0x148)](_0x34f2e6=>_0x34f2e6[_0x31c6cb(0x92)]())[_0x31c6cb(0x12d)](_0x3bf81b=>{const _0x339c5e=_0x31c6cb;common_1[_0x339c5e(0x178)][_0x339c5e(0x17d)](_0x3bf81b);});if(!_0xe3eb52){this[_0x31c6cb(0x13e)]((0x0,path_1[_0x31c6cb(0xc4)])(_0x596259['path']));throw new common_1[(_0x31c6cb(0xae))](_0x31c6cb(0x120),common_1[_0x31c6cb(0xa1)][_0x31c6cb(0x13c)]);}const _0xf926=Buffer[_0x31c6cb(0x1af)](_0xe3eb52);return _0x2bbadb['setHeader'](_0x31c6cb(0xb4),_0x31c6cb(0x182)),_0x2bbadb[_0x31c6cb(0x10d)](_0xf926),_0x2bbadb[_0x31c6cb(0xac)](_0xf926),this[_0x31c6cb(0x13e)]((0x0,path_1[_0x31c6cb(0xc4)])(_0x596259['path'])),_0xf926;}async[_0x27aeda(0x13f)](_0x20d607){const _0x837c60=_0x27aeda,{prompt:_0x595661,userId:_0x1e3e0c,abortController:_0x16ce6d}=_0x20d607,_0x73b450=await this['modelsService'][_0x837c60(0x17c)](model_constant_1['EModelType'][_0x837c60(0x12e)]),{keyType:_0x1492df,model:_0x271052,topN:_0x253f6e}=_0x73b450[_0x837c60(0x156)];let _0x25a0e4=await this['modelsService'][_0x837c60(0xc0)](_0x271052);if(!_0x25a0e4)throw new common_1['HttpException'](_0x837c60(0x1a5),common_1[_0x837c60(0xa1)][_0x837c60(0x13c)]);const {deduct:_0x46d4a6,deductType:_0x5f4baf,key:_0x2beaa0,id:_0x56ed92,parentMessageId:_0x401e97,timeoutMs:_0x4bfdd0}=_0x25a0e4,{maxModelTokens:maxModelTokens=0x1f40,maxResponseTokens:maxResponseTokens=0x1000}=_0x25a0e4,_0x54bfec=await this[_0x837c60(0x6c)](_0x25a0e4);this[_0x837c60(0x1b3)][_0x837c60(0x185)]=(0x0,utils_1[_0x837c60(0x147)])(_0x2beaa0),this[_0x837c60(0x1b3)][_0x837c60(0xd6)]=_0x54bfec+'/v1',this['api'][_0x837c60(0xaf)]=maxModelTokens,this[_0x837c60(0x1b3)]['maxResponseTokens']=maxResponseTokens>=maxModelTokens?Math['abs'](Math[_0x837c60(0x1ed)](maxModelTokens/0x2)):maxResponseTokens;let _0x2fd879=null,_0x18c040=null;try{const _0x162449={'parentMessageId':_0x401e97,'timeoutMs':+_0x4bfdd0,'completionParams':{'model':_0x271052,'temperature':_0x253f6e}};_0x2fd879=await this[_0x837c60(0x1b3)][_0x837c60(0x1e1)](_0x595661,{..._0x162449,'abortSignal':_0x16ce6d[_0x837c60(0xb0)]});const _0x3e9c60=(0x0,helper_1[_0x837c60(0x117)])(_0x1492df,_0x2fd879,_0x18c040),{total_tokens:total_tokens=0x0}=_0x3e9c60[_0x837c60(0x1c8)];return await this[_0x837c60(0x1e9)][_0x837c60(0x146)](_0x1e3e0c,_0x837c60(0x1bc)+(_0x5f4baf===0x1?0x3:0x4),_0x46d4a6,total_tokens),await this[_0x837c60(0xc2)]['saveUseLog'](_0x56ed92,total_tokens),_0x2fd879['text'];}catch(_0x2f2b23){common_1[_0x837c60(0x178)][_0x837c60(0x1ea)](_0x2f2b23);const _0x1b6795=_0x2f2b23[_0x837c60(0x1d8)];console[_0x837c60(0x1ea)](_0x1b6795);if(_0x2f2b23[_0x837c60(0x144)]&&_0x2f2b23[_0x837c60(0x144)]===0x192){const _0x940b2a={'message':_0x837c60(0xc1)+_0x2f2b23[_0x837c60(0x1bb)],'code':0x192};throw new common_1[(_0x837c60(0xae))](_0x2f2b23[_0x837c60(0x1bb)],common_1[_0x837c60(0xa1)]['PAYMENT_REQUIRED']);}if(!_0x1b6795)throw new common_1[(_0x837c60(0xae))](_0x2f2b23[_0x837c60(0x1bb)],common_1[_0x837c60(0xa1)][_0x837c60(0x13c)]);let _0x4790d5=errorMessage_constant_1['OpenAiErrorCodeMessage'][_0x1b6795]?errorMessage_constant_1[_0x837c60(0x190)][_0x1b6795]:_0x837c60(0x85);_0x2f2b23?.[_0x837c60(0x1bb)]['includes'](_0x837c60(0x1c1))&&Number(_0x1492df)===0x1&&(await this[_0x837c60(0xc2)][_0x837c60(0xea)](_0x56ed92,_0x837c60(0xc5),-0x1),_0x4790d5='当前模型key已被封禁');_0x2f2b23?.[_0x837c60(0x1d8)]===0x1ad&&_0x2f2b23[_0x837c60(0x1bb)][_0x837c60(0xc7)](_0x837c60(0x139))&&Number(_0x1492df)===0x1&&(await this['modelsService'][_0x837c60(0xea)](_0x56ed92,_0x837c60(0x1b6),-0x3),_0x4790d5='当前模型key余额已耗尽');_0x2f2b23?.[_0x837c60(0x1d8)]===0x191&&_0x2f2b23[_0x837c60(0x1bb)][_0x837c60(0xc7)](_0x837c60(0x6f))&&Number(_0x1492df)===0x1&&(await this[_0x837c60(0xc2)][_0x837c60(0xea)](_0x56ed92,'提供了错误的模型秘钥',-0x2),_0x4790d5=_0x837c60(0x14f));_0x2f2b23?.['statusCode']===0x191&&_0x2f2b23['message'][_0x837c60(0xc7)]('Unauthorized')&&Number(_0x1492df)===0x1&&(await this[_0x837c60(0xc2)][_0x837c60(0xea)](_0x56ed92,'当前模型key余额已耗尽',-0x2),_0x4790d5=_0x837c60(0x168));_0x2f2b23?.[_0x837c60(0x1d8)]===0x194&&_0x2f2b23['message']['includes'](_0x837c60(0x19d))&&Number(_0x1492df)===0x1&&(await this[_0x837c60(0xc2)][_0x837c60(0xea)](_0x56ed92,'当前模型不是聊天模型',-0x4),_0x4790d5=_0x837c60(0x86));_0x2f2b23?.[_0x837c60(0x1d8)]===0x133&&_0x2f2b23[_0x837c60(0x1bb)][_0x837c60(0xc7)](_0x837c60(0x15b))&&Number(_0x1492df)===0x1&&(console['log'](_0x837c60(0xe7)),_0x4790d5='\x20！');_0x1b6795===0x190&&console[_0x837c60(0x1ea)](_0x837c60(0x174),_0x2f2b23,_0x2f2b23[_0x837c60(0x1bb)]);const _0x2a391f={'message':_0x4790d5||_0x837c60(0x7b),'code':_0x1b6795===0x191?0x191:_0x1b6795||0x1f4};throw new common_1[(_0x837c60(0xae))](_0x2a391f[_0x837c60(0x1bb)],common_1[_0x837c60(0xa1)]['BAD_REQUEST']);}}async[_0x27aeda(0x199)](_0x182cae,_0x2505c2){const _0x4d5ac6=_0x27aeda;await this['badwordsService'][_0x4d5ac6(0x1a1)](_0x182cae[_0x4d5ac6(0x18b)],_0x2505c2['user']['id']),common_1['Logger'][_0x4d5ac6(0x1ea)](_0x4d5ac6(0x166)+_0x182cae['prompt'],_0x4d5ac6(0xec)),await this[_0x4d5ac6(0xe6)][_0x4d5ac6(0x11f)](_0x2505c2[_0x4d5ac6(0x1a9)]),await this['userBalanceService']['validateBalance'](_0x2505c2,balance_constant_1[_0x4d5ac6(0x105)][_0x4d5ac6(0x9d)],_0x182cae['n']||0x1);let _0x21f871=[];const _0x417005=await this[_0x4d5ac6(0xc2)][_0x4d5ac6(0xe0)](model_constant_1[_0x4d5ac6(0x1e2)][_0x4d5ac6(0x1f5)]),{key:_0x5f01ba,model:_0x2cab60,proxyUrl:_0x542be7}=await this[_0x4d5ac6(0x15a)](_0x417005),_0x1fa84b=_0x542be7+'/v1/images/generations';try{const _0x945216=await axios_1[_0x4d5ac6(0x83)][_0x4d5ac6(0x119)](_0x1fa84b,{..._0x182cae,'model':_0x2cab60,'response_format':'b64_json'},{'headers':{'Authorization':'Bearer\x20'+_0x5f01ba}});_0x21f871=_0x945216[_0x4d5ac6(0x17a)]['data'];}catch(_0x509d90){console[_0x4d5ac6(0x1ea)](_0x4d5ac6(0x8a),_0x509d90);const _0x479865=_0x509d90?.[_0x4d5ac6(0x97)]?.['status']||0x1f4,_0x354346=_0x509d90?.['response']?.[_0x4d5ac6(0x17a)]?.['error']?.[_0x4d5ac6(0x1bb)];if(_0x479865===0x1ad)throw new common_1[(_0x4d5ac6(0xae))](_0x4d5ac6(0xf0),common_1['HttpStatus'][_0x4d5ac6(0x13c)]);if(_0x479865===0x190||_0x354346[_0x4d5ac6(0xc7)](_0x4d5ac6(0x10c)))throw new common_1[(_0x4d5ac6(0xae))](_0x4d5ac6(0xb6),common_1[_0x4d5ac6(0xa1)]['BAD_REQUEST']);if(_0x479865===0x1f4)throw new common_1[(_0x4d5ac6(0xae))](_0x4d5ac6(0x19f),common_1[_0x4d5ac6(0xa1)][_0x4d5ac6(0x13c)]);if(_0x479865===0x191)throw new common_1[(_0x4d5ac6(0xae))](_0x4d5ac6(0xb7),common_1[_0x4d5ac6(0xa1)][_0x4d5ac6(0x13c)]);throw new common_1[(_0x4d5ac6(0xae))]('绘制图片失败，请稍后试试吧！',common_1[_0x4d5ac6(0xa1)]['BAD_REQUEST']);}const _0x44b193=[];for(const _0x3b7f25 of _0x21f871){const _0x4f0d3b=uuid['v4']()[_0x4d5ac6(0x14b)](0x0,0xa)+_0x4d5ac6(0xd4),_0x40cdd4=Buffer[_0x4d5ac6(0x1af)](_0x3b7f25[_0x4d5ac6(0x72)],_0x4d5ac6(0x1a0));_0x44b193[_0x4d5ac6(0xa3)](this[_0x4d5ac6(0x11d)][_0x4d5ac6(0xdd)]({'filename':_0x4f0d3b,'buffer':_0x40cdd4}));}const _0x2ebf59=await Promise['all'](_0x44b193);await this['userBalanceService'][_0x4d5ac6(0x146)](_0x2505c2[_0x4d5ac6(0x1a9)]['id'],_0x4d5ac6(0x90),_0x182cae['n'],_0x182cae['n']||0x1);const _0x1646f9=(0x0,utils_1[_0x4d5ac6(0x1b8)])(_0x2505c2),_0x41af51=[],_0x406be9=await this[_0x4d5ac6(0x11d)][_0x4d5ac6(0x134)](),[_0x4e12ae,_0x2ded2a]=_0x182cae[_0x4d5ac6(0x15e)][_0x4d5ac6(0xb3)]('x');return _0x2ebf59[_0x4d5ac6(0x9c)](_0x16b43d=>{const _0x5b322b=_0x4d5ac6;_0x41af51[_0x5b322b(0xa3)](this[_0x5b322b(0x74)][_0x5b322b(0x149)]({'curIp':_0x1646f9,'logType':0x3,'userId':_0x2505c2[_0x5b322b(0x1a9)]['id'],'type':balance_constant_1[_0x5b322b(0x105)]['PAINT_TYPE'],'prompt':_0x182cae[_0x5b322b(0x18b)],'answer':_0x16b43d,'fileInfo':JSON[_0x5b322b(0x11b)]({'cosType':_0x406be9,'width':_0x4e12ae,'height':_0x2ded2a,'cosUrl':_0x16b43d}),'promptTokens':0x0,'completionTokens':0x0,'totalTokens':0x0,'model':_0x5b322b(0xa7)}));}),await Promise[_0x4d5ac6(0x14c)](_0x41af51),_0x2ebf59;}async[_0x27aeda(0x126)](_0x5ac932){const _0xbac5d=_0x27aeda,_0x3cf1f7=await this['globalConfigService'][_0xbac5d(0x10a)]([_0xbac5d(0xb8)])||_0xbac5d(0x1bf);try{const _0x5a0af3={'Content-Type':'application/json','Authorization':_0xbac5d(0x106)+_0x5ac932},_0x128b6b=dayjs()['format'](_0xbac5d(0x10b)),_0x5a3282=dayjs()[_0xbac5d(0xf4)](0x63,_0xbac5d(0x19a))[_0xbac5d(0x16d)](_0xbac5d(0x10b)),_0x194b13=await axios_1['default'][_0xbac5d(0x1aa)](_0x3cf1f7+_0xbac5d(0x1bd)+_0x5a3282+_0xbac5d(0x1d6)+_0x128b6b,{'headers':_0x5a0af3}),_0x3e1ee6=_0x194b13?.[_0xbac5d(0x17a)]['total_usage']??0x0,_0x2cd4f6=await axios_1[_0xbac5d(0x83)][_0xbac5d(0x1aa)](_0x3cf1f7+_0xbac5d(0x1ad),{'headers':_0x5a0af3}),{has_payment_method:_0x12fb26,hard_limit_usd:_0x531093,access_until:_0x31e00a}=_0x2cd4f6[_0xbac5d(0x17a)],_0x103345=(_0x3e1ee6/0x64)[_0xbac5d(0x1da)](0x2),_0x298829=Number(_0x531093)['toFixed'](0x0);return{'totalAmount':_0x298829+'$','useAmount':_0x103345+'$','balance':(Number(_0x298829)-Number(_0x103345))[_0xbac5d(0x1da)](0x2)+'$','isBindCard':_0x12fb26,'expirDate':dayjs(_0x31e00a*0x3e8)[_0xbac5d(0x16d)](_0xbac5d(0xb1)),'status':0x1};}catch(_0x3328b0){return{'status':-0x1};}}async['getModelAndKeyFromUser'](_0x189dd5,_0x5a84e9){const _0x3b65e=_0x27aeda;let _0x5eed90={};_0x5a84e9===0x3?_0x5eed90=await this[_0x3b65e(0xaa)](0x3):_0x5eed90=await this[_0x3b65e(0xaa)](0x4);const {model:_0x1e78a6,key:_0x3b78ee,id:_0xd9c24}=_0x5eed90;return await this[_0x3b65e(0x87)][_0x3b65e(0x129)]()[_0x3b65e(0x191)](gptKeys_entity_1[_0x3b65e(0x197)])[_0x3b65e(0x14d)]({'useCount':()=>'useCount\x20+\x201'})[_0x3b65e(0x116)](_0x3b65e(0x136),{'id':_0xd9c24})[_0x3b65e(0x158)](),_0x5eed90;}async[_0x27aeda(0x1c5)](_0xc1d19e){const _0x4271b0=_0x27aeda,_0x5d17ad=await this[_0x4271b0(0x1ce)][_0x4271b0(0x10a)]([_0x4271b0(0xb8)])||'https://api.openai.com',_0x1a5f6e=_0x5d17ad+_0x4271b0(0x102);try{const _0x1868a4=await axios_1[_0x4271b0(0x83)]['get'](_0x1a5f6e,{'headers':{'Authorization':_0x4271b0(0x106)+_0xc1d19e}}),_0x54153d=_0x1868a4['data'][_0x4271b0(0x17a)][_0x4271b0(0xee)](_0x6f8577=>_0x6f8577['id']);return model_constant_1[_0x4271b0(0x107)][_0x4271b0(0x1dc)](_0x2c8512=>_0x54153d[_0x4271b0(0xc7)](_0x2c8512));}catch(_0x2c039f){throw new common_1[(_0x4271b0(0xae))](_0x4271b0(0xa2),common_1['HttpStatus'][_0x4271b0(0x13c)]);}}async['getKeyList'](_0x5aaf8b,_0x1c2f73){const _0x80a662=_0x27aeda;try{const _0x1a49a7={},{page:page=0x1,size:size=0xa,key:_0x1fb7a0,status:_0xf721bd,keyStatus:_0x2298d7,model:_0x52a208}=_0x5aaf8b;_0x1fb7a0&&(_0x1a49a7[_0x80a662(0xa4)]=(0x0,typeorm_1[_0x80a662(0x130)])('%'+_0x1fb7a0+'%')),_0x2298d7&&(_0x1a49a7['keyStatus']=_0x2298d7),_0x52a208&&(_0x1a49a7[_0x80a662(0x1bc)]=_0x52a208),[0x0,0x1,'0','1','-1',-0x1][_0x80a662(0xc7)](_0xf721bd)&&(_0x1a49a7['status']=_0xf721bd);const [_0x557da3,_0xfab3a0]=await this[_0x80a662(0x87)]['findAndCount']({'skip':(page-0x1)*size,'take':size,'where':_0x1a49a7,'order':{'id':_0x80a662(0x103)}}),_0x420e9a=[];_0x557da3[_0x80a662(0x9c)](_0x32df13=>_0x420e9a['push'](this['getKeyDetail'](_0x32df13[_0x80a662(0xa4)])));const _0x443104=await Promise[_0x80a662(0x14c)](_0x420e9a);return _0x557da3[_0x80a662(0x9c)]((_0x14f12f,_0x5e1d05)=>_0x14f12f[_0x80a662(0x170)]=_0x443104[_0x5e1d05]),_0x1c2f73['user']['role']!=='super'&&_0x557da3['forEach'](_0x3a375e=>{const _0x33d06a=_0x80a662;_0x3a375e['key']=_0x3a375e[_0x33d06a(0xa4)]?(0x0,utils_1[_0x33d06a(0x1ca)])(_0x3a375e[_0x33d06a(0xa4)]):'',_0x3a375e[_0x33d06a(0x115)]=_0x3a375e[_0x33d06a(0x115)]?(0x0,utils_1[_0x33d06a(0x1ca)])(_0x3a375e[_0x33d06a(0x115)]):'';}),{'rows':_0x557da3,'count':_0xfab3a0};}catch(_0x3cee5f){console[_0x80a662(0x1ea)](_0x80a662(0x101),_0x3cee5f);throw new common_1['HttpException'](_0x80a662(0x12b),common_1['HttpStatus'][_0x80a662(0x13c)]);}}async['addKey'](_0x40629b){const _0x42f7e8=_0x27aeda,{key:_0x4e4415}=_0x40629b,_0x3d6214=await this['gptKeysEntity'][_0x42f7e8(0x1d9)]({'where':{'key':_0x4e4415}});if(_0x3d6214)throw new common_1[(_0x42f7e8(0xae))](_0x42f7e8(0x8f),common_1[_0x42f7e8(0xa1)][_0x42f7e8(0x13c)]);const _0x407940=await this[_0x42f7e8(0x87)][_0x42f7e8(0xc6)](_0x40629b);return await this[_0x42f7e8(0x8e)](),_0x407940;}async[_0x27aeda(0x1d4)](_0x24b35d){const _0x10b88c=_0x27aeda,{keyList:_0x4a579e}=_0x24b35d,_0x573c77=await this[_0x10b88c(0x87)]['find']({'where':{'key':(0x0,typeorm_1['In'])(_0x4a579e)}}),_0x10b614=_0x573c77[_0x10b88c(0xee)](_0x16105e=>_0x16105e['key']),_0x248f29=_0x4a579e[_0x10b88c(0x1dc)](_0x38e511=>!_0x10b614[_0x10b88c(0xc7)](_0x38e511)),_0x5016c4=_0x248f29[_0x10b88c(0xee)](_0x463e89=>{const _0x15f803=_0x10b88c;return{'key':_0x463e89,'status':0x1,'model':_0x15f803(0x187)};}),_0x3085b1=await this['gptKeysEntity'][_0x10b88c(0xc6)](_0x5016c4);let _0x391386='本次成功添加'+_0x5016c4[_0x10b88c(0x6d)]+_0x10b88c(0x14a);return _0x10b614[_0x10b88c(0x6d)]&&(_0x391386+=_0x10b88c(0x75)+_0x10b614[_0x10b88c(0x6d)]+_0x10b88c(0x1a8)),_0x391386;}async[_0x27aeda(0x113)](_0x35f2dc){const _0x4cb5c1=_0x27aeda,{id:_0x34df9d}=_0x35f2dc,_0x54a71d=await this['gptKeysEntity'][_0x4cb5c1(0x1d9)]({'where':{'id':_0x34df9d}});if(!_0x54a71d)throw new common_1['HttpException']('key不存在',common_1['HttpStatus'][_0x4cb5c1(0x13c)]);const _0x54de96=await this['gptKeysEntity'][_0x4cb5c1(0x191)]({'id':_0x34df9d},_0x35f2dc);if(_0x54de96['affected']>0x0)return await this[_0x4cb5c1(0x8e)](),_0x4cb5c1(0xfc);else throw new common_1[(_0x4cb5c1(0xae))]('修改失败',common_1[_0x4cb5c1(0xa1)][_0x4cb5c1(0x13c)]);}async[_0x27aeda(0xdc)](_0x56a9b0){const _0x257c35=_0x27aeda,{id:_0x51ed31}=_0x56a9b0,_0x3b7306=await this[_0x257c35(0x87)][_0x257c35(0x1d9)]({'where':{'id':_0x51ed31}});if(!_0x3b7306)throw new common_1['HttpException'](_0x257c35(0x137),common_1[_0x257c35(0xa1)][_0x257c35(0x13c)]);const _0x1fa880=await this[_0x257c35(0x87)]['delete']({'id':_0x51ed31});if(_0x1fa880[_0x257c35(0x141)]>0x0)return await this[_0x257c35(0x8e)](),_0x257c35(0x122);else throw new common_1[(_0x257c35(0xae))](_0x257c35(0xdf),common_1[_0x257c35(0xa1)][_0x257c35(0x13c)]);}async[_0x27aeda(0x8e)](){const _0x54d08c=_0x27aeda,_0x15cafb=await this[_0x54d08c(0x87)]['find']({'where':{'status':0x1},'select':['id',_0x54d08c(0xa4),_0x54d08c(0x96),_0x54d08c(0x1bc),_0x54d08c(0xaf),_0x54d08c(0xcd),'openaiProxyUrl',_0x54d08c(0x1b2)]}),_0x49e887=_0x15cafb['filter'](_0x48862c=>_0x48862c[_0x54d08c(0x1bc)][_0x54d08c(0xc7)]('gpt-3')),_0x321544=_0x15cafb['filter'](_0x5416c4=>_0x5416c4['model']['includes'](_0x54d08c(0x73)));this[_0x54d08c(0x198)]={'list3':_0x49e887,'list4':_0x321544};}async[_0x27aeda(0x138)](){const _0x570922=_0x27aeda;return await this[_0x570922(0xa8)][_0x570922(0xbd)]({'where':{'status':0x1,'count':(0x0,typeorm_1['MoreThan'])(0x0)},'select':[_0x570922(0xb5)]});}async[_0x27aeda(0xeb)](_0x268b29){const _0x37923b=_0x27aeda,{userId:_0x2877c7,count:_0x353684}=_0x268b29,_0xfed806=await this[_0x37923b(0xa8)]['findOne']({'where':{'userId':_0x2877c7}});if(_0xfed806)throw new common_1[(_0x37923b(0xae))]('用户已在白名单中！',common_1[_0x37923b(0xa1)][_0x37923b(0x13c)]);const _0x5577d4=await this[_0x37923b(0xa8)]['save'](_0x268b29);return await this[_0x37923b(0x138)](),_0x5577d4;}async[_0x27aeda(0x152)](_0x3f0324){const _0x194ab3=_0x27aeda,{id:_0x101014}=_0x3f0324,_0x1e4696=await this[_0x194ab3(0xa8)][_0x194ab3(0x1d9)]({'where':{'id':_0x101014}});if(!_0x1e4696)throw new common_1['HttpException']('当前记录不存在！',common_1[_0x194ab3(0xa1)]['BAD_REQUEST']);const _0x5f509a=await this[_0x194ab3(0xa8)][_0x194ab3(0x191)]({'id':_0x101014},_0x3f0324);if(_0x5f509a['affected']>0x0)return await this['getUserWhiteList'](),_0x194ab3(0x76);else throw new common_1[(_0x194ab3(0xae))]('修改白名单失败',common_1[_0x194ab3(0xa1)][_0x194ab3(0x13c)]);}async[_0x27aeda(0x195)](_0x4fcff3,_0xc06141){const _0x2f9776=_0x27aeda,{page:page=0x1,size:size=0xa}=_0x4fcff3,[_0x26c1ad,_0x6f4605]=await this[_0x2f9776(0xa8)]['findAndCount']({'skip':(page-0x1)*size,'take':size,'order':{'id':_0x2f9776(0x103)}}),_0xdb50de=_0x26c1ad[_0x2f9776(0xee)](_0x28f9c5=>_0x28f9c5['userId']),_0x2daaa0=await this[_0x2f9776(0x15d)][_0x2f9776(0xbd)]({'where':{'id':(0x0,typeorm_1['In'])(_0xdb50de)}});return _0x26c1ad[_0x2f9776(0x9c)](_0x18b866=>{const _0xe2764f=_0x2f9776,_0x5b799d=_0x2daaa0[_0xe2764f(0xbd)](_0x5b3294=>_0x5b3294['id']===_0x18b866[_0xe2764f(0xb5)]);_0x18b866['username']=_0x5b799d?.[_0xe2764f(0x16f)]??'',_0x18b866['email']=_0x5b799d?.['email']??'';}),_0xc06141[_0x2f9776(0x1a9)]['role']!==_0x2f9776(0xf8)&&_0x26c1ad[_0x2f9776(0x9c)](_0x42f311=>_0x42f311[_0x2f9776(0x140)]=(0x0,utils_1[_0x2f9776(0x6e)])(_0x42f311[_0x2f9776(0x140)])),{'rows':_0x26c1ad,'count':_0x6f4605};}async['getModelProxyUrl'](_0x174561){const _0x716793=_0x27aeda,{proxyUrl:_0x1f43c7}=_0x174561,_0xa0859c=await this[_0x716793(0x1ce)][_0x716793(0x10a)]([_0x716793(0xb8)]);return _0x1f43c7||_0xa0859c||_0x716793(0x1bf);}async[_0x27aeda(0xdd)](_0x25c6f4,_0xfc39f8){const _0x57e558=_0x27aeda;try{const {cosBucket:_0x43d235,cosRegion:_0x5600c2,tencentCosStatus:_0x160818,tencentCosAcceleratedDomain:_0x4a0b58}=await this[_0x57e558(0x1ce)][_0x57e558(0x10a)]([_0x57e558(0x69),_0x57e558(0xc9),'tencentCosStatus',_0x57e558(0x7a)]);if(_0x160818!=='1')throw new common_1[(_0x57e558(0xae))]('请开启并配置腾讯云COS存储参数后再使用',common_1[_0x57e558(0xa1)][_0x57e558(0x13c)]);!this['cosApi']&&await this['getTencentCOSStorage'](!![]);const _0xa8d910=_0x57e558(0x9a),_0x167c38=(0x0,path_1[_0x57e558(0x19c)])(_0xfc39f8['filename']),_0x614291=await this[_0x57e558(0x1cf)]['putObject']({'Bucket':_0x43d235,'Region':_0x5600c2,'Key':_0xa8d910+Date['now']()+(''+_0x167c38),'Body':(0x0,fs_2[_0x57e558(0x81)])((0x0,path_1[_0x57e558(0xc4)])(_0xfc39f8[_0x57e558(0x1f2)])),'onProgress':_0x77108b=>{const _0x37bdef=_0x57e558;common_1[_0x37bdef(0x178)][_0x37bdef(0x1ea)](_0x77108b,'upload\x20cos');}})[_0x57e558(0x12d)](_0x4b9cb9=>{throw _0x4b9cb9;});return _0x57e558(0x1e5)+_0x614291[_0x57e558(0x1e8)];}catch(_0x1a268b){return console[_0x57e558(0x1ea)](_0x1a268b),Promise[_0x57e558(0x6b)](_0x1a268b);}}async[_0x27aeda(0x17f)](_0x37c4f8){const _0x428eb3=_0x27aeda,{purpose:_0x5d69e4,files:_0x4cdc18}=_0x37c4f8,_0x2473b8=new FormData(),_0x2eaaa2=(0x0,fs_2[_0x428eb3(0x81)])((0x0,path_1[_0x428eb3(0xc4)])(_0x4cdc18[_0x428eb3(0x1f2)]));_0x2473b8[_0x428eb3(0x8d)](_0x428eb3(0xed),_0x5d69e4),_0x2473b8[_0x428eb3(0x8d)](_0x428eb3(0xb2),_0x2eaaa2);const _0x148309=_0x2473b8[_0x428eb3(0x9e)](),_0xa8e309=()=>{return new Promise((_0x521991,_0x2a539e)=>{const _0x208631=_0x4136;_0x2473b8[_0x208631(0x161)]((_0x58c7af,_0x4d302a)=>{const _0x53dc95=_0x208631;if(_0x58c7af)_0x2a539e(_0x58c7af);console['log'](_0x53dc95(0x6d),_0x4d302a),_0x521991(_0x4d302a);});});};_0x148309[_0x428eb3(0x1a2)]=await _0xa8e309();const _0x1627d2=await this[_0x428eb3(0x1ce)][_0x428eb3(0x10a)]([_0x428eb3(0xb8)]),_0x1c8561='',_0x493983=_0x1c8561||_0x1627d2||_0x428eb3(0x1bf);await axios_1['default'][_0x428eb3(0x132)]({'baseURL':_0x493983+'/v1/files','method':'post','headers':_0x148309,'data':_0x2473b8,'onUploadProgress':_0x323eec=>{const _0x2ebe65=_0x428eb3;console[_0x2ebe65(0x1ea)](_0x323eec);}})[_0x428eb3(0x148)](_0x573b4f=>{const _0x7f10c3=_0x428eb3;console[_0x7f10c3(0x1ea)](_0x573b4f);});}async[_0x27aeda(0x15a)](_0x2b0549){const _0x1b87cb=_0x27aeda,{openaiModel3MaxTokens:openaiModel3MaxTokens=0x0,openaiModel3MaxTokensRes:openaiModel3MaxTokensRes=0x0,openaiModel3MaxTokens16k:openaiModel3MaxTokens16k=0x0,openaiModel3MaxTokens16kRes:openaiModel3MaxTokens16kRes=0x0,openaiModel4MaxTokens:openaiModel4MaxTokens=0x0,openaiModel4MaxTokensRes:openaiModel4MaxTokensRes=0x0,openaiModel4MaxTokens32k:openaiModel4MaxTokens32k=0x0,openaiModel4MaxTokens32kRes:openaiModel4MaxTokens32kRes=0x0,openaiBaseUrl:openaiBaseUrl=''}=await this[_0x1b87cb(0x1ce)][_0x1b87cb(0x10a)]([_0x1b87cb(0xe9),_0x1b87cb(0x14e),_0x1b87cb(0x1f4),_0x1b87cb(0x160),_0x1b87cb(0x1b4),_0x1b87cb(0xc8),'openaiModel4MaxTokens32k',_0x1b87cb(0x172),'openaiBaseUrl']);let _0x4de25d=null,_0x5bf7ce=null,_0x554adb=null;const {model:_0x1c8aef,maxModelTokens:maxModelTokens=0x0,maxResponseTokens:maxResponseTokens=0x0,proxyUrl:_0x10d54c,key:_0x570524}=_0x2b0549;return _0x1c8aef[_0x1b87cb(0x18c)]()[_0x1b87cb(0xc7)](_0x1b87cb(0x73))&&(_0x1c8aef[_0x1b87cb(0x18c)]()[_0x1b87cb(0xc7)]('32k')?(_0x4de25d=maxModelTokens||openaiModel4MaxTokens32k||0x8000,_0x5bf7ce=maxResponseTokens||openaiModel4MaxTokens32kRes||0x4000):(_0x4de25d=maxModelTokens||openaiModel4MaxTokens||0x2000,_0x5bf7ce=maxResponseTokens||openaiModel4MaxTokensRes||0x1000)),_0x1c8aef[_0x1b87cb(0x18c)]()[_0x1b87cb(0xc7)](_0x1b87cb(0x98))&&(_0x1c8aef[_0x1b87cb(0x18c)]()[_0x1b87cb(0xc7)](_0x1b87cb(0x123))?(_0x4de25d=maxModelTokens||openaiModel3MaxTokens16k||0x4000,_0x5bf7ce=maxResponseTokens||openaiModel3MaxTokens16kRes||0x2000):(_0x4de25d=maxModelTokens||openaiModel3MaxTokens||0x1000,_0x5bf7ce=maxResponseTokens||openaiModel3MaxTokensRes||0x3e8)),_0x554adb=_0x10d54c||openaiBaseUrl||_0x1b87cb(0x1bf),_0x5bf7ce>=_0x4de25d&&(_0x5bf7ce=Math[_0x1b87cb(0x1ed)](_0x4de25d/0x2),common_1['Logger'][_0x1b87cb(0x181)](_0x1b87cb(0x193)+_0x570524+_0x1b87cb(0x175)+_0x5bf7ce)),{'key':_0x570524,'model':_0x1c8aef,'maxToken':_0x4de25d,'maxTokenRes':_0x5bf7ce,'proxyUrl':_0x554adb};}async[_0x27aeda(0x1cd)](_0x418dbc,_0x13c972){const _0x29caa8=_0x27aeda;let _0x4f979c;if(_0x418dbc['headers'][_0x29caa8(0x163)]){const _0x3273be=_0x418dbc['headers'][_0x29caa8(0x163)]['split']('\x20'),_0x397e58=jwt['verify'](_0x3273be[0x1],process[_0x29caa8(0x110)][_0x29caa8(0xa5)]);_0x4f979c=_0x397e58['id'];}try{const {page:page=0x1,size:size=0x14,order:_0x27813c,keyword:_0xbf9145}=_0x13c972,_0x448564=await this[_0x29caa8(0x1e7)][_0x29caa8(0xab)](_0x29caa8(0x1e3)+(_0xbf9145?_0x29caa8(0x18f)+_0xbf9145+_0x29caa8(0xe1)+_0xbf9145+_0x29caa8(0x111):'')+_0x29caa8(0x112)),_0xa63bd7=await this[_0x29caa8(0x1e7)][_0x29caa8(0xab)](_0x29caa8(0x70)+(_0xbf9145?_0x29caa8(0x18f)+_0xbf9145+'%\x27\x20OR\x20c.answer\x20LIKE\x20\x27%'+_0xbf9145+_0x29caa8(0x111):'')+_0x29caa8(0x1df)+(_0x27813c?_0x27813c:_0x29caa8(0x1b0))+_0x29caa8(0x180)+size+_0x29caa8(0x131)+(page-0x1)*size+_0x29caa8(0x112)),_0x140664=_0xa63bd7[_0x29caa8(0xee)](_0xe2df1e=>_0xe2df1e['id']),_0x16a9d0=new Map();if(_0x4f979c&&_0x140664[_0x29caa8(0x6d)]){const _0x32b8eb=await this[_0x29caa8(0x1c0)]['find']({'where':{'userId':_0x4f979c,'relateId':(0x0,typeorm_1['In'])(_0x140664)}});_0x32b8eb['forEach'](_0x574c21=>{const _0x4618d0=_0x29caa8;_0x16a9d0[_0x4618d0(0x14d)](_0x574c21['relateId'],_0x574c21[_0x4618d0(0x109)]);});}const _0x268997=_0xa63bd7[_0x29caa8(0xee)](_0x1347af=>{const _0xfde48a=_0x29caa8,{prompt:_0x56113c,role:_0x51bbad,answer:_0x155908,createdAt:_0x3e69d4,model:_0xb36b05,conversationOptions:_0x49b6f8,requestOptions:_0x449a38,id:_0x2e9ed0}=_0x1347af;return{'chatId':_0x2e9ed0,'error':![],'playNum':_0x1347af['playNum'],'agreeNum':_0x1347af[_0xfde48a(0xe5)],'inversion':_0x51bbad===_0xfde48a(0x1a9),'agree':_0x16a9d0['get'](_0x2e9ed0)||null,'dateTime':(0x0,utils_1['formatDate'])(_0x3e69d4),'text':_0x51bbad===_0xfde48a(0x1a9)?_0x56113c:_0x155908,'requestOptions':_0x449a38?JSON['parse'](_0x449a38):null,'conversationOptions':_0x49b6f8?JSON['parse'](_0x49b6f8):null};});return{'records':_0x268997,'count':Number(_0x448564[0x0]?.[_0x29caa8(0x104)]||0x0)};}catch(_0x1e5b6a){throw new common_1[(_0x29caa8(0xae))](_0x1e5b6a[_0x29caa8(0x1bb)],common_1[_0x29caa8(0xa1)]['BAD_REQUEST']);}}};function _0x30a9(){const _0x1387dc=['lockKey','addWhiteUser','DrawService','purpose','map','未配置[卡池4]的有效key、请先前往后台系统配置！','当前请求已过载、请稍等会儿再试试吧！','8146506zUfYrI','badwordsService','../aiLog/aiAgreeLog.entity','subtract','getTokenCount','__param','ChatLogEntity','super','request\x20gpt\x20','./whiteList.entity','../user/user.entity','修改成功','this.api.apiKey','./helper','redis://','chatGroupService','error:\x20','/v1/models','DESC','count','DeductionKey','Bearer\x20','MODEL_LIST','1186459lzibZH','action','getConfigs','YYYY-MM-DD','Your\x20request\x20was\x20rejected\x20as\x20a\x20result\x20of\x20our\x20safety\x20system','write','../autoreply/autoreply.service','sendMessageFromZhipu','env','%\x27\x20)','\x0a\x20\x20\x20\x20\x20\x20','updateKey','baseURL','openaiProxyUrl','where','unifiedFormattingResponse','uuid','post',',\x20最大回复token:\x20','stringify','fanyi\x20mj-associate','uploadService','getTencentCOSStorage','checkUserStatus','语音转换失败','4275513RaCMbV','删除成功','16k','未获取到模型基础配置，请前往后台配置并启用','gptsService','getKeyDetail','json','defaultBaseUrl','createQueryBuilder','../badwords/badwords.service','查询key列表失败','155395qgEShx','catch','CHAT','object','Like','\x20OFFSET\x20','request','有4的权限但是卡池没有配置、降级为3的卡池','getUploadType','__metadata','id\x20=\x20:id','key不存在','getUserWhiteList','You\x20exceeded\x20your\x20current\x20quota,\x20please\x20check\x20your\x20plan\x20and\x20billing\x20details.','whisper-1','abs','BAD_REQUEST','close','removeFile','requestFromGpt','email','affected','initOpenAi','CHAT_TYPE','status','当前模型不是聊天模型','deductFromBalance','removeSpecialCharacters','then','saveChatLog','个key','slice','all','set','openaiModel3MaxTokensRes','提供了错误的模型秘钥、已冻结当前调用Key、请重新尝试对话！','selectKeyWithWeight','../globalConfig/globalConfig.service','updateWhiteUser','systemPreMessage','saveUseLog','abortController','modelInfo','./../user/user.service','execute','modelType','formatModelToken','bad\x20response\x20status\x20code\x20307','suno-v3','userEntity','size','未配置语音模型或语音模型key，请配置并启用语音功能！','openaiModel3MaxTokens16kRes','getLength','REDIS_PORT','authorization','../../common/constants/errorMessage.constant','@nestjs/typeorm','draw\x20paompt\x20info\x20<======*******======>\x20','gomaxai-chatlog','当前模型key余额已耗尽，请充值！','remove\x20file\x20','/v1','\x0a\x20Respond\x20using\x20markdown.\x20\x0a\x20Current\x20date:\x20','checkAutoReply','format','./../upload/upload.service','username','keyDetail','systemMessage','openaiModel4MaxTokens32kRes','chat','400\x20error','\x20回复数不得大于等于模型上下文数,\x20已自动调整为\x20maxTokenRes:\x20','key\x20%s,\x20proxy\x20%s','chatgpt-nine-ai','Logger','56721kfHdsM','data','setData','getModelByType','error','ChatgptService','uploadGpt','\x20DESC\x20\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20LIMIT\x20','debug','application/octet-stream','\x20key\x20->\x20','getUuid','apiKey','./store','gpt-3.5-turbo-16k-0613','preset','metadata','../../common/utils','prompt','toLowerCase','./baidu','globalTimeoutMs','AND\x20(\x20c.prompt\x20LIKE\x20\x27%','OpenAiErrorCodeMessage','update','buildMessageFromParentMessageId','key:\x20','PAYMENT_REQUIRED','getWhiteListUser','InjectRepository','GptkeysEntity','keyPool','draw','day','sendMessageFromBaidu','extname','This\x20is\x20not\x20a\x20chat\x20model\x20and\x20thus\x20not\x20supported','axios','绘制图片失败，请检查你的提示词是否有非法描述！','base64','checkBadWords','content-length','getRandomAudioKey','gomaxAiStore','当前流程所需要的模型已被管理员下架、请联系管理员上架专属模型！','remove\x20file\x20%s\x20success','2813620mpsJmA','个已被排除！','user','get','cosSecretId','speech','/v1/dashboard/billing/subscription','./spark','from','c.createdAt','setHeader','openaiTimeoutMs','api','openaiModel4MaxTokens','timeout','当前模型key余额已耗尽、已冻结当前调用Key、尝试重新对话试试吧！','NineStore','getClientIp','Connection','create','message','model','/v1/dashboard/billing/usage?start_date=',',\x20模型token:\x20','https://api.openai.com','aiAgreeLogEntity','The\x20OpenAI\x20account\x20associated\x20with\x20this\x20API\x20key\x20has\x20been\x20deactivated.','text','appEntity','未配置[卡池3]的有效key、请先前往后台系统配置！','getGptModelList','当前模型key余额已耗尽','BadwordsService','usage','../../common/constants/balance.constant','hideString','20wEGkRk','__decorate','musicSquare','globalConfigService','cosApi','本次调用:\x20','ChatLogService','UserService','aac','bulkCreateKey','Injectable','&end_date=','jsonwebtoken','statusCode','findOne','toFixed','@keyv/redis','filter','腾讯云COS连接成功','validateBalance','\x0a\x20\x20\x20\x20\x20\x20ORDER\x20BY\x0a\x20\x20\x20\x20\x20\x20\x20\x20','REDIS_USER','sendMessage','EModelType','\x0a\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20COUNT(*)\x20as\x20count\x0a\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20chatlog\x20c\x0a\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20ai_log_ext\x20ale\x20ON\x20ale.relate_id\x20=\x20c.id\x20AND\x20ale.relate_type\x20=\x20\x27suno\x27\x20\x0a\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20c.isDelete\x20=\x200\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20c.role\x20=\x20\x27assistant\x27\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20c.modelType\x20=\x20\x27music\x27\x20\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20','REDIS_PASSWORD','https://','compileNetwork','connection','Location','userBalanceService','log','OTHER','gpts','floor','typeorm','openaiaAtoDowngrade','audio','16tLYVTR','path','AppEntity','openaiModel3MaxTokens16k','DRAW','cosBucket','timeoutMs','reject','getModelProxyUrl','length','maskEmail','Incorrect\x20API\x20key\x20provided','\x0a\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20c.*,\x0a\x20\x20\x20\x20\x20\x20\x20\x20IFNULL(ale.play_num,0)\x20as\x20playNum,\x0a\x20\x20\x20\x20\x20\x20\x20\x20IFNULL(ale.agree_num,0)\x20as\x20agreeNum\x0a\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20chatlog\x20c\x0a\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20ai_log_ext\x20ale\x20ON\x20ale.relate_id\x20=\x20c.id\x20AND\x20ale.relate_type\x20=\x20\x27suno\x27\x20\x0a\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20c.isDelete\x20=\x200\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20c.role\x20=\x20\x27assistant\x27\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20c.modelType\x20=\x20\x27music\x27\x20\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20','is_end','b64_json','gpt-4','chatLogService','、重复key','修改白名单成功','cos-nodejs-sdk-v5','model4','toISOString','tencentCosAcceleratedDomain','Please\x20check\x20the\x20back-end\x20console','ModelsService','onModuleInit','saveGptsUseLog','response.length','chatLogId','createReadStream','../gpts/gpts.service','default','../chatGroup/chatGroup.service','服务异常、请重新试试吧！！！','当前模型不是聊天模型、已冻结当前调用Key、请重新尝试对话！','gptKeysEntity','openAi','autoreplyService','openai-draw','ChatGroupService','Unauthorized','append','getAllKeyList','key已存在','model3','sendMessageFromXunFei','arrayBuffer','application/octet-stream;\x20charset=utf-8','./gptKeys.entity','你当前使用的应用已被下架、请删除当前对话开启新的对话吧！','weight','response','gpt-3','function','uploaded/','../models/models.service','forEach','PAINT_TYPE','getHeaders','getRequestParams','queryUserBalance','HttpStatus','获取模型列表失败，请检查你的key是否正确！','push','key','JWT_SECRET',',\x20模型名称:\x20','DALL-E2','whiteListEntity','模型秘钥错误或模型金额不足，请联系管理员！','getRandomGptKeyDetail','query','end','modelId','HttpException','maxModelTokens','signal','YYYY年M月D日','file','split','Content-type','userId','您的请求已被系统拒绝。您的提示可能存在一些非法的文本。','绘制图片失败，此次绘画被拒绝了！','openaiBaseUrl','AutoreplyService','GlobalConfigService','getGroupInfoFromId','chat-error','find','472SpIyJM','UploadService','getCurrentModelKeyInfo','Catch\x20Error\x20','modelsService','MUSIC','resolve','当前模型key已被封禁、已冻结当前调用Key、尝试重新对话试试吧！','save','includes','openaiModel4MaxTokensRes','cosRegion','getOwnPropertyDescriptor','WhiteListEntity','config','maxResponseTokens','Repository','REDIS_HOST','conversationId','还未配置腾讯云COS存储的的SecretId和SecretKey、配置后才可进行gpt文件上传操作！！！','未配置有效key、请先前往后台系统配置！','模型秘钥错误或模型余额不足','.png','addOneIfOdd','apiBaseUrl','当前模型key已被封禁','../app/app.entity','1344645VXnJFi','assistant','importDynamic','deleteKey','uploadFile','UserBalanceService','删除失败','getRandomKey','%\x27\x20OR\x20c.answer\x20LIKE\x20\x27%','defineProperty','../chatLog/chatLog.service','gomaxai-default-key','agreeNum','userService','333333333333333','../chatLog/chatLog.entity','openaiModel3MaxTokens'];_0x30a9=function(){return _0x1387dc;};return _0x30a9();}ChatgptService=__decorate([(0x0,common_1[_0x27aeda(0x1d5)])(),__param(0x0,(0x0,typeorm_2[_0x27aeda(0x196)])(user_entity_1['UserEntity'])),__param(0x1,(0x0,typeorm_2['InjectRepository'])(gptKeys_entity_1[_0x27aeda(0x197)])),__param(0x2,(0x0,typeorm_2[_0x27aeda(0x196)])(whiteList_entity_1[_0x27aeda(0xcb)])),__param(0x3,(0x0,typeorm_2['InjectRepository'])(app_entity_1[_0x27aeda(0x1f3)])),__param(0x4,(0x0,typeorm_2[_0x27aeda(0x196)])(chatLog_entity_1[_0x27aeda(0xf7)])),__param(0x5,(0x0,typeorm_2[_0x27aeda(0x196)])(aiAgreeLog_entity_1['AiAgreeLogEntity'])),__metadata('design:paramtypes',[typeorm_1[_0x27aeda(0xce)],typeorm_1[_0x27aeda(0xce)],typeorm_1[_0x27aeda(0xce)],typeorm_1[_0x27aeda(0xce)],typeorm_1[_0x27aeda(0xce)],typeorm_1[_0x27aeda(0xce)],userBalance_service_1[_0x27aeda(0xde)],chatLog_service_1[_0x27aeda(0x1d1)],user_service_1[_0x27aeda(0x1d2)],upload_service_1[_0x27aeda(0xbf)],badwords_service_1[_0x27aeda(0x1c7)],autoreply_service_1[_0x27aeda(0xb9)],globalConfig_service_1[_0x27aeda(0xba)],chatGroup_service_1[_0x27aeda(0x8b)],models_service_1[_0x27aeda(0x7c)],gpts_service_1['GptsService'],typeorm_1[_0x27aeda(0x1b9)]])],ChatgptService),exports[_0x27aeda(0x17e)]=ChatgptService;