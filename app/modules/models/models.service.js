'use strict';const _0x50719f=_0x1006;(function(_0x3c6553,_0x4caa35){const _0x3f7dc1=_0x1006,_0x12488b=_0x3c6553();while(!![]){try{const _0x4a8625=parseInt(_0x3f7dc1(0x1b3))/0x1+parseInt(_0x3f7dc1(0x1aa))/0x2*(parseInt(_0x3f7dc1(0x1a9))/0x3)+-parseInt(_0x3f7dc1(0x1c2))/0x4*(parseInt(_0x3f7dc1(0x1c1))/0x5)+-parseInt(_0x3f7dc1(0x200))/0x6*(-parseInt(_0x3f7dc1(0x213))/0x7)+-parseInt(_0x3f7dc1(0x1fc))/0x8*(parseInt(_0x3f7dc1(0x1bf))/0x9)+parseInt(_0x3f7dc1(0x211))/0xa+-parseInt(_0x3f7dc1(0x1ca))/0xb;if(_0x4a8625===_0x4caa35)break;else _0x12488b['push'](_0x12488b['shift']());}catch(_0x383baf){_0x12488b['push'](_0x12488b['shift']());}}}(_0x99a5,0x4921b));function _0x99a5(){const _0x331152=['set','map','hideString','当前账号不存在！','keyPoolMap','getOfficialModels','length','../../common/utils','EModelType','42dSsGWL','72412zQgKUV','error','refreshBaiduAccesstoken','modelsList','floor','ModelsMapCn','defineProperty','split','key:\x20','54773SPUafb','verify','当前未指定语音对话模型KEY、前往后台设置把！','HttpStatus','keyStatus','keyInfo','暂未配置音乐模型，请联系管理员','getRandomItemFromArray','modelName','ModelsEntity','role','/v1/models','1355463nWBcRs','secret','2045xTpnzd','156xRRIvT','当前未指定特殊模型KEY、前往后台设置！','visitor','useCount\x20+\x201','modelType','delModel','delete','ModelsService','3229237whIzFP','key','BAD_REQUEST','typeorm','reduce','admin','getModelByType','Logger','id\x20=\x20:id','onModuleInit','getModelByName','缺失必要参数！','CHAT','object','headers','__esModule','https://apiv.chatgpt-3.vip','useToken\x20+\x20','env','super','InjectRepository','keyList','modelMaps','modelTypes','keyPoolIndexMap','HttpException','function','../chatgpt/baidu','saveUseLog','update','createQueryBuilder','find','@nestjs/typeorm','model','filter','keyType','Injectable','message','当前调用模型已经被移除、请重新选择模型！','metadata','val','__decorate','\x20欠费或被官方封禁导致不可用，已被系统自动锁定','push','authorization','DESC','json','design:paramtypes','modelsEntity','error:\x20','8uoCORp','sort','getAccessToken','front','3462lXmWWO','stringify','data','lockKey','Bearer\x20sk-bSm3FROxNJ1oIkmd5dDc9b582d3d48E09d12E86eF7FfC0C4','forEach','execute','then','getMusicModel','initCalcKey','getCurrentModelKeyInfo','get','random','status','JWT_SECRET','setModel','模型名称已存在，请修改模型名称','1962840iFwZCR','deepClone','21DZAgDa','displaySort','findOne','save','keys','decorate'];_0x99a5=function(){return _0x331152;};return _0x99a5();}function _0x1006(_0x581637,_0x5653e8){const _0x99a5ec=_0x99a5();return _0x1006=function(_0x1006cc,_0x144893){_0x1006cc=_0x1006cc-0x1a7;let _0x421ba3=_0x99a5ec[_0x1006cc];return _0x421ba3;},_0x1006(_0x581637,_0x5653e8);}var __decorate=this&&this[_0x50719f(0x1f3)]||function(_0x55b888,_0x11feaf,_0x26bbe7,_0x3595ad){const _0x27612f=_0x50719f;var _0x5f53eb=arguments[_0x27612f(0x21f)],_0x447270=_0x5f53eb<0x3?_0x11feaf:_0x3595ad===null?_0x3595ad=Object['getOwnPropertyDescriptor'](_0x11feaf,_0x26bbe7):_0x3595ad,_0x35e12d;if(typeof Reflect===_0x27612f(0x1d7)&&typeof Reflect[_0x27612f(0x218)]==='function')_0x447270=Reflect[_0x27612f(0x218)](_0x55b888,_0x11feaf,_0x26bbe7,_0x3595ad);else{for(var _0x478f9c=_0x55b888[_0x27612f(0x21f)]-0x1;_0x478f9c>=0x0;_0x478f9c--)if(_0x35e12d=_0x55b888[_0x478f9c])_0x447270=(_0x5f53eb<0x3?_0x35e12d(_0x447270):_0x5f53eb>0x3?_0x35e12d(_0x11feaf,_0x26bbe7,_0x447270):_0x35e12d(_0x11feaf,_0x26bbe7))||_0x447270;}return _0x5f53eb>0x3&&_0x447270&&Object[_0x27612f(0x1b0)](_0x11feaf,_0x26bbe7,_0x447270),_0x447270;},__metadata=this&&this['__metadata']||function(_0x234143,_0x5cfbc3){const _0x14eeb4=_0x50719f;if(typeof Reflect==='object'&&typeof Reflect[_0x14eeb4(0x1f1)]===_0x14eeb4(0x1e4))return Reflect[_0x14eeb4(0x1f1)](_0x234143,_0x5cfbc3);},__param=this&&this['__param']||function(_0x3daaf5,_0x51007b){return function(_0x2b0f4e,_0x13d79d){_0x51007b(_0x2b0f4e,_0x13d79d,_0x3daaf5);};};Object['defineProperty'](exports,_0x50719f(0x1d9),{'value':!![]}),exports['ModelsService']=void 0x0;const common_1=require('@nestjs/common'),typeorm_1=require(_0x50719f(0x1ea)),typeorm_2=require(_0x50719f(0x1cd)),models_entity_1=require('./models.entity'),status_constant_1=require('../../common/constants/status.constant'),baidu_1=require(_0x50719f(0x1e5)),utils_1=require(_0x50719f(0x1a7)),model_constant_1=require('../../common/constants/model.constant'),jwt=require('jsonwebtoken');let ModelsService=class ModelsService{constructor(_0xb6d272){const _0x26d7f3=_0x50719f;this[_0x26d7f3(0x1fa)]=_0xb6d272,this['modelTypes']=[],this['modelMaps']={},this['keyList']={},this[_0x26d7f3(0x21d)]={},this['keyPoolIndexMap']={};}async[_0x50719f(0x1d3)](){const _0x27dcf2=_0x50719f;await this[_0x27dcf2(0x209)](),await this[_0x27dcf2(0x1ac)]();}async[_0x50719f(0x21e)](){const _0x2491de=_0x50719f,_0x556e4e=_0x2491de(0x1da),_0x35ee34=_0x556e4e+_0x2491de(0x1be);return await fetch(_0x35ee34,{'method':_0x2491de(0x20b),'headers':{'Authorization':_0x2491de(0x204)}})[_0x2491de(0x207)](async _0x2bce8f=>{const _0x438a8a=_0x2491de,_0x44efa8=await _0x2bce8f[_0x438a8a(0x1f8)]();return _0x44efa8[_0x438a8a(0x202)];});}async[_0x50719f(0x209)](){const _0x6ed80c=_0x50719f;this[_0x6ed80c(0x21d)]={},this[_0x6ed80c(0x1e2)]={},this[_0x6ed80c(0x1df)]={},this[_0x6ed80c(0x1e0)]={},this[_0x6ed80c(0x1e1)]=[];const _0x8938da=await this[_0x6ed80c(0x1fa)][_0x6ed80c(0x1e9)]({'where':{'status':!![]}}),_0x180286=_0x8938da[_0x6ed80c(0x1ce)]((_0x3fec0d,_0x4fcbfa)=>{const _0x48ca3d=_0x6ed80c;return!_0x3fec0d[_0x4fcbfa[_0x48ca3d(0x1ed)]]?_0x3fec0d[_0x4fcbfa[_0x48ca3d(0x1ed)]]=[_0x4fcbfa]:_0x3fec0d[_0x4fcbfa[_0x48ca3d(0x1ed)]][_0x48ca3d(0x1f5)](_0x4fcbfa),_0x3fec0d;},{});this[_0x6ed80c(0x1e1)]=Object['keys'](_0x180286)[_0x6ed80c(0x21a)](_0x54bdb1=>{const _0x254371=_0x6ed80c;return{'label':status_constant_1[_0x254371(0x1af)][_0x54bdb1],'val':_0x54bdb1};}),this[_0x6ed80c(0x1e0)]=_0x180286,this[_0x6ed80c(0x1df)]={},_0x8938da['forEach'](_0xfab818=>{const _0x28249c=_0x6ed80c,{keyType:_0x86edb0,model:_0x4503ed,keyWeight:_0x1551e3}=_0xfab818;if(!this[_0x28249c(0x21d)][_0x4503ed])this[_0x28249c(0x21d)][_0x4503ed]=[];for(let _0x36acdd=0x0;_0x36acdd<_0x1551e3;_0x36acdd++){this['keyPoolMap'][_0x4503ed]['push'](_0xfab818);}if(!this[_0x28249c(0x1e2)][_0x4503ed])this['keyPoolIndexMap'][_0x4503ed]=0x0;if(!this[_0x28249c(0x1df)][_0x86edb0])this[_0x28249c(0x1df)][_0x86edb0]={};if(!this[_0x28249c(0x1df)][_0x86edb0][_0x4503ed])this[_0x28249c(0x1df)][_0x86edb0][_0x4503ed]=[];this[_0x28249c(0x1df)][_0x86edb0][_0x4503ed][_0x28249c(0x1f5)](_0xfab818);});}async[_0x50719f(0x203)](_0x651993,_0x1bdfae,_0x3b915f=-0x1){const _0x1ae2be=_0x50719f,_0x30f39a=await this[_0x1ae2be(0x1fa)][_0x1ae2be(0x1e7)]({'id':_0x651993},{'status':![],'keyStatus':_0x3b915f,'remark':_0x1bdfae});common_1[_0x1ae2be(0x1d1)][_0x1ae2be(0x1ab)](_0x1ae2be(0x1b2)+_0x651993+_0x1ae2be(0x1f4)),await this[_0x1ae2be(0x209)]();}async[_0x50719f(0x1d4)](_0x555ac4){const _0x53e619=_0x50719f;return this[_0x53e619(0x1fa)][_0x53e619(0x215)]({'where':{'modelName':_0x555ac4}});}async[_0x50719f(0x20a)](_0x445c00){const _0x2c80b6=_0x50719f;if(!this[_0x2c80b6(0x21d)][_0x445c00])throw new common_1[(_0x2c80b6(0x1e3))](_0x2c80b6(0x1f0),common_1['HttpStatus'][_0x2c80b6(0x1cc)]);this[_0x2c80b6(0x1e2)][_0x445c00]++;const _0x501a81=this['keyPoolIndexMap'][_0x445c00];if(_0x501a81>=this['keyPoolMap'][_0x445c00][_0x2c80b6(0x21f)])this['keyPoolIndexMap'][_0x445c00]=0x0;return this[_0x2c80b6(0x21d)][_0x445c00][this[_0x2c80b6(0x1e2)][_0x445c00]];}async[_0x50719f(0x1d0)](_0x14d70c,_0x4327ec){const _0x4745f3=_0x50719f,_0x54e1b5={'modelType':_0x14d70c,'status':!![],'keyStatus':0x1};_0x4327ec&&(_0x54e1b5[_0x4745f3(0x1eb)]=_0x4327ec);const _0x1e18b0=await this['modelsEntity']['find']({'where':_0x54e1b5,'order':{'keyWeight':_0x4745f3(0x1f7)}});if(!_0x1e18b0[_0x4745f3(0x21f)])throw new Error('暂未配置相关模型，请联系管理员！');const _0x16ad0f=_0x1e18b0[0x0],_0x29be75=this[_0x4745f3(0x1e1)][_0x4745f3(0x1e9)](_0x3f4089=>Number(_0x3f4089[_0x4745f3(0x1f2)])===_0x16ad0f[_0x4745f3(0x1ed)]);return{'modelTypeInfo':_0x29be75,'modelInfo':{..._0x16ad0f,'topN':0.8,'systemMessage':'','rounds':0x8}};}async[_0x50719f(0x20f)](_0x599371){const _0x403665=_0x50719f;try{const {id:_0x4d7f7c}=_0x599371;_0x599371[_0x403665(0x20d)]&&(_0x599371[_0x403665(0x1b7)]=0x1);if(_0x4d7f7c){const _0x300ce6=await this[_0x403665(0x1fa)][_0x403665(0x1e7)]({'id':_0x4d7f7c},_0x599371);return await this[_0x403665(0x209)](),_0x300ce6['affected']>0x0;}else{const _0xc5f618=await this[_0x403665(0x1fa)][_0x403665(0x215)]({'where':{'modelName':_0x599371[_0x403665(0x1bb)]}});if(_0xc5f618)throw new Error(_0x403665(0x210));const {keyType:_0x180691,key:_0x1f8187}=_0x599371;if(Number(_0x180691!==0x1)){const _0x31e775=await this[_0x403665(0x1fa)]['save'](_0x599371);return await this[_0x403665(0x209)](),_0x180691===0x2&&this[_0x403665(0x1ac)](),_0x31e775;}else{const _0x561090=_0x1f8187['map'](_0x29b6d1=>{const _0x33a0f9=_0x403665,_0x5c1c6e=JSON['parse'](JSON[_0x33a0f9(0x201)](_0x599371));return _0x5c1c6e[_0x33a0f9(0x1cb)]=_0x29b6d1,_0x5c1c6e;}),_0x1f9a6a=await this[_0x403665(0x1fa)][_0x403665(0x216)](_0x561090);return await this[_0x403665(0x209)](),_0x1f9a6a;}}}catch(_0x3d5e9c){console['log'](_0x403665(0x1fb),_0x3d5e9c);throw new common_1['HttpException'](_0x3d5e9c['message'],common_1[_0x403665(0x1b6)]['BAD_REQUEST']);}}async[_0x50719f(0x1c7)]({id:_0x4681b9}){const _0x4f286c=_0x50719f;if(!_0x4681b9)throw new common_1['HttpException'](_0x4f286c(0x1d5),common_1[_0x4f286c(0x1b6)][_0x4f286c(0x1cc)]);const _0x50453d=await this['modelsEntity'][_0x4f286c(0x215)]({'where':{'id':_0x4681b9}});if(!_0x50453d)throw new common_1[(_0x4f286c(0x1e3))](_0x4f286c(0x21c),common_1['HttpStatus']['BAD_REQUEST']);const _0x2c6467=await this[_0x4f286c(0x1fa)][_0x4f286c(0x1c8)]({'id':_0x4681b9});return await this[_0x4f286c(0x209)](),_0x2c6467;}async['queryModels'](_0x4ec43a,_0x553f0b){const _0x3a14fd=_0x50719f;let _0x32c3c9=_0x3a14fd(0x1c4);if(_0x4ec43a[_0x3a14fd(0x1d8)][_0x3a14fd(0x1f6)]){const _0x4deb2e=_0x4ec43a[_0x3a14fd(0x1d8)]['authorization'][_0x3a14fd(0x1b1)]('\x20'),_0x22db94=jwt[_0x3a14fd(0x1b4)](_0x4deb2e[0x1],process[_0x3a14fd(0x1dc)][_0x3a14fd(0x20e)]);_0x32c3c9=_0x22db94[_0x3a14fd(0x1bd)];}const {keyType:_0x232699,key:_0x574b04,status:_0x38311c,model:_0x2eacbd,modelType:_0x26bc89,page:page=0x1,size:size=0xa}=_0x553f0b;let _0x1f0cfc={};_0x2eacbd&&(_0x1f0cfc[_0x3a14fd(0x1eb)]=_0x2eacbd),_0x232699&&(_0x1f0cfc['keyType']=_0x232699),_0x574b04&&(_0x1f0cfc['key']=(0x0,typeorm_2['Like'])('%'+_0x574b04+'%')),_0x26bc89&&(_0x1f0cfc[_0x3a14fd(0x1c6)]=_0x26bc89),_0x38311c&&(_0x1f0cfc[_0x3a14fd(0x20d)]=Number(_0x38311c)===0x1?!![]:![]);_0x32c3c9!==_0x3a14fd(0x1cf)&&_0x32c3c9!==_0x3a14fd(0x1dd)&&(_0x1f0cfc['front']=!![],_0x1f0cfc[_0x3a14fd(0x20d)]=!![],_0x1f0cfc['modelType']=model_constant_1['EModelType'][_0x3a14fd(0x1d6)]);const [_0x26456e,_0x2ebaa0]=await this['modelsEntity']['findAndCount']({'where':_0x1f0cfc,'skip':(page-0x1)*size,'take':size,'order':{'displaySort':'DESC','createdAt':'DESC'}});return _0x32c3c9!==_0x3a14fd(0x1dd)&&_0x26456e[_0x3a14fd(0x205)](_0x3f4a1d=>{const _0x641b86=_0x3a14fd;_0x3f4a1d[_0x641b86(0x1cb)]&&(_0x3f4a1d[_0x641b86(0x1cb)]=(0x0,utils_1[_0x641b86(0x21b)])(_0x3f4a1d[_0x641b86(0x1cb)])),_0x3f4a1d['secret']&&(_0x3f4a1d[_0x641b86(0x1c0)]=(0x0,utils_1[_0x641b86(0x21b)])(_0x3f4a1d[_0x641b86(0x1c0)]));}),{'rows':_0x26456e,'count':_0x2ebaa0};}async[_0x50719f(0x1ad)](_0x259abe=0x0){const _0x3053e3=_0x50719f,_0x2b795e=(0x0,utils_1[_0x3053e3(0x212)])(this[_0x3053e3(0x1e0)]);return Object[_0x3053e3(0x217)](_0x2b795e)[_0x3053e3(0x205)](_0x2a235e=>{const _0xce0ad4=_0x3053e3;let _0x2d78be=_0x2b795e[_0x2a235e];if(_0x259abe===0x0)_0x2d78be=_0x2d78be[_0xce0ad4(0x1ec)](_0x4c628c=>Boolean(_0x4c628c[_0xce0ad4(0x1ff)]))['sort']((_0x2a6a18,_0x29ba43)=>_0x29ba43[_0xce0ad4(0x214)]-_0x2a6a18[_0xce0ad4(0x214)]);else _0x259abe===0x2&&(_0x2d78be=_0x2d78be[_0xce0ad4(0x1ec)](_0x37b790=>!Boolean(_0x37b790[_0xce0ad4(0x1ff)]))[_0xce0ad4(0x1fd)]((_0x559ad7,_0x500c43)=>_0x500c43[_0xce0ad4(0x214)]-_0x559ad7[_0xce0ad4(0x214)]));_0x2b795e[_0x2a235e]=_0x2d78be[_0xce0ad4(0x21a)](_0x57412e=>Object['assign']({},_0x57412e));}),{'modelTypeList':this[_0x3053e3(0x1e1)],'modelMaps':_0x2b795e};}async[_0x50719f(0x1e6)](_0x45a102,_0x53a415){const _0x221888=_0x50719f;await this[_0x221888(0x1fa)][_0x221888(0x1e8)]()[_0x221888(0x1e7)](models_entity_1[_0x221888(0x1bc)])[_0x221888(0x219)]({'useCount':()=>_0x221888(0x1c5),'useToken':()=>_0x221888(0x1db)+_0x53a415})['where'](_0x221888(0x1d2),{'id':_0x45a102})[_0x221888(0x206)]();}async[_0x50719f(0x1ac)](){const _0xab9805=_0x50719f,_0x2389f2=await this['modelsEntity']['find']({'where':{'keyType':0x2}}),_0x1e6a17={};_0x2389f2[_0xab9805(0x205)](_0xbc1e7f=>{const _0x54af5f=_0xab9805,{key:_0x4a290f,secret:_0xea2831}=_0xbc1e7f;!_0x1e6a17[_0x54af5f(0x1cb)]?_0x1e6a17[_0x4a290f]=[{'keyInfo':_0xbc1e7f}]:_0x1e6a17[_0x4a290f][_0x54af5f(0x1f5)](_0xbc1e7f);}),Object[_0xab9805(0x217)](_0x1e6a17)['forEach'](async _0xbd2504=>{const _0xa2626=_0xab9805,{secret:_0x58e3c7,id:_0x455714}=_0x1e6a17[_0xbd2504][0x0][_0xa2626(0x1b8)],_0xf3df71=await(0x0,baidu_1[_0xa2626(0x1fe)])(_0xbd2504,_0x58e3c7);await this[_0xa2626(0x1fa)][_0xa2626(0x1e7)]({'key':_0xbd2504},{'accessToken':_0xf3df71});}),setTimeout(()=>{const _0x495192=_0xab9805;this[_0x495192(0x209)]();},0x3e8);}async['getRandomKey'](_0x2956fc){const _0x5e45c0=_0x50719f,_0x4fb1aa=await this[_0x5e45c0(0x1fa)][_0x5e45c0(0x1e9)]({'where':{'status':!![],'keyStatus':0x1,'modelType':_0x2956fc}});if(!_0x4fb1aa[_0x5e45c0(0x21f)])throw new common_1[(_0x5e45c0(0x1e3))](_0x5e45c0(0x1c3),common_1[_0x5e45c0(0x1b6)][_0x5e45c0(0x1cc)]);return(0x0,utils_1[_0x5e45c0(0x1ba)])(_0x4fb1aa);}async['getRandomAudioKey'](){const _0x4d9955=_0x50719f,_0x2f6d0d=await this[_0x4d9955(0x1fa)][_0x4d9955(0x1e9)]({'where':{'status':!![],'canAudio':!![]}});if(!_0x2f6d0d[_0x4d9955(0x21f)])throw new common_1[(_0x4d9955(0x1e3))](_0x4d9955(0x1b5),common_1['HttpStatus'][_0x4d9955(0x1cc)]);return(0x0,utils_1[_0x4d9955(0x1ba)])(_0x2f6d0d);}async['getAllKey'](){const _0x1388fd=_0x50719f;return await this['modelsEntity'][_0x1388fd(0x1e9)]();}async[_0x50719f(0x208)](){const _0x19f9f0=_0x50719f;try{const _0x5b2f88=await this[_0x19f9f0(0x1fa)][_0x19f9f0(0x1e9)]({'where':{'status':!![],'keyStatus':0x1,'modelType':model_constant_1[_0x19f9f0(0x1a8)]['MUSIC']}});if(_0x5b2f88[_0x19f9f0(0x21f)]===0x0)throw new Error(_0x19f9f0(0x1b9));return _0x5b2f88[Math[_0x19f9f0(0x1ae)](Math[_0x19f9f0(0x20c)]()*_0x5b2f88[_0x19f9f0(0x21f)])];}catch(_0x4b1571){throw new common_1['HttpException'](_0x4b1571[_0x19f9f0(0x1ef)],common_1[_0x19f9f0(0x1b6)][_0x19f9f0(0x1cc)]);}}};ModelsService=__decorate([(0x0,common_1[_0x50719f(0x1ee)])(),__param(0x0,(0x0,typeorm_1[_0x50719f(0x1de)])(models_entity_1['ModelsEntity'])),__metadata(_0x50719f(0x1f9),[typeorm_2['Repository']])],ModelsService),exports[_0x50719f(0x1c9)]=ModelsService;