'use strict';const _0x26607c=_0x3117;(function(_0x4b6df9,_0x14d2e8){const _0x5a0833=_0x3117,_0x5ae07c=_0x4b6df9();while(!![]){try{const _0x4ed75b=parseInt(_0x5a0833(0xc5))/0x1+parseInt(_0x5a0833(0x94))/0x2+-parseInt(_0x5a0833(0xa1))/0x3*(-parseInt(_0x5a0833(0x93))/0x4)+parseInt(_0x5a0833(0x76))/0x5*(parseInt(_0x5a0833(0x8b))/0x6)+parseInt(_0x5a0833(0xc7))/0x7*(-parseInt(_0x5a0833(0xc6))/0x8)+-parseInt(_0x5a0833(0xd7))/0x9*(parseInt(_0x5a0833(0x9a))/0xa)+parseInt(_0x5a0833(0xa3))/0xb*(-parseInt(_0x5a0833(0x97))/0xc);if(_0x4ed75b===_0x14d2e8)break;else _0x5ae07c['push'](_0x5ae07c['shift']());}catch(_0x2f8ffa){_0x5ae07c['push'](_0x5ae07c['shift']());}}}(_0x545d,0xbbd93));var __decorate=this&&this[_0x26607c(0x8f)]||function(_0x461170,_0x56172e,_0x2e53ad,_0x239f06){const _0x60272a=_0x26607c;var _0x1df9a8=arguments[_0x60272a(0x7d)],_0x160364=_0x1df9a8<0x3?_0x56172e:_0x239f06===null?_0x239f06=Object[_0x60272a(0xce)](_0x56172e,_0x2e53ad):_0x239f06,_0x2f4638;if(typeof Reflect===_0x60272a(0x84)&&typeof Reflect[_0x60272a(0x85)]===_0x60272a(0xca))_0x160364=Reflect[_0x60272a(0x85)](_0x461170,_0x56172e,_0x2e53ad,_0x239f06);else{for(var _0x3d1c66=_0x461170[_0x60272a(0x7d)]-0x1;_0x3d1c66>=0x0;_0x3d1c66--)if(_0x2f4638=_0x461170[_0x3d1c66])_0x160364=(_0x1df9a8<0x3?_0x2f4638(_0x160364):_0x1df9a8>0x3?_0x2f4638(_0x56172e,_0x2e53ad,_0x160364):_0x2f4638(_0x56172e,_0x2e53ad))||_0x160364;}return _0x1df9a8>0x3&&_0x160364&&Object[_0x60272a(0x82)](_0x56172e,_0x2e53ad,_0x160364),_0x160364;},__metadata=this&&this[_0x26607c(0xe7)]||function(_0x36eb53,_0x210701){const _0x19683f=_0x26607c;if(typeof Reflect==='object'&&typeof Reflect['metadata']===_0x19683f(0xca))return Reflect[_0x19683f(0x7b)](_0x36eb53,_0x210701);},__param=this&&this[_0x26607c(0x78)]||function(_0x24f97c,_0x31e6f0){return function(_0xc2ed0b,_0x41fca8){_0x31e6f0(_0xc2ed0b,_0x41fca8,_0x24f97c);};};function _0x3117(_0x12228c,_0x5dcdfe){const _0x545db1=_0x545d();return _0x3117=function(_0x31171e,_0x178c27){_0x31171e=_0x31171e-0x76;let _0x5e6047=_0x545db1[_0x31171e];return _0x5e6047;},_0x3117(_0x12228c,_0x5dcdfe);}Object[_0x26607c(0x82)](exports,'__esModule',{'value':!![]}),exports[_0x26607c(0xbc)]=void 0x0;const common_1=require('@nestjs/common'),typeorm_1=require(_0x26607c(0xba)),typeorm_2=require(_0x26607c(0xae)),models_entity_1=require('./models.entity'),status_constant_1=require('../../common/constants/status.constant'),baidu_1=require(_0x26607c(0x96)),utils_1=require(_0x26607c(0x79)),model_constant_1=require('../../common/constants/model.constant'),jwt=require(_0x26607c(0xda));function _0x545d(){const _0xc31eca=['modelName','function','HttpException','缺失必要参数！','val','getOwnPropertyDescriptor','map','getAccessToken','verify','then','saveUseLog','keyPoolIndexMap','当前调用模型已经被移除、请重新选择模型！','modelMaps','755955DFFZtA','当前未指定语音对话模型KEY、前往后台设置把！','https://apiv.chatgpt-3.vip','jsonwebtoken','status','ModelsEntity','findAndCount','Bearer\x20sk-bSm3FROxNJ1oIkmd5dDc9b582d3d48E09d12E86eF7FfC0C4','EModelType','floor','json','headers','\x20欠费或被官方封禁导致不可用，已被系统自动锁定','modelsList','delete','error','__metadata','BAD_REQUEST','10135wvHcOO','getRandomItemFromArray','__param','../../common/utils','push','metadata','onModuleInit','length','hideString','setModel','useCount\x20+\x201','getRandomKey','defineProperty','HttpStatus','object','decorate','findOne','CHAT','模型名称已存在，请修改模型名称','front','save','2544rAldvH','displaySort','error:\x20','keys','__decorate','super','keyList','queryModels','12xAzACU','353464pMSQcR','stringify','../chatgpt/baidu','120tdJxLp','split','keyInfo','10Arcgjc','assign','update','modelsEntity','id\x20=\x20:id','env','keyPoolMap','307647zwqKzG','getOfficialModels','147565GhBsaJ','sort','modelType','lockKey','ModelsMapCn','DESC','keyType','/v1/models','forEach','getMusicModel','design:paramtypes','typeorm','model','key:\x20','getAllKey','authorization','visitor','Logger','refreshBaiduAccesstoken','key','admin','message','Like','@nestjs/typeorm','find','ModelsService','filter','modelTypes','暂未配置相关模型，请联系管理员！','where','secret','当前未指定特殊模型KEY、前往后台设置！','initCalcKey','getModelByName','528290ZbZVWF','372440akSkjx','133HWbjsw','parse'];_0x545d=function(){return _0xc31eca;};return _0x545d();}let ModelsService=class ModelsService{constructor(_0x55b414){const _0x4d0e1a=_0x26607c;this['modelsEntity']=_0x55b414,this[_0x4d0e1a(0xbe)]=[],this[_0x4d0e1a(0xd6)]={},this['keyList']={},this[_0x4d0e1a(0xa0)]={},this['keyPoolIndexMap']={};}async[_0x26607c(0x7c)](){const _0xb697ef=_0x26607c;await this[_0xb697ef(0xc3)](),await this['refreshBaiduAccesstoken']();}async[_0x26607c(0xa2)](){const _0x2b47f5=_0x26607c,_0x3c80eb=_0x2b47f5(0xd9),_0x312b5c=_0x3c80eb+_0x2b47f5(0xaa);return await fetch(_0x312b5c,{'method':'get','headers':{'Authorization':_0x2b47f5(0xde)}})[_0x2b47f5(0xd2)](async _0x444194=>{const _0x18c4aa=_0x2b47f5,_0x4d359b=await _0x444194[_0x18c4aa(0xe1)]();return _0x4d359b['data'];});}async[_0x26607c(0xc3)](){const _0x29d8f2=_0x26607c;this[_0x29d8f2(0xa0)]={},this[_0x29d8f2(0xd4)]={},this[_0x29d8f2(0x91)]={},this[_0x29d8f2(0xd6)]={},this[_0x29d8f2(0xbe)]=[];const _0x1c86ce=await this[_0x29d8f2(0x9d)]['find']({'where':{'status':!![]}}),_0x5d5703=_0x1c86ce['reduce']((_0x2e5ad0,_0x5e55ec)=>{const _0x163d51=_0x29d8f2;return!_0x2e5ad0[_0x5e55ec['keyType']]?_0x2e5ad0[_0x5e55ec[_0x163d51(0xa9)]]=[_0x5e55ec]:_0x2e5ad0[_0x5e55ec[_0x163d51(0xa9)]][_0x163d51(0x7a)](_0x5e55ec),_0x2e5ad0;},{});this[_0x29d8f2(0xbe)]=Object[_0x29d8f2(0x8e)](_0x5d5703)[_0x29d8f2(0xcf)](_0x31002b=>{const _0x2f3191=_0x29d8f2;return{'label':status_constant_1[_0x2f3191(0xa7)][_0x31002b],'val':_0x31002b};}),this[_0x29d8f2(0xd6)]=_0x5d5703,this[_0x29d8f2(0x91)]={},_0x1c86ce[_0x29d8f2(0xab)](_0x4b82e8=>{const _0x2f3a24=_0x29d8f2,{keyType:_0x25c51f,model:_0x2a7ac3,keyWeight:_0x5b8f31}=_0x4b82e8;if(!this[_0x2f3a24(0xa0)][_0x2a7ac3])this[_0x2f3a24(0xa0)][_0x2a7ac3]=[];for(let _0x346d16=0x0;_0x346d16<_0x5b8f31;_0x346d16++){this['keyPoolMap'][_0x2a7ac3]['push'](_0x4b82e8);}if(!this['keyPoolIndexMap'][_0x2a7ac3])this['keyPoolIndexMap'][_0x2a7ac3]=0x0;if(!this['keyList'][_0x25c51f])this[_0x2f3a24(0x91)][_0x25c51f]={};if(!this[_0x2f3a24(0x91)][_0x25c51f][_0x2a7ac3])this[_0x2f3a24(0x91)][_0x25c51f][_0x2a7ac3]=[];this[_0x2f3a24(0x91)][_0x25c51f][_0x2a7ac3]['push'](_0x4b82e8);});}async[_0x26607c(0xa6)](_0x583f54,_0x39c260,_0x5807ba=-0x1){const _0xc5e82e=_0x26607c,_0x47018e=await this[_0xc5e82e(0x9d)]['update']({'id':_0x583f54},{'status':![],'keyStatus':_0x5807ba,'remark':_0x39c260});common_1[_0xc5e82e(0xb4)][_0xc5e82e(0xe6)](_0xc5e82e(0xb0)+_0x583f54+_0xc5e82e(0xe3)),await this[_0xc5e82e(0xc3)]();}async[_0x26607c(0xc4)](_0x1a300a){const _0xb13d29=_0x26607c;return this[_0xb13d29(0x9d)][_0xb13d29(0x86)]({'where':{'modelName':_0x1a300a}});}async['getCurrentModelKeyInfo'](_0x59f2c5){const _0x31426b=_0x26607c;if(!this['keyPoolMap'][_0x59f2c5])throw new common_1[(_0x31426b(0xcb))](_0x31426b(0xd5),common_1[_0x31426b(0x83)][_0x31426b(0xe8)]);this[_0x31426b(0xd4)][_0x59f2c5]++;const _0x527c64=this['keyPoolIndexMap'][_0x59f2c5];if(_0x527c64>=this[_0x31426b(0xa0)][_0x59f2c5][_0x31426b(0x7d)])this['keyPoolIndexMap'][_0x59f2c5]=0x0;return this[_0x31426b(0xa0)][_0x59f2c5][this['keyPoolIndexMap'][_0x59f2c5]];}async['getModelByType'](_0x2b32e7,_0x15de7d){const _0x28c0de=_0x26607c,_0x13cfc4={'modelType':_0x2b32e7,'status':!![],'keyStatus':0x1};_0x15de7d&&(_0x13cfc4[_0x28c0de(0xaf)]=_0x15de7d);const _0x46a099=await this[_0x28c0de(0x9d)][_0x28c0de(0xbb)]({'where':_0x13cfc4,'order':{'displaySort':_0x28c0de(0xa8)}});if(!_0x46a099['length'])throw new Error(_0x28c0de(0xbf));const _0x308452=_0x46a099[0x0],_0x12db2a=this['modelTypes']['find'](_0x14c685=>Number(_0x14c685[_0x28c0de(0xcd)])===_0x308452[_0x28c0de(0xa9)]);return{'modelTypeInfo':_0x12db2a,'modelInfo':{..._0x308452,'topN':0.8,'systemMessage':'','rounds':0x8}};}async[_0x26607c(0x7f)](_0x25d787){const _0x341867=_0x26607c;try{const {id:_0x41365c}=_0x25d787;_0x25d787[_0x341867(0xdb)]&&(_0x25d787['keyStatus']=0x1);if(_0x41365c){const _0x503739=await this['modelsEntity'][_0x341867(0x9c)]({'id':_0x41365c},_0x25d787);return await this['initCalcKey'](),_0x503739['affected']>0x0;}else{const _0x3c393f=await this[_0x341867(0x9d)][_0x341867(0x86)]({'where':{'modelName':_0x25d787[_0x341867(0xc9)]}});if(_0x3c393f)throw new Error(_0x341867(0x88));const {keyType:_0xb98a98,key:_0x89b6dd}=_0x25d787;if(Number(_0xb98a98!==0x1)){const _0x2b6779=await this['modelsEntity'][_0x341867(0x8a)](_0x25d787);return await this[_0x341867(0xc3)](),_0xb98a98===0x2&&this[_0x341867(0xb5)](),_0x2b6779;}else{const _0x495c45=_0x89b6dd[_0x341867(0xcf)](_0x2ff110=>{const _0x4dcab3=_0x341867,_0x4dc59f=JSON[_0x4dcab3(0xc8)](JSON[_0x4dcab3(0x95)](_0x25d787));return _0x4dc59f[_0x4dcab3(0xb6)]=_0x2ff110,_0x4dc59f;}),_0x3b4e6f=await this['modelsEntity'][_0x341867(0x8a)](_0x495c45);return await this[_0x341867(0xc3)](),_0x3b4e6f;}}}catch(_0x5a5766){console['log'](_0x341867(0x8d),_0x5a5766);throw new common_1[(_0x341867(0xcb))](_0x5a5766['message'],common_1[_0x341867(0x83)][_0x341867(0xe8)]);}}async['delModel']({id:_0x49e8c5}){const _0x4f89a9=_0x26607c;if(!_0x49e8c5)throw new common_1['HttpException'](_0x4f89a9(0xcc),common_1['HttpStatus']['BAD_REQUEST']);const _0xcf301b=await this['modelsEntity']['findOne']({'where':{'id':_0x49e8c5}});if(!_0xcf301b)throw new common_1[(_0x4f89a9(0xcb))]('当前账号不存在！',common_1[_0x4f89a9(0x83)][_0x4f89a9(0xe8)]);const _0x21a2e9=await this[_0x4f89a9(0x9d)][_0x4f89a9(0xe5)]({'id':_0x49e8c5});return await this['initCalcKey'](),_0x21a2e9;}async[_0x26607c(0x92)](_0x40365e,_0xef91e4){const _0x371991=_0x26607c;let _0x449a06=_0x371991(0xb3);if(_0x40365e[_0x371991(0xe2)][_0x371991(0xb2)]){const _0x275427=_0x40365e[_0x371991(0xe2)][_0x371991(0xb2)][_0x371991(0x98)]('\x20'),_0xb27056=jwt[_0x371991(0xd1)](_0x275427[0x1],process[_0x371991(0x9f)]['JWT_SECRET']);_0x449a06=_0xb27056['role'];}const {keyType:_0x4df40f,key:_0x5f4fe7,status:_0xd8b0ad,model:_0x2ecb36,modelType:_0x6c4970,page:page=0x1,size:size=0xa}=_0xef91e4;let _0x11f046={};_0x2ecb36&&(_0x11f046[_0x371991(0xaf)]=_0x2ecb36),_0x4df40f&&(_0x11f046[_0x371991(0xa9)]=_0x4df40f),_0x5f4fe7&&(_0x11f046[_0x371991(0xb6)]=(0x0,typeorm_2[_0x371991(0xb9)])('%'+_0x5f4fe7+'%')),_0x6c4970&&(_0x11f046['modelType']=_0x6c4970),_0xd8b0ad&&(_0x11f046[_0x371991(0xdb)]=Number(_0xd8b0ad)===0x1?!![]:![]);_0x449a06!==_0x371991(0xb7)&&_0x449a06!==_0x371991(0x90)&&(_0x11f046[_0x371991(0x89)]=!![],_0x11f046[_0x371991(0xdb)]=!![],_0x11f046[_0x371991(0xa5)]=model_constant_1[_0x371991(0xdf)][_0x371991(0x87)]);const [_0x2cdade,_0x3fa1ac]=await this[_0x371991(0x9d)][_0x371991(0xdd)]({'where':_0x11f046,'skip':(page-0x1)*size,'take':size,'order':{'displaySort':'DESC','createdAt':_0x371991(0xa8)}});return _0x449a06!=='super'&&_0x2cdade[_0x371991(0xab)](_0x5713ca=>{const _0x3fcdc6=_0x371991;_0x5713ca[_0x3fcdc6(0xb6)]&&(_0x5713ca[_0x3fcdc6(0xb6)]=(0x0,utils_1[_0x3fcdc6(0x7e)])(_0x5713ca[_0x3fcdc6(0xb6)])),_0x5713ca[_0x3fcdc6(0xc1)]&&(_0x5713ca['secret']=(0x0,utils_1[_0x3fcdc6(0x7e)])(_0x5713ca[_0x3fcdc6(0xc1)]));}),{'rows':_0x2cdade,'count':_0x3fa1ac};}async[_0x26607c(0xe4)](_0x4342e3=0x0){const _0x55895f=_0x26607c,_0x4d30f2=(0x0,utils_1['deepClone'])(this[_0x55895f(0xd6)]);return Object[_0x55895f(0x8e)](_0x4d30f2)[_0x55895f(0xab)](_0x4e9f85=>{const _0x4f060b=_0x55895f;let _0x1f3d81=_0x4d30f2[_0x4e9f85];if(_0x4342e3===0x0)_0x1f3d81=_0x1f3d81[_0x4f060b(0xbd)](_0x2dd43c=>Boolean(_0x2dd43c[_0x4f060b(0x89)]))[_0x4f060b(0xa4)]((_0x52f5cb,_0x2e2f7b)=>_0x2e2f7b[_0x4f060b(0x8c)]-_0x52f5cb[_0x4f060b(0x8c)]);else _0x4342e3===0x2&&(_0x1f3d81=_0x1f3d81['filter'](_0x4b1712=>!Boolean(_0x4b1712[_0x4f060b(0x89)]))[_0x4f060b(0xa4)]((_0xfcaf51,_0x201b0c)=>_0x201b0c[_0x4f060b(0x8c)]-_0xfcaf51[_0x4f060b(0x8c)]));_0x4d30f2[_0x4e9f85]=_0x1f3d81[_0x4f060b(0xcf)](_0x5cfe34=>Object[_0x4f060b(0x9b)]({},_0x5cfe34));}),{'modelTypeList':this['modelTypes'],'modelMaps':_0x4d30f2};}async[_0x26607c(0xd3)](_0x347a11,_0x2e80f1){const _0x5d10b3=_0x26607c;await this[_0x5d10b3(0x9d)]['createQueryBuilder']()[_0x5d10b3(0x9c)](models_entity_1['ModelsEntity'])['set']({'useCount':()=>_0x5d10b3(0x80),'useToken':()=>'useToken\x20+\x20'+_0x2e80f1})[_0x5d10b3(0xc0)](_0x5d10b3(0x9e),{'id':_0x347a11})['execute']();}async['refreshBaiduAccesstoken'](){const _0x400776=_0x26607c,_0xdb283e=await this['modelsEntity'][_0x400776(0xbb)]({'where':{'keyType':0x2}}),_0x7875f0={};_0xdb283e['forEach'](_0x277a65=>{const _0x504c35=_0x400776,{key:_0xc31479,secret:_0x569243}=_0x277a65;!_0x7875f0[_0x504c35(0xb6)]?_0x7875f0[_0xc31479]=[{'keyInfo':_0x277a65}]:_0x7875f0[_0xc31479]['push'](_0x277a65);}),Object[_0x400776(0x8e)](_0x7875f0)[_0x400776(0xab)](async _0x201741=>{const _0x24d132=_0x400776,{secret:_0x2636f1,id:_0x1aae3e}=_0x7875f0[_0x201741][0x0][_0x24d132(0x99)],_0x8e070f=await(0x0,baidu_1[_0x24d132(0xd0)])(_0x201741,_0x2636f1);await this[_0x24d132(0x9d)]['update']({'key':_0x201741},{'accessToken':_0x8e070f});}),setTimeout(()=>{const _0x4dcbdf=_0x400776;this[_0x4dcbdf(0xc3)]();},0x3e8);}async[_0x26607c(0x81)](_0x5520da){const _0x2aab88=_0x26607c,_0x4f001c=await this[_0x2aab88(0x9d)][_0x2aab88(0xbb)]({'where':{'status':!![],'keyStatus':0x1,'modelType':_0x5520da}});if(!_0x4f001c[_0x2aab88(0x7d)])throw new common_1[(_0x2aab88(0xcb))](_0x2aab88(0xc2),common_1[_0x2aab88(0x83)][_0x2aab88(0xe8)]);return(0x0,utils_1[_0x2aab88(0x77)])(_0x4f001c);}async['getRandomAudioKey'](){const _0x108cd6=_0x26607c,_0x24b4eb=await this['modelsEntity']['find']({'where':{'status':!![],'canAudio':!![]}});if(!_0x24b4eb[_0x108cd6(0x7d)])throw new common_1[(_0x108cd6(0xcb))](_0x108cd6(0xd8),common_1[_0x108cd6(0x83)]['BAD_REQUEST']);return(0x0,utils_1[_0x108cd6(0x77)])(_0x24b4eb);}async[_0x26607c(0xb1)](){const _0x2b79a5=_0x26607c;return await this['modelsEntity'][_0x2b79a5(0xbb)]();}async[_0x26607c(0xac)](){const _0x16e096=_0x26607c;try{const _0x43c797=await this[_0x16e096(0x9d)]['find']({'where':{'status':!![],'keyStatus':0x1,'modelType':model_constant_1[_0x16e096(0xdf)]['MUSIC']}});if(_0x43c797[_0x16e096(0x7d)]===0x0)throw new Error('暂未配置音乐模型，请联系管理员');return _0x43c797[Math[_0x16e096(0xe0)](Math['random']()*_0x43c797['length'])];}catch(_0xccddfe){throw new common_1['HttpException'](_0xccddfe[_0x16e096(0xb8)],common_1['HttpStatus']['BAD_REQUEST']);}}};ModelsService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(models_entity_1[_0x26607c(0xdc)])),__metadata(_0x26607c(0xad),[typeorm_2['Repository']])],ModelsService),exports['ModelsService']=ModelsService;