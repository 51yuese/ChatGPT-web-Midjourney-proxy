'use strict';const _0x24623a=_0x1213;(function(_0x3fd02f,_0x4133be){const _0x302ab6=_0x1213,_0x48d629=_0x3fd02f();while(!![]){try{const _0x268df8=parseInt(_0x302ab6(0xe9))/0x1+parseInt(_0x302ab6(0xf1))/0x2*(-parseInt(_0x302ab6(0xce))/0x3)+parseInt(_0x302ab6(0x11e))/0x4+-parseInt(_0x302ab6(0xf7))/0x5+-parseInt(_0x302ab6(0xe6))/0x6+-parseInt(_0x302ab6(0xfa))/0x7*(parseInt(_0x302ab6(0x10d))/0x8)+parseInt(_0x302ab6(0xd1))/0x9;if(_0x268df8===_0x4133be)break;else _0x48d629['push'](_0x48d629['shift']());}catch(_0x2b2b93){_0x48d629['push'](_0x48d629['shift']());}}}(_0x4238,0xac349));var __decorate=this&&this[_0x24623a(0xf9)]||function(_0x462f21,_0x25c6f3,_0x25a80d,_0x53be62){const _0x54fe0b=_0x24623a;var _0x1d283f=arguments[_0x54fe0b(0xed)],_0x5a6077=_0x1d283f<0x3?_0x25c6f3:_0x53be62===null?_0x53be62=Object[_0x54fe0b(0xf4)](_0x25c6f3,_0x25a80d):_0x53be62,_0x2b3fba;if(typeof Reflect==='object'&&typeof Reflect[_0x54fe0b(0xeb)]==='function')_0x5a6077=Reflect[_0x54fe0b(0xeb)](_0x462f21,_0x25c6f3,_0x25a80d,_0x53be62);else{for(var _0x2daa50=_0x462f21[_0x54fe0b(0xed)]-0x1;_0x2daa50>=0x0;_0x2daa50--)if(_0x2b3fba=_0x462f21[_0x2daa50])_0x5a6077=(_0x1d283f<0x3?_0x2b3fba(_0x5a6077):_0x1d283f>0x3?_0x2b3fba(_0x25c6f3,_0x25a80d,_0x5a6077):_0x2b3fba(_0x25c6f3,_0x25a80d))||_0x5a6077;}return _0x1d283f>0x3&&_0x5a6077&&Object[_0x54fe0b(0x11d)](_0x25c6f3,_0x25a80d,_0x5a6077),_0x5a6077;},__metadata=this&&this[_0x24623a(0x107)]||function(_0x30ed64,_0x5a452c){const _0x1cffe1=_0x24623a;if(typeof Reflect===_0x1cffe1(0x11f)&&typeof Reflect[_0x1cffe1(0x111)]==='function')return Reflect[_0x1cffe1(0x111)](_0x30ed64,_0x5a452c);},__param=this&&this[_0x24623a(0xc2)]||function(_0x39941c,_0x561938){return function(_0x13beea,_0x33f8c4){_0x561938(_0x13beea,_0x33f8c4,_0x39941c);};};function _0x1213(_0x1419c0,_0x3d8845){const _0x4238a4=_0x4238();return _0x1213=function(_0x1213bd,_0x5d9282){_0x1213bd=_0x1213bd-0xbc;let _0x533588=_0x4238a4[_0x1213bd];return _0x533588;},_0x1213(_0x1419c0,_0x3d8845);}Object[_0x24623a(0x11d)](exports,_0x24623a(0xc3),{'value':!![]}),exports[_0x24623a(0x11b)]=void 0x0;const common_1=require(_0x24623a(0xf0)),typeorm_1=require(_0x24623a(0x10a)),typeorm_2=require(_0x24623a(0xdb)),models_entity_1=require(_0x24623a(0xee)),status_constant_1=require(_0x24623a(0xd5)),baidu_1=require(_0x24623a(0x103)),utils_1=require(_0x24623a(0xfb));let ModelsService=class ModelsService{constructor(_0x46d22a){const _0x488105=_0x24623a;this[_0x488105(0x108)]=_0x46d22a,this[_0x488105(0xec)]=[],this[_0x488105(0x100)]={},this[_0x488105(0xfe)]={},this[_0x488105(0xbe)]={},this[_0x488105(0x124)]={};}async[_0x24623a(0xe3)](){await this['initCalcKey'](),await this['refreshBaiduAccesstoken']();}async[_0x24623a(0x121)](){const _0x22141a=_0x24623a,_0x42982f=_0x22141a(0x117),_0x2b5681=_0x42982f+'/v1/models';return await fetch(_0x2b5681,{'method':_0x22141a(0xbd),'headers':{'Authorization':_0x22141a(0x10e)}})[_0x22141a(0xcd)](async _0x1a8c46=>{const _0x47abcf=_0x22141a,_0xd22380=await _0x1a8c46['json']();return _0xd22380[_0x47abcf(0x11a)];});}async[_0x24623a(0xc1)](){const _0x147171=_0x24623a,_0x28aaee=_0x147171(0xc0),_0x420847=_0x28aaee+_0x147171(0x106);return await fetch(_0x420847,{'method':'post','headers':{'Content-Type':_0x147171(0x112),'OpenAI-Beta':'assistants=v1','Authorization':_0x147171(0x10b)},'body':JSON[_0x147171(0x127)]({'model':'gpt-4-1106-preview','name':_0x147171(0xcc),'description':'宠物狗专属客服','tools':[{'type':'code_interpreter'}],'file_ids':[]})})['then'](async _0x28b905=>{const _0x16eae7=_0x147171;console[_0x16eae7(0x102)](_0x28b905);const _0x39e200=await _0x28b905[_0x16eae7(0xca)]();return console[_0x16eae7(0x102)](_0x39e200),_0x39e200;});}async['initCalcKey'](){const _0x13c492=_0x24623a;this[_0x13c492(0xbe)]={},this[_0x13c492(0x124)]={},this[_0x13c492(0xfe)]={},this[_0x13c492(0x100)]={},this[_0x13c492(0xec)]=[];const _0x514e3b=await this[_0x13c492(0x108)][_0x13c492(0xe7)]({'where':{'status':!![]}}),_0x1f2cfb=_0x514e3b[_0x13c492(0x118)]((_0x597b9a,_0x374ef)=>{const _0x5edd07=_0x13c492;return!_0x597b9a[_0x374ef[_0x5edd07(0xd4)]]?_0x597b9a[_0x374ef[_0x5edd07(0xd4)]]=[_0x374ef]:_0x597b9a[_0x374ef[_0x5edd07(0xd4)]][_0x5edd07(0xc6)](_0x374ef),_0x597b9a;},{});this[_0x13c492(0xec)]=Object[_0x13c492(0x120)](_0x1f2cfb)[_0x13c492(0x105)](_0x3fb3d7=>{return{'label':status_constant_1['ModelsMapCn'][_0x3fb3d7],'val':_0x3fb3d7};}),this['modelMaps']=_0x1f2cfb,this['keyList']={},_0x514e3b[_0x13c492(0x110)](_0x34d4fa=>{const _0x22c128=_0x13c492,{keyType:_0x1714f0,model:_0x5b9d01,keyWeight:_0x1b5a7f}=_0x34d4fa;if(!this[_0x22c128(0xbe)][_0x5b9d01])this['keyPoolMap'][_0x5b9d01]=[];for(let _0x5abf98=0x0;_0x5abf98<_0x1b5a7f;_0x5abf98++){this['keyPoolMap'][_0x5b9d01][_0x22c128(0xc6)](_0x34d4fa);}if(!this['keyPoolIndexMap'][_0x5b9d01])this['keyPoolIndexMap'][_0x5b9d01]=0x0;if(!this[_0x22c128(0xfe)][_0x1714f0])this[_0x22c128(0xfe)][_0x1714f0]={};if(!this[_0x22c128(0xfe)][_0x1714f0][_0x5b9d01])this[_0x22c128(0xfe)][_0x1714f0][_0x5b9d01]=[];this[_0x22c128(0xfe)][_0x1714f0][_0x5b9d01]['push'](_0x34d4fa);});}async[_0x24623a(0x10f)](_0x56c54e,_0x285a8b,_0x3f41a6=-0x1){const _0x6a07e9=_0x24623a,_0x44035e=await this[_0x6a07e9(0x108)][_0x6a07e9(0xe4)]({'id':_0x56c54e},{'status':![],'keyStatus':_0x3f41a6,'remark':_0x285a8b});common_1[_0x6a07e9(0xda)][_0x6a07e9(0xf3)](_0x6a07e9(0xc8)+_0x56c54e+_0x6a07e9(0xbf)),await this[_0x6a07e9(0xdd)]();}async[_0x24623a(0xd2)](_0x19093f){const _0x424f69=_0x24623a;if(!this[_0x424f69(0xbe)][_0x19093f])throw new common_1[(_0x424f69(0x116))]('当前调用模型已经被移除、请重新选择模型！',common_1[_0x424f69(0xe8)]['BAD_REQUEST']);this[_0x424f69(0x124)][_0x19093f]++;const _0x527049=this[_0x424f69(0x124)][_0x19093f];if(_0x527049>=this['keyPoolMap'][_0x19093f][_0x424f69(0xed)])this[_0x424f69(0x124)][_0x19093f]=0x0;return this['keyPoolMap'][_0x19093f][this[_0x424f69(0x124)][_0x19093f]];}async[_0x24623a(0x126)](_0xbb3bec){const _0x165e8f=_0x24623a;if(!this[_0x165e8f(0xec)][_0x165e8f(0xed)]||!Object[_0x165e8f(0x120)](this[_0x165e8f(0x100)])[_0x165e8f(0xed)])return;const _0x558155=_0xbb3bec?this[_0x165e8f(0xec)]['find'](_0x5aa580=>Number(_0x5aa580[_0x165e8f(0xc7)])===0x1):this[_0x165e8f(0xec)][0x0];if(!_0x558155)return;const {keyType:_0x5646d1,modelName:_0x84fae1,model:_0x19de81,maxModelTokens:_0x4ba9f3,maxResponseTokens:_0x34b9f4,deductType:_0x2483c7,deduct:_0x1306c0,maxRounds:_0xd981f8}=this[_0x165e8f(0x100)][_0x558155[_0x165e8f(0xc7)]][0x0];return{'modelTypeInfo':_0x558155,'modelInfo':{'keyType':_0x5646d1,'modelName':_0x84fae1,'model':_0x19de81,'maxModelTokens':_0x4ba9f3,'maxResponseTokens':_0x34b9f4,'topN':0.8,'systemMessage':'','deductType':_0x2483c7,'deduct':_0x1306c0,'maxRounds':_0xd981f8,'rounds':0x8}};}async[_0x24623a(0x122)](_0xd40e1e){const _0x1af429=_0x24623a;try{const {id:_0x30acae}=_0xd40e1e;_0xd40e1e[_0x1af429(0x114)]&&(_0xd40e1e[_0x1af429(0xde)]=0x1);if(_0x30acae){const _0x9895f2=await this[_0x1af429(0x108)]['update']({'id':_0x30acae},_0xd40e1e);return await this[_0x1af429(0xdd)](),_0x9895f2['affected']>0x0;}else{const {keyType:_0x167dd2,key:_0x345ec8}=_0xd40e1e;if(Number(_0x167dd2!==0x1)){const _0xb48bf6=await this[_0x1af429(0x108)][_0x1af429(0xef)](_0xd40e1e);return await this['initCalcKey'](),_0x167dd2===0x2&&this[_0x1af429(0xd0)](),_0xb48bf6;}else{const _0x755bcd=_0x345ec8[_0x1af429(0x105)](_0x54a016=>{const _0x44343e=_0x1af429,_0x48a324=JSON[_0x44343e(0xf2)](JSON[_0x44343e(0x127)](_0xd40e1e));return _0x48a324[_0x44343e(0xdc)]=_0x54a016,_0x48a324;}),_0x5c2ae7=await this[_0x1af429(0x108)][_0x1af429(0xef)](_0x755bcd);return await this[_0x1af429(0xdd)](),_0x5c2ae7;}}}catch(_0x2d4d0f){console['log'](_0x1af429(0x115),_0x2d4d0f);}}async[_0x24623a(0x101)]({id:_0xeb6829}){const _0xab1a=_0x24623a;if(!_0xeb6829)throw new common_1['HttpException'](_0xab1a(0x10c),common_1[_0xab1a(0xe8)][_0xab1a(0xcb)]);const _0x503290=await this[_0xab1a(0x108)][_0xab1a(0xff)]({'where':{'id':_0xeb6829}});if(!_0x503290)throw new common_1[(_0xab1a(0x116))](_0xab1a(0xe5),common_1[_0xab1a(0xe8)][_0xab1a(0xcb)]);const _0x157b9b=await this[_0xab1a(0x108)][_0xab1a(0xd3)]({'id':_0xeb6829});return await this[_0xab1a(0xdd)](),_0x157b9b;}async['queryModels'](_0x79be3,_0x3509ff){const _0x10bc5c=_0x24623a,{role:_0x58b67c}=_0x79be3[_0x10bc5c(0x123)],{keyType:_0x4dde5a,key:_0xf032b2,status:_0x21b700,model:_0x39bc78,page:page=0x1,size:size=0xa}=_0x3509ff;let _0x316fa8={};_0x4dde5a&&(_0x316fa8[_0x10bc5c(0xd4)]=_0x4dde5a),_0x39bc78&&(_0x316fa8[_0x10bc5c(0xe2)]=_0x39bc78),_0x21b700&&(_0x316fa8[_0x10bc5c(0x114)]=Number(_0x21b700)===0x1?!![]:![]),_0xf032b2&&(_0x316fa8['key']=(0x0,typeorm_2[_0x10bc5c(0xc4)])('%'+_0xf032b2+'%'));const [_0x5c7b8e,_0x3d74cf]=await this['modelsEntity'][_0x10bc5c(0x109)]({'where':_0x316fa8,'skip':(page-0x1)*size,'take':size});return _0x58b67c!=='super'&&_0x5c7b8e[_0x10bc5c(0x110)](_0x28cc13=>{const _0xab1630=_0x10bc5c;_0x28cc13['key']&&(_0x28cc13['key']=(0x0,utils_1[_0xab1630(0x11c)])(_0x28cc13[_0xab1630(0xdc)])),_0x28cc13[_0xab1630(0xf6)]&&(_0x28cc13[_0xab1630(0xf6)]=(0x0,utils_1[_0xab1630(0x11c)])(_0x28cc13[_0xab1630(0xf6)]));}),{'rows':_0x5c7b8e,'count':_0x3d74cf};}async[_0x24623a(0xf5)](){const _0x28d5bc=_0x24623a,_0x5a09e3=(0x0,utils_1['deepClone'])(this[_0x28d5bc(0x100)]);return Object['keys'](_0x5a09e3)[_0x28d5bc(0x110)](_0x302c19=>{const _0x5db4ea=_0x28d5bc;_0x5a09e3[_0x302c19]=Array[_0x5db4ea(0x119)](_0x5a09e3[_0x302c19][_0x5db4ea(0x105)](_0x594a39=>{const {modelName:_0x201008,model:_0x249b55,deduct:_0x7f2358,deductType:_0x5f1f75,maxRounds:_0x24de0b}=_0x594a39;return{'modelName':_0x201008,'model':_0x249b55,'deduct':_0x7f2358,'deductType':_0x5f1f75,'maxRounds':_0x24de0b};})[_0x5db4ea(0x118)]((_0x10c236,_0x551c61)=>_0x10c236['set'](_0x551c61[_0x5db4ea(0xc9)],_0x551c61),new Map())[_0x5db4ea(0xd8)]());}),{'modelTypeList':this[_0x28d5bc(0xec)],'modelMaps':_0x5a09e3};}async[_0x24623a(0xfc)](_0x5bcf6b,_0x388ed2){const _0x2197f3=_0x24623a;await this[_0x2197f3(0x108)][_0x2197f3(0xd6)]()[_0x2197f3(0xe4)](models_entity_1[_0x2197f3(0xc5)])[_0x2197f3(0x104)]({'useCount':()=>_0x2197f3(0xf8),'useToken':()=>_0x2197f3(0xdf)+_0x388ed2})[_0x2197f3(0x113)]('id\x20=\x20:id',{'id':_0x5bcf6b})['execute']();}async['refreshBaiduAccesstoken'](){const _0x416193=_0x24623a,_0x2110be=await this[_0x416193(0x108)][_0x416193(0xe7)]({'where':{'keyType':0x2}}),_0x3da58d={};_0x2110be[_0x416193(0x110)](_0x53fc15=>{const _0x31c364=_0x416193,{key:_0x1f48ea,secret:_0x2d8b54}=_0x53fc15;!_0x3da58d[_0x31c364(0xdc)]?_0x3da58d[_0x1f48ea]=[{'keyInfo':_0x53fc15}]:_0x3da58d[_0x1f48ea]['push'](_0x53fc15);}),Object[_0x416193(0x120)](_0x3da58d)[_0x416193(0x110)](async _0x3924bb=>{const _0x9033e2=_0x416193,{secret:_0x1fd130,id:_0x148d0b}=_0x3da58d[_0x3924bb][0x0][_0x9033e2(0xbc)],_0x56c75a=await(0x0,baidu_1[_0x9033e2(0xcf)])(_0x3924bb,_0x1fd130);await this[_0x9033e2(0x108)][_0x9033e2(0xe4)]({'key':_0x3924bb},{'accessToken':_0x56c75a});}),setTimeout(()=>{const _0x1405ce=_0x416193;this[_0x1405ce(0xdd)]();},0x3e8);}async['getRandomDrawKey'](){const _0x424951=_0x24623a,_0x1f2cf0=await this[_0x424951(0x108)][_0x424951(0xe7)]({'where':{'isDraw':!![]}});if(!_0x1f2cf0[_0x424951(0xed)])throw new common_1[(_0x424951(0x116))](_0x424951(0x125),common_1[_0x424951(0xe8)][_0x424951(0xcb)]);return(0x0,utils_1[_0x424951(0xe1)])(_0x1f2cf0);}async[_0x24623a(0xea)](){const _0x453c6a=_0x24623a;return await this[_0x453c6a(0x108)][_0x453c6a(0xe7)]();}};function _0x4238(){const _0x38144d=['modelMaps','delModel','log','../chatgpt/baidu','set','map','/v1/assistants','__metadata','modelsEntity','findAndCount','@nestjs/typeorm','Bearer\x20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','缺失必要参数！','48Jdausm','Bearer\x20sk-bSm3FROxNJ1oIkmd5dDc9b582d3d48E09d12E86eF7FfC0C4','lockKey','forEach','metadata','application/json','where','status','error:\x20','HttpException','https://apiv.chatgpt-3.vip','reduce','from','data','ModelsService','hideString','defineProperty','1073608VVdTMx','object','keys','getOfficialModels','setModel','user','keyPoolIndexMap','当前未指定特殊模型KEY、前往后台设置把！','getBaseConfig','stringify','keyInfo','get','keyPoolMap','\x20欠费或被官方封禁导致不可用，已被系统自动锁定','https://api.openai.com','createAssistants','__param','__esModule','Like','ModelsEntity','push','val','key:\x20','modelName','json','BAD_REQUEST','宠物狗','then','22524KzjObi','getAccessToken','refreshBaiduAccesstoken','19731825FBvWCS','getCurrentModelKeyInfo','delete','keyType','../../common/constants/status.constant','createQueryBuilder','Injectable','values','Repository','Logger','typeorm','key','initCalcKey','keyStatus','useToken\x20+\x20','InjectRepository','getRandomItemFromArray','model','onModuleInit','update','当前账号不存在！','2252880yaawrE','find','HttpStatus','1024860iYJorf','getAllKey','decorate','modelTypes','length','./models.entity','save','@nestjs/common','278SrIfPe','parse','error','getOwnPropertyDescriptor','modelsList','secret','5894870saGbBV','useCount\x20+\x201','__decorate','212646ppXnYt','../../common/utils','saveUseLog','design:paramtypes','keyList','findOne'];_0x4238=function(){return _0x38144d;};return _0x4238();}ModelsService=__decorate([(0x0,common_1[_0x24623a(0xd7)])(),__param(0x0,(0x0,typeorm_1[_0x24623a(0xe0)])(models_entity_1[_0x24623a(0xc5)])),__metadata(_0x24623a(0xfd),[typeorm_2[_0x24623a(0xd9)]])],ModelsService),exports[_0x24623a(0x11b)]=ModelsService;